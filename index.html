<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0c29">
    <title>City Life Simulator</title>
    <style>
        * { margin:0; padding:0; box-sizing: border-box; }
        
        /* Fix per spazio laterale mobile */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            overflow-x: hidden !important;
        }
        
        :root{ --primary:#667eea; --secondary:#764ba2; --success:#38ef7d; --danger:#eb3349; --warning:#ffd700; --dark:#1a1a2e; --light:#f0f0f0;}
        body{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial; background:linear-gradient(135deg,#0f0c29,#302b63); color:#fff; min-height:100vh;}
        .container{ max-width:1200px; margin:20px auto; padding:20px; }
        
        /* Rimuove margini/padding ereditati dal layout */
        .main-container,
        .wrapper,
        .content,
        .city-map-container,
        .map-section,
        .page {
            margin-left: 0 !important;
            padding-left: 0 !important;
            width: 100% !important;
        }
        h1{text-align:center; background:linear-gradient(135deg,var(--primary),var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-size:2.8rem; margin-bottom:20px;}
        .card{ background:rgba(255,255,255,0.06); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.04); }
        button{ background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; transition: transform 0.2s; }
        button:hover{ transform: scale(1.05); }
        button:disabled{ opacity: 0.5; cursor: not-allowed; transform: none !important; }
        button.small{ padding:6px 10px; font-size:0.9rem; }
        .grid{ display:grid; gap:12px; }
        .grid-3{ grid-template-columns: repeat(3,1fr); }
        .screen{ display:none; animation:fadeIn .3s ease; }
        .screen.active{ display:block; }
        #homeScreen, #characterScreen{ position:fixed; left:0; top:0; right:0; bottom:0; background:linear-gradient(135deg,#0f0c29,#302b63); z-index:5000; overflow-y:auto; }
        .tab-buttons{ display:flex; gap:8px; margin-bottom:12px; flex-wrap: wrap; }
        .tab-btn{ background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:8px; cursor:pointer; border: 1px solid transparent; transition: all 0.2s; }
        .tab-btn:hover{ background:rgba(255,255,255,0.08); }
        .tab-btn.active{ background:rgba(102,126,234,0.18); border:1px solid var(--primary); }
        .tab-content{ display:none; }
        .tab-content.active{ display:block; }
        .stat-bar{ height:22px; background:rgba(0,0,0,0.4); border-radius:12px; overflow:hidden; position: relative; }
        .stat-fill{ height:100%; display:flex; align-items:center; justify-content:center; font-weight:600; transition:width .4s ease; font-size: 0.85rem; }
        .stat-fill.high{ background:linear-gradient(90deg,var(--success),#11998e); }
        .stat-fill.medium{ background:linear-gradient(90deg,var(--warning),#ff8c00); }
        .stat-fill.low{ background:linear-gradient(90deg,var(--danger),#f45c43); }
        .notification{ position:fixed; top:20px; right:20px; padding:10px 14px; border-radius:8px; background:rgba(0,0,0,0.85); color:#fff; z-index:9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        .modal{ position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:4000; }
        .modal .modal-inner{ width:90%; max-width:700px; background:linear-gradient(135deg,rgba(30,30,50,0.98),rgba(40,40,60,0.98)); padding:18px; border-radius:10px; max-height: 80vh; overflow-y: auto; }
        .npc-card{ padding:8px; background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; border: 1px solid rgba(255,255,255,0.05); }
        input, select{ padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2); color:#fff; width:100%; margin-top: 4px; margin-bottom: 8px; }
        
        /* Character Creation Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); 
            } 
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); 
            } 
        }
        
        /* Trait Card Styles */
        .trait-card { 
            padding: 10px; 
            background: rgba(255,255,255,0.04); 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid transparent;
            position: relative;
        }
        .trait-card:hover { 
            background: rgba(255,255,255,0.08); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .trait-card.selected { 
            background: rgba(102,126,234,0.15); 
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(102,126,234,0.3);
        }
        .trait-card input[type="checkbox"] {
            display: none;
        }
        label{ display: block; margin-top: 8px; font-size: 0.9rem; opacity: 0.9; }
        .loading-screen{ position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f0c29,#302b63); z-index:6000; }
        .quest-card{ background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left: 3px solid var(--primary); }
        .quest-card.completed{ opacity: 0.6; border-left-color: var(--success); }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
        @keyframes fadeOut{ from{opacity:1;} to{opacity:0;} }
        @keyframes slideIn{ from{transform:translateX(100px); opacity:0;} to{transform:none; opacity:1;} }
        @keyframes spin{ to{transform:rotate(360deg);} }
        
        /* Chat Styles */
        /* Old Chat Styles Removed - Using New Dialogue System */
        
        /* ========================================
           DIALOGUE SYSTEM - RPG STYLE
           ======================================== */
        .dialogue-modal {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 5500;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        .dialogue-modal.active { display: flex; }
        .dialogue-container {
            width: 95%;
            max-width: 800px;
            max-height: 85vh;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(30, 30, 50, 0.98));
            border-radius: 16px;
            border: 3px solid rgba(102, 126, 234, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dialogue-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .dialogue-npc-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dialogue-npc-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .dialogue-npc-details h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        .dialogue-npc-details p {
            margin: 2px 0 0 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .dialogue-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
        }
        .dialogue-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 12px;
        }
        .dialogue-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .dialogue-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .trust-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 10px;
            margin: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .trust-icon { font-size: 1.2rem; }
        .trust-text { font-size: 0.85rem; }
        .trust-level-sconosciuto { color: #888; }
        .trust-level-conoscente { color: #4a9eff; }
        .trust-level-amico { color: #38ef7d; }
        .trust-level-confidente { color: #ff6b6b; }
        .trust-level-familiare { color: #ffd700; }
        .dialogue-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
        }
        .dialogue-bubble {
            margin-bottom: 16px;
            animation: slideIn 0.4s ease;
        }
        .dialogue-bubble.npc { text-align: left; }
        .dialogue-bubble.player { text-align: right; }
        .dialogue-bubble.system { text-align: center; }
        .bubble-content {
            display: inline-block;
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
        }
        .dialogue-bubble.npc .bubble-content {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            text-align: left;
        }
        .dialogue-bubble.player .bubble-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border: 1px solid rgba(102, 126, 234, 0.5);
            text-align: left;
        }
        .dialogue-bubble.system .bubble-content {
            background: rgba(255, 200, 100, 0.2);
            border: 1px solid rgba(255, 200, 100, 0.4);
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px 14px;
        }
        .bubble-label {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .check-result {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 8px;
            font-weight: bold;
        }
        .check-result.success {
            background: rgba(56, 239, 125, 0.3);
            color: #38ef7d;
        }
        .check-result.failure {
            background: rgba(235, 51, 73, 0.3);
            color: #eb3349;
        }
        .check-result.critical {
            background: rgba(255, 215, 0, 0.3);
            color: #ffd700;
            animation: pulse 1s infinite;
        }
        .dialogue-choices {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .dialogue-choices-title {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 12px;
            text-align: center;
        }
        .choice-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .choice-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        .choice-option:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(5px);
        }
        .choice-option:hover::before { opacity: 1; }
        .choice-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }
        .choice-option.disabled:hover {
            transform: none;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .choice-text {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .choice-check {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }
        .dialogue-notification {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid var(--success);
            z-index: 10;
            animation: slideDown 0.5s ease;
            min-width: 300px;
            text-align: center;
        }
        .dialogue-notification.relation-down { border-color: var(--danger); }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
            .dialogue-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            .bubble-content { max-width: 85%; }
            .choice-option { padding: 10px 12px; }
        }
        
        /* Visual Map Styles - IMPROVED */
        .visual-map-container{ 
            position:relative; width:100%; height:600px; 
            background:linear-gradient(135deg, #0a0a1e 0%, #1a1a3e 50%, #0f0f2e 100%); 
            border-radius:16px; overflow:hidden; 
            border:3px solid rgba(102,126,234,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 0 60px rgba(102,126,234,0.1);
        }
        .map-grid{ position:absolute; inset:0; display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(3,1fr); gap:4px; padding:12px; }
        .quarter-zone{ 
            position:relative; 
            background:linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%); 
            border-radius:12px; border:2px solid rgba(255,255,255,0.15); 
            cursor:pointer; transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow:hidden; display:flex; flex-direction:column; padding:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .quarter-zone::before{
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, rgba(102,126,234,0.1), transparent 70%);
            opacity: 0; transition: opacity 0.4s;
        }
        .quarter-zone:hover::before{ opacity: 1; }
        .quarter-zone:hover{ 
            background:linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(118,75,162,0.08) 100%);
            border-color:rgba(102,126,234,0.6); transform:scale(1.03) translateY(-2px); 
            box-shadow:0 8px 24px rgba(102,126,234,0.4), 0 0 40px rgba(102,126,234,0.2), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .quarter-zone.active{ 
            border-color:var(--primary); border-width:3px; 
            box-shadow:0 0 30px rgba(102,126,234,0.6), 0 8px 24px rgba(102,126,234,0.3), inset 0 0 20px rgba(102,126,234,0.15);
            background:linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.15) 100%);
            transform:scale(1.02);
        }
        .quarter-name{ 
            font-weight:bold; font-size:1rem; margin-bottom:6px; color:#fff; 
            text-shadow:2px 2px 4px rgba(0,0,0,0.7), 0 0 10px rgba(102,126,234,0.3);
            letter-spacing: 0.5px; z-index: 2;
        }
        .quarter-icon{ 
            font-size:2.8rem; margin:auto; opacity:0.9;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
            transition: transform 0.4s, filter 0.4s; z-index: 2;
        }
        .quarter-zone:hover .quarter-icon{
            transform: scale(1.15) rotate(5deg);
            filter: drop-shadow(0 6px 12px rgba(102,126,234,0.5));
        }
        .quarter-stats{ font-size:0.75rem; opacity:0.85; margin-top:6px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); z-index: 2; }
        .map-road{ position:absolute; background:linear-gradient(90deg, rgba(255,255,255,0.2), rgba(102,126,234,0.3), rgba(255,255,255,0.2)); z-index:1; box-shadow: 0 0 10px rgba(102,126,234,0.2); }
        .road-h{ height:4px; }
        .road-v{ width:4px; }
        .road-label{ position:absolute; font-size:0.75rem; color:rgba(255,255,255,0.8); z-index:2; pointer-events:none; text-shadow: 1px 1px 3px rgba(0,0,0,0.7), 0 0 8px rgba(102,126,234,0.4); font-weight: 500; }
        .location-marker-wrapper{ position:absolute; display:flex; flex-direction:column; align-items:center; cursor:pointer; z-index:3; }
        .location-marker{ width:24px; height:24px; border-radius:50%; border:2px solid #fff; display:flex; align-items:center; justify-content:center; font-size:12px; transition:transform 0.2s; }
        .location-marker:hover{ transform:scale(1.2); }
        .location-label{ font-size:0.7rem; color:#fff; margin-top:4px; text-align:center; white-space:nowrap; text-shadow:1px 1px 2px rgba(0,0,0,0.7); }
        .bus-stop{ position:absolute; width:20px; height:20px; background:var(--warning); border-radius:50%; border:2px solid #fff; z-index:2; display:flex; align-items:center; justify-content:center; font-size:10px; animation:pulse 2s infinite; cursor:pointer; }
        .landmark-marker{ position:absolute; width:24px; height:24px; background:var(--success); border-radius:4px; border:2px solid #fff; z-index:2; display:flex; align-items:center; justify-content:center; font-size:12px; animation:bounce 3s infinite; cursor:pointer; }
        .business-marker{ position:absolute; width:16px; height:16px; background:var(--primary); border-radius:50%; border:1px solid #fff; z-index:2; cursor:pointer; }
        .player-marker{ position:absolute; width:40px; height:40px; background:radial-gradient(circle, #ff6b6b, #ee5a6f); border-radius:50%; border:4px solid #fff; z-index:5; display:flex; align-items:center; justify-content:center; font-size:18px; animation:playerPulse 1.5s infinite; box-shadow:0 0 25px rgba(255,107,107,0.8), 0 4px 15px rgba(0,0,0,0.5); cursor:pointer; transition: all 0.3s ease; }
        .player-marker:hover { transform: scale(1.2); box-shadow:0 0 35px rgba(255,107,107,1), 0 6px 20px rgba(0,0,0,0.6); }
        .player-location-label { position: absolute; bottom: -26px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; white-space: nowrap; border: 2px solid rgba(255,107,107,0.6); box-shadow: 0 2px 8px rgba(0,0,0,0.5); font-weight: 600; letter-spacing: 0.3px; pointer-events: none; }
        .map-tooltip{ position:absolute; background:rgba(0,0,0,0.95); color:#fff; padding:10px 14px; border-radius:8px; font-size:0.85rem; pointer-events:none; z-index:10; white-space:nowrap; display:none; border:2px solid rgba(102,126,234,0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
        .map-legend{ position:absolute; bottom:12px; right:12px; background:rgba(0,0,0,0.9); padding:16px; border-radius:12px; font-size:0.75rem; z-index:3; border:2px solid rgba(102,126,234,0.4); box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(15px); }
        .legend-item{ display:flex; align-items:center; gap:10px; margin-bottom:6px; transition: transform 0.2s; }
        .legend-item:hover { transform: translateX(3px); }
        .legend-icon{ width:18px; height:18px; border-radius:50%; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        @keyframes pulse{ 0%, 100%{transform:scale(1);} 50%{transform:scale(1.2);} }
        @keyframes bounce{ 0%, 100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }
        @keyframes playerPulse{ 0%, 100%{transform:scale(1); box-shadow:0 0 25px rgba(255,107,107,0.8), 0 4px 15px rgba(0,0,0,0.5);} 50%{transform:scale(1.15); box-shadow:0 0 40px rgba(255,107,107,1), 0 6px 20px rgba(0,0,0,0.6);} }
        
        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        @media (max-width:768px) {
            /* Fix spazio laterale mobile */
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                overflow-x: hidden !important;
            }
            
            .main-container,
            .wrapper,
            .content,
            .city-map-container,
            .map-section {
                margin-left: 0 !important;
                padding-left: 0 !important;
                width: 100% !important;
            }
            
            /* Typography */
            h1 { font-size: 1.8rem; margin-bottom: 12px; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.2rem; }
            
            /* Layout */
            .container { padding: 10px; margin: 10px auto; }
            .card { padding: 12px; margin-bottom: 12px; }
            
            /* Grids */
            .grid-3 { grid-template-columns: 1fr; gap: 8px; }
            .modal-action-grid { grid-template-columns: 1fr; }
            
            /* Buttons */
            button { padding: 12px 16px; font-size: 1rem; min-height: 44px; }
            button.small { padding: 8px 12px; font-size: 0.9rem; min-height: 38px; }
            
            /* Top HUD Bar - Make it responsive */
            body > div:first-of-type[style*="position:fixed"][style*="top:0"] {
                padding: 6px 8px !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }
            
            /* Stats Panel */
            #statsPanel {
                font-size: 0.85rem;
            }
            
            #statsPanel details {
                margin-bottom: 8px !important;
            }
            
            /* Map */
            .visual-map-container { 
                height: 300px; 
                border-radius: 8px;
            }
            
            .map-grid { 
                grid-template-columns: repeat(2, 1fr); 
                grid-template-rows: repeat(3, 1fr); 
                gap: 3px;
                padding: 6px;
            }
            
            .quarter-zone {
                padding: 6px;
                min-height: 90px;
                border-radius: 8px;
            }
            
            .quarter-name { font-size: 0.75rem; margin-bottom: 4px; }
            .quarter-icon { font-size: 1.5rem; margin: 8px auto; }
            .quarter-stats { font-size: 0.6rem; margin-top: 4px; }
            
            .map-legend {
                padding: 10px;
                font-size: 0.65rem;
                bottom: 8px;
                right: 8px;
            }
            
            .legend-item {
                margin-bottom: 4px;
                gap: 6px;
            }
            
            .legend-icon {
                width: 14px;
                height: 14px;
            }
            
            /* Player Marker */
            .player-marker {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .player-location-label {
                font-size: 0.65rem;
                padding: 3px 8px;
                bottom: -22px;
            }
            
            /* Sidebar */
            #menuSidebar {
                width: 100%;
                padding: 12px;
                top: 56px;
                transform: translateY(-100%);
            }
            
            #menuSidebar.open {
                transform: translateY(0);
            }
            
            /* Main Map Area */
            #mainMapArea {
                top: 56px !important;
                padding: 10px !important;
            }
            
            /* Dialogue System */
            .dialogue-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .dialogue-header {
                padding: 12px 16px;
                flex-wrap: wrap;
            }
            
            .dialogue-npc-avatar {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .dialogue-npc-details h3 { font-size: 1.1rem; }
            .dialogue-npc-details p { font-size: 0.8rem; }
            
            .dialogue-stats {
                font-size: 0.75rem;
                gap: 8px;
            }
            
            .dialogue-history {
                padding: 12px;
            }
            
            .bubble-content { 
                max-width: 90%; 
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .dialogue-choices {
                padding: 12px;
                max-height: 250px;
            }
            
            .choice-option {
                padding: 10px 12px;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }
            
            /* Location Popup */
            .location-popup {
                min-width: 90%;
                max-width: 90%;
                padding: 16px;
                max-height: 85vh;
                overflow-y: auto;
            }
            
            .location-popup-icon {
                font-size: 2.5rem;
            }
            
            .location-popup-info h3 {
                font-size: 1.3rem;
            }
            
            .location-action-btn {
                padding: 12px 14px;
            }
            
            .location-action-icon {
                font-size: 1.5rem;
                min-width: 35px;
            }
            
            .location-action-title {
                font-size: 0.95rem;
            }
            
            .location-action-desc {
                font-size: 0.8rem;
            }
            
            /* Enhanced Dialog */
            .enhanced-dialog-content {
                max-width: 95vw;
                max-height: 90vh;
                border-radius: 12px;
            }
            
            .modal-header {
                padding: 14px 16px;
            }
            
            .modal-header h3 {
                font-size: 1.2rem;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-section {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            /* Tab Buttons */
            .tab-buttons {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            /* Forms */
            input, select {
                padding: 10px;
                font-size: 1rem;
                min-height: 44px;
            }
            
            /* Character Creation */
            #characterScreen .container {
                padding: 12px;
            }
            
            #characterScreen h1 {
                font-size: 1.8rem;
            }
            
            #characterScreen .grid {
                grid-template-columns: 1fr !important;
            }
            
            #traitsGrid {
                grid-template-columns: 1fr !important;
            }
            
            /* Skills Display */
            #skillsDisplay .stat-bar {
                height: 20px;
            }
            
            /* Notifications */
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            /* Quest Cards */
            .quest-card {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            /* NPC Cards */
            .npc-card {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            /* Stat Tooltips */
            .tooltip-content {
                max-width: 200px;
                font-size: 0.8rem;
                padding: 8px;
            }
            
            /* Details/Summary */
            details summary {
                padding: 8px;
                font-size: 0.95rem;
            }
            
            /* Scrollbars */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
        }
        
        /* Extra small devices (phones in portrait, less than 576px) */
        @media (max-width: 576px) {
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.2rem; }
            h3 { font-size: 1rem; }
            
            .container { padding: 8px; margin: 8px auto; }
            .card { padding: 10px; margin-bottom: 10px; }
            
            button { padding: 10px 14px; font-size: 0.95rem; }
            button.small { padding: 6px 10px; font-size: 0.85rem; }
            
            .visual-map-container { 
                height: 250px; 
            }
            
            .map-grid { 
                grid-template-columns: 1fr; 
                grid-template-rows: repeat(5, 1fr); 
                gap: 2px;
                padding: 4px;
            }
            
            .quarter-zone {
                padding: 4px;
                min-height: 45px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .quarter-name { font-size: 0.7rem; }
            .quarter-icon { font-size: 1.2rem; margin: 0; }
            .quarter-stats { font-size: 0.55rem; margin: 0; }
            
            .dialogue-header {
                padding: 10px 12px;
            }
            
            .dialogue-npc-avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            
            .location-popup {
                padding: 12px;
            }
            
            .location-popup-icon {
                font-size: 2rem;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-body {
                padding: 12px;
            }
        }
        
        /* Landscape orientation optimizations */
        @media (max-width: 768px) and (orientation: landscape) {
            .visual-map-container { 
                height: 200px; 
            }
            
            .quarter-zone {
                min-height: 35px;
                padding: 3px;
            }
            
            .quarter-name { font-size: 0.65rem; }
            .quarter-icon { font-size: 1rem; }
            .quarter-stats { font-size: 0.5rem; }
            
            .dialogue-container {
                height: 100vh;
            }
            
            .dialogue-history {
                max-height: 40vh;
            }
            
            .dialogue-choices {
                max-height: 35vh;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button, .tab-btn, .choice-option, .quarter-zone {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            }
            
            button:active, .tab-btn:active {
                transform: scale(0.97);
            }
            
            .choice-option:active {
                background: rgba(102, 126, 234, 0.25) !important;
            }
        }
        
        /* ========================================
           FIX SPAZIO LATERALE - VERSIONE FINALE
           ======================================== */
        /* Rimuove completamente lo spazio a sinistra */
        .main-container,
        .game-container,
        .map-section-wrapper,
        .map-view,
        .page,
        .wrapper {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        /* Versione desktop */
        body {
            padding-left: 0 !important;
            margin-left: 0 !important;
        }

        /* Fissa anche su mobile */
        @media (max-width: 1024px) {
            .main-container,
            .game-container,
            .map-section-wrapper,
            body {
                margin-left: 0 !important;
                padding-left: 0 !important;
            }
        }

        /* ========================================
           SOLUZIONE DEFINITIVA - RIMUOVE TUTTO LO SPOSTAMENTO
           ======================================== */
        #mainMapArea,
        .main-container,
        .map-section-wrapper,
        .game-area,
        .wrapper {
            margin-left: 0 !important;
            padding-left: 0 !important;
            left: 0 !important;
        }

        /* Mobile fix */
        @media (max-width: 1024px) {
            #mainMapArea {
                left: 0 !important;
            }
        }

        /* Tooltip styles for stats */
        .stat-tooltip {
            position: relative;
            cursor: help;
        }
        .stat-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(-5px);
        }
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 250px;
            white-space: normal;
        }
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
        }
        
        /* Enhanced stat display */
        .stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary);
        }
        .stat-item.low { border-left-color: var(--danger); }
        .stat-item.medium { border-left-color: var(--warning); }
        .stat-item.high { border-left-color: var(--success); }
        
        /* Quarter detail stats with smaller size */
        .quarter-detail-stat {
            padding: 6px 8px;
            margin-bottom: 4px;
            font-size: 0.85rem;
            position: relative;
            cursor: help;
            transition: background 0.2s;
        }
        .quarter-detail-stat:hover {
            background: rgba(255,255,255,0.1);
        }
        .quarter-detail-stat .stat-icon {
            font-size: 0.9rem;
        }
        .quarter-detail-stat .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .quarter-detail-stat .stat-value {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .stat-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .stat-trend {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .detailed-quarter-map {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 15px;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 100;
            overflow: auto;
        }

        .detailed-quarter-map.active {
            display: flex;
        }

        .detailed-quarter-map h4 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .detailed-map-grid {
            position: relative;
            width: 95%;
            height: 80%;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
        }

        .map-road.road-h {
            background: rgba(255,255,255,0.2);
            height: 5px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .map-road.road-v {
            background: rgba(255,255,255,0.2);
            width: 5px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .road-label {
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: #fff;
            text-shadow: none;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        .location-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        .location-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            margin-top: 6px;
            text-align: center;
            white-space: nowrap;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .back-to-overview-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 101;
            font-size: 0.9rem;
        }

        /* Location Popup Styles */
        .location-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.98), rgba(40, 40, 60, 0.98));
            border-radius: 16px;
            padding: 24px;
            min-width: 400px;
            max-width: 600px;
            z-index: 6000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease;
        }

        .location-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5999;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .location-popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .location-popup-icon {
            font-size: 3rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }

        .location-popup-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.5rem;
            color: #fff;
        }

        .location-popup-info p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .location-popup-actions {
            display: grid;
            gap: 10px;
            margin-bottom: 16px;
        }

        .location-action-btn {
            background: rgba(102, 126, 234, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
            text-align: left;
        }

        .location-action-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .location-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .location-action-icon {
            font-size: 1.8rem;
            min-width: 40px;
            text-align: center;
        }

        .location-action-text {
            flex: 1;
        }

        .location-action-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .location-action-desc {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .location-action-cost {
            font-weight: bold;
            color: var(--warning);
            font-size: 0.9rem;
        }

        .location-popup-close {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-popup-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .location-popup {
                min-width: 90%;
                max-width: 90%;
            }
        }

        /* ========================================
           ENHANCED MODAL SYSTEM
           ======================================== */
        .enhanced-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.88);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .enhanced-dialog-content {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.98), rgba(40, 40, 60, 0.98));
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: min(90vw, 650px);
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            transition: all 0.2s;
            padding: 0;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        .modal-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }

        .modal-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .modal-section.info {
            border-left-color: #667eea;
        }

        .modal-section.success {
            border-left-color: #38ef7d;
        }

        .modal-section.warning {
            border-left-color: #ffd700;
        }

        .modal-section.danger {
            border-left-color: #eb3349;
        }

        .modal-section-title {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-section-content {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.9;
        }

        .modal-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .modal-action-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }

        .modal-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-action-btn .btn-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .modal-action-btn .btn-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .modal-action-btn .btn-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.4;
        }

        .modal-footer {
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- Old Chat Modal Removed - Now Using Dialogue System -->

    <!-- Dialogue System Modal (NEW) -->
    <div id="dialogueModal" class="dialogue-modal">
        <div class="dialogue-container">
            <div class="dialogue-header">
                <div class="dialogue-npc-info">
                    <div class="dialogue-npc-avatar" id="dialogueAvatar"></div>
                    <div class="dialogue-npc-details">
                        <h3 id="dialogueName">NPC Name</h3>
                        <p id="dialogueJob">Job</p>
                    </div>
                </div>
                <div class="dialogue-stats">
                    <div class="dialogue-stat"> <span id="dialogueRelation">0</span></div>
                    <div class="dialogue-stat"> <span id="dialogueConversations">0</span></div>
                </div>
                <button class="dialogue-close" onclick="closeDialogue()"></button>
            </div>
            <div class="trust-indicator">
                <span class="trust-icon" id="trustIcon"></span>
                <span class="trust-text">Livello: <strong id="trustLevel">Sconosciuto</strong></span>
            </div>
            <div class="dialogue-history" id="dialogueHistory"></div>
            <div class="dialogue-choices">
                <div class="dialogue-choices-title"> Cosa vuoi dire?</div>
                <div id="dialogueChoices"></div>
            </div>
        </div>
    </div>

    <div id="loadingScreen" class="loading-screen">
        <div style="text-align:center;color:#fff;">
            <div style="font-size:28px;margin-bottom:16px;"> City Life</div>
            <div style="font-size:18px;margin-bottom:8px;">Caricamento...</div>
            <div class="loading-spinner" style="width:50px;height:50px;border:4px solid rgba(255,255,255,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="container">
            <h1> City Life Simulator  Advanced</h1>
            <div class="card">
                <div class="grid grid-3">
                    <button onclick="newGame()"> Nuova Partita</button>
                    <button onclick="loadGame()"> Carica Partita</button>
                    <button onclick="showTutorial()"> Tutorial</button>
                </div>
            </div>
            <div class="card">
                <h3> Benvenuto!</h3>
                <p style="margin-top:8px; line-height:1.6;">Questa versione Advanced include un sistema di tempo realistico, azioni con effetti sulle statistiche, NPC con relazioni dinamiche, sistema di lavoro con promozioni, eventi casuali, missioni coinvolgenti e salvataggi automatici.</p>
            </div>
        </div>
    </div>

    <div id="characterScreen" class="screen">
        <div class="container" style="max-width:900px;">
            <!-- Header -->
            <div style="text-align:center; margin-bottom:24px; animation: fadeIn 0.8s;">
                <h1 style="font-size:2.5rem; margin-bottom:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                     Creazione Personaggio
                </h1>
                <p style="font-size:1.1rem; opacity:0.8;">Prepara la tua nuova vita a Eldoria</p>
            </div>

            <!-- Main Card -->
            <div class="card" style="animation: slideUp 0.6s;">
                
                <!-- Informazioni Base -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                         Informazioni Base
                    </h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px;">
                        <div>
                            <label style="display:block; margin-bottom:6px; font-weight:600;">Nome</label>
                            <input id="charName" placeholder="Inserisci il tuo nome..." style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;" />
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:6px; font-weight:600;">Genere</label>
                            <select id="charGender" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;">
                                <option value="male">Maschile</option>
                                <option value="female">Femminile</option>
                                <option value="other">Altro</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:16px;">
                        <label style="display:block; margin-bottom:6px; font-weight:600;">Et</label>
                        <select id="charAge" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;">
                            <option value="18">18 anni - Giovane e inesperto</option>
                            <option value="20" selected>20 anni - Fresco e motivato</option>
                            <option value="25">25 anni - Con un po' di esperienza</option>
                            <option value="30">30 anni - Maturo e navigato</option>
                        </select>
                    </div>
                </div>

                <!-- Background -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                         Background
                    </h3>
                    <select id="charBackground" onchange="updateBackgroundInfo()" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem; margin-bottom:12px;">
                        <option value="student"> Studente</option>
                        <option value="worker"> Lavoratore</option>
                        <option value="tech"> Tecnico IT</option>
                        <option value="artist"> Artista</option>
                    </select>
                    <div id="backgroundInfo" style="padding:12px; background:rgba(102,126,234,0.1); border-radius:8px; border-left:4px solid #667eea; font-size:0.9rem; line-height:1.6;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Difficolt -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                         Difficolt
                    </h3>
                    <select id="gameDifficulty" onchange="updateDifficultyInfo()" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem; margin-bottom:12px;">
                        <option value="easy"> Facile - Inizio comodo (1000)</option>
                        <option value="normal" selected> Normale - Esperienza bilanciata (500)</option>
                        <option value="hard"> Difficile - Vera sfida (200)</option>
                    </select>
                    <div id="difficultyInfo" style="padding:12px; background:rgba(255,215,0,0.1); border-radius:8px; border-left:4px solid #ffd700; font-size:0.9rem; line-height:1.6;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Tratti Caratteriali -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:8px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                         Tratti Caratteriali
                    </h3>
                    <p style="font-size:0.85rem; opacity:0.7; margin-bottom:12px;">Seleziona massimo 3 tratti che definiscono il tuo personaggio</p>
                    <div id="traitsGrid" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Start Button -->
                <div style="text-align:center; padding-top:16px; border-top:2px solid rgba(255,255,255,0.1);">
                    <button onclick="startGame()" style="font-size:1.2rem; padding:14px 32px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; border-radius:12px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(102,126,234,0.4); transition:all 0.3s; width:100%; max-width:400px;">
                         Inizia la Tua Avventura!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <!-- Top HUD Bar -->
        <div style="position:fixed; top:0; left:0; right:0; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:8px 16px; display:flex; gap:16px; align-items:center; justify-content:space-between; z-index:1000; border-bottom:2px solid rgba(102,126,234,0.3); flex-wrap:wrap;">
            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                <div style="min-width:180px;">
                    <div style="font-size:0.75rem; opacity:0.7;"></div>
                    <div id="gameTime" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;"></div>
                    <div id="playerMoney" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;"></div>
                    <div id="playerRep" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;"></div>
                    <div id="playerJob" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
            </div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                <button id="timePlayBtn" class="small" onclick="playTime()" style="background:#38ef7d; padding:4px 8px; margin-right:4px;"> Play</button>
                <button id="timePauseBtn" class="small" onclick="pauseTime()" style="background:#ff6b6b; padding:4px 8px;"> Pause</button>
                <button id="timeSpeedBtn" class="small" onclick="cycleTimeSpeed()" style="padding:4px 8px;"> 1x</button>
                <button class="small" onclick="toggleStatsPanel()" style="padding:4px 8px;"></button>
                <button class="small" onclick="toggleMenuPanel()" style="padding:4px 8px;"></button>
                <button class="small" onclick="saveGame()" style="padding:4px 8px;"></button>
            </div>
        </div>

        <!-- Stats Panel (directly under top bar) -->
        <div id="statsPanel" style="position:fixed; top:56px; left:0; right:0; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:12px 16px; z-index:999; border-bottom:1px solid rgba(102,126,234,0.3); transform:translateY(-100%); transition:transform 0.3s;">
            <!-- Vital Stats -->
            <details open style="margin-bottom:16px;">
                <summary style="font-size:0.9rem; font-weight:600; cursor:pointer; padding:6px; background:rgba(102,126,234,0.15); border-radius:6px; margin-bottom:8px;">
                     Statistiche
                </summary>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                            <span> Fame</span><span id="hungerValue"></span>
                        </div>
                        <div class="stat-bar"><div id="hungerBar" class="stat-fill"></div></div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                            <span> Energia</span><span id="energyValue"></span>
                        </div>
                        <div class="stat-bar"><div id="energyBar" class="stat-fill"></div></div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                            <span> Morale</span><span id="moraleValue"></span>
                        </div>
                        <div class="stat-bar"><div id="moraleBar" class="stat-fill"></div></div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                            <span> Salute</span><span id="healthValue"></span>
                        </div>
                        <div class="stat-bar"><div id="healthBar" class="stat-fill"></div></div>
                    </div>
                </div>
            </details>
            
            <!-- Skills -->
            <details style="margin-bottom:16px;">
                <summary style="font-size:0.9rem; font-weight:600; cursor:pointer; padding:6px; background:rgba(102,126,234,0.15); border-radius:6px;">
                     Abilit
                </summary>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-top:8px;">
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span> Intelletto</span><span id="intellectValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="intellectBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span> Fitness</span><span id="fitnessValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="fitnessBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span> Creativit</span><span id="creativityValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="creativityBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #fa709a 0%, #fee140 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span> Carisma</span><span id="charismaValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="charismaBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #30cfd0 0%, #330867 100%);"></div>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- Right Menu Sidebar (collapsible) -->
        <div id="menuSidebar" style="position:fixed; right:0; top:50px; bottom:0; width:250px; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:16px; overflow-y:auto; z-index:900; border-left:2px solid rgba(102,126,234,0.3); transition:transform 0.3s; transform:translateX(100%);">
            <h3 style="margin-top:0; font-size:1rem;"> Menu</h3>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:16px;">
                
                <!-- SEZIONE SISTEMA -->
            <details style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;"> Sistema</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="showWelcomeTutorial()" style="font-size:0.9rem;"> Guida</button>
                    <button onclick="saveGame()" style="font-size:0.9rem;"> Salva</button>
                    <button onclick="backToMenu()" style="font-size:0.9rem;"> Menu Principale</button>
                </div>
            </details>
            
            <!-- SEZIONE PERSONALE -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;"> Personale</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('skills')" style="font-size:0.9rem;"> Abilit</button>
                    <button onclick="switchMainTab('agenda')" style="font-size:0.9rem;"> Agenda</button>
                    <button onclick="switchMainTab('quests')" style="font-size:0.9rem;"> Missioni</button>
                </div>
            </details>

            <!-- SEZIONE SOCIALE -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;"> Sociale</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('social')" style="font-size:0.9rem;"> Persone</button>
                    <button onclick="switchMainTab('romance')" style="font-size:0.9rem;"> Relazioni</button>
                    <button onclick="switchMainTab('family')" style="font-size:0.9rem;"> Famiglia</button>
                    <button onclick="switchMainTab('social')" style="font-size:0.9rem;"> Sociale</button>
                </div>
            </details>

            <!-- SEZIONE ECONOMIA -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;"> Economia</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('work')" style="font-size:0.9rem;"> Lavoro</button>
                    <button onclick="switchMainTab('investments')" style="font-size:0.9rem;"> Investimenti</button>
                    <button onclick="switchMainTab('shop')" style="font-size:0.9rem;"> Spesa</button>
                    <button onclick="switchMainTab('crime')" style="font-size:0.9rem;"> Crimine</button>
                </div>
            </details>

            <!-- SEZIONE CITT -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;"> Citt</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('housing')" style="font-size:0.9rem;"> Abitazione</button>
                    <button onclick="showVehiclesMenu()" style="font-size:0.9rem;"> Veicoli</button>
                    <button onclick="showTransportMenu()" style="font-size:0.9rem;"> Trasporti</button>
                    <button onclick="showQuartersMenu()" style="font-size:0.9rem;"> Quartieri</button>
                </div>
            </details>

            
            </div>
        </div>

        <!-- Main Map Area -->
        <div style="position:fixed; left:0; right:0; top:56px; height:calc(100vh - 56px); overflow:auto; padding:20px; box-sizing:border-box;" id="mainMapArea">
            <div class="container" style="max-width:none; padding:20px;">
                <div class="card" style="min-height:calc(100vh - 100px);">
                    <h2 style="margin-top:0;"> Mappa della Citt</h2>
                    <div id="currentLocationDisplay" style="display:none; background:rgba(102,126,234,0.2); padding:12px; border-radius:8px; margin-bottom:16px;">
                        <strong> Posizione attuale:</strong> <span id="currentLocationText">Caricamento...</span>
                    </div>

                    <!-- Map Tabs -->
                    <div class="tab-buttons" style="margin-bottom:16px;">
                        <div class="tab-btn active" onclick="switchMapView('overview')"> Panoramica</div>
                        <div class="tab-btn" onclick="switchMapView('detailed')"> Dettaglio Quartiere</div>
                    </div>

                    <!-- Map Content -->

                    <!-- Overview Map -->
                    <div id="overviewMapContent" style="display:block;">
                        <div class="visual-map-container" id="visualMapContainer">
                            <div id="mapTooltip" class="map-tooltip"></div>
                            
                            <!-- Quarter Zones -->
                            <div class="map-grid" id="overviewMapGrid">
                                <!-- Top Row -->
                                <div class="quarter-zone" data-quarter="periferia" onclick="selectQuarterFromMap('periferia')" style="grid-column:1/3;">
                                    <div class="quarter-name"> Periferia</div>
                                    <div class="quarter-icon"></div>
                                    <div class="quarter-stats"> 15k |  300/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="quartiere_operaio" onclick="selectQuarterFromMap('quartiere_operaio')" style="grid-column:3/5;">
                                    <div class="quarter-name"> Q. Operaio</div>
                                    <div class="quarter-icon"></div>
                                    <div class="quarter-stats"> 22k |  450/m</div>
                                </div>
                                <div style="grid-column:5; background:rgba(34,139,34,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;"></div>
                                
                                <!-- Middle Row -->
                                <div class="quarter-zone" data-quarter="zona_residenziale" onclick="selectQuarterFromMap('zona_residenziale')" style="grid-column:1/2;">
                                    <div class="quarter-name"> Residenziale</div>
                                    <div class="quarter-icon"></div>
                                    <div class="quarter-stats"> 12k |  600/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="centro_storico" onclick="selectQuarterFromMap('centro_storico')" style="grid-column:2/4;">
                                    <div class="quarter-name"> Centro Storico</div>
                                    <div class="quarter-icon"></div>
                                    <div class="quarter-stats"> 18k |  700/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="quartiere_lusso" onclick="selectQuarterFromMap('quartiere_lusso')" style="grid-column:4/6;">
                                    <div class="quarter-name"> Luxury</div>
                                    <div class="quarter-icon"></div>
                                    <div class="quarter-stats"> 5k |  1200/m</div>
                                </div>
                                
                                <!-- Bottom Row -->
                                <div style="grid-column:1/2; background:rgba(30,144,255,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;"></div>
                                <div style="grid-column:2/4; background:rgba(34,139,34,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;"> Parco Centrale</div>
                                <div style="grid-column:4/6; background:rgba(139,69,19,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;"></div>
                            </div>

                            <!-- Detailed Quarter Map -->
                            <div class="detailed-quarter-map" id="detailedQuarterMap">
                                <button class="back-to-overview-btn" onclick="hideDetailedQuarterMap()"> Torna alla Mappa</button>
                                <h4 id="detailedQuarterName"></h4>
                                <div class="detailed-map-grid" id="detailedMapGrid">
                                    <!-- Roads, locations, etc. will be rendered here -->
                                </div>
                            </div>

                            <!-- Player Marker -->
                            <div id="playerMarker" class="player-marker" style="display:none;">
                                
                                <div class="player-location-label" id="playerLocationLabel"> Casa</div>
                            </div>

                            <!-- Legend -->
                            <div class="map-legend">
                                <div style="font-weight:bold; margin-bottom:8px;">Legenda</div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:#ff6b6b;"></div>
                                    <span>Tu</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--warning);"></div>
                                    <span>Fermata Bus</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--success); border-radius:4px;"></div>
                                    <span>Punto Interesse</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--primary);"></div>
                                    <span>Negozio</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Map -->
                    <div id="detailedMapContent" style="display:none;">
                        <div id="detailedMapContainer"></div>
                    </div>

                    <!-- Sezioni nascoste - ora accessibili dal menu laterale -->
                    <div id="vehiclesInfo" style="display:none;"></div>
                    <div id="transportInfo" style="display:none;"></div>
                    <div id="cityQuartiersMap" style="display:none;"></div>
                    <div id="quarterDetails" style="display:none;"></div>
                    <select id="quarterSelect" style="display:none;">
                        <option value="">Seleziona un quartiere...</option>
                        <option value="periferia">Periferia</option>
                        <option value="quartiere_operaio">Quartiere Operaio</option>
                        <option value="centro_storico">Centro Storico</option>
                        <option value="zona_residenziale">Zona Residenziale</option>
                        <option value="quartiere_lusso">Quartiere Luxury</option>
                    </select>
                </div>

                <div id="socialTabContent" class="tab-content">
                    <h3> Persone Conosciute</h3>
                    <div id="knownPeopleList" style="margin-top:12px;"></div>
                    <div style="margin-top:12px;">
                        <button onclick="action('meet_new')"> Incontra Nuove Persone</button>
                    </div>
                </div>

                <div id="workTabContent" class="tab-content">
                    <h3> Situazione Lavorativa</h3>
                    <div id="workStatusDiv" style="margin-top:12px;"></div>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">Offerte di Lavoro</summary>
                        <div id="jobListingsDiv" style="margin-top:8px;"></div>
                    </details>
                </div>

                <div id="cityTabContent" class="tab-content">
                    <h3> Esplora la Citt</h3>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Parco & Natura</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('park')"> Passeggiata</button>
                            <button onclick="action('jog_park')"> Jogging</button>
                            <button onclick="action('picnic')"> Picnic</button>
                            <button onclick="action('bird_watching')"> Birdwatching</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Sport & Fitness</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('gym')"> Palestra</button>
                            <button onclick="action('swimming')"> Piscina</button>
                            <button onclick="action('yoga_class')"> Yoga</button>
                            <button onclick="action('boxing')"> Boxe</button>
                            <button onclick="action('bowling')"> Bowling</button>
                            <button onclick="action('mini_golf')"> Mini Golf</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Cultura & Educazione</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('library')"> Biblioteca</button>
                            <button onclick="action('research')"> Ricerca</button>
                            <button onclick="action('book_club')"> Club Lettura</button>
                            <button onclick="action('museum')"> Museo</button>
                            <button onclick="action('art_gallery')"> Galleria Arte</button>
                            <button onclick="action('guided_tour')"> Tour Guidato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Cibo & Bevande</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cafe')"> Caff</button>
                            <button onclick="action('breakfast_cafe')"> Colazione</button>
                            <button onclick="action('cafe_work')"> Lavora al Caff</button>
                            <button onclick="action('fast_food')"> Fast Food</button>
                            <button onclick="action('restaurant')"> Ristorante</button>
                            <button onclick="action('fine_dining')"> Ristorante Stellato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Vita Notturna</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('bar')"> Bar</button>
                            <button onclick="action('nightclub')"> Discoteca</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Shopping</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('window_shopping')"> Vetrine</button>
                            <button onclick="action('shopping')"> Shopping</button>
                            <button onclick="action('luxury_shopping')"> Shopping Lusso</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Benessere & Relax</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('spa')"> Spa</button>
                            <button onclick="action('massage')"> Massaggio</button>
                            <button onclick="action('sauna')"> Sauna</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Corsi & Formazione</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cooking_class')"> Corso Cucina</button>
                            <button onclick="action('language_class')"> Corso Lingue</button>
                            <button onclick="action('art_class')"> Corso Arte</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Volontariato</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('volunteer')"> Volontariato</button>
                            <button onclick="action('animal_shelter')"> Rifugio Animali</button>
                        </div>
                    </details>
                </div>

                <div id="questsTabContent" class="tab-content">
                    <h3> Le Tue Missioni</h3>
                    <div id="questsList" style="margin-top:12px;"></div>
                </div>

                <div id="skillsTabContent" class="tab-content">
                    <h3> Abilit e Statistiche</h3>
                    
                    <div style="padding:10px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:12px; text-align:center;">
                        <span style="font-weight:600;">Allenamenti Oggi:</span> 
                        <span id="dailyTrainingCount" style="font-weight:bold; color:var(--warning);">0/3</span>
                        <span style="font-size:0.85rem; opacity:0.8; margin-left:8px;"> Massimo 3 attivit di apprendimento al giorno</span>
                    </div>
                    
                    <div id="skillsDisplay" style="margin-top:12px;">
                        <div style="padding:14px; background:rgba(102,126,234,0.08); border-radius:12px; border-left:4px solid var(--primary);">
                            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:16px;">
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;"> Intelletto</span>
                                        <span id="intellectValue" style="font-size:1.2rem; font-weight:bold; color:var(--primary);">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="intellectBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="intellectLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;"> Fitness</span>
                                        <span id="fitnessValue" style="font-size:1.2rem; font-weight:bold; color:#f5576c;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="fitnessBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="fitnessLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;"> Creativit</span>
                                        <span id="creativityValue" style="font-size:1.2rem; font-weight:bold; color:#fee140;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="creativityBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #fa709a 0%, #fee140 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="creativityLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;"> Carisma</span>
                                        <span id="charismaValue" style="font-size:1.2rem; font-weight:bold; color:#30cfd0;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="charismaBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #30cfd0 0%, #330867 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="charismaLevel">Novizio</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <details style="margin-top:20px;" open>
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Allenamento Intelletto</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('read')"> Leggi Libro</button>
                            <button onclick="action('study')"> Studia</button>
                            <button onclick="action('library')"> Biblioteca</button>
                            <button onclick="action('research')"> Ricerca</button>
                            <button onclick="action('museum')"> Museo</button>
                            <button onclick="action('guided_tour')"> Tour Guidato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Allenamento Fitness</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('exercise')"> Esercizio</button>
                            <button onclick="action('jog_park')"> Jogging Parco</button>
                            <button onclick="action('gym')"> Palestra</button>
                            <button onclick="action('swimming')"> Nuoto</button>
                            <button onclick="action('boxing')"> Boxe</button>
                            <button onclick="action('yoga')"> Yoga</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Allenamento Creativit</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('hobby_paint')"> Dipingi</button>
                            <button onclick="action('art_gallery')"> Galleria Arte</button>
                            <button onclick="action('theater')"> Teatro</button>
                            <button onclick="action('opera')"> Opera</button>
                            <button onclick="action('music_lesson')"> Lezione Musica</button>
                            <button onclick="action('photography')"> Fotografia</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Allenamento Carisma</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('nightclub')"> Nightclub</button>
                            <button onclick="action('bar')"> Bar</button>
                            <button onclick="action('karaoke')"> Karaoke</button>
                            <button onclick="action('book_club')"> Book Club</button>
                            <button onclick="action('networking')"> Networking</button>
                            <button onclick="action('public_speaking')"> Public Speaking</button>
                        </div>
                    </details>
                </div>

                <div id="housingTabContent" class="tab-content">
                    <h3> Situazione Abitativa</h3>
                    <div id="currentHousingInfo" style="margin-top:12px;"></div>
                    
                    <details style="margin-top:20px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Quartieri Disponibili</summary>
                        <div id="neighborhoodsList" style="margin-top:12px;"></div>
                    </details>

                    <details style="margin-top:20px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Sistema Economico</summary>
                        <div style="padding:12px; background:rgba(255,200,100,0.1); border-radius:8px; border-left:3px solid var(--warning); margin-top:8px;">
                            <p style="margin-top:8px; font-size:0.9rem;"> L'affitto viene pagato automaticamente ogni 30 giorni</p>
                            <p style="margin-top:4px; font-size:0.9rem;"> Le tasse (10% del reddito) vengono pagate ogni 90 giorni</p>
                            <p style="margin-top:4px; font-size:0.9rem;"> Il costo del cibo varia in base al quartiere</p>
                        </div>
                    </details>
                </div>

                <div id="shopTabContent" class="tab-content">
                    <h3> Supermercato</h3>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Il Tuo Inventario Cibo</summary>
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-top:8px;">
                            <div id="foodInventory" style="margin-top:8px;"></div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Prodotti Disponibili</summary>
                        <div id="foodShop" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px; margin-top:12px;"></div>
                    </details>
                </div>

                <div id="agendaTabContent" class="tab-content">
                    <h3> Agenda</h3>
                    
                    <div style="padding:12px; background:rgba(102,126,234,0.1); border-radius:8px; margin-bottom:16px; border-left:3px solid var(--primary);">
                        <h4 style="margin-bottom:8px;"> Oggi: Giorno <span id="agendaCurrentDay">1</span> - Ore <span id="agendaCurrentHour">08:00</span></h4>
                        <div style="font-size:0.9rem; opacity:0.9;">Organizza i tuoi appuntamenti e non perderti nulla!</div>
                    </div>
                    
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <button onclick="showAddAppointmentDialog()" class="action-btn" style="flex:1; background:var(--success);">
                             Nuovo Appuntamento
                        </button>
                        <button onclick="showDailyTimeline()" class="action-btn" style="flex:1; background:var(--primary);">
                             Timeline Oggi
                        </button>
                    </div>
                    
                    <details open>
                        <summary style="font-size:1rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;">
                             Timeline Giornaliera
                        </summary>
                        <div id="dailyTimelineView" style="margin-top:12px;"></div>
                    </details>
                    
                    <details open style="margin-top:16px;">
                        <summary style="font-size:1rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;">
                             Prossimi Appuntamenti
                        </summary>
                        <div id="upcomingAppointments" style="margin-top:12px;"></div>
                    </details>
                    
                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;">
                             Appuntamenti Passati
                        </summary>
                        <div id="pastAppointments" style="margin-top:12px;"></div>
                    </details>
                </div>

                <div id="romanceTabContent" class="tab-content">
                    <h3> Relazioni Romantiche</h3>
                    <div id="romanceStatus" style="margin-top:12px;"></div>
                    <div id="datingList" style="margin-top:16px;"></div>
                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Potenziali Partner</summary>
                        <div id="potentialPartners" style="margin-top:12px;"></div>
                    </details>
                </div>

                <div id="familyTabContent" class="tab-content">
                    <h3> Famiglia</h3>
                    <div id="familyStatus" style="margin-top:12px;"></div>
                    <div id="childrenList" style="margin-top:16px;"></div>
                </div>

                <div id="investmentsTabContent" class="tab-content">
                    <h3> Investimenti e Finanze</h3>
                    
                    <details open style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Gestione Denaro</summary>
                        <div style="margin-top:8px; padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div style="padding:10px; background:rgba(56,239,125,0.15); border-radius:8px;">
                                    <div style="font-size:0.85rem; opacity:0.8;"> Contante</div>
                                    <div style="font-weight:bold; font-size:1.3rem; color:var(--success);"><span id="cashDisplay">0</span></div>
                                    <div style="font-size:0.75rem; opacity:0.6;">Pu essere rubato</div>
                                </div>
                                <div style="padding:10px; background:rgba(56,159,239,0.15); border-radius:8px;">
                                    <div style="font-size:0.85rem; opacity:0.8;"> Banca</div>
                                    <div style="font-weight:bold; font-size:1.3rem; color:var(--primary);"><span id="bankDisplay">0</span></div>
                                    <div style="font-size:0.75rem; opacity:0.6;">Sicuro</div>
                                </div>
                            </div>
                            <button onclick="showBankDialog()" class="action-btn" style="width:100%;">
                                 Gestisci Conti Bancari
                            </button>
                        </div>
                    </details>
                    
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Conto Risparmio</summary>
                        <div style="margin-top:8px; padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-size:0.9rem; opacity:0.8;">Saldo Risparmi</div>
                                    <div style="font-weight:bold; font-size:1.5rem; color:var(--success);" id="savingsAmount">0</div>
                                    <div style="font-size:0.85rem; opacity:0.7;">Interesse: 2% mensile</div>
                                </div>
                                <div style="display:flex; gap:8px; flex-direction:column;">
                                    <button class="small" onclick="depositSavings()"> Deposita</button>
                                    <button class="small" onclick="withdrawSavings()"> Preleva</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Azioni</summary>
                        <div id="stockPortfolio" style="margin-top:12px;"></div>
                        <div style="margin-top:12px;">
                            <h5>Mercato Azionario</h5>
                            <div id="stockMarket" class="grid" style="grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:12px; margin-top:8px;"></div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Propriet Immobiliari</summary>
                        <div id="propertiesList" style="margin-top:12px;"></div>
                        <div style="margin-top:12px;">
                            <button onclick="showPropertyMarket()"> Mercato Immobiliare</button>
                        </div>
                    </details>
                </div>

                <div id="crimeTabContent" class="tab-content">
                    <h3> Attivit Alternative</h3>
                    
                    <details style="padding:0; margin-bottom:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> ATTENZIONE</summary>
                        <div style="padding:12px; background:rgba(255,100,100,0.1); border-radius:8px; border-left:3px solid var(--danger); margin-top:8px;">
                            <p style="font-size:0.9rem; opacity:0.9;">Le attivit illegali comportano rischi: arresto, multe, perdita reputazione. Procedi con cautela!</p>
                        </div>
                    </details>

                    <div id="crimeStatus" style="margin-top:12px;"></div>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Attivit Disponibili</summary>
                        <div class="grid grid-3" style="margin-top:12px;">
                            <button onclick="crimeAction('pickpocket')"> Borseggio</button>
                            <button onclick="crimeAction('burglary')"> Furto</button>
                            <button onclick="crimeAction('hack')"> Hacking</button>
                            <button onclick="crimeAction('scam')"> Truffa Online</button>
                            <button onclick="crimeAction('smuggle')"> Contrabbando</button>
                            <button onclick="crimeAction('blackjack')"> Blackjack Illegale</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Riscatto</summary>
                        <div style="padding:12px; background:rgba(56,239,125,0.1); border-radius:8px; border-left:3px solid var(--success); margin-top:8px;">
                            <p style="font-size:0.9rem; margin-top:6px;">Se hai precedenti, puoi pulire la fedina penale:</p>
                            <button onclick="clearRecord()" style="margin-top:8px;"> Pulisci Fedina (5000)</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Intrattenimento</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cinema')"> Cinema</button>
                            <button onclick="action('cinema_vip')"> Cinema VIP</button>
                            <button onclick="action('theater')"> Teatro</button>
                            <button onclick="action('opera')"> Opera</button>
                            <button onclick="action('live_music')"> Musica Live</button>
                            <button onclick="action('karaoke')"> Karaoke</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ---------- ENHANCED DIALOGUE SYSTEM ----------
    const ENHANCED_DIALOGUE_SYSTEM = {
        topics: {
            greeting: {
                questions: ['Come va la giornata?', 'Tutto bene?', 'Come stai?', 'Che mi racconti?', 'Come procede tutto?', 'Novit interessanti?', 'Che ne dici di quest\'aria?', 'Giornata pesante?', 'Hai dormito bene?', 'Come ti senti oggi?', 'Bella giornata vero?', 'Hai gi mangiato?', 'Stanco?', 'Energico oggi?', 'Umore buono?'],
                responses: {
                    positive: ['Molto bene, grazie!', 'Tutto perfetto!', 'Non potrebbe andare meglio!', 'Splendida giornata!', 'Sono in forma!', 'Mai stato meglio!', 'Giornata fantastica!', 'Pieno di energie!', 'Ottima giornata!', 'Super positivo!'],
                    neutral: ['Bene, grazie', 'Tutto nella norma', 'Si va avanti', 'Come sempre', 'Niente di che', 'Normale routine', 'Come al solito', 'Cos cos', 'Si tira avanti', 'Nella media'],
                    negative: ['Potrebbe andare meglio...', 'Non  la mia giornata', 'Ho avuto giorni migliori', 'Un po\' stressato', 'Giornata difficile', 'Non molto bene', 'Potrebbe essere peggio', 'Stanchissimo', 'Non al massimo', 'Giornata no']
                }
            },
            work: {
                questions: ['Come va il lavoro?', 'Ti piace quello che fai?', 'Progetti per la carriera?', 'Il tuo capo come ?', 'Colleghi simpatici?', 'Orari pesanti?', 'Stipendio soddisfacente?', 'Opportunit di crescita?', 'Ambiente lavorativo?', 'Benefit aziendali?', 'Smart working possibile?', 'Formazione prevista?', 'Stress sul lavoro?', 'Equilibrio vita-lavoro?', 'Soddisfatto della tua posizione?', 'Cambieresti lavoro?', 'Relazioni con i capi?', 'Prospettive di carriera?', 'Ti senti valorizzato?', 'Ferie sufficienti?'],
                responses: {
                    positive: ['Adoro il mio lavoro!', ' molto gratificante', 'Sto imparando tanto', 'Team fantastico!', 'Ambiente stimolante', 'Grande opportunit', 'Capo comprensivo', 'Colleghi come amici', 'Lavoro dei sogni!', 'Crescita continua', 'Mi sento realizzato', 'Perfetto per me'],
                    neutral: [' un lavoro come un altro', 'Paga le bollette', 'Va bene cos', 'Routine quotidiana', 'Niente di speciale', 'Fa il suo', 'Accettabile', 'Si potrebbe migliorare', 'Nella norma', 'N bene n male'],
                    negative: ['Non  quello che sognavo', 'Sto cercando altro', ' stressante', 'Troppa pressione', 'Ambiente tossico', 'Sottopagato', 'Nessuna crescita', 'Capo impossibile', 'Orari assurdi', 'Voglio cambiare', 'Non mi valorizzano', 'Troppo stress']
                }
            },
            personal: {
                questions: ['Come va la vita sentimentale?', 'Famiglia numerosa?', 'Progetti futuri?', 'Sogni nel cassetto?', 'Cosa ti rende felice?', 'Paure pi grandi?', 'Hobby preferiti?', 'Dove vorresti viaggiare?', 'Film preferito?', 'Musica che ascolti?', 'Sport praticati?', 'Libri letti recentemente?', 'Serie TV seguite?', 'Animali domestici?', 'Cucina preferita?', 'Vacanza ideale?', 'Momento della giornata preferito?', 'Stagione favorita?', 'Talenti nascosti?', 'Obiettivi di vita?'],
                responses: {
                    positive: ['Tutto va per il meglio', 'Famiglia meravigliosa', 'Tanti progetti entusiasmanti', 'Felicissimo', 'Vita piena', 'Tante passioni', 'Sogni realizzabili', 'Momento d\'oro', 'Relazioni bellissime', 'Pieno di idee'],
                    neutral: ['Si va avanti', 'Famiglia normale', 'Vedremo cosa succede', 'Niente di speciale', 'Vita standard', 'Pochi hobby', 'Obiettivi vaghi', 'Tutto ok', 'Situazione stabile', 'Come tutti'],
                    negative: [' complicato', 'Situazione difficile', 'Incertezze sul futuro', 'Single e triste', 'Pochi amici', 'Nessun hobby', 'Sogni infranti', 'Momento buio', 'Solitudine', 'Senza direzione']
                }
            },
            city: {
                questions: ['Ti piace Eldoria?', 'Quartiere preferito?', 'Posti da evitare?', 'Ristoranti consigliati?', 'Vita notturna?', 'Sicurezza in citt?', 'Trasporti pubblici?', 'Costo della vita?', 'Eventi in citt?', 'Luoghi nascosti da vedere?', 'Parchi pi belli?', 'Shopping migliore?', 'Vita culturale?', 'Problemi della citt?', 'Cambieresti citt?'],
                responses: {
                    positive: ['Eldoria  fantastica!', 'Adoro vivere qui', 'Citt piena di vita', 'Mai noiosa', 'Tante opportunit', 'Gente meravigliosa', 'Sicura e vivibile', 'Perfetta per me', 'Non la lascerei mai'],
                    neutral: ['Va bene', 'Come tutte le citt', 'Ha pro e contro', 'Ci si abitua', 'Dipende dal quartiere', 'Niente di speciale', 'Citt normale', 'Ok per vivere'],
                    negative: ['Troppo caotica', 'Criminalit alta', 'Costosa', 'Traffico impossibile', 'Troppo inquinata', 'Gente fredda', 'Vorrei andarmene', 'Non mi piace']
                }
            },
            money: {
                questions: ['Come vanno le finanze?', 'Risparmi qualcosa?', 'Investimenti?', 'Debiti da pagare?', 'Stipendio sufficiente?', 'Spese pi grandi?', 'Come gestisci i soldi?', 'Banca affidabile?', 'Pensione?', 'Assicurazioni?'],
                responses: {
                    positive: ['Bene, riesco a risparmiare', 'Portfolio diversificato', 'Nessun debito', 'Vivendo bene', 'Finanze sane', 'Investimenti solidi'],
                    neutral: ['Arrivo a fine mese', 'Qualche risparmio', 'Gestione oculata', 'N ricco n povero', 'Si va avanti'],
                    negative: ['Sempre in rosso', 'Debiti accumulati', 'Non basta mai', 'Situazione critica', 'Devo risparmiare']
                }
            },
            health: {
                questions: ['Come va la salute?', 'Fai sport?', 'Dieta equilibrata?', 'Dormi abbastanza?', 'Stress gestibile?', 'Check-up recenti?', 'Problemi di salute?', 'Palestra o casa?', 'Vita sana?', 'Ti prendi cura di te?'],
                responses: {
                    positive: ['In forma perfetta', 'Sport regolare', 'Dieta sana', 'Dormo benissimo', 'Zero stress', 'Salute di ferro'],
                    neutral: ['Tutto ok', 'Un po\' di sport', 'Dieta normale', 'Dormo discretamente', 'Stress moderato'],
                    negative: ['Non benissimo', 'Sedentario totale', 'Mangio male', 'Insonnia', 'Stressatissimo', 'Trascuro la salute']
                }
            },
            weather: {
                questions: ['Che tempo fa?', 'Ti piace questa stagione?', 'Caldo o freddo?', 'Pioggia o sole?', 'Neve o estate?', 'Tempo ideale?', 'Influenza del meteo sull\'umore?'],
                responses: {
                    positive: ['Tempo perfetto', 'Adoro questa stagione', 'Temperatura ideale', 'Sole magnifico', 'Clima fantastico'],
                    neutral: ['Tempo normale', 'Stagione ok', 'Temperatura accettabile', 'Come sempre', 'Niente di che'],
                    negative: ['Troppo caldo', 'Troppo freddo', 'Pioggia continua', 'Tempo pessimo', 'Stagione orribile']
                }
            },
            philosophy: {
                questions: ['Senso della vita?', 'Cosa conta davvero?', 'Felicit ...?', 'Dopo la morte?', 'Destino o caso?', 'Dio esiste?', 'Giusto e sbagliato?', 'Tempo o denaro?', 'Amore o successo?', 'Vivere per cosa?'],
                responses: {
                    positive: ['La vita  meravigliosa', 'Conta l\'amore', 'La felicit  semplice', 'Credo nel destino', 'Tutto ha un senso'],
                    neutral: ['Non lo so', 'Difficile dirlo', 'Ognuno la sua verit', 'Mistero irrisolto', 'Forse entrambi'],
                    negative: ['La vita  dura', 'Non c\' un senso', 'Felicit illusoria', 'Solo caso', 'Niente conta']
                }
            }
        }, // Fine propriet philosophy dentro topics  
        skillBasedDialogue: {
            intellect: {
                10: { questions: ['Leggi mai?', 'Guardi le notizie?', 'Quiz show?'], responses: ['Poco tempo', 'Solo sport', 'Troppo difficili'] },
                20: { questions: ['Film o libri?', 'Documentari?', 'App news?'], responses: ['Film d\'azione', 'Qualcuno', 'Scrollo titoli'] },
                30: { questions: ['Cosa pensi delle notizie?', 'Hai letto qualche libro interessante?', 'Podcast ascolti?', 'Storia ti interessa?'], responses: ['Ho delle teorie interessanti...', 'Recentemente ho studiato...', 'Alcuni tech', 'Epoca romana'] },
                40: { questions: ['Saggi o narrativa?', 'Scienza seguita?', 'Filosofia?', 'Economia?'], responses: ['Entrambi', 'Fisica quantistica', 'Stoicismo', 'Macro interessante'] },
                50: { questions: ['Potresti spiegarmi questo concetto?', 'Che ne pensi di questa teoria?', 'Pubblicazioni lette?', 'Ricerca tua?'], responses: [' un argomento complesso...', 'Dal mio punto di vista...', 'Nature e Science', 'Campo interessante'] },
                60: { questions: ['Dibattito filosofico?', 'Teoria economica?', 'Scoperte recenti?', 'AI e futuro?'], responses: ['Stimolante', 'Keynes era brillante', 'CRISPR rivoluzionario', 'Cambier tutto'] },
                70: { questions: ['Collaboreresti a un progetto di ricerca?', 'Insegneresti qualcosa?', 'Conferenze?', 'Pubblicato articoli?'], responses: ['Sarei onorato di contribuire', 'Posso condividere le mie conoscenze', 'Tenuto alcune', 'Peer reviewed'] },
                80: { questions: ['Dottorato conseguito?', 'Brevetti?', 'Cattedra universitaria?', 'H-index?'], responses: ['PhD in fisica', 'Due pending', 'Professore associato', 'Discreto'] },
                90: { questions: ['Nobel candidatura?', 'Scoperte rivoluzionarie?', 'Eredit scientifica?'], responses: ['Chi lo sa...', 'Campo avanzato', 'Contributi significativi'] }
            },
            charisma: {
                10: { questions: ['Timido?', 'Poche amicizie?', 'Parlare in pubblico?'], responses: ['Molto', 'Preferisco', 'Mi terrorizza'] },
                20: { questions: ['Eventi sociali?', 'Gruppo o soli?', 'Conversazioni?'], responses: ['Li evito', 'Piccoli gruppi', 'Fatico'] },
                30: { questions: ['Organizzi mai eventi?', 'Sei bravo a parlare in pubblico?', 'Nuove persone?', 'Feste?'], responses: ['Mi piace coinvolgere le persone', 'Ho una certa facilit di parola', 'Aperto', 'Divertenti'] },
                40: { questions: ['Leadership?', 'Team work?', 'Networking?', 'Presentazioni?'], responses: ['Quando serve', 'Collaboro bene', 'Utile', 'Me la cavo'] },
                50: { questions: ['Potresti convincere qualcuno per me?', 'Daresti consigli di comunicazione?', 'Negoziazioni?', 'Conflitti?'], responses: ['Posso provare a mediare', 'La comunicazione  importante', 'Risultati buoni', 'Li risolvo'] },
                60: { questions: ['Influenza sugli altri?', 'Motivare team?', 'Public speaking?', 'Empatia?'], responses: ['Naturale', 'So coinvolgere', 'Senza paura', 'Capisco le persone'] },
                70: { questions: ['Saresti un ottimo leader', 'Potresti guidare un team?', 'Ispiri fiducia?', 'Carisma?'], responses: ['Mi piacciono le sfide di leadership', 'So motivare le persone', 'Mi dicono di s', 'Innato'] },
                80: { questions: ['Celebrit locale?', 'Seguaci fedeli?', 'Parlare a folle?', 'Cambi opinioni?'], responses: ['Un po\' conosciuto', 'Community forte', 'Grandi platee', 'Influente'] },
                90: { questions: ['Leader riconosciuto?', 'Presenza magnetica?', 'Trascinatore?'], responses: ['In certi ambienti', 'Si nota', 'Mi seguono'] }
            },
            creativity: {
                10: { questions: ['Arte?', 'Musica?', 'Disegno?'], responses: ['Non capisco', 'Solo ascolto', 'Pessimo'] },
                20: { questions: ['Hobby creativi?', 'Foto?', 'DIY?'], responses: ['Standard', 'Selfie', 'Seguo guide'] },
                30: { questions: ['Fai qualcosa di artistico?', 'Hai idee creative?', 'Strumento?', 'Scrivere?'], responses: ['Mi piace esprimermi creativamente', 'Ho sempre nuove idee', 'Chitarra base', 'Blog personale'] },
                40: { questions: ['Progetti creativi?', 'Portfolio?', 'Stile personale?', 'Design?'], responses: ['Alcuni in corso', 'Online', 'Mio modo', 'Mi diverte'] },
                50: { questions: ['Potresti aiutarmi con un progetto creativo?', 'Cosa ne pensi di questo design?', 'Mostre?', 'Commissioni?'], responses: ['Posso dare il mio contributo artistico', 'Ho alcune idee innovative', 'Una locale', 'Qualcuna'] },
                60: { questions: ['Opere vendute?', 'Album registrati?', 'Romanzo scritto?', 'Gallerie?'], responses: ['Su Etsy', 'EP indie', 'Autopubblicato', 'Qualche contatto'] },
                70: { questions: ['Sei un vero artista!', 'Potresti insegnare arte?', 'Premi vinti?', 'Riconoscimento?'], responses: ['L\'arte  la mia passione', 'Posso ispirare altri creativi', 'Concorso regionale', 'Crescente'] },
                80: { questions: ['Mostre importanti?', 'Tour?', 'Best seller?', 'Movimento artistico?'], responses: ['Gallerie nazionali', 'Europa', 'In classifica', 'Neo-surrealismo'] },
                90: { questions: ['Eredit artistica?', 'Rivoluzione stilistica?', 'Opera magnum?'], responses: ['Influenzato molti', 'Trend setter', 'In lavorazione'] }
            },
            fitness: {
                10: { questions: ['Sport?', 'Scale?', 'Camminare?'], responses: ['Mai', 'Ascensore', 'Minimo'] },
                20: { questions: ['Palestra?', 'Bici?', 'Passeggiate?'], responses: ['Ci pensavo', 'Raramente', 'Weekend'] },
                30: { questions: ['Fai sport regolarmente?', 'Tieni alla forma fisica?', 'Corsa?', 'Dieta?'], responses: ['Cerco di mantenermi in forma', 'L\'esercizio  importante', '3km facili', 'Equilibrata'] },
                40: { questions: ['Allenamenti settimanali?', 'Sport praticati?', 'Obiettivi?', 'App fitness?'], responses: ['3-4 volte', 'Calcetto', 'Mantenermi', 'MyFitnessPal'] },
                50: { questions: ['Potresti allenarmi?', 'Che routine consigli?', 'Cardio o pesi?', 'Supplementi?'], responses: ['Posso condividere i miei allenamenti', 'Conosco buone tecniche', 'Mix bilanciato', 'Proteine'] },
                60: { questions: ['Gare partecipate?', 'Record personali?', 'CrossFit?', 'Massa muscolare?'], responses: ['Alcune locali', 'Migliorando', 'WODs', 'In crescita'] },
                70: { questions: ['Sei in forma incredibile!', 'Faresti il personal trainer?', 'Maratone?', 'Triathlon?'], responses: ['Il fitness  il mio stile di vita', 'Posso aiutare altri a migliorare', 'Corsa una', 'Sprint'] },
                80: { questions: ['Competizioni agonistiche?', 'Sponsor?', 'Record regionali?', 'Allenamenti quotidiani?'], responses: ['Livello semi-pro', 'Locale', 'Under 23', 'Due sessioni'] },
                90: { questions: ['Carriera professionista?', 'Olimpiadi?', 'Medaglie nazionali?'], responses: ['Part-time', 'Aspirazione', 'Alcune'] }
            }
        },
        jobBasedDialogue: {
            'Disoccupato': { 
                questions: ['Stai cercando lavoro?', 'Che tipo di lavoro vorresti?', 'Difficile trovare?', 'Da quanto sei disoccupato?', 'Hai mandato CV?', 'Colloqui fatti?', 'Formazione in corso?', 'Cambiare settore?', 'Aspettative salariali?', 'Piano B?', 'Ti aiuta qualcuno?', 'Hai risparmi?'], 
                responses: ['Sto mandando CV', 'Vorrei qualcosa che mi piace', 'Il mercato  difficile', 'Da qualche mese purtroppo', 'Ogni giorno nuove candidature', 'Alcuni colloqui senza esito', 'Sto studiando online', 'Sto considerando altre opzioni', 'Qualsiasi cosa decente', 'Sto valutando alternative', 'La famiglia mi sostiene', 'I risparmi stanno finendo'] 
            },
            'Programmatore Jr': { 
                questions: ['Come va con il codice?', 'Che linguaggi usi?', 'Progetti interessanti?', 'Framework preferito?', 'Bug pi strani?', 'Pair programming?', 'Code review?', 'Stack tecnologico?', 'Deadline strette?', 'Senior disponibili?', 'Impari molto?', 'Vuoi specializzarti?'], 
                responses: ['Sto imparando molto', 'Lavoro principalmente con...', 'Stiamo sviluppando...', 'React e Node.js', 'Ogni giorno nuovi bug', 'S, molto utile', 'Ricevo feedback costanti', 'MERN stack completo', 'Sprint di due settimane', 'Team molto preparato', 'Crescita continua', 'Interessato al backend'] 
            },
            'Manager Vendite': { 
                questions: ['Come vanno le vendite?', 'Gestisci un team?', 'Obiettivi del trimestre?', 'Strategia commerciale?', 'Clienti difficili?', 'Incentivi e bonus?', 'CRM usato?', 'Lead generation?', 'Trattative complesse?', 'Formazione del team?', 'KPI principali?', 'Mercato competitivo?'], 
                responses: ['Il team sta performando bene', 'Abbiamo superato gli obiettivi', 'Sto formando nuovi talenti', 'Focus su qualit e servizio', 'Gestiti con diplomazia', 'Sistema di bonus motivante', 'Salesforce principalmente', 'Multi-channel approach', 'Negoziazioni win-win', 'Training settimanale', 'Revenue e retention', 'Molto, ma siamo forti'] 
            },
            'Barista': { 
                questions: ['Che caff consigli?', 'Clienti interessanti?', 'Orari pesanti?', 'Latte art?', 'Macchina usata?', 'Chicchi preferiti?', 'Clienti abituali?', 'Rush hour stressante?', 'Propine buone?', 'Colleghi simpatici?', 'Passione o lavoro?', 'Aprire un locale?'], 
                responses: ['Dipende dai gusti', 'Ogni giorno storie nuove', 'Si inizia presto ma mi piace', 'Sto imparando le tecniche', 'Professionale, ottima', 'Arabica 100%', 'Conosco tutti i nomi', 'Mattina sempre piena', 'Dipende dal giorno', 'Team affiatato', 'Vera passione', 'Sogno nel cassetto'] 
            },
            'Medico': { 
                questions: ['Casi interessanti?', 'Specializzazione?', 'Orari impossibili?', 'Emergenze notturne?', 'Pazienti difficili?', 'Medicina preventiva?', 'Aggiornamento continuo?', 'Stress del lavoro?', 'Soddisfazioni grandi?', 'Errori medici?', 'Assicurazione malpractice?', 'Vita privata?'], 
                responses: ['Ogni caso  unico', 'Mi sono specializzato in...', 'Le emergenze non aspettano', 'Turni di notte frequenti', 'Empatia e pazienza', 'Fondamentale per la salute', 'Congressi e studi costanti', 'Alto ma gratificante', 'Salvare vite', 'Protocolli rigorosi', 'Obbligatoria', 'Difficile trovare equilibrio'] 
            },
            'Cassiere': {
                questions: ['Clienti maleducati?', 'Furti frequenti?', 'Coda infinita?', 'Promozioni complicate?', 'Colleghi alla cassa?', 'Piedi stanchi?', 'Cambio turni?', 'Monotono?', 'Offerte speciali?', 'Sistema POS?'],
                responses: ['Capita spesso', 'Sicurezza attenta', 'Ore di punta pazzesche', 'Sistema confuso', 'Team solidale', 'Sempre in piedi', 'Turni variabili', 'Routine ripetitiva', 'Le gestisco io', 'Tecnologia moderna']
            },
            'Insegnante': {
                questions: ['Studenti motivati?', 'Materia preferita?', 'Compiti da correggere?', 'Genitori invadenti?', 'Stipendio adeguato?', 'Riforme scolastiche?', 'Classi numerose?', 'Vocazione o lavoro?', 'Estate libera?', 'Tecnologia in classe?'],
                responses: ['Alcuni molto', 'La mia materia mi appassiona', 'Montagne di verifiche', 'A volte troppo', 'Non rispecchia l\'impegno', 'Sempre in cambiamento', 'Troppi studenti', 'Vera vocazione', 'Periodo di riposo meritato', 'LIM e tablet']
            },
            'Cuoco': {
                questions: ['Piatto signature?', 'Cucina calda stressante?', 'Chef urlano?', 'Creativit possibile?', 'Ingredienti freschi?', 'Michelin stelle?', 'Orari del ristorante?', 'Brigade de cuisine?', 'Aprire ristorante?', 'Passione cibo?'],
                responses: ['Risotto allo zafferano', 'Pressione alta sempre', 'Disciplina ferrea', 'Menu stagionale', 'Solo prodotti locali', 'Un giorno forse', 'Sera e weekend', 'Team affiatato', 'Grande sogno', 'Nata in famiglia']
            },
            'Avvocato': {
                questions: ['Casi vinti?', 'Tribunale spesso?', 'Specializzazione legale?', 'Studio proprio?', 'Clienti difficili?', 'Orari assurdi?', 'Parcelle alte?', 'Giustizia funziona?', 'Pro bono?', 'Etica professionale?'],
                responses: ['Percentuale alta', 'Aula ogni settimana', 'Diritto civile', 'Associato in studio', 'Gestione diplomatica', 'Notti sui fascicoli', 'Dipende dalla causa', 'Sistema lento', 'Quando possibile', 'Sempre al primo posto']
            },
            'Artista': {
                questions: ['Opere recenti?', 'Gallerie interessate?', 'Vivere d\'arte?', 'Ispirazione dove?', 'Tecnica preferita?', 'Mercato dell\'arte?', 'Commissioni?', 'Mostre personali?', 'Critica d\'arte?', 'Processo creativo?'],
                responses: ['Serie nuova', 'Contatti in corso', 'Difficile ma possibile', 'Vita quotidiana', 'Olio su tela', 'Volatile e difficile', 'Principalmente ritratti', 'Una l\'anno scorso', 'Soggettiva sempre', 'Intuizione e lavoro']
            }
        },
        relationshipDialogue: {
            stranger: { 
                questions: ['Di dove sei?', 'Lavori qui vicino?', 'Prima volta che ci vediamo', 'Abiti in zona?', 'Che ci fai qui?', 'Posso sedermi?', 'Giornata bella vero?', 'Aspetti qualcuno?', 'Vieni spesso qui?', 'Nome?', 'Piacere mio', 'Ti disturbo?', 'Che coincidenza!', 'Bella citt', 'Consigli sul posto?'], 
                responses: ['Sono della zona', 'S, lavoro qui', 'Piacere di conoscerti', 'Vivo poco distante', 'Passeggiavo', 'Certo, prego', 'Bellissima', 'No, da solo/a', 'Di tanto in tanto', 'Mi chiamo...', 'Piacere', 'No, tranquillo', 'Davvero!', 'Adoro Eldoria', 'Conosco posti interessanti'] 
            },
            acquaintance: { 
                questions: ['Come va la famiglia?', 'Progetti per il weekend?', 'Tutto bene ultimamente?', 'Lavoro come va?', 'Visto l\'ultima serie?', 'Vacanze programmate?', 'Sport praticati?', 'Letture interessanti?', 'Ristoranti nuovi?', 'Eventi in citt?', 'Gita fuori porta?', 'Hobby coltivati?', 'Nuovi progetti?', 'Salute ok?', 'Tutto tranquillo?'], 
                responses: ['Tutto bene, grazie', 'Niente di speciale', 'La solita routine', 'Famiglia in salute', 'Relax totale', 'Qualche problemino', 'Avanti tutta', 'Ancora non iniziata', 'Niente per ora', 'Un po\' di palestra', 'Sto leggendo...', 'Da provare', 'Forse uno', 'Weekend al mare', 'Sempre attivo'] 
            },
            friend: { 
                questions: ['Posso confidarmi con te?', 'Usciamo insieme?', 'Hai bisogno di aiuto?', 'Ricordi quando...?', 'Posso fidarmi?', 'Cosa ne pensi di...?', 'Mi daresti un consiglio?', 'Ci vediamo stasera?', 'Pizza insieme?', 'Film al cinema?', 'Giro in centro?', 'Chiamami se serve', 'Problemi recenti?', 'Posso contare su di te?', 'Amicizia vera?', 'Ti va una birra?', 'Partita insieme?', 'Confidenza totale?', 'Sei libero domani?', 'Chiacchierata seria?'], 
                responses: ['Certo, dimmi tutto', 'Sarebbe bello!', 'Sempre disponibile per te', 'Come no!', 'Assolutamente', 'Penso che...', 'Ecco cosa farei', 'Ci sono!', 'Volentieri', 'Ok, quando?', 'D\'accordo', 'Grazie, lo stesso', 'Qualcosa c\'', 'Sempre', 'Certo che s', 'Ottima idea', 'Organizziamo', 'Puoi parlare', 'Dimmi l\'ora', 'Quando vuoi'] 
            },
            close_friend: { 
                questions: ['Cosa faresti al posto mio?', 'Ti fidi di me?', 'Siamo veri amici', 'Segreti tra noi?', 'Sempre presente?', 'Amicizia per sempre?', 'Fratello/sorella d\'anima?', 'Conosci i miei difetti?', 'Mi accetti cos?', 'Aiuto nei momenti bui?', 'Condividere tutto?', 'Viaggio insieme?', 'Supporto incondizionato?', 'Onest brutale?', 'Legame speciale?', 'Inseparabili?', 'Coppia di amici?', 'Testimone al matrimonio?', 'Connessione profonda?', 'Amicizia rara?'], 
                responses: ['Io farei cos...', 'Completamente', 'Sei importante per me', 'Condivisi e custoditi', 'Nei momenti importanti', 'Per sempre', 'Assolutamente', 'E li apprezzo', 'Proprio come sei', 'Sempre al tuo fianco', 'Ogni cosa', 'Sarebbe bellissimo', 'Senza condizioni', 'Sempre sincero', 'Unico e prezioso', 'Come una cosa sola', 'La migliore', 'Onorato', 'Profondissima', 'Trovare amici cos  raro'] 
            },
            romantic_interest: {
                questions: ['Ti piaccio?', 'Usciamo a cena?', 'Sei single?', 'Posso baciarti?', 'Cosa provi?', 'Relazione seria?', 'Mi pensi?', 'Sono speciale?', 'Futuro insieme?', 'Ti amo', 'Sentimenti ricambiati?', 'Esclusivit?', 'Presentami ai tuoi?', 'Convivenza?', 'Per sempre?'],
                responses: ['Mi piaci molto', 'Con piacere', 'S, perch?', 'Magari...', 'Qualcosa di forte', 'Ci sto pensando', 'Spesso', 'Molto speciale', 'Chi lo sa...', 'Anche tu', 'S, tantissimo', 'Solo tu', 'Presto', 'Step importante', 'Vediamo dove ci porta']
            },
            enemy: {
                questions: ['Problema con me?', 'Cosa ho fatto?', 'Possiamo chiarire?', 'Perch l\'astio?', 'Guerra aperta?', 'Tregua possibile?', 'Scuse?', 'Dimenticare?', 'Dare una chance?', 'Mai amici?'],
                responses: ['Molti problemi', 'Sai benissimo cosa', 'Non credo', 'Ragioni valide', 'Se necessario', 'Difficile', 'Non bastano', 'Impossibile', 'Gi provato', 'Mai']
            }
        },
        generateContextualQuestions: function(npc, playerStats, playerSkills) {
            const questions = [];
            
            // Add base questions
            questions.push(...this.topics.greeting.questions);
            questions.push(...this.topics.work.questions);
            questions.push(...this.topics.personal.questions);
            
            // Add skill-based questions
            Object.keys(playerSkills).forEach(skill => {
                const skillLevel = playerSkills[skill];
                const skillDialogue = this.skillBasedDialogue[skill];
                if (skillDialogue) {
                    Object.keys(skillDialogue).forEach(threshold => {
                        if (skillLevel >= parseInt(threshold)) {
                            questions.push(...skillDialogue[threshold].questions);
                        }
                    });
                }
            });
            
            // Add job-based questions
            if (this.jobBasedDialogue[game.player.job]) {
                questions.push(...this.jobBasedDialogue[game.player.job].questions);
            }
            
            // Add relationship-based questions
            const relationLevel = npc.relation < 20 ? 'stranger' : npc.relation < 40 ? 'acquaintance' : npc.relation < 70 ? 'friend' : 'close_friend';
            if (this.relationshipDialogue[relationLevel]) {
                questions.push(...this.relationshipDialogue[relationLevel].questions);
            }

            // Add time-based questions
            const hour = game.time.hour;
            if (hour >= 6 && hour < 12) {
                questions.push('Buongiorno! Dormito bene?', 'Gi sveglio?', 'Caff fatto?', 'Programmi mattinieri?');
            } else if (hour >= 12 && hour < 18) {
                questions.push('Come va la giornata?', 'Pranzo buono?', 'Pausa caff?', 'Impegni pomeridiani?');
            } else if (hour >= 18 && hour < 23) {
                questions.push('Serata libera?', 'Cena fuori?', 'Stanchi oggi?', 'Relax meritato?');
            } else {
                questions.push('Ancora sveglio?', 'Nottambulo?', 'Domani sveglia presto?', 'Non riesci a dormire?');
            }

            // Add location-based questions if available
            if (game.currentLocation) {
                if (game.currentLocation.includes('bar') || game.currentLocation.includes('Bar')) {
                    questions.push('Ti piace questo locale?', 'Vieni spesso qui?', 'Buon ambiente vero?', 'Consigliato da qualcuno?');
                } else if (game.currentLocation.includes('palestra') || game.currentLocation.includes('Gym')) {
                    questions.push('Allenamento duro?', 'Quanto sollevi?', 'Cardio o pesi?', 'Personal trainer?');
                } else if (game.currentLocation.includes('park') || game.currentLocation.includes('Parco')) {
                    questions.push('Bella giornata per stare fuori', 'Passeggiata rilassante?', 'Natura rigenerante vero?', 'Jogging?');
                } else if (game.currentLocation.includes('biblioteca') || game.currentLocation.includes('Library')) {
                    questions.push('Studiando?', 'Che libro?', 'Ricerca o svago?', 'Posto tranquillo vero?');
                }
            }

            // Add mood-based questions
            if (game.player.morale < 30) {
                questions.push('Tutto ok?', 'Sembri gi', 'Vuoi parlarne?', 'Posso aiutare?');
            } else if (game.player.morale > 70) {
                questions.push('Di buon umore!', 'Giornata positiva?', 'Bella energia!', 'Successo qualcosa di bello?');
            }

            // Add money-based questions
            if (game.player.cash + game.player.bankDeposit > 10000) {
                questions.push('Affari che vanno bene?', 'Investimenti giusti?', 'Obiettivi finanziari?', 'Risparmi o spendi?');
            } else if (game.player.cash + game.player.bankDeposit < 100) {
                questions.push('Periodo difficile?', 'Serve una mano?', 'Soldi stretti?', 'Cerca lavoro?');
            }
            
            // Remove duplicates and shuffle
            const uniqueQuestions = [...new Set(questions)];
            return uniqueQuestions.sort(() => Math.random() - 0.5).slice(0, 8);
        }
    };

    // ---------- UTILITY ----------
    const $ = id => document.getElementById(id);
    const clamp = (val, min = 0, max = 100) => Math.round(Math.max(min, Math.min(max, val)) * 100) / 100;
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const formatMoney = (val) => `${val.toFixed(0)}`;

    // ---------- MONEY HELPERS ----------
    // Pay from cash first, then bank if needed
    function payMoney(amount) {
        const totalMoney = game.player.cash + game.player.bankDeposit;
        if (totalMoney < amount) return false;
        
        if (game.player.cash >= amount) {
            game.player.cash -= amount;
        } else {
            const remaining = amount - game.player.cash;
            game.player.cash = 0;
            game.player.bankDeposit -= remaining;
        }
        return true;
    }

    // Earn money (goes to cash by default)
    function earnMoney(amount, toBank = false) {
        if (toBank) {
            game.player.bankDeposit += amount;
        } else {
            game.player.cash += amount;
        }
    }

    // Check if can afford
    function canAfford(amount) {
        return (game.player.cash + game.player.bankDeposit) >= amount;
    }

    // ---------- GAME STATE ----------
    window.game = {
        player: null,
        time: { day: 1, hour: 8 },
        npcs: [],
        quests: [],
        jobListings: [],
        events: [],
        currentTab: 'home',
        settings: { autoSave: true },
        currentChatNpc: null,
        chatHistory: {},
        housing: null,
        inventory: { food: [] },
        lastRentPayment: 1,
        lastTaxPayment: 1,
        workData: {
            currentJob: null,
            todayWorked: false,
            tasksCompleted: 0,
            performance: 100,
            manager: null,
            workEvents: [],
            careerPath: null, // Tracks current career (e.g., 'tech', 'hospitality', 'business')
            careerLevel: 0, // Level within the career path (0-5)
            daysWorked: 0,
            managerRelation: 50, // 0-100, affects promotions and job security
            warnings: 0, // Accumulate warnings for poor performance
            promotionProgress: 0, // Progress towards next promotion (0-100)
            lastPerformanceReview: 0, // Day of last review
            workLocation: null, // { neighborhood, coordinates, address }
            workPlaceName: null // Nome specifico del luogo di lavoro
        },
        relationships: {
            romantic: null,
            spouse: null,
            children: [],
            dating: []
        },
        investments: {
            stocks: [],
            savings: 0,
            properties: []
        },
        crime: {
            record: [],
            wanted: 0,
            reputation: 'pulito'
        },
        cityMap: {
            currentLocation: null,
            ownedBusinesses: [],
            discoveredLocations: [],
            transportPass: null
        },
        vehicles: {
            owned: [], // Array of owned vehicles
            active: null // Currently selected vehicle for travel
        }
    };

    // Remove local alias - always use window.game directly

    // ---------- DAYS OF THE WEEK ----------
    const DAYS_OF_WEEK = ['Luned', 'Marted', 'Mercoled', 'Gioved', 'Venerd', 'Sabato', 'Domenica'];
    
    // ---------- VEHICLES ----------
    const VEHICLES = {
        monopattino: {
            name: ' Monopattino Elettrico',
            cost: 200,
            speedMultiplier: 0.7, // 30% faster than walking
            energyCost: 2, // per hour of travel
            maintenanceCost: 5, // per month
            description: 'Economico e pratico per brevi distanze',
            emoji: ''
        },
        bici: {
            name: ' Bicicletta',
            cost: 150,
            speedMultiplier: 0.6, // 40% faster than walking
            energyCost: 5, // per hour of travel (physical effort)
            maintenanceCost: 10, // per month
            description: 'Salutare ma faticosa',
            emoji: ''
        },
        moto: {
            name: ' Motocicletta',
            cost: 2500,
            speedMultiplier: 0.4, // 60% faster than walking
            energyCost: 1, // per hour of travel
            fuelCost: 3, // per hour of travel
            maintenanceCost: 50, // per month
            description: 'Veloce e agile nel traffico',
            emoji: ''
        },
        auto: {
            name: ' Automobile',
            cost: 5000,
            speedMultiplier: 0.3, // 70% faster than walking
            energyCost: 0.5, // per hour of travel (very comfortable)
            fuelCost: 5, // per hour of travel
            maintenanceCost: 100, // per month
            description: 'Comoda ma costosa',
            emoji: ''
        },
        auto_lusso: {
            name: ' Auto di Lusso',
            cost: 15000,
            speedMultiplier: 0.2, // 80% faster than walking
            energyCost: 0, // per hour of travel (extremely comfortable)
            fuelCost: 8, // per hour of travel
            maintenanceCost: 200, // per month
            description: 'Veloce, comoda e prestigiosa',
            emoji: ''
        }
    };

    // ---------- NEIGHBORHOODS & HOUSING ----------
    const NEIGHBORHOODS = {
        periferia: {
            name: 'Periferia',
            rent: 300,
            quality: 50,
            services: 40,
            safety: 60,
            foodMultiplier: 0.8,
            description: 'Zona economica ma distante dal centro',
            population: 15000,
            demographics: { young: 35, adults: 45, elderly: 20 },
            interests: ['sport', 'famiglia', 'risparmio'],
            avgIncome: 25000,
            businessOpportunities: ['minimarket', 'pizzeria', 'lavanderia', 'bar', 'panificio', 'fruttivendolo', 'edicola', 'tabaccheria', 'parrucchiere', 'autolavaggio', 'fast_food', 'pet_shop'],
            streets: ['Via Roma', 'Via Mazzini', 'Via Garibaldi', 'Corso Italia'],
            busStops: ['Fermata Periferia Nord', 'Fermata Periferia Centro', 'Fermata Periferia Sud'],
            landmarks: ['Centro Sportivo Comunale', 'Scuola Elementare', 'Parco Giochi'],
            travelTime: 2 // hours to reach this neighborhood from a central point
        },
        quartiere_operaio: {
            name: 'Quartiere Operaio',
            rent: 450,
            quality: 60,
            services: 60,
            safety: 70,
            foodMultiplier: 0.9,
            description: 'Zona vivibile con buoni servizi',
            population: 22000,
            demographics: { young: 30, adults: 50, elderly: 20 },
            interests: ['lavoro', 'sociale', 'sport'],
            avgIncome: 32000,
            businessOpportunities: ['bar', 'ferramenta', 'palestra', 'edicola', 'trattoria', 'macelleria', 'elettronica', 'cartoleria', 'barbiere', 'farmacia', 'autofficina', 'gommista', 'pub', 'negozio_sport'],
            streets: ['Via Operai', 'Via Industria', 'Viale Lavoro', 'Via Sindacato', 'Piazza del Popolo'],
            busStops: ['Fermata Fabbrica', 'Fermata Mercato', 'Fermata Municipio'],
            landmarks: ['Centro Operaio', 'Mercato Rionale', 'Chiesa di San Giuseppe', 'Biblioteca Comunale'],
            travelTime: 1.5 // hours
        },
        centro_storico: {
            name: 'Centro Storico',
            rent: 700,
            quality: 80,
            services: 85,
            safety: 80,
            foodMultiplier: 1.1,
            description: 'Cuore della citt, vivace e costoso',
            population: 18000,
            demographics: { young: 25, adults: 55, elderly: 20 },
            interests: ['cultura', 'shopping', 'intrattenimento', 'gourmet'],
            avgIncome: 55000,
            businessOpportunities: ['boutique', 'ristorante_fine', 'galleria_arte', 'wine_bar', 'concept_store', 'gioielleria', 'libreria', 'profumeria', 'ottica', 'enoteca', 'gelateria', 'sushi_bar', 'fumetteria', 'orologeria', 'borse', 'accessori', 'teatro', 'cinema', 'museo_privato'],
            streets: ['Via del Corso', 'Piazza Duomo', 'Via della Repubblica', 'Corso Vittorio Emanuele', 'Via dei Mercanti', 'Piazza della Libert'],
            busStops: ['Fermata Duomo', 'Fermata Teatro', 'Fermata Stazione Centrale'],
            landmarks: ['Duomo', 'Teatro Comunale', 'Palazzo Storico', 'Piazza Principale', 'Torre Civica', 'Museo Civico'],
            travelTime: 0.5 // hours
        },
        zona_residenziale: {
            name: 'Zona Residenziale',
            rent: 600,
            quality: 75,
            services: 80,
            safety: 90,
            foodMultiplier: 1.0,
            description: 'Tranquilla e sicura, perfetta per famiglie',
            population: 12000,
            demographics: { young: 40, adults: 45, elderly: 15 },
            interests: ['famiglia', 'educazione', 'benessere', 'natura'],
            avgIncome: 48000,
            businessOpportunities: ['asilo', 'centro_yoga', 'pet_shop', 'pasticceria', 'libreria', 'farmacia', 'centro_estetico', 'scuola_lingue', 'scuola_musica', 'parrucchiere', 'fioraio', 'veterinario', 'supermercato', 'panificio', 'abbigliamento', 'negozio_scarpe', 'arredamento', 'vivaio'],
            streets: ['Viale dei Giardini', 'Via delle Rose', 'Via dei Tigli', 'Corso dei Platani', 'Via Quiete'],
            busStops: ['Fermata Scuole', 'Fermata Parco', 'Fermata Residenziale Nord'],
            landmarks: ['Parco delle Famiglie', 'Scuola Internazionale', 'Centro Medico', 'Piscina Comunale', 'Campo da Tennis'],
            travelTime: 1 // hours
        },
        quartiere_lusso: {
            name: 'Quartiere Luxury',
            rent: 1200,
            quality: 95,
            services: 95,
            safety: 95,
            foodMultiplier: 1.3,
            description: 'Il meglio della citt, solo per facoltosi',
            population: 5000,
            demographics: { young: 15, adults: 70, elderly: 15 },
            interests: ['lusso', 'business', 'arte', 'fitness_premium', 'gourmet'],
            avgIncome: 120000,
            businessOpportunities: ['gioielleria', 'spa_luxury', 'ristorante_stellato', 'boutique_designer', 'club_privato', 'orologeria', 'concessionaria', 'galleria', 'palestra_premium', 'wine_bar', 'pellicce', 'antiquariato', 'banca', 'studio_legale', 'centro_estetico', 'nightclub', 'cinema', 'agenzia_immobiliare'],
            streets: ['Boulevard dei Vip', 'Via Eleganza', 'Piazza Prestigio', 'Viale delle Ville'],
            busStops: ['Fermata Luxury Shopping', 'Fermata Country Club'],
            landmarks: ['Club Esclusivo', 'Golf Club', 'Spa di Lusso', 'Galleria d\'Arte Contemporanea', 'Centro Congressi'],
            travelTime: 0.75 // hours
        }
    };

    // ---------- CITY LOCATIONS DATABASE ----------
    const CITY_LOCATIONS = {
        periferia: [
            { id: 'loc_p1', type: 'shop', name: 'Minimarket Express', business: 'supermercato', street: 'Via Roma 15', status: 'occupied', income: 200, x: 20, y: 30 },
            { id: 'loc_p2', type: 'shop', name: 'Pizzeria Da Mario', business: 'pizzeria', street: 'Via Mazzini 8', status: 'occupied', income: 250, x: 40, y: 60 },
            { id: 'loc_p3', type: 'empty', name: 'Locale Commerciale', business: null, street: 'Via Garibaldi 42', status: 'available', cost: 30000, size: 'piccolo', x: 60, y: 20 },
            { id: 'loc_p4', type: 'empty', name: 'Spazio Commerciale', business: null, street: 'Corso Italia 103', status: 'available', cost: 45000, size: 'medio', x: 80, y: 70 },
            { id: 'loc_p5', type: 'landmark', name: 'Centro Sportivo Comunale', business: 'sport', street: 'Via Roma 150', status: 'public', x: 15, y: 80 },
            { id: 'loc_p10', type: 'shop', name: 'Banca di Credito', business: 'banca', street: 'Corso Italia 45', status: 'occupied', income: 0, x: 65, y: 35 },
            { id: 'loc_p6', type: 'residence', name: 'Condominio Vista Parco', street: 'Via Mazzini 25', residents: 45, rent: 300, buyPrice: 45000, x: 50, y: 40, 
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Giuseppe Marini', age: 58, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_p7', type: 'residence', name: 'Palazzina Economica', street: 'Via Garibaldi 12', residents: 30, rent: 250, buyPrice: 35000, x: 25, y: 55,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Maria Rossi', age: 45, personality: 'strict', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_p8', type: 'residence', name: 'Case Popolari', street: 'Corso Italia 50', residents: 80, rent: 200, buyPrice: 28000, x: 70, y: 45,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Antonio Bianchi', age: 52, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_p9', type: 'residence', name: 'Monolocali Via Roma', street: 'Via Roma 88', residents: 20, rent: 220, buyPrice: 30000, x: 35, y: 25,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Elena Conti', age: 38, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } }
        ],
        quartiere_operaio: [
            { id: 'loc_o1', type: 'shop', name: 'Bar Centrale', business: 'bar', street: 'Piazza del Popolo 1', status: 'occupied', income: 300, x: 30, y: 20 },
            { id: 'loc_o2', type: 'shop', name: 'Ferramenta Bianchi', business: 'ferramenta', street: 'Via Industria 12', status: 'occupied', income: 180, x: 50, y: 50 },
            { id: 'loc_o3', type: 'shop', name: 'Palestra FitLife', business: 'palestra', street: 'Via Operai 55', status: 'occupied', income: 400, x: 70, y: 30 },
            { id: 'loc_o4', type: 'empty', name: 'Capannone', business: null, street: 'Via Industria 88', status: 'available', cost: 80000, size: 'grande', x: 20, y: 70 },
            { id: 'loc_o5', type: 'empty', name: 'Negozio d\'Angolo', business: null, street: 'Via Sindacato 7', status: 'available', cost: 35000, size: 'piccolo', x: 80, y: 60 },
            { id: 'loc_o6', type: 'landmark', name: 'Mercato Rionale', business: 'mercato', street: 'Piazza del Popolo', status: 'public', x: 40, y: 80 },
            { id: 'loc_o11', type: 'shop', name: 'Banca del Popolo', business: 'banca', street: 'Via Sindacato 20', status: 'occupied', income: 0, x: 55, y: 55 },
            { id: 'loc_o7', type: 'residence', name: 'Palazzi Popolari', street: 'Via Operai 20-30', residents: 120, rent: 400, buyPrice: 55000, x: 60, y: 40,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Franco Lombardi', age: 60, personality: 'strict', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_o8', type: 'residence', name: 'Condominio del Sindacato', street: 'Via Sindacato 15', residents: 65, rent: 380, buyPrice: 52000, x: 25, y: 50,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Roberto Esposito', age: 55, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_o9', type: 'residence', name: 'Residenza Operaia', street: 'Via Industria 40', residents: 50, rent: 350, buyPrice: 48000, x: 75, y: 65,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Lucia Ferretti', age: 48, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_o10', type: 'residence', name: 'Appartamenti Piazza Popolo', street: 'Piazza del Popolo 8', residents: 35, rent: 420, buyPrice: 58000, x: 45, y: 35,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Stefano Romano', age: 42, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ],
        centro_storico: [
            { id: 'loc_c1', type: 'shop', name: 'Boutique Eleganza', business: 'boutique', street: 'Via del Corso 45', status: 'occupied', income: 800, x: 25, y: 25 },
            { id: 'loc_c2', type: 'shop', name: 'Ristorante La Tavola', business: 'ristorante', street: 'Piazza Duomo 12', status: 'occupied', income: 900, x: 50, y: 40 },
            { id: 'loc_c3', type: 'shop', name: 'Galleria Arte Moderna', business: 'galleria', street: 'Via dei Mercanti 8', status: 'occupied', income: 500, x: 70, y: 60 },
            { id: 'loc_c4', type: 'empty', name: 'Palazzo Storico - Piano Terra', business: null, street: 'Corso Vittorio Emanuele 100', status: 'available', cost: 250000, size: 'grande', x: 15, y: 70 },
            { id: 'loc_c5', type: 'empty', name: 'Locale Centrale', business: null, street: 'Piazza della Libert 5', status: 'available', cost: 180000, size: 'medio', x: 85, y: 30 },
            { id: 'loc_c6', type: 'landmark', name: 'Duomo', business: 'chiesa', street: 'Piazza Duomo', status: 'historic', x: 40, y: 80 },
            { id: 'loc_c7', type: 'landmark', name: 'Teatro Comunale', business: 'teatro', street: 'Via della Repubblica 1', status: 'public', x: 60, y: 10 },
            { id: 'loc_c12', type: 'shop', name: 'Banca Centrale', business: 'banca', street: 'Piazza della Repubblica 8', status: 'occupied', income: 0, x: 35, y: 15 },
            { id: 'loc_c8', type: 'residence', name: 'Appartamenti Centro', street: 'Via del Corso 10-50', residents: 75, rent: 700, buyPrice: 120000, x: 30, y: 55,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Andrea Fontana', age: 50, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_c9', type: 'residence', name: 'Loft Via Repubblica', street: 'Via della Repubblica 22', residents: 40, rent: 750, buyPrice: 135000, x: 65, y: 45,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Silvia Moretti', age: 44, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_c10', type: 'residence', name: 'Attico Piazza Libert', street: 'Piazza della Libert 1', residents: 20, rent: 900, buyPrice: 180000, x: 80, y: 55,
              housingLevel: 'attico', bonuses: { energy: 15, morale: 12, hygiene: 10, health: 5, stressReduction: 2 },
              landlord: { name: 'Marco De Luca', age: 52, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_c11', type: 'residence', name: 'Palazzo dei Mercanti', street: 'Via dei Mercanti 15', residents: 55, rent: 680, buyPrice: 115000, x: 45, y: 65,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Chiara Colombo', age: 47, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } }
        ],
        zona_residenziale: [
            { id: 'loc_r1', type: 'shop', name: 'Pasticceria Dolce Vita', business: 'pasticceria', street: 'Viale dei Giardini 22', status: 'occupied', income: 350, x: 20, y: 40 },
            { id: 'loc_r2', type: 'shop', name: 'Libreria Mondadori', business: 'libreria', street: 'Via delle Rose 15', status: 'occupied', income: 280, x: 50, y: 20 },
            { id: 'loc_r3', type: 'shop', name: 'Pet Paradise', business: 'pet_shop', street: 'Via dei Tigli 8', status: 'occupied', income: 220, x: 80, y: 50 },
            { id: 'loc_r4', type: 'empty', name: 'Locale Residenziale', business: null, street: 'Corso dei Platani 44', status: 'available', cost: 90000, size: 'medio', x: 30, y: 70 },
            { id: 'loc_r5', type: 'empty', name: 'Spazio Wellness', business: null, street: 'Via Quiete 12', status: 'available', cost: 120000, size: 'grande', x: 70, y: 80 },
            { id: 'loc_r6', type: 'landmark', name: 'Parco delle Famiglie', business: 'parco', street: 'Via Quiete', status: 'public', x: 10, y: 10 },
            { id: 'loc_r11', type: 'shop', name: 'Banca delle Famiglie', business: 'banca', street: 'Corso dei Platani 10', status: 'occupied', income: 0, x: 45, y: 50 },
            { id: 'loc_r7', type: 'residence', name: 'Villette a Schiera', street: 'Viale dei Giardini', residents: 60, rent: 850, buyPrice: 160000, x: 60, y: 60,
              housingLevel: 'villa', bonuses: { energy: 15, morale: 12, hygiene: 10, health: 5, stressReduction: 2 },
              landlord: { name: 'Paolo Santoro', age: 56, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r8', type: 'residence', name: 'Condominio delle Rose', street: 'Via delle Rose 30', residents: 45, rent: 800, buyPrice: 145000, x: 35, y: 35,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Laura Ricci', age: 49, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r9', type: 'residence', name: 'Residence Platani', street: 'Corso dei Platani 20', residents: 50, rent: 820, buyPrice: 150000, x: 55, y: 75,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Davide Greco', age: 51, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r10', type: 'residence', name: 'Appartamenti Via Quiete', street: 'Via Quiete 45', residents: 40, rent: 780, buyPrice: 140000, x: 75, y: 25,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Valentina Gallo', age: 43, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ],
        quartiere_lusso: [
            { id: 'loc_l1', type: 'shop', name: 'Gioielleria Cartier', business: 'gioielleria', street: 'Boulevard dei Vip 5', status: 'occupied', income: 2000, x: 20, y: 20 },
            { id: 'loc_l2', type: 'shop', name: 'Ristorante Stella Michelin', business: 'ristorante_stellato', street: 'Via Eleganza 1', status: 'occupied', income: 1800, x: 50, y: 40 },
            { id: 'loc_l3', type: 'shop', name: 'Spa Serenit', business: 'spa', street: 'Piazza Prestigio 3', status: 'occupied', income: 1500, x: 80, y: 60 },
            { id: 'loc_l4', type: 'empty', name: 'Boutique Luxury', business: null, street: 'Boulevard dei Vip 18', status: 'available', cost: 500000, size: 'grande', x: 30, y: 70 },
            { id: 'loc_l5', type: 'landmark', name: 'Golf Club Exclusive', business: 'golf', street: 'Viale delle Ville', status: 'private', x: 70, y: 10 },
            { id: 'loc_l6', type: 'residence', name: 'Ville di Lusso', street: 'Viale delle Ville', residents: 25, rent: 2000, buyPrice: 500000, x: 40, y: 80,
              housingLevel: 'villa_lusso', bonuses: { energy: 20, morale: 15, hygiene: 12, health: 8, stressReduction: 5 },
              landlord: { name: 'Alessandro Vitale', age: 58, personality: 'arrogant', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_l7', type: 'residence', name: 'Attico Panoramico', street: 'Boulevard dei Vip 10', residents: 15, rent: 1800, buyPrice: 450000, x: 30, y: 45,
              housingLevel: 'attico_lusso', bonuses: { energy: 18, morale: 14, hygiene: 11, health: 7, stressReduction: 4 },
              landlord: { name: 'Isabella Monti', age: 53, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_l8', type: 'residence', name: 'Penthouse Prestigio', street: 'Piazza Prestigio 1', residents: 12, rent: 2200, buyPrice: 550000, x: 65, y: 75,
              housingLevel: 'penthouse', bonuses: { energy: 22, morale: 18, hygiene: 14, health: 10, stressReduction: 6 },
              landlord: { name: 'Giovanni Ferrari', age: 62, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_l9', type: 'residence', name: 'Residenza Eleganza', street: 'Via Eleganza 25', residents: 20, rent: 1700, buyPrice: 420000, x: 55, y: 30,
              housingLevel: 'attico_lusso', bonuses: { energy: 18, morale: 14, hygiene: 11, health: 7, stressReduction: 4 },
              landlord: { name: 'Federica Leone', age: 46, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ]
    };

    // ---------- TRANSPORT SYSTEM ----------
    const BUS_ROUTES = {
        linea_1: {
            name: 'Linea 1 - Centro-Periferia',
            stops: ['Duomo', 'Teatro', 'Mercato', 'Periferia Centro', 'Periferia Sud'],
            cost: 1.5,
            time: 30
        },
        linea_2: {
            name: 'Linea 2 - Circolare',
            stops: ['Stazione Centrale', 'Quartiere Operaio', 'Zona Residenziale', 'Luxury Shopping', 'Centro'],
            cost: 1.5,
            time: 45
        },
        linea_3: {
            name: 'Linea 3 - Espressa',
            stops: ['Periferia Nord', 'Fabbrica', 'Municipio', 'Duomo', 'Stazione Centrale'],
            cost: 2,
            time: 20
        }
    };

    // ---------- BUSINESS TYPES ----------
    const BUSINESS_TYPES = {
        // Alimentari & Ristorazione
        minimarket: { name: 'Minimarket', cost: 35000, income: [150, 300], employees: 2, category: 'alimentari' },
        supermercato: { name: 'Supermercato', cost: 120000, income: [800, 1500], employees: 8, category: 'alimentari' },
        macelleria: { name: 'Macelleria', cost: 45000, income: [200, 400], employees: 2, category: 'alimentari' },
        panificio: { name: 'Panificio', cost: 55000, income: [250, 500], employees: 3, category: 'alimentari' },
        fruttivendolo: { name: 'Fruttivendolo', cost: 30000, income: [150, 350], employees: 2, category: 'alimentari' },
        enoteca: { name: 'Enoteca', cost: 60000, income: [300, 600], employees: 2, category: 'alimentari' },
        
        pizzeria: { name: 'Pizzeria', cost: 50000, income: [200, 400], employees: 3, category: 'ristorazione' },
        ristorante: { name: 'Ristorante', cost: 100000, income: [600, 1200], employees: 5, category: 'ristorazione' },
        ristorante_stellato: { name: 'Ristorante Stellato', cost: 300000, income: [2000, 4000], employees: 10, category: 'ristorazione' },
        trattoria: { name: 'Trattoria', cost: 70000, income: [350, 700], employees: 4, category: 'ristorazione' },
        sushi_bar: { name: 'Sushi Bar', cost: 90000, income: [500, 1000], employees: 4, category: 'ristorazione' },
        bar: { name: 'Bar/Caff', cost: 45000, income: [250, 450], employees: 2, category: 'ristorazione' },
        gelateria: { name: 'Gelateria', cost: 40000, income: [200, 450], employees: 2, category: 'ristorazione' },
        pasticceria: { name: 'Pasticceria', cost: 70000, income: [300, 600], employees: 3, category: 'ristorazione' },
        fast_food: { name: 'Fast Food', cost: 80000, income: [400, 800], employees: 5, category: 'ristorazione' },
        pub: { name: 'Pub/Birreria', cost: 65000, income: [350, 700], employees: 3, category: 'ristorazione' },
        wine_bar: { name: 'Wine Bar', cost: 75000, income: [400, 800], employees: 3, category: 'ristorazione' },
        
        // Commercio & Servizi
        ferramenta: { name: 'Ferramenta', cost: 40000, income: [150, 280], employees: 1, category: 'commercio' },
        elettronica: { name: 'Negozio Elettronica', cost: 90000, income: [500, 1000], employees: 3, category: 'commercio' },
        cartoleria: { name: 'Cartoleria', cost: 30000, income: [120, 250], employees: 1, category: 'commercio' },
        farmacia: { name: 'Farmacia', cost: 150000, income: [800, 1500], employees: 3, category: 'commercio' },
        ottica: { name: 'Ottica', cost: 70000, income: [350, 700], employees: 2, category: 'commercio' },
        tabaccheria: { name: 'Tabaccheria', cost: 40000, income: [200, 400], employees: 1, category: 'commercio' },
        edicola: { name: 'Edicola', cost: 25000, income: [100, 200], employees: 1, category: 'commercio' },
        fioraio: { name: 'Fioraio', cost: 35000, income: [150, 350], employees: 2, category: 'commercio' },
        telefonia: { name: 'Negozio Telefonia', cost: 60000, income: [300, 600], employees: 2, category: 'commercio' },
        profumeria: { name: 'Profumeria', cost: 55000, income: [280, 550], employees: 2, category: 'commercio' },
        
        // Moda & Accessori
        boutique: { name: 'Boutique Moda', cost: 120000, income: [500, 1000], employees: 3, category: 'moda' },
        boutique_designer: { name: 'Boutique Designer', cost: 250000, income: [1500, 3000], employees: 4, category: 'moda' },
        negozio_scarpe: { name: 'Negozio Scarpe', cost: 70000, income: [350, 700], employees: 2, category: 'moda' },
        abbigliamento: { name: 'Abbigliamento', cost: 80000, income: [400, 800], employees: 3, category: 'moda' },
        intimo: { name: 'Negozio Intimo', cost: 50000, income: [250, 500], employees: 2, category: 'moda' },
        accessori: { name: 'Accessori Moda', cost: 45000, income: [220, 450], employees: 2, category: 'moda' },
        borse: { name: 'Pelletteria', cost: 85000, income: [420, 850], employees: 2, category: 'moda' },
        occhiali: { name: 'Occhiali da Sole', cost: 55000, income: [280, 560], employees: 2, category: 'moda' },
        
        // Sport & Fitness
        palestra: { name: 'Palestra', cost: 80000, income: [300, 600], employees: 4, category: 'sport' },
        palestra_premium: { name: 'Palestra Premium', cost: 200000, income: [1000, 2000], employees: 8, category: 'sport' },
        negozio_sport: { name: 'Negozio Sportivo', cost: 70000, income: [350, 700], employees: 3, category: 'sport' },
        piscina: { name: 'Centro Acquatico', cost: 250000, income: [1200, 2400], employees: 10, category: 'sport' },
        yoga_studio: { name: 'Studio Yoga', cost: 60000, income: [300, 600], employees: 3, category: 'sport' },
        danza_studio: { name: 'Scuola Danza', cost: 70000, income: [350, 700], employees: 4, category: 'sport' },
        
        // Cultura & Intrattenimento
        libreria: { name: 'Libreria', cost: 60000, income: [200, 400], employees: 2, category: 'cultura' },
        fumetteria: { name: 'Fumetteria', cost: 45000, income: [180, 360], employees: 2, category: 'cultura' },
        galleria: { name: 'Galleria d\'Arte', cost: 150000, income: [500, 1000], employees: 3, category: 'cultura' },
        museo_privato: { name: 'Museo Privato', cost: 300000, income: [800, 1600], employees: 5, category: 'cultura' },
        cinema: { name: 'Cinema', cost: 400000, income: [2000, 4000], employees: 12, category: 'cultura' },
        teatro: { name: 'Teatro', cost: 500000, income: [2500, 5000], employees: 15, category: 'cultura' },
        sala_giochi: { name: 'Sala Giochi', cost: 90000, income: [450, 900], employees: 3, category: 'cultura' },
        videogiochi: { name: 'Negozio Videogiochi', cost: 60000, income: [300, 600], employees: 2, category: 'cultura' },
        
        // Bellezza & Benessere
        parrucchiere: { name: 'Parrucchiere', cost: 40000, income: [200, 400], employees: 2, category: 'benessere' },
        barbiere: { name: 'Barbiere', cost: 35000, income: [180, 360], employees: 2, category: 'benessere' },
        centro_estetico: { name: 'Centro Estetico', cost: 80000, income: [400, 800], employees: 4, category: 'benessere' },
        spa: { name: 'Centro Benessere', cost: 200000, income: [800, 1600], employees: 6, category: 'benessere' },
        spa_luxury: { name: 'Spa di Lusso', cost: 400000, income: [2000, 4000], employees: 10, category: 'benessere' },
        nail_salon: { name: 'Nail Salon', cost: 35000, income: [170, 350], employees: 2, category: 'benessere' },
        tattoo: { name: 'Studio Tatuaggi', cost: 50000, income: [250, 500], employees: 2, category: 'benessere' },
        massaggi: { name: 'Centro Massaggi', cost: 70000, income: [350, 700], employees: 3, category: 'benessere' },
        
        // Servizi Professionali
        agenzia_immobiliare: { name: 'Agenzia Immobiliare', cost: 80000, income: [600, 1200], employees: 3, category: 'servizi' },
        agenzia_viaggi: { name: 'Agenzia Viaggi', cost: 70000, income: [400, 800], employees: 3, category: 'servizi' },
        studio_legale: { name: 'Studio Legale', cost: 100000, income: [800, 1600], employees: 4, category: 'servizi' },
        studio_commercialista: { name: 'Studio Commercialista', cost: 90000, income: [700, 1400], employees: 3, category: 'servizi' },
        agenzia_assicurazioni: { name: 'Agenzia Assicurazioni', cost: 85000, income: [650, 1300], employees: 3, category: 'servizi' },
        banca: { name: 'Filiale Bancaria', cost: 200000, income: [1500, 3000], employees: 8, category: 'servizi' },
        posta: { name: 'Ufficio Postale', cost: 150000, income: [800, 1600], employees: 5, category: 'servizi' },
        
        // Auto & Trasporti
        autofficina: { name: 'Officina Auto', cost: 100000, income: [500, 1000], employees: 4, category: 'auto' },
        autolavaggio: { name: 'Autolavaggio', cost: 60000, income: [300, 600], employees: 3, category: 'auto' },
        concessionaria: { name: 'Concessionaria Auto', cost: 300000, income: [2000, 4000], employees: 8, category: 'auto' },
        gommista: { name: 'Gommista', cost: 50000, income: [250, 500], employees: 2, category: 'auto' },
        
        // Casa & Arredamento
        arredamento: { name: 'Negozio Arredamento', cost: 150000, income: [700, 1400], employees: 4, category: 'casa' },
        elettrodomestici: { name: 'Elettrodomestici', cost: 100000, income: [500, 1000], employees: 3, category: 'casa' },
        sanitari: { name: 'Sanitari & Bagno', cost: 80000, income: [400, 800], employees: 2, category: 'casa' },
        illuminazione: { name: 'Illuminazione', cost: 60000, income: [300, 600], employees: 2, category: 'casa' },
        tende: { name: 'Tende & Tessuti', cost: 50000, income: [250, 500], employees: 2, category: 'casa' },
        
        // Lusso & Preziosi
        gioielleria: { name: 'Gioielleria', cost: 300000, income: [1500, 3000], employees: 2, category: 'lusso' },
        orologeria: { name: 'Orologeria', cost: 200000, income: [1000, 2000], employees: 2, category: 'lusso' },
        pellicce: { name: 'Pellicce & Lusso', cost: 250000, income: [1200, 2400], employees: 2, category: 'lusso' },
        antiquariato: { name: 'Antiquariato', cost: 120000, income: [600, 1200], employees: 2, category: 'lusso' },
        
        // Animali & Natura
        pet_shop: { name: 'Pet Shop', cost: 50000, income: [220, 450], employees: 2, category: 'animali' },
        veterinario: { name: 'Clinica Veterinaria', cost: 120000, income: [600, 1200], employees: 4, category: 'animali' },
        toelettatura: { name: 'Toelettatura', cost: 40000, income: [200, 400], employees: 2, category: 'animali' },
        vivaio: { name: 'Vivaio', cost: 70000, income: [300, 600], employees: 3, category: 'animali' },
        
        // Tecnologia
        internet_cafe: { name: 'Internet Caf', cost: 50000, income: [250, 500], employees: 2, category: 'tech' },
        riparazioni_tech: { name: 'Riparazioni Tech', cost: 45000, income: [220, 450], employees: 2, category: 'tech' },
        computer_shop: { name: 'Negozio Computer', cost: 90000, income: [450, 900], employees: 3, category: 'tech' },
        foto_video: { name: 'Foto & Video', cost: 80000, income: [400, 800], employees: 2, category: 'tech' },
        
        // Educazione
        asilo: { name: 'Asilo Privato', cost: 150000, income: [800, 1600], employees: 8, category: 'educazione' },
        scuola_lingue: { name: 'Scuola di Lingue', cost: 80000, income: [400, 800], employees: 5, category: 'educazione' },
        scuola_musica: { name: 'Scuola di Musica', cost: 70000, income: [350, 700], employees: 4, category: 'educazione' },
        ripetizioni: { name: 'Centro Ripetizioni', cost: 40000, income: [200, 400], employees: 3, category: 'educazione' },
        
        // Altro
        lavanderia: { name: 'Lavanderia', cost: 50000, income: [250, 500], employees: 2, category: 'servizi' },
        tintoria: { name: 'Tintoria', cost: 55000, income: [280, 560], employees: 2, category: 'servizi' },
        sarta: { name: 'Sartoria', cost: 40000, income: [200, 400], employees: 2, category: 'servizi' },
        fotografo: { name: 'Studio Fotografico', cost: 60000, income: [300, 600], employees: 2, category: 'servizi' },
        centro_stampa: { name: 'Centro Stampa', cost: 70000, income: [350, 700], employees: 3, category: 'servizi' },
        agenzia_eventi: { name: 'Agenzia Eventi', cost: 80000, income: [400, 800], employees: 4, category: 'servizi' },
        club_privato: { name: 'Club Privato', cost: 500000, income: [3000, 6000], employees: 12, category: 'lusso' },
        nightclub: { name: 'Discoteca', cost: 300000, income: [1800, 3600], employees: 10, category: 'intrattenimento' }
    };

    // ---------- FOOD ITEMS ----------
    const FOOD_ITEMS = {
        pane: { name: 'Pane', cost: 2, hunger: 10, expires: 3 },
        pasta: { name: 'Pasta', cost: 3, hunger: 25, expires: 7 },
        frutta: { name: 'Frutta', cost: 5, hunger: 15, expires: 2 },
        verdura: { name: 'Verdura', cost: 4, hunger: 15, expires: 3 },
        carne: { name: 'Carne', cost: 12, hunger: 35, expires: 2 },
        pesce: { name: 'Pesce', cost: 15, hunger: 35, expires: 1 },
        latte: { name: 'Latte', cost: 2, hunger: 8, expires: 4 },
        formaggio: { name: 'Formaggio', cost: 8, hunger: 20, expires: 7 },
        uova: { name: 'Uova', cost: 4, hunger: 20, expires: 10 },
        snack: { name: 'Snack', cost: 3, hunger: 12, expires: 30 },
        surgelati: { name: 'Surgelati', cost: 10, hunger: 30, expires: 30 },
        acqua: { name: 'Acqua', cost: 1, hunger: 5, expires: 365 }
    };

    // ---------- INVESTMENTS DATA ----------
    // STOCKS now dynamically generated from companies
    let STOCKS = {};

    const PROPERTIES = [
        { id: 'apt1', name: 'Monolocale Periferia', cost: 50000, income: 300, area: 'periferia' },
        { id: 'apt2', name: 'Bilocale Centro', cost: 120000, income: 800, area: 'centro_storico' },
        { id: 'shop1', name: 'Negozio Piccolo', cost: 80000, income: 600, area: 'quartiere_operaio' },
        { id: 'office1', name: 'Ufficio Commerciale', cost: 200000, income: 1500, area: 'zona_residenziale' }
    ];

    // ---------- TRAITS ----------
    const TRAITS = [
        { id: 'athletic', name: 'Atletico', desc: '+fitness' },
        { id: 'smart', name: 'Intelligente', desc: '+intelletto' },
        { id: 'charismatic', name: 'Carismatico', desc: '+carisma' },
        { id: 'creative', name: 'Creativo', desc: '+creativit' },
        { id: 'lucky', name: 'Fortunato', desc: '+eventi positivi' },
        { id: 'hardworker', name: 'Laborioso', desc: '+guadagni lavoro' }
    ];

    // ---------- ACTIONS DATABASE ----------
    const ACTIONS = {
        // Casa
        eat: { cost: 0, time: 1, effects: { hunger: 0, energy: 5 }, msg: 'Hai bisogno di cibo nell\'inventario per mangiare!', requiresFood: true, category: 'casa' },
        sleep: { cost: 0, time: 8, effects: { energy: 80, health: 10, hunger: -20 }, msg: 'Hai dormito bene!', category: 'casa' },
        nap: { cost: 0, time: 2, effects: { energy: 30, morale: 5 }, msg: 'Un bel pisolino rigenerante!', category: 'casa' },
        shower: { cost: 5, time: 1, effects: { morale: 10, health: 5 }, msg: 'Ti senti fresco e pulito!', category: 'casa' },
        cook: { cost: 0, time: 2, effects: { hunger: 0, morale: 5 }, msg: 'Hai bisogno di ingredienti per cucinare!', requiresFood: true, category: 'casa' },
        clean: { cost: 0, time: 2, effects: { morale: 15, energy: -10 }, msg: 'La casa  ora pulita!', category: 'casa' },
        relax: { cost: 0, time: 2, effects: { morale: 20, energy: 10 }, msg: 'Ti sei rilassato guardando la TV.', category: 'casa' },
        read: { cost: 5, time: 2, effects: { morale: 10, energy: -15 }, skills: { intellect: 2 }, msg: 'Hai imparato qualcosa di nuovo!', category: 'casa' },
        exercise: { cost: 0, time: 2, effects: { health: 15, energy: -25, morale: 10 }, skills: { fitness: 3 }, msg: 'Ottimo allenamento!', category: 'casa' },
        meditate: { cost: 0, time: 1, effects: { morale: 25, energy: 5 }, msg: 'Ti senti in pace con te stesso.', category: 'casa' },
        video_games: { cost: 0, time: 3, effects: { morale: 25, energy: -5 }, msg: 'Sessione di gaming epica!', category: 'casa' },
        hobby_paint: { cost: 15, time: 3, effects: { morale: 30, energy: -15 }, skills: { creativity: 5 }, msg: 'Hai creato un\'opera d\'arte!', category: 'casa' },
        study: { cost: 20, time: 4, effects: { energy: -30, morale: -10 }, skills: { intellect: 8 }, msg: 'Hai studiato intensamente!', category: 'casa' },
        
        // Parco
        park: { cost: 0, time: 2, effects: { morale: 15, energy: -5 }, msg: 'Una bella passeggiata al parco!', category: 'natura' },
        jog_park: { cost: 0, time: 2, effects: { health: 20, energy: -35, morale: 15 }, skills: { fitness: 4 }, msg: 'Corsa rigenerante nel parco!', category: 'natura' },
        picnic: { cost: 25, time: 3, effects: { hunger: 30, morale: 25, energy: 5 }, msg: 'Picnic rilassante!', category: 'natura' },
        bird_watching: { cost: 0, time: 2, effects: { morale: 20, energy: -5 }, msg: 'Hai osservato bellissimi uccelli!', category: 'natura' },
        
        // Palestra
        gym: { cost: 20, time: 2, effects: { health: 20, energy: -30 }, skills: { fitness: 5 }, msg: 'Sessione di palestra completata!', category: 'sport' },
        yoga_class: { cost: 25, time: 2, effects: { health: 15, morale: 20, energy: -10 }, msg: 'Lezione di yoga rilassante!', category: 'sport' },
        swimming: { cost: 15, time: 2, effects: { health: 25, energy: -28 }, skills: { fitness: 6 }, msg: 'Nuotata fantastica!', category: 'sport' },
        boxing: { cost: 30, time: 2, effects: { health: 20, energy: -40, morale: 10 }, skills: { fitness: 7 }, msg: 'Allenamento di boxe intenso!', category: 'sport' },
        
        // Biblioteca
        library: { cost: 10, time: 3, effects: { morale: 10, energy: -20 }, skills: { intellect: 5 }, msg: 'Hai studiato in biblioteca.', category: 'cultura' },
        research: { cost: 25, time: 4, effects: { morale: 5, energy: -35 }, skills: { intellect: 10 }, msg: 'Ricerca approfondita completata!', category: 'cultura' },
        book_club: { cost: 15, time: 3, effects: { morale: 20, energy: -15 }, skills: { intellect: 4, charisma: 3 }, msg: 'Discussione stimolante al club del libro!', category: 'cultura' },
        
        // Caff
        cafe: { cost: 8, time: 1, effects: { morale: 15, energy: 10, hunger: 10 }, msg: 'Un caff perfetto!', category: 'sociale' },
        breakfast_cafe: { cost: 20, time: 1, effects: { morale: 20, energy: 15, hunger: 35 }, msg: 'Ottima colazione al bar!', category: 'sociale' },
        cafe_work: { cost: 10, time: 3, effects: { morale: 10, energy: -15 }, skills: { intellect: 3 }, msg: 'Hai lavorato produttivamente al caff!', category: 'sociale' },
        
        // Cinema
        cinema: { cost: 15, time: 3, effects: { morale: 30, energy: -5 }, msg: 'Film fantastico!', category: 'intrattenimento' },
        cinema_vip: { cost: 35, time: 3, effects: { morale: 45, energy: 0 }, msg: 'Esperienza cinema VIP incredibile!', category: 'intrattenimento' },
        
        // Ristorante
        restaurant: { cost: 40, time: 2, effects: { hunger: 40, morale: 25 }, msg: 'Cena deliziosa!', category: 'cibo' },
        fine_dining: { cost: 100, time: 3, effects: { hunger: 50, morale: 45, energy: 10 }, msg: 'Esperienza culinaria stellata!', category: 'cibo' },
        fast_food: { cost: 12, time: 1, effects: { hunger: 30, morale: 10, health: -5 }, msg: 'Pasto veloce ma poco salutare...', category: 'cibo' },
        
        // Shopping
        shopping: { cost: 50, time: 2, effects: { morale: 20, energy: -10 }, msg: 'Hai comprato qualcosa di bello!', category: 'shopping' },
        window_shopping: { cost: 0, time: 2, effects: { morale: 10, energy: -8 }, msg: 'Hai fatto un giro per vetrine!', category: 'shopping' },
        luxury_shopping: { cost: 200, time: 3, effects: { morale: 50, energy: -15 }, msg: 'Shopping di lusso fantastico!', category: 'shopping' },
        electronics_store: { cost: 0, time: 1, effects: { morale: 5, energy: -5 }, msg: 'Hai visitato il negozio di elettronica!', category: 'shopping', special: 'showElectronicsStore' },
        
        // Museo
        museum: { cost: 10, time: 3, effects: { morale: 20, energy: -20 }, skills: { intellect: 3, creativity: 2 }, msg: 'Cultura e arte!', category: 'cultura' },
        art_gallery: { cost: 15, time: 3, effects: { morale: 25, energy: -15 }, skills: { creativity: 5 }, msg: 'Galleria d\'arte ispiratrice!', category: 'cultura' },
        guided_tour: { cost: 25, time: 4, effects: { morale: 30, energy: -30 }, skills: { intellect: 8 }, msg: 'Tour guidato educativo!', category: 'cultura' },
        
        // Vita notturna
        nightclub: { cost: 30, time: 4, effects: { morale: 35, energy: -35, hunger: -10 }, skills: { charisma: 3 }, msg: 'Serata fantastica!', category: 'notturno' },
        bar: { cost: 20, time: 2, effects: { morale: 20, energy: -15, health: -5 }, skills: { charisma: 2 }, msg: 'Serata al bar divertente!', category: 'notturno' },
        live_music: { cost: 25, time: 3, effects: { morale: 35, energy: -15 }, msg: 'Concerto live spettacolare!', category: 'notturno' },
        karaoke: { cost: 15, time: 3, effects: { morale: 40, energy: -25 }, skills: { charisma: 5 }, msg: 'Karaoke scatenato!', category: 'notturno' },
        
        // Teatro & Spettacoli
        theater: { cost: 40, time: 3, effects: { morale: 40, energy: -10 }, skills: { creativity: 3 }, msg: 'Spettacolo teatrale magnifico!', category: 'cultura' },
        opera: { cost: 60, time: 4, effects: { morale: 50, energy: -15 }, skills: { creativity: 4 }, msg: 'Opera lirica emozionante!', category: 'cultura' },
        
        // Sport & Attivit
        bowling: { cost: 20, time: 2, effects: { morale: 25, energy: -15 }, skills: { fitness: 2 }, msg: 'Partita a bowling divertente!', category: 'sport' },
        mini_golf: { cost: 15, time: 2, effects: { morale: 20, energy: -10 }, msg: 'Mini golf rilassante!', category: 'sport' },
        
        // Spa & Benessere
        spa: { cost: 80, time: 3, effects: { morale: 50, health: 20, energy: 30 }, msg: 'Giornata spa rigenerante!', category: 'benessere' },
        massage: { cost: 50, time: 2, effects: { morale: 35, health: 15, energy: 20 }, msg: 'Massaggio rilassante!', category: 'benessere' },
        sauna: { cost: 25, time: 1, effects: { morale: 20, health: 10 }, msg: 'Sauna purificante!', category: 'benessere' },
        
        // Volontariato
        volunteer: { cost: 0, time: 4, effects: { morale: 40, energy: -25 }, msg: 'Hai aiutato la comunit!', category: 'sociale' },
        animal_shelter: { cost: 0, time: 3, effects: { morale: 45, energy: -20 }, msg: 'Tempo prezioso con gli animali!', category: 'sociale' },
        
        // Corsi & Educazione
        cooking_class: { cost: 50, time: 3, effects: { morale: 25, energy: -25 }, skills: { creativity: 4 }, msg: 'Corso di cucina fantastico!', category: 'educazione' },
        language_class: { cost: 40, time: 3, effects: { morale: 15, energy: -30 }, skills: { intellect: 6 }, msg: 'Lezione di lingua produttiva!', category: 'educazione' },
        art_class: { cost: 45, time: 3, effects: { morale: 30, energy: -25 }, skills: { creativity: 7 }, msg: 'Corso d\'arte creativo!', category: 'educazione' },
        
        // Sociale
        meet_new: { cost: 0, time: 2, effects: { morale: 10, energy: -15 }, skills: { charisma: 2 }, msg: 'Hai conosciuto nuove persone!', category: 'sociale' },
        work: { cost: 0, time: 8, effects: { energy: -40, hunger: -30, morale: -10 }, msg: 'Giornata di lavoro completata!', category: 'lavoro' },
        talk: { cost: 0, time: 1, effects: { morale: 5 }, skills: { charisma: 1 }, msg: 'Bella conversazione!', category: 'sociale' },
        
        // Nuove attivit per skill training
        yoga: { cost: 20, time: 2, effects: { health: 20, morale: 25, energy: -20 }, skills: { fitness: 4 }, msg: 'Sessione yoga equilibrante!', category: 'sport' },
        music_lesson: { cost: 35, time: 2, effects: { morale: 20, energy: -25 }, skills: { creativity: 6 }, msg: 'Lezione di musica produttiva!', category: 'educazione' },
        photography: { cost: 25, time: 3, effects: { morale: 25, energy: -20 }, skills: { creativity: 5 }, msg: 'Sessione fotografica ispiratrice!', category: 'arte' },
        networking: { cost: 30, time: 3, effects: { morale: 15, energy: -30 }, skills: { charisma: 6 }, msg: 'Eventi di networking proficui!', category: 'sociale' },
        public_speaking: { cost: 50, time: 3, effects: { morale: 10, energy: -35 }, skills: { charisma: 8 }, msg: 'Corso di public speaking intensivo!', category: 'educazione' }
    };

    // ---------- ACTION LOCATIONS (for travel) ----------
    const ACTION_LOCATIONS = {
        // Casa (no travel)
        eat: 'home', sleep: 'home', nap: 'home', shower: 'home', cook: 'home', clean: 'home',
        relax: 'home', read: 'home', exercise: 'home', meditate: 'home', video_games: 'home',
        hobby_paint: 'home', study: 'home',

        // Parco (natura)
        park: 'zona_residenziale', jog_park: 'zona_residenziale', picnic: 'zona_residenziale', bird_watching: 'zona_residenziale',

        // Palestra (sport)
        gym: 'quartiere_operaio', yoga_class: 'zona_residenziale', swimming: 'quartiere_operaio', boxing: 'quartiere_operaio',
        bowling: 'quartiere_operaio', mini_golf: 'periferia',

        // Biblioteca (cultura)
        library: 'centro_storico', research: 'centro_storico', book_club: 'centro_storico',
        museum: 'centro_storico', art_gallery: 'centro_storico', guided_tour: 'centro_storico',

        // Caff (sociale/cibo)
        cafe: 'centro_storico', breakfast_cafe: 'centro_storico', cafe_work: 'centro_storico',
        fast_food: 'quartiere_operaio', restaurant: 'centro_storico', fine_dining: 'quartiere_lusso',

        // Cinema (intrattenimento)
        cinema: 'centro_storico', cinema_vip: 'quartiere_lusso', theater: 'centro_storico', opera: 'quartiere_lusso',
        live_music: 'centro_storico', karaoke: 'quartiere_operaio',

        // Vita notturna
        bar: 'quartiere_operaio', nightclub: 'centro_storico',

        // Shopping
        window_shopping: 'centro_storico', shopping: 'centro_storico', luxury_shopping: 'quartiere_lusso',
        electronics_store: 'quartiere_operaio', // Near the technical areas

        // Benessere & Relax
        spa: 'quartiere_lusso', massage: 'quartiere_lusso', sauna: 'quartiere_lusso',

        // Corsi & Formazione
        cooking_class: 'zona_residenziale', language_class: 'centro_storico', art_class: 'centro_storico',

        // Volontariato
        volunteer: 'periferia', animal_shelter: 'periferia',

        // Sociale
        meet_new: 'centro_storico', talk: 'current', // 'current' means stay in current location

        // Lavoro (handled separately, job has its own location)
        work: 'job_location',
        
        // Nuove attivit skill training
        yoga: 'zona_residenziale',
        music_lesson: 'centro_storico',
        photography: 'centro_storico',
        networking: 'quartiere_lusso',
        public_speaking: 'centro_storico'
    };
    
    // Map actions to specific buildings
    const ACTION_BUILDINGS = {
        // Home actions
        eat: 'home', sleep: 'home', nap: 'home', shower: 'home', cook: 'home', clean: 'home',
        relax: 'home', read: 'home', exercise: 'home', meditate: 'home', video_games: 'home',
        hobby_paint: 'home', study: 'home',
        
        // Parks
        park: 'park', jog_park: 'park', picnic: 'park', bird_watching: 'park',
        
        // Gym
        gym: 'gym', yoga_class: 'gym', swimming: 'gym', boxing: 'gym', yoga: 'gym',
        bowling: 'gym', mini_golf: 'gym',
        
        // Library
        library: 'library', research: 'library', book_club: 'library',
        
        // Museum
        museum: 'museum', art_gallery: 'museum', guided_tour: 'museum',
        
        // Restaurants/Cafes
        cafe: 'restaurant', breakfast_cafe: 'restaurant', cafe_work: 'restaurant',
        fast_food: 'restaurant', restaurant: 'restaurant', fine_dining: 'restaurant',
        
        // Entertainment
        cinema: 'cinema', cinema_vip: 'cinema',
        theater: 'theater', opera: 'theater',
        live_music: 'bar', karaoke: 'bar',
        
        // Nightlife
        bar: 'bar', nightclub: 'nightclub',
        
        // Shopping
        window_shopping: 'mall', shopping: 'mall', luxury_shopping: 'mall',
        
        // Wellness
        spa: 'hospital', massage: 'hospital', sauna: 'hospital',
        
        // Classes
        cooking_class: 'restaurant', language_class: 'library', art_class: 'museum',
        music_lesson: 'theater', photography: 'museum',
        
        // Social
        networking: 'restaurant', public_speaking: 'theater',
        meet_new: 'street', talk: 'street',
        
        // Work
        work: 'work'
    };

    // ---------- INIT ----------
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            $('loadingScreen').style.display = 'none';
        }, 1500);
        initTraits();
        checkSavedGame();
    });

    function initTraits() {
        const grid = $('traitsGrid');
        grid.innerHTML = '';
        TRAITS.forEach(t => {
            const card = document.createElement('div');
            card.className = 'trait-card';
            card.onclick = function() {
                const checkbox = card.querySelector('input[type=checkbox]');
                checkbox.checked = !checkbox.checked;
                limitTraits();
            };
            
            card.innerHTML = `
                <input type="checkbox" value="${t.id}" onchange="limitTraits()" />
                <div style="font-weight:600; margin-bottom:4px; font-size:0.95rem;">${t.name}</div>
                <div style="font-size:0.75rem; opacity:0.7; line-height:1.3;">
                    ${getTraitDescription(t.id)}
                </div>
            `;
            grid.appendChild(card);
        });
        
        // Update background and difficulty info on load
        updateBackgroundInfo();
        updateDifficultyInfo();
    }

    function getTraitDescription(traitId) {
        const descriptions = {
            ambitious: '+10% salario, +5 energia ma +5 stress',
            charismatic: '+20 relazioni sociali, -10% prezzi negozi',
            athletic: '+15 salute massima, +10 energia da sport',
            intelligent: '+15% apprendimento, +10 prestazioni lavoro',
            creative: '+20% guadagni attivit artistiche',
            disciplined: '-20% stress, +10 prestazioni lavorative',
            lucky: '+15% eventi positivi casuali',
            frugal: '-15% spese giornaliere',
            workaholic: '+20% salario, -10 morale, +10 stress',
            lazy: '-10% prestazioni, +10 energia da riposo',
            anxious: '+15 stress iniziale, -10 relazioni sociali',
            extrovert: '+15 morale da eventi sociali',
            introvert: '-10 morale da eventi sociali, +5 da attivit solitarie',
            greedy: '+15% guadagni ma -10 morale se basso su soldi',
            generous: '-10% soldi, +15 relazioni sociali'
        };
        return descriptions[traitId] || 'Tratto speciale';
    }

    function limitTraits() {
        const cards = document.querySelectorAll('.trait-card');
        const checked = document.querySelectorAll('#traitsGrid input[type=checkbox]:checked');
        
        if (checked.length > 3) {
            checked[checked.length - 1].checked = false;
            showNotification(' Massimo 3 tratti!', 2000);
        }
        
        // Update visual state of cards
        cards.forEach(card => {
            const checkbox = card.querySelector('input[type=checkbox]');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    function updateBackgroundInfo() {
        const background = $('charBackground').value;
        const info = $('backgroundInfo');
        
        const backgrounds = {
            student: {
                title: ' Studente',
                desc: 'Sei un giovane studente in cerca di opportunit.',
                pros: '<strong> Vantaggi:</strong> +10 intelligenza, accesso a borse di studio, -30% affitto studenti',
                cons: '<strong> Svantaggi:</strong> Stipendio iniziale basso, poche competenze lavorative'
            },
            worker: {
                title: ' Lavoratore',
                desc: 'Hai esperienza pratica e sei abituato al lavoro duro.',
                pros: '<strong> Vantaggi:</strong> +15 forza, +20% stipendio lavori manuali, +10 resistenza',
                cons: '<strong> Svantaggi:</strong> Difficolt con lavori d\'ufficio, -5 intelligenza'
            },
            tech: {
                title: ' Tecnico IT',
                desc: 'Esperto di tecnologia con competenze specializzate.',
                pros: '<strong> Vantaggi:</strong> +20 intelligenza, +50% guadagno lavori tech, accesso lavori specializzati',
                cons: '<strong> Svantaggi:</strong> -10 forza fisica, -5 relazioni sociali iniziali'
            },
            artist: {
                title: ' Artista',
                desc: 'Creativo e sensibile, cerchi di esprimerti attraverso l\'arte.',
                pros: '<strong> Vantaggi:</strong> +20 creativit, +30% guadagni arte, +10 carisma',
                cons: '<strong> Svantaggi:</strong> Reddito instabile, -10 disciplina lavorativa'
            }
        };
        
        const bg = backgrounds[background];
        info.innerHTML = `
            <div style="font-weight:600; margin-bottom:6px;">${bg.title}</div>
            <div style="margin-bottom:8px;">${bg.desc}</div>
            <div style="margin-bottom:4px;">${bg.pros}</div>
            <div>${bg.cons}</div>
        `;
    }

    function updateDifficultyInfo() {
        const difficulty = $('gameDifficulty').value;
        const info = $('difficultyInfo');
        
        const difficulties = {
            easy: {
                title: ' Modalit Facile',
                desc: 'Perfetta per chi vuole godersi la storia senza troppo stress.',
                features: [
                    ' Inizi con 1000 in tasca',
                    ' Affitti ridotti del 30%',
                    ' Stipendi aumentati del 25%',
                    ' Meno eventi criminali (-50%)',
                    ' Penalit homeless ridotte del 50%'
                ]
            },
            normal: {
                title: ' Modalit Normale',
                desc: 'Esperienza bilanciata e realistica della vita cittadina.',
                features: [
                    ' Inizi con 500 in tasca',
                    ' Affitti standard',
                    ' Stipendi normali',
                    ' Eventi casuali bilanciati',
                    ' Sfida equilibrata'
                ]
            },
            hard: {
                title: ' Modalit Difficile',
                desc: 'Per chi cerca una vera sfida di sopravvivenza.',
                features: [
                    ' Inizi con solo 200',
                    ' Affitti aumentati del 20%',
                    ' Stipendi ridotti del 15%',
                    ' Eventi negativi pi frequenti (+50%)',
                    ' Penalit homeless aumentate del 50%',
                    ' Rischio licenziamento pi alto'
                ]
            }
        };
        
        const diff = difficulties[difficulty];
        info.innerHTML = `
            <div style="font-weight:600; margin-bottom:6px;">${diff.title}</div>
            <div style="margin-bottom:10px;">${diff.desc}</div>
            <div style="font-size:0.85rem;">
                ${diff.features.map(f => `<div style="margin-bottom:3px;"> ${f}</div>`).join('')}
            </div>
        `;
    }

    // ---------- GAME FLOW ----------
    function newGame() {
        showScreen('characterScreen');
    }

    function startGame() {
        const name = $('charName').value.trim() || 'Giocatore';
        const age = parseInt($('charAge').value);
        const gender = $('charGender').value;
        const background = $('charBackground').value;
        const diff = $('gameDifficulty').value;
        const traits = Array.from(document.querySelectorAll('#traitsGrid input[type=checkbox]:checked')).map(x => x.value);

        const startMoney = diff === 'easy' ? 1000 : diff === 'normal' ? 500 : 200;

        // Generate random starting skills (5-15 range for each)
        const randomSkills = {
            intellect: randInt(5, 15),
            fitness: randInt(5, 15),
            creativity: randInt(5, 15),
            charisma: randInt(5, 15)
        };

        game.player = {
            name, age, gender, background, difficulty: diff, traits,
            money: startMoney, // Total money (will be split)
            cash: Math.floor(startMoney * 0.3), // Contante (pu essere rubato)
            bankDeposit: Math.floor(startMoney * 0.7), // Deposito bancario (sicuro)
            rep: 10,
            job: 'Disoccupato',
            jobLevel: 0,
            stats: { hunger: 80, energy: 80, morale: 70, health: 90 },
            skills: randomSkills,
            totalEarned: 0,
            dailyTraining: 0, // Track skill training activities per day
            lastTrainingDay: 1, // Reset counter on new day
            workDaysThisWeek: 0, // Track work days in current week
            lastWorkDay: null, // Last day worked
            absences: 0, // Track absences for penalties
            isHomeless: true // Start as homeless until chooses housing
        };
        
        // Initialize chat history
        game.chatHistory = {};
        game.currentChatNpc = null;

        // Initialize housing - start in cheapest neighborhood (Condominio Vista Parco)
        game.housing = {
            neighborhood: 'periferia',
            residenceId: null, // Start homeless - player must find housing
            rentPaid: false,
            owned: false
        };

        // Initialize food inventory with some starter items
        game.inventory = {
            food: [
                { id: 'pane', boughtDay: 1 },
                { id: 'pasta', boughtDay: 1 },
                { id: 'acqua', boughtDay: 1 }
            ],
            devices: {
                phone: false,     // Cellulare - serve per cercare lavoro online
                computer: false   // PC - migliore ricerca lavoro + altre funzioni
            }
        };

        // Initialize city map
        game.cityMap = {
            currentLocation: 'centro_storico', // Homeless start in centro_storico (public area)
            currentBuilding: 'parco', // Start at a public location
            ownedBusinesses: [],
            discoveredLocations: [],
            transportPass: null
        };
        
        // Initialize vehicles
        game.vehicles = {
            owned: [],
            active: null // null = walking
        };

        // Initialize relationships
        game.relationships = {
            romantic: null,
            spouse: null,
            children: [],
            dating: []
        };

        // Initialize investments
        game.investments = {
            stocks: [],
            savings: 0,
            properties: [],
            loans: [] // Array of {id, amount, interestRate, monthlyPayment, remainingMonths, bank, takenDay}
        };
        
        // Initialize companies tracking
        game.companies = {}; // Will be populated from job listings

        // Initialize crime
        game.crime = {
            record: [],
            wanted: 0,
            reputation: 'pulito'
        };
        
        // Initialize health tracking for game over
        game.healthTracking = {
            lowEnergyDays: 0,
            lowHungerDays: 0,
            lowHealthDays: 0,
            debtDays: 0,
            lastCheckDay: 1
        };

    // Time now tracks minutes explicitly for precise control
    game.time = { day: 1, hour: 8, minute: 0 };
        game.lastRentPayment = 1;
        game.lastTaxPayment = 1;
        
        // Initialize agenda (calendar/appointments)
        game.agenda = {
            appointments: [], // Array of {day, hour, type, title, description, location, npcId}
            reminders: []
        };
        
        // Initialize time control with protection
        window.game.timeControl = {
            isPaused: false, // Start with time running
            speed: 1, // 1x, 2x, 5x, 10x
            lastTick: Date.now()
        };
        
        // Protect timeControl from being overwritten
        Object.defineProperty(window.game, 'timeControl', {
            value: window.game.timeControl,
            writable: true,
            enumerable: true,
            configurable: false
        });
        
        // Log function for game messages
        window.addLog = function(message) {
            // Just use console.log for now, could be enhanced with UI notifications
            console.log(' Game Log:', message);
        };
        
        window.game.npcs = generateInitialNPCs();
        window.game.quests = generateInitialQuests();
        
        console.log(' Inizializzando jobListings...');
        const jobListings = window.generateJobListings();
        console.log(' JobListings generati:', jobListings?.length, 'lavori');
        window.game.jobListings = jobListings;
        console.log(' game.jobListings assegnato:', window.game.jobListings?.length);
        
        // Initialize companies and stocks from job listings
        initializeCompanies();

        if (game.player.isHomeless) {
            const currentLocation = game.cityMap.currentLocation || 'centro_storico';
            const neighborhood = NEIGHBORHOODS[currentLocation];
            const locationName = neighborhood ? neighborhood.name : 'Centro Storico';
            showNotification(`Benvenuto/a ${name}! Sei homeless e inizi nel ${locationName}.`, 3000);
        } else {
            const homeLocation = game.housing.neighborhood || 'periferia';
            const neighborhood = NEIGHBORHOODS[homeLocation];
            const locationName = neighborhood ? neighborhood.name : 'Periferia';
            showNotification(`Benvenuto/a ${name}! Inizi in ${locationName}.`, 2500);
        }
        
        showScreen('gameScreen');
        updateUI();
        
        // Initialize map view based on homeless status
        setTimeout(() => {
            if (game.player.isHomeless) {
                renderDetailedMap(game.cityMap.currentLocation);
            } else {
                renderDetailedMap(game.housing.neighborhood);
            }
            updatePlayerMarker();
        }, 100);
        
        // Start game loop for automatic time progression
        console.log(' About to start game loop...');
        startGameLoop();
        
        // Initialize new time control buttons
        console.log(' Initializing time control buttons...');
        updateTimeButtons();
        
        // Initialize the game in PAUSED state by default
        console.log(' Setting game to PAUSED by default...');
        window.game.timeControl.isPaused = true;
        window._timePaused = true;
        updateTimeButtons();
        console.log(' Game initialization complete');
        
        // Show welcome tutorial after starting the game
        setTimeout(() => {
            showWelcomeTutorial();
        }, 1000);
    }

    // ---------- NPC GENERATION ----------
    function generateInitialNPCs() {
        const npcData = [
            { name: 'Marco', job: 'Studente', personality: 'amichevole', mood: 'allegro', locationId: 'loc_c7', neighborhood: 'centro_storico', homeLocationId: 'loc_p6' },
            { name: 'Giulia', job: 'Barista', personality: 'socievole', mood: 'neutro', locationId: 'loc_o1', neighborhood: 'quartiere_operaio', homeLocationId: 'loc_o8' },
            { name: 'Luca', job: 'Programmatore', personality: 'introverso', mood: 'concentrato', locationId: 'loc_c1', neighborhood: 'centro_storico', homeLocationId: 'loc_r8' },
            { name: 'Sofia', job: 'Artista', personality: 'creativa', mood: 'ispirata', locationId: 'loc_c3', neighborhood: 'centro_storico', homeLocationId: 'loc_c8' },
            { name: 'Alessandro', job: 'Manager', personality: 'professionale', mood: 'serio', locationId: 'loc_c2', neighborhood: 'centro_storico', homeLocationId: 'loc_r7' },
            { name: 'Chiara', job: 'Insegnante', personality: 'paziente', mood: 'calma', locationId: 'loc_r2', neighborhood: 'zona_residenziale', homeLocationId: 'loc_r9' }
        ];
        
        return npcData.map((n, i) => ({
            id: 'npc_' + i,
            name: n.name,
            relation: 0, // Inizi senza conoscere nessuno!
            known: false, // Devi incontrare l'NPC prima
            job: n.job,
            personality: n.personality,
            mood: n.mood,
            locationId: n.locationId, // Dove lavora/frequenta
            neighborhood: n.neighborhood,
            location: n.neighborhood, // Current location for filtering
            homeLocationId: n.homeLocationId, // Dove abita
            homeNeighborhood: n.homeNeighborhood,
            conversationStyle: getConversationStyle(n.personality),
            lastInteraction: 0,
            schedule: generateNPCSchedule(n.job), // Orari in cui  presente nelle location
            hasInternet: ['Programmatore', 'Manager', 'Artista'].includes(n.job) // Computer-savvy NPCs
        }));
    }
    
    function generateNPCSchedule(job) {
        // Orari approssimativi in cui l'NPC  nella sua location di lavoro
        const schedules = {
            'Barista': { workDays: [1,2,3,4,5,6], workHours: { start: 7, end: 18 }, homeDays: [7] },
            'Studente': { workDays: [1,2,3,4,5], workHours: { start: 9, end: 17 }, homeDays: [6,7] },
            'Programmatore': { workDays: [1,2,3,4,5], workHours: { start: 9, end: 18 }, homeDays: [6,7] },
            'Artista': { workDays: [2,3,4,5,6], workHours: { start: 10, end: 19 }, homeDays: [1,7] },
            'Manager': { workDays: [1,2,3,4,5], workHours: { start: 8, end: 19 }, homeDays: [6,7] },
            'Insegnante': { workDays: [1,2,3,4,5], workHours: { start: 8, end: 16 }, homeDays: [6,7] }
        };
        return schedules[job] || { workDays: [1,2,3,4,5], workHours: { start: 9, end: 17 }, homeDays: [6,7] };
    }
    
    function getConversationStyle(personality) {
        const styles = {
            'amichevole': { greeting: 'Ciao! Come va?', tone: 'casual e amichevole' },
            'socievole': { greeting: 'Hey! Che piacere vederti!', tone: 'energico e positivo' },
            'introverso': { greeting: 'Salve.', tone: 'riservato ma educato' },
            'creativa': { greeting: 'Oh ciao! Sto lavorando a una nuova idea!', tone: 'entusiasta e creativo' },
            'professionale': { greeting: 'Buongiorno. In cosa posso aiutarti?', tone: 'formale e diretto' },
            'paziente': { greeting: 'Ciao! Tutto bene?', tone: 'calmo e comprensivo' }
        };
        return styles[personality] || styles['amichevole'];
    }
    
    // Update NPC locations based on time and schedule
    function updateNpcLocations() {
        if (!game.npcs || !Array.isArray(game.npcs)) return;
        
        const currentHour = game.time.hour;
        const dayOfWeek = ((game.time.day - 1) % 7) + 1; // 1 = Monday, 7 = Sunday
        
        game.npcs.forEach(npc => {
            if (!npc.schedule) return;
            
            const isWorkDay = npc.schedule.workDays.includes(dayOfWeek);
            const isWorkHours = currentHour >= npc.schedule.workHours.start && 
                              currentHour < npc.schedule.workHours.end;
            
            if (isWorkDay && isWorkHours) {
                // NPC is at work location
                npc.location = npc.neighborhood;
            } else {
                // NPC might be at home, out shopping, or in random locations
                const random = Math.random();
                
                if (random < 0.7) {
                    // 70% chance at home
                    if (npc.homeLocationId && NEIGHBORHOODS) {
                        // Find home neighborhood from homeLocationId
                        const homeNeighborhood = findNeighborhoodByLocationId(npc.homeLocationId);
                        npc.location = homeNeighborhood || npc.neighborhood;
                    } else {
                        npc.location = npc.neighborhood;
                    }
                } else {
                    // 30% chance exploring other areas
                    const neighborhoods = ['centro_storico', 'zona_residenziale', 'quartiere_operaio', 'periferia', 'quartiere_lusso'];
                    npc.location = neighborhoods[Math.floor(Math.random() * neighborhoods.length)];
                }
            }
        });
    }
    
    // Helper function to find neighborhood by location ID
    function findNeighborhoodByLocationId(locationId) {
        if (!NEIGHBORHOODS) return null;
        
        for (const [neighborhoodKey, neighborhood] of Object.entries(NEIGHBORHOODS)) {
            if (neighborhood.locations && neighborhood.locations.some(loc => loc.id === locationId)) {
                return neighborhoodKey;
            }
        }
        return null;
    }

    // ---------- QUESTS ----------
    function generateInitialQuests() {
        return [
            { id: 'first_job', name: 'Trova il tuo primo lavoro', desc: 'Cerca un lavoro nelle offerte disponibili', completed: false, reward: 100 },
            { id: 'make_friend', name: 'Fai amicizia', desc: 'Porta la relazione con qualcuno a 50+', completed: false, reward: 50 }
        ];
    }

    function renderQuests() {
        const list = $('questsList');
        if (!list) return;
        
        if (game.quests.length === 0) {
            list.innerHTML = '<p style="opacity:0.7;">Nessuna missione attiva.</p>';
            return;
        }

        list.innerHTML = game.quests.map(q => `
            <div class="quest-card ${q.completed ? 'completed' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${q.completed ? '' : ''} ${q.name}</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">${q.desc}</div>
                    </div>
                    <div style="text-align:right; min-width:80px;">
                        <div style="color:var(--success); font-weight:bold;">+${q.reward}</div>
                        ${q.completed ? '<div style="color:var(--success); font-size:0.85rem;">Completata!</div>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function checkQuests() {
        game.quests.forEach(q => {
            if (q.completed) return;

            if (q.id === 'first_job' && game.player.job !== 'Disoccupato') {
                q.completed = true;
                earnMoney(q.reward);
                showNotification(` Missione completata: ${q.name}! +${q.reward}`, 2500);
            }

            if (q.id === 'make_friend') {
                const hasFriend = game.npcs.some(npc => npc.relation >= 50);
                if (hasFriend) {
                    q.completed = true;
                    earnMoney(q.reward);
                    showNotification(` Missione completata: ${q.name}! +${q.reward}`, 2500);
                }
            }
        });
        renderQuests();
    }

    // ---------- JOB SYSTEM ----------
    window.generateJobListings = function generateJobListings() {
        return [
            // Entry Level
            // ENTRY LEVEL - Periferia
            { 
                id: 'job1', 
                name: 'Commesso Supermercato', 
                salary: 45, 
                reqRep: 0,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Roberto Marchetti',
                managerPersonality: 'professionale',
                tasks: ['Riordina scaffali', 'Assisti clienti', 'Gestisci cassa'],
                locationId: 'loc_p1', // Minimarket Express
                location: 'periferia'
            },
            { 
                id: 'job2', 
                name: 'Aiuto Pizzaiolo', 
                salary: 48, 
                reqRep: 0,
                hours: { start: 11, end: 19 },
                daysPerWeek: 5,
                manager: 'Mario Esposito',
                managerPersonality: 'paziente',
                tasks: ['Prepara impasti', 'Guarnisci pizze', 'Gestisci forno'],
                locationId: 'loc_p2', // Pizzeria Da Mario
                location: 'periferia'
            },
            
            // ENTRY LEVEL - Quartiere Operaio
            { 
                id: 'job3', 
                name: 'Barista', 
                salary: 50, 
                reqRep: 0,
                hours: { start: 7, end: 15 },
                daysPerWeek: 5,
                manager: 'Maria Rossi',
                managerPersonality: 'socievole',
                tasks: ['Prepara caff', 'Servi clienti', 'Gestisci cassa'],
                locationId: 'loc_o1', // Bar Centrale
                location: 'quartiere_operaio'
            },
            { 
                id: 'job4', 
                name: 'Commesso Ferramenta', 
                salary: 52, 
                reqRep: 5,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Giuseppe Bianchi',
                managerPersonality: 'professionale',
                tasks: ['Assisti clienti', 'Gestisci magazzino', 'Riordina merce'],
                locationId: 'loc_o2', // Ferramenta Bianchi
                location: 'quartiere_operaio'
            },
            { 
                id: 'job5', 
                name: 'Istruttore Palestra', 
                salary: 65, 
                reqRep: 10,
                hours: { start: 14, end: 22 },
                daysPerWeek: 5,
                manager: 'Luca Vitale',
                managerPersonality: 'amichevole',
                tasks: ['Segui clienti', 'Crea schede allenamento', 'Mantieni attrezzature'],
                locationId: 'loc_o3', // Palestra FitLife
                location: 'quartiere_operaio'
            },
            
            // INTERMEDIATE - Centro Storico
            { 
                id: 'job6', 
                name: 'Commesso Boutique', 
                salary: 85, 
                reqRep: 15,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Stefano Moretti',
                managerPersonality: 'professionale',
                tasks: ['Vendi abbigliamento', 'Consiglia clienti', 'Allestisci vetrine'],
                locationId: 'loc_c1', // Boutique Eleganza
                location: 'centro_storico'
            },
            { 
                id: 'job7', 
                name: 'Cameriere', 
                salary: 75, 
                reqRep: 10,
                hours: { start: 12, end: 20 },
                daysPerWeek: 5,
                manager: 'Antonio Verdi',
                managerPersonality: 'paziente',
                tasks: ['Prendi ordini', 'Servi tavoli', 'Gestisci clienti'],
                locationId: 'loc_c2', // Ristorante La Tavola
                location: 'centro_storico'
            },
            { 
                id: 'job8', 
                name: 'Assistente Gallerista', 
                salary: 90, 
                reqRep: 20,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Elena Costa',
                managerPersonality: 'creativa',
                tasks: ['Accogli visitatori', 'Organizza mostre', 'Gestisci vendite opere'],
                locationId: 'loc_c3', // Galleria Arte Moderna
                location: 'centro_storico'
            },
            
            // INTERMEDIATE - Zona Residenziale
            { 
                id: 'job9', 
                name: 'Pasticciere', 
                salary: 80, 
                reqRep: 15,
                hours: { start: 6, end: 14 },
                daysPerWeek: 5,
                manager: 'Carla Fabbri',
                managerPersonality: 'paziente',
                tasks: ['Prepara dolci', 'Servi clienti', 'Gestisci vetrina'],
                locationId: 'loc_r1', // Pasticceria Dolce Vita
                location: 'zona_residenziale'
            },
            { 
                id: 'job10', 
                name: 'Libraio', 
                salary: 70, 
                reqRep: 12,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Paolo Mondadori',
                managerPersonality: 'introverso',
                tasks: ['Consiglia libri', 'Gestisci inventario', 'Organizza eventi'],
                locationId: 'loc_r2', // Libreria Mondadori
                location: 'zona_residenziale'
            },
            { 
                id: 'job11', 
                name: 'Addetto Pet Shop', 
                salary: 65, 
                reqRep: 8,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Sara Benedetti',
                managerPersonality: 'socievole',
                tasks: ['Cura animali', 'Consiglia clienti', 'Gestisci prodotti'],
                locationId: 'loc_r3', // Pet Paradise
                location: 'zona_residenziale'
            },
            
            // PROFESSIONAL - Quartiere Lusso
            { 
                id: 'job12', 
                name: 'Commesso Gioielleria', 
                salary: 120, 
                reqRep: 30,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Alessandro Cartier',
                managerPersonality: 'professionale',
                tasks: ['Vendi gioielli', 'Valuta pezzi', 'Gestisci clientela VIP'],
                locationId: 'loc_l1', // Gioielleria Cartier
                location: 'quartiere_lusso'
            },
            { 
                id: 'job13', 
                name: 'Sous Chef', 
                salary: 150, 
                reqRep: 35,
                hours: { start: 11, end: 19 },
                daysPerWeek: 5,
                manager: 'Chef Matteo Stellini',
                managerPersonality: 'esigente',
                tasks: ['Coordina cucina', 'Crea piatti', 'Gestisci staff'],
                locationId: 'loc_l2', // Ristorante Stella Michelin
                location: 'quartiere_lusso'
            },
            { 
                id: 'job14', 
                name: 'Terapista SPA', 
                salary: 110, 
                reqRep: 25,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Laura Serenit',
                managerPersonality: 'paziente',
                tasks: ['Esegui trattamenti', 'Consiglia percorsi', 'Gestisci prenotazioni'],
                locationId: 'loc_l3', // Spa Serenit
                location: 'quartiere_lusso'
            },
            
            // PROFESSIONAL - Centro Storico (Uffici virtuali)
            { 
                id: 'job15', 
                name: 'Programmatore Junior', 
                salary: 120, 
                reqRep: 30,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Marco Ricci',
                managerPersonality: 'introverso',
                tasks: ['Sviluppa codice', 'Debug problemi', 'Scrivi documentazione'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub
                location: 'centro_storico'
            },
            { 
                id: 'job16', 
                name: 'Grafico Pubblicitario', 
                salary: 110, 
                reqRep: 25,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Elena Fontana',
                managerPersonality: 'creativa',
                tasks: ['Crea design', 'Gestisci progetti', 'Presenta concept'],
                locationId: 'loc_c5', // Locale Centrale - Studio Creativo
                location: 'centro_storico'
            },
            { 
                id: 'job17', 
                name: 'Social Media Manager', 
                salary: 105, 
                reqRep: 22,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Chiara Gallo',
                managerPersonality: 'socievole',
                tasks: ['Gestisci social', 'Crea contenuti', 'Analizza metriche'],
                locationId: 'loc_c5', // Locale Centrale - Agenzia Marketing
                location: 'centro_storico'
            },
            
            // SENIOR/MANAGEMENT - Quartiere Lusso
            { 
                id: 'job18', 
                name: 'Manager Boutique Luxury', 
                salary: 200, 
                reqRep: 50,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Isabella Monti',
                managerPersonality: 'esigente',
                tasks: ['Gestisci team', 'Seleziona collezioni', 'Clientela VIP'],
                locationId: 'loc_l4', // Boutique Luxury
                location: 'quartiere_lusso'
            },
            { 
                id: 'job19', 
                name: 'Programmatore Senior', 
                salary: 220, 
                reqRep: 55,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Matteo Esposito',
                managerPersonality: 'introverso',
                tasks: ['Architetta sistemi', 'Mentora junior', 'Risolvi problemi complessi'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub Senior
                location: 'centro_storico'
            },
            { 
                id: 'job20', 
                name: 'Project Manager', 
                salary: 200, 
                reqRep: 50,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Francesca Colombo',
                managerPersonality: 'professionale',
                tasks: ['Coordina team', 'Pianifica progetti', 'Meeting clienti'],
                locationId: 'loc_c5', // Locale Centrale - Business Hub
                location: 'centro_storico'
            },
            
            // EXECUTIVE - Quartiere Lusso
            { 
                id: 'job21', 
                name: 'Direttore Ristorante Stellato', 
                salary: 280, 
                reqRep: 70,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Proprietario',
                managerPersonality: 'esigente',
                tasks: ['Gestisci ristorante', 'Supervisiona staff', 'Relazioni VIP'],
                locationId: 'loc_l2', // Ristorante Stella Michelin
                location: 'quartiere_lusso'
            },
            { 
                id: 'job22', 
                name: 'Direttore SPA Luxury', 
                salary: 250, 
                reqRep: 65,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Consiglio Amministrazione',
                managerPersonality: 'professionale',
                tasks: ['Gestisci centro', 'Pianifica strategie', 'Budget e investimenti'],
                locationId: 'loc_l3', // Spa Serenit
                location: 'quartiere_lusso'
            },
            { 
                id: 'job23', 
                name: 'CTO - Chief Technology Officer', 
                salary: 350, 
                reqRep: 80,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'CEO',
                managerPersonality: 'visionario',
                tasks: ['Strategia tecnologica', 'Guida tech team', 'Innovazione prodotto'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub HQ
                location: 'centro_storico'
            },
            { 
                id: 'job24', 
                name: 'Direttore Marketing', 
                salary: 320, 
                reqRep: 75,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'CEO',
                managerPersonality: 'professionale',
                tasks: ['Strategia marketing', 'Gestisci budget', 'Guida campagne'],
                locationId: 'loc_c5', // Locale Centrale - Corporate Office
                location: 'centro_storico'
            },
            { 
                id: 'job25', 
                name: 'CEO Startup', 
                salary: 400, 
                reqRep: 90,
                hours: { start: 8, end: 16 },
                daysPerWeek: 5,
                manager: 'Consiglio Amministrazione',
                managerPersonality: 'visionario',
                tasks: ['Guida azienda', 'Strategia aziendale', 'Fundraising investitori'],
                locationId: 'loc_c4', // Palazzo Storico - Startup Hub
                location: 'centro_storico'
            }
        ];
    }

    // ---------- CAREER PATHS SYSTEM ----------
    const CAREER_PATHS = {
        hospitality: {
            name: 'Ospitalit & Ristorazione',
            levels: [
                { 
                    level: 0, 
                    title: 'Commesso/Cameriere', 
                    salary: 50, 
                    requirements: { intellect: 0, charisma: 10, fitness: 10 },
                    description: 'Livello base nel settore ospitalit'
                },
                { 
                    level: 1, 
                    title: 'Cuoco/Barista Senior', 
                    salary: 85, 
                    requirements: { intellect: 15, charisma: 20, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Gestione autonoma e responsabilit'
                },
                { 
                    level: 2, 
                    title: 'Supervisore Sala', 
                    salary: 130, 
                    requirements: { intellect: 25, charisma: 35, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento staff e gestione turni'
                },
                { 
                    level: 3, 
                    title: 'Assistant Manager', 
                    salary: 180, 
                    requirements: { intellect: 35, charisma: 45, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Vice del manager, gestione operativa'
                },
                { 
                    level: 4, 
                    title: 'Restaurant Manager', 
                    salary: 250, 
                    requirements: { intellect: 45, charisma: 55, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Gestione completa del ristorante'
                },
                { 
                    level: 5, 
                    title: 'Direttore Area', 
                    salary: 350, 
                    requirements: { intellect: 60, charisma: 70, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Supervisione di pi location'
                }
            ]
        },
        retail: {
            name: 'Vendite & Retail',
            levels: [
                { 
                    level: 0, 
                    title: 'Addetto Vendite', 
                    salary: 55, 
                    requirements: { intellect: 10, charisma: 15, fitness: 10 },
                    description: 'Assistenza clienti e gestione cassa'
                },
                { 
                    level: 1, 
                    title: 'Venditore Specializzato', 
                    salary: 90, 
                    requirements: { intellect: 20, charisma: 30, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Consulenza specializzata ai clienti'
                },
                { 
                    level: 2, 
                    title: 'Team Leader Vendite', 
                    salary: 140, 
                    requirements: { intellect: 30, charisma: 40, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento piccolo team'
                },
                { 
                    level: 3, 
                    title: 'Store Manager', 
                    salary: 200, 
                    requirements: { intellect: 40, charisma: 50, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Gestione completa del punto vendita'
                },
                { 
                    level: 4, 
                    title: 'District Manager', 
                    salary: 280, 
                    requirements: { intellect: 50, charisma: 60, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Supervisione area territoriale'
                },
                { 
                    level: 5, 
                    title: 'Direttore Vendite', 
                    salary: 380, 
                    requirements: { intellect: 65, charisma: 75, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Strategia vendite nazionale'
                }
            ]
        },
        tech: {
            name: 'Tecnologia & IT',
            levels: [
                { 
                    level: 0, 
                    title: 'Programmatore Junior', 
                    salary: 120, 
                    requirements: { intellect: 30, charisma: 10, creativity: 20 },
                    description: 'Sviluppo sotto supervisione'
                },
                { 
                    level: 1, 
                    title: 'Programmatore', 
                    salary: 180, 
                    requirements: { intellect: 45, charisma: 20, creativity: 30, performance: 70, managerRelation: 60 },
                    description: 'Sviluppo autonomo di features'
                },
                { 
                    level: 2, 
                    title: 'Senior Developer', 
                    salary: 250, 
                    requirements: { intellect: 60, charisma: 30, creativity: 45, performance: 75, managerRelation: 70 },
                    description: 'Architettura e mentoring'
                },
                { 
                    level: 3, 
                    title: 'Tech Lead', 
                    salary: 320, 
                    requirements: { intellect: 70, charisma: 45, creativity: 55, performance: 80, managerRelation: 75 },
                    description: 'Guida tecnica del team'
                },
                { 
                    level: 4, 
                    title: 'Engineering Manager', 
                    salary: 400, 
                    requirements: { intellect: 80, charisma: 60, creativity: 65, performance: 85, managerRelation: 80 },
                    description: 'Gestione team sviluppo'
                },
                { 
                    level: 5, 
                    title: 'CTO', 
                    salary: 550, 
                    requirements: { intellect: 90, charisma: 70, creativity: 75, performance: 90, managerRelation: 85 },
                    description: 'Direzione tecnologica aziendale'
                }
            ]
        },
        creative: {
            name: 'Creativo & Marketing',
            levels: [
                { 
                    level: 0, 
                    title: 'Junior Designer', 
                    salary: 95, 
                    requirements: { intellect: 20, charisma: 20, creativity: 30 },
                    description: 'Esecuzione progetti creativi'
                },
                { 
                    level: 1, 
                    title: 'Graphic Designer', 
                    salary: 140, 
                    requirements: { intellect: 30, charisma: 30, creativity: 45, performance: 70, managerRelation: 60 },
                    description: 'Design autonomo e concept'
                },
                { 
                    level: 2, 
                    title: 'Art Director', 
                    salary: 200, 
                    requirements: { intellect: 40, charisma: 45, creativity: 60, performance: 75, managerRelation: 70 },
                    description: 'Direzione creativa progetti'
                },
                { 
                    level: 3, 
                    title: 'Marketing Manager', 
                    salary: 270, 
                    requirements: { intellect: 50, charisma: 60, creativity: 70, performance: 80, managerRelation: 75 },
                    description: 'Strategia e campagne marketing'
                },
                { 
                    level: 4, 
                    title: 'Creative Director', 
                    salary: 360, 
                    requirements: { intellect: 60, charisma: 70, creativity: 80, performance: 85, managerRelation: 80 },
                    description: 'Visione creativa aziendale'
                },
                { 
                    level: 5, 
                    title: 'CMO', 
                    salary: 480, 
                    requirements: { intellect: 75, charisma: 80, creativity: 90, performance: 90, managerRelation: 85 },
                    description: 'Direzione marketing e branding'
                }
            ]
        },
        healthcare: {
            name: 'Sanit & Medicina',
            levels: [
                { 
                    level: 0, 
                    title: 'Infermiere', 
                    salary: 115, 
                    requirements: { intellect: 30, charisma: 20, fitness: 25 },
                    description: 'Assistenza pazienti e cure base'
                },
                { 
                    level: 1, 
                    title: 'Infermiere Specializzato', 
                    salary: 165, 
                    requirements: { intellect: 45, charisma: 30, fitness: 30, performance: 70, managerRelation: 60 },
                    description: 'Procedure specialistiche'
                },
                { 
                    level: 2, 
                    title: 'Coordinatore Infermieristico', 
                    salary: 220, 
                    requirements: { intellect: 55, charisma: 45, fitness: 35, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento reparto'
                },
                { 
                    level: 3, 
                    title: 'Medico Junior', 
                    salary: 300, 
                    requirements: { intellect: 70, charisma: 50, fitness: 40, performance: 80, managerRelation: 75 },
                    description: 'Diagnosi e cure sotto supervisione'
                },
                { 
                    level: 4, 
                    title: 'Medico Specialista', 
                    salary: 420, 
                    requirements: { intellect: 85, charisma: 60, fitness: 45, performance: 85, managerRelation: 80 },
                    description: 'Specializzazione medica'
                },
                { 
                    level: 5, 
                    title: 'Primario', 
                    salary: 600, 
                    requirements: { intellect: 95, charisma: 75, fitness: 50, performance: 90, managerRelation: 85 },
                    description: 'Direzione reparto ospedaliero'
                }
            ]
        },
        business: {
            name: 'Business & Management',
            levels: [
                { 
                    level: 0, 
                    title: 'Assistente Amministrativo', 
                    salary: 75, 
                    requirements: { intellect: 25, charisma: 20, fitness: 10 },
                    description: 'Supporto amministrativo'
                },
                { 
                    level: 1, 
                    title: 'Analista Business', 
                    salary: 130, 
                    requirements: { intellect: 40, charisma: 30, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Analisi dati e reporting'
                },
                { 
                    level: 2, 
                    title: 'Team Leader', 
                    salary: 190, 
                    requirements: { intellect: 50, charisma: 45, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento piccoli team'
                },
                { 
                    level: 3, 
                    title: 'Project Manager', 
                    salary: 260, 
                    requirements: { intellect: 60, charisma: 60, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Gestione progetti complessi'
                },
                { 
                    level: 4, 
                    title: 'Senior Manager', 
                    salary: 350, 
                    requirements: { intellect: 70, charisma: 70, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Gestione dipartimento'
                },
                { 
                    level: 5, 
                    title: 'Director/VP', 
                    salary: 500, 
                    requirements: { intellect: 85, charisma: 85, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Direzione strategica'
                }
            ]
        }
    };

    // Map jobs to career paths
    const JOB_TO_CAREER = {
        'Commesso Supermercato': 'retail',
        'Barista': 'hospitality',
        'Cameriere': 'hospitality',
        'Cuoco Aiutante': 'hospitality',
        'Head Chef': 'hospitality',
        'Addetto Vendite': 'retail',
        'Manager Vendite': 'retail',
        'Programmatore Jr': 'tech',
        'Programmatore Senior': 'tech',
        'Grafico Pubblicitario': 'creative',
        'Social Media Manager': 'creative',
        'Fotografo': 'creative',
        'Direttore Marketing': 'creative',
        'Infermiere': 'healthcare',
        'Medico': 'healthcare',
        'Receptionist': 'business',
        'Segretario': 'business',
        'Project Manager': 'business',
        'Contabile': 'business',
        'Manager': 'business',
        'Direttore Generale': 'business'
    };

    function renderJobListings() {
        const div = $('jobListingsDiv');
        if (!div) return;

        // Check if player has any device to search for jobs
        const hasPhone = game.inventory.devices.phone;
        const hasComputer = game.inventory.devices.computer;
        const hasAnyDevice = hasPhone || hasComputer;

        div.innerHTML = `
            <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; margin-bottom:12px;">
                <h4 style="margin-bottom:12px; color:#667eea;"> Come Cercare Lavoro</h4>
                <div style="font-size:0.9rem; line-height:1.6; margin-bottom:12px;">
                    Per cercare lavoro hai bisogno di:
                </div>
                
                <div style="display:grid; gap:10px; margin-bottom:16px;">
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid #ffd700;">
                        <strong> Giornale Locale (5)</strong><br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra 3 offerte base giornaliere. Disponibile in edicola.</span>
                    </div>
                    
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid ${hasPhone ? '#38ef7d' : '#666'};">
                        <strong> Cellulare (150)</strong> ${hasPhone ? '' : ''}<br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra 5 offerte di tutti i livelli.</span>
                    </div>
                    
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid ${hasComputer ? '#667eea' : '#666'};">
                        <strong> Computer (500)</strong> ${hasComputer ? '' : ''}<br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra tutte le offerte + filtri avanzati.</span>
                    </div>
                </div>

                ${!hasAnyDevice ? `
                    <div style="padding:12px; background:rgba(235,51,73,0.15); border-radius:8px; border:2px solid #eb3349; margin-bottom:12px;">
                        <strong style="color:#eb3349;"> Non hai dispositivi!</strong><br>
                        <span style="font-size:0.85rem;">Vai al negozio di elettronica per comprare un cellulare o un PC, oppure compra il giornale in edicola (5).</span>
                    </div>
                ` : ''}

                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button onclick="showJobSearchDialog('newspaper')" class="action-btn" style="flex:1; min-width:120px;">
                         Compra Giornale (5)
                    </button>
                    ${hasPhone ? `
                        <button onclick="showJobSearchDialog('phone')" class="action-btn" style="flex:1; min-width:120px; background:var(--success);">
                             Cerca con Cellulare
                        </button>
                    ` : ''}
                    ${hasComputer ? `
                        <button onclick="showJobSearchDialog('computer')" class="action-btn" style="flex:1; min-width:120px; background:var(--primary);">
                             Cerca con PC
                        </button>
                    ` : ''}
                    <button onclick="showElectronicsShop()" class="action-btn" style="flex:1; min-width:120px; background:#ff8c00;">
                         Negozio Elettronica
                    </button>
                </div>
            </div>
        `;
    }

    function showJobSearchDialog(method) {
        let cost = 0;
        let jobsToShow = [];
        let title = '';
        let description = '';

        if (method === 'newspaper') {
            cost = 5;
            title = ' Giornale Locale - Offerte Lavoro';
            description = 'Annunci base della settimana';
            // Show 3 random basic jobs
            const basicJobs = game.jobListings.filter(j => j.reqRep <= 20);
            jobsToShow = basicJobs.sort(() => Math.random() - 0.5).slice(0, 3);
            
            if (!canAfford(cost)) {
                showNotification(' Non hai abbastanza soldi per il giornale (5)', 3000);
                return;
            }
            payMoney(cost);
            showNotification(' Hai comprato il giornale locale!', 2000);
            
        } else if (method === 'phone') {
            if (!game.inventory.devices.phone) {
                showNotification(' Non hai un cellulare!', 2000);
                return;
            }
            title = ' Ricerca Online - Annunci Lavoro';
            description = 'Offerte trovate su portali online';
            // Show 5 jobs of various levels
            jobsToShow = game.jobListings.sort(() => Math.random() - 0.5).slice(0, 5);
            
        } else if (method === 'computer') {
            if (!game.inventory.devices.computer) {
                showNotification(' Non hai un computer!', 2000);
                return;
            }
            title = ' Ricerca Avanzata - Tutte le Offerte';
            description = 'Database completo con filtri avanzati';
            // Show all jobs
            jobsToShow = game.jobListings;
        }

        let html = `
            <div class="modal-section info">
                <div class="modal-section-title"> Informazioni</div>
                <div class="modal-section-content">${description}</div>
            </div>
            
            <div class="modal-section" style="border-left-color:#667eea;">
                <div class="modal-section-title"> Offerte Disponibili (${jobsToShow.length})</div>
                <div class="modal-section-content" style="max-height:50vh; overflow-y:auto;">
                    ${jobsToShow.map(j => {
                        const jobLocation = j.location || 'centro_storico';
                        const locationName = NEIGHBORHOODS[jobLocation] ? NEIGHBORHOODS[jobLocation].name : jobLocation;
                        const travelInfo = calculateTravelTime(jobLocation);
                        const canApply = game.player.rep >= j.reqRep;
                        
                        // Trova il nome del locale dalla locationId
                        let placeName = 'N/A';
                        if (j.locationId && CITY_LOCATIONS[jobLocation]) {
                            const location = CITY_LOCATIONS[jobLocation].find(loc => loc.id === j.locationId);
                            if (location) placeName = location.name;
                        }
                        
                        // Determina giorni lavorativi
                        const workDays = j.workDays || (j.daysPerWeek === 6 ? [1,2,3,4,5,6] : [1,2,3,4,5]);
                        const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                        const workDayNames = workDays.map(d => dayNames[d-1]).join(', ');
                        
                        return `
                            <div style="padding:14px; background:${canApply ? 'rgba(102,126,234,0.12)' : 'rgba(255,255,255,0.03)'}; border-radius:10px; margin-bottom:12px; border:2px solid ${canApply ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}; transition:all 0.3s;" 
                                onmouseover="this.style.background='${canApply ? 'rgba(102,126,234,0.18)' : 'rgba(255,255,255,0.05)'}'" 
                                onmouseout="this.style.background='${canApply ? 'rgba(102,126,234,0.12)' : 'rgba(255,255,255,0.03)'}'">
                                <div style="display:flex; justify-content:space-between; align-items:start; gap:12px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; font-size:1.15rem; margin-bottom:8px; color:${canApply ? '#667eea' : '#888'};">${j.name}</div>
                                        
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85rem; margin-bottom:8px;">
                                            <div> <strong>Manager:</strong> ${j.manager}</div>
                                            <div> <strong>Sede:</strong> ${locationName}</div>
                                            <div> <strong>Locale:</strong> ${placeName}</div>
                                            <div> <strong>Orario:</strong> ${j.hours.start}:00-${j.hours.end}:00</div>
                                            <div style="grid-column:1/3;"> <strong>Giorni:</strong> ${workDayNames}</div>
                                            <div> <strong>Stipendio:</strong> ${j.salary}/giorno</div>
                                        </div>
                                        
                                        <div style="font-size:0.8rem; padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:8px;">
                                             <strong>Mansioni:</strong> ${j.tasks.join('  ')}
                                        </div>
                                        
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:0.75rem;">
                                            <span style="padding:4px 8px; background:${canApply ? 'rgba(56,239,125,0.2)' : 'rgba(235,51,73,0.2)'}; border-radius:4px;">
                                                 Reputazione: ${j.reqRep} ${canApply ? '' : ''}
                                            </span>
                                            ${travelInfo.time > 0 ? `
                                                <span style="padding:4px 8px; background:rgba(255,215,0,0.15); border-radius:4px;">
                                                     Viaggio: ${travelInfo.time}h  ${travelInfo.cost}  ${travelInfo.energy}%
                                                </span>
                                            ` : '<span style="padding:4px 8px; background:rgba(56,239,125,0.15); border-radius:4px;"> Sotto casa</span>'}
                                        </div>
                                    </div>
                                    <button onclick="startJobInterview('${j.id}'); closeDialog();" 
                                            ${!canApply ? 'disabled' : ''}
                                            style="min-width:100px; padding:10px 16px; border-radius:8px; font-weight:600;">
                                        ${canApply ? ' Colloquio' : ' Bloccato'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;

        showDialog(html, title, true);
    }

    function showElectronicsShop() {
        const hasPhone = game.inventory.devices.phone;
        const hasComputer = game.inventory.devices.computer;
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;"> Negozio di Elettronica</h3>
                <p style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">Acquista dispositivi per migliorare la tua vita quotidiana</p>
                
                <div style="display:grid; gap:16px;">
                    <!-- Cellulare -->
                    <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; border:2px solid ${hasPhone ? '#38ef7d' : '#667eea'};">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                            <div>
                                <h4 style="font-size:1.2rem; margin-bottom:8px;"> Smartphone</h4>
                                <div style="font-size:0.9rem; opacity:0.9; line-height:1.6;">
                                    <strong>Funzioni:</strong><br>
                                     Cerca lavoro online (5 offerte)<br>
                                     Chiama taxi/Uber pi velocemente<br>
                                     Accesso a social media e app<br>
                                     Gestione appuntamenti
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#ffd700;">150</div>
                            </div>
                        </div>
                        ${hasPhone ? `
                            <div style="padding:10px; background:rgba(56,239,125,0.2); border-radius:8px; text-align:center; color:#38ef7d; font-weight:bold;">
                                 GI ACQUISTATO
                            </div>
                        ` : `
                            <button onclick="buyDevice('phone')" class="action-btn" style="width:100%; background:var(--success);">
                                 Acquista Cellulare
                            </button>
                        `}
                    </div>

                    <!-- Computer -->
                    <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; border:2px solid ${hasComputer ? '#38ef7d' : '#667eea'};">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                            <div>
                                <h4 style="font-size:1.2rem; margin-bottom:8px;"> Computer Desktop</h4>
                                <div style="font-size:0.9rem; opacity:0.9; line-height:1.6;">
                                    <strong>Funzioni:</strong><br>
                                     Cerca lavoro con filtri avanzati (tutte le offerte)<br>
                                     Lavoro freelance da casa<br>
                                     Trading online potenziato<br>
                                     Corsi online e formazione<br>
                                     Sviluppo software e progetti personali
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#ffd700;">500</div>
                            </div>
                        </div>
                        ${hasComputer ? `
                            <div style="padding:10px; background:rgba(56,239,125,0.2); border-radius:8px; text-align:center; color:#38ef7d; font-weight:bold;">
                                 GI ACQUISTATO
                            </div>
                        ` : `
                            <button onclick="buyDevice('computer')" class="action-btn" style="width:100%; background:var(--primary);">
                                 Acquista Computer
                            </button>
                        `}
                    </div>
                </div>

                <div style="margin-top:20px; padding:12px; background:rgba(255,215,0,0.1); border-radius:8px; border-left:4px solid #ffd700;">
                    <div style="font-size:0.9rem;">
                        <strong> Il tuo denaro:</strong><br>
                         Contante: ${game.player.cash.toFixed(0)}<br>
                         Banca: ${game.player.bankDeposit.toFixed(0)}
                    </div>
                </div>
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;

        showDialog(html);
    }

    function buyDevice(deviceType) {
        const prices = { phone: 150, computer: 500 };
        const names = { phone: 'Cellulare', computer: 'Computer' };
        const price = prices[deviceType];
        const name = names[deviceType];

        if (game.inventory.devices[deviceType]) {
            showNotification(` Hai gi un ${name}!`, 2000);
            return;
        }

        if (!canAfford(price)) {
            showNotification(` Non hai abbastanza soldi per il ${name} (${price})`, 3000);
            return;
        }

        payMoney(price);
        game.inventory.devices[deviceType] = true;
        showNotification(` Hai acquistato un ${name}! Ora puoi cercare lavoro online.`, 4000);
        
        // Close and reopen the shop to update UI
        closeDialog();
        setTimeout(() => showElectronicsShop(), 300);
    }

    function startJobInterview(jobId) {
        // Check if game object exists
        if (!window.game) {
            console.error('game object non inizializzato');
            showNotification('Errore: gioco non inizializzato!', 2000);
            return;
        }
        
        // Check if jobListings is initialized
        if (!window.game.jobListings || !Array.isArray(window.game.jobListings)) {
            console.error('game.jobListings non inizializzato', window.game.jobListings);
            showNotification('Errore: lista lavori non caricata!', 2000);
            return;
        }
        
        const job = window.game.jobListings.find(j => j.id === jobId);
        if (!job) {
            console.error('Lavoro non trovato:', jobId);
            showNotification('Lavoro non trovato!', 2000);
            return;
        }

        if (game.player.rep < job.reqRep) {
            showNotification('Reputazione insufficiente!', 1500);
            return;
        }

        // Create temporary NPC for manager
        const managerNpc = {
            id: 'manager_' + jobId,
            name: job.manager,
            job: 'Manager di ' + job.name,
            personality: job.managerPersonality,
            mood: 'professionale',
            location: 'Ufficio',
            relation: 50, // Neutral starting point for interview
            conversationStyle: getConversationStyle(job.managerPersonality),
            isInterviewing: true,
            interviewFor: job
        };

        // Store interview data
        game.currentInterview = {
            job: job,
            manager: managerNpc,
            started: true
        };

        // Add manager temporarily to NPCs list if not exists
        if (!game.npcs.find(n => n.id === managerNpc.id)) {
            game.npcs.push(managerNpc);
        }

        // Open dialogue with manager (NEW SYSTEM)
        showNotification(` Colloquio per ${job.name}`, 2000);
        setTimeout(() => {
            openDialogue(managerNpc.id);
        }, 500);
    }

    function applyJob(jobId) {
        // Redirect to interview system
        startJobInterview(jobId);
    }

    function updateWorkStatus() {
        const div = $('workStatusDiv');
        if (!div) return;

        if (game.player.job === 'Disoccupato') {
            div.innerHTML = '<p style="opacity:0.7;">Attualmente disoccupato. Cerca un lavoro e fai un colloquio!</p>';
        } else {
            const currentHour = game.time.hour;
            const jobData = game.workData.currentJob;
            const isWorkHours = jobData && currentHour >= jobData.hours.start && currentHour < jobData.hours.end;
            const canWork = isWorkHours && !game.workData.todayWorked;
            
            // Get career path info
            const careerPath = game.workData.careerPath;
            const careerLevel = game.workData.careerLevel || 0;
            let careerInfo = '';
            let nextLevelInfo = '';
            
            if (careerPath && CAREER_PATHS[careerPath]) {
                const career = CAREER_PATHS[careerPath];
                const currentLevel = career.levels[careerLevel];
                careerInfo = ` Percorso: ${career.name} | Livello ${careerLevel + 1}/${career.levels.length}`;
                
                if (careerLevel + 1 < career.levels.length) {
                    const nextLevel = career.levels[careerLevel + 1];
                    const skills = game.player.skills || {};
                    const reqs = nextLevel.requirements;
                    
                    // Check which requirements are met
                    const reqCheck = [];
                    if (reqs.intellect) reqCheck.push(`Int:${skills.intellect||0}/${reqs.intellect}${(skills.intellect||0)>=reqs.intellect?'':''}`);
                    if (reqs.charisma) reqCheck.push(`Car:${skills.charisma||0}/${reqs.charisma}${(skills.charisma||0)>=reqs.charisma?'':''}`);
                    if (reqs.creativity) reqCheck.push(`Cre:${skills.creativity||0}/${reqs.creativity}${(skills.creativity||0)>=reqs.creativity?'':''}`);
                    if (reqs.fitness) reqCheck.push(`Fit:${skills.fitness||0}/${reqs.fitness}${(skills.fitness||0)>=reqs.fitness?'':''}`);
                    if (reqs.performance) reqCheck.push(`Perf:${game.workData.performance}%/${reqs.performance}%${game.workData.performance>=reqs.performance?'':''}`);
                    if (reqs.managerRelation) reqCheck.push(`Mgr:${game.workData.managerRelation}/${reqs.managerRelation}${game.workData.managerRelation>=reqs.managerRelation?'':''}`);
                    
                    nextLevelInfo = `
                        <div style="margin-top:12px; padding:10px; background:rgba(102,126,234,0.1); border-radius:8px; border-left:3px solid var(--primary);">
                            <div style="font-weight:bold; font-size:0.95rem; margin-bottom:6px;"> Prossima Promozione: ${nextLevel.title} (${nextLevel.salary}/giorno)</div>
                            <div style="font-size:0.85rem; opacity:0.9;">
                                Requisiti: ${reqCheck.join(' | ')}
                            </div>
                            <div style="margin-top:6px;">
                                <div style="font-size:0.8rem; opacity:0.8;">Progresso Promozione</div>
                                <div class="stat-bar" style="margin-top:4px;">
                                    <div class="stat-fill ${(game.workData.promotionProgress||0) >= 75 ? 'high' : (game.workData.promotionProgress||0) >= 40 ? 'medium' : 'low'}" 
                                         style="width:${game.workData.promotionProgress||0}%">
                                        ${game.workData.promotionProgress||0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px; border-left:3px solid var(--success);">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:1.2rem;">${game.player.job}</div>
                            <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                                 Manager: ${jobData ? jobData.manager : 'N/A'}<br>
                                 Orario: ${jobData ? `${jobData.hours.start}:00 - ${jobData.hours.end}:00` : 'N/A'}<br>
                                 Giorni: ${(() => {
                                    const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                                    const workDays = game.workData.workDays || [1,2,3,4,5];
                                    return workDays.map(d => dayNames[d-1]).join(', ');
                                })()}<br>
                                 Stipendio: ${game.player.jobSalary}/giorno<br>
                                 Performance: <span style="color:${game.workData.performance>=80?'#38ef7d':game.workData.performance>=60?'#ffd700':'#eb3349'}">${game.workData.performance}%</span><br>
                                 Relazione Manager: <span style="color:${game.workData.managerRelation>=70?'#38ef7d':game.workData.managerRelation>=40?'#ffd700':'#eb3349'}">${game.workData.managerRelation}/100</span>
                                ${game.workData.warnings > 0 ? `<br> Avvertimenti: ${game.workData.warnings}/3` : ''}
                            </div>
                            ${careerInfo ? `<div style="font-size:0.85rem; opacity:0.9; margin-top:6px;">${careerInfo}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.85rem; opacity:0.8;">Giorni Lavorati</div>
                            <div style="font-weight:bold; font-size:1.5rem; color:var(--primary);">${game.workData.daysWorked || 0}</div>
                        </div>
                    </div>
                    
                    ${nextLevelInfo}

                    ${!isWorkHours ? `
                        <div style="padding:10px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:10px; text-align:center;">
                             Fuori orario lavorativo (${jobData.hours.start}:00-${jobData.hours.end}:00)
                        </div>
                    ` : ''}

                    ${game.workData.todayWorked ? `
                        <div style="padding:10px; background:rgba(56,239,125,0.15); border-radius:8px; margin-bottom:10px; text-align:center;">
                             Hai gi lavorato oggi
                        </div>
                    ` : ''}

                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="doWorkDay()" ${!canWork ? 'disabled' : ''} style="flex:1; min-width:150px;">
                             ${canWork ? 'Inizia Lavoro' : 'Non disponibile'}
                        </button>
                        ${jobData ? `<button class="small" onclick="talkToManager()" style="flex:1; min-width:120px;"> Parla con Manager</button>` : ''}
                        ${checkPromotionEligibility() && (game.workData.promotionProgress || 0) >= 100 ? `
                            <button class="small" onclick="attemptPromotion()" style="flex:1; min-width:140px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                 Richiedi Promozione
                            </button>
                        ` : ''}
                    </div>

                    ${game.workData.workEvents.length > 0 ? `
                        <div style="margin-top:12px;">
                            <h5 style="margin-bottom:6px;"> Eventi Recenti</h5>
                            ${game.workData.workEvents.slice(-3).map(e => `
                                <div style="font-size:0.85rem; opacity:0.8; padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px;">
                                    ${e}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    }

    // ---------- PEOPLE & SOCIAL ----------
    function renderKnownPeople() {
        const list = $('knownPeopleList');
        if (!list) return;

        // Filtra solo NPCs conosciuti (known = true)
        const knownNpcs = game.npcs.filter(npc => npc.known === true);

        if (knownNpcs.length === 0) {
            list.innerHTML = `
                <div style="padding:20px; text-align:center; opacity:0.7;">
                    <div style="font-size:2rem; margin-bottom:8px;"></div>
                    <div>Non conosci ancora nessuno.</div>
                    <div style="font-size:0.85rem; margin-top:8px;">Esci in citt, frequenta i luoghi e incontra persone!</div>
                </div>
            `;
            return;
        }

        list.innerHTML = knownNpcs.map(npc => `
            <div class="npc-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;"> ${npc.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">${npc.job} | Relazione: ${npc.relation}/100</div>
                        ${npc.location ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:2px;"> ${npc.location}</div>` : ''}
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button class="small" onclick="openDialogue('${npc.id}')"> Parla</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function talkTo(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;

        npc.relation = clamp(npc.relation + randInt(3, 8));
        game.player.stats.morale = clamp(game.player.stats.morale + 5);
        
        passTime(1);
        showNotification(`Hai parlato con ${npc.name}. Relazione: ${npc.relation}/100`, 1800);
        updateUI();
        checkQuests();
    }

    // ---------- ACTIONS ----------
    function getActionDetails(actionName) {
        const act = ACTIONS[actionName];
        if (!act) return '';

        let details = `<div style="font-size:0.9rem;">`;
        details += ` Costo: ${act.cost || 0}<br>`;
        details += ` Tempo: ${act.time}h<br>`;
        
        if (act.effects) {
            details += `<br><strong>Effetti:</strong><br>`;
            Object.keys(act.effects).forEach(stat => {
                const value = act.effects[stat];
                const icon = {hunger: '', energy: '', morale: '', health: ''}[stat] || '';
                details += `${icon} ${stat}: ${value > 0 ? '+' : ''}${value}%<br>`;
            });
        }

        if (act.skills) {
            details += `<br><strong>Skills:</strong><br>`;
            Object.keys(act.skills).forEach(skill => {
                const value = act.skills[skill];
                details += ` ${skill}: +${value}<br>`;
            });
        }

        details += `</div>`;
        return details;
    }

    function action(actionName) {
        const act = ACTIONS[actionName];
        if (!act) {
            showNotification('Azione non disponibile', 1200);
            return;
        }

        // Block home actions if homeless
        const homeActions = ['shower', 'sleep', 'nap', 'clean', 'cook'];
        if (homeActions.includes(actionName) && game.player.isHomeless) {
            showNotification(' Sei senzatetto! Non puoi fare questa azione. Trova una casa!', 3000);
            return;
        }

        // Special handling for food-based actions
        if (actionName === 'eat') {
            if (game.inventory.food.length === 0) {
                showNotification(' Non hai cibo! Vai al supermercato.', 2000);
                return;
            }
            // Open food inventory to choose what to eat
            switchMainTab('shop');
            showNotification('Scegli cosa mangiare dal tuo inventario', 1500);
            return;
        }

        if (actionName === 'cook') {
            cookFood();
            return;
        }

        if (act.cost > 0 && !canAfford(act.cost)) {
            showNotification(' Non hai abbastanza soldi!', 1500);
            return;
        }
        
        // Check energy for skill-based activities
        if (act.skills && Object.keys(act.skills).length > 0) {
            const energy = game.player.stats.energy;
            
            // Reset daily training counter if new day
            if (game.player.lastTrainingDay !== game.time.day) {
                game.player.dailyTraining = 0;
                game.player.lastTrainingDay = game.time.day;
            }
            
            // Limit training activities per day (max 3)
            if (game.player.dailyTraining >= 3) {
                showNotification(' Hai gi fatto 3 attivit di apprendimento oggi! Il corpo e la mente hanno bisogno di riposo.', 3000);
                return;
            }
            
            if (energy < 20) {
                showNotification(' Sei troppo stanco! Riposa prima di studiare/allenarti. Rischi risultati negativi!', 3000);
                return;
            } else if (energy < 40) {
                if (!confirm(' Hai poca energia. L\'apprendimento sar molto ridotto. Continuare comunque?')) {
                    return;
                }
            } else if (energy < 60) {
                showNotification(' Energia media: l\'apprendimento sar ridotto del 40%', 2000);
            }
            
            // Increment daily training counter
            game.player.dailyTraining++;
        }

        // Apply effects
        if (act.cost > 0 && !payMoney(act.cost)) {
            showNotification(' Fondi insufficienti!', 2000);
            return;
        }
        
        if (act.effects) {
            Object.keys(act.effects).forEach(stat => {
                if (game.player.stats[stat] !== undefined) {
                    game.player.stats[stat] = clamp(game.player.stats[stat] + act.effects[stat]);
                }
            });
        }

        if (act.skills) {
            const skillGains = [];
            Object.keys(act.skills).forEach(skill => {
                const oldValue = game.player.skills[skill] || 0;
                
                // Cap at 100
                if (oldValue >= 100) {
                    const skillName = skill.charAt(0).toUpperCase() + skill.slice(1);
                    skillGains.push(` ${skillName} gi al massimo (100)`);
                    return;
                }
                
                let gain = act.skills[skill];
                
                // Apply fatigue penalty based on daily training count
                const fatigueMultiplier = [1.0, 0.8, 0.5][game.player.dailyTraining - 1] || 0.5;
                gain = Math.floor(gain * fatigueMultiplier);
                
                if (game.player.dailyTraining > 1) {
                    const fatigueMessages = {
                        2: '(fatica leggera)',
                        3: '(fatica elevata)'
                    };
                    if (fatigueMultiplier < 1.0) {
                        skillGains.push(` ${fatigueMessages[game.player.dailyTraining] || ''}`);
                    }
                }
                
                // Reduce gain based on energy - low energy = reduced learning
                const energyFactor = game.player.stats.energy / 100;
                if (energyFactor < 0.3) {
                    // Very low energy: negative effect!
                    gain = Math.floor(gain * -0.5);
                    skillGains.push(` Troppo stanco! Prestazione negativa`);
                } else if (energyFactor < 0.5) {
                    // Low energy: much reduced gain
                    gain = Math.floor(gain * 0.3);
                } else if (energyFactor < 0.7) {
                    // Medium energy: reduced gain
                    gain = Math.floor(gain * 0.6);
                }
                
                const newValue = Math.min(100, oldValue + gain);
                game.player.skills[skill] = Math.round(newValue * 100) / 100; // Round to 2 decimals
                
                // Check for level up
                const oldLevel = getSkillLevel(oldValue);
                const newLevel = getSkillLevel(newValue);
                
                // Create skill gain notification
                const skillEmojis = {
                    intellect: '',
                    fitness: '',
                    creativity: '',
                    charisma: ''
                };
                const emoji = skillEmojis[skill] || '';
                const skillName = skill.charAt(0).toUpperCase() + skill.slice(1);
                
                if (oldLevel !== newLevel) {
                    // Level up! Show special notification
                    skillGains.push(`${emoji} ${skillName}: ${newLevel}! `);
                } else if (gain > 0) {
                    skillGains.push(`${emoji} +${gain} ${skillName}`);
                } else if (gain < 0) {
                    skillGains.push(`${emoji} ${gain} ${skillName} (stanchezza)`);
                }
            });
            
            // Show skill gains in notification after main message
            if (skillGains.length > 0) {
                setTimeout(() => {
                    showNotification(skillGains.join(' | '), 2500);
                }, 1600);
            }
        }

        // Special actions
        if (actionName === 'work' && game.player.job !== 'Disoccupato') {
            const salary = game.player.jobSalary || 50;
            earnMoney(salary); // Salary goes to cash
            game.player.totalEarned = (game.player.totalEarned || 0) + salary;
            game.player.rep = clamp(game.player.rep + 2, 0, 100);
            showNotification(`${act.msg} Hai guadagnato ${salary}!`, 2000);
        } else if (actionName === 'meet_new') {
            triggerRandomEncounter();
        } else {
            // Determine if action requires travel
            let destinationQuarterId = ACTION_LOCATIONS[actionName];

            if (destinationQuarterId === 'home') {
                destinationQuarterId = game.housing.neighborhood;
            } else if (destinationQuarterId === 'job_location' && game.workData.currentJob) {
                destinationQuarterId = game.workData.currentJob.location;
            } else if (destinationQuarterId === 'current') {
                destinationQuarterId = game.cityMap.currentLocation;
            }

            if (destinationQuarterId && destinationQuarterId !== game.cityMap.currentLocation) {
                const travelInfo = calculateTravelTime(destinationQuarterId);
                if (travelInfo.time > 0) {
                    // Check if player has enough money and energy
                    if (game.player.money < travelInfo.cost) {
                        showNotification(` Non hai abbastanza soldi per il viaggio! Serve: ${travelInfo.cost}`, 2500);
                        return;
                    }
                    
                    if (game.player.stats.energy < travelInfo.energy) {
                        showNotification(` Non hai abbastanza energia per il viaggio! Serve: ${travelInfo.energy}%`, 2500);
                        return;
                    }
                    
                    // Apply travel costs
                    if (travelInfo.cost > 0 && !payMoney(travelInfo.cost)) {
                        showNotification(' Non hai abbastanza soldi per viaggiare!', 2000);
                        return;
                    }
                    game.player.stats.energy = clamp(game.player.stats.energy - travelInfo.energy);
                    
                    const vehicleUsed = game.vehicles.active || 'walk';
                    const vehicleEmoji = VEHICLES[vehicleUsed] ? VEHICLES[vehicleUsed].emoji : '';
                    
                    showNotification(`${vehicleEmoji} Viaggio verso ${NEIGHBORHOODS[destinationQuarterId].name}... (${travelInfo.time}h, ${travelInfo.cost})`, 2500);
                    passTime(travelInfo.time);
                    game.cityMap.currentLocation = destinationQuarterId; // Update player's current location
                }
            }
            
            // Update current building
            if (ACTION_BUILDINGS[actionName]) {
                game.cityMap.currentBuilding = ACTION_BUILDINGS[actionName];
            }

            // Handle special actions
            if (act.special) {
                // Execute the special function
                if (window[act.special] && typeof window[act.special] === 'function') {
                    window[act.special]();
                } else {
                    console.error('Special function not found:', act.special);
                    showNotification(act.msg, 1500);
                }
            } else {
                showNotification(act.msg, 1500);
            }
        }

        passTime(act.time);
        
        // Random encounter chance on city actions (excluding 'home' actions)
        const cityActions = Object.keys(ACTIONS).filter(a => ACTIONS[a].category !== 'casa');
        if (cityActions.includes(actionName)) {
            triggerRandomEncounter();
        }
        updateUI();
        checkRandomEvent();
        checkQuests();
    }

    // ---------- ELECTRONICS STORE ----------
    function showElectronicsStore() {
        const devices = [
            {
                id: 'phone',
                name: ' Cellulare',
                price: 150,
                description: 'Permette di chiamare gli NPC anche quando non sono nella tua posizione. Necessario per cercare lavoro online.',
                owned: game.inventory.devices.phone
            },
            {
                id: 'computer',
                name: ' Computer',
                price: 800,
                description: 'Permette chat online e ricerca lavoro avanzata. Migliora le possibilit di carriera.',
                owned: game.inventory.devices.computer
            }
        ];
        
        let dialogHTML = `
            <h3> Negozio Elettronica</h3>
            <p style="margin-bottom: 15px; color: #666;">Acquista dispositivi per migliorare la tua vita sociale e professionale</p>
            <div style="display: flex; flex-direction: column; gap: 15px;">
        `;
        
        devices.forEach(device => {
            const canAfford = game.player.cash >= device.price;
            const buttonText = device.owned ? ' Gi Posseduto' : ` ${device.price}`;
            const buttonStyle = device.owned ? 'background: #28a745; opacity: 0.6;' : 
                              canAfford ? 'background: var(--primary); cursor: pointer;' : 
                              'background: #6c757d; cursor: not-allowed;';
            
            dialogHTML += `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #333;">${device.name}</h4>
                        <button onclick="${device.owned ? '' : `buyDevice('${device.id}', ${device.price})`}" 
                                style="padding: 8px 15px; border: none; border-radius: 5px; color: white; ${buttonStyle}"
                                ${device.owned || !canAfford ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">${device.description}</p>
                    ${!canAfford && !device.owned ? '<p style="color: #dc3545; font-size: 0.8rem; margin: 5px 0 0 0;"> Fondi insufficienti</p>' : ''}
                </div>
            `;
        });
        
        dialogHTML += `</div>`;
        
        showDialog(dialogHTML, 'Negozio Elettronica');
    }
    
    // Buy device function
    function buyDevice(deviceId, price) {
        if (!canAfford(price)) {
            showNotification(' Non hai abbastanza soldi!', 2000);
            return;
        }
        
        if (game.inventory.devices[deviceId]) {
            showNotification(' Hai gi questo dispositivo!', 2000);
            return;
        }
        
        // Purchase device
        payMoney(price);
        game.inventory.devices[deviceId] = true;
        
        const deviceNames = {
            phone: 'cellulare',
            computer: 'computer'
        };
        
        const deviceName = deviceNames[deviceId] || deviceId;
        addLog(` Hai acquistato un ${deviceName}! Ora puoi comunicare con gli NPC anche a distanza.`);
        
        // Close dialog and show success
        closeDialog();
        showNotification(` ${deviceName.charAt(0).toUpperCase() + deviceName.slice(1)} acquistato!`, 3000);
        
        // Update UI
        updateUI();
    }

    // ---------- TRAVEL SYSTEM ----------
    function calculateTravelTime(destinationQuarterId, transportMethod = null) {
        const currentQuarterId = game.cityMap.currentLocation;
        if (currentQuarterId === destinationQuarterId) {
            return { time: 0, cost: 0, energy: 0 }; // Already at destination
        }

        const currentQuarter = NEIGHBORHOODS[currentQuarterId];
        const destinationQuarter = NEIGHBORHOODS[destinationQuarterId];

        if (!currentQuarter || !destinationQuarter) {
            console.error('Quartiere non trovato per il calcolo del tempo di viaggio.');
            return { time: 0, cost: 0, energy: 0 };
        }

        // Base travel time (walking)
        let baseTime = currentQuarter.travelTime + destinationQuarter.travelTime;
        let travelTime = baseTime;
        let travelCost = 0;
        let energyCost = baseTime * 3; // Walking is tiring
        
        // Determine transport method
        if (!transportMethod) {
            transportMethod = game.vehicles.active || 'walk';
        }
        
        if (transportMethod === 'walk') {
            // Already calculated above
            travelCost = 0;
        } else if (transportMethod === 'public') {
            // Public transport
            const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
            travelTime = baseTime * 0.5; // 50% faster than walking
            travelCost = hasPass ? 0 : Math.max(2, Math.floor(baseTime * 2));
            energyCost = baseTime * 0.5; // Less tiring
        } else if (VEHICLES[transportMethod]) {
            // Personal vehicle
            const vehicle = VEHICLES[transportMethod];
            travelTime = baseTime * vehicle.speedMultiplier;
            energyCost = travelTime * vehicle.energyCost;
            travelCost = vehicle.fuelCost ? travelTime * vehicle.fuelCost : 0;
        }
        
        return { 
            time: Math.ceil(travelTime), 
            cost: Math.ceil(travelCost), 
            energy: Math.ceil(energyCost) 
        };
    }

    // ---------- TIME ----------
    // Nuova funzione: aggiungi minuti al tempo di gioco
    function addMinutes(minutes) {
        console.log(' addMinutes called with', minutes, 'minutes');
        
        // Use same pause check logic as game loop
        const isPaused = window._timePaused !== undefined ? window._timePaused : 
                        (window.game && window.game.timeControl && window.game.timeControl.isPaused);
        
        if (isPaused) {
            console.log(' addMinutes() called while PAUSED! Ignoring.');
            return;
        }
        
        console.log(' Adding', minutes, 'minutes to game time');
        
        game.time.minute += minutes;
        while (game.time.minute >= 60) {
            game.time.minute -= 60;
            game.time.hour += 1;
        }
        while (game.time.hour >= 24) {
            game.time.hour -= 24;
            game.time.day++;
            dailyEffects();
        }
        
        console.log(' New time:', game.time.hour + ':' + String(game.time.minute).padStart(2, '0'));
        
        // Decadimento naturale ogni ora piena simulata
        // Approssimazione: decadimento per frazioni di ora
        const fractionalHours = minutes / 60;
        game.player.stats.hunger = clamp(game.player.stats.hunger - fractionalHours * 2);
        game.player.stats.energy = clamp(game.player.stats.energy - fractionalHours * 1);
        
        // Degrado relazioni sociali se non vengono mantenute
        updateRelationshipDecay(fractionalHours);
        
        // Update NPC locations based on time change
        updateNpcLocations();
    }

    // Sistema degrado relazioni sociali
    function updateRelationshipDecay(fractionalHours) {
        if (!game.npcs || !Array.isArray(game.npcs)) return;
        
        // Initialize last contact tracking if not exists
        if (!game.relationshipTracker) {
            game.relationshipTracker = {
                lastContactDay: {},
                moraleWarning: false
            };
        }
        
        const currentDay = game.time.day;
        let totalRelationshipLoss = 0;
        
        game.npcs.forEach(npc => {
            if (!npc.known || !npc.relation) return;
            
            // Track last contact
            if (!game.relationshipTracker.lastContactDay[npc.id]) {
                game.relationshipTracker.lastContactDay[npc.id] = currentDay;
                return; // First time, no decay
            }
            
            const daysSinceContact = currentDay - game.relationshipTracker.lastContactDay[npc.id];
            
            // Decay starts after 3 days without contact
            if (daysSinceContact >= 3) {
                const decayRate = 0.5 * fractionalHours; // Lose 0.5 relation per hour after 3 days
                const previousRelation = npc.relation;
                
                npc.relation = Math.max(0, npc.relation - decayRate);
                
                const relationshipLoss = previousRelation - npc.relation;
                totalRelationshipLoss += relationshipLoss;
                
                // Log significant relationship drops
                if (relationshipLoss >= 2) {
                    addLog(`La tua relazione con ${npc.name} sta peggiorando per mancanza di contatto (-${Math.round(relationshipLoss)})`);
                }
            }
        });
        
        // Impact on morale based on total relationship loss
        if (totalRelationshipLoss > 0) {
            const moraleImpact = Math.min(totalRelationshipLoss * 0.1, 2); // Max 2 morale loss per hour
            game.player.stats.morale = clamp(game.player.stats.morale - moraleImpact);
            
            // Warning if morale drops significantly due to loneliness
            if (game.player.stats.morale < 30 && !game.relationshipTracker.moraleWarning) {
                addLog('Ti senti solo. Dovresti contattare qualcuno per migliorare il tuo umore.');
                game.relationshipTracker.moraleWarning = true;
            }
            
            // Reset warning when morale improves
            if (game.player.stats.morale > 50) {
                game.relationshipTracker.moraleWarning = false;
            }
        }
    }
    
    // Update last contact when talking to NPCs
    function updateLastContact(npcId) {
        if (!game.relationshipTracker) {
            game.relationshipTracker = {
                lastContactDay: {},
                moraleWarning: false
            };
        }
        
        game.relationshipTracker.lastContactDay[npcId] = game.time.day;
        console.log(`Updated last contact for ${npcId} to day ${game.time.day}`);
    }

    // Mantiene compatibilit con vecchie chiamate che usano ore (pu essere frazione)
    function passTime(hours) {
        const totalMinutes = Math.round(hours * 60);
        addMinutes(totalMinutes);
    }

    function dailyEffects() {
        // Check rent and tax payments
        checkRentPayment();
        checkTaxPayment();
        
        // Reset daily work
        resetDailyWork();
        
        // Reset weekly work counter on Monday (day % 7 === 1)
        if ((game.time.day - 1) % 7 === 0) {
            game.player.workDaysThisWeek = 0;
            showNotification(' Nuova settimana lavorativa!', 2000);
        }
        
        // Homeless penalties OR Housing bonuses
        if (game.player.isHomeless || !game.housing.residenceId) {
            game.player.stats.morale = clamp(game.player.stats.morale - 30);
            game.player.stats.health = clamp(game.player.stats.health - 20);
            game.player.stats.energy = clamp(game.player.stats.energy - 15);
            
            // Hygiene penalty (if exists)
            if (game.player.stats.hygiene !== undefined) {
                game.player.stats.hygiene = clamp(game.player.stats.hygiene - 10);
            }
            
            showNotification(' Vita da senzatetto: -30 Morale, -20 Salute, -15 Energia', 3000);
            
            // Higher risk of getting fired
            if (game.player.job !== 'Disoccupato' && Math.random() < 0.15) {
                showNotification(' Il tuo datore di lavoro ha notato il tuo stato...', 3000);
                game.workData.managerRelation = clamp((game.workData.managerRelation || 50) - 20);
                game.workData.performance = clamp((game.workData.performance || 50) - 15);
            }
        } else if (game.housing.residenceId) {
            // Apply housing bonuses
            const residence = findResidenceById(game.housing.residenceId);
            if (residence && residence.bonuses) {
                const bonuses = residence.bonuses;
                if (bonuses.energy > 0) game.player.stats.energy = clamp(game.player.stats.energy + bonuses.energy);
                if (bonuses.morale > 0) game.player.stats.morale = clamp(game.player.stats.morale + bonuses.morale);
                if (bonuses.hygiene > 0 && game.player.stats.hygiene !== undefined) {
                    game.player.stats.hygiene = clamp(game.player.stats.hygiene + bonuses.hygiene);
                }
                if (bonuses.health > 0) game.player.stats.health = clamp(game.player.stats.health + bonuses.health);
                if (bonuses.stressReduction > 0) {
                    game.player.stats.stress = Math.max(0, (game.player.stats.stress || 0) - bonuses.stressReduction);
                }
                
                // Show notification for significant bonuses
                if (bonuses.energy >= 10 || bonuses.morale >= 8) {
                    showNotification(` La tua casa ti d energia! +${bonuses.energy} , +${bonuses.morale} `, 2000);
                }
            }
        }
        
        // Check for work absence penalties
        if (game.player.job !== 'Disoccupato' && !isWeekend(game.time.day)) {
            if (!game.workData.todayWorked && game.player.lastWorkDay !== game.time.day) {
                game.player.absences = (game.player.absences || 0) + 1;
                game.workData.managerRelation = clamp((game.workData.managerRelation || 50) - 15);
                game.workData.performance = clamp((game.workData.performance || 50) - 10);
                game.player.rep = Math.max(0, game.player.rep - 5);
                
                showNotification(` Assenza ingiustificata! Penalit: -15 rapporto manager, -10 performance, -5 reputazione`, 4000);
                
                // Fire after 3 consecutive absences
                if (game.player.absences >= 3) {
                    showNotification(' SEI STATO LICENZIATO per troppe assenze!', 5000);
                    game.player.job = 'Disoccupato';
                    game.player.jobSalary = 0;
                    game.player.absences = 0;
                    game.workData = {
                        currentJob: null,
                        todayWorked: false,
                        tasksCompleted: 0,
                        performance: 50,
                        manager: null,
                        workEvents: [],
                        careerPath: null,
                        careerLevel: 0,
                        daysWorked: 0,
                        managerRelation: 50,
                        warnings: 0,
                        promotionProgress: 0,
                        lastPerformanceReview: 0
                    };
                }
            } else if (game.workData.todayWorked) {
                // Reset absence counter if went to work
                game.player.absences = 0;
            }
        }
        
        // Daily crime events based on neighborhood safety
        checkDailyCrimeEvent();
        
        // Monthly savings interest (every 30 days)
        if (game.time.day % 30 === 0) {
            applySavingsInterest();
        }

        // Monthly property income (every 30 days)
        if (game.time.day % 30 === 0) {
            collectPropertyIncome();
            collectBusinessIncome();
        }
        
        // Monthly vehicle maintenance (every 30 days)
        if (game.time.day % 30 === 0) {
            payVehicleMaintenance();
        }

        // Update company performance and stock prices daily
        updateCompanyPerformance();
        updateStockPrices();

        // Reduce wanted level slowly over time
        if (game.crime.wanted > 0 && Math.random() < 0.1) {
            game.crime.wanted = Math.max(0, game.crime.wanted - 0.5);
        }
        
        // Daily hunger decay if no housing quality bonus
        if (game.housing) {
            const hood = NEIGHBORHOODS[game.housing.neighborhood];
            const qualityBonus = Math.floor(hood.quality / 20);
            game.player.stats.morale = clamp(game.player.stats.morale + qualityBonus - 2);
        }
        
        // Check critical health status and debt
        checkCriticalStatus();
        
        // Monthly loan payments
        if (game.time.day % 30 === 0) {
            processLoanPayments();
        }
        
        checkRandomEvent();
    }

    function passHour() {
        passTime(1);
        showNotification(' Passata 1 ora', 1000);
        updateUI();
    }

    function passDay() {
        passTime(24 - game.time.hour + 8); // Skip to 8 AM next day
        showNotification(' Nuovo giorno!', 1200);
        updateUI();
    }

    // ========================================
    // TIME CONTROL SYSTEM
    // ========================================
    
    // Separate Play and Pause functions for better control
    window.playTime = function() {
        console.log(' PLAY TIME CALLED!');
        
        if (!window.game.timeControl) {
            window.game.timeControl = { isPaused: false, speed: 1, lastTick: Date.now() };
        }
        
        window.game.timeControl.isPaused = false;
        window._timePaused = false;
        
        console.log(' Set isPaused to:', window.game.timeControl.isPaused);
        console.log(' Set backup _timePaused to:', window._timePaused);
        
        updateTimeButtons();
        showNotification(' Tempo in movimento', 1200);
        console.log(' Time is now RUNNING - should advance next tick');
    }
    
    window.pauseTime = function() {
        console.log(' PAUSE TIME CALLED!');
        
        if (!window.game.timeControl) {
            window.game.timeControl = { isPaused: true, speed: 1, lastTick: Date.now() };
        }
        
        window.game.timeControl.isPaused = true;
        window._timePaused = true;
        
        updateTimeButtons();
        showNotification(' Tempo in pausa', 1200);
        console.log(' Time is now PAUSED');
    }
    
    function updateTimeButtons() {
        const isPaused = window._timePaused !== undefined ? window._timePaused : window.game.timeControl.isPaused;
        
        const playBtn = $('timePlayBtn');
        const pauseBtn = $('timePauseBtn');
        
        if (playBtn && pauseBtn) {
            if (isPaused) {
                playBtn.style.opacity = '1';
                playBtn.style.cursor = 'pointer';
                pauseBtn.style.opacity = '0.5';
                pauseBtn.style.cursor = 'default';
            } else {
                playBtn.style.opacity = '0.5';
                playBtn.style.cursor = 'default';
                pauseBtn.style.opacity = '1';
                pauseBtn.style.cursor = 'pointer';
            }
        }
    }
    
    function cycleTimeSpeed() {
        if (!window.game.timeControl) {
            window.game.timeControl = { isPaused: true, speed: 1, lastTick: Date.now() };
        }
        
        const speeds = [1, 2, 5, 10];
        const currentIndex = speeds.indexOf(window.game.timeControl.speed);
        const nextIndex = (currentIndex + 1) % speeds.length;
        window.game.timeControl.speed = speeds[nextIndex];
        
        const btn = $('timeSpeedBtn');
        if (btn) {
            btn.innerHTML = ` ${window.game.timeControl.speed}x`;
        }
        
        showNotification(` Velocit: ${window.game.timeControl.speed}x`, 1200);
    }
    
    // Game loop - avanza tempo automaticamente
    let gameLoopInterval = null;
    
    function startGameLoop() {
        if (gameLoopInterval) {
            console.log(' Game loop already running, ID:', gameLoopInterval);
            return; // Gi in esecuzione
        }
        
        console.log(' Starting game loop...');
        
        gameLoopInterval = setInterval(() => {
            console.log(' Game loop tick at', new Date().toLocaleTimeString());
            
            if (!window.game) {
                console.log(' window.game missing!');
                return;
            }
            
            if (!window.game.timeControl) {
                console.log(' window.game.timeControl missing!');
                return;
            }
            
            // Use backup flag if available, otherwise use main flag
            const backupPaused = window._timePaused;
            const mainPaused = window.game.timeControl.isPaused;
            const isPaused = backupPaused !== undefined ? backupPaused : mainPaused;
            
            console.log(' Pause check:');
            console.log('  - backup (_timePaused):', backupPaused);
            console.log('  - main (timeControl.isPaused):', mainPaused);
            console.log('  - final decision (isPaused):', isPaused);
            
            // Update button display every tick
            updateTimeButtons();
            
            if (isPaused) {
                console.log(' Game is PAUSED - skipping time advancement');
                return; // Skip time advancement
            }

            console.log(' Game is RUNNING - about to call addMinutes with', window.game.timeControl.speed, 'minutes');
            
            // Avanza minuto per minuto in base alla velocit
            // Speed 1x = 1 min/sec, 2x = 2 min/sec, ecc.
            addMinutes(window.game.timeControl.speed);
            checkAppointmentReminders();
            updateUI();
            
            console.log(' Game loop tick completed');
        }, 1000); // Tick ogni secondo reale
        
        console.log(' Game loop started with ID:', gameLoopInterval);
    }
    
    function stopGameLoop() {
        if (gameLoopInterval) {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
        }
    }

    // ========================================
    // AGENDA SYSTEM
    // ========================================
    
    function showAddAppointmentDialog() {
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        
        const html = `
            <div style="padding:24px; max-width:500px;">
                <h3 style="margin-bottom:16px;"> Nuovo Appuntamento</h3>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Giorno</label>
                    <input type="number" id="apptDay" min="${currentDay}" value="${currentDay}" 
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
                
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:12px;">
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Ora (0-23)</label>
                        <input type="number" id="apptHour" min="0" max="23" value="${Math.min(currentHour + 1, 23)}" 
                               style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Minuti</label>
                        <input type="number" id="apptMinute" min="0" max="59" value="0" 
                               style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    </div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Tipo</label>
                    <select id="apptType" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                        <option value="work"> Lavoro</option>
                        <option value="social"> Sociale</option>
                        <option value="personal"> Personale</option>
                        <option value="health"> Salute</option>
                        <option value="other"> Altro</option>
                    </select>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Titolo</label>
                    <input type="text" id="apptTitle" placeholder="Es: Riunione, Cena con amici..." 
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Descrizione (opzionale)</label>
                    <textarea id="apptDescription" rows="2" placeholder="Dettagli aggiuntivi..."
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white; resize:vertical;"></textarea>
                </div>
                
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:12px;">
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Luogo (opzionale)</label>
                        <select id="apptLocation" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                            <option value="">-- Nessuno --</option>
                            <option value="periferia"> Periferia</option>
                            <option value="quartiere_operaio"> Q. Operaio</option>
                            <option value="zona_residenziale"> Residenziale</option>
                            <option value="centro_storico"> Centro Storico</option>
                            <option value="quartiere_lusso"> Luxury</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Durata (h)</label>
                        <input type="number" id="apptDuration" min="0.25" max="12" step="0.25" value="1" 
                               style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    </div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;"> Mezzo di Trasporto</label>
                    <select id="apptTransport" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                        <option value="walk"> A piedi</option>
                        <option value="bike"> Bicicletta</option>
                        <option value="bus"> Autobus</option>
                        <option value="car"> Auto propria</option>
                        <option value="taxi"> Taxi</option>
                        <option value="uber"> Uber</option>
                    </select>
                </div>
                
                <div style="margin-bottom:16px; padding:10px; background:rgba(102,126,234,0.1); border-radius:6px; border-left:3px solid var(--primary);">
                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="checkbox" id="apptRecurring" style="margin-right:8px; width:18px; height:18px;">
                        <span style="font-size:0.9rem;"> Replica nei giorni lavorativi (Lun-Ven)</span>
                    </label>
                    <div id="recurringInfo" style="font-size:0.8rem; opacity:0.7; margin-top:4px; display:none;">
                        Creer questo appuntamento per tutti i giorni lavorativi della prossima settimana
                    </div>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:20px;">
                    <button onclick="createAppointment()" style="flex:1; padding:10px; background:var(--success); border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">
                         Crea Appuntamento
                    </button>
                    <button onclick="closeDialog()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; color:white; cursor:pointer;">
                         Annulla
                    </button>
                </div>
            </div>
        `;
        
        showDialog(html);
        
        // Aggiungi event listener per il checkbox dopo che il dialog  stato creato
        setTimeout(() => {
            const checkbox = document.getElementById('apptRecurring');
            const info = document.getElementById('recurringInfo');
            if (checkbox && info) {
                checkbox.addEventListener('change', function() {
                    info.style.display = this.checked ? 'block' : 'none';
                });
            }
        }, 100);
    }
    
    function createAppointment() {
        const day = parseInt($('apptDay').value);
        const hour = parseInt($('apptHour').value);
        const minute = parseInt($('apptMinute').value) || 0;
        const type = $('apptType').value;
        const title = $('apptTitle').value.trim();
        const description = $('apptDescription').value.trim();
        const location = $('apptLocation').value;
        const duration = parseFloat($('apptDuration').value) || 1;
        const transport = $('apptTransport').value;
        const recurring = $('apptRecurring').checked;
        
        if (!title) {
            showNotification(' Inserisci un titolo per l\'appuntamento!', 2000);
            return;
        }
        
        // Check if appointment is in the past
        const isPast = day < game.time.day || 
                      (day === game.time.day && hour < game.time.hour) ||
                      (day === game.time.day && hour === game.time.hour && minute < game.time.minute);
        
        if (isPast) {
            showNotification(' Non puoi creare un appuntamento nel passato!', 2000);
            return;
        }
        
        const transportIcons = {
            walk: '',
            bike: '',
            bus: '',
            car: '',
            taxi: '',
            uber: ''
        };
        
        // Crea appuntamento base
        const createAppt = (targetDay) => ({
            id: Date.now() + Math.random(),
            day: targetDay,
            hour: hour,
            minute: minute,
            type: type,
            title: title,
            description: description,
            location: location,
            duration: duration,
            transport: transport,
            transportIcon: transportIcons[transport] || '',
            notified: false,
            created: game.time.day,
            recurring: recurring
        });
        
        if (recurring) {
            // Crea appuntamenti per i prossimi giorni lavorativi (Lun-Ven)
            let created = 0;
            for (let i = 0; i < 14; i++) { // Prossime 2 settimane
                const targetDay = day + i;
                const dayOfWeek = ((targetDay - 1) % 7) + 1; // 1-7 (Lun-Dom)
                
                // Solo giorni lavorativi (1-5 = Lun-Ven)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    game.agenda.appointments.push(createAppt(targetDay));
                    created++;
                }
            }
            showNotification(` Creati ${created} appuntamenti ricorrenti (Lun-Ven)`, 3000);
        } else {
            game.agenda.appointments.push(createAppt(day));
            const timeStr = formatTime(hour, minute);
            showNotification(` Appuntamento creato: ${title} (Giorno ${day} alle ${timeStr})`, 3000);
        }
        
        game.agenda.appointments.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            if (a.hour !== b.hour) return a.hour - b.hour;
            return (a.minute || 0) - (b.minute || 0);
        });
        
        closeDialog();
        updateUI();
    }
    
    function renderAgenda() {
        // Update current day/hour display
        if ($('agendaCurrentDay')) $('agendaCurrentDay').innerText = game.time.day;
        if ($('agendaCurrentHour')) $('agendaCurrentHour').innerText = (function(){
            const h = game.time.hour % 24;
            const m = game.time.minute || 0;
            const pad = n => (n<10? '0'+n : ''+n);
            return pad(h)+ ':' + pad(m);
        })();
        
        if (!game.agenda) {
            game.agenda = { appointments: [], reminders: [] };
        }
        
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        
        // Filtra appuntamenti futuri e passati
        const upcoming = game.agenda.appointments.filter(a => 
            a.day > currentDay || (a.day === currentDay && a.hour >= currentHour)
        );
        
        const past = game.agenda.appointments.filter(a => 
            a.day < currentDay || (a.day === currentDay && a.hour < currentHour)
        );
        
        // Render upcoming appointments
        const upcomingDiv = $('upcomingAppointments');
        if (upcomingDiv) {
            if (upcoming.length === 0) {
                upcomingDiv.innerHTML = `
                    <div style="padding:16px; text-align:center; opacity:0.6;">
                        <div> Nessun appuntamento in programma</div>
                    </div>
                `;
            } else {
                upcomingDiv.innerHTML = upcoming.map(appt => {
                    const typeIcons = {
                        work: '',
                        social: '',
                        personal: '',
                        health: '',
                        other: ''
                    };
                    const icon = typeIcons[appt.type] || '';
                    
                    const daysUntil = appt.day - currentDay;
                    const apptMinute = appt.minute || 0;
                    const timeStr = formatTime(appt.hour, apptMinute);
                    const timeInfo = daysUntil === 0 
                        ? `Oggi alle ${timeStr}` 
                        : `Tra ${daysUntil} giorni alle ${timeStr}`;
                    
                    // Info aggiuntive
                    const locationInfo = appt.location ? ` ${NEIGHBORHOODS[appt.location]?.name || appt.location}` : '';
                    const durationInfo = appt.duration ? ` ${appt.duration}h` : '';
                    const transportInfo = appt.transportIcon ? `${appt.transportIcon}` : '';
                    const extras = [locationInfo, durationInfo, transportInfo].filter(x => x).join('  ');
                    
                    return `
                        <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:8px; border-left:3px solid var(--primary); margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div style="flex:1;">
                                    <div style="font-weight:bold; margin-bottom:4px;">${icon} ${appt.title}</div>
                                    <div style="font-size:0.85rem; opacity:0.8;"> ${timeInfo}</div>
                                    ${extras ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:2px;">${extras}</div>` : ''}
                                    ${appt.description ? `<div style="font-size:0.85rem; opacity:0.7; margin-top:4px;">${appt.description}</div>` : ''}
                                </div>
                                <button class="small" onclick="deleteAppointment('${appt.id}')" style="background:rgba(255,0,0,0.3);">
                                    
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Render past appointments
        const pastDiv = $('pastAppointments');
        if (pastDiv) {
            if (past.length === 0) {
                pastDiv.innerHTML = `
                    <div style="padding:16px; text-align:center; opacity:0.6;">
                        <div> Nessun appuntamento passato</div>
                    </div>
                `;
            } else {
                pastDiv.innerHTML = past.slice(-10).reverse().map(appt => {
                    const typeIcons = {
                        work: '',
                        social: '',
                        personal: '',
                        health: '',
                        other: ''
                    };
                    const icon = typeIcons[appt.type] || '';
                    
                    const apptMinute = appt.minute || 0;
                    const timeStr = formatTime(appt.hour, apptMinute);
                    return `
                        <div style="padding:10px; background:rgba(255,255,255,0.03); border-radius:6px; border-left:2px solid rgba(255,255,255,0.2); margin-bottom:6px; opacity:0.7;">
                            <div style="font-size:0.9rem; font-weight:bold;">${icon} ${appt.title}</div>
                            <div style="font-size:0.8rem; opacity:0.8;"> Giorno ${appt.day} alle ${timeStr}</div>
                        </div>
                    `;
                }).join('');
            }
        }
    }
    
    function showTodaySchedule() {
        const currentDay = game.time.day;
        const todayAppts = game.agenda.appointments.filter(a => a.day === currentDay);
        
        if (todayAppts.length === 0) {
            showNotification(' Nessun appuntamento per oggi!', 2000);
            return;
        }
        
        const html = `
            <div style="padding:24px; max-width:500px;">
                <h3 style="margin-bottom:16px;"> Programma di Oggi (Giorno ${currentDay})</h3>
                
                <div style="max-height:400px; overflow-y:auto;">
                    ${todayAppts.map(appt => {
                        const typeIcons = {
                            work: '',
                            social: '',
                            personal: '',
                            health: '',
                            other: ''
                        };
                        const icon = typeIcons[appt.type] || '';
                        const apptMinute = appt.minute || 0;
                        const isPast = appt.hour < game.time.hour || (appt.hour === game.time.hour && apptMinute < game.time.minute);
                        const timeStr = formatTime(appt.hour, apptMinute);
                        
                        return `
                            <div style="padding:14px; background:${isPast ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.08)'}; 
                                        border-radius:8px; margin-bottom:10px; ${isPast ? 'opacity:0.5;' : ''}
                                        border-left:3px solid ${isPast ? 'gray' : 'var(--primary)'};">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div>
                                        <div style="font-size:1.4rem; margin-bottom:4px;">${timeStr}</div>
                                        <div style="font-weight:bold; margin-bottom:4px;">${icon} ${appt.title}</div>
                                        ${appt.description ? `<div style="font-size:0.85rem; opacity:0.8;">${appt.description}</div>` : ''}
                                        ${isPast ? '<div style="font-size:0.8rem; color:#999; margin-top:4px;"> Completato</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top:16px;">
                    <button onclick="closeModal()" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; color:white; cursor:pointer;">
                        Chiudi
                    </button>
                </div>
            </div>
        `;
        
        showModal(html);
    }
    
    function deleteAppointment(apptId) {
        game.agenda.appointments = game.agenda.appointments.filter(a => a.id !== apptId);
        showNotification(' Appuntamento eliminato', 1500);
        updateUI();
    }
    
    function showDailyTimeline() {
        renderDailyTimeline();
    }
    
    function renderDailyTimeline() {
        const timelineDiv = $('dailyTimelineView');
        if (!timelineDiv) return;
        
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        const currentMinute = game.time.minute || 0;
        
        // Ottieni appuntamenti di oggi
        const todayAppts = game.agenda?.appointments?.filter(a => a.day === currentDay) || [];
        
        // Calcola viaggi e crea eventi timeline
        const timelineEvents = [];
        
        // Evento: Sveglia/Casa mattina
        timelineEvents.push({
            type: 'home',
            start: 0,
            end: 8,
            title: ' Casa',
            description: 'A casa',
            color: 'rgba(100,200,255,0.3)'
        });
        
        let lastEventEnd = 8;
        let lastLocation = game.housing?.neighborhood || 'periferia';
        
        // Aggiungi appuntamenti ordinati
        todayAppts.sort((a, b) => {
            if (a.hour !== b.hour) return a.hour - b.hour;
            return (a.minute || 0) - (b.minute || 0);
        }).forEach(appt => {
            const apptStart = appt.hour + (appt.minute || 0) / 60;
            
            // Determina destinazione dall'appuntamento
            let destination = lastLocation;
            if (appt.location) {
                destination = appt.location;
            } else if (appt.type === 'work' && game.workData?.workLocation) {
                destination = game.workData.workLocation.neighborhood;
            }
            
            // Calcola viaggio se necessario
            let travelNeeded = destination !== lastLocation;
            let travelTime = 0;
            let travelCost = 0;
            
            if (travelNeeded) {
                const travelInfo = calculateTravelTime(destination, lastLocation);
                travelTime = travelInfo.time;
                travelCost = travelInfo.cost;
                
                // Modifica tempo/costo in base al mezzo di trasporto
                const transport = appt.transport || 'walk';
                const transportMultipliers = {
                    walk: { time: 1.0, cost: 0 },
                    bike: { time: 0.6, cost: 0 },
                    bus: { time: 0.5, cost: 3 },
                    car: { time: 0.4, cost: 5 },
                    taxi: { time: 0.3, cost: 15 },
                    uber: { time: 0.3, cost: 12 }
                };
                const mult = transportMultipliers[transport] || transportMultipliers.walk;
                travelTime *= mult.time;
                travelCost = mult.cost > 0 ? mult.cost : travelCost * mult.time;
            }
            
            // Aggiungi viaggio se necessario
            if (travelNeeded && travelTime > 0) {
                const transportIcon = appt.transportIcon || '';
                const transportNames = {
                    walk: 'A piedi',
                    bike: 'In bici',
                    bus: 'In autobus',
                    car: 'In auto',
                    taxi: 'In taxi',
                    uber: 'Con Uber'
                };
                const transportName = transportNames[appt.transport] || 'A piedi';
                
                timelineEvents.push({
                    type: 'travel',
                    start: lastEventEnd,
                    end: lastEventEnd + travelTime,
                    title: `${transportIcon} ${transportName}`,
                    description: `Da ${NEIGHBORHOODS[lastLocation]?.name || lastLocation} a ${NEIGHBORHOODS[destination]?.name || destination} - ${travelCost.toFixed(1)}`,
                    color: 'rgba(255,200,100,0.3)',
                    transport: appt.transport
                });
                lastEventEnd += travelTime;
            }
            
            // Tempo libero prima dell'appuntamento
            if (apptStart > lastEventEnd) {
                timelineEvents.push({
                    type: 'free',
                    start: lastEventEnd,
                    end: apptStart,
                    title: ' Tempo Libero',
                    description: 'Attivit personali',
                    color: 'rgba(150,150,150,0.2)'
                });
            }
            
            // Appuntamento - usa durata specificata o default
            const duration = appt.duration || 
                (appt.type === 'work' && game.workData?.currentJob 
                    ? (game.workData.currentJob.hours.end - game.workData.currentJob.hours.start)
                    : 1);
            
            const typeColors = {
                work: 'rgba(102,126,234,0.4)',
                social: 'rgba(255,100,200,0.4)',
                personal: 'rgba(100,255,100,0.4)',
                health: 'rgba(255,100,100,0.4)',
                other: 'rgba(200,200,100,0.4)'
            };
            
            timelineEvents.push({
                type: appt.type,
                start: apptStart,
                end: apptStart + duration,
                title: appt.title,
                description: appt.description || '',
                location: destination,
                color: typeColors[appt.type] || 'rgba(255,255,255,0.2)'
            });
            
            lastEventEnd = apptStart + duration;
            lastLocation = destination;
        });
        
        // Viaggio di ritorno a casa se necessario
        if (lastLocation !== (game.housing?.neighborhood || 'periferia') && lastEventEnd < 24) {
            const homeNeighborhood = game.housing?.neighborhood || 'periferia';
            const travelInfo = calculateTravelTime(homeNeighborhood, lastLocation);
            const travelTime = travelInfo.time;
            
            if (travelTime > 0) {
                timelineEvents.push({
                    type: 'travel',
                    start: lastEventEnd,
                    end: lastEventEnd + travelTime,
                    title: ' Ritorno a Casa',
                    description: `Da ${NEIGHBORHOODS[lastLocation]?.name || lastLocation} a ${NEIGHBORHOODS[homeNeighborhood]?.name || homeNeighborhood}`,
                    color: 'rgba(255,200,100,0.3)'
                });
                lastEventEnd += travelTime;
            }
            
            lastLocation = homeNeighborhood;
        }
        
        // Resto della giornata a casa
        if (lastEventEnd < 24) {
            timelineEvents.push({
                type: 'home',
                start: lastEventEnd,
                end: 24,
                title: ' Casa',
                description: 'A casa - tempo libero',
                color: 'rgba(100,200,255,0.3)'
            });
        }
        
        // Render timeline
        const currentTimePercent = ((currentHour + currentMinute / 60) / 24) * 100;
        
        timelineDiv.innerHTML = `
            <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:16px; margin-bottom:16px;">
                <h4 style="margin-bottom:12px; font-size:1rem;"> Timeline Giornaliera - Giorno ${currentDay}</h4>
                
                <!-- Timeline Bar -->
                <div style="position:relative; height:60px; background:rgba(0,0,0,0.3); border-radius:8px; margin-bottom:8px; overflow:hidden;">
                    ${timelineEvents.map(event => {
                        const leftPercent = (event.start / 24) * 100;
                        const widthPercent = ((event.end - event.start) / 24) * 100;
                        const isPast = event.end <= (currentHour + currentMinute / 60);
                        const isCurrent = event.start <= (currentHour + currentMinute / 60) && event.end > (currentHour + currentMinute / 60);
                        
                        return `
                            <div style="position:absolute; left:${leftPercent}%; width:${widthPercent}%; height:100%; 
                                        background:${event.color}; 
                                        border:2px solid ${isCurrent ? '#fff' : 'rgba(255,255,255,0.3)'};
                                        ${isPast ? 'opacity:0.5;' : ''}
                                        display:flex; align-items:center; justify-content:center;
                                        font-size:0.75rem; font-weight:bold; color:white; text-shadow:0 1px 2px rgba(0,0,0,0.8);
                                        overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding:0 4px;">
                                ${event.title}
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Current Time Indicator -->
                    <div style="position:absolute; left:${currentTimePercent}%; top:0; bottom:0; width:3px; 
                                background:red; z-index:100; box-shadow:0 0 8px rgba(255,0,0,0.8);">
                        <div style="position:absolute; top:-20px; left:50%; transform:translateX(-50%); 
                                    background:red; color:white; padding:2px 6px; border-radius:4px; 
                                    font-size:0.7rem; font-weight:bold; white-space:nowrap;">
                            ${String(currentHour).padStart(2,'0')}:${String(currentMinute).padStart(2,'0')}
                        </div>
                    </div>
                </div>
                
                <!-- Hour Labels -->
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; opacity:0.6; margin-bottom:16px;">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>24:00</span>
                </div>
                
                <!-- Event Details -->
                <div style="max-height:300px; overflow-y:auto;">
                    ${timelineEvents.map((event, idx) => {
                        const startTime = Math.floor(event.start);
                        const startMin = Math.round((event.start - startTime) * 60);
                        const endTime = Math.floor(event.end);
                        const endMin = Math.round((event.end - endTime) * 60);
                        const duration = event.end - event.start;
                        const isPast = event.end <= (currentHour + currentMinute / 60);
                        const isCurrent = event.start <= (currentHour + currentMinute / 60) && event.end > (currentHour + currentMinute / 60);
                        
                        return `
                            <div style="padding:10px; background:${event.color}; border-radius:6px; margin-bottom:8px;
                                        border-left:3px solid ${isCurrent ? '#fff' : 'rgba(255,255,255,0.5)'};
                                        ${isPast ? 'opacity:0.5;' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; margin-bottom:2px;">
                                            ${event.title} ${isCurrent ? '' : isPast ? '' : ''}
                                        </div>
                                        <div style="font-size:0.85rem; opacity:0.9;">${event.description}</div>
                                    </div>
                                    <div style="text-align:right; font-size:0.85rem;">
                                        <div>${String(startTime).padStart(2,'0')}:${String(startMin).padStart(2,'0')} - ${String(endTime).padStart(2,'0')}:${String(endMin).padStart(2,'0')}</div>
                                        <div style="opacity:0.7;">${duration.toFixed(1)}h</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    function checkAppointmentReminders() {
        if (!game.agenda || !game.agenda.appointments) return;
        
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        const currentMinute = game.time.minute || 0;
        
        // Calcola tempo corrente in minuti totali
        const currentTotalMinutes = currentDay * 24 * 60 + currentHour * 60 + currentMinute;
        
        game.agenda.appointments.forEach(appt => {
            const apptMinute = appt.minute || 0;
            const apptTotalMinutes = appt.day * 24 * 60 + appt.hour * 60 + apptMinute;
            
            // Notifica tra 55 e 65 minuti prima (finestra di 10 minuti per non perdere notifica)
            const minutesUntil = apptTotalMinutes - currentTotalMinutes;
            
            if (minutesUntil > 55 && minutesUntil <= 65 && !appt.notified) {
                const typeIcons = {
                    work: '',
                    social: '',
                    personal: '',
                    health: '',
                    other: ''
                };
                const icon = typeIcons[appt.type] || '';
                const timeStr = formatTime(appt.hour, apptMinute);
                
                showNotification(`${icon} Promemoria: ${appt.title} alle ${timeStr} (tra ~1 ora)!`, 4000);
                appt.notified = true;
            }
        });
    }
    
    function showSleepUntilDialog() {
        const currentHour = game.time.hour;
        
        let html = `
            <div class="modal-section info">
                <div class="modal-section-title"> Ora Attuale</div>
                <div class="modal-section-content" style="font-size:1.3rem; font-weight:bold; text-align:center; color:#667eea;">
                    ${formatTime(game.time.hour, game.time.minute)}
                </div>
            </div>
        `;
        
        // Add options for specific hours
        const workJob = game.workData?.currentJob;
        
        // Suggest work hours if employed
        if (workJob && workJob.hours) {
            const workStart = workJob.hours.start;
            const travelTime = workJob.location && workJob.location !== game.cityMap.currentLocation ? 
                              calculateTravelTime(workJob.location).time : 0;
            const wakeUpTime = Math.max(6, workStart - travelTime - 1); // Wake up 1h before + travel time
            
            html += `
                <div class="modal-section success">
                    <div class="modal-section-title"> Sveglia Ottimizzata per Lavoro</div>
                    <div class="modal-section-content">
                        <div style="margin-bottom:12px; line-height:1.6;">
                             Inizio turno: <strong>${workStart}:00</strong><br>
                            ${travelTime > 0 ? ` Tempo di viaggio: <strong>${travelTime}h</strong><br>` : ''}
                             Sveglia consigliata: <strong>${wakeUpTime}:00</strong>
                        </div>
                        <button onclick="sleepUntil(${wakeUpTime}); closeDialog();" 
                                style="width:100%; padding:12px; background:linear-gradient(135deg, #38ef7d, #11998e); border-radius:10px; font-weight:600; font-size:1rem;">
                             Svegliati alle ${wakeUpTime}:00
                        </button>
                    </div>
                </div>
            `;
        }
        
        html += `
            <div class="modal-section" style="border-left-color:#764ba2;">
                <div class="modal-section-title"> Scegli l'Orario di Sveglia</div>
                <div class="modal-section-content">
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
        `;
        
        // Add hourly options
        for (let hour = 0; hour < 24; hour++) {
            if (hour === currentHour) continue; // Skip current hour
            
            let hoursToSleep;
            if (hour > currentHour) {
                hoursToSleep = hour - currentHour;
            } else {
                hoursToSleep = (24 - currentHour) + hour;
            }
            
            // Calculate energy recovery
            const energyGain = Math.min(100, hoursToSleep * 8);
            
            html += `
                <button onclick="sleepUntil(${hour}); closeDialog();" 
                        class="modal-action-btn" 
                        style="padding:12px 8px; min-height:70px; background:rgba(102,126,234,0.12); border:1px solid rgba(102,126,234,0.3);">
                    <div style="font-size:1.2rem; font-weight:bold; margin-bottom:4px;">${hour}:00</div>
                    <div style="font-size:0.8rem; opacity:0.7;">+${energyGain} </div>
                </button>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        showDialog(html, ' Dormi fino alle...', true);
    }
    
    function sleepUntil(targetHour) {
        const currentHour = game.time.hour;
        let hoursToSleep;
        
        if (targetHour > currentHour) {
            hoursToSleep = targetHour - currentHour;
        } else {
            hoursToSleep = (24 - currentHour) + targetHour;
        }
        
        // Must be at home to sleep
        if (game.cityMap.currentLocation !== game.housing.neighborhood) {
            showNotification(' Devi tornare a casa per dormire!', 2500);
            return;
        }
        
        // Calculate energy recovery (8% per hour of sleep, max 100%)
        const energyGain = Math.min(100 - game.player.stats.energy, hoursToSleep * 8);
        game.player.stats.energy = clamp(game.player.stats.energy + energyGain);
        
        // Small hunger and morale changes
        game.player.stats.hunger = clamp(game.player.stats.hunger - hoursToSleep * 3);
        game.player.stats.morale = clamp(game.player.stats.morale + Math.floor(hoursToSleep / 2));
        
        passTime(hoursToSleep);
        
        showNotification(` Hai dormito ${hoursToSleep}h. Ti sei svegliato alle ${formatTime(game.time.hour, game.time.minute)}. Energia: +${energyGain}%`, 3000);
        updateUI();
    }

    function pad2(n) { return n < 10 ? '0' + n : '' + n; }
    function formatTime(hour24, minute) {
        const period = hour24 >= 12 ? 'PM' : 'AM';
        const h12 = hour24 % 12 === 0 ? 12 : hour24 % 12;
        return `${h12}:${pad2(minute)} ${period}`;
    }

    function getTimeString() {
        const dayOfWeek = DAYS_OF_WEEK[(game.time.day - 1) % 7];
        return `${dayOfWeek} - Giorno ${game.time.day} - ${formatTime(game.time.hour, game.time.minute)}`;
    }
    
    function getDayOfWeek(day) {
        return DAYS_OF_WEEK[(day - 1) % 7];
    }
    
    function isWeekend(day) {
        const dayIndex = (day - 1) % 7;
        return dayIndex === 5 || dayIndex === 6; // Sabato (5) o Domenica (6)
    }

    // ---------- CRIME EVENTS ----------
    function checkDailyCrimeEvent() {
        // No crime if homeless (already suffering enough)
        if (game.player.isHomeless) return;
        
        const hood = NEIGHBORHOODS[game.housing.neighborhood];
        const safetyLevel = hood.safety || 50;
        
        // Crime chance increases in unsafe neighborhoods
        const crimeChance = (100 - safetyLevel) / 100 * 0.2; // Max 20% in worst area
        
        if (Math.random() > crimeChance) return;
        
        // Types of crime based on neighborhood
        const crimeTypes = [];
        
        if (safetyLevel < 40) {
            crimeTypes.push('robbery_high', 'vehicle_damage', 'home_burglary');
        } else if (safetyLevel < 60) {
            crimeTypes.push('robbery_medium', 'vehicle_damage');
        } else if (safetyLevel < 80) {
            crimeTypes.push('robbery_low', 'pickpocket');
        } else {
            crimeTypes.push('pickpocket');
        }
        
        const crimeType = crimeTypes[randInt(0, crimeTypes.length - 1)];
        
        switch(crimeType) {
            case 'robbery_high':
                const stolen1 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.3 + Math.random() * 0.4)));
                game.player.cash -= stolen1;
                game.player.stats.morale = clamp(game.player.stats.morale - 30);
                showNotification(` SEI STATO RAPINATO! Hanno rubato ${stolen1} in contante!`, 5000);
                break;
                
            case 'robbery_medium':
                const stolen2 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.15 + Math.random() * 0.25)));
                game.player.cash -= stolen2;
                game.player.stats.morale = clamp(game.player.stats.morale - 20);
                showNotification(` Sei stato derubato! Persi ${stolen2}!`, 4000);
                break;
                
            case 'robbery_low':
                const stolen3 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.05 + Math.random() * 0.15)));
                game.player.cash -= stolen3;
                game.player.stats.morale = clamp(game.player.stats.morale - 10);
                showNotification(` Borseggiatore! Persi ${stolen3}!`, 3000);
                break;
                
            case 'pickpocket':
                const stolen4 = Math.min(game.player.cash, Math.floor(50 + Math.random() * 150));
                game.player.cash -= stolen4;
                game.player.stats.morale = clamp(game.player.stats.morale - 8);
                showNotification(` Borseggiatore furtivo! Persi ${stolen4}!`, 3000);
                break;
                
            case 'vehicle_damage':
                if (game.vehicles && game.vehicles.length > 0) {
                    const damageCost = Math.floor(200 + Math.random() * 1800);
                    showNotification(` Il tuo veicolo  stato danneggiato! Riparazione: ${damageCost}`, 4000);
                    
                    if (game.player.cash >= damageCost) {
                        game.player.cash -= damageCost;
                    } else {
                        // Remove vehicle if can't afford repair
                        game.vehicles = [];
                        game.player.stats.morale = clamp(game.player.stats.morale - 40);
                        showNotification(' Non puoi permetterti la riparazione. Veicolo perso!', 5000);
                    }
                }
                break;
                
            case 'home_burglary':
                if (game.housing.owned) {
                    const burglaryLoss = Math.floor(500 + Math.random() * 2500);
                    const totalMoney = game.player.cash + game.player.bankDeposit;
                    
                    if (totalMoney >= burglaryLoss) {
                        if (game.player.cash >= burglaryLoss) {
                            game.player.cash -= burglaryLoss;
                        } else {
                            const remaining = burglaryLoss - game.player.cash;
                            game.player.cash = 0;
                            game.player.bankDeposit -= remaining;
                        }
                        showNotification(` FURTO IN CASA! Persi beni per ${burglaryLoss}!`, 5000);
                        game.player.stats.morale = clamp(game.player.stats.morale - 35);
                    }
                }
                break;
        }
        
        updateUI();
    }

    // ---------- BANK FUNCTIONS ----------
    function showBankDialog() {
        const html = `
            <div class="modal-section success">
                <div class="modal-section-title"> Il Tuo Patrimonio</div>
                <div class="modal-section-content">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;">
                        <div style="background:rgba(56,239,125,0.15); padding:14px; border-radius:10px; text-align:center; border:2px solid rgba(56,239,125,0.3);">
                            <div style="font-size:0.9rem; opacity:0.8; margin-bottom:6px;"> Contante</div>
                            <div style="font-weight:bold; font-size:1.6rem; color:#38ef7d;">${game.player.cash.toFixed(0)}</div>
                            <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">A rischio furto</div>
                        </div>
                        <div style="background:rgba(102,126,234,0.15); padding:14px; border-radius:10px; text-align:center; border:2px solid rgba(102,126,234,0.3);">
                            <div style="font-size:0.9rem; opacity:0.8; margin-bottom:6px;"> Deposito</div>
                            <div style="font-weight:bold; font-size:1.6rem; color:#667eea;">${game.player.bankDeposit.toFixed(0)}</div>
                            <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">Protetto e sicuro</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-section info">
                <div class="modal-section-title"> Deposita Contante</div>
                <div class="modal-section-content">
                    <input type="number" id="depositAmount" min="0" max="${game.player.cash}" 
                        style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:2px solid rgba(102,126,234,0.3); border-radius:10px; color:white; font-size:1.1rem; margin-bottom:12px;"
                        placeholder="Quanto vuoi depositare?">
                    <button onclick="depositMoney()" style="width:100%; padding:12px; border-radius:10px; font-size:1rem; font-weight:600;">
                         Deposita in Banca
                    </button>
                </div>
            </div>
            
            <div class="modal-section warning">
                <div class="modal-section-title"> Preleva Contante</div>
                <div class="modal-section-content">
                    <input type="number" id="withdrawAmount" min="0" max="${game.player.bankDeposit}"
                        style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:2px solid rgba(255,215,0,0.3); border-radius:10px; color:white; font-size:1.1rem; margin-bottom:12px;"
                        placeholder="Quanto vuoi prelevare?">
                    <button onclick="withdrawMoney()" style="width:100%; padding:12px; border-radius:10px; font-size:1rem; font-weight:600;">
                         Preleva dalla Banca
                    </button>
                </div>
            </div>
            
            <div class="modal-section" style="background:rgba(56,239,125,0.08); border-left-color:#38ef7d;">
                <div style="font-size:0.9rem; line-height:1.6;">
                     <strong>Importante:</strong> Il contante che porti con te pu essere rubato durante rapine o eventi negativi. I soldi depositati in banca sono completamente al sicuro!
                </div>
            </div>
        `;
        showDialog(html, ' Gestione Bancaria', true);
    }

    function depositMoney() {
        const amount = parseFloat($('depositAmount').value);
        
        if (isNaN(amount) || amount <= 0) {
            showNotification(' Importo non valido!', 2000);
            return;
        }
        
        if (amount > game.player.cash) {
            showNotification(' Non hai abbastanza contante!', 2000);
            return;
        }
        
        game.player.cash -= amount;
        game.player.bankDeposit += amount;
        
        showNotification(` Depositati ${amount.toFixed(0)} in banca!`, 2000);
        closeDialog();
        updateUI();
    }

    function withdrawMoney() {
        const amount = parseFloat($('withdrawAmount').value);
        
        if (isNaN(amount) || amount <= 0) {
            showNotification(' Importo non valido!', 2000);
            return;
        }
        
        if (amount > game.player.bankDeposit) {
            showNotification(' Fondi insufficienti in banca!', 2000);
            return;
        }
        
        game.player.bankDeposit -= amount;
        game.player.cash += amount;
        
        showNotification(` Prelevati ${amount.toFixed(0)} dalla banca!`, 2000);
        closeDialog();
        updateUI();
    }

    // ---------- RANDOM EVENTS ----------
    // ---------- CRITICAL STATUS TRACKING ----------
    function checkCriticalStatus() {
        const stats = game.player.stats;
        const tracking = game.healthTracking;
        
        // Check if this is a new day
        if (tracking.lastCheckDay !== game.time.day) {
            tracking.lastCheckDay = game.time.day;
            
            // Check energy
            if (stats.energy < 10) {
                tracking.lowEnergyDays++;
                if (tracking.lowEnergyDays === 3) {
                    showNotification(' La tua energia  stata criticamente bassa per 3 giorni!', 4000);
                } else if (tracking.lowEnergyDays === 5) {
                    showNotification(' PERICOLO: La tua energia  pericolosamente bassa! Giorno 5/7', 5000);
                } else if (tracking.lowEnergyDays >= 7) {
                    gameOver(' GAME OVER - Sei morto di esaurimento. La tua energia  rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.energy > 20) {
                tracking.lowEnergyDays = 0;
            }
            
            // Check hunger
            if (stats.hunger < 10) {
                tracking.lowHungerDays++;
                if (tracking.lowHungerDays === 3) {
                    showNotification(' La tua fame  stata criticamente alta per 3 giorni!', 4000);
                } else if (tracking.lowHungerDays === 5) {
                    showNotification(' PERICOLO: Stai morendo di fame! Giorno 5/7', 5000);
                } else if (tracking.lowHungerDays >= 7) {
                    gameOver(' GAME OVER - Sei morto di malnutrizione. La tua fame  rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.hunger > 20) {
                tracking.lowHungerDays = 0;
            }
            
            // Check health
            if (stats.health < 10) {
                tracking.lowHealthDays++;
                if (tracking.lowHealthDays === 3) {
                    showNotification(' La tua salute  stata criticamente bassa per 3 giorni!', 4000);
                } else if (tracking.lowHealthDays === 5) {
                    showNotification(' PERICOLO: Sei gravemente malato! Giorno 5/7', 5000);
                } else if (tracking.lowHealthDays >= 7) {
                    gameOver(' GAME OVER - Sei morto di malattia. La tua salute  rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.health > 20) {
                tracking.lowHealthDays = 0;
            }
            
            // Check debt
            if (game.player.money < 0) {
                tracking.debtDays++;
                if (tracking.debtDays === 7) {
                    showNotification(' Sei stato in debito per 7 giorni! Le banche potrebbero agire presto.', 4000);
                } else if (tracking.debtDays === 14) {
                    showNotification(' AVVISO FINALE: Paga i tuoi debiti o affronterai il fallimento!', 5000);
                } else if (tracking.debtDays >= 30) {
                    gameOver(' GAME OVER - Fallimento dichiarato! Sei stato in debito per 30 giorni e i tuoi beni sono stati sequestrati.');
                    return;
                }
            } else {
                tracking.debtDays = 0;
            }
        }
    }
    
    // ---------- LOAN PAYMENT PROCESSING ----------
    function processLoanPayments() {
        if (!game.investments.loans || game.investments.loans.length === 0) return;
        
        const loansToRemove = [];
        
        for (let i = 0; i < game.investments.loans.length; i++) {
            const loan = game.investments.loans[i];
            
            // Check if payment is due
            if (game.player.money >= loan.monthlyPayment) {
                game.player.money -= loan.monthlyPayment;
                game.player.cash -= loan.monthlyPayment;
                loan.remainingMonths--;
                
                if (loan.remainingMonths <= 0) {
                    showNotification(` Hai completato il pagamento del prestito da ${loan.bank}!`, 3000);
                    loansToRemove.push(i);
                } else {
                    showNotification(` Pagamento mensile di ${loan.monthlyPayment.toFixed(0)} effettuato. Restano ${loan.remainingMonths} rate.`, 3000);
                }
            } else {
                // Can't pay - increase missed payments
                if (!loan.missedPayments) loan.missedPayments = 0;
                loan.missedPayments++;
                
                showNotification(` Non hai abbastanza soldi per la rata del prestito! (${loan.monthlyPayment.toFixed(0)}) Rate mancate: ${loan.missedPayments}`, 4000);
                
                if (loan.missedPayments >= 3) {
                    gameOver(` GAME OVER - Hai mancato ${loan.missedPayments} pagamenti del prestito. La banca ha sequestrato i tuoi beni!`);
                    return;
                }
            }
        }
        
        // Remove paid-off loans
        for (let i = loansToRemove.length - 1; i >= 0; i--) {
            game.investments.loans.splice(loansToRemove[i], 1);
        }
        
        updateUI();
    }
    
    // ---------- GAME OVER ----------
    function gameOver(message) {
        game.isPaused = true;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            border: 3px solid #ff0000;
            box-shadow: 0 0 50px rgba(255,0,0,0.5);
        `;
        
        content.innerHTML = `
            <h1 style="color: #ff0000; font-size: 48px; margin: 0 0 20px 0;">GAME OVER</h1>
            <p style="color: #fff; font-size: 20px; margin: 20px 0;">${message}</p>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <p style="color: #ccc; margin: 5px 0;"> Giorni sopravvissuti: ${game.time.day}</p>
                <p style="color: #ccc; margin: 5px 0;"> Denaro finale: ${game.player.money.toFixed(0)}</p>
                <p style="color: #ccc; margin: 5px 0;"> Reputazione: ${game.player.rep}</p>
            </div>
            <button onclick="location.reload()" style="
                background: #ff0000;
                color: white;
                border: none;
                padding: 15px 40px;
                font-size: 18px;
                border-radius: 10px;
                cursor: pointer;
                margin-top: 20px;
            ">Ricomincia</button>
        `;
        
        overlay.appendChild(content);
        document.body.appendChild(overlay);
    }

    function checkRandomEvent() {
        if (Math.random() > 0.15) return; // 15% chance

        const events = [
            { msg: ' Hai trovato 50 per strada!', cash: 50 },
            { msg: ' Una giornata particolarmente bella!', morale: 15 },
            { msg: ' Ti senti energico!', energy: 20 },
            { msg: ' Qualcuno ti ha offerto la pizza!', hunger: 25, cash: 15 },
            { msg: ' Ti senti in gran forma!', health: 15 }
        ];

        const event = events[randInt(0, events.length - 1)];
        
        if (event.cash) game.player.cash += event.cash;
        if (event.morale) game.player.stats.morale = clamp(game.player.stats.morale + event.morale);
        if (event.energy) game.player.stats.energy = clamp(game.player.stats.energy + event.energy);
        if (event.hunger) game.player.stats.hunger = clamp(game.player.stats.hunger + event.hunger);
        if (event.health) game.player.stats.health = clamp(game.player.stats.health + event.health);

        showNotification(event.msg, 2500);
        updateUI();
    }

    // ---------- UI UPDATE ----------
    function updateUI() {
        if (!game.player) return;

        // Update total money display with cash/bank breakdown
        const totalMoney = (game.player.cash || 0) + (game.player.bankDeposit || 0);
        game.player.money = totalMoney; // Keep synced
        $('playerMoney').innerHTML = `${totalMoney.toFixed(0)}<br><small style="font-size:9px"> ${(game.player.cash || 0).toFixed(0)} |  ${(game.player.bankDeposit || 0).toFixed(0)}</small>`;
        
        $('playerRep').innerText = game.player.rep || 0;
        $('playerJob').innerText = game.player.job || 'Disoccupato';
        if ($('gameTime')) $('gameTime').innerText = getTimeString();
        
        // Update location display
        updateLocationDisplay();

        updateStatBar('hunger', game.player.stats.hunger);
        updateStatBar('energy', game.player.stats.energy);
        updateStatBar('morale', game.player.stats.morale);
        updateStatBar('health', game.player.stats.health);

        // Update skills in both locations (sidebar and skills tab)
        const skills = game.player.skills || { intellect: 0, fitness: 0, creativity: 0, charisma: 0 };
        
        // Update skills tab (rounded to 2 decimals)
        if ($('intellectValue')) $('intellectValue').innerText = Math.round(skills.intellect * 100) / 100;
        if ($('fitnessValue')) $('fitnessValue').innerText = Math.round(skills.fitness * 100) / 100;
        if ($('creativityValue')) $('creativityValue').innerText = Math.round(skills.creativity * 100) / 100;
        if ($('charismaValue')) $('charismaValue').innerText = Math.round(skills.charisma * 100) / 100;
        
        // Update skills in vital stats card with bars (rounded to 2 decimals)
        if ($('intellectValue2')) $('intellectValue2').innerText = Math.round(skills.intellect * 100) / 100;
        if ($('fitnessValue2')) $('fitnessValue2').innerText = Math.round(skills.fitness * 100) / 100;
        if ($('creativityValue2')) $('creativityValue2').innerText = Math.round(skills.creativity * 100) / 100;
        if ($('charismaValue2')) $('charismaValue2').innerText = Math.round(skills.charisma * 100) / 100;
        
        // Update skill bars (max 100)
        if ($('intellectBar')) $('intellectBar').style.width = Math.min(100, skills.intellect) + '%';
        if ($('fitnessBar')) $('fitnessBar').style.width = Math.min(100, skills.fitness) + '%';
        if ($('creativityBar')) $('creativityBar').style.width = Math.min(100, skills.creativity) + '%';
        if ($('charismaBar')) $('charismaBar').style.width = Math.min(100, skills.charisma) + '%';
        
        // Update skill bars in Skills tab
        if ($('intellectBarTab')) $('intellectBarTab').style.width = Math.min(100, skills.intellect) + '%';
        if ($('fitnessBarTab')) $('fitnessBarTab').style.width = Math.min(100, skills.fitness) + '%';
        if ($('creativityBarTab')) $('creativityBarTab').style.width = Math.min(100, skills.creativity) + '%';
        if ($('charismaBarTab')) $('charismaBarTab').style.width = Math.min(100, skills.charisma) + '%';
        
        // Update skill levels
        if ($('intellectLevel')) $('intellectLevel').innerText = getSkillLevel(skills.intellect);
        if ($('fitnessLevel')) $('fitnessLevel').innerText = getSkillLevel(skills.fitness);
        if ($('creativityLevel')) $('creativityLevel').innerText = getSkillLevel(skills.creativity);
        if ($('charismaLevel')) $('charismaLevel').innerText = getSkillLevel(skills.charisma);
        
        // Update daily training counter
        if ($('dailyTrainingCount')) {
            // Reset counter if new day
            if (game.player.lastTrainingDay !== game.time.day) {
                game.player.dailyTraining = 0;
                game.player.lastTrainingDay = game.time.day;
            }
            const count = game.player.dailyTraining || 0;
            $('dailyTrainingCount').innerText = `${count}/3`;
            $('dailyTrainingCount').style.color = count >= 3 ? '#eb3349' : count >= 2 ? '#ffd700' : '#38ef7d';
        }

        // Update cash/bank displays
        if ($('cashDisplay')) $('cashDisplay').innerText = (game.player.cash || 0).toFixed(0);
        if ($('bankDisplay')) $('bankDisplay').innerText = (game.player.bankDeposit || 0).toFixed(0);

        updateWorkStatus();
        renderKnownPeople();
        renderQuests();
        renderJobListings();
        
        // Update housing and food systems
        renderCurrentHousing();
        renderNeighborhoods();
        renderFoodShop();
        renderFoodInventory();

        // Update new systems
        renderRomanceStatus();
        renderPotentialPartners();
        renderFamilyStatus();
        
        // Update investments
        if ($('savingsAmount')) $('savingsAmount').innerText = formatMoney(game.investments.savings);
        renderStockMarket();
        renderStockPortfolio();
        renderPropertiesList();

        // Update crime
        renderCrimeStatus();

        // Update map and vehicles
        renderCityQuartiersMap();
        renderTransportInfo();
        renderVehiclesInfo();
        updatePlayerMarker(); // Update player position on map
        
        // Update agenda
        renderAgenda();
        renderDailyTimeline();
        
        // Update enhanced info panel
        updateEnhancedLocationDisplay();
        updateDetailedStats();
        updateLocalNpcs();
    }

    function updateStatBar(stat, value) {
        const bar = $(stat + 'Bar');
        const txt = $(stat + 'Value');
        if (!bar || !txt) return;

        const roundedValue = Math.round(value * 100) / 100;
        bar.style.width = roundedValue + '%';
        txt.innerText = roundedValue + '%';
        bar.className = 'stat-fill ' + (roundedValue > 66 ? 'high' : roundedValue > 33 ? 'medium' : 'low');
    }
    
    function getSkillLevel(skillValue) {
        if (skillValue < 10) return 'Novizio';
        if (skillValue < 20) return 'Principiante';
        if (skillValue < 35) return 'Apprendista';
        if (skillValue < 50) return 'Competente';
        if (skillValue < 65) return 'Esperto';
        if (skillValue < 80) return 'Avanzato';
        if (skillValue < 95) return 'Maestro';
        return 'Gran Maestro';
    }

    // ---------- ENHANCED INFO PANEL FUNCTIONS ----------
    function updateEnhancedLocationDisplay() {
        const currentLocation = game.cityMap.currentLocation || 'centro_storico';
        const neighborhood = NEIGHBORHOODS[currentLocation];
        const building = game.cityMap.currentBuilding || null;
        
        if (!neighborhood) return;
        
        let locationInfo = `<div style="color: #FFD700; font-size: 1.2rem; margin-bottom: 8px;">${neighborhood.emoji} ${neighborhood.name}</div>`;
        
        // Add specific building/location if available
        if (building) {
            locationInfo += `<div style="color: #87CEEB; margin-bottom: 8px;"> ${building}</div>`;
        }
        
        // Add address/status for homeless or housed
        if (game.player.isHomeless) {
            locationInfo += `<div style="color: #FF6B6B; font-size: 0.9rem;"> Senzatetto - Posizione temporanea</div>`;
        } else if (game.housing && game.housing.neighborhood) {
            const homeNeighborhood = NEIGHBORHOODS[game.housing.neighborhood];
            if (homeNeighborhood && currentLocation !== game.housing.neighborhood) {
                locationInfo += `<div style="color: #90EE90; font-size: 0.9rem;"> Casa: ${homeNeighborhood.name}</div>`;
            } else if (currentLocation === game.housing.neighborhood) {
                locationInfo += `<div style="color: #90EE90; font-size: 0.9rem;"> Sei a casa</div>`;
            }
        }
        
        // Add neighborhood info
        locationInfo += `<div style="color: #DDD; font-size: 0.85rem; margin-top: 8px; opacity: 0.8;">
             ${(neighborhood.residents || 0).toLocaleString()} abitanti<br>
             ${neighborhood.averageRent || 0}/mese affitti medi
        </div>`;
        
        if ($('enhancedLocationText')) {
            $('enhancedLocationText').innerHTML = locationInfo;
        }
    }
    
    function updateDetailedStats() {
        if (!game.player || !game.player.stats) return;
        
        const stats = [
            {
                name: 'Fame',
                emoji: '',
                value: game.player.stats.hunger,
                info: getStatInfo('hunger', game.player.stats.hunger)
            },
            {
                name: 'Energia',
                emoji: '',
                value: game.player.stats.energy,
                info: getStatInfo('energy', game.player.stats.energy)
            },
            {
                name: 'Morale',
                emoji: '',
                value: game.player.stats.morale,
                info: getStatInfo('morale', game.player.stats.morale)
            },
            {
                name: 'Salute',
                emoji: '',
                value: game.player.stats.health,
                info: getStatInfo('health', game.player.stats.health)
            }
        ];
        
        let statsHTML = '';
        
        stats.forEach(stat => {
            const roundedValue = Math.round(stat.value * 100) / 100;
            const level = roundedValue > 66 ? 'high' : roundedValue > 33 ? 'medium' : 'low';
            
            statsHTML += `
                <div class="stat-item ${level} stat-tooltip">
                    <div class="stat-name">
                        <span>${stat.emoji}</span>
                        <span>${stat.name}</span>
                    </div>
                    <div>
                        <div class="stat-value">${roundedValue}%</div>
                    </div>
                    <div class="tooltip-content">${stat.info}</div>
                </div>
            `;
        });
        
        if ($('detailedStats')) {
            $('detailedStats').innerHTML = statsHTML;
        }
    }
    
    function getStatInfo(statName, value) {
        const roundedValue = Math.round(value * 100) / 100;
        
        switch(statName) {
            case 'hunger':
                if (roundedValue < 20) return `<strong>Affamato!</strong><br> Vai al supermercato per comprare cibo<br> Mangia a casa o al ristorante<br> La fame riduce energia e morale`;
                if (roundedValue < 50) return `<strong>Hai fame</strong><br>  ora di mangiare qualcosa<br> Controlla il tuo inventario cibo<br> Il cibo migliora energia e morale`;
                return `<strong>Sazio</strong><br> Non hai bisogno di cibo ora<br> Il cibo si deteriora dopo 3 giorni<br> Mangiare quando sazio spreca risorse`;
                
            case 'energy':
                if (roundedValue < 20) return `<strong>Esausto!</strong><br> Dormi immediatamente (8h)<br> Bevi caff per energia temporanea<br> Bassa energia riduce efficacia azioni`;
                if (roundedValue < 50) return `<strong>Stanco</strong><br> Fai un pisolino (2h) o dormi<br> Medita per recupero parziale<br> Caff o colazione aiutano`;
                return `<strong>Energico</strong><br> Perfetto per attivit impegnative<br> Ottimo momento per studiare<br> Energia alta migliora apprendimento`;
                
            case 'morale':
                if (roundedValue < 20) return `<strong>Depresso</strong><br> Attivit divertenti: cinema, shopping<br> Socializza con amici<br> Spa o benessere<br> Basso morale riduce produttivit`;
                if (roundedValue < 50) return `<strong>Gi di morale</strong><br> Video games o hobby<br> Passeggia al parco<br> Rilassati al caff<br> Shopping migliora l'umore`;
                return `<strong>Felice</strong><br> Ottimo stato mentale<br> Perfetto per il lavoro<br> Apprendimento efficace<br> Buon momento per socializzare`;
                
            case 'health':
                if (roundedValue < 20) return `<strong>Malato!</strong><br> Evita attivit fisiche intense<br> Riposo e cure necessarie<br> Igiene personale importante<br> Bassa salute limita le azioni`;
                if (roundedValue < 50) return `<strong>Non in forma</strong><br> Esercizio fisico leggero<br> Alimentazione sana<br> Cura l'igiene personale<br> Riposo adeguato`;
                return `<strong>In salute</strong><br> Perfetto per sport intensi<br> Tutti gli allenamenti disponibili<br> Attivit fisiche molto efficaci<br> Recupero energia pi veloce`;
                
            default:
                return `Valore attuale: ${roundedValue}%`;
        }
    }
    
    function updateLocalNpcs() {
        if (!game.npcs) {
            if ($('localNpcs')) {
                $('localNpcs').innerHTML = '<div style="color: #999; font-style: italic;">Nessun NPC disponibile</div>';
            }
            return;
        }
        
        const currentLocation = game.cityMap.currentLocation || 'centro_storico';
        const localNpcs = game.npcs.filter(npc => npc.location === currentLocation || 
                                                   (!npc.location && currentLocation === 'centro_storico'));
        
        if (localNpcs.length === 0) {
            if ($('localNpcs')) {
                $('localNpcs').innerHTML = '<div style="color: #999; font-style: italic;">Nessuno in zona al momento</div>';
            }
            return;
        }
        
        let npcsHTML = '';
        
        localNpcs.forEach(npc => {
            const relationColor = npc.relation > 70 ? '#4CAF50' : npc.relation > 40 ? '#FF9800' : '#F44336';
            const knownStatus = npc.known ? '' : '?';
            
            npcsHTML += `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${relationColor};">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: white;">${knownStatus} ${npc.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${npc.job}</div>
                        ${npc.known ? `<div style="font-size: 0.75rem; color: ${relationColor};">Relazione: ${npc.relation}/100</div>` : ''}
                    </div>
                    <button onclick="showNpcChat('${npc.id}')" 
                            style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                         Parla
                    </button>
                </div>
            `;
        });
        
        if ($('localNpcs')) {
            $('localNpcs').innerHTML = npcsHTML;
        }
    }

    // ---------- TABS ----------
    // ---------- UI CONTROL ----------
    function toggleStatsPanel() {
        const statsPanel = document.getElementById('statsPanel');
        const mapArea = document.getElementById('mainMapArea');
        
        if (statsPanel.style.transform === 'translateY(-100%)') {
            statsPanel.style.transform = 'translateY(0)';
            mapArea.style.paddingTop = '200px'; // Make room for expanded stats
        } else {
            statsPanel.style.transform = 'translateY(-100%)';
            mapArea.style.paddingTop = '0';
        }
    }
    
    function toggleMenuPanel() {
        const sidebar = document.getElementById('menuSidebar');
        if (sidebar.style.transform === 'translateX(0px)') {
            sidebar.style.transform = 'translateX(100%)';
        } else {
            sidebar.style.transform = 'translateX(0px)';
        }
    }
    
    // Funzioni per i nuovi menu
    function showVehiclesMenu() {
        closeLocationPopup(); // Chiudi eventuali popup aperti
        const currentLocation = game.cityMap?.currentLocation || 'periferia';
        const hood = NEIGHBORHOODS[currentLocation];
        
        let vehiclesHTML = '';
        if (game.vehicles.owned.length === 0) {
            vehiclesHTML = '<p style="opacity:0.7;">Nessun veicolo posseduto. Acquista veicoli per spostarti pi velocemente!</p>';
        } else {
            vehiclesHTML = game.vehicles.owned.map(v => {
                const vData = VEHICLES[v.type];
                const isActive = game.vehicles.active === v.id;
                return `
                    <div style="padding:12px; background:${isActive ? 'rgba(102,126,234,0.2)' : 'rgba(255,255,255,0.05)'}; border-radius:8px; margin-bottom:8px; border:2px solid ${isActive ? '#667eea' : 'transparent'};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:1.2rem;">${vData.emoji} ${vData.name}</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                    ${vData.description}<br>
                                     Velocit: ${Math.round((1-vData.speedMultiplier)*100)}% pi veloce<br>
                                     Manutenzione: ${vData.maintenanceCost}/mese
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                ${!isActive ? `<button class="small" onclick="setActiveVehicle('${v.id}')"> Usa</button>` : '<div style="color:#667eea; font-weight:bold;">In Uso</div>'}
                                <button class="small" onclick="sellVehicle('${v.id}')" style="background:var(--danger);"> Vendi</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title"> I Tuoi Veicoli</div>
                <div class="modal-section-content">
                    ${vehiclesHTML}
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title"> Acquista Veicoli</div>
                <div class="modal-section-content">
                    ${Object.keys(VEHICLES).map(key => {
                        const v = VEHICLES[key];
                        const owned = game.vehicles.owned.some(owned => owned.type === key);
                        return `
                            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-size:1.1rem;">${v.emoji} ${v.name}</div>
                                        <div style="font-size:0.85rem; opacity:0.8;">${v.description}</div>
                                        <div style="font-size:0.8rem; margin-top:4px;">
                                             ${v.cost}   ${Math.round((1-v.speedMultiplier)*100)}% pi veloce
                                        </div>
                                    </div>
                                    ${owned ? '<div style="color:var(--success);"> Posseduto</div>' : `<button class="small" onclick="buyVehicle('${key}')"> Acquista</button>`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        showDialog(html);
    }
    
    function showTransportMenu() {
        closeLocationPopup();
        const hasPass = game.cityMap?.transportPass && game.cityMap.transportPass > game.time.day;
        const daysLeft = hasPass ? game.cityMap.transportPass - game.time.day : 0;
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title"> Sistema Trasporti Pubblici</div>
                <div class="modal-section-content">
                    <p>Usa i trasporti pubblici per spostarti velocemente e gratuitamente (con abbonamento) nella citt.</p>
                    <div style="margin-top:12px; padding:12px; background:${hasPass ? 'rgba(56,239,125,0.1)' : 'rgba(255,100,100,0.1)'}; border-radius:8px;">
                        <strong> Stato Abbonamento:</strong><br>
                        ${hasPass ? ` Attivo (${daysLeft} giorni rimanenti)` : ' Nessun abbonamento attivo'}
                    </div>
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title"> Acquista Abbonamento</div>
                <div class="modal-section-content">
                    <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:bold;"> Abbonamento Mensile</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                    Viaggio illimitato su bus e metro per 30 giorni<br>
                                     Costo: 50
                                </div>
                            </div>
                            <button onclick="closeDialog(); buyTransportPass()"> Acquista</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-section warning">
                <div class="modal-section-title"> Linee Disponibili</div>
                <div class="modal-section-content" style="font-size:0.9rem;">
                    ${Object.values(NEIGHBORHOODS).map(n => `
                        <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:6px;">
                            <strong>${n.icon} ${n.name}</strong><br>
                            <div style="font-size:0.8rem; opacity:0.8;">
                                 Fermate: ${n.busStops.join(', ')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        showDialog(html);
    }
    
    function showQuartersMenu() {
        closeLocationPopup();
        const currentQuarter = game.cityMap?.currentLocation || 'periferia';
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title"> Quartieri di Eldoria</div>
                <div class="modal-section-content">
                    <p>Esplora i diversi quartieri della citt. Ogni quartiere ha caratteristiche uniche!</p>
                </div>
            </div>
            
            ${Object.keys(NEIGHBORHOODS).map(key => {
                const n = NEIGHBORHOODS[key];
                const isCurrent = currentQuarter === key;
                return `
                    <div class="modal-section ${isCurrent ? 'success' : 'info'}">
                        <div class="modal-section-title">${n.icon} ${n.name} ${isCurrent ? ' (Sei qui)' : ''}</div>
                        <div class="modal-section-content">
                            <p>${n.description}</p>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; font-size:0.85rem;">
                                <div> Affitto: ${n.rent}/mese</div>
                                <div> Qualit: ${n.quality}/100</div>
                                <div> Sicurezza: ${n.safety}/100</div>
                                <div> Servizi: ${n.services}/100</div>
                            </div>
                            <div style="margin-top:8px;">
                                ${!isCurrent ? `<button onclick="closeDialog(); travelToQuarter('${key}')"> Vai a ${n.name}</button>` : '<div style="color:var(--success);"> Posizione attuale</div>'}
                                <button onclick="closeDialog(); showDetailedQuarterMap('${key}')" style="margin-left:8px;"> Esplora Mappa</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
        
        showDialog(html);
    }
    
    function travelToQuarter(quarterId) {
        const hood = NEIGHBORHOODS[quarterId];
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, quarterId);
        
        if (confirm(` Vuoi andare a ${hood.name}?\nTempo di viaggio: ${travelTime} minuti`)) {
            advanceTime(travelTime);
            game.cityMap.currentLocation = quarterId;
            game.cityMap.currentBuilding = null;
            updateLocationDisplay();
            updateUI();
            showNotification(` Sei arrivato a ${hood.name}!`);
            showDetailedQuarterMap(quarterId);
        }
    }
    
    function switchMapView(view) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if (view === 'overview') {
            document.getElementById('overviewMapContent').style.display = 'block';
            document.getElementById('detailedMapContent').style.display = 'none';
            // Nascondi la mappa dettagliata se era aperta
            const detailedMap = document.getElementById('detailedQuarterMap');
            if (detailedMap) detailedMap.classList.remove('active');
            const overviewGrid = document.getElementById('overviewMapGrid');
            if (overviewGrid) overviewGrid.style.display = 'grid';
            // Reinizializza i marker della vista overview
            initializeVisualMap();
        } else {
            // NUOVO: mostra la mappa grafica del quartiere corrente
            const currentQuarter = game.cityMap?.currentLocation || 'periferia';
            showDetailedQuarterMap(currentQuarter);
        }
    }
    
    function updateLocationDisplay() {
        const locText = document.getElementById('currentLocationText');
        if (!locText) return;
        
        const neighborhood = game.cityMap?.currentLocation || 'periferia';
        const building = game.cityMap?.currentBuilding;
        
        let text = `${NEIGHBORHOODS[neighborhood]?.name || neighborhood}`;
        if (building) {
            const location = findLocationById(building);
            if (location) {
                text += `  ${location.name}`;
            }
        }
        locText.textContent = text;
    }

    function switchMainTab(name) {
        // Open menu sidebar and show content
        const menuSidebar = document.getElementById('menuSidebar');
        menuSidebar.style.transform = 'translateX(0px)';
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const id = name + 'TabContent';
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
        
        game.currentTab = name;
    }

    // ---------- SCREENS ----------
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // ---------- SAVE/LOAD ----------
    function saveGame() {
        try {
            localStorage.setItem('cityLifeSave', JSON.stringify(game));
            showNotification(' Partita salvata!', 1400);
        } catch (e) {
            showNotification(' Errore nel salvataggio', 1500);
        }
    }

    function loadGame() {
        const saved = localStorage.getItem('cityLifeSave');
        if (!saved) {
            showNotification(' Nessun salvataggio trovato', 1600);
            return;
        }

        try {
            game = JSON.parse(saved);
            
            // Initialize companies if not present (backward compatibility)
            if (!game.companies) {
                game.companies = {};
                initializeCompanies();
            } else {
                // Regenerate stocks from companies
                generateStocksFromCompanies();
            }
            
            showNotification(' Partita caricata!', 1200);
            showScreen('gameScreen');
            updateUI();
            
            // Initialize map view
            setTimeout(() => {
                renderDetailedMap(game.cityMap?.currentLocation || game.housing?.neighborhood || 'periferia');
                updatePlayerMarker();
            }, 100);
        } catch (e) {
            showNotification(' Errore nel caricamento', 1500);
        }
    }

    function checkSavedGame() {
        const saved = localStorage.getItem('cityLifeSave');
        // Could show a "Continue" button on home screen if save exists
    }

    function backToMenu() {
        if (confirm('Vuoi tornare al menu principale? (Ricordati di salvare!)')) {
            showScreen('homeScreen');
        }
    }

    // ---------- NOTIFICATIONS ----------
    function showNotification(msg, duration = 2000) {
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.innerText = msg;
        document.body.appendChild(notif);

        setTimeout(() => {
            notif.style.opacity = '0';
            notif.style.transform = 'translateX(100px)';
            setTimeout(() => notif.remove(), 300);
        }, duration);
    }

    // ---------- TUTORIAL ----------
    function showTutorial() {
        showNotification(' Tutorial: Usa i pulsanti per svolgere azioni. Gestisci le tue statistiche, trova lavoro, fai amicizie e completa missioni. Buon divertimento!', 4000);
    }

    // ---------- HOUSING SYSTEM ----------
    function renderCurrentHousing() {
        const div = $('currentHousingInfo');
        if (!div || !game.housing) return;

        // Check if homeless
        if (game.player.isHomeless || !game.housing.residenceId) {
            div.innerHTML = `
                <div style="padding:16px; background:rgba(235,51,73,0.15); border-radius:12px; border:2px solid var(--danger);">
                    <h4 style="margin-bottom:12px; color:var(--danger);"> SENZATETTO</h4>
                    <p style="opacity:0.9; margin-bottom:12px;">Vivi per strada. Devi trovare una casa!</p>
                    
                    <div style="padding:12px; background:rgba(0,0,0,0.3); border-radius:8px; margin-bottom:12px;">
                        <div style="color:var(--danger); font-weight:bold; margin-bottom:8px;"> Penalit Giornaliere:</div>
                        <div style="font-size:0.9rem; opacity:0.9;">
                             -30 Morale<br>
                             -20 Salute<br>
                             -15 Energia<br>
                             -40% Prestazioni al lavoro<br>
                             Rischio licenziamento aumentato<br>
                             Impossibile lavarsi (-10 Igiene)
                        </div>
                    </div>

                    <button onclick="showHousingMarket()" class="action-btn" style="width:100%; margin-top:8px;">
                         Cerca un'Abitazione
                    </button>
                </div>
            `;
            return;
        }

        // Find residence data
        const residence = findResidenceById(game.housing.residenceId);
        if (!residence) return;

        const hood = NEIGHBORHOODS[game.housing.neighborhood];
        const daysSinceRent = game.time.day - game.lastRentPayment;
        const daysUntilRent = 30 - daysSinceRent;

        div.innerHTML = `
            <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px; border:2px solid ${game.housing.rentPaid ? 'var(--success)' : 'var(--danger)'};">
                <h4 style="margin-bottom:12px;"> ${residence.name}</h4>
                <p style="opacity:0.8; margin-bottom:8px; font-size:0.9rem;"> ${residence.street}, ${hood.name}</p>
                <p style="opacity:0.9; margin-bottom:12px;">${hood.description}</p>
                
                <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap:8px; margin-bottom:12px;">
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Qualit</div>
                        <div style="font-weight:bold;">${hood.quality}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Servizi</div>
                        <div style="font-weight:bold;">${hood.services}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Sicurezza</div>
                        <div style="font-weight:bold;">${hood.safety}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Costo Cibo</div>
                        <div style="font-weight:bold;">${hood.foodMultiplier}x</div>
                    </div>
                </div>

                ${game.housing.owned ? `
                    <div style="padding:12px; background:rgba(56,239,125,0.15); border-radius:8px; margin-bottom:12px;">
                        <div style="color:var(--success); font-weight:bold;"> PROPRIET DI TUA PROPRIET</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">Valore: ${residence.buyPrice}</div>
                    </div>
                ` : `
                    <div style="padding:12px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:0.85rem; opacity:0.8;">Affitto Mensile</div>
                                <div style="font-weight:bold; font-size:1.2rem; color:var(--warning);">${residence.rent}/30 giorni</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.85rem; opacity:0.8;">Prossimo Pagamento</div>
                                <div style="font-weight:bold;">${daysUntilRent} giorni</div>
                            </div>
                        </div>
                    </div>
                `}

                ${!game.housing.rentPaid && !game.housing.owned ? '<div style="padding:10px; background:rgba(235,51,73,0.2); border-radius:8px; color:var(--danger); text-align:center; font-weight:bold;"> AFFITTO SCADUTO!</div>' : ''}
                
                <button onclick="showHousingMarket()" class="action-btn" style="width:100%; margin-top:8px;">
                     Cambia Abitazione
                </button>
            </div>
        `;
    }

    // ---------- HOUSING MARKET ----------
    // Helper to find residence by ID
    function findResidenceById(residenceId) {
        for (let neighborhood in CITY_LOCATIONS) {
            const locations = CITY_LOCATIONS[neighborhood];
            const residence = locations.find(loc => loc.id === residenceId);
            if (residence) return residence;
        }
        return null;
    }

    function showHousingMarket() {
        // CITY_LOCATIONS  un oggetto con chiavi per quartiere (periferia, quartiere_operaio, etc)
        // Ogni quartiere ha un array di locations
        const byNeighborhood = {};
        
        // Iterate through each neighborhood in CITY_LOCATIONS
        Object.keys(CITY_LOCATIONS).forEach(neighborhoodKey => {
            const locations = CITY_LOCATIONS[neighborhoodKey];
            const residences = locations.filter(loc => loc.type === 'residence');
            
            if (residences.length > 0) {
                byNeighborhood[neighborhoodKey] = residences;
            }
        });

        let html = `
            <div style="max-height:70vh; overflow-y:auto; padding:16px;">
                <h3 style="margin-bottom:16px;"> Mercato Immobiliare</h3>
                
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:0.9rem; opacity:0.8;">Disponibile</div>
                            <div style="font-weight:bold; font-size:1.2rem;"> ${game.player.cash.toFixed(0)}</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; opacity:0.8;">Banca</div>
                            <div style="font-weight:bold; font-size:1.2rem;"> ${game.player.bankDeposit.toFixed(0)}</div>
                        </div>
                    </div>
                </div>

                <div style="padding:14px; background:rgba(235,51,73,0.15); border-radius:10px; margin-bottom:16px; border:2px solid var(--danger);">
                    <h4 style="color:var(--danger); margin-bottom:8px;"> Vivi per Strada (Gratis)</h4>
                    <p style="font-size:0.85rem; opacity:0.9; margin-bottom:10px;">
                        Non hai soldi? Puoi vivere come senzatetto, ma con gravi conseguenze.
                    </p>
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:10px;">
                         Penalit: -30 Morale, -20 Salute, -15 Energia al giorno<br>
                         Rischio licenziamento aumentato (-40% prestazioni)<br>
                         Impossibile lavarsi (-10 Igiene al giorno)
                    </div>
                    <button onclick="becomeHomeless()" class="action-btn" style="background:var(--danger); width:100%;">
                        Vivi per Strada
                    </button>
                </div>
        `;

        // List residences by neighborhood
        Object.keys(byNeighborhood).forEach(hoodKey => {
            const hood = NEIGHBORHOODS[hoodKey];
            const residences = byNeighborhood[hoodKey];
            
            html += `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                         ${hood.name}
                    </h4>
                    <div style="font-size:0.85rem; opacity:0.7; margin-bottom:10px;">
                         Qualit ${hood.quality}% |  Sicurezza ${hood.safety}% |  Servizi ${hood.services}%
                    </div>
                    
                    ${residences.map(res => {
                        const isCurrent = game.housing.residenceId === res.id;
                        const canAffordRent = game.player.cash >= res.rent;
                        const canAffordBuy = (game.player.cash + game.player.bankDeposit) >= res.buyPrice;
                        
                        // Generate bonuses display
                        let bonusesHtml = '';
                        if (res.bonuses) {
                            const bonusItems = [];
                            if (res.bonuses.energy > 0) bonusItems.push(` +${res.bonuses.energy} Energia`);
                            if (res.bonuses.morale > 0) bonusItems.push(` +${res.bonuses.morale} Morale`);
                            if (res.bonuses.hygiene > 0) bonusItems.push(` +${res.bonuses.hygiene} Igiene`);
                            if (res.bonuses.health > 0) bonusItems.push(` +${res.bonuses.health} Salute`);
                            if (res.bonuses.stressReduction > 0) bonusItems.push(` -${res.bonuses.stressReduction} Stress`);
                            bonusesHtml = `<div style="font-size:0.75rem; opacity:0.85; margin-top:6px; color:#38ef7d;">${bonusItems.join(' | ')}</div>`;
                        }
                        
                        return `
                            <div style="padding:12px; background:rgba(255,255,255,${isCurrent ? '0.12' : '0.06'}); border-radius:8px; margin-bottom:10px; border:2px solid ${isCurrent ? 'var(--primary)' : 'transparent'};">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; margin-bottom:4px;">
                                            ${isCurrent ? ' ' : ''}${res.name}
                                        </div>
                                        <div style="font-size:0.8rem; opacity:0.7;"> ${res.street}</div>
                                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;"> ${res.residents} residenti</div>
                                        ${bonusesHtml}
                                    </div>
                                    <div style="text-align:right; min-width:120px;">
                                        <div style="font-size:0.85rem; opacity:0.8;">Affitto</div>
                                        <div style="font-weight:bold; color:var(--warning);">${res.rent}/mese</div>
                                        <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">Acquisto: ${res.buyPrice}</div>
                                    </div>
                                </div>
                                
                                ${!isCurrent ? `
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
                                        <button 
                                            onclick="rentResidence('${res.id}')" 
                                            class="action-btn" 
                                            ${!canAffordRent ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}
                                            style="font-size:0.85rem; padding:8px;">
                                             Affitta ${!canAffordRent ? '(Non hai abbastanza contante)' : ''}
                                        </button>
                                        <button 
                                            onclick="buyResidence('${res.id}')" 
                                            class="action-btn" 
                                            ${!canAffordBuy ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}
                                            style="font-size:0.85rem; padding:8px; background:var(--success);">
                                             Acquista ${!canAffordBuy ? '(Fondi insufficienti)' : ''}
                                        </button>
                                    </div>
                                ` : `
                                    <div style="text-align:center; padding:8px; background:rgba(56,239,125,0.2); border-radius:6px; color:var(--success);">
                                         La tua casa attuale
                                    </div>
                                `}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        });

        html += `
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;

        showDialog(html);
    }

    function rentResidence(residenceId) {
        const residence = findResidenceById(residenceId);
        if (!residence || !residence.landlord) return;

        const landlord = residence.landlord;
        
        // Check if landlord accepts rent
        if (!landlord.acceptsRent) {
            showLandlordResponse(landlord, 'rent_refused', residence);
            return;
        }

        if (game.player.cash < residence.rent) {
            showNotification(' Non hai abbastanza contante per pagare l\'affitto!', 2500);
            return;
        }

        // Show negotiation dialog
        showLandlordNegotiation(residence, 'rent');
    }

    function buyResidence(residenceId) {
        const residence = findResidenceById(residenceId);
        if (!residence || !residence.landlord) return;

        const landlord = residence.landlord;
        
        // Check if landlord accepts sale
        if (!landlord.acceptsSale) {
            showLandlordResponse(landlord, 'sale_refused', residence);
            return;
        }

        const totalMoney = game.player.cash + game.player.bankDeposit;
        if (totalMoney < residence.buyPrice) {
            showNotification(' Non hai abbastanza soldi per acquistare questa propriet!', 2500);
            return;
        }

        // Show negotiation dialog
        showLandlordNegotiation(residence, 'buy');
    }

    function showLandlordNegotiation(residence, type) {
        const landlord = residence.landlord;
        const isRent = type === 'rent';
        const price = isRent ? residence.rent : residence.buyPrice;
        
        // Calculate possible discount based on personality
        let discount = 0;
        let discountText = '';
        
        if (landlord.negotiable) {
            if (landlord.personality === 'friendly') {
                discount = Math.floor(price * 0.10); // 10% discount
                discountText = '  una persona amichevole e potrebbe farti uno sconto!';
            } else if (landlord.personality === 'neutral') {
                discount = Math.floor(price * 0.05); // 5% discount
                discountText = ' Potrebbe considerare una piccola riduzione.';
            } else if (landlord.personality === 'professional') {
                discount = Math.floor(price * 0.07); // 7% discount
                discountText = '  un professionista, puoi provare a negoziare.';
            }
        }
        
        let personalityDesc = '';
        switch(landlord.personality) {
            case 'friendly': personalityDesc = ' Persona amichevole e disponibile'; break;
            case 'strict': personalityDesc = ' Persona rigida, non negoziabile'; break;
            case 'neutral': personalityDesc = ' Persona neutrale'; break;
            case 'professional': personalityDesc = ' Persona professionale'; break;
            case 'greedy': personalityDesc = ' Interessato solo al denaro'; break;
            case 'selective': personalityDesc = ' Molto selettivo con gli inquilini'; break;
            case 'arrogant': personalityDesc = ' Persona arrogante'; break;
        }

        const finalPrice = price - discount;
        
        const html = `
            <div style="padding:20px; max-width:600px;">
                <h3 style="margin-bottom:16px;"> Incontro con il Proprietario</h3>
                
                <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <div style="font-size:3rem;"></div>
                        <div>
                            <div style="font-weight:bold; font-size:1.2rem;">${landlord.name}</div>
                            <div style="font-size:0.9rem; opacity:0.8;">${landlord.age} anni</div>
                            <div style="font-size:0.85rem; opacity:0.7; margin-top:4px;">${personalityDesc}</div>
                        </div>
                    </div>
                    
                    <div style="padding:12px; background:rgba(0,0,0,0.2); border-radius:8px; margin-top:12px;">
                        <div style="font-style:italic; opacity:0.9;">
                            "${getQuote(landlord.personality, isRent)}"
                        </div>
                    </div>
                </div>

                <div style="padding:16px; background:rgba(56,159,239,0.15); border-radius:12px; margin-bottom:16px;">
                    <h4 style="margin-bottom:12px;"> ${residence.name}</h4>
                    <div style="font-size:0.9rem; opacity:0.8; margin-bottom:8px;"> ${residence.street}</div>
                    
                    <div style="margin-top:12px; padding-top:12px; border-top:2px solid rgba(255,255,255,0.1);">
                        ${landlord.negotiable && discount > 0 ? `
                            <div style="margin-bottom:10px;">
                                <div style="text-decoration:line-through; opacity:0.6;">Prezzo originale: ${price}</div>
                                <div style="font-size:1.3rem; font-weight:bold; color:var(--success);">
                                    ${isRent ? 'Affitto' : 'Prezzo'}: ${finalPrice} ${discount > 0 ? '(-' + discount + ')' : ''}
                                </div>
                                <div style="font-size:0.8rem; color:var(--success); margin-top:4px;">
                                     ${discountText}
                                </div>
                            </div>
                        ` : `
                            <div style="font-size:1.3rem; font-weight:bold; color:var(--warning);">
                                ${isRent ? 'Affitto' : 'Prezzo'}: ${price}
                            </div>
                            <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">
                                 Prezzo non negoziabile
                            </div>
                        `}
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <button onclick="confirmHousingDeal('${residence.id}', '${type}', ${finalPrice})" class="action-btn" style="background:var(--success);">
                         ${isRent ? 'Affitta' : 'Acquista'}
                    </button>
                    <button onclick="closeDialog()" class="action-btn" style="background:var(--danger);">
                         Rifiuta
                    </button>
                </div>
            </div>
        `;

        showDialog(html);
    }

    function getQuote(personality, isRent) {
        const quotes = {
            friendly: {
                rent: [
                    'Ciao! Cerco qualcuno di affidabile per questa casa. Sei la persona giusta?',
                    'Mi sembri una brava persona, sono sicuro che ci prenderai cura!',
                    'Benvenuto! Sar felice di averti come inquilino.'
                ],
                buy: [
                    'Ho deciso di vendere, ma voglio che vada a qualcuno che la apprezzi.',
                    ' un posto speciale, me ne prendo cura da anni.',
                    'Sono contento di trovare un acquirente serio come te.'
                ]
            },
            strict: {
                rent: [
                    'Le regole sono chiare: affitto puntuale ogni mese, nessun ritardo.',
                    'Non accetto scuse. Pagamento il primo del mese, senza eccezioni.',
                    'Ho standard molto alti. Sei in grado di rispettarli?'
                ],
                buy: [
                    'Il prezzo  quello, non c\' margine di trattativa.',
                    'O lo prendi a questo prezzo o cerco qualcun altro.',
                    'Non ho tempo da perdere. Sei interessato o no?'
                ]
            },
            neutral: {
                rent: [
                    'Le condizioni sono standard. Se sei d\'accordo, possiamo procedere.',
                    'Ecco il contratto. Dai un\'occhiata e fammi sapere.',
                    'Cerco un inquilino affidabile. Tu lo sei?'
                ],
                buy: [
                    'Il prezzo  in linea con il mercato. Cosa ne pensi?',
                    'Se sei seriamente interessato, possiamo parlarne.',
                    'Fammi un\'offerta ragionevole e la valuter.'
                ]
            },
            professional: {
                rent: [
                    'Ho preparato tutta la documentazione necessaria. Vuoi esaminarla?',
                    'Possiamo discutere i termini del contratto in modo professionale.',
                    'Lavoro solo con persone serie e affidabili.'
                ],
                buy: [
                    'Ho fatto una valutazione professionale dell\'immobile.',
                    'La documentazione  in regola, possiamo procedere rapidamente.',
                    'Il prezzo riflette il valore di mercato attuale.'
                ]
            },
            greedy: {
                rent: [
                    'L\'affitto potrebbe sembrare alto, ma ne vale la pena.',
                    'Questo quartiere sta diventando costoso, considerati fortunato.',
                    'Ho altre persone interessate, devi decidere subito.'
                ],
                buy: [
                    'Questo  un investimento, il valore salir sicuramente.',
                    'Altri compratori offrono di pi, ma ti do questa possibilit.',
                    'Il prezzo tiene gi conto di uno "sconto speciale".'
                ]
            },
            selective: {
                rent: [
                    'Seleziono accuratamente i miei inquilini. Parlami di te.',
                    'Non affitto a chiunque. Devo sapere che tipo di persona sei.',
                    'Questo posto merita qualcuno di speciale.'
                ],
                buy: [
                    'Non vendo a chiunque. Devo essere sicuro che sia la scelta giusta.',
                    'Voglio che questa casa vada a qualcuno che la rispetti.',
                    'Prima di vendere, devo conoscerti meglio.'
                ]
            },
            arrogant: {
                rent: [
                    'Dovresti sentirti fortunato che io stia considerando la tua richiesta.',
                    'Ho standard molto alti. Sei all\'altezza?',
                    'Normalmente affitto solo a persone... di un certo livello.'
                ],
                buy: [
                    'Dubito che tu possa permettertelo, ma dimmi pure.',
                    'Questa propriet  per chi ha... un certo status.',
                    'Sei sicuro di potertelo permettere?'
                ]
            }
        };

        const category = isRent ? 'rent' : 'buy';
        const options = quotes[personality] ? quotes[personality][category] : quotes.neutral[category];
        return options[Math.floor(Math.random() * options.length)];
    }

    function showLandlordResponse(landlord, responseType, residence) {
        let message = '';
        let emoji = '';
        
        switch(responseType) {
            case 'rent_refused':
                emoji = '';
                if (landlord.personality === 'strict') {
                    message = `${landlord.name} scuote la testa: "Non affitto pi. Devi cercare altrove."`;
                } else if (landlord.personality === 'arrogant') {
                    message = `${landlord.name} ti guarda dall'alto in basso: "Questo immobile non  per chiunque. Buona fortuna altrove."`;
                } else {
                    message = `${landlord.name} si scusa: "Mi dispiace, ma al momento non affitto. Prova con altri immobili."`;
                }
                break;
                
            case 'sale_refused':
                emoji = '';
                if (landlord.personality === 'greedy') {
                    message = `${landlord.name} sorride: "Vendere? Mai! Questo  il mio patrimonio!"`;
                } else if (landlord.personality === 'arrogant') {
                    message = `${landlord.name} ti respinge: "Non vendo a chiunque. Decisamente non a te."`;
                } else {
                    message = `${landlord.name}  fermo: "Non ho intenzione di vendere.  fuori discussione."`;
                }
                break;
        }

        const html = `
            <div style="padding:20px; max-width:400px; text-align:center;">
                <div style="font-size:4rem; margin-bottom:16px;">${emoji}</div>
                <div style="font-size:1.1rem; margin-bottom:20px; font-style:italic; opacity:0.9;">
                    "${message}"
                </div>
                <button onclick="closeDialog(); showHousingMarket();" class="action-btn" style="width:100%;">
                    Torna al Mercato
                </button>
            </div>
        `;

        showDialog(html);
    }

    function confirmHousingDeal(residenceId, type, finalPrice) {
        const residence = findResidenceById(residenceId);
        if (!residence) return;

        const isRent = type === 'rent';

        if (isRent) {
            if (game.player.cash < finalPrice) {
                showNotification(' Non hai abbastanza contante!', 2500);
                return;
            }

            // Pay rent
            game.player.cash -= finalPrice;
            
            // Update housing
            const hood = residenceId.substring(0, 5);
            let hoodKey;
            if (hood === 'loc_p') hoodKey = 'periferia';
            else if (hood === 'loc_o') hoodKey = 'quartiere_operaio';
            else if (hood === 'loc_c') hoodKey = 'centro_storico';
            else if (hood === 'loc_r') hoodKey = 'zona_residenziale';
            else if (hood === 'loc_l') hoodKey = 'quartiere_lusso';
            
            game.housing.neighborhood = hoodKey;
            game.housing.residenceId = residenceId;
            game.housing.rentPaid = true;
            game.housing.owned = false;
            game.lastRentPayment = game.time.day;
            game.player.isHomeless = false;
            
            // Update location
            game.cityMap.currentLocation = hoodKey;
            game.cityMap.currentBuilding = 'home';
            
            showNotification(` Hai affittato ${residence.name}! Primo mese pagato: ${finalPrice}`, 3000);
            
        } else {
            // Buy
            if (!payMoney(finalPrice)) {
                showNotification(' Fondi insufficienti!', 2500);
                return;
            }

            // Update housing
            const hood = residenceId.substring(0, 5);
            let hoodKey;
            if (hood === 'loc_p') hoodKey = 'periferia';
            else if (hood === 'loc_o') hoodKey = 'quartiere_operaio';
            else if (hood === 'loc_c') hoodKey = 'centro_storico';
            else if (hood === 'loc_r') hoodKey = 'zona_residenziale';
            else if (hood === 'loc_l') hoodKey = 'quartiere_lusso';
            
            game.housing.neighborhood = hoodKey;
            game.housing.residenceId = residenceId;
            game.housing.rentPaid = true;
            game.housing.owned = true;
            game.player.isHomeless = false;
            
            // Update location
            game.cityMap.currentLocation = hoodKey;
            game.cityMap.currentBuilding = 'home';
            
            showNotification(` Congratulazioni! Hai acquistato ${residence.name} per ${finalPrice}!`, 3000);
        }

        closeDialog();
        updateUI();
        updatePlayerMarker();
    }

    function becomeHomeless() {
        if (!confirm(' Sei sicuro di voler vivere per strada? Subirai gravi penalit ogni giorno!')) {
            return;
        }

        game.housing.neighborhood = 'periferia'; // Default location
        game.housing.residenceId = null;
        game.housing.rentPaid = false;
        game.housing.owned = false;
        game.player.isHomeless = true;
        
        game.cityMap.currentLocation = 'periferia';
        game.cityMap.currentBuilding = 'street';
        
        showNotification(' Ora sei senzatetto. Ogni giorno sar una lotta per sopravvivere...', 4000);
        closeDialog();
        updateUI();
        updatePlayerMarker();
    }

    function renderNeighborhoods() {
        const div = $('neighborhoodsList');
        if (!div) return;

        div.innerHTML = Object.keys(NEIGHBORHOODS).map(key => {
            const hood = NEIGHBORHOODS[key];
            const isCurrent = game.housing && game.housing.neighborhood === key;
            const canAfford = game.player.money >= hood.rent;

            return `
                <div style="padding:14px; background:rgba(255,255,255,${isCurrent ? '0.1' : '0.05'}); border-radius:10px; margin-bottom:10px; border:2px solid ${isCurrent ? 'var(--primary)' : 'transparent'};">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                            <h4 style="margin-bottom:4px;">${isCurrent ? ' ' : ''}${hood.name}</h4>
                            <p style="font-size:0.85rem; opacity:0.8;">${hood.description}</p>
                        </div>
                        <div style="text-align:right; min-width:100px;">
                            <div style="font-weight:bold; color:var(--warning); font-size:1.1rem;">${hood.rent}</div>
                            <div style="font-size:0.8rem; opacity:0.7;">/mese</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:10px; font-size:0.8rem;">
                        <div> ${hood.quality}%</div>
                        <div> ${hood.services}%</div>
                        <div> ${hood.safety}%</div>
                        <div> ${hood.foodMultiplier}x</div>
                    </div>

                    ${!isCurrent ? `<button class="small" onclick="moveToNeighborhood('${key}')" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? 'Trasferisciti' : 'Non puoi permettertelo'}
                    </button>` : '<div style="text-align:center; padding:6px; background:rgba(102,126,234,0.2); border-radius:6px; font-size:0.85rem;"> Casa Attuale</div>'}
                </div>
            `;
        }).join('');
    }

    function moveToNeighborhood(neighborhoodKey) {
        const hood = NEIGHBORHOODS[neighborhoodKey];
        
        if (game.player.money < hood.rent) {
            showNotification(' Non hai abbastanza soldi!', 1500);
            return;
        }

        if (confirm(`Vuoi trasferirti in ${hood.name}? Coster ${hood.rent} per il primo mese.`)) {
            game.player.money -= hood.rent;
            game.housing.neighborhood = neighborhoodKey;
            game.housing.rentPaid = true;
            game.lastRentPayment = game.time.day;
            
            showNotification(` Ti sei trasferito in ${hood.name}!`, 2000);
            updateUI();
        }
    }

    // ---------- FOOD SYSTEM ----------
    function renderFoodShop() {
        const div = $('foodShop');
        if (!div) return;

        const multiplier = game.housing ? NEIGHBORHOODS[game.housing.neighborhood].foodMultiplier : 1;

        div.innerHTML = Object.keys(FOOD_ITEMS).map(key => {
            const item = FOOD_ITEMS[key];
            const finalCost = Math.ceil(item.cost * multiplier);
            const canBuy = game.player.money >= finalCost;

            return `
                <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:10px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="font-weight:bold; margin-bottom:4px;">${item.name}</div>
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">
                         +${item.hunger}% fame<br>
                         Scade in ${item.expires} giorni
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:bold; color:var(--warning);">${finalCost}</div>
                        <button class="small" onclick="buyFood('${key}')" ${!canBuy ? 'disabled' : ''}>
                            Compra
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function buyFood(itemKey) {
        // Controlla se sei fisicamente al supermercato
        const currentBuilding = game.cityMap?.currentBuilding;
        let isAtSupermarket = false;
        
        // Cerca se la location corrente  un supermercato
        if (currentBuilding) {
            for (let hood in CITY_LOCATIONS) {
                const location = CITY_LOCATIONS[hood].find(loc => loc.id === currentBuilding);
                if (location && (location.business === 'supermercato' || location.business === 'minimarket')) {
                    isAtSupermarket = true;
                    break;
                }
            }
        }
        
        if (!isAtSupermarket) {
            showNotification(' Devi andare fisicamente al supermercato per comprare cibo!', 3000);
            return;
        }
        
        const item = FOOD_ITEMS[itemKey];
        const multiplier = game.housing ? NEIGHBORHOODS[game.housing.neighborhood].foodMultiplier : 1;
        const finalCost = Math.ceil(item.cost * multiplier);

        if (game.player.money < finalCost) {
            showNotification(' Non hai abbastanza soldi!', 1500);
            return;
        }

        game.player.money -= finalCost;
        game.inventory.food.push({
            id: itemKey,
            boughtDay: game.time.day
        });

        showNotification(` Hai comprato ${item.name} per ${finalCost}`, 1500);
        updateUI();
    }

    function renderFoodInventory() {
        const div = $('foodInventory');
        if (!div) return;

        // Remove expired food
        game.inventory.food = game.inventory.food.filter(f => {
            const item = FOOD_ITEMS[f.id];
            const daysSinceBought = game.time.day - f.boughtDay;
            return daysSinceBought < item.expires;
        });

        if (game.inventory.food.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; padding:12px; text-align:center;">Inventario vuoto! Vai al supermercato.</p>';
            return;
        }

        // Group food by type
        const foodCounts = {};
        game.inventory.food.forEach(f => {
            foodCounts[f.id] = (foodCounts[f.id] || 0) + 1;
        });

        div.innerHTML = Object.keys(foodCounts).map(key => {
            const item = FOOD_ITEMS[key];
            const count = foodCounts[key];
            const oldestItem = game.inventory.food.find(f => f.id === key);
            const daysSinceBought = game.time.day - oldestItem.boughtDay;
            const daysLeft = item.expires - daysSinceBought;

            return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:6px; border-left:3px solid ${daysLeft <= 1 ? 'var(--danger)' : daysLeft <= 3 ? 'var(--warning)' : 'var(--success)'};">
                    <div>
                        <span style="font-weight:bold;">${item.name}</span>
                        <span style="opacity:0.7; margin-left:8px;">x${count}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem; opacity:0.8;">Scade: ${daysLeft}g</div>
                        <button class="small" onclick="eatFood('${key}')" style="margin-top:4px;">Mangia</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function cookFood() {
        // Check if player has ingredients
        if (game.inventory.food.length < 2) {
            showNotification(' Hai bisogno di almeno 2 ingredienti per cucinare!', 2000);
            return;
        }

        // Use 2 random ingredients
        const removed = [];
        for (let i = 0; i < 2; i++) {
            const randomIndex = randInt(0, game.inventory.food.length - 1);
            const food = game.inventory.food[randomIndex];
            removed.push(FOOD_ITEMS[food.id].name);
            game.inventory.food.splice(randomIndex, 1);
        }

        // Cooking gives more hunger satisfaction
        const hungerGain = 45;
        game.player.stats.hunger = clamp(game.player.stats.hunger + hungerGain);
        game.player.stats.morale = clamp(game.player.stats.morale + 10);
        game.player.stats.energy = clamp(game.player.stats.energy - 10);

        passTime(2);
        showNotification(` Hai cucinato usando ${removed.join(' e ')}! +${hungerGain}% fame`, 2000);
        updateUI();
    }

    // ---------- ECONOMIC SYSTEM ----------
    function checkRentPayment() {
        // Skip if homeless or owns property
        if (game.player.isHomeless || game.housing.owned) return;
        
        const daysSinceRent = game.time.day - game.lastRentPayment;
        
        if (daysSinceRent >= 30) {
            const residence = findResidenceById(game.housing.residenceId);
            const rent = residence ? residence.rent : 0;
            
            if (rent > 0) {
                if (payMoney(rent)) {
                    game.lastRentPayment = game.time.day;
                    game.housing.rentPaid = true;
                    showNotification(` Hai pagato l'affitto: ${rent}`, 2500);
                } else {
                    game.housing.rentPaid = false;
                    showNotification(` Non hai abbastanza soldi per l'affitto! Rischi lo sfratto!`, 3000);
                    game.player.stats.morale = clamp(game.player.stats.morale - 20);
                    
                    // After 2 months unpaid, become homeless
                    if (daysSinceRent >= 60) {
                        game.player.isHomeless = true;
                        game.housing.residenceId = null;
                        showNotification(' Sei stato sfrattato! Ora sei senzatetto!', 5000);
                    }
                }
            }
            updateUI();
        }
    }

    function checkTaxPayment() {
        const daysSinceTax = game.time.day - game.lastTaxPayment;
        
        if (daysSinceTax >= 90) {
            const taxRate = 0.10;
            const taxes = Math.floor(game.player.totalEarned * taxRate);
            
            if (taxes > 0) {
                if (payMoney(taxes)) {
                    game.lastTaxPayment = game.time.day;
                    game.player.totalEarned = 0;
                    showNotification(` Hai pagato le tasse: ${taxes} (10% del reddito)`, 2500);
                } else {
                    showNotification(` Non hai abbastanza soldi per le tasse! Penalit applicata.`, 3000);
                    game.player.stats.morale = clamp(game.player.stats.morale - 15);
                    game.player.rep = clamp(game.player.rep - 5, 0, 100);
                    game.lastTaxPayment = game.time.day;
                }
            } else {
                game.lastTaxPayment = game.time.day;
            }
            updateUI();
        }
    }

    // ---------- VISUAL MAP FUNCTIONS ----------
    function selectQuarterFromMap(quarterId) {
        // Switch to detailed view and show this quarter
        showDetailedQuarterMap(quarterId);
    }
    
    // Helper function to render stats for quarter details
    function renderStatsForQuarter() {
        const stats = [
            { 
                key: 'money', 
                icon: '', 
                label: 'Denaro', 
                value: `${game.player.money.toFixed(2)}`,
                tooltip: game.player.money < 100 ? 'Denaro basso! Cerca lavoro nei negozi o negli uffici.' : 'Situazione finanziaria stabile.'
            },
            { 
                key: 'happiness', 
                icon: '', 
                label: 'Felicit', 
                value: `${Math.round(game.player.happiness)}/100`,
                tooltip: game.player.happiness < 30 ? 'Morale basso! Socializza, vai al cinema o a mangiare fuori.' : game.player.happiness < 60 ? 'Morale nella media. Prova attivit divertenti.' : 'Ottimo morale!'
            },
            { 
                key: 'energy', 
                icon: '', 
                label: 'Energia', 
                value: `${Math.round(game.player.energy)}/100`,
                tooltip: game.player.energy < 30 ? 'Energia bassa! Riposati a casa o trova un alloggio.' : game.player.energy < 60 ? 'Energia moderata. Considera di riposare.' : 'Pieno di energie!'
            },
            { 
                key: 'hygiene', 
                icon: '', 
                label: 'Igiene', 
                value: `${Math.round(game.player.hygiene)}/100`,
                tooltip: game.player.hygiene < 30 ? 'Igiene scarsa! Trova un bagno pubblico o un alloggio.' : game.player.hygiene < 60 ? 'Igiene moderata. Dovresti lavarti.' : 'Pulito e fresco!'
            },
            { 
                key: 'hunger', 
                icon: '', 
                label: 'Fame', 
                value: `${Math.round(game.player.hunger)}/100`,
                tooltip: game.player.hunger < 30 ? 'Molto affamato! Vai al supermercato o al ristorante.' : game.player.hunger < 60 ? 'Un po\' affamato. Cerca del cibo.' : 'Sazio e soddisfatto!'
            }
        ];
        
        return stats.map(stat => {
            const value = game.player[stat.key];
            const percentage = Math.round(value);
            let colorClass = 'stat-good';
            if (percentage < 30) colorClass = 'stat-critical';
            else if (percentage < 60) colorClass = 'stat-warning';
            
            return `
                <div class="stat-item quarter-detail-stat ${colorClass}" data-tooltip="${stat.tooltip}">
                    <span class="stat-icon">${stat.icon}</span>
                    <span class="stat-label">${stat.label}</span>
                    <span class="stat-value">${stat.value}</span>
                </div>
            `;
        }).join('');
    }

    function renderDetailedMap(quarterId) {
        const container = document.getElementById('detailedMapContainer');
        if (!container) return;
        
        const quarter = quarterId || game.cityMap.currentLocation || 'periferia';
        const locations = CITY_LOCATIONS[quarter] || [];
        const neighborhood = NEIGHBORHOODS[quarter];
        const isCurrentLocation = quarter === game.cityMap.currentLocation;
        
        // Get local NPCs for this quarter
        const localNpcs = game.npcs ? game.npcs.filter(npc => npc.location === quarter) : [];
        
        container.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 16px;">
                <!-- Quarter Info -->
                <div>
                    <h3 style="margin:0 0 8px 0;">${neighborhood.icon} ${neighborhood.name}</h3>
                    <p style="opacity:0.8; margin:0 0 12px 0;">${neighborhood.description}</p>
                    ${isCurrentLocation ? '<div style="color: #4CAF50; font-weight: bold; margin-bottom: 12px;"> Ti trovi qui attualmente</div>' : ''}
                </div>
                
                <!-- Info Panel -->
                <div style="background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(255,255,255,0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(102,126,234,0.3);">
                    ${isCurrentLocation ? `
                        <!-- Current Location Stats -->
                        <h4 style="margin: 0 0 10px 0; color: #667eea;"> Le tue statistiche</h4>
                        <div id="quarterDetailStats" style="margin-bottom: 15px;">
                            ${renderStatsForQuarter()}
                        </div>
                    ` : ''}
                    
                    <!-- NPCs in this quarter -->
                    <h4 style="margin: ${isCurrentLocation ? '0' : '0'} 0 10px 0; color: #667eea;"> Persone in zona (${localNpcs.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${localNpcs.length > 0 ? localNpcs.map(npc => {
                            const relationColor = npc.relation > 70 ? '#4CAF50' : npc.relation > 40 ? '#FF9800' : '#F44336';
                            const knownStatus = npc.known ? '' : '?';
                            
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${relationColor};">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${knownStatus} ${npc.name}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.8;">${npc.job}</div>
                                        ${npc.known ? `<div style="font-size: 0.75rem; color: ${relationColor};">Relazione: ${npc.relation}/100</div>` : ''}
                                    </div>
                                    ${isCurrentLocation ? `
                                        <button onclick="event.stopPropagation(); showNpcChat('${npc.id}')" 
                                                style="padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                            
                                        </button>
                                    ` : `
                                        <div style="font-size: 0.7rem; opacity: 0.6; text-align: center;">
                                            Vai qui per<br>parlare
                                        </div>
                                    `}
                                </div>
                            `;
                        }).join('') : '<div style="color: #999; font-style: italic; text-align: center; padding: 10px;">Nessuno in zona</div>'}
                    </div>
                </div>
            </div>
            
            <!-- Locations Grid -->
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
                ${locations.map(loc => {
                    const isCurrentLocation = game.cityMap.currentBuilding === loc.id;
                    const isClosed = loc.status === 'closed';
                    
                    // Get icon based on type
                    let icon = '';
                    if (loc.type === 'shop') {
                        if (loc.business === 'supermercato') icon = '';
                        else if (loc.business === 'pizzeria') icon = '';
                        else if (loc.business === 'bar') icon = '';
                        else if (loc.business === 'palestra') icon = '';
                        else if (loc.business === 'libreria') icon = '';
                        else if (loc.business === 'boutique') icon = '';
                        else if (loc.business === 'ristorante') icon = '';
                        else if (loc.business === 'banca') icon = '';
                        else if (loc.business === 'pasticceria') icon = '';
                        else icon = '';
                    } else if (loc.type === 'residence') {
                        icon = '';
                    } else if (loc.type === 'landmark') {
                        icon = '';
                    } else if (loc.type === 'empty') {
                        icon = '';
                    }
                    
                    return `
                        <div onclick="interactWithLocation('${loc.id}', '${quarter}')" 
                             style="padding:12px; background:${isCurrentLocation ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}; 
                                    border-radius:8px; cursor:pointer; transition:all 0.2s; border:2px solid ${isCurrentLocation ? '#667eea' : 'transparent'}; 
                                    ${isClosed ? 'opacity:0.5;' : ''}"
                             onmouseenter="this.style.background='rgba(102,126,234,0.2)'" 
                             onmouseleave="this.style.background='${isCurrentLocation ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}'">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                                <div style="font-size:1.5rem;">${icon}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:bold; font-size:0.9rem;">${loc.name}</div>
                                    <div style="font-size:0.75rem; opacity:0.7;">${loc.street}</div>
                                </div>
                                ${isCurrentLocation ? '<div style="color:#667eea;"></div>' : ''}
                            </div>
                            ${isClosed ? '<div style="color:#ef4444; font-size:0.8rem;"> CHIUSO</div>' : ''}
                            ${loc.type === 'shop' && !isClosed ? `<div style="font-size:0.75rem; opacity:0.8;"> ${loc.business}</div>` : ''}
                            ${loc.type === 'residence' ? `<div style="font-size:0.75rem; opacity:0.8;"> ${loc.rent}/mese</div>` : ''}
                            ${loc.type === 'empty' ? `<div style="font-size:0.75rem; opacity:0.8;"> ${loc.cost}</div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function interactWithLocation(locationId, neighborhood) {
        const location = findLocationById(locationId);
        if (!location) return;
        
        // Check if already there
        if (game.cityMap.currentBuilding === locationId) {
            // Show actions for current location
            showLocationActions(location, neighborhood);
        } else {
            // Ask if want to travel
            if (confirm(` Vuoi andare a ${location.name}?\n${location.street}`)) {
                travelToLocation(locationId, neighborhood, location.name);
                renderDetailedMap(neighborhood);
            }
        }
    }
    
    function showLocationActions(location, neighborhood) {
        const actions = getLocationActions(location, neighborhood);
        
        if (actions.length === 0) {
            showNotification(' Osservi il luogo ma non ci sono azioni disponibili.', 2000);
            return;
        }
        
        // Genera le azioni con stile moderno
        const actionsHTML = `
            <div class="modal-section info">
                <div class="modal-section-title"> Posizione</div>
                <div class="modal-section-content">
                    <strong>${location.street}</strong>  ${NEIGHBORHOODS[neighborhood].name}
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title"> Azioni Disponibili</div>
                <div class="modal-action-grid">
                    ${actions.map(action => `
                        <button class="modal-action-btn" onclick="${action.onclick}; closeDialog();">
                            <div class="btn-icon">${action.icon}</div>
                            <div class="btn-title">${action.label}</div>
                            <div class="btn-subtitle">${action.subtitle}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        
        showDialog(actionsHTML, `${location.icon || ''} ${location.name}`, true);
    }
    
    function showHomeActions() {
        if (game.player.isHomeless) {
            showNotification(' Sei homeless! Non hai una casa dove fare queste azioni.', 2500);
            return;
        }
        
        if (game.cityMap.currentBuilding !== 'home') {
            showNotification(' Devi essere a casa per utilizzare queste azioni.', 2500);
            return;
        }
        
        const homeActionsData = [
            {
                icon: '',
                label: 'Mangia',
                subtitle: 'Recupera fame e energia',
                onclick: `action('eat')`
            },
            {
                icon: '',
                label: 'Dormi',
                subtitle: 'Riposa completamente',
                onclick: "showSleepUntilDialog()"
            },
            {
                icon: '',
                label: 'Doccia',
                subtitle: 'Rinfrescati e rilassati',
                onclick: `action('shower')`
            },
            {
                icon: '',
                label: 'Relax',
                subtitle: 'Migliora il morale',
                onclick: `action('relax')`
            },
            {
                icon: '',
                label: 'Allenati',
                subtitle: 'Aumenta fitness',
                onclick: `action('exercise')`
            }
                   ];
        
        const homeLocation = game.housing.neighborhood;
        const neighborhoodName = NEIGHBORHOODS[homeLocation] ? NEIGHBORHOODS[homeLocation].name : 'Casa';
        
        const actionsHTML = `
            <div class="modal-section info">
                <div class="modal-section-title"> La tua casa</div>
                <div class="modal-section-content">
                    <strong>Casa</strong>  ${neighborhoodName}
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title"> Azioni Disponibili</div>
                <div class="modal-action-grid">
                    ${homeActionsData.map(action => `
                        <button class="modal-action-btn" onclick="${action.onclick}; closeDialog();">
                            <div class="btn-icon">${action.icon}</div>
                            <div class="btn-title">${action.label}</div>
                            <div class="btn-subtitle">${action.subtitle}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        
        showDialog(actionsHTML, ` Casa`, true);
    }

    function updatePlayerMarker(quarterId) {
        const marker = $('playerMarker');
        const label = $('playerLocationLabel');
        if (!marker) return;

        const currentQuarter = game.cityMap.currentLocation || (game.housing ? game.housing.neighborhood : null);
        if (!currentQuarter) return;
        
        const zone = document.querySelector(`[data-quarter="${currentQuarter}"]`);
        
        if (zone) {
            const rect = zone.getBoundingClientRect();
            const container = $('visualMapContainer').getBoundingClientRect();
            
            const x = rect.left - container.left + (rect.width / 2) - 20;
            const y = rect.top - container.top + (rect.height / 2) - 20;
            
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.display = 'flex';
            
            // Update marker with building info
            const building = game.cityMap.currentBuilding || 'home';
            const buildingName = getBuildingName(building);
            marker.title = ` ${NEIGHBORHOODS[currentQuarter].name}\n ${buildingName}`;
            
            // Update location label
            if (label) {
                label.textContent = buildingName;
            }
        }
    }
    
    function getBuildingName(buildingId) {
        const buildingNames = {
            'home': ' Casa',
            'work': ' Lavoro',
            'supermarket': ' Supermercato',
            'gym': ' Palestra',
            'library': ' Biblioteca',
            'museum': ' Museo',
            'park': ' Parco',
            'restaurant': ' Ristorante',
            'bar': ' Bar',
            'nightclub': ' Discoteca',
            'cinema': ' Cinema',
            'theater': ' Teatro',
            'hospital': ' Ospedale',
            'police': ' Polizia',
            'bank': ' Banca',
            'mall': ' Centro Commerciale',
            'street': ' Per Strada'
        };
        return buildingNames[buildingId] || ' Luogo Sconosciuto';
    }

    function initializeVisualMap() {
        // This function will now only update the player marker on the overview map
        // Detailed markers (bus stops, landmarks, businesses) will be rendered by showDetailedQuarterMap
        const container = $('visualMapContainer');
        if (!container) return;

        // Clear any existing overview markers from previous views
        container.querySelectorAll('.bus-stop, .landmark-marker, .business-marker, .overview-home-marker, .overview-work-marker').forEach(marker => marker.remove());

        // Update player marker on init
        const currentLoc = game.cityMap.currentLocation || (game.housing ? game.housing.neighborhood : null);
        if (currentLoc) {
            updatePlayerMarker(currentLoc);
        }
        
        // Add home marker on overview map
        addOverviewHomeMarker();
        
        // Add work marker on overview map
        addOverviewWorkMarker();
    }
    
    function addOverviewHomeMarker() {
        if (!game.housing || !game.housing.neighborhood) return;
        
        const homeNeighborhood = game.housing.neighborhood;
        const zone = document.querySelector(`[data-quarter="${homeNeighborhood}"]`);
        if (!zone) return;
        
        const container = $('visualMapContainer');
        const rect = zone.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const x = rect.left - containerRect.left + (rect.width / 2) - 15;
        const y = rect.top - containerRect.top + (rect.height / 2) + 30; // Sotto il player marker
        
        const marker = document.createElement('div');
        marker.className = 'overview-home-marker';
        marker.style.position = 'absolute';
        marker.style.left = x + 'px';
        marker.style.top = y + 'px';
        marker.style.fontSize = '20px';
        marker.style.zIndex = '999';
        marker.style.cursor = 'pointer';
        marker.style.textShadow = '0 2px 4px rgba(0,0,0,0.5)';
        marker.innerHTML = '';
        marker.title = `Casa: ${NEIGHBORHOODS[homeNeighborhood].name}`;
        
        marker.addEventListener('click', () => {
            selectQuarterFromMap(homeNeighborhood);
        });
        
        container.appendChild(marker);
    }
    
    function addOverviewWorkMarker() {
        if (!game.workData || !game.workData.workLocation || game.player.job === 'Disoccupato') return;
        
        const workNeighborhood = game.workData.workLocation.neighborhood;
        const zone = document.querySelector(`[data-quarter="${workNeighborhood}"]`);
        if (!zone) return;
        
        const container = $('visualMapContainer');
        const rect = zone.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const x = rect.left - containerRect.left + (rect.width / 2) + 20; // A destra del centro
        const y = rect.top - containerRect.top + (rect.height / 2) + 30;
        
        const marker = document.createElement('div');
        marker.className = 'overview-work-marker';
        marker.style.position = 'absolute';
        marker.style.left = x + 'px';
        marker.style.top = y + 'px';
        marker.style.fontSize = '20px';
        marker.style.zIndex = '999';
        marker.style.cursor = 'pointer';
        marker.style.textShadow = '0 2px 4px rgba(0,0,0,0.5)';
        marker.innerHTML = '';
        marker.title = `Lavoro: ${game.workData.workPlaceName || 'Lavoro'} - ${NEIGHBORHOODS[workNeighborhood].name}`;
        
        marker.addEventListener('click', () => {
            selectQuarterFromMap(workNeighborhood);
        });
        
        container.appendChild(marker);
    }

    function showMapTooltip(event, text) {
        const tooltip = $('mapTooltip');
        if (!tooltip) return;
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (event.clientY - tooltip.offsetHeight - 10) + 'px';
    }

    function hideMapTooltip() {
        const tooltip = $('mapTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    function showDetailedQuarterMap(quarterId) {
        const overviewMap = $('overviewMapGrid');
        const detailedMap = $('detailedQuarterMap');
        const detailedMapGrid = $('detailedMapGrid');
        const detailedQuarterName = $('detailedQuarterName');

        overviewMap.style.display = 'none';
        detailedMap.classList.add('active');
        
        // Nascondi i marker della vista overview
        const container = $('visualMapContainer');
        if (container) {
            container.querySelectorAll('.overview-home-marker, .overview-work-marker').forEach(marker => {
                marker.style.display = 'none';
            });
        }

        const hood = NEIGHBORHOODS[quarterId];
        detailedQuarterName.innerHTML = ` ${hood.name} - Dettaglio`;
        detailedMapGrid.innerHTML = ''; // Clear previous content

        // Render roads
        renderRoads(quarterId, detailedMapGrid);

        // Render locations (shops, landmarks, etc.)
        renderLocations(quarterId, detailedMapGrid);

        // Update player marker position on detailed map
        updatePlayerMarkerDetailed(quarterId);
    }

    function hideDetailedQuarterMap() {
        $('detailedQuarterMap').classList.remove('active');
        $('overviewMapGrid').style.display = 'grid';
        
        // Mostra di nuovo i marker della vista overview
        const container = $('visualMapContainer');
        if (container) {
            container.querySelectorAll('.overview-home-marker, .overview-work-marker').forEach(marker => {
                marker.style.display = 'block';
            });
        }
        
        // Re-initialize overview map markers if needed
        initializeVisualMap();
        // Reset dropdown
        $('quarterSelect').value = '';
        $('quarterDetails').innerHTML = '';
    }

    function renderRoads(quarterId, container) {
        const hood = NEIGHBORHOODS[quarterId];
        if (!hood || !hood.streets) return;

        // Clear existing roads
        container.querySelectorAll('.map-road, .road-label').forEach(el => el.remove());

        // Define a more visually appealing road network
        // For simplicity, let's create a few main roads and intersections
        const roadsData = [
            // Horizontal roads
            { type: 'h', x: 0, y: 25, length: 100, name: hood.streets[0] || 'Main Street' },
            { type: 'h', x: 0, y: 50, length: 100, name: hood.streets[1] || 'Central Avenue' },
            { type: 'h', x: 0, y: 75, length: 100, name: hood.streets[2] || 'Park Road' },
            // Vertical roads
            { type: 'v', x: 25, y: 0, length: 100, name: hood.streets[3] || 'North Street' },
            { type: 'v', x: 50, y: 0, length: 100, name: hood.streets[4] || 'East Street' },
            { type: 'v', x: 75, y: 0, length: 100, name: hood.streets[5] || 'West Street' }
        ];

        roadsData.forEach(road => {
            const roadEl = document.createElement('div');
            roadEl.className = `map-road ${road.type === 'h' ? 'road-h' : 'road-v'}`;
            roadEl.style.left = road.x + '%';
            roadEl.style.top = road.y + '%';
            if (road.type === 'h') {
                roadEl.style.width = road.length + '%';
            } else {
                roadEl.style.height = road.length + '%';
            }
            container.appendChild(roadEl);

            // Add road labels
            const labelEl = document.createElement('div');
            labelEl.className = 'road-label';
            labelEl.textContent = road.name;
            if (road.type === 'h') {
                labelEl.style.left = `${road.x + road.length / 2}%`;
                labelEl.style.top = `${road.y - 10}px`; // Position above road
                labelEl.style.transform = 'translateX(-50%)';
            } else {
                labelEl.style.left = `${road.x - 10}px`; // Position left of road
                labelEl.style.top = `${road.y + road.length / 2}%`;
                labelEl.style.transform = 'translateY(-50%) rotate(-90deg)';
                labelEl.style.transformOrigin = 'left center';
            }
            container.appendChild(labelEl);
        });
    }

    function renderLocations(quarterId, container) {
        const locations = CITY_LOCATIONS[quarterId] || [];

        locations.forEach(loc => {
            const markerWrapper = document.createElement('div');
            markerWrapper.className = 'location-marker-wrapper'; // New wrapper for marker + label
            markerWrapper.style.left = loc.x + '%';
            markerWrapper.style.top = loc.y + '%';
            
            const marker = document.createElement('div');
            marker.className = 'location-marker';
            
            let icon = '';
            let bgColor = '';

            if (loc.type === 'shop') {
                icon = '';
                bgColor = 'var(--primary)';
            } else if (loc.type === 'landmark') {
                icon = '';
                bgColor = 'var(--success)';
            } else if (loc.type === 'empty') {
                icon = '';
                bgColor = 'var(--warning)';
            } else if (loc.type === 'residence') {
                icon = '';
                bgColor = 'rgba(255,255,255,0.3)';
            }

            marker.innerHTML = icon;
            marker.style.background = bgColor;
            marker.title = loc.name; // Tooltip on hover

            // Add label
            const label = document.createElement('span');
            label.className = 'location-label';
            label.textContent = loc.name;

            markerWrapper.appendChild(marker);
            markerWrapper.appendChild(label);
            
            // Click per aprire popup spostamento
            markerWrapper.style.cursor = 'pointer';
            markerWrapper.addEventListener('click', () => {
                showTravelPopup(loc, quarterId, icon);
            });
            
            markerWrapper.addEventListener('mouseenter', (e) => {
                showMapTooltip(e, `${icon} ${loc.name} - ${loc.street}`);
            });
            markerWrapper.addEventListener('mouseleave', hideMapTooltip);
            
            container.appendChild(markerWrapper);
        });
        
        // Aggiungi marker del lavoro se esiste e siamo nel quartiere giusto
        console.log(' Checking work marker:', {
            hasWorkData: !!game.workData,
            hasWorkLocation: !!(game.workData && game.workData.workLocation),
            workNeighborhood: game.workData?.workLocation?.neighborhood,
            currentQuarter: quarterId,
            job: game.player.job
        });
        
        if (game.workData && game.workData.workLocation && 
            game.workData.workLocation.neighborhood === quarterId && 
            game.player.job !== 'Disoccupato') {
            
            const workLoc = game.workData.workLocation;
            console.log(' Adding work marker at:', workLoc.coordinates);
            
            const markerWrapper = document.createElement('div');
            markerWrapper.className = 'location-marker-wrapper work-location-marker';
            markerWrapper.style.position = 'absolute';
            markerWrapper.style.left = workLoc.coordinates.x + '%';
            markerWrapper.style.top = workLoc.coordinates.y + '%';
            markerWrapper.style.transform = 'translate(-50%, -50%)';
            markerWrapper.style.zIndex = '1000';
            
            const marker = document.createElement('div');
            marker.className = 'location-marker';
            marker.innerHTML = '';
            marker.style.background = '#4CAF50';
            marker.style.animation = 'pulse 2s infinite';
            marker.style.fontSize = '24px';
            marker.style.padding = '8px';
            marker.style.borderRadius = '50%';
            marker.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            marker.title = 'Il tuo lavoro';
            
            const label = document.createElement('span');
            label.className = 'location-label';
            label.style.whiteSpace = 'nowrap';
            label.textContent = game.workData.workPlaceName || 'Lavoro';
            
            markerWrapper.appendChild(marker);
            markerWrapper.appendChild(label);
            
            // Click per mostrare dettagli
            markerWrapper.style.cursor = 'pointer';
            markerWrapper.addEventListener('click', () => {
                console.log(' Work marker clicked!');
                showWorkLocationDetails();
            });
            
            markerWrapper.addEventListener('mouseenter', (e) => {
                showMapTooltip(e, ` ${game.workData.workPlaceName}\n${workLoc.address}\n${game.player.job} - ${game.player.jobSalary}/giorno`);
            });
            markerWrapper.addEventListener('mouseleave', hideMapTooltip);
            
            container.appendChild(markerWrapper);
            console.log(' Work marker added to container');
        } else {
            if (game.workData?.workLocation?.neighborhood && game.workData.workLocation.neighborhood !== quarterId) {
                console.log(` Il tuo lavoro  in "${game.workData.workLocation.neighborhood}", ma stai visualizzando "${quarterId}". Vai nel quartiere del lavoro per vedere il marker `);
            } else {
                console.log(' Work marker NOT added - conditions not met');
            }
        }
    }

    function updatePlayerMarkerDetailed(quarterId) {
        const marker = $('playerMarker');
        const label = $('playerLocationLabel');
        if (!marker) return;

        const currentQuarter = game.cityMap.currentLocation;
        if (currentQuarter !== quarterId) {
            // If player is not in this detailed quarter, hide marker
            marker.style.display = 'none';
            return;
        }

        // Find player's current location (residence or building)
        const locations = CITY_LOCATIONS[quarterId];
        if (!locations) {
            marker.style.display = 'none';
            return;
        }
        
        let playerLocation = null;
        
        // If at home, find residence
        if (game.cityMap.currentBuilding === 'home' && game.housing.residenceId) {
            playerLocation = locations.find(loc => loc.id === game.housing.residenceId);
        }
        
        // If at work, find work location
        if (game.cityMap.currentBuilding === 'work' && game.workData && game.workData.currentJob) {
            // Work locations will need to be added later or use a default position
            playerLocation = { x: 50, y: 50 }; // Default center for now
        }
        
        // Otherwise try to match building type with location
        if (!playerLocation) {
            const buildingTypeMap = {
                'supermarket': 'supermercato',
                'gym': 'palestra',
                'library': 'libreria',
                'museum': 'galleria',
                'park': 'parco',
                'restaurant': 'ristorante',
                'bar': 'bar',
                'nightclub': 'nightclub',
                'cinema': 'cinema',
                'theater': 'teatro'
            };
            
            const searchBusiness = buildingTypeMap[game.cityMap.currentBuilding];
            if (searchBusiness) {
                playerLocation = locations.find(loc => loc.business === searchBusiness || loc.type === searchBusiness);
            }
        }
        
        // If still no location, use default center
        if (!playerLocation) {
            playerLocation = { x: 50, y: 50 };
        }

        // Position marker at specific coordinates
        marker.style.left = playerLocation.x + '%';
        marker.style.top = playerLocation.y + '%';
        marker.style.display = 'flex';
        
        // Make marker clickable if at home
        if (game.cityMap.currentBuilding === 'home') {
            marker.style.cursor = 'pointer';
            marker.onclick = () => showHomeActions();
        } else {
            marker.style.cursor = 'default';
            marker.onclick = null;
        }
        
        // Update label
        if (label) {
            const building = game.cityMap.currentBuilding || 'home';
            label.textContent = getBuildingName(building);
        }
    }

    function showMapTooltip(event, text) {
        const tooltip = $('mapTooltip');
        if (!tooltip) return;
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (event.clientY - tooltip.offsetHeight - 10) + 'px';
    }

    function hideMapTooltip() {
        const tooltip = $('mapTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    function showWorkLocationDetails() {
        if (!game.workData || !game.workData.workLocation || game.player.job === 'Disoccupato') {
            showNotification(' Non hai un lavoro!', 2000);
            return;
        }
        
        const workLoc = game.workData.workLocation;
        const job = game.workData.currentJob;
        const placeName = game.workData.workPlaceName;
        const neighborhood = NEIGHBORHOODS[workLoc.neighborhood];
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;"> Il Tuo Lavoro</h3>
                
                <div style="background:linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding:16px; border-radius:12px; margin-bottom:16px; text-align:center;">
                    <h2 style="margin:0 0 8px 0; font-size:1.5rem;">${placeName}</h2>
                    <div style="font-size:0.9rem; opacity:0.9;">
                        ${workLoc.address}<br>
                         ${neighborhood.name}
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;"> Informazioni Lavoro</h4>
                    <div style="font-size:0.9rem;">
                         <strong>Posizione:</strong> ${game.player.job}<br>
                         <strong>Stipendio:</strong> ${game.player.jobSalary}/giorno<br>
                        ${job ? ` <strong>Orario:</strong> ${job.hours.start}:00 - ${job.hours.end}:00<br>` : ''}
                        ${job && job.manager ? ` <strong>Manager:</strong> ${job.manager}<br>` : ''}
                         <strong>Performance:</strong> ${game.workData.performance || 75}%<br>
                         <strong>Giorni lavorati:</strong> ${game.workData.daysWorked || 0}
                    </div>
                </div>
                
                ${job && job.tasks ? `
                    <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                        <h4 style="margin-bottom:10px;"> Mansioni Principali</h4>
                        <div style="font-size:0.9rem;">
                            ${job.tasks.map(task => ` ${task}`).join('<br>')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;"> Come Raggiungerlo</h4>
                    <div style="font-size:0.9rem;">
                         A piedi dal centro: ~${randInt(5, 20)} minuti<br>
                         Fermata bus pi vicina: ${neighborhood.streets[randInt(0, neighborhood.streets.length - 1)]}<br>
                         Costo taxi: ~${randInt(5, 15)}
                    </div>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button onclick="travelToWork()" class="action-btn" style="flex:1; background:var(--success);">
                         Vai al Lavoro
                    </button>
                    ${game.workData.todayWorked ? 
                        '<button disabled class="action-btn" style="flex:1; opacity:0.5;"> Gi lavorato oggi</button>' :
                        '<button onclick="closeDialog(); doWorkDay();" class="action-btn" style="flex:1; background:var(--primary);"> Inizia Lavoro</button>'
                    }
                </div>
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;
        
        showDialog(html);
    }

    function showTravelPopup(location, neighborhood, icon) {
        const neighborhoodData = NEIGHBORHOODS[neighborhood];
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, neighborhood);
        const currentLoc = game.cityMap.currentLocation ? NEIGHBORHOODS[game.cityMap.currentLocation].name : 'posizione sconosciuta';
        
        // Controlla se ci sono NPCs in questa location
        const npcsHere = getNPCsAtLocation(location.id, neighborhood);
        
        // Determina azioni disponibili in base al tipo
        let actions = getLocationActions(location, neighborhood);
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;">${icon} ${location.name}</h3>
                
                <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding:16px; border-radius:12px; margin-bottom:16px; text-align:center;">
                    <h2 style="margin:0 0 8px 0; font-size:1.3rem;">${location.street}</h2>
                    <div style="font-size:0.9rem; opacity:0.9;">
                         ${neighborhoodData.name}
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;"> Informazioni</h4>
                    <div style="font-size:0.9rem;">
                         <strong>Tipo:</strong> ${location.type === 'shop' ? 'Negozio' : location.type === 'landmark' ? 'Punto d\'interesse' : location.type === 'residence' ? 'Residenza' : 'Area in costruzione'}<br>
                        ${location.business ? ` <strong>Attivit:</strong> ${location.business}<br>` : ''}
                         <strong>Indirizzo:</strong> ${location.street}
                    </div>
                </div>
                
                ${npcsHere.length > 0 ? `
                    <div style="background:rgba(56,239,125,0.1); padding:14px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(56,239,125,0.3);">
                        <h4 style="margin-bottom:10px;"> Persone Presenti</h4>
                        ${npcsHere.map(npc => `
                            <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${npc.known ? npc.name : '??? Sconosciuto'}</strong>
                                    <div style="font-size:0.85rem; opacity:0.8;">${npc.known ? npc.job : 'Non lo conosci ancora'}</div>
                                </div>
                                ${npc.known ? `<div style="color:var(--success);"> ${npc.relation}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;"> Viaggio</h4>
                    <div style="font-size:0.9rem;">
                         <strong>Posizione attuale:</strong> ${currentLoc}<br>
                         <strong>Tempo stimato:</strong> ${travelTime} minuti<br>
                         <strong>Costo:</strong> Gratuito (a piedi)
                    </div>
                </div>
                
                ${actions.length > 0 ? `
                    <div style="background:rgba(102,126,234,0.1); padding:14px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(102,126,234,0.3);">
                        <h4 style="margin-bottom:10px;"> Azioni Disponibili</h4>
                        <div style="display:grid; gap:8px;">
                            ${actions.map(action => `
                                <button onclick="${action.onclick}" class="action-btn" style="text-align:left; padding:10px;">
                                    ${action.icon} ${action.label}
                                    ${action.subtitle ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:2px;">${action.subtitle}</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button onclick="travelToLocation('${location.id}', '${neighborhood}', '${location.name}')" class="action-btn" style="flex:1; background:var(--success);">
                         Vai Qui (${travelTime} min)
                    </button>
                </div>
            </div>
        `;
        
        // NUOVO: invece di usare showDialog, crea popup custom
        // Crea overlay
        const overlay = document.createElement('div');
        overlay.className = 'location-popup-overlay';
        overlay.onclick = () => closeLocationPopup();
        
        // Crea popup
        const popup = document.createElement('div');
        popup.className = 'location-popup';
        popup.id = 'locationPopup';
        
        popup.innerHTML = `
            <div class="location-popup-header">
                <div class="location-popup-icon">${icon}</div>
                <div class="location-popup-info">
                    <h3>${location.name}</h3>
                    <p> ${location.street}, ${neighborhoodData.name}</p>
                </div>
            </div>
            
            ${npcsHere.length > 0 ? `
                <div style="background:rgba(56,239,125,0.1); padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid var(--success);">
                    <div style="font-weight:600; margin-bottom:8px;"> Persone Presenti (${npcsHere.length})</div>
                    ${npcsHere.map(npc => `
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="closeLocationPopup(); showNpcChat('${npc.id}')">
                            <div>
                                <strong>${npc.known ? npc.name : '??? Sconosciuto'}</strong>
                                <div style="font-size:0.8rem; opacity:0.8;">${npc.known ? npc.job : 'Non lo conosci ancora'}</div>
                            </div>
                            ${npc.known ? `<div style="color:var(--success);"> ${npc.relation}</div>` : '<button class="small"> Parla</button>'}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div class="location-popup-actions">
                <div class="location-action-btn" onclick="closeLocationPopup(); travelToLocation('${location.id}', '${neighborhood}', '${location.name}')">
                    <div class="location-action-icon"></div>
                    <div class="location-action-text">
                        <div class="location-action-title">Vai Qui</div>
                        <div class="location-action-desc"> ${travelTime} minuti  Da: ${currentLoc}</div>
                    </div>
                </div>
                
                ${actions.map(action => `
                    <div class="location-action-btn" onclick="${action.onclick}">
                        <div class="location-action-icon">${action.icon}</div>
                        <div class="location-action-text">
                            <div class="location-action-title">${action.label}</div>
                            ${action.subtitle ? `<div class="location-action-desc">${action.subtitle}</div>` : ''}
                            ${action.cost ? `<div class="location-action-cost"> ${action.cost}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <button class="location-popup-close" onclick="closeLocationPopup()"> Chiudi</button>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
    }
    
    function getNPCsAtLocation(locationId, neighborhood) {
        const currentDay = (game.time.day - 1) % 7 + 1; // 1-7 (Lun-Dom)
        const currentHour = game.time.hour;
        
        return game.npcs.filter(npc => {
            if (!npc.schedule || !npc.schedule.workDays) {
                return false;
            }
            const schedule = npc.schedule;
            const isWorkDay = schedule.workDays.includes(currentDay);
            const isWorkHour = currentHour >= schedule.workHours.start && currentHour <= schedule.workHours.end;
            
            // NPC  al lavoro
            if (npc.locationId === locationId && isWorkDay && isWorkHour) {
                return true;
            }
            
            // NPC  a casa (nei giorni liberi o fuori orario)
            if (npc.homeLocationId === locationId && (!isWorkDay || !isWorkHour)) {
                return true;
            }
            
            return false;
        });
    }
    
    function closeLocationPopup() {
        const overlay = document.querySelector('.location-popup-overlay');
        const popup = document.getElementById('locationPopup');
        if (overlay) overlay.remove();
        if (popup) popup.remove();
    }
    
    function getLocationActions(location, neighborhood) {
        const actions = [];
        
        // Azioni per NEGOZI
        if (location.type === 'shop') {
            if (location.business === 'supermercato' || location.business === 'minimarket') {
                actions.push({
                    icon: '',
                    label: 'Fai la Spesa',
                    subtitle: 'Compra cibo e prodotti',
                    onclick: `closeLocationPopup(); showShoppingAt('${location.id}', '${location.name}')`
                });
            }
            
            if (location.business === 'palestra') {
                actions.push({
                    icon: '',
                    label: 'Allenati',
                    subtitle: '+Fitness, -Energia, -Fame (1h)',
                    onclick: `closeLocationPopup(); trainAtGym('${location.id}')`
                });
            }
            
            if (location.business === 'libreria') {
                actions.push({
                    icon: '',
                    label: 'Studia',
                    subtitle: '+Intelletto, -Energia (1h)',
                    onclick: `closeLocationPopup(); studyAtLibrary('${location.id}')`
                });
            }
            
            if (location.business === 'galleria' || location.business === 'teatro') {
                actions.push({
                    icon: '',
                    label: 'Visita Culturale',
                    subtitle: '+Creativit, +Morale (1h)',
                    onclick: `closeLocationPopup(); visitCulturalSite('${location.id}')`
                });
            }
            
            if (location.business === 'bar' || location.business === 'ristorante') {
                actions.push({
                    icon: '',
                    label: 'Prendi qualcosa',
                    subtitle: 'Mangia/bevi, +Morale',
                    cost: '5-20',
                    onclick: `closeLocationPopup(); eatAtRestaurant('${location.id}', '${location.name}')`
                });
            }
            
            if (location.business === 'banca') {
                actions.push({
                    icon: '',
                    label: 'Servizi Bancari',
                    subtitle: 'Prestiti e investimenti',
                    onclick: `closeLocationPopup(); showBankServices('${location.id}', '${location.name}')`
                });
            }
        }
        
        // Azioni per LANDMARK
        if (location.type === 'landmark') {
            if (location.business === 'parco' || location.business === 'sport') {
                actions.push({
                    icon: '',
                    label: 'Corri al Parco',
                    subtitle: '+Fitness, +Morale, -Energia (1h)',
                    onclick: `closeLocationPopup(); runInPark('${location.id}')`
                });
            }
        }
        
        // Azioni per RESIDENZE (visitare NPCs)
        if (location.type === 'residence') {
            const npcsLivingHere = game.npcs.filter(npc => npc.homeLocationId === location.id && npc.known && npc.relation >= 30);
            npcsLivingHere.forEach(npc => {
                actions.push({
                    icon: '',
                    label: `Visita ${npc.name}`,
                    subtitle: `Passa del tempo con ${npc.name}`,
                    onclick: `closeLocationPopup(); visitNPCHome('${npc.id}', '${location.id}')`
                });
            });
        }
        
        return actions;
    }

    function calculateTravelTime(fromNeighborhood, toNeighborhood) {
        if (!fromNeighborhood || fromNeighborhood === toNeighborhood) {
            return 0; // Same neighborhood, no time needed
        }
        
        const fromQuarter = NEIGHBORHOODS[fromNeighborhood];
        const toQuarter = NEIGHBORHOODS[toNeighborhood];
        
        if (!fromQuarter || !toQuarter) {
            return 15; // Default time if neighborhoods not found
        }
        
        // Calculate base time based on distance between neighborhoods
        let baseTime = Math.abs(fromQuarter.travelTime - toQuarter.travelTime) + 10;
        
        // Apply transport method
        const transport = game.vehicles.active || 'walk';
        
        if (transport === 'walk') {
            return baseTime;
        } else if (transport === 'public') {
            return Math.floor(baseTime * 0.6); // Public transport is faster
        } else if (VEHICLES[transport]) {
            const vehicle = VEHICLES[transport];
            return Math.floor(baseTime * vehicle.speedMultiplier);
        }
        
        return baseTime;
    }

    function travelToLocation(locationId, neighborhood, locationName) {
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, neighborhood);
        const transport = game.vehicles.active || 'walk';
        
        // Calculate costs
        let travelCost = 0;
        let energyCost = Math.max(1, Math.floor(travelTime / 10));
        
        if (transport === 'public') {
            const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
            if (!hasPass) {
                travelCost = Math.max(2, Math.floor(travelTime / 5));
            }
            energyCost = Math.floor(energyCost * 0.5);
        } else if (VEHICLES[transport]) {
            const vehicle = VEHICLES[transport];
            travelCost = vehicle.fuelCost ? Math.floor(travelTime * vehicle.fuelCost) : 0;
            energyCost = Math.floor(energyCost * vehicle.energyCost);
        }
        
        // Check if can afford travel
        if (travelCost > 0 && game.player.money < travelCost) {
            showNotification(` Non hai abbastanza soldi per viaggiare! Serve ${formatMoney(travelCost)}.`, 3000);
            return;
        }
        
        // Apply costs
        if (travelCost > 0) {
            game.player.money -= travelCost;
        }
        if (energyCost > 0) {
            game.player.stats.energy = clamp(game.player.stats.energy - energyCost, 0, 100);
        }
        
        // Update location
        game.cityMap.currentLocation = neighborhood;
        game.cityMap.currentBuilding = locationId;
        
        closeDialog();
        
        // Show travel notification
        let transportIcon = '';
        if (transport === 'public') transportIcon = '';
        else if (transport === 'car') transportIcon = '';
        else if (transport === 'bike') transportIcon = '';
        else if (transport === 'motorcycle') transportIcon = '';
        
        let message = `${transportIcon} Sei arrivato a ${locationName}!`;
        if (travelTime > 0) {
            message += ` (${travelTime} min)`;
        }
        if (travelCost > 0) {
            message += `  ${formatMoney(travelCost)}`;
        }
        
        showNotification(message, 3000);
        
        // Add travel time
        if (travelTime > 0) {
            addMinutes(travelTime);
        }
        
        updateUI();
        
        // Show detailed map of the neighborhood
        showDetailedQuarterMap(neighborhood);
    }

    function travelToWork() {
        if (!game.workData || !game.workData.workLocation) {
            showNotification(' Non hai un lavoro!', 2000);
            return;
        }
        
        const workLoc = game.workData.workLocation;
        game.cityMap.currentLocation = workLoc.neighborhood;
        game.cityMap.currentBuilding = 'work';
        
        closeDialog();
        showNotification(` Sei arrivato a ${game.workData.workPlaceName}!`, 2000);
    addMinutes(30);
        updateUI();
        
        // Mostra mappa dettagliata del quartiere
        showDetailedQuarterMap(workLoc.neighborhood);
    }
    
    // ========== AZIONI NELLE LOCATION ==========
    
    function trainAtGym(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente in palestra per allenarti!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 20) {
            showNotification(' Sei troppo stanco per allenarti!', 2000);
            return;
        }
        
        const cost = 10;
        if (game.player.money < cost) {
            showNotification(' Non hai abbastanza soldi! (10)', 2000);
            return;
        }
        
        game.player.money -= cost;
        game.player.stats.energy -= 20;
        game.player.stats.hunger -= 15;
        game.player.skills.fitness += randInt(2, 5);
        passTime(1);
        
        showNotification(' Ottimo allenamento! +Fitness, -10', 2000);
        
        // Possibilit di incontrare qualcuno
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function studyAtLibrary(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente in libreria per studiare!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 15) {
            showNotification(' Sei troppo stanco per studiare!', 2000);
            return;
        }
        
        game.player.stats.energy -= 15;
        game.player.skills.intellect += randInt(2, 4);
        passTime(1);
        
        showNotification(' Hai studiato con profitto! +Intelletto', 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function visitCulturalSite(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente al sito culturale per visitarlo!', 2500);
            return;
        }
        
        const cost = 15;
        if (game.player.money < cost) {
            showNotification(' Biglietto d\'ingresso: 15', 2000);
            return;
        }
        
        game.player.money -= cost;
        game.player.stats.morale += 10;
        game.player.skills.creativity += randInt(1, 3);
        passTime(1);
        
        showNotification(' Che bella esperienza culturale! +Creativit, +Morale, -15', 2500);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function runInPark(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente al parco per correre!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 15) {
            showNotification(' Sei troppo stanco per correre!', 2000);
            return;
        }
        
        game.player.stats.energy -= 15;
        game.player.stats.hunger -= 10;
        game.player.stats.morale += 5;
        game.player.skills.fitness += randInt(1, 3);
        passTime(1);
        
        showNotification(' Ottima corsa! +Fitness, +Morale', 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function eatAtRestaurant(locationId, locationName) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente al ristorante per mangiare!', 2500);
            return;
        }
        
        const options = [
            { name: 'Caff', cost: 2, hunger: 5, morale: 3 },
            { name: 'Panino', cost: 5, hunger: 15, morale: 5 },
            { name: 'Pranzo completo', cost: 15, hunger: 40, morale: 10 }
        ];
        
        const choice = prompt(`Cosa vuoi ordinare da ${locationName}?\n1. Caff (2)\n2. Panino (5)\n3. Pranzo completo (15)\n\nScrivi 1, 2 o 3:`);
        if (!choice) return;
        
        const idx = parseInt(choice) - 1;
        if (idx < 0 || idx >= options.length) {
            showNotification(' Scelta non valida!', 1500);
            return;
        }
        
        const selected = options[idx];
        if (game.player.money < selected.cost) {
            showNotification(` Non hai abbastanza soldi! (${selected.cost})`, 2000);
            return;
        }
        
        game.player.money -= selected.cost;
        game.player.stats.hunger = Math.min(100, game.player.stats.hunger + selected.hunger);
        game.player.stats.morale = Math.min(100, game.player.stats.morale + selected.morale);
        addMinutes(30); // 30 minuti per mangiare
        
        showNotification(` ${selected.name} ordinato! +Fame, +Morale, -${selected.cost}`, 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    // ---------- BANK SERVICES ----------
    function showBankServices(locationId, bankName) {
        // Controlla se sei fisicamente nella banca
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente in banca!', 2500);
            return;
        }
        
        const creditScore = calculateCreditScore();
        const maxLoan = Math.floor(creditScore * 500); // Max 1000-50000
        const interestRate = Math.max(5, 20 - (creditScore / 10)); // 5-15% based on creditScore
        
        showDialog(`
            <h2> ${bankName}</h2>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <h3>Il tuo profilo creditizio</h3>
                <p> Credit Score: ${creditScore}/100</p>
                <p> Prestito massimo: ${maxLoan.toFixed(0)}</p>
                <p> Tasso interesse: ${interestRate.toFixed(1)}%</p>
                <p> Prestiti attivi: ${game.investments.loans.length}</p>
            </div>
            
            ${game.investments.loans.length > 0 ? `
                <div style="background: rgba(255,100,100,0.2); padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h3> I tuoi prestiti</h3>
                    ${game.investments.loans.map(loan => `
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 5px 0;">
                            <p><strong>${loan.bank}</strong></p>
                            <p>Importo: ${loan.amount.toFixed(0)} | Rate mensili: ${loan.monthlyPayment.toFixed(0)}</p>
                            <p>Rate rimanenti: ${loan.remainingMonths} | Tasso: ${loan.interestRate.toFixed(1)}%</p>
                            ${loan.missedPayments ? `<p style="color: #ff0000;"> Rate mancate: ${loan.missedPayments}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="requestLoan('${locationId}', '${bankName}', ${maxLoan}, ${interestRate})" 
                    style="flex: 1; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                     Richiedi Prestito
                </button>
                <button onclick="closeDialog()" 
                    style="flex: 1; padding: 15px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                     Esci
                </button>
            </div>
        `);
    }
    
    function calculateCreditScore() {
        let score = 50; // Base score
        
        // Job status
        if (game.player.job !== 'Disoccupato') {
            score += 20;
            // Salary influence
            const salary = game.player.salary || 0;
            if (salary > 2000) score += 10;
            else if (salary > 1000) score += 5;
        } else {
            score -= 15;
        }
        
        // Money in bank
        if (game.player.money > 10000) score += 15;
        else if (game.player.money > 5000) score += 10;
        else if (game.player.money > 1000) score += 5;
        else if (game.player.money < 0) score -= 20;
        
        // Reputation
        if (game.player.rep > 80) score += 10;
        else if (game.player.rep > 50) score += 5;
        else if (game.player.rep < 20) score -= 10;
        
        // Existing loans
        score -= game.investments.loans.length * 10;
        
        // Missed payments
        game.investments.loans.forEach(loan => {
            if (loan.missedPayments) score -= loan.missedPayments * 15;
        });
        
        return Math.max(10, Math.min(100, score));
    }
    
    function requestLoan(locationId, bankName, maxLoan, interestRate) {
        closeDialog();
        
        if (game.investments.loans.length >= 3) {
            showNotification(' Non puoi avere pi di 3 prestiti attivi contemporaneamente!', 3000);
            return;
        }
        
        const amount = prompt(`Quanto vuoi richiedere in prestito?\n\nMassimo: ${maxLoan.toFixed(0)}\nTasso interesse: ${interestRate.toFixed(1)}%\n\nInserisci l'importo:`);
        if (!amount) return;
        
        const loanAmount = parseFloat(amount);
        if (isNaN(loanAmount) || loanAmount <= 0) {
            showNotification(' Importo non valido!', 2000);
            return;
        }
        
        if (loanAmount > maxLoan) {
            showNotification(` Puoi richiedere massimo ${maxLoan.toFixed(0)}!`, 2500);
            return;
        }
        
        if (loanAmount < 1000) {
            showNotification(' Importo minimo: 1000!', 2000);
            return;
        }
        
        const months = prompt(`In quanti mesi vuoi restituire il prestito?\n\nMin: 6 mesi | Max: 60 mesi\n\nInserisci il numero di mesi:`);
        if (!months) return;
        
        const loanMonths = parseInt(months);
        if (isNaN(loanMonths) || loanMonths < 6 || loanMonths > 60) {
            showNotification(' Durata non valida! (6-60 mesi)', 2500);
            return;
        }
        
        const totalWithInterest = loanAmount * (1 + interestRate / 100);
        const monthlyPayment = totalWithInterest / loanMonths;
        
        const confirm = window.confirm(
            `Confermi il prestito?\n\n` +
            `Importo: ${loanAmount.toFixed(0)}\n` +
            `Durata: ${loanMonths} mesi\n` +
            `Tasso: ${interestRate.toFixed(1)}%\n` +
            `Totale da restituire: ${totalWithInterest.toFixed(0)}\n` +
            `Rata mensile: ${monthlyPayment.toFixed(0)}`
        );
        
        if (!confirm) {
            showNotification(' Richiesta annullata.', 1500);
            return;
        }
        
        // Crea il prestito
        const loan = {
            id: 'loan_' + Date.now(),
            amount: loanAmount,
            interestRate: interestRate,
            monthlyPayment: monthlyPayment,
            remainingMonths: loanMonths,
            bank: bankName,
            takenDay: game.time.day,
            missedPayments: 0
        };
        
        game.investments.loans.push(loan);
        game.player.money += loanAmount;
        game.player.cash += loanAmount;
        
        showNotification(` Prestito approvato! +${loanAmount.toFixed(0)}\nPrima rata tra 30 giorni.`, 4000);
        updateUI();
    }

    function visitNPCHome(npcId, locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification(' Devi andare fisicamente a casa della persona per visitarla!', 2500);
            return;
        }
        
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        if (npc.relation < 30) {
            showNotification(` Non conosci abbastanza ${npc.name} per visitarlo a casa!`, 2500);
            return;
        }
        
        const relationGain = randInt(5, 10);
        npc.relation = Math.min(100, npc.relation + relationGain);
        game.player.stats.morale += 5;
        game.player.stats.energy -= 10;
        passTime(2);
        
        showNotification(` Bella serata con ${npc.name}! Relazione: +${relationGain}`, 2500);
        updateUI();
        
        // Apri dialogo
        setTimeout(() => openDialogue(npcId), 1000);
    }
    
    function checkRandomEncounter(locationId) {
        // 30% possibilit di incontrare qualcuno
        if (Math.random() > 0.3) return;
        
        const npcsHere = getNPCsAtLocation(locationId, game.cityMap.currentLocation);
        if (npcsHere.length === 0) return;
        
        const npc = npcsHere[randInt(0, npcsHere.length - 1)];
        
        if (!npc.known) {
            // Primo incontro!
            npc.known = true;
            npc.relation = randInt(10, 25);
            showNotification(` Hai conosciuto ${npc.name} (${npc.job})! Relazione: ${npc.relation}`, 3000);
        } else {
            // Incontro casuale con conoscente
            const gain = randInt(1, 3);
            npc.relation = Math.min(100, npc.relation + gain);
            showNotification(` Hai incontrato ${npc.name}! Relazione: +${gain}`, 2000);
        }
    }
    
    function showShoppingAt(locationId, locationName) {
        // Riusa il sistema shopping esistente
        switchMainTab('shop');
        showNotification(` Benvenuto a ${locationName}!`, 1500);
    }

    // Initialize visual map when tab is opened
    // ---------- CITY MAP SYSTEM ----------
    function renderCityQuartiersMap() {
        const div = $('cityQuartiersMap');
        if (!div) return;

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        div.innerHTML = Object.keys(NEIGHBORHOODS).map(key => {
            const hood = NEIGHBORHOODS[key];
            const isCurrent = game.housing && game.housing.neighborhood === key;
            const locations = CITY_LOCATIONS[key] || [];
            const shops = locations.filter(l => l.type === 'shop').length;
            const empty = locations.filter(l => l.type === 'empty').length;
            const landmarks = locations.filter(l => l.type === 'landmark').length;

            return `
                <div style="padding:14px; background:rgba(255,255,255,${isCurrent ? '0.12' : '0.06'}); border-radius:10px; margin-bottom:12px; border-left:3px solid ${isCurrent ? 'var(--primary)' : 'rgba(255,255,255,0.2)'};">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                            <h4 style="margin-bottom:4px;">${isCurrent ? ' ' : ''}${hood.name}</h4>
                            <div style="font-size:0.85rem; opacity:0.8;">
                                 Popolazione: ${hood.population.toLocaleString()}<br>
                                 Reddito Medio: ${hood.avgIncome.toLocaleString()}/anno
                            </div>
                        </div>
                        <button class="small" onclick="selectQuarter('${key}')"> Esplora</button>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px; font-size:0.85rem;">
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Negozi</div>
                            <div style="font-weight:bold;">${shops}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Disponibili</div>
                            <div style="font-weight:bold; color:var(--success);">${empty}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Punti Int.</div>
                            <div style="font-weight:bold;">${landmarks}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Fermate</div>
                            <div style="font-weight:bold;">${hood.busStops.length}</div>
                        </div>
                    </div>

                    <div style="margin-top:10px; font-size:0.8rem; opacity:0.7;">
                         Interessi: ${hood.interests.join(', ')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectQuarter(quarterId) {
        $('quarterSelect').value = quarterId;
        exploreQuarter();
    }

    function exploreQuarter() {
        const quarterId = $('quarterSelect').value;
        if (!quarterId) {
            $('quarterDetails').innerHTML = '';
            return;
        }

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        // NUOVO: Apri la mappa grafica invece della lista
        showDetailedQuarterMap(quarterId);
        return;
        
        // Vecchio codice commentato per riferimento
        const hood = NEIGHBORHOODS[quarterId];
        const locations = CITY_LOCATIONS[quarterId] || [];

        let html = `
            <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <h4 style="margin-bottom:12px;"> ${hood.name}</h4>
                
                <div style="padding:12px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;"> Demografia</h5>
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; font-size:0.85rem;">
                        <div> Giovani: ${hood.demographics.young}%</div>
                        <div> Adulti: ${hood.demographics.adults}%</div>
                        <div> Anziani: ${hood.demographics.elderly}%</div>
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;"> Fermate Bus</h5>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${hood.busStops.map(stop => `
                            <span style="padding:6px 12px; background:rgba(102,126,234,0.2); border-radius:6px; font-size:0.85rem;">
                                 ${stop}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;"> Strade Principali</h5>
                    <div style="font-size:0.85rem; opacity:0.9;">
                        ${hood.streets.join('  ')}
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;"> Punti di Interesse</h5>
                    ${locations.filter(l => l.type === 'landmark').map(loc => `
                        <div style="padding:8px; background:rgba(56,239,125,0.1); border-radius:6px; margin-bottom:6px; border-left:3px solid var(--success);">
                            <div style="font-weight:bold;">${loc.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8;"> ${loc.street}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;"> Negozi & Attivit</h5>
                    ${locations.filter(l => l.type === 'shop').map(loc => {
                        const owned = game.cityMap.ownedBusinesses.some(b => b.locationId === loc.id);
                        return `
                            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; ${owned ? 'border:2px solid var(--success);' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-weight:bold;">${owned ? ' ' : ''}${loc.name}</div>
                                        <div style="font-size:0.85rem; opacity:0.8;"> ${loc.street}</div>
                                        <div style="font-size:0.85rem; opacity:0.7;"> Reddito: ~${loc.income}/mese</div>
                                    </div>
                                    ${owned ? `<button class="small" onclick="manageOwnedBusiness('${loc.id}')"> Gestisci</button>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div>
                    <h5 style="margin-bottom:8px;"> Lotti Disponibili</h5>
                    ${locations.filter(l => l.type === 'empty').map(loc => `
                        <div style="padding:12px; background:rgba(255,200,100,0.08); border-radius:8px; margin-bottom:8px; border-left:3px solid var(--warning);">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <div style="font-weight:bold;"> ${loc.name}</div>
                                    <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                         ${loc.street}<br>
                                         Dimensione: ${loc.size}<br>
                                         Costo: ${loc.cost.toLocaleString()}
                                    </div>
                                    <div style="margin-top:8px; font-size:0.85rem;">
                                        <strong>Attivit consigliate:</strong><br>
                                        ${hood.businessOpportunities.slice(0, 3).map(b => {
                                            const business = BUSINESS_TYPES[b];
                                            return business ? business.name : b;
                                        }).join(', ')}
                                    </div>
                                </div>
                                <button class="small" onclick="buyLocation('${loc.id}', '${quarterId}')"> Acquista</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        $('quarterDetails').innerHTML = html;
    }

    function buyLocation(locationId, quarterId) {
        const locations = CITY_LOCATIONS[quarterId];
        const location = locations.find(l => l.id === locationId);
        
        if (!location || location.type !== 'empty') {
            showNotification('Lotto non disponibile!', 1500);
            return;
        }

        if (game.player.money < location.cost) {
            showNotification(' Non hai abbastanza soldi!', 1500);
            return;
        }

        // Show business selection
        const hood = NEIGHBORHOODS[quarterId];
        const businessOptions = hood.businessOpportunities.map(b => {
            const business = BUSINESS_TYPES[b];
            if (!business) return '';
            return `${business.name} (${business.cost.toLocaleString()} - Reddito: ${business.income[0]}-${business.income[1]}/mese)`;
        }).join('\n');

        const choice = prompt(`Scegli che attivit aprire:\n\n${businessOptions}\n\nDigita il numero (1-${hood.businessOpportunities.length}):`, '1');
        if (!choice) return;

        const index = parseInt(choice) - 1;
        const businessKey = hood.businessOpportunities[index];
        const businessType = BUSINESS_TYPES[businessKey];

        if (!businessType) {
            showNotification('Scelta non valida!', 1500);
            return;
        }

        const totalCost = location.cost + businessType.cost;
        if (game.player.money < totalCost) {
            showNotification(` Costo totale: ${totalCost.toLocaleString()}. Non hai abbastanza!`, 2000);
            return;
        }

        if (confirm(`Acquistare ${location.name} e aprire ${businessType.name}?\nCosto totale: ${totalCost.toLocaleString()}`)) {
            game.player.money -= totalCost;
            
            // Update location
            location.type = 'shop';
            location.name = businessType.name + ' "' + game.player.name + '"';
            location.business = businessKey;
            location.status = 'owned';
            
            // Add to owned businesses
            game.cityMap.ownedBusinesses.push({
                locationId: locationId,
                quarterId: quarterId,
                businessType: businessKey,
                opened: game.time.day,
                income: businessType.income[0],
                employees: businessType.employees,
                level: 1
            });

            showNotification(` Hai aperto ${businessType.name}!`, 2500);
            exploreQuarter();
            updateUI();
        }
    }

    function manageOwnedBusiness(locationId) {
        const business = game.cityMap.ownedBusinesses.find(b => b.locationId === locationId);
        if (!business) return;

        const businessType = BUSINESS_TYPES[business.businessType];
        const location = Object.values(CITY_LOCATIONS).flat().find(l => l.id === locationId);

        alert(` ${location.name}\n\n Reddito Mensile: ${business.income}\n Dipendenti: ${business.employees}\n Livello: ${business.level}\n Aperto da: ${game.time.day - business.opened} giorni`);
    }

    function collectBusinessIncome() {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }
        
        if (game.cityMap.ownedBusinesses && game.cityMap.ownedBusinesses.length > 0) {
            const totalIncome = game.cityMap.ownedBusinesses.reduce((sum, b) => sum + b.income, 0);
            game.player.money += totalIncome;
            showNotification(` Reddito attivit: +${totalIncome}!`, 2000);
        }
    }

    function renderTransportInfo() {
        const div = $('transportInfo');
        if (!div) return;

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
        
        div.innerHTML = `
            <div style="padding:10px; background:rgba(0,0,0,0.2); border-radius:8px;">
                <div style="font-weight:bold; margin-bottom:8px;">
                    ${hasPass ? ' Abbonamento Attivo' : ' Nessun Abbonamento'}
                </div>
                ${hasPass ? `<div style="font-size:0.85rem; opacity:0.8;">Valido fino al giorno ${game.cityMap.transportPass}</div>` : ''}
            </div>

            <div style="margin-top:12px;">
                <h5 style="margin-bottom:8px;"> Linee Disponibili</h5>
                ${Object.keys(BUS_ROUTES).map(key => {
                    const route = BUS_ROUTES[key];
                    return `
                        <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                            <div style="font-weight:bold;">${route.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                 ${route.stops.join('  ')}<br>
                                 Costo: ${route.cost} |  Tempo: ${route.time} min
                            </div>
                            <button class="small" style="margin-top:6px;" onclick="takeBus('${key}')" ${!hasPass ? '' : 'disabled'}>
                                ${hasPass ? ' Incluso' : `Prendi (${route.cost})`}
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    // ---------- VEHICLES SYSTEM ----------
    function renderVehiclesInfo() {
        const div = $('vehiclesInfo');
        if (!div) return;
        
        const currentLocation = game.cityMap.currentLocation;
        const currentVehicle = game.vehicles.active;
        
        let html = '<div style="margin-bottom:12px;">';
        html += '<div style="font-weight:600; margin-bottom:8px;"> Mezzo di Trasporto Attivo:</div>';
        
        if (!currentVehicle) {
            html += '<div style="padding:8px; background:rgba(255,200,100,0.15); border-radius:6px;">A piedi </div>';
        } else if (currentVehicle === 'public') {
            const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
            html += `<div style="padding:8px; background:rgba(100,150,255,0.15); border-radius:6px;"> Trasporto Pubblico${hasPass ? ' (con abbonamento)' : ''}</div>`;
        } else {
            const vehicle = VEHICLES[currentVehicle];
            html += `<div style="padding:8px; background:rgba(100,255,150,0.15); border-radius:6px;">${vehicle.emoji} ${vehicle.name}</div>`;
        }
        html += '</div>';
        
        // Show owned vehicles
        if (game.vehicles.owned && game.vehicles.owned.length > 0) {
            html += '<div style="margin-top:16px;">';
            html += '<div style="font-weight:600; margin-bottom:8px;"> Veicoli Posseduti:</div>';
            game.vehicles.owned.forEach(vehicleId => {
                const vehicle = VEHICLES[vehicleId];
                const isActive = vehicleId === currentVehicle;
                html += `
                    <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; border-left:3px solid ${isActive ? 'var(--success)' : 'transparent'};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600;">${vehicle.emoji} ${vehicle.name}</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                     Energia: ${vehicle.energyCost}/h | 
                                    ${vehicle.fuelCost ? ` Carburante: ${vehicle.fuelCost}/h` : ' Elettrico'} | 
                                     Manutenzione: ${vehicle.maintenanceCost}/mese
                                </div>
                                <div style="font-size:0.8rem; opacity:0.7; margin-top:2px;"> Velocit: ${Math.round((1-vehicle.speedMultiplier)*100)}% pi veloce</div>
                            </div>
                            <button class="small" onclick="setActiveVehicle('${vehicleId}')" ${isActive ? 'disabled' : ''}>
                                ${isActive ? ' Attivo' : 'Usa'}
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        // Shop section
        html += '<div style="margin-top:20px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1);">';
        html += '<div style="font-weight:600; margin-bottom:12px;"> Concessionario Veicoli:</div>';
        
        Object.keys(VEHICLES).forEach(vehicleId => {
            const vehicle = VEHICLES[vehicleId];
            const owned = game.vehicles.owned && game.vehicles.owned.includes(vehicleId);
            
            html += `
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:1.1rem;">${vehicle.emoji} ${vehicle.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">${vehicle.description}</div>
                            <div style="font-size:0.85rem; margin-top:6px;">
                                 Prezzo: ${vehicle.cost}<br>
                                 Consumo Energia: ${vehicle.energyCost}/h<br>
                                ${vehicle.fuelCost ? ` Carburante: ${vehicle.fuelCost}/h<br>` : ''}
                                 Manutenzione: ${vehicle.maintenanceCost}/mese<br>
                                 Velocit: ${Math.round((1-vehicle.speedMultiplier)*100)}% pi veloce
                            </div>
                        </div>
                        <button onclick="buyVehicle('${vehicleId}')" ${owned ? 'disabled' : ''} style="min-width:100px;">
                            ${owned ? ' Posseduto' : 'Acquista'}
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Options section
        html += '<div style="margin-top:16px; padding:10px; background:rgba(100,150,255,0.1); border-radius:8px;">';
        html += '<div style="font-weight:600; margin-bottom:8px;"> Modalit di Viaggio:</div>';
        html += '<div style="display:flex; gap:8px; flex-wrap:wrap;">';
        html += `<button class="small" onclick="setActiveVehicle(null)" ${!currentVehicle ? 'disabled' : ''}> A piedi (Gratis)</button>`;
        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
        html += `<button class="small" onclick="setActiveVehicle('public')" ${currentVehicle === 'public' ? 'disabled' : ''}> Trasporto Pubblico${hasPass ? '' : ' (2-4/viaggio)'}</button>`;
        html += '</div>';
        html += '</div>';
        
        div.innerHTML = html;
    }
    
    function buyVehicle(vehicleId) {
        const vehicle = VEHICLES[vehicleId];
        
        if (!vehicle) {
            showNotification(' Veicolo non trovato!', 1500);
            return;
        }
        
        if (game.vehicles.owned && game.vehicles.owned.includes(vehicleId)) {
            showNotification(' Possiedi gi questo veicolo!', 1500);
            return;
        }
        
        if (game.player.money < vehicle.cost) {
            showNotification(` Non hai abbastanza soldi! Serve: ${vehicle.cost}`, 2000);
            return;
        }
        
        if (confirm(`${vehicle.emoji} Vuoi acquistare ${vehicle.name} per ${vehicle.cost}?\n\nCosti di gestione:\n- Carburante: ${vehicle.fuelCost || 0}/h di viaggio\n- Manutenzione: ${vehicle.maintenanceCost}/mese`)) {
            game.player.money -= vehicle.cost;
            if (!game.vehicles.owned) game.vehicles.owned = [];
            game.vehicles.owned.push(vehicleId);
            showNotification(` Hai acquistato ${vehicle.name}!`, 2500);
            updateUI();
        }
    }
    
    function setActiveVehicle(vehicleId) {
        if (vehicleId && vehicleId !== 'public' && (!game.vehicles.owned || !game.vehicles.owned.includes(vehicleId))) {
            showNotification(' Non possiedi questo veicolo!', 1500);
            return;
        }
        
        game.vehicles.active = vehicleId;
        const vehicleName = vehicleId === null ? 'A piedi ' : 
                           vehicleId === 'public' ? 'Trasporto Pubblico ' : 
                           VEHICLES[vehicleId].name;
        showNotification(` Modalit di viaggio impostata: ${vehicleName}`, 2000);
        updateUI();
    }
    
    function payVehicleMaintenance() {
        if (!game.vehicles.owned || game.vehicles.owned.length === 0) return;
        
        let totalCost = 0;
        game.vehicles.owned.forEach(vehicleId => {
            const vehicle = VEHICLES[vehicleId];
            if (vehicle && vehicle.maintenanceCost) {
                totalCost += vehicle.maintenanceCost;
            }
        });
        
        if (totalCost > 0) {
            game.player.money -= totalCost;
            showNotification(` Manutenzione veicoli: -${totalCost}`, 2500);
        }
    }
    
    // Show travel dialog with vehicle options
    function showTravelDialog(destination, callback) {
        const destName = NEIGHBORHOODS[destination] ? NEIGHBORHOODS[destination].name : destination;
        
        if (game.cityMap.currentLocation === destination) {
            callback(null); // Already there
            return;
        }
        
        // Calculate costs for each transport option
        const walkInfo = calculateTravelTime(destination, null);
        const publicInfo = calculateTravelTime(destination, 'public');
        
        let html = `
            <div style="padding:20px; max-width:500px;">
                <h3 style="margin-top:0;"> Viaggio verso ${destName}</h3>
                <p style="opacity:0.8; margin-bottom:20px;">Scegli il mezzo di trasporto:</p>
                <div style="display:flex; flex-direction:column; gap:12px;">
        `;
        
        // Walking option
        html += `
            <button onclick="selectTransportForTravel(null, '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                    style="padding:15px; text-align:left; background:rgba(100,100,100,0.2); border:2px solid rgba(255,255,255,0.2); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                    onmouseover="this.style.background='rgba(100,100,100,0.4)'" 
                    onmouseout="this.style.background='rgba(100,100,100,0.2)'">
                <div style="font-weight:bold; font-size:1.1rem;"> A Piedi (Gratis)</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                     Tempo: ${walkInfo.time}h |  Energia: -${walkInfo.energy}%
                </div>
            </button>
        `;
        
        // Public transport option
        html += `
            <button onclick="selectTransportForTravel('public', '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                    style="padding:15px; text-align:left; background:rgba(50,100,200,0.2); border:2px solid rgba(50,150,255,0.3); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                    onmouseover="this.style.background='rgba(50,100,200,0.4)'" 
                    onmouseout="this.style.background='rgba(50,100,200,0.2)'">
                <div style="font-weight:bold; font-size:1.1rem;"> Trasporto Pubblico</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                     Tempo: ${publicInfo.time}h |  Costo: ${publicInfo.cost} |  Energia: -${publicInfo.energy}%
                </div>
            </button>
        `;
        
        // Personal vehicles
        if (game.vehicles.owned && game.vehicles.owned.length > 0) {
            game.vehicles.owned.forEach(vehicleId => {
                const vehicle = VEHICLES[vehicleId];
                const vehicleInfo = calculateTravelTime(destination, vehicleId);
                
                html += `
                    <button onclick="selectTransportForTravel('${vehicleId}', '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                            style="padding:15px; text-align:left; background:rgba(50,200,100,0.2); border:2px solid rgba(50,255,150,0.3); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                            onmouseover="this.style.background='rgba(50,200,100,0.4)'" 
                            onmouseout="this.style.background='rgba(50,200,100,0.2)'">
                        <div style="font-weight:bold; font-size:1.1rem;">${vehicle.emoji} ${vehicle.name}</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                             Tempo: ${vehicleInfo.time}h |  Costo: ${vehicleInfo.cost} |  Energia: -${vehicleInfo.energy}%
                        </div>
                    </button>
                `;
            });
        }
        
        html += `
                    <button onclick="closeDialog()" 
                            style="padding:12px; background:rgba(200,50,50,0.3); border:2px solid rgba(255,100,100,0.4); border-radius:8px; cursor:pointer; margin-top:10px;">
                         Annulla
                    </button>
                </div>
            </div>
        `;
        
        // Show dialog
        const dialog = document.createElement('div');
        dialog.id = 'travelDialog';
        dialog.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;';
        dialog.innerHTML = html;
        document.body.appendChild(dialog);
    }
    
    function selectTransportForTravel(vehicleId, destination, callback) {
        closeDialog();
        
        const travelInfo = calculateTravelTime(destination, vehicleId);
        
        // Check resources
        if (game.player.money < travelInfo.cost) {
            showNotification(` Non hai abbastanza soldi! Serve: ${travelInfo.cost}`, 2500);
            return;
        }
        
        if (game.player.stats.energy < travelInfo.energy) {
            showNotification(` Non hai abbastanza energia! Serve: ${travelInfo.energy}%`, 2500);
            return;
        }
        
        // Apply travel
        game.player.money -= travelInfo.cost;
        game.player.stats.energy = clamp(game.player.stats.energy - travelInfo.energy);
        
        const vehicleName = vehicleId === null ? '' : 
                           vehicleId === 'public' ? '' : 
                           VEHICLES[vehicleId].emoji;
        
        showNotification(`${vehicleName} Viaggio verso ${NEIGHBORHOODS[destination].name}... (${travelInfo.time}h, ${travelInfo.cost})`, 2500);
        passTime(travelInfo.time);
        game.cityMap.currentLocation = destination;
        
        updateUI();
        
        if (callback) callback();
    }
    
    function showDialog(htmlContent, title = null, showCloseButton = true) {
        // Remove existing dialog if any
        closeDialog();
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'travelDialog'; // Keep same ID for consistency
        overlay.className = 'enhanced-dialog-overlay';
        
        // Create content container
        const dialogContent = document.createElement('div');
        dialogContent.className = 'enhanced-dialog-content';
        
        // Add header if title provided
        if (title) {
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.innerHTML = `
                <h3>${title}</h3>
                ${showCloseButton ? `<button class="modal-close-btn" onclick="closeDialog()"></button>` : ''}
            `;
            dialogContent.appendChild(header);
        }
        
        // Add body
        const body = document.createElement('div');
        body.className = 'modal-body';
        body.innerHTML = htmlContent;
        dialogContent.appendChild(body);
        
        overlay.appendChild(dialogContent);
        document.body.appendChild(overlay);
        
        // Close on overlay click (but not on content click)
        if (showCloseButton) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeDialog();
            });
        }
    }

    function closeDialog() {
        const dialog = document.getElementById('travelDialog');
        if (dialog) {
            dialog.style.animation = 'fadeOut 0.2s ease';
            setTimeout(() => dialog.remove(), 200);
        }
    }

    function showWelcomeTutorial() {
        // Check if tutorial was already shown
        const tutorialShown = localStorage.getItem('eldoriaTutorialShown');
        if (tutorialShown === 'true') return;

        const html = `
            <div style="max-height:80vh; overflow-y:auto; padding:24px; max-width:600px;">
                <div style="text-align:center; margin-bottom:24px;">
                    <h2 style="font-size:2rem; margin-bottom:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                         Benvenuto a Eldoria!
                    </h2>
                    <p style="font-size:1.1rem; opacity:0.9; margin-bottom:16px;">
                        La citt dove i sogni diventano realt... o incubi.
                    </p>
                </div>

                <div style="background:rgba(255,255,255,0.08); padding:16px; border-radius:12px; margin-bottom:16px; border-left:4px solid #667eea;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem;"> La Tua Storia</h3>
                    <p style="font-size:0.95rem; line-height:1.6; opacity:0.9;">
                        Sei appena arrivato a <strong>Eldoria</strong>, una metropoli vibrante e pericolosa. 
                        Hai lasciato tutto alle spalle per cercare una nuova vita. 
                        Ora sei <span style="color:#eb3349;">senzatetto</span>, senza lavoro e con pochissimi soldi in tasca.
                    </p>
                </div>

                <div style="background:rgba(255,255,255,0.08); padding:16px; border-radius:12px; margin-bottom:16px; border-left:4px solid #38ef7d;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem;"> Cosa Devi Fare</h3>
                    <div style="font-size:0.9rem; line-height:1.8; opacity:0.9;">
                        <div style="margin-bottom:8px;">
                            <strong> 1. Trova una Casa</strong><br>
                            <span style="opacity:0.8;">Vivere per strada  duro: perdi -30 morale, -20 salute e -15 energia ogni giorno! 
                            Vai su <em>Propriet  Cerca un'Abitazione</em> e affitta o acquista una casa.</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong> 2. Cerca Lavoro</strong><br>
                            <span style="opacity:0.8;">Senza reddito non sopravviverai. Vai su <em>Lavoro  Cerca Lavoro</em> e trova un'occupazione. 
                            Ricorda: devi lavorare 5 giorni a settimana o rischi il licenziamento!</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong> 3. Gestisci i Soldi</strong><br>
                            <span style="opacity:0.8;">Hai <em>contante</em> (rubabile) e <em>deposito bancario</em> (sicuro). 
                            Deposita i soldi in banca per proteggerli dai furti! Usa il tab Banca.</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong> 4. Investi e Cresci</strong><br>
                            <span style="opacity:0.8;">Compra azioni in borsa, acquista propriet, apri attivit commerciali. 
                            Pi investi, pi guadagni!</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong> 5. Esplora la Citt</strong><br>
                            <span style="opacity:0.8;">Eldoria ha 5 quartieri: Periferia (economica ma pericolosa), 
                            Centro Storico (costoso ma prestigioso), Quartiere Lusso (per i ricchi). 
                            Ogni zona ha vantaggi e svantaggi.</span>
                        </div>
                    </div>
                </div>

                <div style="background:rgba(235,51,73,0.15); padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid #eb3349;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem; color:#eb3349;"> Attenzione</h3>
                    <ul style="font-size:0.9rem; line-height:1.6; opacity:0.9; margin-left:20px;">
                        <li>Ogni quartiere ha un <strong>livello di criminalit</strong>: puoi essere derubato, i tuoi veicoli danneggiati o subire furti in casa!</li>
                        <li>Se sei senzatetto, le tue prestazioni lavorative crollano (-40%) e rischi il licenziamento.</li>
                        <li>Devi pagare l'<strong>affitto ogni mese</strong> o sarai sfrattato dopo 60 giorni.</li>
                        <li>Controlla sempre <strong>energia, salute, morale e igiene</strong>: se crollano, non potrai lavorare!</li>
                    </ul>
                </div>

                <div style="text-align:center; padding-top:16px;">
                    <button onclick="closeTutorial()" class="action-btn" style="width:100%; font-size:1.1rem; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                         Inizia la Tua Avventura!
                    </button>
                    <div style="margin-top:12px;">
                        <button onclick="skipTutorial()" style="background:transparent; border:none; color:rgba(255,255,255,0.6); cursor:pointer; font-size:0.85rem; text-decoration:underline;">
                            Salta Tutorial (non mostrare pi)
                        </button>
                    </div>
                </div>
            </div>
        `;

        showDialog(html);
    }

    function closeTutorial() {
        closeDialog();
    }

    function skipTutorial() {
        localStorage.setItem('eldoriaTutorialShown', 'true');
        closeDialog();
        showNotification(' Tutorial disattivato. Buona fortuna a Eldoria!', 3000);
    }

    function resetTutorial() {
        localStorage.removeItem('eldoriaTutorialShown');
        showNotification(' Tutorial riattivato! Verr mostrato al prossimo caricamento.', 3000);
    }

    function buyTransportPass() {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        if (game.player.money < 50) {
            showNotification(' Serve 50 per l\'abbonamento!', 1500);
            return;
        }

        game.player.money -= 50;
        game.cityMap.transportPass = game.time.day + 30;
        showNotification(' Hai acquistato l\'abbonamento mensile!', 2000);
        updateUI();
    }

    function takeBus(routeKey) {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        const route = BUS_ROUTES[routeKey];
        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;

        if (!hasPass) {
            if (game.player.money < route.cost) {
                showNotification(' Non hai abbastanza soldi!', 1500);
                return;
            }
            game.player.money -= route.cost;
        }

        passTime(route.time / 60); // Convert minutes to hours
        showNotification(` Hai preso la ${route.name}`, 1500);
        updateUI();
    }

    // ---------- ROMANCE SYSTEM ----------
    function renderRomanceStatus() {
        const div = $('romanceStatus');
        if (!div) return;

        if (game.relationships.spouse) {
            const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,105,180,0.15); border-radius:12px; border-left:3px solid #ff69b4;">
                    <h4> Sposato/a con ${spouse.name}</h4>
                    <div style="margin-top:8px; font-size:0.9rem;">
                         Relazione: ${spouse.relation}/100<br>
                         Lavoro: ${spouse.job}<br>
                         Sposati da ${game.time.day - (spouse.marriageDay || 0)} giorni
                    </div>
                    <div style="margin-top:12px; display:flex; gap:8px;">
                        <button class="small" onclick="openDialogue('${spouse.id}')"> Parla</button>
                        <button class="small" onclick="dateNight()"> Serata Romantica</button>
                        ${!game.relationships.children.length ? '<button class="small" onclick="tryForBaby()"> Prova ad avere un figlio</button>' : ''}
                    </div>
                </div>
            `;
        } else if (game.relationships.romantic) {
            const partner = game.npcs.find(n => n.id === game.relationships.romantic);
            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,182,193,0.15); border-radius:12px; border-left:3px solid #ffb6c1;">
                    <h4> In relazione con ${partner.name}</h4>
                    <div style="margin-top:8px; font-size:0.9rem;">
                         Relazione: ${partner.relation}/100<br>
                         Lavoro: ${partner.job}
                    </div>
                    <div style="margin-top:12px; display:flex; gap:8px;">
                        <button class="small" onclick="openDialogue('${partner.id}')"> Parla</button>
                        <button class="small" onclick="goOnDate('${partner.id}')"> Appuntamento</button>
                        ${partner.relation >= 80 ? '<button class="small" onclick="propose(\'' + partner.id + '\')"> Proposta</button>' : ''}
                        <button class="small" onclick="breakUp('${partner.id}')"> Lascia</button>
                    </div>
                </div>
            `;
        } else {
            div.innerHTML = '<p style="opacity:0.7; padding:12px;">Nessuna relazione romantica. Conosci persone e costruisci relazioni forti!</p>';
        }
    }

    function renderPotentialPartners() {
        const div = $('potentialPartners');
        if (!div) return;

        if (game.relationships.romantic || game.relationships.spouse) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Sei gi in una relazione.</p>';
            return;
        }

        const eligible = game.npcs.filter(n => 
            !n.isInterviewing && 
            n.relation >= 50 && 
            !game.relationships.dating.includes(n.id)
        );

        if (eligible.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Migliora le relazioni con le persone (50) per sbloccare opzioni romantiche.</p>';
            return;
        }

        div.innerHTML = eligible.map(npc => `
            <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;"> ${npc.name}</div>
                    <div style="font-size:0.85rem; opacity:0.8;">${npc.job} | Relazione: ${npc.relation}/100</div>
                </div>
                <button class="small" onclick="askOut('${npc.id}')"> Chiedi di uscire</button>
            </div>
        `).join('');
    }

    function askOut(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || npc.relation < 50) {
            showNotification('La relazione non  abbastanza forte!', 1500);
            return;
        }

        const success = Math.random() < (npc.relation / 100);
        
        if (success) {
            game.relationships.romantic = npcId;
            game.relationships.dating.push(npcId);
            npc.relation = clamp(npc.relation + 10);
            showNotification(` ${npc.name} ha accettato! Siete ora una coppia!`, 2500);
        } else {
            npc.relation = clamp(npc.relation - 5);
            showNotification(` ${npc.name} ha rifiutato gentilmente. Forse un'altra volta...`, 2000);
        }
        
        updateUI();
    }

    function goOnDate(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || game.player.money < 50) {
            showNotification('Serve 50 per un appuntamento!', 1500);
            return;
        }

        game.player.money -= 50;
        npc.relation = clamp(npc.relation + randInt(8, 15));
        game.player.stats.morale = clamp(game.player.stats.morale + 20);
        
        passTime(3);
        showNotification(` Bellissimo appuntamento con ${npc.name}! Relazione: ${npc.relation}/100`, 2500);
        updateUI();
    }

    function propose(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || npc.relation < 80) {
            showNotification('La relazione non  abbastanza forte per il matrimonio!', 2000);
            return;
        }

        if (confirm(`Vuoi sposare ${npc.name}?`)) {
            game.relationships.spouse = npcId;
            game.relationships.romantic = null;
            npc.marriageDay = game.time.day;
            npc.relation = 100;
            
            showNotification(` Congratulazioni! Hai sposato ${npc.name}!`, 3000);
            game.player.stats.morale = 100;
            updateUI();
        }
    }

    function breakUp(npcId) {
        if (confirm('Sei sicuro di voler lasciare questa persona?')) {
            game.relationships.romantic = null;
            const npc = game.npcs.find(n => n.id === npcId);
            if (npc) npc.relation = clamp(npc.relation - 30);
            
            game.player.stats.morale = clamp(game.player.stats.morale - 20);
            showNotification(' Hai lasciato la relazione.', 2000);
            updateUI();
        }
    }

    function dateNight() {
        if (game.player.money < 100) {
            showNotification('Serve 100 per una serata speciale!', 1500);
            return;
        }

        game.player.money -= 100;
        const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
        if (spouse) spouse.relation = clamp(spouse.relation + 5);
        
        game.player.stats.morale = clamp(game.player.stats.morale + 25);
        passTime(4);
        showNotification(' Serata romantica indimenticabile!', 2000);
        updateUI();
    }

    // ---------- FAMILY SYSTEM ----------
    function renderFamilyStatus() {
        const div = $('familyStatus');
        if (!div) return;

        if (!game.relationships.spouse) {
            div.innerHTML = '<p style="opacity:0.7;">Devi essere sposato/a per avere una famiglia.</p>';
            return;
        }

        const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
        div.innerHTML = `
            <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <h4> La Tua Famiglia</h4>
                <div style="margin-top:8px;">
                    <p> Coniuge: ${spouse.name}</p>
                    <p style="margin-top:4px;"> Figli: ${game.relationships.children.length}</p>
                </div>
            </div>
        `;

        renderChildren();
    }

    function renderChildren() {
        const div = $('childrenList');
        if (!div || game.relationships.children.length === 0) {
            if (div) div.innerHTML = '';
            return;
        }

        div.innerHTML = `
            <h4 style="margin-bottom:8px;"> I Tuoi Figli</h4>
            ${game.relationships.children.map(child => {
                const age = Math.floor((game.time.day - child.bornDay) / 365);
                return `
                    <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                        <div style="font-weight:bold;">${child.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                            Et: ${age} anni (${game.time.day - child.bornDay} giorni)<br>
                            Umore: ${child.mood || 'Felice'}
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    }

    function tryForBaby() {
        if (!game.relationships.spouse) {
            showNotification('Devi essere sposato/a!', 1500);
            return;
        }

        const chance = 0.3;
        if (Math.random() < chance) {
            const names = ['Luca', 'Sofia', 'Marco', 'Giulia', 'Alessandro', 'Elena'];
            const babyName = names[randInt(0, names.length - 1)];
            
            game.relationships.children.push({
                name: babyName,
                bornDay: game.time.day,
                mood: 'Felice'
            });
            
            showNotification(` Congratulazioni!  nato/a ${babyName}!`, 3000);
            game.player.stats.morale = 100;
        } else {
            showNotification('Non ancora... Riprova pi tardi!', 2000);
        }
        
        passTime(1);
        updateUI();
    }

    // ---------- INVESTMENTS SYSTEM ----------
    // ---------- COMPANY SYSTEM ----------
    function initializeCompanies() {
        // Extract unique companies from job listings and locations
        const companies = new Map();
        
        // Get companies from job locations
        game.jobListings.forEach(job => {
            const location = findLocationById(job.locationId);
            if (location && location.name) {
                const companyId = job.locationId;
                if (!companies.has(companyId)) {
                    companies.set(companyId, {
                        id: companyId,
                        name: location.name,
                        business: location.business,
                        locationIds: [job.locationId],
                        neighborhood: job.location,
                        employees: 0,
                        performance: 50 + Math.random() * 30, // Start 50-80
                        performanceHistory: [],
                        revenue: 0,
                        foundedDay: game.time.day
                    });
                }
                // Count employees
                const company = companies.get(companyId);
                if (game.player.job === job.name && game.player.workplace === job.locationId) {
                    company.employees++;
                }
            }
        });
        
        // Convert to object
        game.companies = {};
        companies.forEach((company, id) => {
            game.companies[id] = company;
        });
        
        // Generate stocks from companies
        generateStocksFromCompanies();
    }
    
    function findLocationById(locationId) {
        for (const neighborhood in CITY_LOCATIONS) {
            const location = CITY_LOCATIONS[neighborhood].find(loc => loc.id === locationId);
            if (location) return location;
        }
        return null;
    }
    
    function generateStocksFromCompanies() {
        STOCKS = {};
        
        // Only create stocks for companies with certain business types
        const stockEligibleTypes = ['boutique', 'ristorante', 'palestra', 'libreria', 'galleria', 
                                    'pasticceria', 'supermercato', 'ferramenta', 'gioielleria', 
                                    'ristorante_stellato', 'spa'];
        
        Object.values(game.companies).forEach(company => {
            if (stockEligibleTypes.includes(company.business)) {
                const basePrice = 50 + Math.random() * 150; // 50-200
                STOCKS[company.id] = {
                    name: company.name,
                    companyId: company.id,
                    price: basePrice,
                    volatility: 0.08 + Math.random() * 0.12, // 8-20%
                    performance: company.performance
                };
            }
        });
    }
    
    function updateCompanyPerformance() {
        Object.values(game.companies).forEach(company => {
            let performance = company.performance;
            
            // Base random fluctuation
            performance += (Math.random() - 0.5) * 10;
            
            // Employee factor
            const expectedEmployees = company.locationIds.length * 3;
            if (company.employees > expectedEmployees) {
                performance += 5; // Well staffed
            } else if (company.employees < expectedEmployees * 0.5) {
                performance -= 10; // Understaffed
            }
            
            // Revenue factor (simulated based on business type and neighborhood)
            const revenueMultipliers = {
                'periferia': 0.8,
                'quartiere_operaio': 1.0,
                'zona_residenziale': 1.2,
                'centro_storico': 1.5,
                'quartiere_lusso': 2.0
            };
            const multiplier = revenueMultipliers[company.neighborhood] || 1.0;
            company.revenue = company.employees * 1000 * multiplier;
            
            // Clamp performance
            performance = Math.max(0, Math.min(100, performance));
            
            // Track history
            company.performanceHistory.push({
                day: game.time.day,
                performance: performance
            });
            
            // Keep only last 30 days
            if (company.performanceHistory.length > 30) {
                company.performanceHistory.shift();
            }
            
            company.performance = performance;
            
            // Check for bankruptcy or expansion
            checkCompanyStatus(company);
        });
    }
    
    function checkCompanyStatus(company) {
        // Check bankruptcy: performance < 20 for 30+ days
        if (company.performanceHistory.length >= 30) {
            const last30 = company.performanceHistory.slice(-30);
            const avgPerformance = last30.reduce((sum, h) => sum + h.performance, 0) / 30;
            
            if (avgPerformance < 20 && company.performance < 20) {
                triggerBankruptcy(company);
                return;
            }
            
            // Check expansion: performance > 85 for 30+ days
            if (avgPerformance > 85 && company.performance > 85) {
                if (!company.lastExpansionDay || (game.time.day - company.lastExpansionDay) > 60) {
                    triggerExpansion(company);
                }
            }
        }
    }
    
    function triggerBankruptcy(company) {
        showNotification(` BREAKING NEWS: ${company.name} ha dichiarato bancarotta!`, 5000);
        
        // Set stock price to 0
        if (STOCKS[company.id]) {
            STOCKS[company.id].price = 0;
        }
        
        // Fire employees working there
        game.jobListings = game.jobListings.filter(job => {
            if (job.locationId === company.id) {
                if (game.player.job === job.name && game.workData?.currentJob?.locationId === company.id) {
                    game.player.job = 'Disoccupato';
                    game.player.jobSalary = 0;
                    game.workData.currentJob = null;
                    showNotification(` Sei stato licenziato a causa del fallimento di ${company.name}!`, 4000);
                }
                return false; // Remove job listing
            }
            return true;
        });
        
        // Remove location from map (mark as closed)
        company.locationIds.forEach(locId => {
            const location = findLocationById(locId);
            if (location) {
                location.status = 'closed';
                location.business = 'chiuso';
            }
        });
        
        // Remove company
        delete game.companies[company.id];
        delete STOCKS[company.id];
        
        updateUI();
    }
    
    function triggerExpansion(company) {
        showNotification(` ${company.name} apre una nuova sede!`, 4000);
        
        company.lastExpansionDay = game.time.day;
        
        // Increase stock price
        if (STOCKS[company.id]) {
            STOCKS[company.id].price *= 1.2;
        }
        
        // Add new location to the same neighborhood
        const neighborhood = company.neighborhood;
        const newLocationId = `${company.id}_expansion_${Date.now()}`;
        
        const newLocation = {
            id: newLocationId,
            type: 'shop',
            name: `${company.name} - Nuova Sede`,
            business: company.business,
            street: `Via Espansione ${Math.floor(Math.random() * 100)}`,
            status: 'occupied',
            income: 300,
            x: Math.random() * 100,
            y: Math.random() * 100
        };
        
        CITY_LOCATIONS[neighborhood].push(newLocation);
        company.locationIds.push(newLocationId);
        
        // Add new job listings for this location
        const newJobId = `job_expansion_${Date.now()}`;
        const baseJob = game.jobListings.find(j => j.locationId === company.id);
        
        if (baseJob) {
            const newJob = {
                ...baseJob,
                id: newJobId,
                locationId: newLocationId
            };
            game.jobListings.push(newJob);
        }
        
        updateUI();
    }
    
    function updateStockPrices() {
        Object.keys(STOCKS).forEach(key => {
            const stock = STOCKS[key];
            
            // Base volatility change
            const change = (Math.random() - 0.5) * 2 * stock.volatility;
            let newPrice = stock.price * (1 + change);
            
            // Company performance influence
            const company = game.companies[stock.companyId];
            if (company) {
                const performanceInfluence = (company.performance - 50) / 500; // -0.1 to +0.1
                newPrice *= (1 + performanceInfluence);
                
                // Update stock performance reference
                stock.performance = company.performance;
            }
            
            stock.price = Math.max(1, newPrice); // Minimum 1 (unless bankrupt = 0)
        });
    }

    function renderStockMarket() {
        const div = $('stockMarket');
        if (!div) return;

        div.innerHTML = getMarketStatusHTML() + Object.keys(STOCKS).map(key => {
            const stock = STOCKS[key];
            const owned = game.investments.stocks.find(s => s.id === key);
            const company = game.companies[stock.companyId];
            
            // Performance indicator
            let perfColor = '#4ade80'; // green
            let perfIcon = '';
            if (company) {
                if (company.performance < 30) {
                    perfColor = '#ef4444'; // red
                    perfIcon = '';
                } else if (company.performance < 60) {
                    perfColor = '#f59e0b'; // orange
                    perfIcon = '';
                }
            }
            
            return `
                <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:10px;">
                    <div style="font-weight:bold; margin-bottom:6px;">${stock.name}</div>
                    <div style="font-size:1.2rem; color:var(--success); margin-bottom:8px;">${stock.price.toFixed(2)}</div>
                    ${company ? `
                        <div style="font-size:0.75rem; opacity:0.9; margin-bottom:4px; color:${perfColor};">
                            ${perfIcon} Performance: ${company.performance.toFixed(0)}%
                        </div>
                        <div style="font-size:0.75rem; opacity:0.7; margin-bottom:8px;">
                             Dipendenti: ${company.employees} |  Revenue: ${company.revenue.toFixed(0)}
                        </div>
                    ` : ''}
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">
                        ${owned ? `Possedute: ${owned.shares} azioni` : 'Non possedute'}
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button class="small" onclick="buyStock('${key}')">Compra</button>
                        ${owned ? `<button class="small" onclick="sellStock('${key}')">Vendi</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------- MARKET HOURS ----------
    function isMarketOpen() {
        const dayOfWeek = game.time.day % 7;
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // Domenica=0, Sabato=6
        const hour = game.time.hour;
        
        if (isWeekend) {
            return { open: false, reason: 'Il mercato  chiuso nei weekend' };
        }
        
        if (hour < 9) {
            return { open: false, reason: `Il mercato apre alle 9:00 AM (ora: ${formatTime(hour, game.time.minute)})` };
        }
        
        if (hour >= 17) {
            return { open: false, reason: `Il mercato  chiuso (chiude alle 5:00 PM, ora: ${formatTime(hour, game.time.minute)})` };
        }
        
        return { open: true, reason: '' };
    }
    
    function getMarketStatusHTML() {
        const status = isMarketOpen();
        if (status.open) {
            return `<div style="background: rgba(0,255,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                <strong> MERCATO APERTO</strong><br>
                <small>Lun-Ven 9:00-17:00 | Ora: ${formatTime(game.time.hour, game.time.minute)}</small>
            </div>`;
        } else {
            return `<div style="background: rgba(255,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                <strong> MERCATO CHIUSO</strong><br>
                <small>${status.reason}</small>
            </div>`;
        }
    }

    function buyStock(stockId) {
        const marketStatus = isMarketOpen();
        if (!marketStatus.open) {
            showNotification(` ${marketStatus.reason}`, 3000);
            return;
        }
        
        const stock = STOCKS[stockId];
        const amount = prompt('Quante azioni vuoi comprare?', '1');
        if (!amount) return;

        const shares = parseInt(amount);
        const cost = stock.price * shares;

        if (game.player.money < cost) {
            showNotification(' Non hai abbastanza soldi!', 1500);
            return;
        }

        game.player.money -= cost;
        game.player.cash -= cost;
        
        const existing = game.investments.stocks.find(s => s.id === stockId);
        if (existing) {
            existing.shares += shares;
            existing.avgPrice = ((existing.avgPrice * (existing.shares - shares)) + (stock.price * shares)) / existing.shares;
        } else {
            game.investments.stocks.push({
                id: stockId,
                name: stock.name,
                shares: shares,
                avgPrice: stock.price
            });
        }

        showNotification(` Hai comprato ${shares} azioni di ${stock.name}!`, 2000);
        updateUI();
        renderStockMarket(); // Aggiorna display
    }

    function sellStock(stockId) {
        const marketStatus = isMarketOpen();
        if (!marketStatus.open) {
            showNotification(` ${marketStatus.reason}`, 3000);
            return;
        }
        
        const stock = STOCKS[stockId];
        const owned = game.investments.stocks.find(s => s.id === stockId);
        if (!owned) return;

        const amount = prompt(`Quante azioni vuoi vendere? (Hai: ${owned.shares})`, owned.shares);
        if (!amount) return;

        const shares = Math.min(parseInt(amount), owned.shares);
        const revenue = stock.price * shares;
        const profit = (stock.price - owned.avgPrice) * shares;

        game.player.money += revenue;
        game.player.cash += revenue;
        owned.shares -= shares;

        if (owned.shares <= 0) {
            game.investments.stocks = game.investments.stocks.filter(s => s.id !== stockId);
        }

        showNotification(` Vendute ${shares} azioni! ${profit >= 0 ? 'Profitto' : 'Perdita'}: ${profit.toFixed(2)}`, 2500);
        updateUI();
        renderStockMarket(); // Aggiorna display
    }

    function renderStockPortfolio() {
        const div = $('stockPortfolio');
        if (!div) return;

        if (game.investments.stocks.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Nessuna azione in portafoglio.</p>';
            return;
        }

        let totalValue = 0;
        let totalInvested = 0;

        div.innerHTML = game.investments.stocks.map(owned => {
            const stock = STOCKS[owned.id];
            const value = stock.price * owned.shares;
            const invested = owned.avgPrice * owned.shares;
            const profit = value - invested;
            const profitPercent = (profit / invested) * 100;

            totalValue += value;
            totalInvested += invested;

            return `
                <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${owned.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">${owned.shares} azioni @ ${stock.price.toFixed(2)}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${profit >= 0 ? '+' : ''}${profit.toFixed(2)}
                        </div>
                        <div style="font-size:0.85rem; opacity:0.8;">${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }).join('') + `
            <div style="margin-top:12px; padding:12px; background:rgba(56,239,125,0.1); border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">
                    <span>Valore Totale:</span>
                    <span style="font-weight:bold;">${totalValue.toFixed(2)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:4px;">
                    <span>P&L Totale:</span>
                    <span style="font-weight:bold; color:${(totalValue - totalInvested) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${(totalValue - totalInvested) >= 0 ? '+' : ''}${(totalValue - totalInvested).toFixed(2)}
                    </span>
                </div>
            </div>
        `;
    }

    function depositSavings() {
        const amount = prompt(` Quanto vuoi depositare nel conto risparmio?\n\nDisponibile: ${game.player.money}\nInteressi: 2% giornaliero`);
        if (!amount) return;

        const deposit = parseInt(amount);
        
        // Validazione input
        if (isNaN(deposit) || deposit <= 0) {
            showNotification(' Importo non valido!', 1500);
            return;
        }
        
        if (deposit > game.player.money) {
            showNotification(` Non hai abbastanza soldi! Hai solo ${game.player.money}`, 2000);
            return;
        }

        game.player.money -= deposit;
        game.investments.savings += deposit;
        showNotification(` Depositati ${deposit} nel conto risparmio! Interessi: 2%/giorno`, 2000);
        updateUI();
    }

    function withdrawSavings() {
        if (game.investments.savings <= 0) {
            showNotification(' Il conto risparmio  vuoto!', 1500);
            return;
        }
        
        const amount = prompt(` Quanto vuoi prelevare?\n\nDisponibile: ${Math.floor(game.investments.savings)}`);
        if (!amount) return;

        const withdrawal = parseInt(amount);
        
        // Validazione input
        if (isNaN(withdrawal) || withdrawal <= 0) {
            showNotification(' Importo non valido!', 1500);
            return;
        }
        
        if (withdrawal > game.investments.savings) {
            showNotification(` Puoi prelevare massimo ${Math.floor(game.investments.savings)}!`, 2000);
            return;
        }

        game.investments.savings -= withdrawal;
        game.player.money += withdrawal;
        showNotification(` Prelevati ${withdrawal} dal conto risparmio!`, 2000);
        updateUI();
    }

    function applySavingsInterest() {
        if (game.investments.savings > 0) {
            const interest = game.investments.savings * 0.02;
            game.investments.savings += interest;
            showNotification(` Interessi maturati: +${interest.toFixed(2)}!`, 2000);
        }
    }

    function renderPropertiesList() {
        const div = $('propertiesList');
        if (!div) return;

        if (game.investments.properties.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Nessuna propriet posseduta.</p>';
            return;
        }

        div.innerHTML = game.investments.properties.map(prop => {
            const propData = PROPERTIES.find(p => p.id === prop.id);
            return `
                <div style="padding:12px; background:rgba(255,255,255,0.08); border-radius:8px; margin-bottom:8px;">
                    <div style="font-weight:bold;">${propData.name}</div>
                    <div style="font-size:0.9rem; opacity:0.9; margin-top:4px;">
                         Rendita: ${propData.income}/mese<br>
                         Zona: ${NEIGHBORHOODS[propData.area].name}
                    </div>
                </div>
            `;
        }).join('');
    }

    function showPropertyMarket() {
        alert('Mercato immobiliare: ' + PROPERTIES.map(p => 
            `${p.name} - ${p.cost} (Rende ${p.income}/mese)`
        ).join('\n'));
    }

    function collectPropertyIncome() {
        if (game.investments.properties.length > 0) {
            const income = game.investments.properties.reduce((sum, prop) => {
                const propData = PROPERTIES.find(p => p.id === prop.id);
                return sum + (propData?.income || 0);
            }, 0);
            
            game.player.money += income;
            showNotification(` Rendita propriet: +${income}!`, 2000);
        }
    }

    // ---------- CRIME SYSTEM ----------
    function renderCrimeStatus() {
        const div = $('crimeStatus');
        if (!div) return;

        const status = game.crime.wanted > 0 ? ' RICERCATO' : ' Pulito';
        const color = game.crime.wanted > 0 ? 'var(--danger)' : 'var(--success)';

        div.innerHTML = `
            <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">Stato Legale</div>
                        <div style="font-size:1.3rem; color:${color}; margin-top:4px;">${status}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.9rem; opacity:0.8;">Livello Ricerca</div>
                        <div style="font-weight:bold; font-size:1.5rem; color:${color};">${game.crime.wanted}</div>
                    </div>
                </div>
                <div style="font-size:0.9rem; opacity:0.9;">
                     Fedina: ${game.crime.reputation}<br>
                     Precedenti: ${game.crime.record.length}
                </div>
                ${game.crime.wanted > 0 ? `
                    <div style="margin-top:12px; padding:10px; background:rgba(235,51,73,0.2); border-radius:8px; text-align:center;">
                         Rischio arresto: ${Math.min(game.crime.wanted * 10, 90)}%
                    </div>
                ` : ''}
            </div>
        `;
    }

    function crimeAction(type) {
        const crimes = {
            pickpocket: { name: 'Borseggio', reward: [20, 100], risk: 0.2, time: 1 },
            burglary: { name: 'Furto', reward: [100, 500], risk: 0.4, time: 3 },
            hack: { name: 'Hacking', reward: [200, 1000], risk: 0.3, time: 4 },
            scam: { name: 'Truffa', reward: [150, 800], risk: 0.35, time: 2 },
            smuggle: { name: 'Contrabbando', reward: [500, 2000], risk: 0.5, time: 6 },
            blackjack: { name: 'Blackjack Illegale', reward: [-200, 500], risk: 0.25, time: 2 }
        };

        const crime = crimes[type];
        if (!crime) return;

        if (!confirm(`Tentare: ${crime.name}?\nRischio: ${crime.risk * 100}%\nTempo: ${crime.time}h`)) {
            return;
        }

        const caught = Math.random() < (crime.risk + game.crime.wanted * 0.05);
        
        if (caught) {
            const fine = randInt(200, 1000);
            game.player.money = Math.max(0, game.player.money - fine);
            game.crime.wanted = clamp(game.crime.wanted + 1, 0, 10);
            game.crime.record.push({ crime: crime.name, day: game.time.day });
            game.crime.reputation = 'Criminale';
            game.player.rep = clamp(game.player.rep - 10, 0, 100);
            game.player.stats.morale = clamp(game.player.stats.morale - 20);
            
            showNotification(` Arrestato per ${crime.name}! Multa: ${fine}`, 3000);
        } else {
            const reward = randInt(crime.reward[0], crime.reward[1]);
            game.player.money += reward;
            game.crime.wanted = clamp(game.crime.wanted + 0.5, 0, 10);
            
            if (reward > 0) {
                showNotification(` ${crime.name} riuscito! +${reward}`, 2500);
            } else {
                showNotification(` ${crime.name} fallito. Persi ${Math.abs(reward)}`, 2000);
            }
        }

        passTime(crime.time);
        updateUI();
    }

    function clearRecord() {
        if (game.player.money < 5000) {
            showNotification('Serve 5000 per pulire la fedina!', 1500);
            return;
        }

        if (confirm('Pagare 5000 per pulire la fedina penale?')) {
            game.player.money -= 5000;
            game.crime.record = [];
            game.crime.wanted = 0;
            game.crime.reputation = 'pulito';
            game.player.rep = clamp(game.player.rep + 10, 0, 100);
            
            showNotification(' Fedina penale pulita!', 2000);
            updateUI();
        }
    }

    // ---------- TIME ----------
    function passTime(hours) {
        // Usa il sistema a minuti per coerenza
        const totalMinutes = Math.round(hours * 60);
        addMinutes(totalMinutes);
    }

    function showWorkInterface(job) {
        const tasks = job.tasks;
        const randomTask = tasks[randInt(0, tasks.length - 1)];
        
        // Create work modal/interface via chat with manager
        const manager = game.npcs.find(n => n.name === job.manager);
        if (!manager) return;

        game.currentChatNpc = manager.id;
        
        if (!game.chatHistory[manager.id]) {
            game.chatHistory[manager.id] = [];
        }

        // OLD: Update chat header - NOW USING DIALOGUE SYSTEM
        // $('chatNpcName').innerText = manager.name + ' (Manager)';
        // $('chatNpcIcon').innerText = '';
        // $('chatNpcJob').innerText = `Lavoro: ${job.name}`;
        // $('chatRelation').innerText = `Performance: ${game.workData.performance}%`;

        // renderChatMessages();

        // OLD: Show chat modal - NOW USING DIALOGUE SYSTEM
        // $('chatModal').classList.add('active');
        // $('chatInput').focus();

        // Manager assigns task
        setTimeout(() => {
            addSystemMessage(` Giornata lavorativa iniziata - ${job.hours.start}:00`);
            setTimeout(() => {
                const taskMessage = `Buongiorno ${game.player.name}. Oggi hai questo compito: "${randomTask}". Come procedi?`;
                game.chatHistory[manager.id].push({ type: 'npc', text: taskMessage });
                renderChatMessages();
                
                // Mark as work conversation
                game.currentWorkTask = randomTask;
            }, 800);
        }, 300);
    }

    function completeWorkDay() {
        if (!game.workData.currentJob) return;

        const job = game.workData.currentJob;
        const salary = game.player.jobSalary || job.salary;
        const performanceBonus = Math.floor(salary * (game.workData.performance / 100 - 1));
        const totalPay = salary + performanceBonus;

        game.player.money += totalPay;
        game.player.totalEarned = (game.player.totalEarned || 0) + totalPay;
        game.player.rep = clamp(game.player.rep + 2, 0, 100);
        game.workData.todayWorked = true;
        game.workData.tasksCompleted++;

        // Apply work effects
        game.player.stats.energy = clamp(game.player.stats.energy - 40);
        game.player.stats.hunger = clamp(game.player.stats.hunger - 30);
        game.player.stats.morale = clamp(game.player.stats.morale + (performanceBonus > 0 ? 10 : -5));

        const workHours = job.hours.end - job.hours.start;
        game.time.hour = job.hours.end;

        const msg = performanceBonus > 0 
            ? ` Ottimo lavoro! Hai guadagnato ${totalPay} (bonus: ${performanceBonus})` 
            : ` Lavoro completato. Hai guadagnato ${totalPay}`;

        showNotification(msg, 2500);
        
        // Random work event
        if (Math.random() > 0.7) {
            triggerWorkEvent();
        }

        updateUI();
        checkQuests();
    }

    function triggerWorkEvent() {
        const events = [
            { msg: ' Il tuo manager ti ha fatto i complimenti!', performance: 5, morale: 10 },
            { msg: ' Hai ricevuto un riconoscimento dal team!', performance: 3, rep: 3 },
            { msg: ' Hai avuto un piccolo disaccordo con un collega', performance: -2, morale: -5 },
            { msg: ' Hai completato un progetto importante!', performance: 8, money: 50 },
            { msg: ' Pausa caff piacevole con i colleghi', morale: 8 }
        ];

        const event = events[randInt(0, events.length - 1)];
        
        if (event.performance) game.workData.performance = clamp(game.workData.performance + event.performance, 0, 150);
        if (event.morale) game.player.stats.morale = clamp(game.player.stats.morale + event.morale);
        if (event.rep) game.player.rep = clamp(game.player.rep + event.rep, 0, 100);
        if (event.money) game.player.money += event.money;

        game.workData.workEvents.push(event.msg);
        showNotification(event.msg, 2500);
    }

    function talkToManager() {
        if (!game.workData.currentJob) return;

        const manager = game.npcs.find(n => n.name === game.workData.currentJob.manager);
        if (!manager) return;

        openDialogue(manager.id);
    }

    function resetDailyWork() {
        game.workData.todayWorked = false;
    }

    // ---------- NPC INTERACTION WRAPPER ----------
    function showNpcChat(npcId) {
        // Wrapper function for NPC interactions - calls the main dialogue system
        console.log('showNpcChat called with npcId:', npcId);
        
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) {
            console.error('NPC not found:', npcId);
            return;
        }
        
        // Check if player knows this NPC
        if (!npc.known) {
            // First time meeting - introduce the NPC
            npc.known = true;
            addLog(`Hai incontrato ${npc.name}, ${npc.job}.`);
        }
        
        // Check if NPC is in the same location as player
        const isInSameLocation = (npc.location === game.cityMap.currentLocation);
        
        // Show communication options if not in same location
        if (!isInSameLocation) {
            showCommunicationOptions(npcId);
            return;
        }
        
        // Update last contact for relationship maintenance
        updateLastContact(npcId);
        
        // Open the dialogue system for in-person conversation
        openDialogue(npcId);
    }
    
    // Show communication method selection
    function showCommunicationOptions(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        let options = [];
        
        // In-person option if possible to travel
        if (canTravelTo(npc.location)) {
            options.push({
                text: ` Vai da ${npc.name} (${npc.location})`,
                action: () => {
                    closeDialog();
                    travelToLocation(npc.location, () => {
                        showNpcChat(npcId); // Recursively call for in-person chat
                    });
                }
            });
        }
        
        // Phone option
        if (game.inventory.devices.phone) {
            options.push({
                text: ` Chiama ${npc.name}`,
                action: () => {
                    closeDialog();
                    startPhoneCall(npcId);
                }
            });
        }
        
        // Computer chat option
        if (game.inventory.devices.computer && npc.hasInternet !== false) {
            options.push({
                text: ` Chatta con ${npc.name} online`,
                action: () => {
                    closeDialog();
                    startOnlineChat(npcId);
                }
            });
        }
        
        // Schedule appointment option
        options.push({
            text: ` Fissa un appuntamento con ${npc.name}`,
            action: () => {
                closeDialog();
                scheduleAppointmentWith(npcId);
            }
        });
        
        if (options.length === 0) {
            addLog(`Non puoi contattare ${npc.name} al momento. Hai bisogno di un telefono o computer, o devi andare da ${npc.pronoun}.`);
            return;
        }
        
        // Show options in a dialog
        let dialogHTML = `
            <h3>Come vuoi contattare ${npc.name}?</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
        `;
        
        options.forEach(option => {
            dialogHTML += `<button onclick="(${option.action.toString()})()" style="padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">${option.text}</button>`;
        });
        
        dialogHTML += `</div>`;
        
        showDialog(dialogHTML, `Contatta ${npc.name}`);
    }
    
    // Phone call system
    function startPhoneCall(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        // Phone call costs energy and money
        if (game.player.stats.energy < 5) {
            addLog('Sei troppo stanco per fare una telefonata.');
            return;
        }
        
        if (game.player.cash < 2) {
            addLog('Non hai abbastanza soldi per la telefonata (2).');
            return;
        }
        
        // Deduct costs
        game.player.cash -= 2;
        game.player.stats.energy = clamp(game.player.stats.energy - 5);
        
        addLog(` Stai chiamando ${npc.name}...`);
        
        // Update last contact
        updateLastContact(npcId);
        
        // Chance of busy/not answering
        if (Math.random() < 0.2) {
            addLog(`${npc.name} non risponde. Riprova pi tardi.`);
            return;
        }
        
        addLog(`${npc.name} risponde al telefono.`);
        passTime(0.25); // Phone calls take 15 minutes
        
        // Open dialogue with phone context
        openDialogue(npcId, { communicationMethod: 'phone' });
    }
    
    // Online chat system
    function startOnlineChat(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        if (npc.hasInternet === false) {
            addLog(`${npc.name} non  disponibile online.`);
            return;
        }
        
        // Online chat costs less energy but requires time
        if (game.player.stats.energy < 3) {
            addLog('Sei troppo stanco per chattare online.');
            return;
        }
        
        game.player.stats.energy = clamp(game.player.stats.energy - 3);
        
        addLog(` Ti stai connettendo con ${npc.name} online...`);
        
        // Update last contact
        updateLastContact(npcId);
        
        // Online chats are usually available
        addLog(`${npc.name}  online e disponibile per chattare.`);
        passTime(0.5); // Online chats take 30 minutes
        
        // Open dialogue with online context
        openDialogue(npcId, { communicationMethod: 'online' });
    }
    
    // Appointment scheduling system
    function scheduleAppointmentWith(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        // Simple appointment scheduling - could be expanded
        const hours = [9, 10, 11, 14, 15, 16, 17, 18, 19, 20];
        const availableHour = hours[Math.floor(Math.random() * hours.length)];
        const appointmentDay = game.time.day + Math.floor(Math.random() * 3) + 1; // 1-3 days from now
        
        // Add appointment
        if (!game.appointments) game.appointments = [];
        
        const appointment = {
            id: Date.now(),
            npcId: npcId,
            npcName: npc.name,
            day: appointmentDay,
            hour: availableHour,
            location: npc.location || cityMap.currentLocation,
            type: 'social',
            description: `Incontro con ${npc.name}`
        };
        
        game.appointments.push(appointment);
        
        addLog(` Hai fissato un appuntamento con ${npc.name} il giorno ${appointmentDay} alle ${availableHour}:00 in ${appointment.location}.`);
        
        // Update last contact
        updateLastContact(npcId);
    }
    
    // Helper function to check if can travel to location
    function canTravelTo(location) {
        // Basic check - can be expanded with travel requirements
        return location && cityMap && cityMap.neighborhoods && 
               Object.keys(cityMap.neighborhoods).includes(location);
    }


    // Helper function needed by both systems
    function getJobIcon(job) {
        const icons = {
            'Studente': '',
            'Barista': '',
            'Programmatore': '',
            'Artista': '',
            'Manager': '',
            'Insegnante': '',
            'Commesso': '',
            'Receptionist': '',
            'Programmatore Jr': '',
            'Disoccupato': '',
            'CEO': '',
            'Imprenditore': '',
            'Direttore': '',
            'HR Manager': '',
            'Team Leader': '',
            'Coordinatore': '',
            'Responsabile Vendite': '',
            'Assistente': '',
            'Collaboratore': ''
        };
        return icons[job] || '';
    }

    // ---------- AUTO-SAVE ----------
    // ============================================
    // SISTEMA DIALOGHI DINAMICO - COMPLETO
    // ============================================

    let currentDialogueNPC = null;

    // Inizializza memoria NPC
    function initNPCMemory(npc) {
        if (!npc.memory) {
            npc.memory = {
                conversations: 0,
                topics: [],
                favors: [],
                promises: [],
                insults: 0,
                compliments: 0,
                lastInteraction: null,
                relationHistory: [npc.relation],
                jobOffered: false,
                jobRejected: false,
                metFamily: false,
                sharedSecrets: false,
                trustLevel: 'sconosciuto',
                mood: 'neutro'
            };
        }
    }

    // Aggiorna livello fiducia
    function updateTrustLevel(npc) {
        const rel = npc.relation;
        const mem = npc.memory;
        
        if (rel >= 90 && mem.sharedSecrets && mem.conversations >= 20) {
            mem.trustLevel = 'familiare';
        } else if (rel >= 70 && mem.conversations >= 10) {
            mem.trustLevel = 'confidente';
        } else if (rel >= 50 && mem.conversations >= 5) {
            mem.trustLevel = 'amico';
        } else if (rel >= 30 || mem.conversations >= 2) {
            mem.trustLevel = 'conoscente';
        } else {
            mem.trustLevel = 'sconosciuto';
        }
    }

    // Sistema check D&D
    function makeCheck(type, difficulty) {
        const player = game.player;
        let modifier = 0;
        
        switch(type) {
            case 'charisma':
                modifier = Math.floor((player.skills.charisma || 0) / 10);
                break;
            case 'intelligence':
                modifier = Math.floor((player.skills.intellect || 0) / 10);
                break;
            case 'creativity':
                modifier = Math.floor((player.skills.creativity || 0) / 10);
                break;
            case 'fitness':
                modifier = Math.floor((player.skills.fitness || 0) / 10);
                break;
        }
        
        const roll = randInt(1, 20) + modifier;
        const success = roll >= difficulty;
        
        return {
            success: success,
            roll: roll - modifier,
            modifier: modifier,
            total: roll,
            margin: roll - difficulty
        };
    }

    // ============================================
    // SISTEMA DIALOGHI CONTESTUALI
    // ============================================
    
    // Determina il contesto della conversazione
    function getConversationContext(npc) {
        // Colloquio di lavoro
        if (game.currentInterview && game.currentInterview.manager && game.currentInterview.manager.id === npc.id) {
            return {
                type: 'job_interview',
                job: game.currentInterview.job
            };
        }
        
        // Giornata lavorativa
        if (game.currentWorkTask && game.workData && game.workData.currentJob && npc.name === game.workData.currentJob.manager) {
            return {
                type: 'work_task',
                task: game.currentWorkTask
            };
        }
        
        // Conversazione normale
        return {
            type: 'normal'
        };
    }
    
    // Genera opzioni per COLLOQUIO DI LAVORO - VERSIONE REALISTICA
    function getJobInterviewOptions(npc, job) {
        const options = [];
        const player = game.player;
        const skills = player.skills;
        
        // Mappa skill per tipo di lavoro
        const jobSkillMap = {
            'Programmatore Junior': 'intellect',
            'Programmatore Senior': 'intellect',
            'Grafico Pubblicitario': 'creativity',
            'Social Media Manager': 'creativity',
            'Commesso Supermercato': 'charisma',
            'Commesso Boutique': 'charisma',
            'Barista': 'charisma',
            'Cameriere': 'charisma',
            'Manager Boutique Luxury': 'charisma',
            'Project Manager': 'intellect',
            'Istruttore Palestra': 'fitness',
            'Terapista SPA': 'fitness'
        };
        
        const relevantSkill = jobSkillMap[job.name] || 'charisma';
        const skillValue = skills[relevantSkill] || 0;
        
        // Calcola difficolt base in base allo stipendio/livello lavoro
        const baseDifficulty = Math.min(18, Math.max(10, Math.floor(job.salary / 20)));
        
        // FASE 1: SALUTO INIZIALE
        if (!npc.memory.jobInterviewStarted) {
            options.push({
                id: 'interview_greeting_confident',
                text: ' Buongiorno, sono molto interessato a questa posizione',
                type: 'interview_greeting',
                check: { type: 'charisma', difficulty: 12 },
                outcomes: {
                    success: { relation: 5, response: 'Ottimo! Mi piace l\'entusiasmo. Iniziamo. Mi parli delle sue competenze.' },
                    failure: { relation: 2, response: 'Bene. Mi parli di lei.' }
                }
            });
            
            options.push({
                id: 'interview_greeting_nervous',
                text: ' Buongiorno... sono qui per il colloquio',
                type: 'interview_greeting',
                outcomes: {
                    relation: 1,
                    response: 'S, lo so. Si calmi e mi parli delle sue competenze per questa posizione.'
                }
            });
            
            npc.memory.jobInterviewStarted = true;
            npc.memory.interviewQuestionCount = 0;
        }
        
        // FASE 2-4: DOMANDE MULTIPLE (3-5 domande per colloquio)
        const questionCount = npc.memory.interviewQuestionCount || 0;
        
        // Pool di domande generiche (sempre disponibili)
        const genericQuestions = [
            {
                id: 'q_why_here',
                text: ' "Perch vuole lavorare qui?"',
                options: [
                    { text: ' Questa azienda  leader nel settore', check: 'charisma', diff: baseDifficulty, success: 5, fail: -3 },
                    { text: ' Mi interessa la retribuzione', check: 'charisma', diff: baseDifficulty + 4, success: 2, fail: -8 },
                    { text: ' Voglio crescere professionalmente', check: 'charisma', diff: baseDifficulty - 2, success: 6, fail: -2 },
                    { text: ' Ho bisogno di un lavoro', check: 'charisma', diff: baseDifficulty + 6, success: 1, fail: -10 }
                ]
            },
            {
                id: 'q_strengths',
                text: ' "Quali sono i suoi punti di forza?"',
                options: [
                    { text: ' Sono affidabile e puntuale', check: 'charisma', diff: baseDifficulty, success: 4, fail: -2 },
                    { text: ' Imparo velocemente', check: 'intellect', diff: baseDifficulty - 1, success: 5, fail: -3 },
                    { text: ' Lavoro bene in team', check: 'charisma', diff: baseDifficulty - 2, success: 6, fail: -2 },
                    { text: ' Sono il migliore!', check: 'charisma', diff: baseDifficulty + 5, success: 8, fail: -12 }
                ]
            },
            {
                id: 'q_weaknesses',
                text: ' "Mi parli di un suo punto debole"',
                options: [
                    { text: ' Perfezionismo - dedico troppo tempo ai dettagli', check: 'charisma', diff: baseDifficulty + 2, success: 7, fail: -4 },
                    { text: ' Sono sempre in ritardo', check: 'charisma', diff: baseDifficulty + 8, success: 2, fail: -15 },
                    { text: ' A volte mi serve pi tempo per apprendere', check: 'charisma', diff: baseDifficulty, success: 5, fail: -5 },
                    { text: ' Non ho difetti rilevanti', check: 'charisma', diff: baseDifficulty + 6, success: 3, fail: -10 }
                ]
            },
            {
                id: 'q_pressure',
                text: ' "Come gestisce lo stress e le scadenze?"',
                options: [
                    { text: ' Lavoro meglio sotto pressione', check: 'fitness', diff: baseDifficulty - 1, success: 6, fail: -3 },
                    { text: ' Organizzo priorit e seguo un piano', check: 'intellect', diff: baseDifficulty, success: 7, fail: -2 },
                    { text: ' Lo stress mi blocca', check: 'charisma', diff: baseDifficulty + 8, success: 1, fail: -12 },
                    { text: ' Uso tecniche di rilassamento', check: 'fitness', diff: baseDifficulty + 1, success: 5, fail: -4 }
                ]
            },
            {
                id: 'q_future',
                text: ' "Dove si vede tra 5 anni?"',
                options: [
                    { text: ' In una posizione senior in questa azienda', check: 'charisma', diff: baseDifficulty - 1, success: 6, fail: -3 },
                    { text: ' A gestire il mio business', check: 'charisma', diff: baseDifficulty + 3, success: 4, fail: -8 },
                    { text: ' Non ci ho ancora pensato', check: 'charisma', diff: baseDifficulty + 6, success: 1, fail: -10 },
                    { text: ' Esperto riconosciuto nel settore', check: 'intellect', diff: baseDifficulty + 2, success: 7, fail: -4 }
                ]
            }
        ];
        
        // Seleziona 1-2 domande generiche casuali
        const shuffledGeneric = [...genericQuestions].sort(() => Math.random() - 0.5);
        const numGenericQuestions = questionCount < 2 ? 2 : 1;
        
        for (let i = 0; i < Math.min(numGenericQuestions, shuffledGeneric.length); i++) {
            const q = shuffledGeneric[i];
            q.options.forEach(opt => {
                options.push({
                    id: `${q.id}_${options.length}`,
                    text: opt.text,
                    type: 'interview_answer',
                    check: { type: opt.check, difficulty: opt.diff },
                    outcomes: {
                        success: { relation: opt.success, response: 'Buona risposta.' },
                        failure: { relation: opt.fail, response: 'Risposta inadeguata.' }
                    }
                });
            });
        }
        
        // DOMANDE SPECIFICHE PER CATEGORIA DI LAVORO
        const techJobs = ['Programmatore Junior', 'Programmatore Senior', 'Grafico Pubblicitario', 'Social Media Manager', 'CTO'];
        const serviceJobs = ['Barista', 'Cameriere', 'Commesso Supermercato', 'Commesso Boutique', 'Addetto Pet Shop', 'Libraio', 'Pasticciere', 'Commesso Ferramenta', 'Commesso Gioielleria'];
        const managerJobs = ['Project Manager', 'Manager Boutique Luxury', 'Direttore', 'CEO'];
        const healthJobs = ['Terapista SPA', 'Istruttore Palestra'];
        const creativeJobs = ['Assistente Gallerista'];
        
        if (techJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // TECH: Domande tecniche
            options.push({
                id: 'tech_skills_strong',
                text: ' Ho esperienza con linguaggi moderni e framework',
                type: 'interview_answer',
                check: { type: 'intellect', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 8, response: 'Ottimo! Competenze solide.' },
                    failure: { relation: -5, response: 'Hmm, pensavo sapesse pi dettagli tecnici...' }
                }
            });
            
            options.push({
                id: 'tech_skills_weak',
                text: ' Sono autodidatta, sto ancora imparando',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 5 },
                outcomes: {
                    success: { relation: 3, response: 'L\'onest  apprezzata, ma serve esperienza.' },
                    failure: { relation: -10, response: 'Cerchiamo qualcuno gi formato...' }
                }
            });
            
            if (skillValue >= 60) {
                options.push({
                    id: 'tech_portfolio',
                    text: ' Ho un portfolio con progetti reali e certificazioni',
                    type: 'interview_answer',
                    check: { type: 'intellect', difficulty: baseDifficulty - 3 },
                    outcomes: {
                        success: { relation: 12, response: 'Eccellente! Profilo perfetto!', jobOfferBoost: 25 },
                        failure: { relation: 4, response: 'Interessante, valuteremo.' }
                    }
                });
            }
        } else if (serviceJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // SERVIZI: Domande customer service
            options.push({
                id: 'service_exp_yes',
                text: ' Ho esperienza nel servizio clienti',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty - 2 },
                outcomes: {
                    success: { relation: 7, response: 'Perfetto! L\'esperienza  fondamentale.' },
                    failure: { relation: -3, response: 'Ma esempi concreti ne ha?' }
                }
            });
            
            options.push({
                id: 'service_exp_no',
                text: ' Primo lavoro ma imparo velocemente',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 4 },
                outcomes: {
                    success: { relation: 3, response: 'Ok, possiamo formarla.' },
                    failure: { relation: -7, response: 'Cerchiamo qualcuno gi formato...' }
                }
            });
            
        } else if (managerJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // MANAGEMENT: Leadership
            options.push({
                id: 'mgmt_leadership',
                text: ' Ho gestito team e raggiunto obiettivi aziendali',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 9, response: 'Esattamente il profilo che cerchiamo!' },
                    failure: { relation: -4, response: 'Servono prove concrete...' }
                }
            });
            
            options.push({
                id: 'mgmt_noexp',
                text: ' Voglio crescere e diventare un leader',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 5 },
                outcomes: {
                    success: { relation: 4, response: 'Ambizione buona, ma serve esperienza.' },
                    failure: { relation: -9, response: 'Cerchiamo manager esperti, non aspiranti.' }
                }
            });
            
        } else if (healthJobs.some(j => job.name.includes(j))) {
            // HEALTH/FITNESS
            options.push({
                id: 'health_cert',
                text: ' Ho certificazioni e esperienza nel settore',
                type: 'interview_answer',
                check: { type: 'fitness', difficulty: baseDifficulty - 1 },
                outcomes: {
                    success: { relation: 8, response: 'Perfetto! Le certificazioni sono importanti.' },
                    failure: { relation: -4, response: 'Le certificazioni sono obbligatorie...' }
                }
            });
            
            options.push({
                id: 'health_passion',
                text: ' Sono appassionato di benessere',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 3 },
                outcomes: {
                    success: { relation: 4, response: 'La passione  buona, ma servono competenze.' },
                    failure: { relation: -6, response: 'Servono qualifiche professionali...' }
                }
            });
            
        } else if (creativeJobs.some(j => job.name.includes(j))) {
            // CREATIVI/CULTURA
            options.push({
                id: 'creative_knowledge',
                text: ' Ho conoscenze approfondite di arte e cultura',
                type: 'interview_answer',
                check: { type: 'creativity', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 7, response: 'Ottimo! La cultura  fondamentale per noi.' },
                    failure: { relation: -3, response: 'Aspettavamo pi preparazione...' }
                }
            });
            
            options.push({
                id: 'creative_passion',
                text: ' Sono molto appassionato d\'arte',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 3 },
                outcomes: {
                    success: { relation: 4, response: 'La passione  importante.' },
                    failure: { relation: -5, response: 'Serve conoscenza, non solo passione.' }
                }
            });
        }
        
        // OPZIONI CHIUSURA COLLOQUIO - sempre disponibili
        // Chiusura formale e professionale
        options.push({
            id: 'interview_conclude_professional',
            text: ' Grazie per il suo tempo. Quando avr una risposta?',
            type: 'interview_end',
            check: { type: 'charisma', difficulty: 12 },
            outcomes: {
                success: {
                    relation: 3,
                    response: ' stato un piacere conoscerla. La ricontatteremo entro 48 ore. Ottima presentazione!',
                    event: 'interview_end'
                },
                failure: {
                    relation: 1,
                    response: 'La ricontatteremo entro 48 ore. Grazie per essere venuto.',
                    event: 'interview_end'
                }
            }
        });
        
        // Chiusura con interesse
        options.push({
            id: 'interview_conclude_interested',
            text: ' Sono molto interessato a questa opportunit. Grazie!',
            type: 'interview_end',
            outcomes: {
                relation: 2,
                response: 'L\'entusiasmo  importante. Valuteremo attentamente la sua candidatura. A presto!',
                event: 'interview_end'
            }
        });
        
        // Chiusura neutrale
        options.push({
            id: 'interview_conclude_neutral',
            text: ' Grazie per l\'opportunit. Buona giornata',
            type: 'interview_end',
            outcomes: {
                relation: 0,
                response: 'Arrivederci. Le faremo sapere.',
                event: 'interview_end'
            }
        });
        
        // Incrementa contatore domande solo se non  il saluto iniziale
        if (npc.memory.jobInterviewStarted) {
            npc.memory.interviewQuestionCount = (npc.memory.interviewQuestionCount || 0) + 1;
        }
        
        return options;
    }
    
    // Genera opzioni per GIORNATA LAVORATIVA
    function getWorkTaskOptions(npc, task) {
        const options = [];
        const player = game.player;
        const job = game.workData?.currentJob;
        
        if (!job) return options;
        
        // Determina skill rilevante
        const jobSkillMap = {
            'Programmatore': 'intellect',
            'Programmatore Jr': 'intellect',
            'Designer': 'creativity',
            'Artista': 'creativity',
            'Manager': 'charisma',
            'Team Leader': 'charisma',
            'Barista': 'charisma',
            'Commesso': 'charisma',
            'Receptionist': 'charisma',
            'Insegnante': 'intellect',
            'Personal Trainer': 'fitness'
        };
        
        const relevantSkill = jobSkillMap[job.name] || 'charisma';
        const skillValue = player.skills[relevantSkill] || 0;
        
        // SALUTO INIZIALE
        if (!npc.memory.workGreeted) {
            const greetings = [
                ' Buongiorno! Pronto a lavorare',
                ' Buongiorno, sono arrivato!',
                ' Buongiorno! Caff bevuto, pronto!',
                ' Buongiorno! Bella giornata!',
                ' Buongiorno! Carico e motivato!'
            ];
            
            options.push({
                id: 'work_greeting',
                text: greetings[randInt(0, greetings.length - 1)],
                type: 'work_greeting',
                outcomes: {
                    relation: 2,
                    response: `Buongiorno ${player.name}. Oggi il tuo compito : "${task}". Come procedi?`
                }
            });
            
            npc.memory.workGreeted = true;
            return options;
        }
        
        // Risposte BASE
        const basicResponses = [
            ' Far del mio meglio',
            ' Ok, ci provo subito',
            ' Capito, inizio ora',
            ' Va bene, lo faccio',
            ' Ricevuto, procedo'
        ];
        
        options.push({
            id: 'task_basic',
            text: basicResponses[randInt(0, basicResponses.length - 1)],
            type: 'work_response',
            check: { type: relevantSkill, difficulty: 14 },
            outcomes: {
                success: { 
                    relation: 3, 
                    performance: 5,
                    response: 'Bene, conta su di te. Fammi sapere se hai dubbi.'
                },
                failure: { 
                    relation: 1,
                    performance: 2,
                    response: 'Ok. Cerca di fare un buon lavoro.'
                }
            }
        });
        
        // Risposte COMPETENTI (30+)
        if (skillValue >= 30) {
            const competentResponses = [
                ' So esattamente come procedere',
                ' Ho gi un piano d\'azione',
                ' Conosco il processo',
                ' So come gestirlo bene'
            ];
            
            options.push({
                id: 'task_competent',
                text: competentResponses[randInt(0, competentResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 12 },
                outcomes: {
                    success: { 
                        relation: 5, 
                        performance: 10,
                        response: 'Ottimo! Mi piace questa sicurezza.'
                    },
                    failure: { 
                        relation: 2,
                        performance: 5,
                        response: 'Ok, mostrami i risultati.'
                    }
                }
            });
        }
        
        // Risposte AVANZATE (50+)
        if (skillValue >= 50) {
            const advancedResponses = [
                ' Ho esperienza in situazioni simili',
                ' User le strategie che hanno funzionato',
                '  nel mio campo di expertise',
                ' Posso applicare tecniche avanzate'
            ];
            
            options.push({
                id: 'task_advanced',
                text: advancedResponses[randInt(0, advancedResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 10 },
                outcomes: {
                    success: { 
                        relation: 7, 
                        performance: 15,
                        response: 'Perfetto! Sapevo di poter contare su di te!',
                        bonus: 20
                    },
                    failure: { 
                        relation: 3,
                        performance: 8,
                        response: 'Bene, mi fido della tua esperienza.'
                    }
                }
            });
        }
        
        // Risposte ESPERTE (70+)
        if (skillValue >= 70) {
            const expertResponses = [
                ' Ho un\'idea per farlo meglio e pi veloce',
                ' Posso ottimizzare il processo',
                ' Conosco una soluzione innovativa',
                ' Ho un metodo molto efficace'
            ];
            
            options.push({
                id: 'task_expert',
                text: expertResponses[randInt(0, expertResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 8 },
                outcomes: {
                    success: { 
                        relation: 10, 
                        performance: 20,
                        response: 'Eccellente! Questa  l\'iniziativa che cerco!',
                        bonus: 40
                    },
                    failure: { 
                        relation: 4,
                        performance: 10,
                        response: 'Interessante. Vediamo i risultati.'
                    }
                }
            });
        }
        
        // Chiedi aiuto
        options.push({
            id: 'task_help',
            text: ' Ho dei dubbi, pu aiutarmi?',
            type: 'work_help',
            outcomes: {
                relation: -1,
                performance: 3,
                response: 'Devi essere pi autonomo, ma ok. Ti spiego...'
            }
        });
        
        // Completa lavoro
        if (game.workData.performance >= 50) {
            options.push({
                id: 'task_complete',
                text: ' Ho finito il compito!',
                type: 'work_complete',
                outcomes: {
                    relation: 3,
                    response: 'Bene! Ottimo lavoro! A domani!',
                    event: 'complete_work_day'
                }
            });
        }
        
        return options;
    }

    // Genera opzioni di dialogo dinamiche (ORIGINALE - per conversazioni normali)
    function getDialogueOptions(npc, context = {}) {
        // Prima controlla il contesto
        const conversationContext = getConversationContext(npc);
        
        // Se  un colloquio, usa le opzioni specifiche
        if (conversationContext.type === 'job_interview') {
            return getJobInterviewOptions(npc, conversationContext.job);
        }
        
        // Altrimenti usa il sistema normale
        initNPCMemory(npc);
        updateTrustLevel(npc);
        
        const options = [];
        const mem = npc.memory;
        const rel = npc.relation;
        const trust = mem.trustLevel;
        const canHire = ['Manager', 'Imprenditore', 'Direttore', 'CEO', 'Titolare', 'HR Manager', 'Team Leader'].includes(npc.job);
        
        // SALUTI
        if (mem.conversations === 0) {
            options.push({
                id: 'intro_friendly',
                text: ` Ciao! Sono ${game.player.name}`,
                type: 'greeting',
                outcomes: { 
                    relation: 3, 
                    memory: ['first_meeting'],
                    response: `Piacere! Io sono ${npc.name}. Che ci fai da queste parti?`
                },
                followUp: [
                    {
                        id: 'intro_job',
                        text: ` Lavoro come ${game.player.job}`,
                        type: 'personal',
                        outcomes: { 
                            relation: 2,
                            response: `Interessante! Io invece faccio ${npc.job}.`
                        },
                        followUp: [
                            {
                                id: 'ask_experience',
                                text: ' Da quanto fai questo lavoro?',
                                type: 'info',
                                outcomes: {
                                    relation: 2,
                                    response: `Ormai da qualche anno. All'inizio era dura, ma ora va meglio.`
                                }
                            },
                            {
                                id: 'ask_like_job',
                                text: ' Ti piace il tuo lavoro?',
                                type: 'personal',
                                outcomes: {
                                    relation: 3,
                                    response: npc.mood === 'felice' ? 'S, tantissimo! Non lo cambierei per niente al mondo.' : 'Ha i suoi pro e contro, ma in generale s.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'intro_explore',
                        text: ' Sto esplorando la citt',
                        type: 'casual',
                        outcomes: { 
                            relation: 2,
                            response: 'Ah, sei nuovo qui? Eldoria  bellissima, vedrai!'
                        },
                        followUp: [
                            {
                                id: 'ask_recommendations',
                                text: ' Cosa mi consigli di visitare?',
                                type: 'advice',
                                outcomes: {
                                    relation: 3,
                                    response: `Devi assolutamente vedere ${['il Centro Storico', 'il Parco Centrale', 'il Porto', 'il Business District'][randInt(0, 3)]}!  stupendo!`
                                }
                            },
                            {
                                id: 'ask_safety',
                                text: ' La citt  sicura?',
                                type: 'advice',
                                outcomes: {
                                    relation: 2,
                                    response: 'Dipende dalle zone. La periferia pu essere pericolosa di notte, ma il centro  tranquillo.'
                                }
                            }
                        ]
                    }
                ]
            });
            if (game.player.skills.charisma >= 20) {
                options.push({
                    id: 'intro_professional',
                    text: ' Buongiorno, piacere di conoscerla',
                    type: 'greeting',
                    check: { type: 'charisma', difficulty: 12 },
                    outcomes: {
                        success: { 
                            relation: 5, 
                            reputation: 2,
                            response: `Che bella presentazione! ${npc.name}, molto lieto. Lei lavora qui?`
                        },
                        failure: { 
                            relation: 1,
                            response: 'Ehm... ciao. Piacere.'
                        }
                    }
                });
            }
        } else {
            options.push({
                id: 'greet_normal',
                text: ' Ciao! Come va?',
                type: 'greeting',
                outcomes: { 
                    relation: 2,
                    response: rel >= 60 ? 'Tutto bene grazie! Tu come stai?' : 'Bene dai, la solita routine.'
                },
                followUp: [
                    {
                        id: 'share_day',
                        text: ' Ti racconto la mia giornata',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: 'Dimmi tutto! Ti ascolto.'
                        },
                        followUp: [
                            {
                                id: 'good_news',
                                text: ' Ho avuto ottime notizie!',
                                type: 'positive',
                                outcomes: {
                                    relation: 4,
                                    response: 'Che bello! Sono felice per te! Raccontami!'
                                }
                            },
                            {
                                id: 'bad_news',
                                text: '  stata una giornata difficile',
                                type: 'negative',
                                outcomes: {
                                    relation: 4,
                                    response: rel >= 50 ? 'Mi dispiace... vuoi parlarne? Sono qui per te.' : 'Oh, mi dispiace. Spero migliori presto.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'ask_their_day',
                        text: ' E tu come stai?',
                        type: 'friendly',
                        outcomes: {
                            relation: 3,
                            response: npc.mood === 'felice' ? 'Benissimo!  una bella giornata!' : 'Insomma, potrebbe andare meglio ma dai.'
                        }
                    }
                ]
            });
        }
        
        // LAVORO
        if (canHire && !mem.jobOffered && !mem.jobRejected) {
            if (trust === 'sconosciuto' || trust === 'conoscente') {
                options.push({
                    id: 'job_inquiry_cold',
                    text: ' State cercando personale?',
                    type: 'job',
                    outcomes: {
                        relation: 1,
                        response: 'Mmm, non so chi sei. Parliamo prima, poi vediamo.'
                    }
                });
            } else if (trust === 'amico') {
                options.push({
                    id: 'job_inquiry_friend',
                    text: ' Sai di qualche opportunit di lavoro?',
                    type: 'job',
                    check: { type: 'charisma', difficulty: 14 },
                    outcomes: {
                        success: {
                            relation: 5,
                            event: 'job_offer',
                            response: 'Sai che c\'? Ho proprio bisogno di qualcuno di fidato!'
                        },
                        failure: {
                            relation: 2,
                            response: 'Al momento no, ma ti far sapere!'
                        }
                    }
                });
            } else if (trust === 'confidente' || trust === 'familiare') {
                options.push({
                    id: 'job_direct',
                    text: ' Ho bisogno di un lavoro, puoi aiutarmi?',
                    type: 'job',
                    outcomes: {
                        relation: 3,
                        event: 'job_offer_guaranteed',
                        response: 'Certo! Per te c\' sempre posto. Quando puoi iniziare?'
                    }
                });
            }
        } else if (mem.jobOffered && game.player.job !== 'Disoccupato') {
            options.push({
                id: 'job_thankyou',
                text: ' Grazie ancora per il lavoro!',
                type: 'gratitude',
                outcomes: {
                    relation: 3,
                    response: 'Figurati! Stai andando bene?'
                }
            });
        }
        
        // CONVERSAZIONE PERSONALE
        if (trust === 'sconosciuto') {
            options.push({
                id: 'personal_basic',
                text: ' Cosa fai nella vita?',
                type: 'personal',
                outcomes: {
                    relation: 2,
                    memory: ['asked_about_life'],
                    response: `Faccio ${npc.job}. E tu?`
                },
                followUp: [
                    {
                        id: 'tell_job',
                        text: ` Io sono ${game.player.job}`,
                        type: 'personal',
                        outcomes: {
                            relation: 2,
                            response: 'Interessante! Ti piace?'
                        },
                        followUp: [
                            {
                                id: 'love_job',
                                text: ' S, mi piace molto!',
                                type: 'positive',
                                outcomes: {
                                    relation: 3,
                                    response: 'Che bello quando si fa quello che piace!'
                                }
                            },
                            {
                                id: 'hate_job',
                                text: ' In realt non tanto...',
                                type: 'negative',
                                outcomes: {
                                    relation: 2,
                                    response: 'Capisco... spero tu possa trovare qualcosa di meglio.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'ask_hobbies',
                        text: ' Hai degli hobby?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: `Nel tempo libero mi piace ${['leggere', 'fare sport', 'guardare film', 'ascoltare musica', 'cucinare'][randInt(0, 4)]}.`
                        }
                    }
                ]
            });
        } else if (trust === 'conoscente' || trust === 'amico') {
            options.push({
                id: 'personal_deeper',
                text: ' Come ti trovi qui in citt?',
                type: 'personal',
                outcomes: {
                    relation: 3,
                    memory: ['deeper_conversation'],
                    response: 'Beh, Eldoria ha i suoi pro e contro. Ma ci si abitua.'
                },
                followUp: [
                    {
                        id: 'ask_origins',
                        text: ' Sei di qui originariamente?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: Math.random() > 0.5 ? 'S, sono nato qui. Conosco ogni angolo!' : 'No, mi sono trasferito qualche anno fa. Ma ormai  casa.'
                        }
                    },
                    {
                        id: 'ask_dreams',
                        text: ' Hai dei sogni nel cassetto?',
                        type: 'intimate',
                        check: { type: 'charisma', difficulty: 12 },
                        outcomes: {
                            success: {
                                relation: 5,
                                response: 'S... vorrei davvero realizzare qualcosa di importante. Non so ancora cosa, ma lo sento.'
                            },
                            failure: {
                                relation: 1,
                                response: 'Ehm... chi non ne ha? Ma preferirei non parlarne ora.'
                            }
                        }
                    },
                    {
                        id: 'ask_family',
                        text: ' Hai famiglia qui?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: Math.random() > 0.5 ? 'S, vivono qui vicino. Ci vediamo spesso.' : 'No, la mia famiglia  lontana. Mi manca a volte.'
                        }
                    }
                ]
            });
            
            if (!mem.sharedSecrets && game.player.skills.charisma >= 30) {
                options.push({
                    id: 'share_secret',
                    text: ' Posso confidarti una cosa?',
                    type: 'intimate',
                    check: { type: 'charisma', difficulty: 15 },
                    outcomes: {
                        success: {
                            relation: 8,
                            memory: ['shared_secret'],
                            trustBoost: true,
                            response: 'Certo, dimmi tutto. Sai che puoi fidarti di me.'
                        },
                        failure: {
                            relation: -2,
                            response: 'Ehm... forse  un po\' presto per queste cose...'
                        }
                    },
                    followUp: [
                        {
                            id: 'share_problem',
                            text: ' Ho un problema serio...',
                            type: 'intimate',
                            outcomes: {
                                relation: 6,
                                response: 'Ascolta, qualunque cosa sia, possiamo affrontarla insieme. Parlami.'
                            }
                        },
                        {
                            id: 'share_hope',
                            text: ' Ho un sogno che voglio realizzare',
                            type: 'intimate',
                            outcomes: {
                                relation: 6,
                                response: 'Fantastico! Raccontami tutto, voglio sapere!'
                            }
                        }
                    ]
                });
            }
        }
        
        // USCIRE INSIEME
        if (rel >= 40 && mem.conversations >= 3) {
            options.push({
                id: 'invite_coffee',
                text: ' Ti va di prendere un caff?',
                type: 'social',
                check: { type: 'charisma', difficulty: rel >= 60 ? 10 : 14 },
                outcomes: {
                    success: {
                        relation: 5,
                        happiness: 10,
                        event: 'coffee_date',
                        response: 'Volentieri! Quando sei libero?'
                    },
                    failure: {
                        relation: 0,
                        response: 'Mi piacerebbe ma sono impegnato. Un\'altra volta!'
                    }
                },
                followUp: [
                    {
                        id: 'suggest_now',
                        text: ' Che ne dici di ora?',
                        type: 'social',
                        outcomes: {
                            relation: 4,
                            response: 'Perfetto! Conosco un bel posto qui vicino.',
                            event: 'coffee_immediate'
                        }
                    },
                    {
                        id: 'suggest_later',
                        text: ' Magari domani?',
                        type: 'social',
                        outcomes: {
                            relation: 3,
                            response: 'Va bene! Ci sentiamo domani allora.',
                            event: 'coffee_planned'
                        }
                    },
                    {
                        id: 'my_treat',
                        text: ' Offro io!',
                        type: 'generous',
                        check: { type: 'charisma', difficulty: 10 },
                        outcomes: {
                            success: {
                                relation: 6,
                                response: 'Oh, che gentile! Allora accetto sicuramente!',
                                event: 'coffee_treat'
                            },
                            failure: {
                                relation: 3,
                                response: 'Non c\' bisogno, ma grazie dell\'offerta!'
                            }
                        }
                    }
                ]
            });
        }
        
        if (rel >= 70 && !mem.metFamily) {
            options.push({
                id: 'meet_family',
                text: ' Mi piacerebbe conoscere la tua famiglia',
                type: 'deep_social',
                check: { type: 'charisma', difficulty: 16 },
                outcomes: {
                    success: {
                        relation: 10,
                        event: 'family_meeting',
                        memory: ['met_family'],
                        response: 'Wow, mi fa davvero piacere! Organizzo una cena!'
                    },
                    failure: {
                        relation: 2,
                        response: ' un po\' presto, ma apprezzo l\'interesse!'
                    }
                }
            });
        }
        
        // CONSIGLI
        options.push({
            id: 'advice_money',
            text: ' Consigli per guadagnare?',
            type: 'advice',
            outcomes: {
                relation: 2,
                memory: ['asked_advice'],
                response: 'Beh, devi essere costante. Lavora duro e risparmia.'
            },
            followUp: [
                {
                    id: 'ask_invest',
                    text: ' E gli investimenti?',
                    type: 'advice',
                    outcomes: {
                        relation: 2,
                        response: 'Le azioni sono rischiose ma possono dare buoni ritorni. Studia bene prima!'
                    }
                },
                {
                    id: 'ask_savings',
                    text: ' Come risparmiare meglio?',
                    type: 'advice',
                    outcomes: {
                        relation: 2,
                        response: 'Metti da parte almeno il 20% di quello che guadagni. E tieni i soldi in banca, non tutti in contanti.'
                    }
                },
                {
                    id: 'ask_business',
                    text: ' Meglio dipendente o mettersi in proprio?',
                    type: 'advice',
                    outcomes: {
                        relation: 3,
                        response: 'Dipende. Il lavoro dipendente  sicuro, ma in proprio hai pi libert. Serve coraggio!'
                    }
                }
            ]
        });
        
        if (rel >= 30) {
            options.push({
                id: 'advice_life',
                text: ' Come affronti le difficolt?',
                type: 'advice_deep',
                outcomes: {
                    relation: 3,
                    response: 'Non  mai facile. Ma bisogna andare avanti, un passo alla volta.'
                },
                followUp: [
                    {
                        id: 'ask_motivation',
                        text: ' Come trovi la motivazione?',
                        type: 'advice_deep',
                        outcomes: {
                            relation: 4,
                            response: 'Penso ai miei obiettivi. E alle persone che amo. Loro mi danno forza.'
                        }
                    },
                    {
                        id: 'ask_failure',
                        text: ' E quando fallisci?',
                        type: 'advice_deep',
                        outcomes: {
                            relation: 4,
                            response: 'I fallimenti fanno parte del percorso. L\'importante  imparare e non arrendersi.'
                        }
                    },
                    {
                        id: 'ask_happiness',
                        text: ' Cos\' per te la felicit?',
                        type: 'philosophical',
                        check: { type: 'intellect', difficulty: 12 },
                        outcomes: {
                            success: {
                                relation: 6,
                                response: 'Bella domanda... Per me  fare quello che ami con le persone che ami. Semplice no?'
                            },
                            failure: {
                                relation: 2,
                                response: 'Domanda difficile... non saprei dirti.'
                            }
                        }
                    }
                ]
            });
        }
        
        // AFFARI
        if (game.player.money >= 5000 && rel >= 50 && game.player.skills.intellect >= 30) {
            options.push({
                id: 'business_proposal',
                text: ' Ho un\'idea imprenditoriale...',
                type: 'business',
                check: { type: 'intelligence', difficulty: 15 },
                outcomes: {
                    success: {
                        relation: 6,
                        event: 'business_opportunity',
                        response: 'Interessante! Parliamone con calma.'
                    },
                    failure: {
                        relation: -1,
                        response: 'Mmm, non mi convince. Ripensaci.'
                    }
                }
            });
        }
        
        // INFORMAZIONI
        options.push({
            id: 'city_info',
            text: ' Cosa mi consigli di visitare?',
            type: 'info',
            outcomes: { 
                relation: 1,
                response: `Dovresti vedere ${['il Business District', 'il Centro Storico', 'il Parco Centrale', 'il Porto'][randInt(0, 3)]}!  bellissimo!`
            },
            followUp: [
                {
                    id: 'ask_nightlife',
                    text: ' E per la vita notturna?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'I migliori locali sono nel Centro Storico e nel Porto. Si balla fino all\'alba!'
                    }
                },
                {
                    id: 'ask_restaurants',
                    text: ' Ristoranti da provare?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'Ce ne sono tantissimi! Dipende cosa ti piace. Italiana, cinese, indiana...'
                    },
                    followUp: [
                        {
                            id: 'italian_food',
                            text: ' Italiana sicuramente!',
                            type: 'info',
                            outcomes: {
                                relation: 2,
                                response: 'Allora devi provare "La Tavola Calda" nel Centro Storico. Fantastico!'
                            }
                        },
                        {
                            id: 'exotic_food',
                            text: ' Mi piace provare cucine esotiche',
                            type: 'info',
                            outcomes: {
                                relation: 2,
                                response: 'C\' un ristorante cinese ottimo nel Business District. E uno indiano vicino al Porto!'
                            }
                        }
                    ]
                },
                {
                    id: 'ask_safety',
                    text: ' Quali zone evitare?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'La Periferia di notte pu essere pericolosa. Meglio stare nel centro e nelle zone residenziali.'
                    }
                },
                {
                    id: 'ask_parks',
                    text: ' Parchi e natura?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'Il Parco Centrale  magnifico! Perfetto per correre o rilassarsi. E c\' anche il giardino botanico!'
                    }
                }
            ]
        });
        
        // CONGEDO - Opzioni diverse in base alla relazione
        if (rel >= 70) {
            // Amici stretti
            options.push({
                id: 'leave_friend',
                text: '  stato bello parlare! Ci sentiamo presto!',
                type: 'leave',
                outcomes: {
                    relation: 2,
                    response: 'Sempre un piacere! Chiamami quando vuoi!'
                }
            });
        } else if (rel >= 40) {
            // Conoscenti amichevoli
            options.push({
                id: 'leave_friendly',
                text: ' Devo andare, ci vediamo presto!',
                type: 'leave',
                outcomes: {
                    relation: 1,
                    response: 'Certo, a presto! Buona giornata!'
                }
            });
        } else {
            // Sconosciuti/formale
            options.push({
                id: 'leave_polite',
                text: '  stato un piacere conoscerla. Arrivederci',
                type: 'leave',
                outcomes: {
                    relation: 1,
                    response: 'Arrivederci. Buona giornata!'
                }
            });
        }
        
        // Opzione alternativa pi rapida
        options.push({
            id: 'leave_quick',
            text: ' Scusa, ho fretta. Ciao!',
            type: 'leave',
            outcomes: {
                relation: rel >= 60 ? 0 : -1,
                response: rel >= 60 ? 'Vai vai! Ci sentiamo!' : 'Oh... ok, ciao.'
            }
        });
        
        return options;
    }

    // Esegui scelta dialogo
    function executeDialogueChoice(npc, option) {
        initNPCMemory(npc);
        const mem = npc.memory;
        const outcomes = option.outcomes;
        let result = {
            response: '',
            relationChange: 0,
            events: [],
            checkResult: null
        };
        
        mem.conversations++;
        mem.lastInteraction = game.time.day;
        
        if (option.check) {
            const checkResult = makeCheck(option.check.type, option.check.difficulty);
            result.checkResult = checkResult;
            
            const outcome = checkResult.success ? outcomes.success : outcomes.failure;
            result.relationChange = outcome.relation || 0;
            result.response = generateResponse(npc, option, outcome, checkResult);
            
            if (outcome.event) result.events.push(outcome.event);
            if (outcome.memory) {
                outcome.memory.forEach(m => {
                    if (!mem.topics.includes(m)) mem.topics.push(m);
                });
            }
            if (outcome.trustBoost) mem.sharedSecrets = true;
            if (outcome.happiness) {
                game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + outcome.happiness);
            }
            
            // NUOVI CAMPI PER COLLOQUI
            if (outcome.jobOfferBoost) {
                mem.jobOfferBoost = (mem.jobOfferBoost || 0) + outcome.jobOfferBoost;
            }
            if (outcome.salaryBonus) {
                mem.salaryBonus = (mem.salaryBonus || 0) + outcome.salaryBonus;
            }
            if (outcome.jobOfferGuaranteed) {
                mem.jobOfferGuaranteed = true;
            }
            if (outcome.performance) {
                if (game.workData) {
                    game.workData.performance = Math.min(100, (game.workData.performance || 50) + outcome.performance);
                }
            }
            if (outcome.bonus) {
                game.player.money = (game.player.money || 0) + outcome.bonus;
                showNotification(` Bonus: +${outcome.bonus}!`, 2000);
            }
        } else {
            result.relationChange = outcomes.relation || 0;
            result.response = generateResponse(npc, option, outcomes);
            
            if (outcomes.event) result.events.push(outcomes.event);
            if (outcomes.memory) {
                outcomes.memory.forEach(m => {
                    if (!mem.topics.includes(m)) mem.topics.push(m);
                });
            }
            
            // NUOVI CAMPI anche senza check
            if (outcomes.jobOfferBoost) {
                mem.jobOfferBoost = (mem.jobOfferBoost || 0) + outcomes.jobOfferBoost;
            }
            if (outcomes.salaryBonus) {
                mem.salaryBonus = (mem.salaryBonus || 0) + outcomes.salaryBonus;
            }
            if (outcomes.jobOfferGuaranteed) {
                mem.jobOfferGuaranteed = true;
            }
        }
        
        npc.relation = Math.max(0, Math.min(100, npc.relation + result.relationChange));
        mem.relationHistory.push(npc.relation);
        
        if (result.relationChange > 5) {
            mem.mood = 'felice';
        } else if (result.relationChange < -5) {
            mem.mood = 'arrabbiato';
        } else if (result.relationChange > 0) {
            mem.mood = 'contento';
        }
        
        if (option.type === 'gratitude') mem.compliments++;
        
        // Se  un'opzione di chiusura, aggiungi evento per chiudere il dialogo
        if (option.type === 'leave') {
            result.events.push('conversation_end');
        }
        
        // CONTROLLO COLLOQUIO: NPC chiude automaticamente in base all'andamento
        if (game.currentInterview && game.currentInterview.job && option.type === 'interview_answer') {
            const questionCount = mem.interviewQuestionCount || 0;
            const job = game.currentInterview.job;
            
            // Calcola soglia minima per questo lavoro
            let minRelation = 35;
            const baseSalary = job.salary || 100;
            if (baseSalary < 70) minRelation = 35;
            else if (baseSalary < 150) minRelation = 50;
            else if (baseSalary < 280) minRelation = 65;
            else minRelation = 80;
            
            //  CHIUSURA POSITIVA: NPC entusiasta se relazione molto alta dopo 3+ domande
            if (questionCount >= 3 && npc.relation >= (minRelation + 20)) {
                const positiveClosings = [
                    ' "Complimenti!  esattamente il profilo che cercavamo. Posso dirle che  praticamente assunto! La contatteremo domani con l\'offerta formale."',
                    ' "Wow, ottime risposte! Raramente incontro candidati cos preparati. Direi che abbiamo trovato la persona giusta. Le far avere l\'offerta entro 24 ore!"',
                    ' "Eccellente! Ha tutte le qualifiche che cerchiamo e anche di pi. Posso anticiparle che la posizione  sua. A presto!"',
                    ' "Fantastico colloquio!  chiaro che lei  la persona perfetta per questa posizione. Consideri di essere gi parte del team!"'
                ];
                result.response += '\n\n' + positiveClosings[Math.floor(Math.random() * positiveClosings.length)];
                result.events.push('interview_end');
                mem.jobOfferGuaranteed = true; // Assunzione garantita!
                mem.interviewClosedByNPC = true;
            }
            //  CHIUSURA SODDISFATTA: Se sopra soglia e 4+ domande
            else if (questionCount >= 4 && npc.relation >= minRelation) {
                result.response += '\n\n "Bene, ho visto abbastanza. Lei ha un buon profilo. La ricontatteremo entro 48 ore con la nostra decisione. Grazie per il suo tempo!"';
                result.events.push('interview_end');
                mem.interviewClosedByNPC = true;
            }
            //  CHIUSURA NEGATIVA: relazione troppo bassa dopo 3+ domande
            else if (questionCount >= 3 && npc.relation < (minRelation - 15)) {
                result.response += '\n\n "Senta, credo che questo non sia il posto giusto per lei. Le faremo sapere. Arrivederci."';
                result.events.push('interview_end');
                mem.interviewFailedByNPC = true;
            }
            //  CHIUSURA NEUTRA: colloquio troppo lungo (8+ domande)
            else if (questionCount >= 8) {
                result.response += '\n\n "Direi che ho tutte le informazioni necessarie. La ricontatteremo presto. Grazie per essere venuto."';
                result.events.push('interview_end');
                mem.interviewClosedByNPC = true;
            }
            //  CHIUSURA IMMEDIATA: gaffe grave (risposta che fa perdere 10+ punti)
            else if (result.relationChange <= -10) {
                result.response += '\n\n "Mi dispiace ma questa risposta dimostra che non  adatto alla posizione. Buona giornata."';
                result.events.push('interview_end');
                mem.interviewFailedByNPC = true;
            }
        }
        
        updateTrustLevel(npc);
        
        return result;
    }

    // Genera risposta contestuale
    function generateResponse(npc, option, outcomes, checkResult = null) {
        const mem = npc.memory;
        const personality = npc.personality || 'amichevole';
        
        if (outcomes.response) return outcomes.response;
        
        const responses = {
            'greeting': {
                'amichevole': [
                    `Ciao ${game.player.name}! Che piacere vederti!`,
                    `Ehi! Come va la vita?`
                ],
                'socievole': [
                    `${game.player.name}! Finalmente! Come stai?!`,
                    `Oh wow, ciao! Raccontami tutto!`
                ],
                'introverso': [
                    `Oh, ciao ${game.player.name}.`,
                    `Salve.`
                ],
                'professionale': [
                    `Buongiorno ${game.player.name}. Come posso aiutarla?`,
                    `Salve.  un piacere rivederla.`
                ],
                'creativa': [
                    `Ciao! Sai, stavo pensando proprio a te...`,
                    `Oh ciao! Ho avuto un'idea fantastica!`
                ],
                'paziente': [
                    `Ciao ${game.player.name}. Come ti senti oggi?`,
                    `Salve.  bello vederti.`
                ]
            },
            'personal': {
                'amichevole': [`Beh, lavoro come ${npc.job}. Non  male! Tu cosa fai?`],
                'socievole': [`Faccio il/la ${npc.job}!  fantastico! E tu?`],
                'introverso': [`Sono ${npc.job}. Niente di speciale.`],
                'professionale': [`Mi occupo di ${npc.job}.  la mia professione.`],
                'creativa': [`Lavoro come ${npc.job}, ma sogno sempre qualcosa di pi grande!`],
                'paziente': [`Faccio il/la ${npc.job}. Mi piace aiutare le persone.`]
            },
            'advice': {
                'all': [
                    `Per guadagnare devi essere costante. Lavora ogni giorno e risparmia.`,
                    `Investi in te stesso. Formazione e abilit pagano sempre.`,
                    `Cerca opportunit, non aspettare che arrivino da sole.`
                ]
            },
            'info': {
                'all': [
                    `Ti consiglio il ${['Business District', 'Centro Storico', 'Parco Centrale'][randInt(0, 2)]}.  bellissimo!`,
                    `Dovresti visitare il ${['Tech Hub', 'Quartiere Culturale', 'Porto'][randInt(0, 2)]}!`
                ]
            }
        };
        
        let response = '';
        if (checkResult) {
            if (checkResult.success) {
                response = checkResult.margin >= 5 ? '[Successo Critico!] ' : '[Successo] ';
            } else {
                response = '[Fallimento] ';
            }
        }
        
        if (responses[option.type]) {
            const typeResponses = responses[option.type][personality] || responses[option.type]['all'];
            if (typeResponses) {
                response += typeResponses[randInt(0, typeResponses.length - 1)];
            } else {
                response += 'Interessante...';
            }
        } else {
            response += `${npc.name} riflette un momento...`;
        }
        
        return response;
    }

    // ============================================
    // SISTEMA LAVORATIVO COMPLETO
    // ============================================
    
    // Inizia giornata lavorativa
    function startWorkDay() {
        if (!game.player.job || game.player.job === 'Disoccupato') {
            showNotification(' Non hai un lavoro!', 2000);
            return;
        }
        
        if (!game.workData || !game.workData.currentJob) {
            showNotification(' Dati lavoro non trovati!', 2000);
            return;
        }
        
        const job = game.workData.currentJob;
        const currentHour = game.time.hour;
        
        // Verifica orario
        if (currentHour < job.hours.start || currentHour >= job.hours.end) {
            showNotification(` Puoi lavorare solo tra le ${job.hours.start}:00 e ${job.hours.end}:00`, 2000);
            return;
        }
        
        // Verifica energia
        if (game.player.stats.energy < 30) {
            showNotification(' Troppo stanco! Riposa prima di lavorare.', 2000);
            return;
        }
        
        // Inizializza performance
        if (!game.workData.performance) {
            game.workData.performance = 50;
        }
        
        // Task casuale
        const tasks = job.tasks || [
            'Completare il progetto assegnato',
            'Rispondere alle email urgenti',
            'Preparare il report giornaliero',
            'Gestire le richieste dei clienti',
            'Organizzare la documentazione',
            'Partecipare al meeting di team',
            'Risolvere i problemi tecnici',
            'Coordinare con gli altri reparti'
        ];
        
        game.currentWorkTask = tasks[randInt(0, tasks.length - 1)];
        
        // Trova o crea manager
        let manager = game.npcs.find(n => n.name === job.manager);
        if (!manager) {
            manager = {
                id: 'manager_' + Date.now(),
                name: job.manager || 'Manager',
                job: 'Manager',
                personality: 'professionale',
                relation: 50,
                memory: {}
            };
            game.npcs.push(manager);
        }
        
        // Apri dialogo
        showNotification(` Giornata lavorativa iniziata - ${job.hours.start}:00`, 2000);
        setTimeout(() => {
            openDialogue(manager.id);
        }, 500);
    }
    
    // Completa giornata lavorativa
    function completeWorkDay() {
        if (!game.workData || !game.workData.currentJob) return;
        
        const job = game.workData.currentJob;
        const salary = game.player.jobSalary || job.salary || 100;
        const performance = game.workData.performance || 50;
        
        // Calcola bonus
        const performanceBonus = Math.floor(salary * (performance / 100 - 0.5));
        const totalPay = Math.max(salary + performanceBonus, Math.floor(salary * 0.7));
        
        // Paga
        game.player.money += totalPay;
        game.player.totalEarned = (game.player.totalEarned || 0) + totalPay;
        
        // Reputazione
        if (performance >= 70) {
            game.player.rep = Math.min(100, (game.player.rep || 0) + 3);
        } else if (performance >= 50) {
            game.player.rep = Math.min(100, (game.player.rep || 0) + 2);
        } else {
            game.player.rep = Math.max(0, (game.player.rep || 0) - 1);
        }
        
        // Stats lavoro
        game.workData.todayWorked = true;
        game.workData.tasksCompleted = (game.workData.tasksCompleted || 0) + 1;
        game.workData.totalEarned = (game.workData.totalEarned || 0) + totalPay;
        
        // CONSUMA RISORSE
        const workHours = job.hours.end - job.hours.start;
        
        // Energia: -10 per ora
        game.player.stats.energy = Math.max(0, (game.player.stats.energy || 100) - (workHours * 10));
        
        // Fame: -8 per ora  
        game.player.stats.hunger = Math.max(0, (game.player.stats.hunger || 100) - (workHours * 8));
        
        // Morale
        if (performanceBonus > 0) {
            game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + 10);
        } else if (performance < 40) {
            game.player.stats.morale = Math.max(0, (game.player.stats.morale || 50) - 5);
        }
        
        // PASSA TEMPO
        game.time.hour = job.hours.end;
        if (game.time.hour >= 24) {
            game.time.hour -= 24;
            game.time.day++;
        }
        
        // Reset
        game.currentWorkTask = null;
        game.workData.performance = 50;
        
        // Notifica
        const msg = performanceBonus > 0 
            ? ` Ottimo lavoro! ${totalPay} (bonus: ${performanceBonus})` 
            : performance < 40
            ? ` Completato. ${totalPay} (performance bassa)`
            : ` Completato. ${totalPay}`;
        
        showNotification(msg, 3000);
        
        setTimeout(() => {
            showNotification(` Energia: -${workHours * 10} |  Fame: -${workHours * 8}`, 2500);
        }, 1000);
        
        updateUI();
        closeDialogue();
    }

    // Eventi speciali
    function handleDialogueEvent(eventType, npc) {
        switch(eventType) {
            case 'job_offer':
            case 'job_offer_guaranteed':
                offerJobDialogue(npc);
                break;
            case 'interview_end':
                handleInterviewEnd(npc);
                break;
            case 'conversation_end':
                // Chiude il dialogo dopo la risposta NPC
                setTimeout(() => closeDialogue(), 1500);
                break;
            case 'complete_work_day':
                completeWorkDay();
                break;
            case 'coffee_date':
                scheduleCoffeeDate(npc);
                break;
            case 'family_meeting':
                scheduleFamilyMeeting(npc);
                break;
            case 'business_opportunity':
                presentBusinessOffer(npc);
                break;
        }
    }
    
    function handleInterviewEnd(npc) {
        const interview = game.currentInterview;
        if (!interview) return;
        
        const job = interview.job;
        const relation = npc.relation;
        const jobOfferBoost = npc.memory.jobOfferBoost || 0;
        const salaryBonus = npc.memory.salaryBonus || 0;
        const jobOfferGuaranteed = npc.memory.jobOfferGuaranteed || false;
        
        // Calcola se viene assunto - SISTEMA REALISTICO
        let hired = false;
        let baseSalary = job.salary || 100;
        let finalSalary = baseSalary;
        
        // Soglia minima basata su stipendio/livello lavoro
        // Entry level (45-70): soglia 35-45
        // Mid level (70-150): soglia 45-60
        // Senior (150-280): soglia 60-75
        // Executive (280+): soglia 75-85
        let minRelation = 35;
        if (baseSalary < 70) {
            minRelation = 35;  // Entry level - pi facile
        } else if (baseSalary < 150) {
            minRelation = 50;  // Mid level
        } else if (baseSalary < 280) {
            minRelation = 65;  // Senior
        } else {
            minRelation = 80;  // Executive - molto difficile
        }
        
        // Applica boost
        minRelation -= jobOfferBoost;
        
        if (jobOfferGuaranteed) {
            hired = true;
            finalSalary = Math.floor(baseSalary * (1 + salaryBonus / 100));
        } else if (relation >= minRelation) {
            hired = true;
            if (salaryBonus > 0) {
                finalSalary = Math.floor(baseSalary * (1 + salaryBonus / 100));
            }
        }
        
        setTimeout(() => {
            closeDialogue();
            
            setTimeout(() => {
                if (hired) {
                    if (confirm(` ASSUNTO! ${npc.name} ti offre il lavoro di ${job.name} con stipendio ${finalSalary}/giorno.\nOrario: ${job.hours.start}:00-${job.hours.end}:00, ${job.daysPerWeek} giorni/settimana.\nAccetti?`)) {
                        game.player.job = job.name;
                        game.player.jobSalary = finalSalary;
                        game.workData.currentJob = job;
                        game.workData.performance = 75; // Start with decent performance
                        game.workData.workHours = job.hours;
                        game.workData.daysPerWeek = job.daysPerWeek;
                        game.workData.manager = job.manager;
                        npc.memory.jobOffered = true;
                        
                        // Initialize career path
                        game.workData.careerPath = JOB_TO_CAREER[job.name] || 'business';
                        game.workData.careerLevel = 0; // Entry level
                        game.workData.daysWorked = 0;
                        game.workData.managerRelation = 50; // Neutral starting relationship
                        game.workData.warnings = 0;
                        game.workData.promotionProgress = 0;
                        game.workData.lastPerformanceReview = 0;
                        
                        // Assegna location lavoro
                        assignWorkLocation(job);
                        
                        // Update company employee count
                        if (game.companies[job.locationId]) {
                            game.companies[job.locationId].employees++;
                        }
                        
                        // Pulisci interview
                        game.currentInterview = null;
                        npc.memory.jobInterviewStarted = false;
                        
                        showNotification(` Congratulazioni! Inizi come ${job.name}!`, 3000);
                        updateUI();
                    } else {
                        npc.memory.jobRejected = true;
                        npc.relation = Math.max(0, npc.relation - 10);
                        game.currentInterview = null;
                        npc.memory.jobInterviewStarted = false;
                        showNotification(`${npc.name}  deluso. -10 Relazione`, 2000);
                    }
                } else {
                    game.currentInterview = null;
                    npc.memory.jobInterviewStarted = false;
                    npc.memory.jobRejected = true;
                    npc.relation = Math.max(0, npc.relation - 5); // Penalit per colloquio fallito
                    
                    const reasons = [
                        'profilo non in linea con le nostre esigenze',
                        'competenze insufficienti per la posizione',
                        'altri candidati pi qualificati',
                        'mancanza di esperienza richiesta',
                        'preparazione inadeguata'
                    ];
                    const reason = reasons[randInt(0, reasons.length - 1)];
                    
                    showNotification(` COLLOQUIO FALLITO!\n${npc.name}: "Spiacente, ${reason}."\nRelazione: ${relation}/${minRelation} richiesta`, 4000);
                }
            }, 500);
        }, 800);
    }

    function offerJobDialogue(npc) {
        // Offri lavori entry-level o intermediate dalla lista principale
        const availableJobs = game.jobs.filter(j => j.reqRep <= game.player.reputation);
        
        if (availableJobs.length === 0) {
            showNotification(`${npc.name} non ha posizioni disponibili per te al momento.`, 2000);
            return;
        }
        
        const job = availableJobs[randInt(0, availableJobs.length - 1)];
        
        setTimeout(() => {
            if (confirm(`${npc.name} ti offre il lavoro di ${job.name} con stipendio ${job.salary}/giorno.\nOrario: ${job.hours.start}:00-${job.hours.end}:00, ${job.daysPerWeek} giorni/settimana.\nAccetti?`)) {
                game.player.job = job.name;
                game.player.jobSalary = job.salary;
                npc.memory.jobOffered = true;
                
                // Initialize career path
                game.workData.careerPath = JOB_TO_CAREER[job.name] || 'business';
                game.workData.careerLevel = 0;
                game.workData.daysWorked = 0;
                game.workData.managerRelation = 50;
                game.workData.warnings = 0;
                game.workData.promotionProgress = 0;
                game.workData.lastPerformanceReview = 0;
                game.workData.performance = 75;
                game.workData.workHours = job.hours;
                game.workData.daysPerWeek = job.daysPerWeek;
                game.workData.manager = job.manager;
                
                // Assegna location lavoro reale
                assignWorkLocation(job);
                
                showNotification(` Congratulazioni! Sei stato assunto come ${job.name}!`, 3000);
                updateUI();
            } else {
                npc.memory.jobRejected = true;
                npc.relation = Math.max(0, npc.relation - 10);
                showNotification(`${npc.name}  deluso dal tuo rifiuto. -10 Relazione`, 2000);
            }
        }, 500);
    }

    // Assegna posizione al lavoro sulla mappa
    function assignWorkLocation(job) {
        console.log(' assignWorkLocation called with:', job);
        
        if (!job || !job.locationId) {
            console.error(' Job missing locationId:', job);
            return;
        }
        
        // Trova la location reale in CITY_LOCATIONS
        let workLocation = null;
        let neighborhood = null;
        
        console.log(' Searching for location:', job.locationId);
        
        for (let hood in CITY_LOCATIONS) {
            const found = CITY_LOCATIONS[hood].find(loc => loc.id === job.locationId);
            if (found) {
                workLocation = found;
                neighborhood = hood;
                console.log(` Found location in ${hood}:`, found);
                break;
            }
        }
        
        if (!workLocation) {
            console.error(' Location not found for job:', job.locationId);
            return;
        }
        
        // Usa le coordinate reali della location aziendale
        const x = workLocation.x;
        const y = workLocation.y;
        
        // Usa il nome dell'azienda dalla location
        const placeName = workLocation.name;
        const address = workLocation.street;
        
        // Salva nel workData
        game.workData.workLocation = {
            neighborhood: neighborhood,
            coordinates: { x, y },
            address: address,
            locationId: job.locationId
        };
        game.workData.workPlaceName = placeName;
        
        console.log(` Lavoro assegnato: ${placeName} @ ${address} (${neighborhood}) [${x}%, ${y}%]`);
        console.log(' game.workData.workLocation:', game.workData.workLocation);
        console.log(' game.workData.workPlaceName:', game.workData.workPlaceName);
        
        // Crea appuntamenti automatici per i turni di lavoro
        scheduleWorkAppointments(job);
        
        // Salva subito nel localStorage per persistenza
        saveGame();
    }
    
    function scheduleWorkAppointments(job) {
        if (!game.agenda) {
            game.agenda = { appointments: [], reminders: [] };
        }
        
        // Determina giorni lavorativi (se non specificati, usa Lun-Ven per 5 giorni, Lun-Sab per 6)
        let workDays = job.workDays || [];
        if (!workDays.length) {
            if (job.daysPerWeek === 5) {
                workDays = [1, 2, 3, 4, 5]; // Lun-Ven
            } else if (job.daysPerWeek === 6) {
                workDays = [1, 2, 3, 4, 5, 6]; // Lun-Sab
            } else {
                workDays = [1, 2, 3, 4, 5]; // Default Lun-Ven
            }
        }
        
        // Salva i giorni lavorativi nel workData
        game.workData.workDays = workDays;
        
        // Rimuovi eventuali appuntamenti di lavoro precedenti
        game.agenda.appointments = game.agenda.appointments.filter(a => a.type !== 'work');
        
        // Crea appuntamenti per le prossime 2 settimane
        const currentDay = game.time.day;
        const daysToSchedule = 14;
        
        for (let i = 0; i < daysToSchedule; i++) {
            const day = currentDay + i;
            const dayOfWeek = ((day - 1) % 7) + 1; // 1-7 (Lun-Dom)
            
            if (workDays.includes(dayOfWeek)) {
                const appointment = {
                    id: Date.now() + Math.random() + i,
                    day: day,
                    hour: job.hours.start,
                    minute: 0,
                    type: 'work',
                    title: ` ${job.name}`,
                    description: `Turno di lavoro ${job.hours.start}:00-${job.hours.end}:00 presso ${game.workData.workPlaceName || 'Lavoro'}`,
                    notified: false,
                    created: currentDay,
                    recurring: true // Flag per appuntamenti ricorrenti
                };
                
                game.agenda.appointments.push(appointment);
            }
        }
        
        // Ordina gli appuntamenti
        game.agenda.appointments.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            if (a.hour !== b.hour) return a.hour - b.hour;
            return (a.minute || 0) - (b.minute || 0);
        });
        
        // Mostra i giorni lavorativi
        const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
        const workDayNames = workDays.map(d => dayNames[d - 1]).join(', ');
        console.log(` Giorni lavorativi: ${workDayNames}`);
        showNotification(` Turni programmati: ${workDayNames} ore ${job.hours.start}:00-${job.hours.end}:00`, 4000);
    }

    function scheduleCoffeeDate(npc) {
        showNotification(` Hai fissato un caff con ${npc.name}!`, 2000);
        game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + 10);
        passTime(2);
    }

    function scheduleFamilyMeeting(npc) {
        showNotification(` ${npc.name} ti presenter alla sua famiglia! +15 Relazione`, 3000);
        npc.relation = Math.min(100, npc.relation + 15);
        npc.memory.metFamily = true;
    }

    function presentBusinessOffer(npc) {
        const investment = randInt(5000, 15000);
        const dailyReturn = Math.floor(investment * 0.015);
        
        setTimeout(() => {
            if (game.player.money >= investment) {
                if (confirm(`${npc.name} propone un investimento di ${investment} con ritorno di ${dailyReturn}/giorno. Accetti?`)) {
                    game.player.money -= investment;
                    game.player.passiveIncome = (game.player.passiveIncome || 0) + dailyReturn;
                    showNotification(` Investimento completato! Guadagnerai ${dailyReturn}/giorno`, 3000);
                    updateUI();
                }
            } else {
                showNotification(` Non hai abbastanza soldi (servono ${investment})`, 2000);
            }
        }, 500);
    }

    // ========================================
    // UI DIALOGHI
    // ========================================

    function openDialogue(npcId) {
        try {
            const npc = game.npcs.find(n => n.id === npcId);
            if (!npc) {
                console.error('NPC not found:', npcId);
                return;
            }
            
            currentDialogueNPC = npc;
            initNPCMemory(npc);
            
            // Safely set elements
            const avatarEl = document.getElementById('dialogueAvatar');
            const nameEl = document.getElementById('dialogueName');
            const jobEl = document.getElementById('dialogueJob');
            const relEl = document.getElementById('dialogueRelation');
            const convEl = document.getElementById('dialogueConversations');
            const historyEl = document.getElementById('dialogueHistory');
            const modalEl = document.getElementById('dialogueModal');
            
            if (!avatarEl || !nameEl || !jobEl || !relEl || !convEl || !historyEl || !modalEl) {
                console.error('Dialogue modal elements not found in DOM');
                alert('Errore: Elementi del dialogo non trovati. Ricarica la pagina.');
                return;
            }
            
            avatarEl.textContent = getJobIcon(npc.job);
            nameEl.textContent = npc.name;
            jobEl.textContent = `${npc.job}  ${npc.personality || 'amichevole'}`;
            relEl.textContent = npc.relation;
            convEl.textContent = npc.memory.conversations;
            
            updateTrustDisplay(npc);
            historyEl.innerHTML = '';
            modalEl.classList.add('active');
            
            if (npc.memory.conversations === 0) {
                addDialogueBubble('system', `Incontri ${npc.name}...`);
                setTimeout(() => {
                    addDialogueBubble('npc', getInitialGreeting(npc));
                    setTimeout(() => renderDialogueChoices(npc), 500);
                }, 800);
            } else {
                addDialogueBubble('npc', getReturningGreeting(npc));
                setTimeout(() => renderDialogueChoices(npc), 500);
            }
        } catch (error) {
            console.error('Error in openDialogue:', error);
            alert('Errore nell\'apertura del dialogo: ' + error.message);
        }
    }

    function closeDialogue() {
        const modalEl = document.getElementById('dialogueModal');
        if (modalEl) {
            modalEl.classList.remove('active');
        }
        currentDialogueNPC = null;
        if (typeof updateUI === 'function') {
            updateUI();
        }
    }

    function updateTrustDisplay(npc) {
        const trustLevel = npc.memory.trustLevel;
        const trustIcons = {
            'sconosciuto': '',
            'conoscente': '',
            'amico': '',
            'confidente': '',
            'familiare': ''
        };
        
        const trustNames = {
            'sconosciuto': 'Sconosciuto',
            'conoscente': 'Conoscente',
            'amico': 'Amico',
            'confidente': 'Confidente',
            'familiare': 'Familiare'
        };
        
        document.getElementById('trustIcon').textContent = trustIcons[trustLevel];
        const trustEl = document.getElementById('trustLevel');
        trustEl.textContent = trustNames[trustLevel];
        trustEl.className = `trust-level-${trustLevel}`;
    }

    function getInitialGreeting(npc) {
        const greetings = {
            'amichevole': `Ciao! Sono ${npc.name}. Piacere di conoscerti!`,
            'socievole': `Ehi! Ciao! Sono ${npc.name}! Come ti chiami?`,
            'introverso': `...Ciao. ${npc.name}.`,
            'creativa': `Oh, ciao! Sono ${npc.name}. Stavo proprio pensando a qualcosa...`,
            'professionale': `Buongiorno. Sono ${npc.name}, ${npc.job}.`,
            'paziente': `Salve. ${npc.name}, piacere. Come stai?`
        };
        return greetings[npc.personality] || greetings['amichevole'];
    }

    function getReturningGreeting(npc) {
        const trust = npc.memory.trustLevel;
        if (trust === 'familiare') return `${game.player.name}! Che bello rivederti!`;
        if (trust === 'confidente') return `Ciao ${game.player.name}! Siediti!`;
        if (trust === 'amico') return `Ehi ${game.player.name}! Come stai?`;
        if (trust === 'conoscente') return `Oh, ciao. Come va?`;
        return `Ciao. Ci siamo gi visti?`;
    }

    function addDialogueBubble(type, text, checkResult = null) {
        const history = document.getElementById('dialogueHistory');
        const bubble = document.createElement('div');
        bubble.className = `dialogue-bubble ${type}`;
        
        let content = `<div class="bubble-content">`;
        
        if (type === 'player') {
            content += `<div class="bubble-label">${game.player.name}</div>`;
        } else if (type === 'npc') {
            content += `<div class="bubble-label">${currentDialogueNPC.name}</div>`;
        }
        
        content += text;
        
        if (checkResult) {
            const checkClass = checkResult.success ? 
                (checkResult.margin >= 5 ? 'critical' : 'success') : 
                'failure';
            content += `<span class="check-result ${checkClass}">
                 ${checkResult.roll}+${checkResult.modifier}=${checkResult.total} ${checkResult.success ? '' : ''}
            </span>`;
        }
        
        content += `</div>`;
        bubble.innerHTML = content;
        history.appendChild(bubble);
        history.scrollTop = history.scrollHeight;
    }

    function renderDialogueChoices(npc) {
        const choicesDiv = document.getElementById('dialogueChoices');
        choicesDiv.innerHTML = '';
        
        const options = getDialogueOptions(npc);
        
        options.forEach(option => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-option';
            
            let html = `<div class="choice-text">${option.text}</div>`;
            
            if (option.check) {
                const skillValue = game.player.skills[option.check.type] || 0;
                const modifier = Math.floor(skillValue / 10);
                html += `<span class="choice-check"> ${option.check.type.toUpperCase()} DC${option.check.difficulty} (${modifier >= 0 ? '+' : ''}${modifier})</span>`;
            }
            
            choiceDiv.innerHTML = html;
            choiceDiv.onclick = () => selectDialogueChoice(npc, option);
            choicesDiv.appendChild(choiceDiv);
        });
    }

    function selectDialogueChoice(npc, option) {
        addDialogueBubble('player', option.text);
        document.getElementById('dialogueChoices').innerHTML = '<div style="text-align:center; opacity:0.7; padding:20px;">...</div>';
        
        setTimeout(() => {
            const result = executeDialogueChoice(npc, option);
            
            setTimeout(() => {
                addDialogueBubble('npc', result.response, result.checkResult);
                
                if (result.relationChange !== 0) {
                    showRelationChange(result.relationChange);
                }
                
                document.getElementById('dialogueRelation').textContent = npc.relation;
                document.getElementById('dialogueConversations').textContent = npc.memory.conversations;
                updateTrustDisplay(npc);
                
                if (result.events.length > 0) {
                    result.events.forEach(event => {
                        setTimeout(() => handleDialogueEvent(event, npc), 1000);
                    });
                }
                
                // Se l'opzione ha follow-up, mostra quelli invece del menu principale
                if (option.followUp && option.followUp.length > 0) {
                    setTimeout(() => renderFollowUpChoices(npc, option.followUp, option.type), 1500);
                } else {
                    // Torna al menu principale solo se non ci sono follow-up
                    setTimeout(() => renderDialogueChoices(npc), 1500);
                }
            }, 800);
        }, 300);
    }

    function renderFollowUpChoices(npc, followUpOptions, previousType) {
        const choicesDiv = document.getElementById('dialogueChoices');
        choicesDiv.innerHTML = '';
        
        // Aggiungi le opzioni di follow-up
        followUpOptions.forEach(option => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-option';
            
            let html = `<div class="choice-text">${option.text}</div>`;
            
            if (option.check) {
                const skillValue = game.player.skills[option.check.type] || 0;
                const modifier = Math.floor(skillValue / 10);
                html += `<span class="choice-check"> ${option.check.type.toUpperCase()} DC${option.check.difficulty} (${modifier >= 0 ? '+' : ''}${modifier})</span>`;
            }
            
            choiceDiv.innerHTML = html;
            choiceDiv.onclick = () => selectDialogueChoice(npc, option);
            choicesDiv.appendChild(choiceDiv);
        });
        
        // Aggiungi sempre un'opzione per tornare indietro
        const backDiv = document.createElement('div');
        backDiv.className = 'choice-option';
        backDiv.innerHTML = `<div class="choice-text"> Torna al menu principale</div>`;
        backDiv.onclick = () => renderDialogueChoices(npc);
        choicesDiv.appendChild(backDiv);
    }

    function showRelationChange(change) {
        const notif = document.createElement('div');
        notif.className = `dialogue-notification ${change > 0 ? 'relation-up' : 'relation-down'}`;
        notif.textContent = `${change > 0 ? '' : ''} Relazione ${change > 0 ? '+' : ''}${change}`;
        
        document.querySelector('.dialogue-container').appendChild(notif);
        
        setTimeout(() => {
            notif.style.animation = 'fadeOut 0.5s';
            setTimeout(() => notif.remove(), 500);
        }, 2000);
    }

    
// ---------- ADVANCED CAREER & WORK SYSTEM ----------

// Calculate work performance based on vital stats
function calculateWorkPerformance() {
    const stats = game.player.stats || {};
    const skills = game.player.skills || {};
    
    // Vital stats influence (0-100 each)
    const energy = stats.energy || 50;
    const health = stats.health || 50;
    const morale = stats.morale || 50;
    const hunger = stats.hunger || 50;
    
    // Base performance from vital stats (weighted)
    let vitalPerformance = (
        energy * 0.35 +  // Energy is most important
        health * 0.25 +  // Health affects stamina
        morale * 0.25 +  // Morale affects motivation
        hunger * 0.15    // Hunger affects focus
    );
    
    // Homeless penalty: massive performance drop
    if (game.player.isHomeless) {
        vitalPerformance *= 0.6; // -40% performance if homeless
        showNotification(' Il tuo stato di senzatetto influisce gravemente sul lavoro!', 2500);
    }
    
    // Get relevant skill for current job
    const careerPath = game.workData.careerPath;
    let skillBonus = 0;
    
    if (careerPath && CAREER_PATHS[careerPath]) {
        const level = game.workData.careerLevel || 0;
        const requirements = CAREER_PATHS[careerPath].levels[level].requirements;
        
        // Calculate skill bonus based on requirements
        const relevantSkills = ['intellect', 'charisma', 'creativity', 'fitness'];
        let totalSkill = 0;
        let requiredSkill = 0;
        
        relevantSkills.forEach(skill => {
            if (requirements[skill]) {
                totalSkill += skills[skill] || 0;
                requiredSkill += requirements[skill];
            }
        });
        
        // Skill bonus: positive if above requirements, negative if below
        if (requiredSkill > 0) {
            skillBonus = ((totalSkill - requiredSkill) / requiredSkill) * 20;
        }
    }
    
    // Combine vital performance and skill bonus
    const finalPerformance = clamp(vitalPerformance + skillBonus);
    
    return Math.round(finalPerformance);
}

// Work events based on performance and stats
function triggerWorkEvent(performance) {
    const stats = game.player.stats || {};
    const events = [];
    
    // Very poor performance (< 40)
    if (performance < 40) {
        events.push(
            { type: 'negative', msg: ' Performance scarsa: il manager ti ha rimproverato', managerChange: -8, perfChange: -5 },
            { type: 'negative', msg: ' Hai commesso un errore grave che ha causato problemi', managerChange: -12, perfChange: -8, moneyChange: -50 },
            { type: 'negative', msg: ' Ti sei addormentato durante il lavoro per la stanchezza', managerChange: -15, perfChange: -10 },
            { type: 'warning', msg: ' AVVERTIMENTO FORMALE ricevuto per performance inadeguata', managerChange: -20, perfChange: -12, warning: true }
        );
    }
    // Poor performance (40-60)
    else if (performance < 60) {
        events.push(
            { type: 'neutral', msg: ' Giornata nella media, ma potresti fare di meglio', managerChange: -3, perfChange: -2 },
            { type: 'negative', msg: ' Il manager ha notato cali di produttivit', managerChange: -5, perfChange: -3 },
            { type: 'neutral', msg: ' Hai completato i compiti base ma senza eccellere', managerChange: 0, perfChange: 0 }
        );
    }
    // Good performance (60-80)
    else if (performance < 80) {
        events.push(
            { type: 'positive', msg: ' Buon lavoro, il manager  soddisfatto', managerChange: 3, perfChange: 2 },
            { type: 'positive', msg: ' Hai gestito bene una situazione difficile', managerChange: 5, perfChange: 3, repChange: 2 },
            { type: 'neutral', msg: ' Giornata produttiva e senza intoppi', managerChange: 2, perfChange: 1 }
        );
    }
    // Excellent performance (80-100)
    else {
        events.push(
            { type: 'excellent', msg: ' Performance eccellente! Il manager ti ha elogiato', managerChange: 8, perfChange: 5, repChange: 3 },
            { type: 'excellent', msg: ' Hai risolto un problema critico salvando la situazione', managerChange: 12, perfChange: 8, repChange: 5, moneyChange: 100 },
            { type: 'excellent', msg: ' Ottimo lavoro! Sei stato preso come esempio per il team', managerChange: 10, perfChange: 6, repChange: 4, promotionProgress: 10 }
        );
    }
    
    // Random events based on stats
    if (stats.energy < 30) {
        events.push({ type: 'negative', msg: ' La stanchezza ti ha fatto rallentare molto', managerChange: -6, perfChange: -4 });
    }
    if (stats.health < 30) {
        events.push({ type: 'negative', msg: ' Non stavi bene e hai lavorato male', managerChange: -5, perfChange: -5 });
    }
    if (stats.morale > 80) {
        events.push({ type: 'positive', msg: ' Il tuo ottimo umore ha contagiato i colleghi', managerChange: 4, perfChange: 2, repChange: 2 });
    }
    
    return events[randInt(0, events.length - 1)];
}

// Check for promotion eligibility
function checkPromotionEligibility() {
    const careerPath = game.workData.careerPath;
    if (!careerPath || !CAREER_PATHS[careerPath]) return false;
    
    const currentLevel = game.workData.careerLevel || 0;
    const nextLevel = currentLevel + 1;
    
    // Check if there's a next level
    if (nextLevel >= CAREER_PATHS[careerPath].levels.length) return false;
    
    const requirements = CAREER_PATHS[careerPath].levels[nextLevel].requirements;
    const skills = game.player.skills || {};
    const workData = game.workData;
    
    // Check all requirements
    const checks = {
        intellect: !requirements.intellect || (skills.intellect || 0) >= requirements.intellect,
        charisma: !requirements.charisma || (skills.charisma || 0) >= requirements.charisma,
        creativity: !requirements.creativity || (skills.creativity || 0) >= requirements.creativity,
        fitness: !requirements.fitness || (skills.fitness || 0) >= requirements.fitness,
        performance: !requirements.performance || workData.performance >= requirements.performance,
        managerRelation: !requirements.managerRelation || workData.managerRelation >= requirements.managerRelation
    };
    
    return Object.values(checks).every(check => check);
}

// Attempt promotion
function attemptPromotion() {
    if (!checkPromotionEligibility()) {
        showNotification(' Non hai ancora i requisiti per una promozione', 2500);
        return;
    }
    
    const careerPath = game.workData.careerPath;
    const nextLevel = (game.workData.careerLevel || 0) + 1;
    const levelData = CAREER_PATHS[careerPath].levels[nextLevel];
    
    // Promotion success chance based on various factors
    const baseChance = 60;
    const performanceBonus = (game.workData.performance - 70) * 0.5;
    const managerBonus = (game.workData.managerRelation - 60) * 0.4;
    const progressBonus = (game.workData.promotionProgress || 0) * 0.3;
    
    const successChance = clamp(baseChance + performanceBonus + managerBonus + progressBonus, 20, 95);
    
    if (Math.random() * 100 < successChance) {
        // PROMOTION SUCCESS!
        game.workData.careerLevel = nextLevel;
        game.player.job = levelData.title;
        game.player.jobSalary = levelData.salary;
        game.player.jobLevel = nextLevel + 1;
        game.workData.promotionProgress = 0;
        game.workData.managerRelation = Math.min(100, game.workData.managerRelation + 10);
        game.player.rep += 10;
        
        showNotification(` PROMOZIONE! Ora sei ${levelData.title} con stipendio ${levelData.salary}/giorno!`, 5000);
        
        game.workData.workEvents.push(`${getTimeString()}   PROMOSSO a ${levelData.title}!`);
        
        updateUI();
    } else {
        // Promotion denied
        showNotification(' Promozione rifiutata. Continua a migliorare performance e relazione col manager', 3000);
        game.workData.promotionProgress += 10;
    }
}

// Talk to manager action
function talkToManager() {
    const manager = game.npcs.find(n => n.name === game.workData.currentJob.manager);
    if (manager) {
        openDialogue(manager.id);
    } else {
        showNotification(' Il tuo manager non  disponibile al momento', 2000);
    }
}

function doWorkDay() {
    if (!game.player || game.player.job === 'Disoccupato') {
        showNotification(' Non hai un lavoro!', 2000);
        return;
    }

    if (!game.workData || !game.workData.currentJob) {
        showNotification(' Dati lavoro non trovati!', 2000);
        return;
    }

    const job = game.workData.currentJob;
    const currentHour = game.time.hour;
    
    // Check if it's weekend
    if (isWeekend(game.time.day)) {
        showNotification('  weekend! Riposa e goditi il tempo libero.', 2500);
        return;
    }
    
    // Check work days this week
    if (game.player.workDaysThisWeek >= 5) {
        showNotification(' Hai gi lavorato 5 giorni questa settimana. Riposati!', 2500);
        return;
    }

    if (game.workData.todayWorked) {
        showNotification(' Hai gi lavorato oggi.', 2000);
        return;
    }

    if (!job.hours || typeof job.hours.start !== 'number' || typeof job.hours.end !== 'number') {
        showNotification(' Orario di lavoro non valido.', 2000);
        return;
    }
    
    // Validate max 8 hour shift
    const shiftDuration = job.hours.end - job.hours.start;
    if (shiftDuration > 8) {
        showNotification(' Errore: turno superiore a 8 ore non permesso!', 2500);
        return;
    }

    if (currentHour < job.hours.start || currentHour >= job.hours.end) {
        showNotification(` Non sei nell'orario di lavoro (${job.hours.start}:00-${job.hours.end}:00).`, 2500);
        return;
    }
    
    // Travel to work location if needed
    if (job.location && game.cityMap.currentLocation !== job.location) {
        // Show travel dialog
        showTravelDialog(job.location, function() {
            // After travel, check if still in work hours
            if (game.time.hour >= job.hours.end) {
                showNotification(` Troppo tardi! Orario di lavoro terminato durante il viaggio.`, 2500);
                updateUI();
                return;
            }
            
            // Continue with work
            performWorkDay();
        });
        return;
    }

    // If already at work location, perform work directly
    performWorkDay();
}

function performWorkDay() {
    const job = game.workData.currentJob;
    const currentHour = game.time.hour;
    
    // Update building to work
    game.cityMap.currentBuilding = 'work';
    
    const fullShiftHours = Math.max(1, job.hours.end - job.hours.start);
    const hoursToWork = Math.max(1, job.hours.end - currentHour);

    // Calculate performance based on vital stats
    const dailyPerformance = calculateWorkPerformance();
    
    // Update rolling average performance
    game.workData.performance = Math.round((game.workData.performance * 0.7) + (dailyPerformance * 0.3));
    
    // Base salary
    const baseSalary = game.player.jobSalary || job.salary || 100;
    let earnings = Math.round(baseSalary * (hoursToWork / fullShiftHours));
    
    // Performance affects earnings
    const performanceMultiplier = dailyPerformance / 100;
    earnings = Math.round(earnings * performanceMultiplier);
    
    // Consumo risorse base
    const baseEnergyLoss = hoursToWork * 8;
    const baseHungerLoss = hoursToWork * 6;
    const baseMoraleLoss = Math.floor(hoursToWork * 1.5);
    const baseHealthLoss = Math.floor(hoursToWork * 0.5);

    let energyChange = -baseEnergyLoss;
    let hungerChange = -baseHungerLoss;
    let moraleChange = -baseMoraleLoss;
    let healthChange = -baseHealthLoss;
    let repChange = 0;

    // Trigger work event
    const workEvent = triggerWorkEvent(dailyPerformance);
    let message = workEvent.msg;
    
    // Apply event effects
    game.workData.managerRelation = clamp(game.workData.managerRelation + (workEvent.managerChange || 0));
    game.workData.performance = clamp(game.workData.performance + (workEvent.perfChange || 0));
    
    if (workEvent.moneyChange) {
        earnings += workEvent.moneyChange;
    }
    if (workEvent.repChange) {
        repChange += workEvent.repChange;
    }
    if (workEvent.promotionProgress) {
        game.workData.promotionProgress = Math.min(100, (game.workData.promotionProgress || 0) + workEvent.promotionProgress);
    }
    if (workEvent.warning) {
        game.workData.warnings = (game.workData.warnings || 0) + 1;
        
        // Check for firing after 3 warnings
        if (game.workData.warnings >= 3) {
            showNotification(' SEI STATO LICENZIATO per ripetute performance scadenti!', 5000);
            
            // Update company employee count
            if (game.workData.currentJob && game.companies[game.workData.currentJob.locationId]) {
                game.companies[game.workData.currentJob.locationId].employees = Math.max(0, game.companies[game.workData.currentJob.locationId].employees - 1);
            }
            
            game.player.job = 'Disoccupato';
            game.player.jobSalary = 0;
            game.workData = {
                currentJob: null,
                todayWorked: false,
                tasksCompleted: 0,
                performance: 50,
                manager: null,
                workEvents: [...game.workData.workEvents, `${getTimeString()}   LICENZIATO per performance scadenti`],
                careerPath: null,
                careerLevel: 0,
                daysWorked: 0,
                managerRelation: 50,
                warnings: 0,
                promotionProgress: 0,
                lastPerformanceReview: 0
            };
            updateUI();
            return;
        }
    }
    
    // Poor manager relation can lead to firing
    if (game.workData.managerRelation < 20 && Math.random() < 0.3) {
        showNotification(' SEI STATO LICENZIATO per pessimi rapporti col manager!', 5000);
        
        // Update company employee count
        if (game.workData.currentJob && game.companies[game.workData.currentJob.locationId]) {
            game.companies[game.workData.currentJob.locationId].employees = Math.max(0, game.companies[game.workData.currentJob.locationId].employees - 1);
        }
        
        game.player.job = 'Disoccupato';
        game.player.jobSalary = 0;
        game.workData = {
            currentJob: null,
            todayWorked: false,
            tasksCompleted: 0,
            performance: 50,
            manager: null,
            workEvents: [...game.workData.workEvents, `${getTimeString()}   LICENZIATO per conflitti col manager`],
            careerPath: null,
            careerLevel: 0,
            daysWorked: 0,
            managerRelation: 50,
            warnings: 0,
            promotionProgress: 0,
            lastPerformanceReview: 0
        };
        updateUI();
        return;
    }

    // Aggiorna stats giocatore
    const stats = game.player.stats || {};
    stats.energy = clamp((stats.energy || 0) + energyChange);
    stats.hunger = clamp((stats.hunger || 0) + hungerChange);
    stats.morale = clamp((stats.morale || 0) + moraleChange);
    stats.health = clamp((stats.health || 0) + healthChange);
    game.player.stats = stats;
    game.player.rep = clamp((game.player.rep || 0) + repChange);

    // Aggiorna denaro
    game.player.money += earnings;
    game.player.totalEarned = (game.player.totalEarned || 0) + earnings;

    // Increment days worked
    game.workData.daysWorked = (game.workData.daysWorked || 0) + 1;
    game.workData.todayWorked = true;
    
    // Track work days this week
    game.player.workDaysThisWeek = (game.player.workDaysThisWeek || 0) + 1;
    game.player.lastWorkDay = game.time.day;
    
    // Auto promotion progress for good performance
    if (dailyPerformance >= 80) {
        game.workData.promotionProgress = Math.min(100, (game.workData.promotionProgress || 0) + 2);
    }
    
    // Check for automatic promotion at 100% progress
    if (game.workData.promotionProgress >= 100 && checkPromotionEligibility()) {
        attemptPromotion();
    }

    // Avanza il tempo fino a fine turno
    game.time.hour += hoursToWork;
    while (game.time.hour >= 24) {
        game.time.hour -= 24;
        game.time.day += 1;
    }

    // Log eventi di lavoro
    if (!Array.isArray(game.workData.workEvents)) {
        game.workData.workEvents = [];
    }
    const summary = `${getTimeString()}  ${message} | Guadagni: ${formatMoney(earnings)} | Perf: ${dailyPerformance}% | Manager: ${game.workData.managerRelation}/100`;
    game.workData.workEvents.push(summary);
    if (game.workData.workEvents.length > 20) {
        game.workData.workEvents = game.workData.workEvents.slice(-20);
    }

    showNotification(message + ` | ${formatMoney(earnings)} | Perf: ${dailyPerformance}%`, 4000);
    updateUI();
}

setInterval(() => {
        if (game.settings.autoSave && game.player) {
            saveGame();
        }
    }, 60000); // Auto-save every 60 seconds

    // Debug function - call from console: debugWork()
    window.debugWork = function() {
        console.log('=== WORK DEBUG INFO ===');
        console.log('Player Job:', game.player.job);
        console.log('Player Salary:', game.player.jobSalary);
        console.log('Has workData:', !!game.workData);
        console.log('Has workLocation:', !!(game.workData && game.workData.workLocation));
        console.log('Work Location:', game.workData?.workLocation);
        console.log('Work Place Name:', game.workData?.workPlaceName);
        console.log('Current City Location:', game.cityMap?.currentLocation);
        console.log('Current Job Object:', game.workData?.currentJob);
        console.log('======================');
        return game.workData;
    };

    </script>
    
    <!-- Mobile Enhancements -->
    <script>
    // Mobile-specific improvements
    (function() {
        // Check if mobile
        const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            console.log(' Mobile device detected - applying optimizations');
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Improve menu toggle for mobile
            window.toggleMenuPanel = function() {
                const sidebar = document.getElementById('menuSidebar');
                const isOpen = sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === '';
                
                if (isOpen) {
                    sidebar.style.transform = 'translateX(100%)';
                    sidebar.classList.remove('open');
                } else {
                    sidebar.style.transform = 'translateX(0px)';
                    sidebar.classList.add('open');
                }
            };
            
            // Close menu when clicking outside on mobile
            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('menuSidebar');
                const menuBtn = document.querySelector('[onclick="toggleMenuPanel()"]');
                
                if (sidebar && sidebar.classList.contains('open')) {
                    if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                        sidebar.style.transform = 'translateX(100%)';
                        sidebar.classList.remove('open');
                    }
                }
            });
            
            // Improve stats panel toggle for mobile
            window.toggleStatsPanel = function() {
                const statsPanel = document.getElementById('statsPanel');
                const mapArea = document.getElementById('mainMapArea');
                const isOpen = statsPanel.style.transform === 'translateY(0px)' || statsPanel.style.transform === '';
                
                if (isOpen) {
                    statsPanel.style.transform = 'translateY(-100%)';
                    if (mapArea) mapArea.style.paddingTop = '0';
                } else {
                    statsPanel.style.transform = 'translateY(0px)';
                    const panelHeight = statsPanel.offsetHeight;
                    if (mapArea) mapArea.style.paddingTop = panelHeight + 'px';
                }
            };
            
            // Auto-close stats panel after 10 seconds on mobile
            let statsTimeout;
            const originalToggleStats = window.toggleStatsPanel;
            window.toggleStatsPanel = function() {
                originalToggleStats();
                const statsPanel = document.getElementById('statsPanel');
                
                if (statsPanel.style.transform === 'translateY(0px)') {
                    clearTimeout(statsTimeout);
                    statsTimeout = setTimeout(function() {
                        statsPanel.style.transform = 'translateY(-100%)';
                        const mapArea = document.getElementById('mainMapArea');
                        if (mapArea) mapArea.style.paddingTop = '0';
                    }, 10000);
                } else {
                    clearTimeout(statsTimeout);
                }
            };
            
            // Add swipe gestures for menu (optional but nice)
            let touchStartX = 0;
            let touchEndX = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            document.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, false);
            
            function handleSwipe() {
                const sidebar = document.getElementById('menuSidebar');
                const swipeThreshold = 100;
                
                // Swipe from right to open menu
                if (touchStartX > window.innerWidth - 50 && touchEndX < touchStartX - swipeThreshold) {
                    if (sidebar && sidebar.style.transform === 'translateX(100%)') {
                        sidebar.style.transform = 'translateX(0px)';
                        sidebar.classList.add('open');
                    }
                }
                
                // Swipe to right to close menu
                if (touchStartX < window.innerWidth / 2 && touchEndX > touchStartX + swipeThreshold) {
                    if (sidebar && sidebar.classList.contains('open')) {
                        sidebar.style.transform = 'translateX(100%)';
                        sidebar.classList.remove('open');
                    }
                }
            }
            
            // Optimize modals for mobile - prevent body scroll when modal is open
            const originalShowNotification = window.showNotification;
            window.showNotification = function(msg, duration) {
                // Make notifications more visible on mobile
                const notif = document.createElement('div');
                notif.className = 'notification';
                notif.textContent = msg;
                notif.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 10px;
                    right: 10px;
                    z-index: 9999;
                    padding: 12px;
                    background: rgba(0,0,0,0.9);
                    border: 2px solid #667eea;
                    border-radius: 8px;
                    color: white;
                    font-size: 1rem;
                    text-align: center;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(notif);
                setTimeout(() => {
                    notif.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => notif.remove(), 300);
                }, duration || 3000);
            };
            
            console.log(' Mobile optimizations applied successfully');
        }
        
        // Resize handler for orientation changes
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('menuSidebar');
            if (window.innerWidth > 768 && sidebar) {
                // Reset sidebar for desktop view
                sidebar.style.transform = '';
                sidebar.classList.remove('open');
            }
        });
        
        // Improve viewport height for mobile (fix for address bar)
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
    })();
    </script>
    
    <script src="fix_ui_v2.js"></script>
    <script src="fix_jobs_complete.js"></script>
    <script src="fix_map_actions.js"></script>
</body>
</html>
