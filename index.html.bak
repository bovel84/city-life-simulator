<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>City Life Simulator</title>
    <style>
        * { margin:0; padding:0; box-sizing: border-box; }
        :root{ --primary:#667eea; --secondary:#764ba2; --success:#38ef7d; --danger:#eb3349; --warning:#ffd700; --dark:#1a1a2e; --light:#f0f0f0;}
        body{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial; background:linear-gradient(135deg,#0f0c29,#302b63); color:#fff; min-height:100vh;}
        .container{ max-width:1200px; margin:20px auto; padding:20px; }
        h1{text-align:center; background:linear-gradient(135deg,var(--primary),var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-size:2.8rem; margin-bottom:20px;}
        .card{ background:rgba(255,255,255,0.06); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.04); }
        button{ background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; transition: transform 0.2s; }
        button:hover{ transform: scale(1.05); }
        button:disabled{ opacity: 0.5; cursor: not-allowed; transform: none !important; }
        button.small{ padding:6px 10px; font-size:0.9rem; }
        .grid{ display:grid; gap:12px; }
        .grid-3{ grid-template-columns: repeat(3,1fr); }
        .screen{ display:none; animation:fadeIn .3s ease; }
        .screen.active{ display:block; }
        #homeScreen, #characterScreen{ position:fixed; left:0; top:0; right:0; bottom:0; background:linear-gradient(135deg,#0f0c29,#302b63); z-index:5000; overflow-y:auto; }
        .tab-buttons{ display:flex; gap:8px; margin-bottom:12px; flex-wrap: wrap; }
        .tab-btn{ background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:8px; cursor:pointer; border: 1px solid transparent; transition: all 0.2s; }
        .tab-btn:hover{ background:rgba(255,255,255,0.08); }
        .tab-btn.active{ background:rgba(102,126,234,0.18); border:1px solid var(--primary); }
        .tab-content{ display:none; }
        .tab-content.active{ display:block; }
        .stat-bar{ height:22px; background:rgba(0,0,0,0.4); border-radius:12px; overflow:hidden; position: relative; }
        .stat-fill{ height:100%; display:flex; align-items:center; justify-content:center; font-weight:600; transition:width .4s ease; font-size: 0.85rem; }
        .stat-fill.high{ background:linear-gradient(90deg,var(--success),#11998e); }
        .stat-fill.medium{ background:linear-gradient(90deg,var(--warning),#ff8c00); }
        .stat-fill.low{ background:linear-gradient(90deg,var(--danger),#f45c43); }
        .notification{ position:fixed; top:20px; right:20px; padding:10px 14px; border-radius:8px; background:rgba(0,0,0,0.85); color:#fff; z-index:9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        .modal{ position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:4000; }
        .modal .modal-inner{ width:90%; max-width:700px; background:linear-gradient(135deg,rgba(30,30,50,0.98),rgba(40,40,60,0.98)); padding:18px; border-radius:10px; max-height: 80vh; overflow-y: auto; }
        .npc-card{ padding:8px; background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; border: 1px solid rgba(255,255,255,0.05); }
        input, select{ padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2); color:#fff; width:100%; margin-top: 4px; margin-bottom: 8px; }
        
        /* Character Creation Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); 
            } 
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); 
            } 
        }
        
        /* Trait Card Styles */
        .trait-card { 
            padding: 10px; 
            background: rgba(255,255,255,0.04); 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid transparent;
            position: relative;
        }
        .trait-card:hover { 
            background: rgba(255,255,255,0.08); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .trait-card.selected { 
            background: rgba(102,126,234,0.15); 
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(102,126,234,0.3);
        }
        .trait-card input[type="checkbox"] {
            display: none;
        }
        label{ display: block; margin-top: 8px; font-size: 0.9rem; opacity: 0.9; }
        .loading-screen{ position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f0c29,#302b63); z-index:6000; }
        .quest-card{ background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; border-left: 3px solid var(--primary); }
        .quest-card.completed{ opacity: 0.6; border-left-color: var(--success); }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
        @keyframes fadeOut{ from{opacity:1;} to{opacity:0;} }
        @keyframes slideIn{ from{transform:translateX(100px); opacity:0;} to{transform:none; opacity:1;} }
        @keyframes spin{ to{transform:rotate(360deg);} }
        
        /* Chat Styles */
        /* Old Chat Styles Removed - Using New Dialogue System */
        
        /* ========================================
           DIALOGUE SYSTEM - RPG STYLE
           ======================================== */
        .dialogue-modal {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 5500;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        .dialogue-modal.active { display: flex; }
        .dialogue-container {
            width: 95%;
            max-width: 800px;
            max-height: 85vh;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(30, 30, 50, 0.98));
            border-radius: 16px;
            border: 3px solid rgba(102, 126, 234, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dialogue-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .dialogue-npc-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dialogue-npc-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .dialogue-npc-details h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        .dialogue-npc-details p {
            margin: 2px 0 0 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .dialogue-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
        }
        .dialogue-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 10px;
            border-radius: 12px;
        }
        .dialogue-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .dialogue-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .trust-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 10px;
            margin: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .trust-icon { font-size: 1.2rem; }
        .trust-text { font-size: 0.85rem; }
        .trust-level-sconosciuto { color: #888; }
        .trust-level-conoscente { color: #4a9eff; }
        .trust-level-amico { color: #38ef7d; }
        .trust-level-confidente { color: #ff6b6b; }
        .trust-level-familiare { color: #ffd700; }
        .dialogue-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
        }
        .dialogue-bubble {
            margin-bottom: 16px;
            animation: slideIn 0.4s ease;
        }
        .dialogue-bubble.npc { text-align: left; }
        .dialogue-bubble.player { text-align: right; }
        .dialogue-bubble.system { text-align: center; }
        .bubble-content {
            display: inline-block;
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
        }
        .dialogue-bubble.npc .bubble-content {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            text-align: left;
        }
        .dialogue-bubble.player .bubble-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border: 1px solid rgba(102, 126, 234, 0.5);
            text-align: left;
        }
        .dialogue-bubble.system .bubble-content {
            background: rgba(255, 200, 100, 0.2);
            border: 1px solid rgba(255, 200, 100, 0.4);
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px 14px;
        }
        .bubble-label {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .check-result {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 8px;
            font-weight: bold;
        }
        .check-result.success {
            background: rgba(56, 239, 125, 0.3);
            color: #38ef7d;
        }
        .check-result.failure {
            background: rgba(235, 51, 73, 0.3);
            color: #eb3349;
        }
        .check-result.critical {
            background: rgba(255, 215, 0, 0.3);
            color: #ffd700;
            animation: pulse 1s infinite;
        }
        .dialogue-choices {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .dialogue-choices-title {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 12px;
            text-align: center;
        }
        .choice-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .choice-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        .choice-option:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(5px);
        }
        .choice-option:hover::before { opacity: 1; }
        .choice-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }
        .choice-option.disabled:hover {
            transform: none;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .choice-text {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .choice-check {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            font-weight: bold;
        }
        .dialogue-notification {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid var(--success);
            z-index: 10;
            animation: slideDown 0.5s ease;
            min-width: 300px;
            text-align: center;
        }
        .dialogue-notification.relation-down { border-color: var(--danger); }
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
            .dialogue-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
            .bubble-content { max-width: 85%; }
            .choice-option { padding: 10px 12px; }
        }
        
        /* Visual Map Styles - IMPROVED */
        .visual-map-container{ 
            position:relative; width:100%; height:600px; 
            background:linear-gradient(135deg, #0a0a1e 0%, #1a1a3e 50%, #0f0f2e 100%); 
            border-radius:16px; overflow:hidden; 
            border:3px solid rgba(102,126,234,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 0 60px rgba(102,126,234,0.1);
        }
        .map-grid{ position:absolute; inset:0; display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(3,1fr); gap:4px; padding:12px; }
        .quarter-zone{ 
            position:relative; 
            background:linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%); 
            border-radius:12px; border:2px solid rgba(255,255,255,0.15); 
            cursor:pointer; transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow:hidden; display:flex; flex-direction:column; padding:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .quarter-zone::before{
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, rgba(102,126,234,0.1), transparent 70%);
            opacity: 0; transition: opacity 0.4s;
        }
        .quarter-zone:hover::before{ opacity: 1; }
        .quarter-zone:hover{ 
            background:linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(118,75,162,0.08) 100%);
            border-color:rgba(102,126,234,0.6); transform:scale(1.03) translateY(-2px); 
            box-shadow:0 8px 24px rgba(102,126,234,0.4), 0 0 40px rgba(102,126,234,0.2), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .quarter-zone.active{ 
            border-color:var(--primary); border-width:3px; 
            box-shadow:0 0 30px rgba(102,126,234,0.6), 0 8px 24px rgba(102,126,234,0.3), inset 0 0 20px rgba(102,126,234,0.15);
            background:linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.15) 100%);
            transform:scale(1.02);
        }
        .quarter-name{ 
            font-weight:bold; font-size:1rem; margin-bottom:6px; color:#fff; 
            text-shadow:2px 2px 4px rgba(0,0,0,0.7), 0 0 10px rgba(102,126,234,0.3);
            letter-spacing: 0.5px; z-index: 2;
        }
        .quarter-icon{ 
            font-size:2.8rem; margin:auto; opacity:0.9;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
            transition: transform 0.4s, filter 0.4s; z-index: 2;
        }
        .quarter-zone:hover .quarter-icon{
            transform: scale(1.15) rotate(5deg);
            filter: drop-shadow(0 6px 12px rgba(102,126,234,0.5));
        }
        .quarter-stats{ font-size:0.75rem; opacity:0.85; margin-top:6px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); z-index: 2; }
        .map-road{ position:absolute; background:linear-gradient(90deg, rgba(255,255,255,0.2), rgba(102,126,234,0.3), rgba(255,255,255,0.2)); z-index:1; box-shadow: 0 0 10px rgba(102,126,234,0.2); }
        .road-h{ height:4px; }
        .road-v{ width:4px; }
        .road-label{ position:absolute; font-size:0.75rem; color:rgba(255,255,255,0.8); z-index:2; pointer-events:none; text-shadow: 1px 1px 3px rgba(0,0,0,0.7), 0 0 8px rgba(102,126,234,0.4); font-weight: 500; }
        .location-marker-wrapper{ position:absolute; display:flex; flex-direction:column; align-items:center; cursor:pointer; z-index:3; }
        .location-marker{ width:24px; height:24px; border-radius:50%; border:2px solid #fff; display:flex; align-items:center; justify-content:center; font-size:12px; transition:transform 0.2s; }
        .location-marker:hover{ transform:scale(1.2); }
        .location-label{ font-size:0.7rem; color:#fff; margin-top:4px; text-align:center; white-space:nowrap; text-shadow:1px 1px 2px rgba(0,0,0,0.7); }
        .bus-stop{ position:absolute; width:20px; height:20px; background:var(--warning); border-radius:50%; border:2px solid #fff; z-index:2; display:flex; align-items:center; justify-content:center; font-size:10px; animation:pulse 2s infinite; cursor:pointer; }
        .landmark-marker{ position:absolute; width:24px; height:24px; background:var(--success); border-radius:4px; border:2px solid #fff; z-index:2; display:flex; align-items:center; justify-content:center; font-size:12px; animation:bounce 3s infinite; cursor:pointer; }
        .business-marker{ position:absolute; width:16px; height:16px; background:var(--primary); border-radius:50%; border:1px solid #fff; z-index:2; cursor:pointer; }
        .player-marker{ position:absolute; width:40px; height:40px; background:radial-gradient(circle, #ff6b6b, #ee5a6f); border-radius:50%; border:4px solid #fff; z-index:5; display:flex; align-items:center; justify-content:center; font-size:18px; animation:playerPulse 1.5s infinite; box-shadow:0 0 25px rgba(255,107,107,0.8), 0 4px 15px rgba(0,0,0,0.5); cursor:pointer; transition: all 0.3s ease; }
        .player-marker:hover { transform: scale(1.2); box-shadow:0 0 35px rgba(255,107,107,1), 0 6px 20px rgba(0,0,0,0.6); }
        .player-location-label { position: absolute; bottom: -26px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; white-space: nowrap; border: 2px solid rgba(255,107,107,0.6); box-shadow: 0 2px 8px rgba(0,0,0,0.5); font-weight: 600; letter-spacing: 0.3px; pointer-events: none; }
        .map-tooltip{ position:absolute; background:rgba(0,0,0,0.95); color:#fff; padding:10px 14px; border-radius:8px; font-size:0.85rem; pointer-events:none; z-index:10; white-space:nowrap; display:none; border:2px solid rgba(102,126,234,0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
        .map-legend{ position:absolute; bottom:12px; right:12px; background:rgba(0,0,0,0.9); padding:16px; border-radius:12px; font-size:0.75rem; z-index:3; border:2px solid rgba(102,126,234,0.4); box-shadow: 0 4px 20px rgba(0,0,0,0.5); backdrop-filter: blur(15px); }
        .legend-item{ display:flex; align-items:center; gap:10px; margin-bottom:6px; transition: transform 0.2s; }
        .legend-item:hover { transform: translateX(3px); }
        .legend-icon{ width:18px; height:18px; border-radius:50%; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        @keyframes pulse{ 0%, 100%{transform:scale(1);} 50%{transform:scale(1.2);} }
        @keyframes bounce{ 0%, 100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }
        @keyframes playerPulse{ 0%, 100%{transform:scale(1); box-shadow:0 0 25px rgba(255,107,107,0.8), 0 4px 15px rgba(0,0,0,0.5);} 50%{transform:scale(1.15); box-shadow:0 0 40px rgba(255,107,107,1), 0 6px 20px rgba(0,0,0,0.6);} }
        
        @media (max-width:768px){ .grid-3{ grid-template-columns:1fr; } h1{ font-size: 2rem; } .chat-container{ height:90vh; } .visual-map-container{ height:400px; } .map-grid{ grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(5,1fr); } }

        .detailed-quarter-map {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 15px;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 100;
            overflow: auto;
        }

        .detailed-quarter-map.active {
            display: flex;
        }

        .detailed-quarter-map h4 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .detailed-map-grid {
            position: relative;
            width: 95%;
            height: 80%;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
        }

        .map-road.road-h {
            background: rgba(255,255,255,0.2);
            height: 5px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .map-road.road-v {
            background: rgba(255,255,255,0.2);
            width: 5px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .road-label {
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: #fff;
            text-shadow: none;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .location-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        .location-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        .location-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            margin-top: 6px;
            text-align: center;
            white-space: nowrap;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .back-to-overview-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 101;
            font-size: 0.9rem;
        }

        /* Location Popup Styles */
        .location-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.98), rgba(40, 40, 60, 0.98));
            border-radius: 16px;
            padding: 24px;
            min-width: 400px;
            max-width: 600px;
            z-index: 6000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease;
        }

        .location-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5999;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .location-popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .location-popup-icon {
            font-size: 3rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }

        .location-popup-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.5rem;
            color: #fff;
        }

        .location-popup-info p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .location-popup-actions {
            display: grid;
            gap: 10px;
            margin-bottom: 16px;
        }

        .location-action-btn {
            background: rgba(102, 126, 234, 0.15);
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
            text-align: left;
        }

        .location-action-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.6);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .location-action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .location-action-icon {
            font-size: 1.8rem;
            min-width: 40px;
            text-align: center;
        }

        .location-action-text {
            flex: 1;
        }

        .location-action-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .location-action-desc {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .location-action-cost {
            font-weight: bold;
            color: var(--warning);
            font-size: 0.9rem;
        }

        .location-popup-close {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-popup-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .location-popup {
                min-width: 90%;
                max-width: 90%;
            }
        }

        /* ========================================
           ENHANCED MODAL SYSTEM
           ======================================== */
        .enhanced-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.88);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .enhanced-dialog-content {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.98), rgba(40, 40, 60, 0.98));
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: min(90vw, 650px);
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            transition: all 0.2s;
            padding: 0;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        .modal-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }

        .modal-section:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .modal-section.info {
            border-left-color: #667eea;
        }

        .modal-section.success {
            border-left-color: #38ef7d;
        }

        .modal-section.warning {
            border-left-color: #ffd700;
        }

        .modal-section.danger {
            border-left-color: #eb3349;
        }

        .modal-section-title {
            font-weight: 600;
            font-size: 1.05rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-section-content {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.9;
        }

        .modal-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .modal-action-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }

        .modal-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-action-btn .btn-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .modal-action-btn .btn-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .modal-action-btn .btn-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            line-height: 1.4;
        }

        .modal-footer {
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- Old Chat Modal Removed - Now Using Dialogue System -->

    <!-- Dialogue System Modal (NEW) -->
    <div id="dialogueModal" class="dialogue-modal">
        <div class="dialogue-container">
            <div class="dialogue-header">
                <div class="dialogue-npc-info">
                    <div class="dialogue-npc-avatar" id="dialogueAvatar">üë§</div>
                    <div class="dialogue-npc-details">
                        <h3 id="dialogueName">NPC Name</h3>
                        <p id="dialogueJob">Job</p>
                    </div>
                </div>
                <div class="dialogue-stats">
                    <div class="dialogue-stat">‚ù§Ô∏è <span id="dialogueRelation">0</span></div>
                    <div class="dialogue-stat">üí¨ <span id="dialogueConversations">0</span></div>
                </div>
                <button class="dialogue-close" onclick="closeDialogue()">‚úï</button>
            </div>
            <div class="trust-indicator">
                <span class="trust-icon" id="trustIcon">ü§ù</span>
                <span class="trust-text">Livello: <strong id="trustLevel">Sconosciuto</strong></span>
            </div>
            <div class="dialogue-history" id="dialogueHistory"></div>
            <div class="dialogue-choices">
                <div class="dialogue-choices-title">üí≠ Cosa vuoi dire?</div>
                <div id="dialogueChoices"></div>
            </div>
        </div>
    </div>

    <div id="loadingScreen" class="loading-screen">
        <div style="text-align:center;color:#fff;">
            <div style="font-size:28px;margin-bottom:16px;">üåÜ City Life</div>
            <div style="font-size:18px;margin-bottom:8px;">Caricamento...</div>
            <div class="loading-spinner" style="width:50px;height:50px;border:4px solid rgba(255,255,255,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto;"></div>
        </div>
    </div>

    <div id="homeScreen" class="screen active">
        <div class="container">
            <h1>üåÜ City Life Simulator ‚Äî Advanced</h1>
            <div class="card">
                <div class="grid grid-3">
                    <button onclick="newGame()">üéÆ Nuova Partita</button>
                    <button onclick="loadGame()">üìÇ Carica Partita</button>
                    <button onclick="showTutorial()">üìñ Tutorial</button>
                </div>
            </div>
            <div class="card">
                <h3>üéØ Benvenuto!</h3>
                <p style="margin-top:8px; line-height:1.6;">Questa versione Advanced include un sistema di tempo realistico, azioni con effetti sulle statistiche, NPC con relazioni dinamiche, sistema di lavoro con promozioni, eventi casuali, missioni coinvolgenti e salvataggi automatici.</p>
            </div>
        </div>
    </div>

    <div id="characterScreen" class="screen">
        <div class="container" style="max-width:900px;">
            <!-- Header -->
            <div style="text-align:center; margin-bottom:24px; animation: fadeIn 0.8s;">
                <h1 style="font-size:2.5rem; margin-bottom:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                    üë§ Creazione Personaggio
                </h1>
                <p style="font-size:1.1rem; opacity:0.8;">Prepara la tua nuova vita a Eldoria</p>
            </div>

            <!-- Main Card -->
            <div class="card" style="animation: slideUp 0.6s;">
                
                <!-- Informazioni Base -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                        üìù Informazioni Base
                    </h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px;">
                        <div>
                            <label style="display:block; margin-bottom:6px; font-weight:600;">Nome</label>
                            <input id="charName" placeholder="Inserisci il tuo nome..." style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;" />
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:6px; font-weight:600;">Genere</label>
                            <select id="charGender" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;">
                                <option value="male">Maschile</option>
                                <option value="female">Femminile</option>
                                <option value="other">Altro</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:16px;">
                        <label style="display:block; margin-bottom:6px; font-weight:600;">Et√†</label>
                        <select id="charAge" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem;">
                            <option value="18">18 anni - Giovane e inesperto</option>
                            <option value="20" selected>20 anni - Fresco e motivato</option>
                            <option value="25">25 anni - Con un po' di esperienza</option>
                            <option value="30">30 anni - Maturo e navigato</option>
                        </select>
                    </div>
                </div>

                <!-- Background -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                        üéì Background
                    </h3>
                    <select id="charBackground" onchange="updateBackgroundInfo()" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem; margin-bottom:12px;">
                        <option value="student">üìö Studente</option>
                        <option value="worker">üë∑ Lavoratore</option>
                        <option value="tech">üíª Tecnico IT</option>
                        <option value="artist">üé® Artista</option>
                    </select>
                    <div id="backgroundInfo" style="padding:12px; background:rgba(102,126,234,0.1); border-radius:8px; border-left:4px solid #667eea; font-size:0.9rem; line-height:1.6;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Difficolt√† -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                        ‚öôÔ∏è Difficolt√†
                    </h3>
                    <select id="gameDifficulty" onchange="updateDifficultyInfo()" style="width:100%; padding:10px; border-radius:8px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; font-size:1rem; margin-bottom:12px;">
                        <option value="easy">üòä Facile - Inizio comodo (1000‚Ç¨)</option>
                        <option value="normal" selected>üòê Normale - Esperienza bilanciata (500‚Ç¨)</option>
                        <option value="hard">üò∞ Difficile - Vera sfida (200‚Ç¨)</option>
                    </select>
                    <div id="difficultyInfo" style="padding:12px; background:rgba(255,215,0,0.1); border-radius:8px; border-left:4px solid #ffd700; font-size:0.9rem; line-height:1.6;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Tratti Caratteriali -->
                <div style="margin-bottom:24px;">
                    <h3 style="margin-bottom:8px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                        ‚ú® Tratti Caratteriali
                    </h3>
                    <p style="font-size:0.85rem; opacity:0.7; margin-bottom:12px;">Seleziona massimo 3 tratti che definiscono il tuo personaggio</p>
                    <div id="traitsGrid" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Start Button -->
                <div style="text-align:center; padding-top:16px; border-top:2px solid rgba(255,255,255,0.1);">
                    <button onclick="startGame()" style="font-size:1.2rem; padding:14px 32px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; border-radius:12px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(102,126,234,0.4); transition:all 0.3s; width:100%; max-width:400px;">
                        üöÄ Inizia la Tua Avventura!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <!-- Top HUD Bar -->
        <div style="position:fixed; top:0; left:0; right:0; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:8px 16px; display:flex; gap:16px; align-items:center; justify-content:space-between; z-index:1000; border-bottom:2px solid rgba(102,126,234,0.3); flex-wrap:wrap;">
            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                <div style="min-width:180px;">
                    <div style="font-size:0.75rem; opacity:0.7;">üìÖ</div>
                    <div id="gameTime" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;">üí∞</div>
                    <div id="playerMoney" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;">‚≠ê</div>
                    <div id="playerRep" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;">üíº</div>
                    <div id="playerJob" style="font-weight:700; font-size:0.9rem;"></div>
                </div>
            </div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                <button id="timePlayPauseBtn" class="small" onclick="toggleTimePause()" style="background:var(--success); padding:4px 8px;">‚ñ∂Ô∏è</button>
                <button id="timeSpeedBtn" class="small" onclick="cycleTimeSpeed()" style="padding:4px 8px;">‚ö° 1x</button>
                <button class="small" onclick="showSleepUntilDialog()" style="padding:4px 8px;">üò¥</button>
                <button class="small" onclick="toggleStatsPanel()" style="padding:4px 8px;">üìä</button>
                <button class="small" onclick="toggleMenuPanel()" style="padding:4px 8px;">‚ò∞</button>
                <button class="small" onclick="saveGame()" style="padding:4px 8px;">üíæ</button>
            </div>
        </div>

        <!-- Left Stats Sidebar (collapsible) -->
        <div id="statsSidebar" style="position:fixed; left:0; top:50px; bottom:0; width:240px; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:12px; overflow-y:auto; z-index:900; border-right:2px solid rgba(102,126,234,0.3); transition:transform 0.3s;">
            <h3 style="margin-top:0; font-size:0.95rem;">üìä Statistiche</h3>
            
            <!-- Vital Stats -->
            <div style="margin-top:12px;">
                <div style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                        <span>üçî Fame</span><span id="hungerValue"></span>
                    </div>
                    <div class="stat-bar"><div id="hungerBar" class="stat-fill"></div></div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                        <span>‚ö° Energia</span><span id="energyValue"></span>
                    </div>
                    <div class="stat-bar"><div id="energyBar" class="stat-fill"></div></div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                        <span>üòä Morale</span><span id="moraleValue"></span>
                    </div>
                    <div class="stat-bar"><div id="moraleBar" class="stat-fill"></div></div>
                </div>
                <div style="margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.85rem;">
                        <span>‚ù§Ô∏è Salute</span><span id="healthValue"></span>
                    </div>
                    <div class="stat-bar"><div id="healthBar" class="stat-fill"></div></div>
                </div>
            </div>
            
            <!-- Skills -->
            <details style="margin-top:16px;" open>
                <summary style="font-size:0.9rem; font-weight:600; cursor:pointer; padding:6px; background:rgba(102,126,234,0.15); border-radius:6px;">
                    üìà Abilit√†
                </summary>
                <div style="margin-top:8px;">
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span>üß† Intelletto</span><span id="intellectValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="intellectBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span>üí™ Fitness</span><span id="fitnessValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="fitnessBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span>üé® Creativit√†</span><span id="creativityValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="creativityBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #fa709a 0%, #fee140 100%);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px; font-size:0.8rem;">
                            <span>üí¨ Carisma</span><span id="charismaValue2">0</span>
                        </div>
                        <div class="stat-bar">
                            <div id="charismaBar" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #30cfd0 0%, #330867 100%);"></div>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Quick Actions at Home -->
            <details style="margin-top:16px;" id="homeActionsPanel">
                <summary style="font-size:0.9rem; font-weight:600; cursor:pointer; padding:6px; background:rgba(102,126,234,0.15); border-radius:6px;">
                    üè† Azioni Casa
                </summary>
                <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;">
                    <button class="small" onclick="action('eat')" style="font-size:0.8rem;">üçΩÔ∏è Mangia</button>
                    <button class="small" onclick="action('sleep')" style="font-size:0.8rem;">üò¥ Dormi 8h</button>
                    <button class="small" onclick="action('shower')" style="font-size:0.8rem;">ÔøΩ Doccia</button>
                    <button class="small" onclick="action('relax')" style="font-size:0.8rem;">ÔøΩ Relax</button>
                    <button class="small" onclick="action('exercise')" style="font-size:0.8rem;">ÔøΩÔ∏è Allenati</button>
                </div>
            </details>
        </div>

        <!-- Right Menu Sidebar (collapsible) -->
        <div id="menuSidebar" style="position:fixed; right:0; top:50px; bottom:0; width:250px; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:16px; overflow-y:auto; z-index:900; border-left:2px solid rgba(102,126,234,0.3); transition:transform 0.3s; transform:translateX(100%);">
            <h3 style="margin-top:0; font-size:1rem;">‚ò∞ Menu</h3>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:16px;">
                <button onclick="switchMainTab('social')">ÔøΩ Sociale</button>
            
            <!-- SEZIONE PERSONALE -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;">üë§ Personale</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('skills')" style="font-size:0.9rem;">üìà Abilit√†</button>
                    <button onclick="switchMainTab('agenda')" style="font-size:0.9rem;">üìÖ Agenda</button>
                    <button onclick="switchMainTab('quests')" style="font-size:0.9rem;">‚≠ê Missioni</button>
                </div>
            </details>

            <!-- SEZIONE SOCIALE -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;">ÔøΩ Sociale</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('social')" style="font-size:0.9rem;">üë´ Persone</button>
                    <button onclick="switchMainTab('romance')" style="font-size:0.9rem;">üíï Relazioni</button>
                    <button onclick="switchMainTab('family')" style="font-size:0.9rem;">üë®‚Äçüë©‚Äçüëß Famiglia</button>
                    <button onclick="switchMainTab('social')">ÔøΩ Sociale</button>
                </div>
            </details>

            <!-- SEZIONE ECONOMIA -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;">üí∞ Economia</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('work')" style="font-size:0.9rem;">üíº Lavoro</button>
                    <button onclick="switchMainTab('investments')" style="font-size:0.9rem;">ÔøΩ Investimenti</button>
                    <button onclick="switchMainTab('shop')" style="font-size:0.9rem;">üõí Spesa</button>
                    <button onclick="switchMainTab('crime')" style="font-size:0.9rem;">üé≠ Crimine</button>
                </div>
            </details>

            <!-- SEZIONE CITT√Ä -->
            <details open style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;">üó∫Ô∏è Citt√†</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="switchMainTab('housing')" style="font-size:0.9rem;">üèòÔ∏è Abitazione</button>
                    <button onclick="showVehiclesMenu()" style="font-size:0.9rem;">ÔøΩ Veicoli</button>
                    <button onclick="showTransportMenu()" style="font-size:0.9rem;">ÔøΩ Trasporti</button>
                    <button onclick="showQuartersMenu()" style="font-size:0.9rem;">üèôÔ∏è Quartieri</button>
                </div>
            </details>

            <!-- SEZIONE SISTEMA -->
            <details style="margin-top:12px;">
                <summary style="font-size:0.95rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(102,126,234,0.15); border-radius:6px; color:#667eea;">‚öôÔ∏è Sistema</summary>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px; padding-left:8px;">
                    <button onclick="showWelcomeTutorial()" style="font-size:0.9rem;">‚ùì Guida</button>
                    <button onclick="saveGame()" style="font-size:0.9rem;">üíæ Salva</button>
                    <button onclick="backToMenu()" style="font-size:0.9rem;">üè† Menu Principale</button>
                </div>
            </details>
            </div>
        </div>

        <!-- Main Map Area -->
        <div style="position:fixed; left:280px; right:0; top:50px; bottom:0; overflow:auto;" id="mainMapArea">
            <div class="container" style="max-width:none; padding:20px;">
                <div class="card" style="min-height:calc(100vh - 100px);">
                    <h2 style="margin-top:0;">üó∫Ô∏è Mappa della Citt√†</h2>
                    <div id="currentLocationDisplay" style="background:rgba(102,126,234,0.2); padding:12px; border-radius:8px; margin-bottom:16px;">
                        <strong>ÔøΩ Posizione attuale:</strong> <span id="currentLocationText">Caricamento...</span>
                    </div>

                    <!-- Map Tabs -->
                    <div class="tab-buttons" style="margin-bottom:16px;">
                        <div class="tab-btn active" onclick="switchMapView('overview')">üåÜ Panoramica</div>
                        <div class="tab-btn" onclick="switchMapView('detailed')">üèòÔ∏è Dettaglio Quartiere</div>
                    </div>

                    <!-- Map Content -->

                    <!-- Overview Map -->
                    <div id="overviewMapContent" style="display:block;">
                        <div class="visual-map-container" id="visualMapContainer">
                            <div id="mapTooltip" class="map-tooltip"></div>
                            
                            <!-- Quarter Zones -->
                            <div class="map-grid" id="overviewMapGrid">
                                <!-- Top Row -->
                                <div class="quarter-zone" data-quarter="periferia" onclick="selectQuarterFromMap('periferia')" style="grid-column:1/3;">
                                    <div class="quarter-name">üèòÔ∏è Periferia</div>
                                    <div class="quarter-icon">üè†</div>
                                    <div class="quarter-stats">üë• 15k | üí∞ ‚Ç¨300/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="quartiere_operaio" onclick="selectQuarterFromMap('quartiere_operaio')" style="grid-column:3/5;">
                                    <div class="quarter-name">üè≠ Q. Operaio</div>
                                    <div class="quarter-icon">‚öôÔ∏è</div>
                                    <div class="quarter-stats">üë• 22k | üí∞ ‚Ç¨450/m</div>
                                </div>
                                <div style="grid-column:5; background:rgba(34,139,34,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;">üå≥</div>
                                
                                <!-- Middle Row -->
                                <div class="quarter-zone" data-quarter="zona_residenziale" onclick="selectQuarterFromMap('zona_residenziale')" style="grid-column:1/2;">
                                    <div class="quarter-name">üè° Residenziale</div>
                                    <div class="quarter-icon">üå∫</div>
                                    <div class="quarter-stats">üë• 12k | üí∞ ‚Ç¨600/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="centro_storico" onclick="selectQuarterFromMap('centro_storico')" style="grid-column:2/4;">
                                    <div class="quarter-name">üèõÔ∏è Centro Storico</div>
                                    <div class="quarter-icon">‚õ™</div>
                                    <div class="quarter-stats">üë• 18k | üí∞ ‚Ç¨700/m</div>
                                </div>
                                <div class="quarter-zone" data-quarter="quartiere_lusso" onclick="selectQuarterFromMap('quartiere_lusso')" style="grid-column:4/6;">
                                    <div class="quarter-name">üíé Luxury</div>
                                    <div class="quarter-icon">üè∞</div>
                                    <div class="quarter-stats">üë• 5k | üí∞ ‚Ç¨1200/m</div>
                                </div>
                                
                                <!-- Bottom Row -->
                                <div style="grid-column:1/2; background:rgba(30,144,255,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;">üíß</div>
                                <div style="grid-column:2/4; background:rgba(34,139,34,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">üå≥ Parco Centrale</div>
                                <div style="grid-column:4/6; background:rgba(139,69,19,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:2rem;">üèîÔ∏è</div>
                            </div>

                            <!-- Detailed Quarter Map -->
                            <div class="detailed-quarter-map" id="detailedQuarterMap">
                                <button class="back-to-overview-btn" onclick="hideDetailedQuarterMap()">‚Üê Torna alla Mappa</button>
                                <h4 id="detailedQuarterName"></h4>
                                <div class="detailed-map-grid" id="detailedMapGrid">
                                    <!-- Roads, locations, etc. will be rendered here -->
                                </div>
                            </div>

                            <!-- Player Marker -->
                            <div id="playerMarker" class="player-marker" style="display:none;">
                                üë§
                                <div class="player-location-label" id="playerLocationLabel">üè† Casa</div>
                            </div>

                            <!-- Legend -->
                            <div class="map-legend">
                                <div style="font-weight:bold; margin-bottom:8px;">Legenda</div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:#ff6b6b;">üë§</div>
                                    <span>Tu</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--warning);">üöè</div>
                                    <span>Fermata Bus</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--success); border-radius:4px;">üèõÔ∏è</div>
                                    <span>Punto Interesse</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-icon" style="background:var(--primary);">üè™</div>
                                    <span>Negozio</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Map -->
                    <div id="detailedMapContent" style="display:none;">
                        <div id="detailedMapContainer"></div>
                    </div>

                    <!-- Sezioni nascoste - ora accessibili dal menu laterale -->
                    <div id="vehiclesInfo" style="display:none;"></div>
                    <div id="transportInfo" style="display:none;"></div>
                    <div id="cityQuartiersMap" style="display:none;"></div>
                    <div id="quarterDetails" style="display:none;"></div>
                    <select id="quarterSelect" style="display:none;">
                        <option value="">Seleziona un quartiere...</option>
                        <option value="periferia">Periferia</option>
                        <option value="quartiere_operaio">Quartiere Operaio</option>
                        <option value="centro_storico">Centro Storico</option>
                        <option value="zona_residenziale">Zona Residenziale</option>
                        <option value="quartiere_lusso">Quartiere Luxury</option>
                    </select>
                </div>

                <div id="socialTabContent" class="tab-content">
                    <h3>üë• Persone Conosciute</h3>
                    <div id="knownPeopleList" style="margin-top:12px;"></div>
                    <div style="margin-top:12px;">
                        <button onclick="action('meet_new')">ü§ù Incontra Nuove Persone</button>
                    </div>
                </div>

                <div id="workTabContent" class="tab-content">
                    <h3>üíº Situazione Lavorativa</h3>
                    <div id="workStatusDiv" style="margin-top:12px;"></div>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">Offerte di Lavoro</summary>
                        <div id="jobListingsDiv" style="margin-top:8px;"></div>
                    </details>
                </div>

                <div id="cityTabContent" class="tab-content">
                    <h3>üåÜ Esplora la Citt√†</h3>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üå≥ Parco & Natura</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('park')">üö∂ Passeggiata</button>
                            <button onclick="action('jog_park')">üèÉ Jogging</button>
                            <button onclick="action('picnic')">üß∫ Picnic</button>
                            <button onclick="action('bird_watching')">ü¶ú Birdwatching</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üí™ Sport & Fitness</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('gym')">üèãÔ∏è Palestra</button>
                            <button onclick="action('swimming')">üèä Piscina</button>
                            <button onclick="action('yoga_class')">üßò Yoga</button>
                            <button onclick="action('boxing')">ü•ä Boxe</button>
                            <button onclick="action('bowling')">üé≥ Bowling</button>
                            <button onclick="action('mini_golf')">‚õ≥ Mini Golf</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üìö Cultura & Educazione</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('library')">üìñ Biblioteca</button>
                            <button onclick="action('research')">üî¨ Ricerca</button>
                            <button onclick="action('book_club')">üìö Club Lettura</button>
                            <button onclick="action('museum')">üèõÔ∏è Museo</button>
                            <button onclick="action('art_gallery')">üñºÔ∏è Galleria Arte</button>
                            <button onclick="action('guided_tour')">üéØ Tour Guidato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üçΩÔ∏è Cibo & Bevande</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cafe')">‚òï Caff√®</button>
                            <button onclick="action('breakfast_cafe')">ü•ê Colazione</button>
                            <button onclick="action('cafe_work')">üíª Lavora al Caff√®</button>
                            <button onclick="action('fast_food')">üçî Fast Food</button>
                            <button onclick="action('restaurant')">üçù Ristorante</button>
                            <button onclick="action('fine_dining')">‚≠ê Ristorante Stellato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;"> Vita Notturna</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('bar')">üç∫ Bar</button>
                            <button onclick="action('nightclub')">üéâ Discoteca</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üõçÔ∏è Shopping</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('window_shopping')">üëÄ Vetrine</button>
                            <button onclick="action('shopping')">üõçÔ∏è Shopping</button>
                            <button onclick="action('luxury_shopping')">üíé Shopping Lusso</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üíÜ Benessere & Relax</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('spa')">üßñ Spa</button>
                            <button onclick="action('massage')">üíÜ Massaggio</button>
                            <button onclick="action('sauna')">üî• Sauna</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üéì Corsi & Formazione</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cooking_class')">üë®‚Äçüç≥ Corso Cucina</button>
                            <button onclick="action('language_class')">üó£Ô∏è Corso Lingue</button>
                            <button onclick="action('art_class')">üé® Corso Arte</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">ü§ù Volontariato</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('volunteer')">‚ù§Ô∏è Volontariato</button>
                            <button onclick="action('animal_shelter')">üêï Rifugio Animali</button>
                        </div>
                    </details>
                </div>

                <div id="questsTabContent" class="tab-content">
                    <h3>‚≠ê Le Tue Missioni</h3>
                    <div id="questsList" style="margin-top:12px;"></div>
                </div>

                <div id="skillsTabContent" class="tab-content">
                    <h3>üìà Abilit√† e Statistiche</h3>
                    
                    <div style="padding:10px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:12px; text-align:center;">
                        <span style="font-weight:600;">Allenamenti Oggi:</span> 
                        <span id="dailyTrainingCount" style="font-weight:bold; color:var(--warning);">0/3</span>
                        <span style="font-size:0.85rem; opacity:0.8; margin-left:8px;">üí° Massimo 3 attivit√† di apprendimento al giorno</span>
                    </div>
                    
                    <div id="skillsDisplay" style="margin-top:12px;">
                        <div style="padding:14px; background:rgba(102,126,234,0.08); border-radius:12px; border-left:4px solid var(--primary);">
                            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:16px;">
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;">üß† Intelletto</span>
                                        <span id="intellectValue" style="font-size:1.2rem; font-weight:bold; color:var(--primary);">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="intellectBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="intellectLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;">üí™ Fitness</span>
                                        <span id="fitnessValue" style="font-size:1.2rem; font-weight:bold; color:#f5576c;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="fitnessBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="fitnessLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;">üé® Creativit√†</span>
                                        <span id="creativityValue" style="font-size:1.2rem; font-weight:bold; color:#fee140;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="creativityBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #fa709a 0%, #fee140 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="creativityLevel">Novizio</div>
                                </div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600;">üí¨ Carisma</span>
                                        <span id="charismaValue" style="font-size:1.2rem; font-weight:bold; color:#30cfd0;">0</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div id="charismaBarTab" class="stat-fill" style="width:0%; background:linear-gradient(90deg, #30cfd0 0%, #330867 100%);"></div>
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;" id="charismaLevel">Novizio</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <details style="margin-top:20px;" open>
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üß† Allenamento Intelletto</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('read')">üìö Leggi Libro</button>
                            <button onclick="action('study')">üìñ Studia</button>
                            <button onclick="action('library')">üèõÔ∏è Biblioteca</button>
                            <button onclick="action('research')">üî¨ Ricerca</button>
                            <button onclick="action('museum')">üèõÔ∏è Museo</button>
                            <button onclick="action('guided_tour')">üéì Tour Guidato</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üí™ Allenamento Fitness</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('exercise')">üèÉ Esercizio</button>
                            <button onclick="action('jog_park')">üå≥ Jogging Parco</button>
                            <button onclick="action('gym')">üèãÔ∏è Palestra</button>
                            <button onclick="action('swimming')">üèä Nuoto</button>
                            <button onclick="action('boxing')">ü•ä Boxe</button>
                            <button onclick="action('yoga')">üßò Yoga</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üé® Allenamento Creativit√†</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('hobby_paint')">üé® Dipingi</button>
                            <button onclick="action('art_gallery')">üñºÔ∏è Galleria Arte</button>
                            <button onclick="action('theater')">üé≠ Teatro</button>
                            <button onclick="action('opera')">üéµ Opera</button>
                            <button onclick="action('music_lesson')">üé∏ Lezione Musica</button>
                            <button onclick="action('photography')">üì∑ Fotografia</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üí¨ Allenamento Carisma</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('nightclub')">üéâ Nightclub</button>
                            <button onclick="action('bar')">üç∫ Bar</button>
                            <button onclick="action('karaoke')">üé§ Karaoke</button>
                            <button onclick="action('book_club')">üìö Book Club</button>
                            <button onclick="action('networking')">ü§ù Networking</button>
                            <button onclick="action('public_speaking')">üé§ Public Speaking</button>
                        </div>
                    </details>
                </div>

                <div id="housingTabContent" class="tab-content">
                    <h3>üèòÔ∏è Situazione Abitativa</h3>
                    <div id="currentHousingInfo" style="margin-top:12px;"></div>
                    
                    <details style="margin-top:20px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üè† Quartieri Disponibili</summary>
                        <div id="neighborhoodsList" style="margin-top:12px;"></div>
                    </details>

                    <details style="margin-top:20px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üí∞ Sistema Economico</summary>
                        <div style="padding:12px; background:rgba(255,200,100,0.1); border-radius:8px; border-left:3px solid var(--warning); margin-top:8px;">
                            <p style="margin-top:8px; font-size:0.9rem;">‚Ä¢ L'affitto viene pagato automaticamente ogni 30 giorni</p>
                            <p style="margin-top:4px; font-size:0.9rem;">‚Ä¢ Le tasse (10% del reddito) vengono pagate ogni 90 giorni</p>
                            <p style="margin-top:4px; font-size:0.9rem;">‚Ä¢ Il costo del cibo varia in base al quartiere</p>
                        </div>
                    </details>
                </div>

                <div id="shopTabContent" class="tab-content">
                    <h3>üõí Supermercato</h3>
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üçΩÔ∏è Il Tuo Inventario Cibo</summary>
                        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-top:8px;">
                            <div id="foodInventory" style="margin-top:8px;"></div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üõçÔ∏è Prodotti Disponibili</summary>
                        <div id="foodShop" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px; margin-top:12px;"></div>
                    </details>
                </div>

                <div id="agendaTabContent" class="tab-content">
                    <h3>üìÖ Agenda</h3>
                    
                    <div style="padding:12px; background:rgba(102,126,234,0.1); border-radius:8px; margin-bottom:16px; border-left:3px solid var(--primary);">
                        <h4 style="margin-bottom:8px;">üìÜ Oggi: Giorno <span id="agendaCurrentDay">1</span> - Ore <span id="agendaCurrentHour">08:00</span></h4>
                        <div style="font-size:0.9rem; opacity:0.9;">Organizza i tuoi appuntamenti e non perderti nulla!</div>
                    </div>
                    
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <button onclick="showAddAppointmentDialog()" class="action-btn" style="flex:1; background:var(--success);">
                            ‚ûï Nuovo Appuntamento
                        </button>
                        <button onclick="showTodaySchedule()" class="action-btn" style="flex:1;">
                            üìã Programma Oggi
                        </button>
                    </div>
                    
                    <details open>
                        <summary style="font-size:1rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;">
                            üìÖ Prossimi Appuntamenti
                        </summary>
                        <div id="upcomingAppointments" style="margin-top:12px;"></div>
                    </details>
                    
                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; font-weight:600; cursor:pointer; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px;">
                            ‚úÖ Appuntamenti Passati
                        </summary>
                        <div id="pastAppointments" style="margin-top:12px;"></div>
                    </details>
                </div>

                <div id="romanceTabContent" class="tab-content">
                    <h3>üíï Relazioni Romantiche</h3>
                    <div id="romanceStatus" style="margin-top:12px;"></div>
                    <div id="datingList" style="margin-top:16px;"></div>
                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üíò Potenziali Partner</summary>
                        <div id="potentialPartners" style="margin-top:12px;"></div>
                    </details>
                </div>

                <div id="familyTabContent" class="tab-content">
                    <h3>üë®‚Äçüë©‚Äçüëß Famiglia</h3>
                    <div id="familyStatus" style="margin-top:12px;"></div>
                    <div id="childrenList" style="margin-top:16px;"></div>
                </div>

                <div id="investmentsTabContent" class="tab-content">
                    <h3>üí∞ Investimenti e Finanze</h3>
                    
                    <details open style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üè¶ Gestione Denaro</summary>
                        <div style="margin-top:8px; padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div style="padding:10px; background:rgba(56,239,125,0.15); border-radius:8px;">
                                    <div style="font-size:0.85rem; opacity:0.8;">üíµ Contante</div>
                                    <div style="font-weight:bold; font-size:1.3rem; color:var(--success);">‚Ç¨<span id="cashDisplay">0</span></div>
                                    <div style="font-size:0.75rem; opacity:0.6;">Pu√≤ essere rubato</div>
                                </div>
                                <div style="padding:10px; background:rgba(56,159,239,0.15); border-radius:8px;">
                                    <div style="font-size:0.85rem; opacity:0.8;">üè¶ Banca</div>
                                    <div style="font-weight:bold; font-size:1.3rem; color:var(--primary);">‚Ç¨<span id="bankDisplay">0</span></div>
                                    <div style="font-size:0.75rem; opacity:0.6;">Sicuro</div>
                                </div>
                            </div>
                            <button onclick="showBankDialog()" class="action-btn" style="width:100%;">
                                üè¶ Gestisci Conti Bancari
                            </button>
                        </div>
                    </details>
                    
                    <details style="margin-top:12px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üíµ Conto Risparmio</summary>
                        <div style="margin-top:8px; padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-size:0.9rem; opacity:0.8;">Saldo Risparmi</div>
                                    <div style="font-weight:bold; font-size:1.5rem; color:var(--success);" id="savingsAmount">‚Ç¨0</div>
                                    <div style="font-size:0.85rem; opacity:0.7;">Interesse: 2% mensile</div>
                                </div>
                                <div style="display:flex; gap:8px; flex-direction:column;">
                                    <button class="small" onclick="depositSavings()">üíµ Deposita</button>
                                    <button class="small" onclick="withdrawSavings()">üí∏ Preleva</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üìà Azioni</summary>
                        <div id="stockPortfolio" style="margin-top:12px;"></div>
                        <div style="margin-top:12px;">
                            <h5>Mercato Azionario</h5>
                            <div id="stockMarket" class="grid" style="grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:12px; margin-top:8px;"></div>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üè¢ Propriet√† Immobiliari</summary>
                        <div id="propertiesList" style="margin-top:12px;"></div>
                        <div style="margin-top:12px;">
                            <button onclick="showPropertyMarket()">üèòÔ∏è Mercato Immobiliare</button>
                        </div>
                    </details>
                </div>

                <div id="crimeTabContent" class="tab-content">
                    <h3>üé≠ Attivit√† Alternative</h3>
                    
                    <details style="padding:0; margin-bottom:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">‚ö†Ô∏è ATTENZIONE</summary>
                        <div style="padding:12px; background:rgba(255,100,100,0.1); border-radius:8px; border-left:3px solid var(--danger); margin-top:8px;">
                            <p style="font-size:0.9rem; opacity:0.9;">Le attivit√† illegali comportano rischi: arresto, multe, perdita reputazione. Procedi con cautela!</p>
                        </div>
                    </details>

                    <div id="crimeStatus" style="margin-top:12px;"></div>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üé≤ Attivit√† Disponibili</summary>
                        <div class="grid grid-3" style="margin-top:12px;">
                            <button onclick="crimeAction('pickpocket')">üëú Borseggio</button>
                            <button onclick="crimeAction('burglary')">üè† Furto</button>
                            <button onclick="crimeAction('hack')">üíª Hacking</button>
                            <button onclick="crimeAction('scam')">üìß Truffa Online</button>
                            <button onclick="crimeAction('smuggle')">üì¶ Contrabbando</button>
                            <button onclick="crimeAction('blackjack')">üé∞ Blackjack Illegale</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">‚ú® Riscatto</summary>
                        <div style="padding:12px; background:rgba(56,239,125,0.1); border-radius:8px; border-left:3px solid var(--success); margin-top:8px;">
                            <p style="font-size:0.9rem; margin-top:6px;">Se hai precedenti, puoi pulire la fedina penale:</p>
                            <button onclick="clearRecord()" style="margin-top:8px;">üßπ Pulisci Fedina (‚Ç¨5000)</button>
                        </div>
                    </details>

                    <details style="margin-top:16px;">
                        <summary style="font-size:1rem; opacity:0.9; cursor:pointer;">üé¨ Intrattenimento</summary>
                        <div class="grid grid-3" style="margin-top:8px;">
                            <button onclick="action('cinema')">üé¨ Cinema</button>
                            <button onclick="action('cinema_vip')">üéüÔ∏è Cinema VIP</button>
                            <button onclick="action('theater')">üé≠ Teatro</button>
                            <button onclick="action('opera')">üéº Opera</button>
                            <button onclick="action('live_music')">üé∏ Musica Live</button>
                            <button onclick="action('karaoke')">üé§ Karaoke</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ---------- ENHANCED DIALOGUE SYSTEM ----------
    const ENHANCED_DIALOGUE_SYSTEM = {
        topics: {
            greeting: {
                questions: ['Come va la giornata?', 'Tutto bene?', 'Come stai?', 'Che mi racconti?', 'Come procede tutto?', 'Novit√† interessanti?', 'Che ne dici di quest\'aria?', 'Giornata pesante?', 'Hai dormito bene?', 'Come ti senti oggi?', 'Bella giornata vero?', 'Hai gi√† mangiato?', 'Stanco?', 'Energico oggi?', 'Umore buono?'],
                responses: {
                    positive: ['Molto bene, grazie!', 'Tutto perfetto!', 'Non potrebbe andare meglio!', 'Splendida giornata!', 'Sono in forma!', 'Mai stato meglio!', 'Giornata fantastica!', 'Pieno di energie!', 'Ottima giornata!', 'Super positivo!'],
                    neutral: ['Bene, grazie', 'Tutto nella norma', 'Si va avanti', 'Come sempre', 'Niente di che', 'Normale routine', 'Come al solito', 'Cos√¨ cos√¨', 'Si tira avanti', 'Nella media'],
                    negative: ['Potrebbe andare meglio...', 'Non √® la mia giornata', 'Ho avuto giorni migliori', 'Un po\' stressato', 'Giornata difficile', 'Non molto bene', 'Potrebbe essere peggio', 'Stanchissimo', 'Non al massimo', 'Giornata no']
                }
            },
            work: {
                questions: ['Come va il lavoro?', 'Ti piace quello che fai?', 'Progetti per la carriera?', 'Il tuo capo come √®?', 'Colleghi simpatici?', 'Orari pesanti?', 'Stipendio soddisfacente?', 'Opportunit√† di crescita?', 'Ambiente lavorativo?', 'Benefit aziendali?', 'Smart working possibile?', 'Formazione prevista?', 'Stress sul lavoro?', 'Equilibrio vita-lavoro?', 'Soddisfatto della tua posizione?', 'Cambieresti lavoro?', 'Relazioni con i capi?', 'Prospettive di carriera?', 'Ti senti valorizzato?', 'Ferie sufficienti?'],
                responses: {
                    positive: ['Adoro il mio lavoro!', '√à molto gratificante', 'Sto imparando tanto', 'Team fantastico!', 'Ambiente stimolante', 'Grande opportunit√†', 'Capo comprensivo', 'Colleghi come amici', 'Lavoro dei sogni!', 'Crescita continua', 'Mi sento realizzato', 'Perfetto per me'],
                    neutral: ['√à un lavoro come un altro', 'Paga le bollette', 'Va bene cos√¨', 'Routine quotidiana', 'Niente di speciale', 'Fa il suo', 'Accettabile', 'Si potrebbe migliorare', 'Nella norma', 'N√© bene n√© male'],
                    negative: ['Non √® quello che sognavo', 'Sto cercando altro', '√à stressante', 'Troppa pressione', 'Ambiente tossico', 'Sottopagato', 'Nessuna crescita', 'Capo impossibile', 'Orari assurdi', 'Voglio cambiare', 'Non mi valorizzano', 'Troppo stress']
                }
            },
            personal: {
                questions: ['Come va la vita sentimentale?', 'Famiglia numerosa?', 'Progetti futuri?', 'Sogni nel cassetto?', 'Cosa ti rende felice?', 'Paure pi√π grandi?', 'Hobby preferiti?', 'Dove vorresti viaggiare?', 'Film preferito?', 'Musica che ascolti?', 'Sport praticati?', 'Libri letti recentemente?', 'Serie TV seguite?', 'Animali domestici?', 'Cucina preferita?', 'Vacanza ideale?', 'Momento della giornata preferito?', 'Stagione favorita?', 'Talenti nascosti?', 'Obiettivi di vita?'],
                responses: {
                    positive: ['Tutto va per il meglio', 'Famiglia meravigliosa', 'Tanti progetti entusiasmanti', 'Felicissimo', 'Vita piena', 'Tante passioni', 'Sogni realizzabili', 'Momento d\'oro', 'Relazioni bellissime', 'Pieno di idee'],
                    neutral: ['Si va avanti', 'Famiglia normale', 'Vedremo cosa succede', 'Niente di speciale', 'Vita standard', 'Pochi hobby', 'Obiettivi vaghi', 'Tutto ok', 'Situazione stabile', 'Come tutti'],
                    negative: ['√à complicato', 'Situazione difficile', 'Incertezze sul futuro', 'Single e triste', 'Pochi amici', 'Nessun hobby', 'Sogni infranti', 'Momento buio', 'Solitudine', 'Senza direzione']
                }
            },
            city: {
                questions: ['Ti piace Eldoria?', 'Quartiere preferito?', 'Posti da evitare?', 'Ristoranti consigliati?', 'Vita notturna?', 'Sicurezza in citt√†?', 'Trasporti pubblici?', 'Costo della vita?', 'Eventi in citt√†?', 'Luoghi nascosti da vedere?', 'Parchi pi√π belli?', 'Shopping migliore?', 'Vita culturale?', 'Problemi della citt√†?', 'Cambieresti citt√†?'],
                responses: {
                    positive: ['Eldoria √® fantastica!', 'Adoro vivere qui', 'Citt√† piena di vita', 'Mai noiosa', 'Tante opportunit√†', 'Gente meravigliosa', 'Sicura e vivibile', 'Perfetta per me', 'Non la lascerei mai'],
                    neutral: ['Va bene', 'Come tutte le citt√†', 'Ha pro e contro', 'Ci si abitua', 'Dipende dal quartiere', 'Niente di speciale', 'Citt√† normale', 'Ok per vivere'],
                    negative: ['Troppo caotica', 'Criminalit√† alta', 'Costosa', 'Traffico impossibile', 'Troppo inquinata', 'Gente fredda', 'Vorrei andarmene', 'Non mi piace']
                }
            },
            money: {
                questions: ['Come vanno le finanze?', 'Risparmi qualcosa?', 'Investimenti?', 'Debiti da pagare?', 'Stipendio sufficiente?', 'Spese pi√π grandi?', 'Come gestisci i soldi?', 'Banca affidabile?', 'Pensione?', 'Assicurazioni?'],
                responses: {
                    positive: ['Bene, riesco a risparmiare', 'Portfolio diversificato', 'Nessun debito', 'Vivendo bene', 'Finanze sane', 'Investimenti solidi'],
                    neutral: ['Arrivo a fine mese', 'Qualche risparmio', 'Gestione oculata', 'N√© ricco n√© povero', 'Si va avanti'],
                    negative: ['Sempre in rosso', 'Debiti accumulati', 'Non basta mai', 'Situazione critica', 'Devo risparmiare']
                }
            },
            health: {
                questions: ['Come va la salute?', 'Fai sport?', 'Dieta equilibrata?', 'Dormi abbastanza?', 'Stress gestibile?', 'Check-up recenti?', 'Problemi di salute?', 'Palestra o casa?', 'Vita sana?', 'Ti prendi cura di te?'],
                responses: {
                    positive: ['In forma perfetta', 'Sport regolare', 'Dieta sana', 'Dormo benissimo', 'Zero stress', 'Salute di ferro'],
                    neutral: ['Tutto ok', 'Un po\' di sport', 'Dieta normale', 'Dormo discretamente', 'Stress moderato'],
                    negative: ['Non benissimo', 'Sedentario totale', 'Mangio male', 'Insonnia', 'Stressatissimo', 'Trascuro la salute']
                }
            },
            weather: {
                questions: ['Che tempo fa?', 'Ti piace questa stagione?', 'Caldo o freddo?', 'Pioggia o sole?', 'Neve o estate?', 'Tempo ideale?', 'Influenza del meteo sull\'umore?'],
                responses: {
                    positive: ['Tempo perfetto', 'Adoro questa stagione', 'Temperatura ideale', 'Sole magnifico', 'Clima fantastico'],
                    neutral: ['Tempo normale', 'Stagione ok', 'Temperatura accettabile', 'Come sempre', 'Niente di che'],
                    negative: ['Troppo caldo', 'Troppo freddo', 'Pioggia continua', 'Tempo pessimo', 'Stagione orribile']
                }
            },
            philosophy: {
                questions: ['Senso della vita?', 'Cosa conta davvero?', 'Felicit√† √®...?', 'Dopo la morte?', 'Destino o caso?', 'Dio esiste?', 'Giusto e sbagliato?', 'Tempo o denaro?', 'Amore o successo?', 'Vivere per cosa?'],
                responses: {
                    positive: ['La vita √® meravigliosa', 'Conta l\'amore', 'La felicit√† √® semplice', 'Credo nel destino', 'Tutto ha un senso'],
                    neutral: ['Non lo so', 'Difficile dirlo', 'Ognuno la sua verit√†', 'Mistero irrisolto', 'Forse entrambi'],
                    negative: ['La vita √® dura', 'Non c\'√® un senso', 'Felicit√† illusoria', 'Solo caso', 'Niente conta']
                }
            }
        }, // Fine propriet√† philosophy dentro topics  
        skillBasedDialogue: {
            intellect: {
                10: { questions: ['Leggi mai?', 'Guardi le notizie?', 'Quiz show?'], responses: ['Poco tempo', 'Solo sport', 'Troppo difficili'] },
                20: { questions: ['Film o libri?', 'Documentari?', 'App news?'], responses: ['Film d\'azione', 'Qualcuno', 'Scrollo titoli'] },
                30: { questions: ['Cosa pensi delle notizie?', 'Hai letto qualche libro interessante?', 'Podcast ascolti?', 'Storia ti interessa?'], responses: ['Ho delle teorie interessanti...', 'Recentemente ho studiato...', 'Alcuni tech', 'Epoca romana'] },
                40: { questions: ['Saggi o narrativa?', 'Scienza seguita?', 'Filosofia?', 'Economia?'], responses: ['Entrambi', 'Fisica quantistica', 'Stoicismo', 'Macro interessante'] },
                50: { questions: ['Potresti spiegarmi questo concetto?', 'Che ne pensi di questa teoria?', 'Pubblicazioni lette?', 'Ricerca tua?'], responses: ['√à un argomento complesso...', 'Dal mio punto di vista...', 'Nature e Science', 'Campo interessante'] },
                60: { questions: ['Dibattito filosofico?', 'Teoria economica?', 'Scoperte recenti?', 'AI e futuro?'], responses: ['Stimolante', 'Keynes era brillante', 'CRISPR rivoluzionario', 'Cambier√† tutto'] },
                70: { questions: ['Collaboreresti a un progetto di ricerca?', 'Insegneresti qualcosa?', 'Conferenze?', 'Pubblicato articoli?'], responses: ['Sarei onorato di contribuire', 'Posso condividere le mie conoscenze', 'Tenuto alcune', 'Peer reviewed'] },
                80: { questions: ['Dottorato conseguito?', 'Brevetti?', 'Cattedra universitaria?', 'H-index?'], responses: ['PhD in fisica', 'Due pending', 'Professore associato', 'Discreto'] },
                90: { questions: ['Nobel candidatura?', 'Scoperte rivoluzionarie?', 'Eredit√† scientifica?'], responses: ['Chi lo sa...', 'Campo avanzato', 'Contributi significativi'] }
            },
            charisma: {
                10: { questions: ['Timido?', 'Poche amicizie?', 'Parlare in pubblico?'], responses: ['Molto', 'Preferisco', 'Mi terrorizza'] },
                20: { questions: ['Eventi sociali?', 'Gruppo o soli?', 'Conversazioni?'], responses: ['Li evito', 'Piccoli gruppi', 'Fatico'] },
                30: { questions: ['Organizzi mai eventi?', 'Sei bravo a parlare in pubblico?', 'Nuove persone?', 'Feste?'], responses: ['Mi piace coinvolgere le persone', 'Ho una certa facilit√† di parola', 'Aperto', 'Divertenti'] },
                40: { questions: ['Leadership?', 'Team work?', 'Networking?', 'Presentazioni?'], responses: ['Quando serve', 'Collaboro bene', 'Utile', 'Me la cavo'] },
                50: { questions: ['Potresti convincere qualcuno per me?', 'Daresti consigli di comunicazione?', 'Negoziazioni?', 'Conflitti?'], responses: ['Posso provare a mediare', 'La comunicazione √® importante', 'Risultati buoni', 'Li risolvo'] },
                60: { questions: ['Influenza sugli altri?', 'Motivare team?', 'Public speaking?', 'Empatia?'], responses: ['Naturale', 'So coinvolgere', 'Senza paura', 'Capisco le persone'] },
                70: { questions: ['Saresti un ottimo leader', 'Potresti guidare un team?', 'Ispiri fiducia?', 'Carisma?'], responses: ['Mi piacciono le sfide di leadership', 'So motivare le persone', 'Mi dicono di s√¨', 'Innato'] },
                80: { questions: ['Celebrit√† locale?', 'Seguaci fedeli?', 'Parlare a folle?', 'Cambi opinioni?'], responses: ['Un po\' conosciuto', 'Community forte', 'Grandi platee', 'Influente'] },
                90: { questions: ['Leader riconosciuto?', 'Presenza magnetica?', 'Trascinatore?'], responses: ['In certi ambienti', 'Si nota', 'Mi seguono'] }
            },
            creativity: {
                10: { questions: ['Arte?', 'Musica?', 'Disegno?'], responses: ['Non capisco', 'Solo ascolto', 'Pessimo'] },
                20: { questions: ['Hobby creativi?', 'Foto?', 'DIY?'], responses: ['Standard', 'Selfie', 'Seguo guide'] },
                30: { questions: ['Fai qualcosa di artistico?', 'Hai idee creative?', 'Strumento?', 'Scrivere?'], responses: ['Mi piace esprimermi creativamente', 'Ho sempre nuove idee', 'Chitarra base', 'Blog personale'] },
                40: { questions: ['Progetti creativi?', 'Portfolio?', 'Stile personale?', 'Design?'], responses: ['Alcuni in corso', 'Online', 'Mio modo', 'Mi diverte'] },
                50: { questions: ['Potresti aiutarmi con un progetto creativo?', 'Cosa ne pensi di questo design?', 'Mostre?', 'Commissioni?'], responses: ['Posso dare il mio contributo artistico', 'Ho alcune idee innovative', 'Una locale', 'Qualcuna'] },
                60: { questions: ['Opere vendute?', 'Album registrati?', 'Romanzo scritto?', 'Gallerie?'], responses: ['Su Etsy', 'EP indie', 'Autopubblicato', 'Qualche contatto'] },
                70: { questions: ['Sei un vero artista!', 'Potresti insegnare arte?', 'Premi vinti?', 'Riconoscimento?'], responses: ['L\'arte √® la mia passione', 'Posso ispirare altri creativi', 'Concorso regionale', 'Crescente'] },
                80: { questions: ['Mostre importanti?', 'Tour?', 'Best seller?', 'Movimento artistico?'], responses: ['Gallerie nazionali', 'Europa', 'In classifica', 'Neo-surrealismo'] },
                90: { questions: ['Eredit√† artistica?', 'Rivoluzione stilistica?', 'Opera magnum?'], responses: ['Influenzato molti', 'Trend setter', 'In lavorazione'] }
            },
            fitness: {
                10: { questions: ['Sport?', 'Scale?', 'Camminare?'], responses: ['Mai', 'Ascensore', 'Minimo'] },
                20: { questions: ['Palestra?', 'Bici?', 'Passeggiate?'], responses: ['Ci pensavo', 'Raramente', 'Weekend'] },
                30: { questions: ['Fai sport regolarmente?', 'Tieni alla forma fisica?', 'Corsa?', 'Dieta?'], responses: ['Cerco di mantenermi in forma', 'L\'esercizio √® importante', '3km facili', 'Equilibrata'] },
                40: { questions: ['Allenamenti settimanali?', 'Sport praticati?', 'Obiettivi?', 'App fitness?'], responses: ['3-4 volte', 'Calcetto', 'Mantenermi', 'MyFitnessPal'] },
                50: { questions: ['Potresti allenarmi?', 'Che routine consigli?', 'Cardio o pesi?', 'Supplementi?'], responses: ['Posso condividere i miei allenamenti', 'Conosco buone tecniche', 'Mix bilanciato', 'Proteine'] },
                60: { questions: ['Gare partecipate?', 'Record personali?', 'CrossFit?', 'Massa muscolare?'], responses: ['Alcune locali', 'Migliorando', 'WODs', 'In crescita'] },
                70: { questions: ['Sei in forma incredibile!', 'Faresti il personal trainer?', 'Maratone?', 'Triathlon?'], responses: ['Il fitness √® il mio stile di vita', 'Posso aiutare altri a migliorare', 'Corsa una', 'Sprint'] },
                80: { questions: ['Competizioni agonistiche?', 'Sponsor?', 'Record regionali?', 'Allenamenti quotidiani?'], responses: ['Livello semi-pro', 'Locale', 'Under 23', 'Due sessioni'] },
                90: { questions: ['Carriera professionista?', 'Olimpiadi?', 'Medaglie nazionali?'], responses: ['Part-time', 'Aspirazione', 'Alcune'] }
            }
        },
        jobBasedDialogue: {
            'Disoccupato': { 
                questions: ['Stai cercando lavoro?', 'Che tipo di lavoro vorresti?', 'Difficile trovare?', 'Da quanto sei disoccupato?', 'Hai mandato CV?', 'Colloqui fatti?', 'Formazione in corso?', 'Cambiare settore?', 'Aspettative salariali?', 'Piano B?', 'Ti aiuta qualcuno?', 'Hai risparmi?'], 
                responses: ['Sto mandando CV', 'Vorrei qualcosa che mi piace', 'Il mercato √® difficile', 'Da qualche mese purtroppo', 'Ogni giorno nuove candidature', 'Alcuni colloqui senza esito', 'Sto studiando online', 'Sto considerando altre opzioni', 'Qualsiasi cosa decente', 'Sto valutando alternative', 'La famiglia mi sostiene', 'I risparmi stanno finendo'] 
            },
            'Programmatore Jr': { 
                questions: ['Come va con il codice?', 'Che linguaggi usi?', 'Progetti interessanti?', 'Framework preferito?', 'Bug pi√π strani?', 'Pair programming?', 'Code review?', 'Stack tecnologico?', 'Deadline strette?', 'Senior disponibili?', 'Impari molto?', 'Vuoi specializzarti?'], 
                responses: ['Sto imparando molto', 'Lavoro principalmente con...', 'Stiamo sviluppando...', 'React e Node.js', 'Ogni giorno nuovi bug', 'S√¨, molto utile', 'Ricevo feedback costanti', 'MERN stack completo', 'Sprint di due settimane', 'Team molto preparato', 'Crescita continua', 'Interessato al backend'] 
            },
            'Manager Vendite': { 
                questions: ['Come vanno le vendite?', 'Gestisci un team?', 'Obiettivi del trimestre?', 'Strategia commerciale?', 'Clienti difficili?', 'Incentivi e bonus?', 'CRM usato?', 'Lead generation?', 'Trattative complesse?', 'Formazione del team?', 'KPI principali?', 'Mercato competitivo?'], 
                responses: ['Il team sta performando bene', 'Abbiamo superato gli obiettivi', 'Sto formando nuovi talenti', 'Focus su qualit√† e servizio', 'Gestiti con diplomazia', 'Sistema di bonus motivante', 'Salesforce principalmente', 'Multi-channel approach', 'Negoziazioni win-win', 'Training settimanale', 'Revenue e retention', 'Molto, ma siamo forti'] 
            },
            'Barista': { 
                questions: ['Che caff√® consigli?', 'Clienti interessanti?', 'Orari pesanti?', 'Latte art?', 'Macchina usata?', 'Chicchi preferiti?', 'Clienti abituali?', 'Rush hour stressante?', 'Propine buone?', 'Colleghi simpatici?', 'Passione o lavoro?', 'Aprire un locale?'], 
                responses: ['Dipende dai gusti', 'Ogni giorno storie nuove', 'Si inizia presto ma mi piace', 'Sto imparando le tecniche', 'Professionale, ottima', 'Arabica 100%', 'Conosco tutti i nomi', 'Mattina sempre piena', 'Dipende dal giorno', 'Team affiatato', 'Vera passione', 'Sogno nel cassetto'] 
            },
            'Medico': { 
                questions: ['Casi interessanti?', 'Specializzazione?', 'Orari impossibili?', 'Emergenze notturne?', 'Pazienti difficili?', 'Medicina preventiva?', 'Aggiornamento continuo?', 'Stress del lavoro?', 'Soddisfazioni grandi?', 'Errori medici?', 'Assicurazione malpractice?', 'Vita privata?'], 
                responses: ['Ogni caso √® unico', 'Mi sono specializzato in...', 'Le emergenze non aspettano', 'Turni di notte frequenti', 'Empatia e pazienza', 'Fondamentale per la salute', 'Congressi e studi costanti', 'Alto ma gratificante', 'Salvare vite', 'Protocolli rigorosi', 'Obbligatoria', 'Difficile trovare equilibrio'] 
            },
            'Cassiere': {
                questions: ['Clienti maleducati?', 'Furti frequenti?', 'Coda infinita?', 'Promozioni complicate?', 'Colleghi alla cassa?', 'Piedi stanchi?', 'Cambio turni?', 'Monotono?', 'Offerte speciali?', 'Sistema POS?'],
                responses: ['Capita spesso', 'Sicurezza attenta', 'Ore di punta pazzesche', 'Sistema confuso', 'Team solidale', 'Sempre in piedi', 'Turni variabili', 'Routine ripetitiva', 'Le gestisco io', 'Tecnologia moderna']
            },
            'Insegnante': {
                questions: ['Studenti motivati?', 'Materia preferita?', 'Compiti da correggere?', 'Genitori invadenti?', 'Stipendio adeguato?', 'Riforme scolastiche?', 'Classi numerose?', 'Vocazione o lavoro?', 'Estate libera?', 'Tecnologia in classe?'],
                responses: ['Alcuni molto', 'La mia materia mi appassiona', 'Montagne di verifiche', 'A volte troppo', 'Non rispecchia l\'impegno', 'Sempre in cambiamento', 'Troppi studenti', 'Vera vocazione', 'Periodo di riposo meritato', 'LIM e tablet']
            },
            'Cuoco': {
                questions: ['Piatto signature?', 'Cucina calda stressante?', 'Chef urlano?', 'Creativit√† possibile?', 'Ingredienti freschi?', 'Michelin stelle?', 'Orari del ristorante?', 'Brigade de cuisine?', 'Aprire ristorante?', 'Passione cibo?'],
                responses: ['Risotto allo zafferano', 'Pressione alta sempre', 'Disciplina ferrea', 'Menu stagionale', 'Solo prodotti locali', 'Un giorno forse', 'Sera e weekend', 'Team affiatato', 'Grande sogno', 'Nata in famiglia']
            },
            'Avvocato': {
                questions: ['Casi vinti?', 'Tribunale spesso?', 'Specializzazione legale?', 'Studio proprio?', 'Clienti difficili?', 'Orari assurdi?', 'Parcelle alte?', 'Giustizia funziona?', 'Pro bono?', 'Etica professionale?'],
                responses: ['Percentuale alta', 'Aula ogni settimana', 'Diritto civile', 'Associato in studio', 'Gestione diplomatica', 'Notti sui fascicoli', 'Dipende dalla causa', 'Sistema lento', 'Quando possibile', 'Sempre al primo posto']
            },
            'Artista': {
                questions: ['Opere recenti?', 'Gallerie interessate?', 'Vivere d\'arte?', 'Ispirazione dove?', 'Tecnica preferita?', 'Mercato dell\'arte?', 'Commissioni?', 'Mostre personali?', 'Critica d\'arte?', 'Processo creativo?'],
                responses: ['Serie nuova', 'Contatti in corso', 'Difficile ma possibile', 'Vita quotidiana', 'Olio su tela', 'Volatile e difficile', 'Principalmente ritratti', 'Una l\'anno scorso', 'Soggettiva sempre', 'Intuizione e lavoro']
            }
        },
        relationshipDialogue: {
            stranger: { 
                questions: ['Di dove sei?', 'Lavori qui vicino?', 'Prima volta che ci vediamo', 'Abiti in zona?', 'Che ci fai qui?', 'Posso sedermi?', 'Giornata bella vero?', 'Aspetti qualcuno?', 'Vieni spesso qui?', 'Nome?', 'Piacere mio', 'Ti disturbo?', 'Che coincidenza!', 'Bella citt√†', 'Consigli sul posto?'], 
                responses: ['Sono della zona', 'S√¨, lavoro qui', 'Piacere di conoscerti', 'Vivo poco distante', 'Passeggiavo', 'Certo, prego', 'Bellissima', 'No, da solo/a', 'Di tanto in tanto', 'Mi chiamo...', 'Piacere', 'No, tranquillo', 'Davvero!', 'Adoro Eldoria', 'Conosco posti interessanti'] 
            },
            acquaintance: { 
                questions: ['Come va la famiglia?', 'Progetti per il weekend?', 'Tutto bene ultimamente?', 'Lavoro come va?', 'Visto l\'ultima serie?', 'Vacanze programmate?', 'Sport praticati?', 'Letture interessanti?', 'Ristoranti nuovi?', 'Eventi in citt√†?', 'Gita fuori porta?', 'Hobby coltivati?', 'Nuovi progetti?', 'Salute ok?', 'Tutto tranquillo?'], 
                responses: ['Tutto bene, grazie', 'Niente di speciale', 'La solita routine', 'Famiglia in salute', 'Relax totale', 'Qualche problemino', 'Avanti tutta', 'Ancora non iniziata', 'Niente per ora', 'Un po\' di palestra', 'Sto leggendo...', 'Da provare', 'Forse uno', 'Weekend al mare', 'Sempre attivo'] 
            },
            friend: { 
                questions: ['Posso confidarmi con te?', 'Usciamo insieme?', 'Hai bisogno di aiuto?', 'Ricordi quando...?', 'Posso fidarmi?', 'Cosa ne pensi di...?', 'Mi daresti un consiglio?', 'Ci vediamo stasera?', 'Pizza insieme?', 'Film al cinema?', 'Giro in centro?', 'Chiamami se serve', 'Problemi recenti?', 'Posso contare su di te?', 'Amicizia vera?', 'Ti va una birra?', 'Partita insieme?', 'Confidenza totale?', 'Sei libero domani?', 'Chiacchierata seria?'], 
                responses: ['Certo, dimmi tutto', 'Sarebbe bello!', 'Sempre disponibile per te', 'Come no!', 'Assolutamente', 'Penso che...', 'Ecco cosa farei', 'Ci sono!', 'Volentieri', 'Ok, quando?', 'D\'accordo', 'Grazie, lo stesso', 'Qualcosa c\'√®', 'Sempre', 'Certo che s√¨', 'Ottima idea', 'Organizziamo', 'Puoi parlare', 'Dimmi l\'ora', 'Quando vuoi'] 
            },
            close_friend: { 
                questions: ['Cosa faresti al posto mio?', 'Ti fidi di me?', 'Siamo veri amici', 'Segreti tra noi?', 'Sempre presente?', 'Amicizia per sempre?', 'Fratello/sorella d\'anima?', 'Conosci i miei difetti?', 'Mi accetti cos√¨?', 'Aiuto nei momenti bui?', 'Condividere tutto?', 'Viaggio insieme?', 'Supporto incondizionato?', 'Onest√† brutale?', 'Legame speciale?', 'Inseparabili?', 'Coppia di amici?', 'Testimone al matrimonio?', 'Connessione profonda?', 'Amicizia rara?'], 
                responses: ['Io farei cos√¨...', 'Completamente', 'Sei importante per me', 'Condivisi e custoditi', 'Nei momenti importanti', 'Per sempre', 'Assolutamente', 'E li apprezzo', 'Proprio come sei', 'Sempre al tuo fianco', 'Ogni cosa', 'Sarebbe bellissimo', 'Senza condizioni', 'Sempre sincero', 'Unico e prezioso', 'Come una cosa sola', 'La migliore', 'Onorato', 'Profondissima', 'Trovare amici cos√¨ √® raro'] 
            },
            romantic_interest: {
                questions: ['Ti piaccio?', 'Usciamo a cena?', 'Sei single?', 'Posso baciarti?', 'Cosa provi?', 'Relazione seria?', 'Mi pensi?', 'Sono speciale?', 'Futuro insieme?', 'Ti amo', 'Sentimenti ricambiati?', 'Esclusivit√†?', 'Presentami ai tuoi?', 'Convivenza?', 'Per sempre?'],
                responses: ['Mi piaci molto', 'Con piacere', 'S√¨, perch√©?', 'Magari...', 'Qualcosa di forte', 'Ci sto pensando', 'Spesso', 'Molto speciale', 'Chi lo sa...', 'Anche tu', 'S√¨, tantissimo', 'Solo tu', 'Presto', 'Step importante', 'Vediamo dove ci porta']
            },
            enemy: {
                questions: ['Problema con me?', 'Cosa ho fatto?', 'Possiamo chiarire?', 'Perch√© l\'astio?', 'Guerra aperta?', 'Tregua possibile?', 'Scuse?', 'Dimenticare?', 'Dare una chance?', 'Mai amici?'],
                responses: ['Molti problemi', 'Sai benissimo cosa', 'Non credo', 'Ragioni valide', 'Se necessario', 'Difficile', 'Non bastano', 'Impossibile', 'Gi√† provato', 'Mai']
            }
        },
        generateContextualQuestions: function(npc, playerStats, playerSkills) {
            const questions = [];
            
            // Add base questions
            questions.push(...this.topics.greeting.questions);
            questions.push(...this.topics.work.questions);
            questions.push(...this.topics.personal.questions);
            
            // Add skill-based questions
            Object.keys(playerSkills).forEach(skill => {
                const skillLevel = playerSkills[skill];
                const skillDialogue = this.skillBasedDialogue[skill];
                if (skillDialogue) {
                    Object.keys(skillDialogue).forEach(threshold => {
                        if (skillLevel >= parseInt(threshold)) {
                            questions.push(...skillDialogue[threshold].questions);
                        }
                    });
                }
            });
            
            // Add job-based questions
            if (this.jobBasedDialogue[game.player.job]) {
                questions.push(...this.jobBasedDialogue[game.player.job].questions);
            }
            
            // Add relationship-based questions
            const relationLevel = npc.relation < 20 ? 'stranger' : npc.relation < 40 ? 'acquaintance' : npc.relation < 70 ? 'friend' : 'close_friend';
            if (this.relationshipDialogue[relationLevel]) {
                questions.push(...this.relationshipDialogue[relationLevel].questions);
            }

            // Add time-based questions
            const hour = game.time.hour;
            if (hour >= 6 && hour < 12) {
                questions.push('Buongiorno! Dormito bene?', 'Gi√† sveglio?', 'Caff√® fatto?', 'Programmi mattinieri?');
            } else if (hour >= 12 && hour < 18) {
                questions.push('Come va la giornata?', 'Pranzo buono?', 'Pausa caff√®?', 'Impegni pomeridiani?');
            } else if (hour >= 18 && hour < 23) {
                questions.push('Serata libera?', 'Cena fuori?', 'Stanchi oggi?', 'Relax meritato?');
            } else {
                questions.push('Ancora sveglio?', 'Nottambulo?', 'Domani sveglia presto?', 'Non riesci a dormire?');
            }

            // Add location-based questions if available
            if (game.currentLocation) {
                if (game.currentLocation.includes('bar') || game.currentLocation.includes('Bar')) {
                    questions.push('Ti piace questo locale?', 'Vieni spesso qui?', 'Buon ambiente vero?', 'Consigliato da qualcuno?');
                } else if (game.currentLocation.includes('palestra') || game.currentLocation.includes('Gym')) {
                    questions.push('Allenamento duro?', 'Quanto sollevi?', 'Cardio o pesi?', 'Personal trainer?');
                } else if (game.currentLocation.includes('park') || game.currentLocation.includes('Parco')) {
                    questions.push('Bella giornata per stare fuori', 'Passeggiata rilassante?', 'Natura rigenerante vero?', 'Jogging?');
                } else if (game.currentLocation.includes('biblioteca') || game.currentLocation.includes('Library')) {
                    questions.push('Studiando?', 'Che libro?', 'Ricerca o svago?', 'Posto tranquillo vero?');
                }
            }

            // Add mood-based questions
            if (game.player.morale < 30) {
                questions.push('Tutto ok?', 'Sembri gi√π', 'Vuoi parlarne?', 'Posso aiutare?');
            } else if (game.player.morale > 70) {
                questions.push('Di buon umore!', 'Giornata positiva?', 'Bella energia!', 'Successo qualcosa di bello?');
            }

            // Add money-based questions
            if (game.player.cash + game.player.bankDeposit > 10000) {
                questions.push('Affari che vanno bene?', 'Investimenti giusti?', 'Obiettivi finanziari?', 'Risparmi o spendi?');
            } else if (game.player.cash + game.player.bankDeposit < 100) {
                questions.push('Periodo difficile?', 'Serve una mano?', 'Soldi stretti?', 'Cerca lavoro?');
            }
            
            // Remove duplicates and shuffle
            const uniqueQuestions = [...new Set(questions)];
            return uniqueQuestions.sort(() => Math.random() - 0.5).slice(0, 8);
        }
    };

    // ---------- UTILITY ----------
    const $ = id => document.getElementById(id);
    const clamp = (val, min = 0, max = 100) => Math.max(min, Math.min(max, val));
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const formatMoney = (val) => `‚Ç¨${val.toFixed(0)}`;

    // ---------- MONEY HELPERS ----------
    // Pay from cash first, then bank if needed
    function payMoney(amount) {
        const totalMoney = game.player.cash + game.player.bankDeposit;
        if (totalMoney < amount) return false;
        
        if (game.player.cash >= amount) {
            game.player.cash -= amount;
        } else {
            const remaining = amount - game.player.cash;
            game.player.cash = 0;
            game.player.bankDeposit -= remaining;
        }
        return true;
    }

    // Earn money (goes to cash by default)
    function earnMoney(amount, toBank = false) {
        if (toBank) {
            game.player.bankDeposit += amount;
        } else {
            game.player.cash += amount;
        }
    }

    // Check if can afford
    function canAfford(amount) {
        return (game.player.cash + game.player.bankDeposit) >= amount;
    }

    // ---------- GAME STATE ----------
    let game = {
        player: null,
        time: { day: 1, hour: 8 },
        npcs: [],
        quests: [],
        jobListings: [],
        events: [],
        currentTab: 'home',
        settings: { autoSave: true },
        currentChatNpc: null,
        chatHistory: {},
        housing: null,
        inventory: { food: [] },
        lastRentPayment: 1,
        lastTaxPayment: 1,
        workData: {
            currentJob: null,
            todayWorked: false,
            tasksCompleted: 0,
            performance: 100,
            manager: null,
            workEvents: [],
            careerPath: null, // Tracks current career (e.g., 'tech', 'hospitality', 'business')
            careerLevel: 0, // Level within the career path (0-5)
            daysWorked: 0,
            managerRelation: 50, // 0-100, affects promotions and job security
            warnings: 0, // Accumulate warnings for poor performance
            promotionProgress: 0, // Progress towards next promotion (0-100)
            lastPerformanceReview: 0, // Day of last review
            workLocation: null, // { neighborhood, coordinates, address }
            workPlaceName: null // Nome specifico del luogo di lavoro
        },
        relationships: {
            romantic: null,
            spouse: null,
            children: [],
            dating: []
        },
        investments: {
            stocks: [],
            savings: 0,
            properties: []
        },
        crime: {
            record: [],
            wanted: 0,
            reputation: 'pulito'
        },
        cityMap: {
            currentLocation: null,
            ownedBusinesses: [],
            discoveredLocations: [],
            transportPass: null
        },
        vehicles: {
            owned: [], // Array of owned vehicles
            active: null // Currently selected vehicle for travel
        }
    };

    // ---------- DAYS OF THE WEEK ----------
    const DAYS_OF_WEEK = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];
    
    // ---------- VEHICLES ----------
    const VEHICLES = {
        monopattino: {
            name: 'üõ¥ Monopattino Elettrico',
            cost: 200,
            speedMultiplier: 0.7, // 30% faster than walking
            energyCost: 2, // per hour of travel
            maintenanceCost: 5, // per month
            description: 'Economico e pratico per brevi distanze',
            emoji: 'üõ¥'
        },
        bici: {
            name: 'üö≤ Bicicletta',
            cost: 150,
            speedMultiplier: 0.6, // 40% faster than walking
            energyCost: 5, // per hour of travel (physical effort)
            maintenanceCost: 10, // per month
            description: 'Salutare ma faticosa',
            emoji: 'üö≤'
        },
        moto: {
            name: 'üèçÔ∏è Motocicletta',
            cost: 2500,
            speedMultiplier: 0.4, // 60% faster than walking
            energyCost: 1, // per hour of travel
            fuelCost: 3, // per hour of travel
            maintenanceCost: 50, // per month
            description: 'Veloce e agile nel traffico',
            emoji: 'üèçÔ∏è'
        },
        auto: {
            name: 'üöó Automobile',
            cost: 5000,
            speedMultiplier: 0.3, // 70% faster than walking
            energyCost: 0.5, // per hour of travel (very comfortable)
            fuelCost: 5, // per hour of travel
            maintenanceCost: 100, // per month
            description: 'Comoda ma costosa',
            emoji: 'üöó'
        },
        auto_lusso: {
            name: 'üèéÔ∏è Auto di Lusso',
            cost: 15000,
            speedMultiplier: 0.2, // 80% faster than walking
            energyCost: 0, // per hour of travel (extremely comfortable)
            fuelCost: 8, // per hour of travel
            maintenanceCost: 200, // per month
            description: 'Veloce, comoda e prestigiosa',
            emoji: 'üèéÔ∏è'
        }
    };

    // ---------- NEIGHBORHOODS & HOUSING ----------
    const NEIGHBORHOODS = {
        periferia: {
            name: 'Periferia',
            rent: 300,
            quality: 50,
            services: 40,
            safety: 60,
            foodMultiplier: 0.8,
            description: 'Zona economica ma distante dal centro',
            population: 15000,
            demographics: { young: 35, adults: 45, elderly: 20 },
            interests: ['sport', 'famiglia', 'risparmio'],
            avgIncome: 25000,
            businessOpportunities: ['minimarket', 'pizzeria', 'lavanderia', 'bar', 'panificio', 'fruttivendolo', 'edicola', 'tabaccheria', 'parrucchiere', 'autolavaggio', 'fast_food', 'pet_shop'],
            streets: ['Via Roma', 'Via Mazzini', 'Via Garibaldi', 'Corso Italia'],
            busStops: ['Fermata Periferia Nord', 'Fermata Periferia Centro', 'Fermata Periferia Sud'],
            landmarks: ['Centro Sportivo Comunale', 'Scuola Elementare', 'Parco Giochi'],
            travelTime: 2 // hours to reach this neighborhood from a central point
        },
        quartiere_operaio: {
            name: 'Quartiere Operaio',
            rent: 450,
            quality: 60,
            services: 60,
            safety: 70,
            foodMultiplier: 0.9,
            description: 'Zona vivibile con buoni servizi',
            population: 22000,
            demographics: { young: 30, adults: 50, elderly: 20 },
            interests: ['lavoro', 'sociale', 'sport'],
            avgIncome: 32000,
            businessOpportunities: ['bar', 'ferramenta', 'palestra', 'edicola', 'trattoria', 'macelleria', 'elettronica', 'cartoleria', 'barbiere', 'farmacia', 'autofficina', 'gommista', 'pub', 'negozio_sport'],
            streets: ['Via Operai', 'Via Industria', 'Viale Lavoro', 'Via Sindacato', 'Piazza del Popolo'],
            busStops: ['Fermata Fabbrica', 'Fermata Mercato', 'Fermata Municipio'],
            landmarks: ['Centro Operaio', 'Mercato Rionale', 'Chiesa di San Giuseppe', 'Biblioteca Comunale'],
            travelTime: 1.5 // hours
        },
        centro_storico: {
            name: 'Centro Storico',
            rent: 700,
            quality: 80,
            services: 85,
            safety: 80,
            foodMultiplier: 1.1,
            description: 'Cuore della citt√†, vivace e costoso',
            population: 18000,
            demographics: { young: 25, adults: 55, elderly: 20 },
            interests: ['cultura', 'shopping', 'intrattenimento', 'gourmet'],
            avgIncome: 55000,
            businessOpportunities: ['boutique', 'ristorante_fine', 'galleria_arte', 'wine_bar', 'concept_store', 'gioielleria', 'libreria', 'profumeria', 'ottica', 'enoteca', 'gelateria', 'sushi_bar', 'fumetteria', 'orologeria', 'borse', 'accessori', 'teatro', 'cinema', 'museo_privato'],
            streets: ['Via del Corso', 'Piazza Duomo', 'Via della Repubblica', 'Corso Vittorio Emanuele', 'Via dei Mercanti', 'Piazza della Libert√†'],
            busStops: ['Fermata Duomo', 'Fermata Teatro', 'Fermata Stazione Centrale'],
            landmarks: ['Duomo', 'Teatro Comunale', 'Palazzo Storico', 'Piazza Principale', 'Torre Civica', 'Museo Civico'],
            travelTime: 0.5 // hours
        },
        zona_residenziale: {
            name: 'Zona Residenziale',
            rent: 600,
            quality: 75,
            services: 80,
            safety: 90,
            foodMultiplier: 1.0,
            description: 'Tranquilla e sicura, perfetta per famiglie',
            population: 12000,
            demographics: { young: 40, adults: 45, elderly: 15 },
            interests: ['famiglia', 'educazione', 'benessere', 'natura'],
            avgIncome: 48000,
            businessOpportunities: ['asilo', 'centro_yoga', 'pet_shop', 'pasticceria', 'libreria', 'farmacia', 'centro_estetico', 'scuola_lingue', 'scuola_musica', 'parrucchiere', 'fioraio', 'veterinario', 'supermercato', 'panificio', 'abbigliamento', 'negozio_scarpe', 'arredamento', 'vivaio'],
            streets: ['Viale dei Giardini', 'Via delle Rose', 'Via dei Tigli', 'Corso dei Platani', 'Via Quiete'],
            busStops: ['Fermata Scuole', 'Fermata Parco', 'Fermata Residenziale Nord'],
            landmarks: ['Parco delle Famiglie', 'Scuola Internazionale', 'Centro Medico', 'Piscina Comunale', 'Campo da Tennis'],
            travelTime: 1 // hours
        },
        quartiere_lusso: {
            name: 'Quartiere Luxury',
            rent: 1200,
            quality: 95,
            services: 95,
            safety: 95,
            foodMultiplier: 1.3,
            description: 'Il meglio della citt√†, solo per facoltosi',
            population: 5000,
            demographics: { young: 15, adults: 70, elderly: 15 },
            interests: ['lusso', 'business', 'arte', 'fitness_premium', 'gourmet'],
            avgIncome: 120000,
            businessOpportunities: ['gioielleria', 'spa_luxury', 'ristorante_stellato', 'boutique_designer', 'club_privato', 'orologeria', 'concessionaria', 'galleria', 'palestra_premium', 'wine_bar', 'pellicce', 'antiquariato', 'banca', 'studio_legale', 'centro_estetico', 'nightclub', 'cinema', 'agenzia_immobiliare'],
            streets: ['Boulevard dei Vip', 'Via Eleganza', 'Piazza Prestigio', 'Viale delle Ville'],
            busStops: ['Fermata Luxury Shopping', 'Fermata Country Club'],
            landmarks: ['Club Esclusivo', 'Golf Club', 'Spa di Lusso', 'Galleria d\'Arte Contemporanea', 'Centro Congressi'],
            travelTime: 0.75 // hours
        }
    };

    // ---------- CITY LOCATIONS DATABASE ----------
    const CITY_LOCATIONS = {
        periferia: [
            { id: 'loc_p1', type: 'shop', name: 'Minimarket Express', business: 'supermercato', street: 'Via Roma 15', status: 'occupied', income: 200, x: 20, y: 30 },
            { id: 'loc_p2', type: 'shop', name: 'Pizzeria Da Mario', business: 'pizzeria', street: 'Via Mazzini 8', status: 'occupied', income: 250, x: 40, y: 60 },
            { id: 'loc_p3', type: 'empty', name: 'Locale Commerciale', business: null, street: 'Via Garibaldi 42', status: 'available', cost: 30000, size: 'piccolo', x: 60, y: 20 },
            { id: 'loc_p4', type: 'empty', name: 'Spazio Commerciale', business: null, street: 'Corso Italia 103', status: 'available', cost: 45000, size: 'medio', x: 80, y: 70 },
            { id: 'loc_p5', type: 'landmark', name: 'Centro Sportivo Comunale', business: 'sport', street: 'Via Roma 150', status: 'public', x: 15, y: 80 },
            { id: 'loc_p10', type: 'shop', name: 'Banca di Credito', business: 'banca', street: 'Corso Italia 45', status: 'occupied', income: 0, x: 65, y: 35 },
            { id: 'loc_p6', type: 'residence', name: 'Condominio Vista Parco', street: 'Via Mazzini 25', residents: 45, rent: 300, buyPrice: 45000, x: 50, y: 40, 
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Giuseppe Marini', age: 58, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_p7', type: 'residence', name: 'Palazzina Economica', street: 'Via Garibaldi 12', residents: 30, rent: 250, buyPrice: 35000, x: 25, y: 55,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Maria Rossi', age: 45, personality: 'strict', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_p8', type: 'residence', name: 'Case Popolari', street: 'Corso Italia 50', residents: 80, rent: 200, buyPrice: 28000, x: 70, y: 45,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Antonio Bianchi', age: 52, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_p9', type: 'residence', name: 'Monolocali Via Roma', street: 'Via Roma 88', residents: 20, rent: 220, buyPrice: 30000, x: 35, y: 25,
              housingLevel: 'monolocale', bonuses: { energy: 5, morale: 3, hygiene: 0, health: 0 },
              landlord: { name: 'Elena Conti', age: 38, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } }
        ],
        quartiere_operaio: [
            { id: 'loc_o1', type: 'shop', name: 'Bar Centrale', business: 'bar', street: 'Piazza del Popolo 1', status: 'occupied', income: 300, x: 30, y: 20 },
            { id: 'loc_o2', type: 'shop', name: 'Ferramenta Bianchi', business: 'ferramenta', street: 'Via Industria 12', status: 'occupied', income: 180, x: 50, y: 50 },
            { id: 'loc_o3', type: 'shop', name: 'Palestra FitLife', business: 'palestra', street: 'Via Operai 55', status: 'occupied', income: 400, x: 70, y: 30 },
            { id: 'loc_o4', type: 'empty', name: 'Capannone', business: null, street: 'Via Industria 88', status: 'available', cost: 80000, size: 'grande', x: 20, y: 70 },
            { id: 'loc_o5', type: 'empty', name: 'Negozio d\'Angolo', business: null, street: 'Via Sindacato 7', status: 'available', cost: 35000, size: 'piccolo', x: 80, y: 60 },
            { id: 'loc_o6', type: 'landmark', name: 'Mercato Rionale', business: 'mercato', street: 'Piazza del Popolo', status: 'public', x: 40, y: 80 },
            { id: 'loc_o11', type: 'shop', name: 'Banca del Popolo', business: 'banca', street: 'Via Sindacato 20', status: 'occupied', income: 0, x: 55, y: 55 },
            { id: 'loc_o7', type: 'residence', name: 'Palazzi Popolari', street: 'Via Operai 20-30', residents: 120, rent: 400, buyPrice: 55000, x: 60, y: 40,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Franco Lombardi', age: 60, personality: 'strict', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_o8', type: 'residence', name: 'Condominio del Sindacato', street: 'Via Sindacato 15', residents: 65, rent: 380, buyPrice: 52000, x: 25, y: 50,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Roberto Esposito', age: 55, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_o9', type: 'residence', name: 'Residenza Operaia', street: 'Via Industria 40', residents: 50, rent: 350, buyPrice: 48000, x: 75, y: 65,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Lucia Ferretti', age: 48, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_o10', type: 'residence', name: 'Appartamenti Piazza Popolo', street: 'Piazza del Popolo 8', residents: 35, rent: 420, buyPrice: 58000, x: 45, y: 35,
              housingLevel: 'bilocale', bonuses: { energy: 8, morale: 5, hygiene: 5, health: 0 },
              landlord: { name: 'Stefano Romano', age: 42, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ],
        centro_storico: [
            { id: 'loc_c1', type: 'shop', name: 'Boutique Eleganza', business: 'boutique', street: 'Via del Corso 45', status: 'occupied', income: 800, x: 25, y: 25 },
            { id: 'loc_c2', type: 'shop', name: 'Ristorante La Tavola', business: 'ristorante', street: 'Piazza Duomo 12', status: 'occupied', income: 900, x: 50, y: 40 },
            { id: 'loc_c3', type: 'shop', name: 'Galleria Arte Moderna', business: 'galleria', street: 'Via dei Mercanti 8', status: 'occupied', income: 500, x: 70, y: 60 },
            { id: 'loc_c4', type: 'empty', name: 'Palazzo Storico - Piano Terra', business: null, street: 'Corso Vittorio Emanuele 100', status: 'available', cost: 250000, size: 'grande', x: 15, y: 70 },
            { id: 'loc_c5', type: 'empty', name: 'Locale Centrale', business: null, street: 'Piazza della Libert√† 5', status: 'available', cost: 180000, size: 'medio', x: 85, y: 30 },
            { id: 'loc_c6', type: 'landmark', name: 'Duomo', business: 'chiesa', street: 'Piazza Duomo', status: 'historic', x: 40, y: 80 },
            { id: 'loc_c7', type: 'landmark', name: 'Teatro Comunale', business: 'teatro', street: 'Via della Repubblica 1', status: 'public', x: 60, y: 10 },
            { id: 'loc_c12', type: 'shop', name: 'Banca Centrale', business: 'banca', street: 'Piazza della Repubblica 8', status: 'occupied', income: 0, x: 35, y: 15 },
            { id: 'loc_c8', type: 'residence', name: 'Appartamenti Centro', street: 'Via del Corso 10-50', residents: 75, rent: 700, buyPrice: 120000, x: 30, y: 55,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Andrea Fontana', age: 50, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_c9', type: 'residence', name: 'Loft Via Repubblica', street: 'Via della Repubblica 22', residents: 40, rent: 750, buyPrice: 135000, x: 65, y: 45,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Silvia Moretti', age: 44, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_c10', type: 'residence', name: 'Attico Piazza Libert√†', street: 'Piazza della Libert√† 1', residents: 20, rent: 900, buyPrice: 180000, x: 80, y: 55,
              housingLevel: 'attico', bonuses: { energy: 15, morale: 12, hygiene: 10, health: 5, stressReduction: 2 },
              landlord: { name: 'Marco De Luca', age: 52, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_c11', type: 'residence', name: 'Palazzo dei Mercanti', street: 'Via dei Mercanti 15', residents: 55, rent: 680, buyPrice: 115000, x: 45, y: 65,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Chiara Colombo', age: 47, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } }
        ],
        zona_residenziale: [
            { id: 'loc_r1', type: 'shop', name: 'Pasticceria Dolce Vita', business: 'pasticceria', street: 'Viale dei Giardini 22', status: 'occupied', income: 350, x: 20, y: 40 },
            { id: 'loc_r2', type: 'shop', name: 'Libreria Mondadori', business: 'libreria', street: 'Via delle Rose 15', status: 'occupied', income: 280, x: 50, y: 20 },
            { id: 'loc_r3', type: 'shop', name: 'Pet Paradise', business: 'pet_shop', street: 'Via dei Tigli 8', status: 'occupied', income: 220, x: 80, y: 50 },
            { id: 'loc_r4', type: 'empty', name: 'Locale Residenziale', business: null, street: 'Corso dei Platani 44', status: 'available', cost: 90000, size: 'medio', x: 30, y: 70 },
            { id: 'loc_r5', type: 'empty', name: 'Spazio Wellness', business: null, street: 'Via Quiete 12', status: 'available', cost: 120000, size: 'grande', x: 70, y: 80 },
            { id: 'loc_r6', type: 'landmark', name: 'Parco delle Famiglie', business: 'parco', street: 'Via Quiete', status: 'public', x: 10, y: 10 },
            { id: 'loc_r11', type: 'shop', name: 'Banca delle Famiglie', business: 'banca', street: 'Corso dei Platani 10', status: 'occupied', income: 0, x: 45, y: 50 },
            { id: 'loc_r7', type: 'residence', name: 'Villette a Schiera', street: 'Viale dei Giardini', residents: 60, rent: 850, buyPrice: 160000, x: 60, y: 60,
              housingLevel: 'villa', bonuses: { energy: 15, morale: 12, hygiene: 10, health: 5, stressReduction: 2 },
              landlord: { name: 'Paolo Santoro', age: 56, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r8', type: 'residence', name: 'Condominio delle Rose', street: 'Via delle Rose 30', residents: 45, rent: 800, buyPrice: 145000, x: 35, y: 35,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Laura Ricci', age: 49, personality: 'friendly', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r9', type: 'residence', name: 'Residence Platani', street: 'Corso dei Platani 20', residents: 50, rent: 820, buyPrice: 150000, x: 55, y: 75,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Davide Greco', age: 51, personality: 'neutral', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_r10', type: 'residence', name: 'Appartamenti Via Quiete', street: 'Via Quiete 45', residents: 40, rent: 780, buyPrice: 140000, x: 75, y: 25,
              housingLevel: 'trilocale', bonuses: { energy: 12, morale: 8, hygiene: 8, health: 2 },
              landlord: { name: 'Valentina Gallo', age: 43, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ],
        quartiere_lusso: [
            { id: 'loc_l1', type: 'shop', name: 'Gioielleria Cartier', business: 'gioielleria', street: 'Boulevard dei Vip 5', status: 'occupied', income: 2000, x: 20, y: 20 },
            { id: 'loc_l2', type: 'shop', name: 'Ristorante Stella Michelin', business: 'ristorante_stellato', street: 'Via Eleganza 1', status: 'occupied', income: 1800, x: 50, y: 40 },
            { id: 'loc_l3', type: 'shop', name: 'Spa Serenit√†', business: 'spa', street: 'Piazza Prestigio 3', status: 'occupied', income: 1500, x: 80, y: 60 },
            { id: 'loc_l4', type: 'empty', name: 'Boutique Luxury', business: null, street: 'Boulevard dei Vip 18', status: 'available', cost: 500000, size: 'grande', x: 30, y: 70 },
            { id: 'loc_l5', type: 'landmark', name: 'Golf Club Exclusive', business: 'golf', street: 'Viale delle Ville', status: 'private', x: 70, y: 10 },
            { id: 'loc_l6', type: 'residence', name: 'Ville di Lusso', street: 'Viale delle Ville', residents: 25, rent: 2000, buyPrice: 500000, x: 40, y: 80,
              housingLevel: 'villa_lusso', bonuses: { energy: 20, morale: 15, hygiene: 12, health: 8, stressReduction: 5 },
              landlord: { name: 'Alessandro Vitale', age: 58, personality: 'arrogant', negotiable: false, acceptsRent: true, acceptsSale: false } },
            { id: 'loc_l7', type: 'residence', name: 'Attico Panoramico', street: 'Boulevard dei Vip 10', residents: 15, rent: 1800, buyPrice: 450000, x: 30, y: 45,
              housingLevel: 'attico_lusso', bonuses: { energy: 18, morale: 14, hygiene: 11, health: 7, stressReduction: 4 },
              landlord: { name: 'Isabella Monti', age: 53, personality: 'selective', negotiable: false, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_l8', type: 'residence', name: 'Penthouse Prestigio', street: 'Piazza Prestigio 1', residents: 12, rent: 2200, buyPrice: 550000, x: 65, y: 75,
              housingLevel: 'penthouse', bonuses: { energy: 22, morale: 18, hygiene: 14, health: 10, stressReduction: 6 },
              landlord: { name: 'Giovanni Ferrari', age: 62, personality: 'professional', negotiable: true, acceptsRent: true, acceptsSale: true } },
            { id: 'loc_l9', type: 'residence', name: 'Residenza Eleganza', street: 'Via Eleganza 25', residents: 20, rent: 1700, buyPrice: 420000, x: 55, y: 30,
              housingLevel: 'attico_lusso', bonuses: { energy: 18, morale: 14, hygiene: 11, health: 7, stressReduction: 4 },
              landlord: { name: 'Federica Leone', age: 46, personality: 'greedy', negotiable: false, acceptsRent: true, acceptsSale: true } }
        ]
    };

    // ---------- TRANSPORT SYSTEM ----------
    const BUS_ROUTES = {
        linea_1: {
            name: 'Linea 1 - Centro-Periferia',
            stops: ['Duomo', 'Teatro', 'Mercato', 'Periferia Centro', 'Periferia Sud'],
            cost: 1.5,
            time: 30
        },
        linea_2: {
            name: 'Linea 2 - Circolare',
            stops: ['Stazione Centrale', 'Quartiere Operaio', 'Zona Residenziale', 'Luxury Shopping', 'Centro'],
            cost: 1.5,
            time: 45
        },
        linea_3: {
            name: 'Linea 3 - Espressa',
            stops: ['Periferia Nord', 'Fabbrica', 'Municipio', 'Duomo', 'Stazione Centrale'],
            cost: 2,
            time: 20
        }
    };

    // ---------- BUSINESS TYPES ----------
    const BUSINESS_TYPES = {
        // Alimentari & Ristorazione
        minimarket: { name: 'Minimarket', cost: 35000, income: [150, 300], employees: 2, category: 'alimentari' },
        supermercato: { name: 'Supermercato', cost: 120000, income: [800, 1500], employees: 8, category: 'alimentari' },
        macelleria: { name: 'Macelleria', cost: 45000, income: [200, 400], employees: 2, category: 'alimentari' },
        panificio: { name: 'Panificio', cost: 55000, income: [250, 500], employees: 3, category: 'alimentari' },
        fruttivendolo: { name: 'Fruttivendolo', cost: 30000, income: [150, 350], employees: 2, category: 'alimentari' },
        enoteca: { name: 'Enoteca', cost: 60000, income: [300, 600], employees: 2, category: 'alimentari' },
        
        pizzeria: { name: 'Pizzeria', cost: 50000, income: [200, 400], employees: 3, category: 'ristorazione' },
        ristorante: { name: 'Ristorante', cost: 100000, income: [600, 1200], employees: 5, category: 'ristorazione' },
        ristorante_stellato: { name: 'Ristorante Stellato', cost: 300000, income: [2000, 4000], employees: 10, category: 'ristorazione' },
        trattoria: { name: 'Trattoria', cost: 70000, income: [350, 700], employees: 4, category: 'ristorazione' },
        sushi_bar: { name: 'Sushi Bar', cost: 90000, income: [500, 1000], employees: 4, category: 'ristorazione' },
        bar: { name: 'Bar/Caff√®', cost: 45000, income: [250, 450], employees: 2, category: 'ristorazione' },
        gelateria: { name: 'Gelateria', cost: 40000, income: [200, 450], employees: 2, category: 'ristorazione' },
        pasticceria: { name: 'Pasticceria', cost: 70000, income: [300, 600], employees: 3, category: 'ristorazione' },
        fast_food: { name: 'Fast Food', cost: 80000, income: [400, 800], employees: 5, category: 'ristorazione' },
        pub: { name: 'Pub/Birreria', cost: 65000, income: [350, 700], employees: 3, category: 'ristorazione' },
        wine_bar: { name: 'Wine Bar', cost: 75000, income: [400, 800], employees: 3, category: 'ristorazione' },
        
        // Commercio & Servizi
        ferramenta: { name: 'Ferramenta', cost: 40000, income: [150, 280], employees: 1, category: 'commercio' },
        elettronica: { name: 'Negozio Elettronica', cost: 90000, income: [500, 1000], employees: 3, category: 'commercio' },
        cartoleria: { name: 'Cartoleria', cost: 30000, income: [120, 250], employees: 1, category: 'commercio' },
        farmacia: { name: 'Farmacia', cost: 150000, income: [800, 1500], employees: 3, category: 'commercio' },
        ottica: { name: 'Ottica', cost: 70000, income: [350, 700], employees: 2, category: 'commercio' },
        tabaccheria: { name: 'Tabaccheria', cost: 40000, income: [200, 400], employees: 1, category: 'commercio' },
        edicola: { name: 'Edicola', cost: 25000, income: [100, 200], employees: 1, category: 'commercio' },
        fioraio: { name: 'Fioraio', cost: 35000, income: [150, 350], employees: 2, category: 'commercio' },
        telefonia: { name: 'Negozio Telefonia', cost: 60000, income: [300, 600], employees: 2, category: 'commercio' },
        profumeria: { name: 'Profumeria', cost: 55000, income: [280, 550], employees: 2, category: 'commercio' },
        
        // Moda & Accessori
        boutique: { name: 'Boutique Moda', cost: 120000, income: [500, 1000], employees: 3, category: 'moda' },
        boutique_designer: { name: 'Boutique Designer', cost: 250000, income: [1500, 3000], employees: 4, category: 'moda' },
        negozio_scarpe: { name: 'Negozio Scarpe', cost: 70000, income: [350, 700], employees: 2, category: 'moda' },
        abbigliamento: { name: 'Abbigliamento', cost: 80000, income: [400, 800], employees: 3, category: 'moda' },
        intimo: { name: 'Negozio Intimo', cost: 50000, income: [250, 500], employees: 2, category: 'moda' },
        accessori: { name: 'Accessori Moda', cost: 45000, income: [220, 450], employees: 2, category: 'moda' },
        borse: { name: 'Pelletteria', cost: 85000, income: [420, 850], employees: 2, category: 'moda' },
        occhiali: { name: 'Occhiali da Sole', cost: 55000, income: [280, 560], employees: 2, category: 'moda' },
        
        // Sport & Fitness
        palestra: { name: 'Palestra', cost: 80000, income: [300, 600], employees: 4, category: 'sport' },
        palestra_premium: { name: 'Palestra Premium', cost: 200000, income: [1000, 2000], employees: 8, category: 'sport' },
        negozio_sport: { name: 'Negozio Sportivo', cost: 70000, income: [350, 700], employees: 3, category: 'sport' },
        piscina: { name: 'Centro Acquatico', cost: 250000, income: [1200, 2400], employees: 10, category: 'sport' },
        yoga_studio: { name: 'Studio Yoga', cost: 60000, income: [300, 600], employees: 3, category: 'sport' },
        danza_studio: { name: 'Scuola Danza', cost: 70000, income: [350, 700], employees: 4, category: 'sport' },
        
        // Cultura & Intrattenimento
        libreria: { name: 'Libreria', cost: 60000, income: [200, 400], employees: 2, category: 'cultura' },
        fumetteria: { name: 'Fumetteria', cost: 45000, income: [180, 360], employees: 2, category: 'cultura' },
        galleria: { name: 'Galleria d\'Arte', cost: 150000, income: [500, 1000], employees: 3, category: 'cultura' },
        museo_privato: { name: 'Museo Privato', cost: 300000, income: [800, 1600], employees: 5, category: 'cultura' },
        cinema: { name: 'Cinema', cost: 400000, income: [2000, 4000], employees: 12, category: 'cultura' },
        teatro: { name: 'Teatro', cost: 500000, income: [2500, 5000], employees: 15, category: 'cultura' },
        sala_giochi: { name: 'Sala Giochi', cost: 90000, income: [450, 900], employees: 3, category: 'cultura' },
        videogiochi: { name: 'Negozio Videogiochi', cost: 60000, income: [300, 600], employees: 2, category: 'cultura' },
        
        // Bellezza & Benessere
        parrucchiere: { name: 'Parrucchiere', cost: 40000, income: [200, 400], employees: 2, category: 'benessere' },
        barbiere: { name: 'Barbiere', cost: 35000, income: [180, 360], employees: 2, category: 'benessere' },
        centro_estetico: { name: 'Centro Estetico', cost: 80000, income: [400, 800], employees: 4, category: 'benessere' },
        spa: { name: 'Centro Benessere', cost: 200000, income: [800, 1600], employees: 6, category: 'benessere' },
        spa_luxury: { name: 'Spa di Lusso', cost: 400000, income: [2000, 4000], employees: 10, category: 'benessere' },
        nail_salon: { name: 'Nail Salon', cost: 35000, income: [170, 350], employees: 2, category: 'benessere' },
        tattoo: { name: 'Studio Tatuaggi', cost: 50000, income: [250, 500], employees: 2, category: 'benessere' },
        massaggi: { name: 'Centro Massaggi', cost: 70000, income: [350, 700], employees: 3, category: 'benessere' },
        
        // Servizi Professionali
        agenzia_immobiliare: { name: 'Agenzia Immobiliare', cost: 80000, income: [600, 1200], employees: 3, category: 'servizi' },
        agenzia_viaggi: { name: 'Agenzia Viaggi', cost: 70000, income: [400, 800], employees: 3, category: 'servizi' },
        studio_legale: { name: 'Studio Legale', cost: 100000, income: [800, 1600], employees: 4, category: 'servizi' },
        studio_commercialista: { name: 'Studio Commercialista', cost: 90000, income: [700, 1400], employees: 3, category: 'servizi' },
        agenzia_assicurazioni: { name: 'Agenzia Assicurazioni', cost: 85000, income: [650, 1300], employees: 3, category: 'servizi' },
        banca: { name: 'Filiale Bancaria', cost: 200000, income: [1500, 3000], employees: 8, category: 'servizi' },
        posta: { name: 'Ufficio Postale', cost: 150000, income: [800, 1600], employees: 5, category: 'servizi' },
        
        // Auto & Trasporti
        autofficina: { name: 'Officina Auto', cost: 100000, income: [500, 1000], employees: 4, category: 'auto' },
        autolavaggio: { name: 'Autolavaggio', cost: 60000, income: [300, 600], employees: 3, category: 'auto' },
        concessionaria: { name: 'Concessionaria Auto', cost: 300000, income: [2000, 4000], employees: 8, category: 'auto' },
        gommista: { name: 'Gommista', cost: 50000, income: [250, 500], employees: 2, category: 'auto' },
        
        // Casa & Arredamento
        arredamento: { name: 'Negozio Arredamento', cost: 150000, income: [700, 1400], employees: 4, category: 'casa' },
        elettrodomestici: { name: 'Elettrodomestici', cost: 100000, income: [500, 1000], employees: 3, category: 'casa' },
        sanitari: { name: 'Sanitari & Bagno', cost: 80000, income: [400, 800], employees: 2, category: 'casa' },
        illuminazione: { name: 'Illuminazione', cost: 60000, income: [300, 600], employees: 2, category: 'casa' },
        tende: { name: 'Tende & Tessuti', cost: 50000, income: [250, 500], employees: 2, category: 'casa' },
        
        // Lusso & Preziosi
        gioielleria: { name: 'Gioielleria', cost: 300000, income: [1500, 3000], employees: 2, category: 'lusso' },
        orologeria: { name: 'Orologeria', cost: 200000, income: [1000, 2000], employees: 2, category: 'lusso' },
        pellicce: { name: 'Pellicce & Lusso', cost: 250000, income: [1200, 2400], employees: 2, category: 'lusso' },
        antiquariato: { name: 'Antiquariato', cost: 120000, income: [600, 1200], employees: 2, category: 'lusso' },
        
        // Animali & Natura
        pet_shop: { name: 'Pet Shop', cost: 50000, income: [220, 450], employees: 2, category: 'animali' },
        veterinario: { name: 'Clinica Veterinaria', cost: 120000, income: [600, 1200], employees: 4, category: 'animali' },
        toelettatura: { name: 'Toelettatura', cost: 40000, income: [200, 400], employees: 2, category: 'animali' },
        vivaio: { name: 'Vivaio', cost: 70000, income: [300, 600], employees: 3, category: 'animali' },
        
        // Tecnologia
        internet_cafe: { name: 'Internet Caf√©', cost: 50000, income: [250, 500], employees: 2, category: 'tech' },
        riparazioni_tech: { name: 'Riparazioni Tech', cost: 45000, income: [220, 450], employees: 2, category: 'tech' },
        computer_shop: { name: 'Negozio Computer', cost: 90000, income: [450, 900], employees: 3, category: 'tech' },
        foto_video: { name: 'Foto & Video', cost: 80000, income: [400, 800], employees: 2, category: 'tech' },
        
        // Educazione
        asilo: { name: 'Asilo Privato', cost: 150000, income: [800, 1600], employees: 8, category: 'educazione' },
        scuola_lingue: { name: 'Scuola di Lingue', cost: 80000, income: [400, 800], employees: 5, category: 'educazione' },
        scuola_musica: { name: 'Scuola di Musica', cost: 70000, income: [350, 700], employees: 4, category: 'educazione' },
        ripetizioni: { name: 'Centro Ripetizioni', cost: 40000, income: [200, 400], employees: 3, category: 'educazione' },
        
        // Altro
        lavanderia: { name: 'Lavanderia', cost: 50000, income: [250, 500], employees: 2, category: 'servizi' },
        tintoria: { name: 'Tintoria', cost: 55000, income: [280, 560], employees: 2, category: 'servizi' },
        sarta: { name: 'Sartoria', cost: 40000, income: [200, 400], employees: 2, category: 'servizi' },
        fotografo: { name: 'Studio Fotografico', cost: 60000, income: [300, 600], employees: 2, category: 'servizi' },
        centro_stampa: { name: 'Centro Stampa', cost: 70000, income: [350, 700], employees: 3, category: 'servizi' },
        agenzia_eventi: { name: 'Agenzia Eventi', cost: 80000, income: [400, 800], employees: 4, category: 'servizi' },
        club_privato: { name: 'Club Privato', cost: 500000, income: [3000, 6000], employees: 12, category: 'lusso' },
        nightclub: { name: 'Discoteca', cost: 300000, income: [1800, 3600], employees: 10, category: 'intrattenimento' }
    };

    // ---------- FOOD ITEMS ----------
    const FOOD_ITEMS = {
        pane: { name: 'Pane', cost: 2, hunger: 10, expires: 3 },
        pasta: { name: 'Pasta', cost: 3, hunger: 25, expires: 7 },
        frutta: { name: 'Frutta', cost: 5, hunger: 15, expires: 2 },
        verdura: { name: 'Verdura', cost: 4, hunger: 15, expires: 3 },
        carne: { name: 'Carne', cost: 12, hunger: 35, expires: 2 },
        pesce: { name: 'Pesce', cost: 15, hunger: 35, expires: 1 },
        latte: { name: 'Latte', cost: 2, hunger: 8, expires: 4 },
        formaggio: { name: 'Formaggio', cost: 8, hunger: 20, expires: 7 },
        uova: { name: 'Uova', cost: 4, hunger: 20, expires: 10 },
        snack: { name: 'Snack', cost: 3, hunger: 12, expires: 30 },
        surgelati: { name: 'Surgelati', cost: 10, hunger: 30, expires: 30 },
        acqua: { name: 'Acqua', cost: 1, hunger: 5, expires: 365 }
    };

    // ---------- INVESTMENTS DATA ----------
    // STOCKS now dynamically generated from companies
    let STOCKS = {};

    const PROPERTIES = [
        { id: 'apt1', name: 'Monolocale Periferia', cost: 50000, income: 300, area: 'periferia' },
        { id: 'apt2', name: 'Bilocale Centro', cost: 120000, income: 800, area: 'centro_storico' },
        { id: 'shop1', name: 'Negozio Piccolo', cost: 80000, income: 600, area: 'quartiere_operaio' },
        { id: 'office1', name: 'Ufficio Commerciale', cost: 200000, income: 1500, area: 'zona_residenziale' }
    ];

    // ---------- TRAITS ----------
    const TRAITS = [
        { id: 'athletic', name: 'Atletico', desc: '+fitness' },
        { id: 'smart', name: 'Intelligente', desc: '+intelletto' },
        { id: 'charismatic', name: 'Carismatico', desc: '+carisma' },
        { id: 'creative', name: 'Creativo', desc: '+creativit√†' },
        { id: 'lucky', name: 'Fortunato', desc: '+eventi positivi' },
        { id: 'hardworker', name: 'Laborioso', desc: '+guadagni lavoro' }
    ];

    // ---------- ACTIONS DATABASE ----------
    const ACTIONS = {
        // Casa
        eat: { cost: 0, time: 1, effects: { hunger: 0, energy: 5 }, msg: 'Hai bisogno di cibo nell\'inventario per mangiare!', requiresFood: true, category: 'casa' },
        sleep: { cost: 0, time: 8, effects: { energy: 80, health: 10, hunger: -20 }, msg: 'Hai dormito bene!', category: 'casa' },
        nap: { cost: 0, time: 2, effects: { energy: 30, morale: 5 }, msg: 'Un bel pisolino rigenerante!', category: 'casa' },
        shower: { cost: 5, time: 1, effects: { morale: 10, health: 5 }, msg: 'Ti senti fresco e pulito!', category: 'casa' },
        cook: { cost: 0, time: 2, effects: { hunger: 0, morale: 5 }, msg: 'Hai bisogno di ingredienti per cucinare!', requiresFood: true, category: 'casa' },
        clean: { cost: 0, time: 2, effects: { morale: 15, energy: -10 }, msg: 'La casa √® ora pulita!', category: 'casa' },
        relax: { cost: 0, time: 2, effects: { morale: 20, energy: 10 }, msg: 'Ti sei rilassato guardando la TV.', category: 'casa' },
        read: { cost: 5, time: 2, effects: { morale: 10, energy: -15 }, skills: { intellect: 2 }, msg: 'Hai imparato qualcosa di nuovo!', category: 'casa' },
        exercise: { cost: 0, time: 2, effects: { health: 15, energy: -25, morale: 10 }, skills: { fitness: 3 }, msg: 'Ottimo allenamento!', category: 'casa' },
        meditate: { cost: 0, time: 1, effects: { morale: 25, energy: 5 }, msg: 'Ti senti in pace con te stesso.', category: 'casa' },
        video_games: { cost: 0, time: 3, effects: { morale: 25, energy: -5 }, msg: 'Sessione di gaming epica!', category: 'casa' },
        hobby_paint: { cost: 15, time: 3, effects: { morale: 30, energy: -15 }, skills: { creativity: 5 }, msg: 'Hai creato un\'opera d\'arte!', category: 'casa' },
        study: { cost: 20, time: 4, effects: { energy: -30, morale: -10 }, skills: { intellect: 8 }, msg: 'Hai studiato intensamente!', category: 'casa' },
        
        // Parco
        park: { cost: 0, time: 2, effects: { morale: 15, energy: -5 }, msg: 'Una bella passeggiata al parco!', category: 'natura' },
        jog_park: { cost: 0, time: 2, effects: { health: 20, energy: -35, morale: 15 }, skills: { fitness: 4 }, msg: 'Corsa rigenerante nel parco!', category: 'natura' },
        picnic: { cost: 25, time: 3, effects: { hunger: 30, morale: 25, energy: 5 }, msg: 'Picnic rilassante!', category: 'natura' },
        bird_watching: { cost: 0, time: 2, effects: { morale: 20, energy: -5 }, msg: 'Hai osservato bellissimi uccelli!', category: 'natura' },
        
        // Palestra
        gym: { cost: 20, time: 2, effects: { health: 20, energy: -30 }, skills: { fitness: 5 }, msg: 'Sessione di palestra completata!', category: 'sport' },
        yoga_class: { cost: 25, time: 2, effects: { health: 15, morale: 20, energy: -10 }, msg: 'Lezione di yoga rilassante!', category: 'sport' },
        swimming: { cost: 15, time: 2, effects: { health: 25, energy: -28 }, skills: { fitness: 6 }, msg: 'Nuotata fantastica!', category: 'sport' },
        boxing: { cost: 30, time: 2, effects: { health: 20, energy: -40, morale: 10 }, skills: { fitness: 7 }, msg: 'Allenamento di boxe intenso!', category: 'sport' },
        
        // Biblioteca
        library: { cost: 10, time: 3, effects: { morale: 10, energy: -20 }, skills: { intellect: 5 }, msg: 'Hai studiato in biblioteca.', category: 'cultura' },
        research: { cost: 25, time: 4, effects: { morale: 5, energy: -35 }, skills: { intellect: 10 }, msg: 'Ricerca approfondita completata!', category: 'cultura' },
        book_club: { cost: 15, time: 3, effects: { morale: 20, energy: -15 }, skills: { intellect: 4, charisma: 3 }, msg: 'Discussione stimolante al club del libro!', category: 'cultura' },
        
        // Caff√®
        cafe: { cost: 8, time: 1, effects: { morale: 15, energy: 10, hunger: 10 }, msg: 'Un caff√® perfetto!', category: 'sociale' },
        breakfast_cafe: { cost: 20, time: 1, effects: { morale: 20, energy: 15, hunger: 35 }, msg: 'Ottima colazione al bar!', category: 'sociale' },
        cafe_work: { cost: 10, time: 3, effects: { morale: 10, energy: -15 }, skills: { intellect: 3 }, msg: 'Hai lavorato produttivamente al caff√®!', category: 'sociale' },
        
        // Cinema
        cinema: { cost: 15, time: 3, effects: { morale: 30, energy: -5 }, msg: 'Film fantastico!', category: 'intrattenimento' },
        cinema_vip: { cost: 35, time: 3, effects: { morale: 45, energy: 0 }, msg: 'Esperienza cinema VIP incredibile!', category: 'intrattenimento' },
        
        // Ristorante
        restaurant: { cost: 40, time: 2, effects: { hunger: 40, morale: 25 }, msg: 'Cena deliziosa!', category: 'cibo' },
        fine_dining: { cost: 100, time: 3, effects: { hunger: 50, morale: 45, energy: 10 }, msg: 'Esperienza culinaria stellata!', category: 'cibo' },
        fast_food: { cost: 12, time: 1, effects: { hunger: 30, morale: 10, health: -5 }, msg: 'Pasto veloce ma poco salutare...', category: 'cibo' },
        
        // Shopping
        shopping: { cost: 50, time: 2, effects: { morale: 20, energy: -10 }, msg: 'Hai comprato qualcosa di bello!', category: 'shopping' },
        window_shopping: { cost: 0, time: 2, effects: { morale: 10, energy: -8 }, msg: 'Hai fatto un giro per vetrine!', category: 'shopping' },
        luxury_shopping: { cost: 200, time: 3, effects: { morale: 50, energy: -15 }, msg: 'Shopping di lusso fantastico!', category: 'shopping' },
        
        // Museo
        museum: { cost: 10, time: 3, effects: { morale: 20, energy: -20 }, skills: { intellect: 3, creativity: 2 }, msg: 'Cultura e arte!', category: 'cultura' },
        art_gallery: { cost: 15, time: 3, effects: { morale: 25, energy: -15 }, skills: { creativity: 5 }, msg: 'Galleria d\'arte ispiratrice!', category: 'cultura' },
        guided_tour: { cost: 25, time: 4, effects: { morale: 30, energy: -30 }, skills: { intellect: 8 }, msg: 'Tour guidato educativo!', category: 'cultura' },
        
        // Vita notturna
        nightclub: { cost: 30, time: 4, effects: { morale: 35, energy: -35, hunger: -10 }, skills: { charisma: 3 }, msg: 'Serata fantastica!', category: 'notturno' },
        bar: { cost: 20, time: 2, effects: { morale: 20, energy: -15, health: -5 }, skills: { charisma: 2 }, msg: 'Serata al bar divertente!', category: 'notturno' },
        live_music: { cost: 25, time: 3, effects: { morale: 35, energy: -15 }, msg: 'Concerto live spettacolare!', category: 'notturno' },
        karaoke: { cost: 15, time: 3, effects: { morale: 40, energy: -25 }, skills: { charisma: 5 }, msg: 'Karaoke scatenato!', category: 'notturno' },
        
        // Teatro & Spettacoli
        theater: { cost: 40, time: 3, effects: { morale: 40, energy: -10 }, skills: { creativity: 3 }, msg: 'Spettacolo teatrale magnifico!', category: 'cultura' },
        opera: { cost: 60, time: 4, effects: { morale: 50, energy: -15 }, skills: { creativity: 4 }, msg: 'Opera lirica emozionante!', category: 'cultura' },
        
        // Sport & Attivit√†
        bowling: { cost: 20, time: 2, effects: { morale: 25, energy: -15 }, skills: { fitness: 2 }, msg: 'Partita a bowling divertente!', category: 'sport' },
        mini_golf: { cost: 15, time: 2, effects: { morale: 20, energy: -10 }, msg: 'Mini golf rilassante!', category: 'sport' },
        
        // Spa & Benessere
        spa: { cost: 80, time: 3, effects: { morale: 50, health: 20, energy: 30 }, msg: 'Giornata spa rigenerante!', category: 'benessere' },
        massage: { cost: 50, time: 2, effects: { morale: 35, health: 15, energy: 20 }, msg: 'Massaggio rilassante!', category: 'benessere' },
        sauna: { cost: 25, time: 1, effects: { morale: 20, health: 10 }, msg: 'Sauna purificante!', category: 'benessere' },
        
        // Volontariato
        volunteer: { cost: 0, time: 4, effects: { morale: 40, energy: -25 }, msg: 'Hai aiutato la comunit√†!', category: 'sociale' },
        animal_shelter: { cost: 0, time: 3, effects: { morale: 45, energy: -20 }, msg: 'Tempo prezioso con gli animali!', category: 'sociale' },
        
        // Corsi & Educazione
        cooking_class: { cost: 50, time: 3, effects: { morale: 25, energy: -25 }, skills: { creativity: 4 }, msg: 'Corso di cucina fantastico!', category: 'educazione' },
        language_class: { cost: 40, time: 3, effects: { morale: 15, energy: -30 }, skills: { intellect: 6 }, msg: 'Lezione di lingua produttiva!', category: 'educazione' },
        art_class: { cost: 45, time: 3, effects: { morale: 30, energy: -25 }, skills: { creativity: 7 }, msg: 'Corso d\'arte creativo!', category: 'educazione' },
        
        // Sociale
        meet_new: { cost: 0, time: 2, effects: { morale: 10, energy: -15 }, skills: { charisma: 2 }, msg: 'Hai conosciuto nuove persone!', category: 'sociale' },
        work: { cost: 0, time: 8, effects: { energy: -40, hunger: -30, morale: -10 }, msg: 'Giornata di lavoro completata!', category: 'lavoro' },
        talk: { cost: 0, time: 1, effects: { morale: 5 }, skills: { charisma: 1 }, msg: 'Bella conversazione!', category: 'sociale' },
        
        // Nuove attivit√† per skill training
        yoga: { cost: 20, time: 2, effects: { health: 20, morale: 25, energy: -20 }, skills: { fitness: 4 }, msg: 'Sessione yoga equilibrante!', category: 'sport' },
        music_lesson: { cost: 35, time: 2, effects: { morale: 20, energy: -25 }, skills: { creativity: 6 }, msg: 'Lezione di musica produttiva!', category: 'educazione' },
        photography: { cost: 25, time: 3, effects: { morale: 25, energy: -20 }, skills: { creativity: 5 }, msg: 'Sessione fotografica ispiratrice!', category: 'arte' },
        networking: { cost: 30, time: 3, effects: { morale: 15, energy: -30 }, skills: { charisma: 6 }, msg: 'Eventi di networking proficui!', category: 'sociale' },
        public_speaking: { cost: 50, time: 3, effects: { morale: 10, energy: -35 }, skills: { charisma: 8 }, msg: 'Corso di public speaking intensivo!', category: 'educazione' }
    };

    // ---------- ACTION LOCATIONS (for travel) ----------
    const ACTION_LOCATIONS = {
        // Casa (no travel)
        eat: 'home', sleep: 'home', nap: 'home', shower: 'home', cook: 'home', clean: 'home',
        relax: 'home', read: 'home', exercise: 'home', meditate: 'home', video_games: 'home',
        hobby_paint: 'home', study: 'home',

        // Parco (natura)
        park: 'zona_residenziale', jog_park: 'zona_residenziale', picnic: 'zona_residenziale', bird_watching: 'zona_residenziale',

        // Palestra (sport)
        gym: 'quartiere_operaio', yoga_class: 'zona_residenziale', swimming: 'quartiere_operaio', boxing: 'quartiere_operaio',
        bowling: 'quartiere_operaio', mini_golf: 'periferia',

        // Biblioteca (cultura)
        library: 'centro_storico', research: 'centro_storico', book_club: 'centro_storico',
        museum: 'centro_storico', art_gallery: 'centro_storico', guided_tour: 'centro_storico',

        // Caff√® (sociale/cibo)
        cafe: 'centro_storico', breakfast_cafe: 'centro_storico', cafe_work: 'centro_storico',
        fast_food: 'quartiere_operaio', restaurant: 'centro_storico', fine_dining: 'quartiere_lusso',

        // Cinema (intrattenimento)
        cinema: 'centro_storico', cinema_vip: 'quartiere_lusso', theater: 'centro_storico', opera: 'quartiere_lusso',
        live_music: 'centro_storico', karaoke: 'quartiere_operaio',

        // Vita notturna
        bar: 'quartiere_operaio', nightclub: 'centro_storico',

        // Shopping
        window_shopping: 'centro_storico', shopping: 'centro_storico', luxury_shopping: 'quartiere_lusso',

        // Benessere & Relax
        spa: 'quartiere_lusso', massage: 'quartiere_lusso', sauna: 'quartiere_lusso',

        // Corsi & Formazione
        cooking_class: 'zona_residenziale', language_class: 'centro_storico', art_class: 'centro_storico',

        // Volontariato
        volunteer: 'periferia', animal_shelter: 'periferia',

        // Sociale
        meet_new: 'centro_storico', talk: 'current', // 'current' means stay in current location

        // Lavoro (handled separately, job has its own location)
        work: 'job_location',
        
        // Nuove attivit√† skill training
        yoga: 'zona_residenziale',
        music_lesson: 'centro_storico',
        photography: 'centro_storico',
        networking: 'quartiere_lusso',
        public_speaking: 'centro_storico'
    };
    
    // Map actions to specific buildings
    const ACTION_BUILDINGS = {
        // Home actions
        eat: 'home', sleep: 'home', nap: 'home', shower: 'home', cook: 'home', clean: 'home',
        relax: 'home', read: 'home', exercise: 'home', meditate: 'home', video_games: 'home',
        hobby_paint: 'home', study: 'home',
        
        // Parks
        park: 'park', jog_park: 'park', picnic: 'park', bird_watching: 'park',
        
        // Gym
        gym: 'gym', yoga_class: 'gym', swimming: 'gym', boxing: 'gym', yoga: 'gym',
        bowling: 'gym', mini_golf: 'gym',
        
        // Library
        library: 'library', research: 'library', book_club: 'library',
        
        // Museum
        museum: 'museum', art_gallery: 'museum', guided_tour: 'museum',
        
        // Restaurants/Cafes
        cafe: 'restaurant', breakfast_cafe: 'restaurant', cafe_work: 'restaurant',
        fast_food: 'restaurant', restaurant: 'restaurant', fine_dining: 'restaurant',
        
        // Entertainment
        cinema: 'cinema', cinema_vip: 'cinema',
        theater: 'theater', opera: 'theater',
        live_music: 'bar', karaoke: 'bar',
        
        // Nightlife
        bar: 'bar', nightclub: 'nightclub',
        
        // Shopping
        window_shopping: 'mall', shopping: 'mall', luxury_shopping: 'mall',
        
        // Wellness
        spa: 'hospital', massage: 'hospital', sauna: 'hospital',
        
        // Classes
        cooking_class: 'restaurant', language_class: 'library', art_class: 'museum',
        music_lesson: 'theater', photography: 'museum',
        
        // Social
        networking: 'restaurant', public_speaking: 'theater',
        meet_new: 'street', talk: 'street',
        
        // Work
        work: 'work'
    };

    // ---------- INIT ----------
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            $('loadingScreen').style.display = 'none';
        }, 1500);
        initTraits();
        checkSavedGame();
    });

    function initTraits() {
        const grid = $('traitsGrid');
        grid.innerHTML = '';
        TRAITS.forEach(t => {
            const card = document.createElement('div');
            card.className = 'trait-card';
            card.onclick = function() {
                const checkbox = card.querySelector('input[type=checkbox]');
                checkbox.checked = !checkbox.checked;
                limitTraits();
            };
            
            card.innerHTML = `
                <input type="checkbox" value="${t.id}" onchange="limitTraits()" />
                <div style="font-weight:600; margin-bottom:4px; font-size:0.95rem;">${t.name}</div>
                <div style="font-size:0.75rem; opacity:0.7; line-height:1.3;">
                    ${getTraitDescription(t.id)}
                </div>
            `;
            grid.appendChild(card);
        });
        
        // Update background and difficulty info on load
        updateBackgroundInfo();
        updateDifficultyInfo();
    }

    function getTraitDescription(traitId) {
        const descriptions = {
            ambitious: '+10% salario, +5 energia ma +5 stress',
            charismatic: '+20 relazioni sociali, -10% prezzi negozi',
            athletic: '+15 salute massima, +10 energia da sport',
            intelligent: '+15% apprendimento, +10 prestazioni lavoro',
            creative: '+20% guadagni attivit√† artistiche',
            disciplined: '-20% stress, +10 prestazioni lavorative',
            lucky: '+15% eventi positivi casuali',
            frugal: '-15% spese giornaliere',
            workaholic: '+20% salario, -10 morale, +10 stress',
            lazy: '-10% prestazioni, +10 energia da riposo',
            anxious: '+15 stress iniziale, -10 relazioni sociali',
            extrovert: '+15 morale da eventi sociali',
            introvert: '-10 morale da eventi sociali, +5 da attivit√† solitarie',
            greedy: '+15% guadagni ma -10 morale se basso su soldi',
            generous: '-10% soldi, +15 relazioni sociali'
        };
        return descriptions[traitId] || 'Tratto speciale';
    }

    function limitTraits() {
        const cards = document.querySelectorAll('.trait-card');
        const checked = document.querySelectorAll('#traitsGrid input[type=checkbox]:checked');
        
        if (checked.length > 3) {
            checked[checked.length - 1].checked = false;
            showNotification('‚ö†Ô∏è Massimo 3 tratti!', 2000);
        }
        
        // Update visual state of cards
        cards.forEach(card => {
            const checkbox = card.querySelector('input[type=checkbox]');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    function updateBackgroundInfo() {
        const background = $('charBackground').value;
        const info = $('backgroundInfo');
        
        const backgrounds = {
            student: {
                title: 'üìö Studente',
                desc: 'Sei un giovane studente in cerca di opportunit√†.',
                pros: '<strong>‚úÖ Vantaggi:</strong> +10 intelligenza, accesso a borse di studio, -30% affitto studenti',
                cons: '<strong>‚ùå Svantaggi:</strong> Stipendio iniziale basso, poche competenze lavorative'
            },
            worker: {
                title: 'üë∑ Lavoratore',
                desc: 'Hai esperienza pratica e sei abituato al lavoro duro.',
                pros: '<strong>‚úÖ Vantaggi:</strong> +15 forza, +20% stipendio lavori manuali, +10 resistenza',
                cons: '<strong>‚ùå Svantaggi:</strong> Difficolt√† con lavori d\'ufficio, -5 intelligenza'
            },
            tech: {
                title: 'üíª Tecnico IT',
                desc: 'Esperto di tecnologia con competenze specializzate.',
                pros: '<strong>‚úÖ Vantaggi:</strong> +20 intelligenza, +50% guadagno lavori tech, accesso lavori specializzati',
                cons: '<strong>‚ùå Svantaggi:</strong> -10 forza fisica, -5 relazioni sociali iniziali'
            },
            artist: {
                title: 'üé® Artista',
                desc: 'Creativo e sensibile, cerchi di esprimerti attraverso l\'arte.',
                pros: '<strong>‚úÖ Vantaggi:</strong> +20 creativit√†, +30% guadagni arte, +10 carisma',
                cons: '<strong>‚ùå Svantaggi:</strong> Reddito instabile, -10 disciplina lavorativa'
            }
        };
        
        const bg = backgrounds[background];
        info.innerHTML = `
            <div style="font-weight:600; margin-bottom:6px;">${bg.title}</div>
            <div style="margin-bottom:8px;">${bg.desc}</div>
            <div style="margin-bottom:4px;">${bg.pros}</div>
            <div>${bg.cons}</div>
        `;
    }

    function updateDifficultyInfo() {
        const difficulty = $('gameDifficulty').value;
        const info = $('difficultyInfo');
        
        const difficulties = {
            easy: {
                title: 'üòä Modalit√† Facile',
                desc: 'Perfetta per chi vuole godersi la storia senza troppo stress.',
                features: [
                    'üí∞ Inizi con 1000‚Ç¨ in tasca',
                    'üè† Affitti ridotti del 30%',
                    'üíº Stipendi aumentati del 25%',
                    'üõ°Ô∏è Meno eventi criminali (-50%)',
                    '‚è∞ Penalit√† homeless ridotte del 50%'
                ]
            },
            normal: {
                title: 'üòê Modalit√† Normale',
                desc: 'Esperienza bilanciata e realistica della vita cittadina.',
                features: [
                    'üí∞ Inizi con 500‚Ç¨ in tasca',
                    'üè† Affitti standard',
                    'üíº Stipendi normali',
                    'üé≤ Eventi casuali bilanciati',
                    '‚öñÔ∏è Sfida equilibrata'
                ]
            },
            hard: {
                title: 'üò∞ Modalit√† Difficile',
                desc: 'Per chi cerca una vera sfida di sopravvivenza.',
                features: [
                    'üí∞ Inizi con solo 200‚Ç¨',
                    'üè† Affitti aumentati del 20%',
                    'üíº Stipendi ridotti del 15%',
                    'üî• Eventi negativi pi√π frequenti (+50%)',
                    'üíÄ Penalit√† homeless aumentate del 50%',
                    'üìâ Rischio licenziamento pi√π alto'
                ]
            }
        };
        
        const diff = difficulties[difficulty];
        info.innerHTML = `
            <div style="font-weight:600; margin-bottom:6px;">${diff.title}</div>
            <div style="margin-bottom:10px;">${diff.desc}</div>
            <div style="font-size:0.85rem;">
                ${diff.features.map(f => `<div style="margin-bottom:3px;">‚Ä¢ ${f}</div>`).join('')}
            </div>
        `;
    }

    // ---------- GAME FLOW ----------
    function newGame() {
        showScreen('characterScreen');
    }

    function startGame() {
        const name = $('charName').value.trim() || 'Giocatore';
        const age = parseInt($('charAge').value);
        const gender = $('charGender').value;
        const background = $('charBackground').value;
        const diff = $('gameDifficulty').value;
        const traits = Array.from(document.querySelectorAll('#traitsGrid input[type=checkbox]:checked')).map(x => x.value);

        const startMoney = diff === 'easy' ? 1000 : diff === 'normal' ? 500 : 200;

        // Generate random starting skills (5-15 range for each)
        const randomSkills = {
            intellect: randInt(5, 15),
            fitness: randInt(5, 15),
            creativity: randInt(5, 15),
            charisma: randInt(5, 15)
        };

        game.player = {
            name, age, gender, background, difficulty: diff, traits,
            money: startMoney, // Total money (will be split)
            cash: Math.floor(startMoney * 0.3), // Contante (pu√≤ essere rubato)
            bankDeposit: Math.floor(startMoney * 0.7), // Deposito bancario (sicuro)
            rep: 10,
            job: 'Disoccupato',
            jobLevel: 0,
            stats: { hunger: 80, energy: 80, morale: 70, health: 90 },
            skills: randomSkills,
            totalEarned: 0,
            dailyTraining: 0, // Track skill training activities per day
            lastTrainingDay: 1, // Reset counter on new day
            workDaysThisWeek: 0, // Track work days in current week
            lastWorkDay: null, // Last day worked
            absences: 0, // Track absences for penalties
            isHomeless: true // Start as homeless until chooses housing
        };
        
        // Initialize chat history
        game.chatHistory = {};
        game.currentChatNpc = null;

        // Initialize housing - start in cheapest neighborhood (Condominio Vista Parco)
        game.housing = {
            neighborhood: 'periferia',
            residenceId: null, // Start homeless - player must find housing
            rentPaid: false,
            owned: false
        };

        // Initialize food inventory with some starter items
        game.inventory = {
            food: [
                { id: 'pane', boughtDay: 1 },
                { id: 'pasta', boughtDay: 1 },
                { id: 'acqua', boughtDay: 1 }
            ],
            devices: {
                phone: false,     // Cellulare - serve per cercare lavoro online
                computer: false   // PC - migliore ricerca lavoro + altre funzioni
            }
        };

        // Initialize city map
        game.cityMap = {
            currentLocation: 'periferia', // Player starts at home neighborhood
            currentBuilding: 'home', // Specific building/location within neighborhood
            ownedBusinesses: [],
            discoveredLocations: [],
            transportPass: null
        };
        
        // Initialize vehicles
        game.vehicles = {
            owned: [],
            active: null // null = walking
        };

        // Initialize relationships
        game.relationships = {
            romantic: null,
            spouse: null,
            children: [],
            dating: []
        };

        // Initialize investments
        game.investments = {
            stocks: [],
            savings: 0,
            properties: [],
            loans: [] // Array of {id, amount, interestRate, monthlyPayment, remainingMonths, bank, takenDay}
        };
        
        // Initialize companies tracking
        game.companies = {}; // Will be populated from job listings

        // Initialize crime
        game.crime = {
            record: [],
            wanted: 0,
            reputation: 'pulito'
        };
        
        // Initialize health tracking for game over
        game.healthTracking = {
            lowEnergyDays: 0,
            lowHungerDays: 0,
            lowHealthDays: 0,
            debtDays: 0,
            lastCheckDay: 1
        };

    // Time now tracks minutes explicitly for precise control
    game.time = { day: 1, hour: 8, minute: 0 };
        game.lastRentPayment = 1;
        game.lastTaxPayment = 1;
        
        // Initialize agenda (calendar/appointments)
        game.agenda = {
            appointments: [], // Array of {day, hour, type, title, description, location, npcId}
            reminders: []
        };
        
        // Initialize time control
        game.timeControl = {
            isPaused: true, // Start paused
            speed: 1, // 1x, 2x, 5x, 10x
            lastTick: Date.now()
        };
        
        game.npcs = generateInitialNPCs();
        game.quests = generateInitialQuests();
        game.jobListings = generateJobListings();
        
        // Initialize companies and stocks from job listings
        initializeCompanies();

        showNotification(`Benvenuto/a ${name}! Inizi in ${NEIGHBORHOODS[game.housing.neighborhood].name}.`, 2500);
        showScreen('gameScreen');
        updateUI();
        
        // Initialize map view
        setTimeout(() => {
            renderDetailedMap(game.housing.neighborhood);
            updatePlayerMarker();
        }, 100);
        
        // Start game loop for automatic time progression
        startGameLoop();
        
        // Show welcome tutorial after starting the game
        setTimeout(() => {
            showWelcomeTutorial();
        }, 1000);
    }

    // ---------- NPC GENERATION ----------
    function generateInitialNPCs() {
        const npcData = [
            { name: 'Marco', job: 'Studente', personality: 'amichevole', mood: 'allegro', locationId: 'loc_c7', neighborhood: 'centro_storico', homeLocationId: 'loc_p6' },
            { name: 'Giulia', job: 'Barista', personality: 'socievole', mood: 'neutro', locationId: 'loc_o1', neighborhood: 'quartiere_operaio', homeLocationId: 'loc_o8' },
            { name: 'Luca', job: 'Programmatore', personality: 'introverso', mood: 'concentrato', locationId: 'loc_c1', neighborhood: 'centro_storico', homeLocationId: 'loc_r8' },
            { name: 'Sofia', job: 'Artista', personality: 'creativa', mood: 'ispirata', locationId: 'loc_c3', neighborhood: 'centro_storico', homeLocationId: 'loc_c8' },
            { name: 'Alessandro', job: 'Manager', personality: 'professionale', mood: 'serio', locationId: 'loc_c2', neighborhood: 'centro_storico', homeLocationId: 'loc_r7' },
            { name: 'Chiara', job: 'Insegnante', personality: 'paziente', mood: 'calma', locationId: 'loc_r2', neighborhood: 'zona_residenziale', homeLocationId: 'loc_r9' }
        ];
        
        return npcData.map((n, i) => ({
            id: 'npc_' + i,
            name: n.name,
            relation: 0, // Inizi senza conoscere nessuno!
            known: false, // Devi incontrare l'NPC prima
            job: n.job,
            personality: n.personality,
            mood: n.mood,
            locationId: n.locationId, // Dove lavora/frequenta
            neighborhood: n.neighborhood,
            homeLocationId: n.homeLocationId, // Dove abita
            homeNeighborhood: n.homeNeighborhood,
            conversationStyle: getConversationStyle(n.personality),
            lastInteraction: 0,
            schedule: generateNPCSchedule(n.job) // Orari in cui √® presente nelle location
        }));
    }
    
    function generateNPCSchedule(job) {
        // Orari approssimativi in cui l'NPC √® nella sua location di lavoro
        const schedules = {
            'Barista': { workDays: [1,2,3,4,5,6], workHours: { start: 7, end: 18 }, homeDays: [7] },
            'Studente': { workDays: [1,2,3,4,5], workHours: { start: 9, end: 17 }, homeDays: [6,7] },
            'Programmatore': { workDays: [1,2,3,4,5], workHours: { start: 9, end: 18 }, homeDays: [6,7] },
            'Artista': { workDays: [2,3,4,5,6], workHours: { start: 10, end: 19 }, homeDays: [1,7] },
            'Manager': { workDays: [1,2,3,4,5], workHours: { start: 8, end: 19 }, homeDays: [6,7] },
            'Insegnante': { workDays: [1,2,3,4,5], workHours: { start: 8, end: 16 }, homeDays: [6,7] }
        };
        return schedules[job] || { workDays: [1,2,3,4,5], workHours: { start: 9, end: 17 }, homeDays: [6,7] };
    }
    
    function getConversationStyle(personality) {
        const styles = {
            'amichevole': { greeting: 'Ciao! Come va?', tone: 'casual e amichevole' },
            'socievole': { greeting: 'Hey! Che piacere vederti!', tone: 'energico e positivo' },
            'introverso': { greeting: 'Salve.', tone: 'riservato ma educato' },
            'creativa': { greeting: 'Oh ciao! Sto lavorando a una nuova idea!', tone: 'entusiasta e creativo' },
            'professionale': { greeting: 'Buongiorno. In cosa posso aiutarti?', tone: 'formale e diretto' },
            'paziente': { greeting: 'Ciao! Tutto bene?', tone: 'calmo e comprensivo' }
        };
        return styles[personality] || styles['amichevole'];
    }

    // ---------- QUESTS ----------
    function generateInitialQuests() {
        return [
            { id: 'first_job', name: 'Trova il tuo primo lavoro', desc: 'Cerca un lavoro nelle offerte disponibili', completed: false, reward: 100 },
            { id: 'make_friend', name: 'Fai amicizia', desc: 'Porta la relazione con qualcuno a 50+', completed: false, reward: 50 }
        ];
    }

    function renderQuests() {
        const list = $('questsList');
        if (!list) return;
        
        if (game.quests.length === 0) {
            list.innerHTML = '<p style="opacity:0.7;">Nessuna missione attiva.</p>';
            return;
        }

        list.innerHTML = game.quests.map(q => `
            <div class="quest-card ${q.completed ? 'completed' : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${q.completed ? '‚úÖ' : '‚≠ê'} ${q.name}</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">${q.desc}</div>
                    </div>
                    <div style="text-align:right; min-width:80px;">
                        <div style="color:var(--success); font-weight:bold;">+‚Ç¨${q.reward}</div>
                        ${q.completed ? '<div style="color:var(--success); font-size:0.85rem;">Completata!</div>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function checkQuests() {
        game.quests.forEach(q => {
            if (q.completed) return;

            if (q.id === 'first_job' && game.player.job !== 'Disoccupato') {
                q.completed = true;
                earnMoney(q.reward);
                showNotification(`‚úÖ Missione completata: ${q.name}! +‚Ç¨${q.reward}`, 2500);
            }

            if (q.id === 'make_friend') {
                const hasFriend = game.npcs.some(npc => npc.relation >= 50);
                if (hasFriend) {
                    q.completed = true;
                    earnMoney(q.reward);
                    showNotification(`‚úÖ Missione completata: ${q.name}! +‚Ç¨${q.reward}`, 2500);
                }
            }
        });
        renderQuests();
    }

    // ---------- JOB SYSTEM ----------
    function generateJobListings() {
        return [
            // Entry Level
            // ENTRY LEVEL - Periferia
            { 
                id: 'job1', 
                name: 'Commesso Supermercato', 
                salary: 45, 
                reqRep: 0,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Roberto Marchetti',
                managerPersonality: 'professionale',
                tasks: ['Riordina scaffali', 'Assisti clienti', 'Gestisci cassa'],
                locationId: 'loc_p1', // Minimarket Express
                location: 'periferia'
            },
            { 
                id: 'job2', 
                name: 'Aiuto Pizzaiolo', 
                salary: 48, 
                reqRep: 0,
                hours: { start: 11, end: 19 },
                daysPerWeek: 5,
                manager: 'Mario Esposito',
                managerPersonality: 'paziente',
                tasks: ['Prepara impasti', 'Guarnisci pizze', 'Gestisci forno'],
                locationId: 'loc_p2', // Pizzeria Da Mario
                location: 'periferia'
            },
            
            // ENTRY LEVEL - Quartiere Operaio
            { 
                id: 'job3', 
                name: 'Barista', 
                salary: 50, 
                reqRep: 0,
                hours: { start: 7, end: 15 },
                daysPerWeek: 5,
                manager: 'Maria Rossi',
                managerPersonality: 'socievole',
                tasks: ['Prepara caff√®', 'Servi clienti', 'Gestisci cassa'],
                locationId: 'loc_o1', // Bar Centrale
                location: 'quartiere_operaio'
            },
            { 
                id: 'job4', 
                name: 'Commesso Ferramenta', 
                salary: 52, 
                reqRep: 5,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Giuseppe Bianchi',
                managerPersonality: 'professionale',
                tasks: ['Assisti clienti', 'Gestisci magazzino', 'Riordina merce'],
                locationId: 'loc_o2', // Ferramenta Bianchi
                location: 'quartiere_operaio'
            },
            { 
                id: 'job5', 
                name: 'Istruttore Palestra', 
                salary: 65, 
                reqRep: 10,
                hours: { start: 14, end: 22 },
                daysPerWeek: 5,
                manager: 'Luca Vitale',
                managerPersonality: 'amichevole',
                tasks: ['Segui clienti', 'Crea schede allenamento', 'Mantieni attrezzature'],
                locationId: 'loc_o3', // Palestra FitLife
                location: 'quartiere_operaio'
            },
            
            // INTERMEDIATE - Centro Storico
            { 
                id: 'job6', 
                name: 'Commesso Boutique', 
                salary: 85, 
                reqRep: 15,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Stefano Moretti',
                managerPersonality: 'professionale',
                tasks: ['Vendi abbigliamento', 'Consiglia clienti', 'Allestisci vetrine'],
                locationId: 'loc_c1', // Boutique Eleganza
                location: 'centro_storico'
            },
            { 
                id: 'job7', 
                name: 'Cameriere', 
                salary: 75, 
                reqRep: 10,
                hours: { start: 12, end: 20 },
                daysPerWeek: 5,
                manager: 'Antonio Verdi',
                managerPersonality: 'paziente',
                tasks: ['Prendi ordini', 'Servi tavoli', 'Gestisci clienti'],
                locationId: 'loc_c2', // Ristorante La Tavola
                location: 'centro_storico'
            },
            { 
                id: 'job8', 
                name: 'Assistente Gallerista', 
                salary: 90, 
                reqRep: 20,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Elena Costa',
                managerPersonality: 'creativa',
                tasks: ['Accogli visitatori', 'Organizza mostre', 'Gestisci vendite opere'],
                locationId: 'loc_c3', // Galleria Arte Moderna
                location: 'centro_storico'
            },
            
            // INTERMEDIATE - Zona Residenziale
            { 
                id: 'job9', 
                name: 'Pasticciere', 
                salary: 80, 
                reqRep: 15,
                hours: { start: 6, end: 14 },
                daysPerWeek: 5,
                manager: 'Carla Fabbri',
                managerPersonality: 'paziente',
                tasks: ['Prepara dolci', 'Servi clienti', 'Gestisci vetrina'],
                locationId: 'loc_r1', // Pasticceria Dolce Vita
                location: 'zona_residenziale'
            },
            { 
                id: 'job10', 
                name: 'Libraio', 
                salary: 70, 
                reqRep: 12,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Paolo Mondadori',
                managerPersonality: 'introverso',
                tasks: ['Consiglia libri', 'Gestisci inventario', 'Organizza eventi'],
                locationId: 'loc_r2', // Libreria Mondadori
                location: 'zona_residenziale'
            },
            { 
                id: 'job11', 
                name: 'Addetto Pet Shop', 
                salary: 65, 
                reqRep: 8,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Sara Benedetti',
                managerPersonality: 'socievole',
                tasks: ['Cura animali', 'Consiglia clienti', 'Gestisci prodotti'],
                locationId: 'loc_r3', // Pet Paradise
                location: 'zona_residenziale'
            },
            
            // PROFESSIONAL - Quartiere Lusso
            { 
                id: 'job12', 
                name: 'Commesso Gioielleria', 
                salary: 120, 
                reqRep: 30,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Alessandro Cartier',
                managerPersonality: 'professionale',
                tasks: ['Vendi gioielli', 'Valuta pezzi', 'Gestisci clientela VIP'],
                locationId: 'loc_l1', // Gioielleria Cartier
                location: 'quartiere_lusso'
            },
            { 
                id: 'job13', 
                name: 'Sous Chef', 
                salary: 150, 
                reqRep: 35,
                hours: { start: 11, end: 19 },
                daysPerWeek: 5,
                manager: 'Chef Matteo Stellini',
                managerPersonality: 'esigente',
                tasks: ['Coordina cucina', 'Crea piatti', 'Gestisci staff'],
                locationId: 'loc_l2', // Ristorante Stella Michelin
                location: 'quartiere_lusso'
            },
            { 
                id: 'job14', 
                name: 'Terapista SPA', 
                salary: 110, 
                reqRep: 25,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Laura Serenit√†',
                managerPersonality: 'paziente',
                tasks: ['Esegui trattamenti', 'Consiglia percorsi', 'Gestisci prenotazioni'],
                locationId: 'loc_l3', // Spa Serenit√†
                location: 'quartiere_lusso'
            },
            
            // PROFESSIONAL - Centro Storico (Uffici virtuali)
            { 
                id: 'job15', 
                name: 'Programmatore Junior', 
                salary: 120, 
                reqRep: 30,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Marco Ricci',
                managerPersonality: 'introverso',
                tasks: ['Sviluppa codice', 'Debug problemi', 'Scrivi documentazione'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub
                location: 'centro_storico'
            },
            { 
                id: 'job16', 
                name: 'Grafico Pubblicitario', 
                salary: 110, 
                reqRep: 25,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Elena Fontana',
                managerPersonality: 'creativa',
                tasks: ['Crea design', 'Gestisci progetti', 'Presenta concept'],
                locationId: 'loc_c5', // Locale Centrale - Studio Creativo
                location: 'centro_storico'
            },
            { 
                id: 'job17', 
                name: 'Social Media Manager', 
                salary: 105, 
                reqRep: 22,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Chiara Gallo',
                managerPersonality: 'socievole',
                tasks: ['Gestisci social', 'Crea contenuti', 'Analizza metriche'],
                locationId: 'loc_c5', // Locale Centrale - Agenzia Marketing
                location: 'centro_storico'
            },
            
            // SENIOR/MANAGEMENT - Quartiere Lusso
            { 
                id: 'job18', 
                name: 'Manager Boutique Luxury', 
                salary: 200, 
                reqRep: 50,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Isabella Monti',
                managerPersonality: 'esigente',
                tasks: ['Gestisci team', 'Seleziona collezioni', 'Clientela VIP'],
                locationId: 'loc_l4', // Boutique Luxury
                location: 'quartiere_lusso'
            },
            { 
                id: 'job19', 
                name: 'Programmatore Senior', 
                salary: 220, 
                reqRep: 55,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Matteo Esposito',
                managerPersonality: 'introverso',
                tasks: ['Architetta sistemi', 'Mentora junior', 'Risolvi problemi complessi'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub Senior
                location: 'centro_storico'
            },
            { 
                id: 'job20', 
                name: 'Project Manager', 
                salary: 200, 
                reqRep: 50,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Francesca Colombo',
                managerPersonality: 'professionale',
                tasks: ['Coordina team', 'Pianifica progetti', 'Meeting clienti'],
                locationId: 'loc_c5', // Locale Centrale - Business Hub
                location: 'centro_storico'
            },
            
            // EXECUTIVE - Quartiere Lusso
            { 
                id: 'job21', 
                name: 'Direttore Ristorante Stellato', 
                salary: 280, 
                reqRep: 70,
                hours: { start: 10, end: 18 },
                daysPerWeek: 5,
                manager: 'Proprietario',
                managerPersonality: 'esigente',
                tasks: ['Gestisci ristorante', 'Supervisiona staff', 'Relazioni VIP'],
                locationId: 'loc_l2', // Ristorante Stella Michelin
                location: 'quartiere_lusso'
            },
            { 
                id: 'job22', 
                name: 'Direttore SPA Luxury', 
                salary: 250, 
                reqRep: 65,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'Consiglio Amministrazione',
                managerPersonality: 'professionale',
                tasks: ['Gestisci centro', 'Pianifica strategie', 'Budget e investimenti'],
                locationId: 'loc_l3', // Spa Serenit√†
                location: 'quartiere_lusso'
            },
            { 
                id: 'job23', 
                name: 'CTO - Chief Technology Officer', 
                salary: 350, 
                reqRep: 80,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'CEO',
                managerPersonality: 'visionario',
                tasks: ['Strategia tecnologica', 'Guida tech team', 'Innovazione prodotto'],
                locationId: 'loc_c4', // Palazzo Storico - TechHub HQ
                location: 'centro_storico'
            },
            { 
                id: 'job24', 
                name: 'Direttore Marketing', 
                salary: 320, 
                reqRep: 75,
                hours: { start: 9, end: 17 },
                daysPerWeek: 5,
                manager: 'CEO',
                managerPersonality: 'professionale',
                tasks: ['Strategia marketing', 'Gestisci budget', 'Guida campagne'],
                locationId: 'loc_c5', // Locale Centrale - Corporate Office
                location: 'centro_storico'
            },
            { 
                id: 'job25', 
                name: 'CEO Startup', 
                salary: 400, 
                reqRep: 90,
                hours: { start: 8, end: 16 },
                daysPerWeek: 5,
                manager: 'Consiglio Amministrazione',
                managerPersonality: 'visionario',
                tasks: ['Guida azienda', 'Strategia aziendale', 'Fundraising investitori'],
                locationId: 'loc_c4', // Palazzo Storico - Startup Hub
                location: 'centro_storico'
            }
        ];
    }

    // ---------- CAREER PATHS SYSTEM ----------
    const CAREER_PATHS = {
        hospitality: {
            name: 'Ospitalit√† & Ristorazione',
            levels: [
                { 
                    level: 0, 
                    title: 'Commesso/Cameriere', 
                    salary: 50, 
                    requirements: { intellect: 0, charisma: 10, fitness: 10 },
                    description: 'Livello base nel settore ospitalit√†'
                },
                { 
                    level: 1, 
                    title: 'Cuoco/Barista Senior', 
                    salary: 85, 
                    requirements: { intellect: 15, charisma: 20, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Gestione autonoma e responsabilit√†'
                },
                { 
                    level: 2, 
                    title: 'Supervisore Sala', 
                    salary: 130, 
                    requirements: { intellect: 25, charisma: 35, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento staff e gestione turni'
                },
                { 
                    level: 3, 
                    title: 'Assistant Manager', 
                    salary: 180, 
                    requirements: { intellect: 35, charisma: 45, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Vice del manager, gestione operativa'
                },
                { 
                    level: 4, 
                    title: 'Restaurant Manager', 
                    salary: 250, 
                    requirements: { intellect: 45, charisma: 55, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Gestione completa del ristorante'
                },
                { 
                    level: 5, 
                    title: 'Direttore Area', 
                    salary: 350, 
                    requirements: { intellect: 60, charisma: 70, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Supervisione di pi√π location'
                }
            ]
        },
        retail: {
            name: 'Vendite & Retail',
            levels: [
                { 
                    level: 0, 
                    title: 'Addetto Vendite', 
                    salary: 55, 
                    requirements: { intellect: 10, charisma: 15, fitness: 10 },
                    description: 'Assistenza clienti e gestione cassa'
                },
                { 
                    level: 1, 
                    title: 'Venditore Specializzato', 
                    salary: 90, 
                    requirements: { intellect: 20, charisma: 30, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Consulenza specializzata ai clienti'
                },
                { 
                    level: 2, 
                    title: 'Team Leader Vendite', 
                    salary: 140, 
                    requirements: { intellect: 30, charisma: 40, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento piccolo team'
                },
                { 
                    level: 3, 
                    title: 'Store Manager', 
                    salary: 200, 
                    requirements: { intellect: 40, charisma: 50, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Gestione completa del punto vendita'
                },
                { 
                    level: 4, 
                    title: 'District Manager', 
                    salary: 280, 
                    requirements: { intellect: 50, charisma: 60, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Supervisione area territoriale'
                },
                { 
                    level: 5, 
                    title: 'Direttore Vendite', 
                    salary: 380, 
                    requirements: { intellect: 65, charisma: 75, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Strategia vendite nazionale'
                }
            ]
        },
        tech: {
            name: 'Tecnologia & IT',
            levels: [
                { 
                    level: 0, 
                    title: 'Programmatore Junior', 
                    salary: 120, 
                    requirements: { intellect: 30, charisma: 10, creativity: 20 },
                    description: 'Sviluppo sotto supervisione'
                },
                { 
                    level: 1, 
                    title: 'Programmatore', 
                    salary: 180, 
                    requirements: { intellect: 45, charisma: 20, creativity: 30, performance: 70, managerRelation: 60 },
                    description: 'Sviluppo autonomo di features'
                },
                { 
                    level: 2, 
                    title: 'Senior Developer', 
                    salary: 250, 
                    requirements: { intellect: 60, charisma: 30, creativity: 45, performance: 75, managerRelation: 70 },
                    description: 'Architettura e mentoring'
                },
                { 
                    level: 3, 
                    title: 'Tech Lead', 
                    salary: 320, 
                    requirements: { intellect: 70, charisma: 45, creativity: 55, performance: 80, managerRelation: 75 },
                    description: 'Guida tecnica del team'
                },
                { 
                    level: 4, 
                    title: 'Engineering Manager', 
                    salary: 400, 
                    requirements: { intellect: 80, charisma: 60, creativity: 65, performance: 85, managerRelation: 80 },
                    description: 'Gestione team sviluppo'
                },
                { 
                    level: 5, 
                    title: 'CTO', 
                    salary: 550, 
                    requirements: { intellect: 90, charisma: 70, creativity: 75, performance: 90, managerRelation: 85 },
                    description: 'Direzione tecnologica aziendale'
                }
            ]
        },
        creative: {
            name: 'Creativo & Marketing',
            levels: [
                { 
                    level: 0, 
                    title: 'Junior Designer', 
                    salary: 95, 
                    requirements: { intellect: 20, charisma: 20, creativity: 30 },
                    description: 'Esecuzione progetti creativi'
                },
                { 
                    level: 1, 
                    title: 'Graphic Designer', 
                    salary: 140, 
                    requirements: { intellect: 30, charisma: 30, creativity: 45, performance: 70, managerRelation: 60 },
                    description: 'Design autonomo e concept'
                },
                { 
                    level: 2, 
                    title: 'Art Director', 
                    salary: 200, 
                    requirements: { intellect: 40, charisma: 45, creativity: 60, performance: 75, managerRelation: 70 },
                    description: 'Direzione creativa progetti'
                },
                { 
                    level: 3, 
                    title: 'Marketing Manager', 
                    salary: 270, 
                    requirements: { intellect: 50, charisma: 60, creativity: 70, performance: 80, managerRelation: 75 },
                    description: 'Strategia e campagne marketing'
                },
                { 
                    level: 4, 
                    title: 'Creative Director', 
                    salary: 360, 
                    requirements: { intellect: 60, charisma: 70, creativity: 80, performance: 85, managerRelation: 80 },
                    description: 'Visione creativa aziendale'
                },
                { 
                    level: 5, 
                    title: 'CMO', 
                    salary: 480, 
                    requirements: { intellect: 75, charisma: 80, creativity: 90, performance: 90, managerRelation: 85 },
                    description: 'Direzione marketing e branding'
                }
            ]
        },
        healthcare: {
            name: 'Sanit√† & Medicina',
            levels: [
                { 
                    level: 0, 
                    title: 'Infermiere', 
                    salary: 115, 
                    requirements: { intellect: 30, charisma: 20, fitness: 25 },
                    description: 'Assistenza pazienti e cure base'
                },
                { 
                    level: 1, 
                    title: 'Infermiere Specializzato', 
                    salary: 165, 
                    requirements: { intellect: 45, charisma: 30, fitness: 30, performance: 70, managerRelation: 60 },
                    description: 'Procedure specialistiche'
                },
                { 
                    level: 2, 
                    title: 'Coordinatore Infermieristico', 
                    salary: 220, 
                    requirements: { intellect: 55, charisma: 45, fitness: 35, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento reparto'
                },
                { 
                    level: 3, 
                    title: 'Medico Junior', 
                    salary: 300, 
                    requirements: { intellect: 70, charisma: 50, fitness: 40, performance: 80, managerRelation: 75 },
                    description: 'Diagnosi e cure sotto supervisione'
                },
                { 
                    level: 4, 
                    title: 'Medico Specialista', 
                    salary: 420, 
                    requirements: { intellect: 85, charisma: 60, fitness: 45, performance: 85, managerRelation: 80 },
                    description: 'Specializzazione medica'
                },
                { 
                    level: 5, 
                    title: 'Primario', 
                    salary: 600, 
                    requirements: { intellect: 95, charisma: 75, fitness: 50, performance: 90, managerRelation: 85 },
                    description: 'Direzione reparto ospedaliero'
                }
            ]
        },
        business: {
            name: 'Business & Management',
            levels: [
                { 
                    level: 0, 
                    title: 'Assistente Amministrativo', 
                    salary: 75, 
                    requirements: { intellect: 25, charisma: 20, fitness: 10 },
                    description: 'Supporto amministrativo'
                },
                { 
                    level: 1, 
                    title: 'Analista Business', 
                    salary: 130, 
                    requirements: { intellect: 40, charisma: 30, fitness: 15, performance: 70, managerRelation: 60 },
                    description: 'Analisi dati e reporting'
                },
                { 
                    level: 2, 
                    title: 'Team Leader', 
                    salary: 190, 
                    requirements: { intellect: 50, charisma: 45, fitness: 20, performance: 75, managerRelation: 70 },
                    description: 'Coordinamento piccoli team'
                },
                { 
                    level: 3, 
                    title: 'Project Manager', 
                    salary: 260, 
                    requirements: { intellect: 60, charisma: 60, fitness: 25, performance: 80, managerRelation: 75 },
                    description: 'Gestione progetti complessi'
                },
                { 
                    level: 4, 
                    title: 'Senior Manager', 
                    salary: 350, 
                    requirements: { intellect: 70, charisma: 70, fitness: 30, performance: 85, managerRelation: 80 },
                    description: 'Gestione dipartimento'
                },
                { 
                    level: 5, 
                    title: 'Director/VP', 
                    salary: 500, 
                    requirements: { intellect: 85, charisma: 85, fitness: 35, performance: 90, managerRelation: 85 },
                    description: 'Direzione strategica'
                }
            ]
        }
    };

    // Map jobs to career paths
    const JOB_TO_CAREER = {
        'Commesso Supermercato': 'retail',
        'Barista': 'hospitality',
        'Cameriere': 'hospitality',
        'Cuoco Aiutante': 'hospitality',
        'Head Chef': 'hospitality',
        'Addetto Vendite': 'retail',
        'Manager Vendite': 'retail',
        'Programmatore Jr': 'tech',
        'Programmatore Senior': 'tech',
        'Grafico Pubblicitario': 'creative',
        'Social Media Manager': 'creative',
        'Fotografo': 'creative',
        'Direttore Marketing': 'creative',
        'Infermiere': 'healthcare',
        'Medico': 'healthcare',
        'Receptionist': 'business',
        'Segretario': 'business',
        'Project Manager': 'business',
        'Contabile': 'business',
        'Manager': 'business',
        'Direttore Generale': 'business'
    };

    function renderJobListings() {
        const div = $('jobListingsDiv');
        if (!div) return;

        // Check if player has any device to search for jobs
        const hasPhone = game.inventory.devices.phone;
        const hasComputer = game.inventory.devices.computer;
        const hasAnyDevice = hasPhone || hasComputer;

        div.innerHTML = `
            <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; margin-bottom:12px;">
                <h4 style="margin-bottom:12px; color:#667eea;">üì± Come Cercare Lavoro</h4>
                <div style="font-size:0.9rem; line-height:1.6; margin-bottom:12px;">
                    Per cercare lavoro hai bisogno di:
                </div>
                
                <div style="display:grid; gap:10px; margin-bottom:16px;">
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid #ffd700;">
                        <strong>üì∞ Giornale Locale (‚Ç¨5)</strong><br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra 3 offerte base giornaliere. Disponibile in edicola.</span>
                    </div>
                    
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid ${hasPhone ? '#38ef7d' : '#666'};">
                        <strong>üì± Cellulare (‚Ç¨150)</strong> ${hasPhone ? '‚úÖ' : '‚ùå'}<br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra 5 offerte di tutti i livelli.</span>
                    </div>
                    
                    <div style="padding:10px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid ${hasComputer ? '#667eea' : '#666'};">
                        <strong>üíª Computer (‚Ç¨500)</strong> ${hasComputer ? '‚úÖ' : '‚ùå'}<br>
                        <span style="font-size:0.85rem; opacity:0.8;">Mostra tutte le offerte + filtri avanzati.</span>
                    </div>
                </div>

                ${!hasAnyDevice ? `
                    <div style="padding:12px; background:rgba(235,51,73,0.15); border-radius:8px; border:2px solid #eb3349; margin-bottom:12px;">
                        <strong style="color:#eb3349;">‚ö†Ô∏è Non hai dispositivi!</strong><br>
                        <span style="font-size:0.85rem;">Vai al negozio di elettronica per comprare un cellulare o un PC, oppure compra il giornale in edicola (‚Ç¨5).</span>
                    </div>
                ` : ''}

                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button onclick="showJobSearchDialog('newspaper')" class="action-btn" style="flex:1; min-width:120px;">
                        üì∞ Compra Giornale (‚Ç¨5)
                    </button>
                    ${hasPhone ? `
                        <button onclick="showJobSearchDialog('phone')" class="action-btn" style="flex:1; min-width:120px; background:var(--success);">
                            üì± Cerca con Cellulare
                        </button>
                    ` : ''}
                    ${hasComputer ? `
                        <button onclick="showJobSearchDialog('computer')" class="action-btn" style="flex:1; min-width:120px; background:var(--primary);">
                            üíª Cerca con PC
                        </button>
                    ` : ''}
                    <button onclick="showElectronicsShop()" class="action-btn" style="flex:1; min-width:120px; background:#ff8c00;">
                        üõí Negozio Elettronica
                    </button>
                </div>
            </div>
        `;
    }

    function showJobSearchDialog(method) {
        let cost = 0;
        let jobsToShow = [];
        let title = '';
        let description = '';

        if (method === 'newspaper') {
            cost = 5;
            title = 'üì∞ Giornale Locale - Offerte Lavoro';
            description = 'Annunci base della settimana';
            // Show 3 random basic jobs
            const basicJobs = game.jobListings.filter(j => j.reqRep <= 20);
            jobsToShow = basicJobs.sort(() => Math.random() - 0.5).slice(0, 3);
            
            if (!canAfford(cost)) {
                showNotification('‚ùå Non hai abbastanza soldi per il giornale (‚Ç¨5)', 3000);
                return;
            }
            payMoney(cost);
            showNotification('üì∞ Hai comprato il giornale locale!', 2000);
            
        } else if (method === 'phone') {
            if (!game.inventory.devices.phone) {
                showNotification('‚ùå Non hai un cellulare!', 2000);
                return;
            }
            title = 'üì± Ricerca Online - Annunci Lavoro';
            description = 'Offerte trovate su portali online';
            // Show 5 jobs of various levels
            jobsToShow = game.jobListings.sort(() => Math.random() - 0.5).slice(0, 5);
            
        } else if (method === 'computer') {
            if (!game.inventory.devices.computer) {
                showNotification('‚ùå Non hai un computer!', 2000);
                return;
            }
            title = 'üíª Ricerca Avanzata - Tutte le Offerte';
            description = 'Database completo con filtri avanzati';
            // Show all jobs
            jobsToShow = game.jobListings;
        }

        let html = `
            <div class="modal-section info">
                <div class="modal-section-title">‚ÑπÔ∏è Informazioni</div>
                <div class="modal-section-content">${description}</div>
            </div>
            
            <div class="modal-section" style="border-left-color:#667eea;">
                <div class="modal-section-title">üíº Offerte Disponibili (${jobsToShow.length})</div>
                <div class="modal-section-content" style="max-height:50vh; overflow-y:auto;">
                    ${jobsToShow.map(j => {
                        const jobLocation = j.location || 'centro_storico';
                        const locationName = NEIGHBORHOODS[jobLocation] ? NEIGHBORHOODS[jobLocation].name : jobLocation;
                        const travelInfo = calculateTravelTime(jobLocation);
                        const canApply = game.player.rep >= j.reqRep;
                        
                        return `
                            <div style="padding:14px; background:${canApply ? 'rgba(102,126,234,0.12)' : 'rgba(255,255,255,0.03)'}; border-radius:10px; margin-bottom:12px; border:2px solid ${canApply ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}; transition:all 0.3s;" 
                                onmouseover="this.style.background='${canApply ? 'rgba(102,126,234,0.18)' : 'rgba(255,255,255,0.05)'}'" 
                                onmouseout="this.style.background='${canApply ? 'rgba(102,126,234,0.12)' : 'rgba(255,255,255,0.03)'}'">
                                <div style="display:flex; justify-content:space-between; align-items:start; gap:12px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; font-size:1.15rem; margin-bottom:8px; color:${canApply ? '#667eea' : '#888'};">${j.name}</div>
                                        
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85rem; margin-bottom:8px;">
                                            <div>üëî <strong>Manager:</strong> ${j.manager}</div>
                                            <div>üìç <strong>Sede:</strong> ${locationName}</div>
                                            <div>‚è∞ <strong>Orario:</strong> ${j.hours.start}:00-${j.hours.end}:00</div>
                                            <div>üí∞ <strong>Stipendio:</strong> ‚Ç¨${j.salary}/giorno</div>
                                        </div>
                                        
                                        <div style="font-size:0.8rem; padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:8px;">
                                            üìã <strong>Mansioni:</strong> ${j.tasks.join(' ‚Ä¢ ')}
                                        </div>
                                        
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:0.75rem;">
                                            <span style="padding:4px 8px; background:${canApply ? 'rgba(56,239,125,0.2)' : 'rgba(235,51,73,0.2)'}; border-radius:4px;">
                                                üåü Reputazione: ${j.reqRep} ${canApply ? '‚úì' : '‚úó'}
                                            </span>
                                            ${travelInfo.time > 0 ? `
                                                <span style="padding:4px 8px; background:rgba(255,215,0,0.15); border-radius:4px;">
                                                    üö∂ Viaggio: ${travelInfo.time}h ‚Ä¢ ‚Ç¨${travelInfo.cost} ‚Ä¢ ‚ö°${travelInfo.energy}%
                                                </span>
                                            ` : '<span style="padding:4px 8px; background:rgba(56,239,125,0.15); border-radius:4px;">‚úì Sotto casa</span>'}
                                        </div>
                                    </div>
                                    <button onclick="startJobInterview('${j.id}'); closeDialog();" 
                                            ${!canApply ? 'disabled' : ''}
                                            style="min-width:100px; padding:10px 16px; border-radius:8px; font-weight:600;">
                                        ${canApply ? 'üí¨ Colloquio' : 'üîí Bloccato'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;

        showDialog(html, title, true);
    }

    function showElectronicsShop() {
        const hasPhone = game.inventory.devices.phone;
        const hasComputer = game.inventory.devices.computer;
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;">üõí Negozio di Elettronica</h3>
                <p style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">Acquista dispositivi per migliorare la tua vita quotidiana</p>
                
                <div style="display:grid; gap:16px;">
                    <!-- Cellulare -->
                    <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; border:2px solid ${hasPhone ? '#38ef7d' : '#667eea'};">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                            <div>
                                <h4 style="font-size:1.2rem; margin-bottom:8px;">üì± Smartphone</h4>
                                <div style="font-size:0.9rem; opacity:0.9; line-height:1.6;">
                                    <strong>Funzioni:</strong><br>
                                    ‚Ä¢ Cerca lavoro online (5 offerte)<br>
                                    ‚Ä¢ Chiama taxi/Uber pi√π velocemente<br>
                                    ‚Ä¢ Accesso a social media e app<br>
                                    ‚Ä¢ Gestione appuntamenti
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#ffd700;">‚Ç¨150</div>
                            </div>
                        </div>
                        ${hasPhone ? `
                            <div style="padding:10px; background:rgba(56,239,125,0.2); border-radius:8px; text-align:center; color:#38ef7d; font-weight:bold;">
                                ‚úÖ GI√Ä ACQUISTATO
                            </div>
                        ` : `
                            <button onclick="buyDevice('phone')" class="action-btn" style="width:100%; background:var(--success);">
                                üí≥ Acquista Cellulare
                            </button>
                        `}
                    </div>

                    <!-- Computer -->
                    <div style="padding:16px; background:rgba(255,255,255,0.06); border-radius:12px; border:2px solid ${hasComputer ? '#38ef7d' : '#667eea'};">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                            <div>
                                <h4 style="font-size:1.2rem; margin-bottom:8px;">üíª Computer Desktop</h4>
                                <div style="font-size:0.9rem; opacity:0.9; line-height:1.6;">
                                    <strong>Funzioni:</strong><br>
                                    ‚Ä¢ Cerca lavoro con filtri avanzati (tutte le offerte)<br>
                                    ‚Ä¢ Lavoro freelance da casa<br>
                                    ‚Ä¢ Trading online potenziato<br>
                                    ‚Ä¢ Corsi online e formazione<br>
                                    ‚Ä¢ Sviluppo software e progetti personali
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#ffd700;">‚Ç¨500</div>
                            </div>
                        </div>
                        ${hasComputer ? `
                            <div style="padding:10px; background:rgba(56,239,125,0.2); border-radius:8px; text-align:center; color:#38ef7d; font-weight:bold;">
                                ‚úÖ GI√Ä ACQUISTATO
                            </div>
                        ` : `
                            <button onclick="buyDevice('computer')" class="action-btn" style="width:100%; background:var(--primary);">
                                üí≥ Acquista Computer
                            </button>
                        `}
                    </div>
                </div>

                <div style="margin-top:20px; padding:12px; background:rgba(255,215,0,0.1); border-radius:8px; border-left:4px solid #ffd700;">
                    <div style="font-size:0.9rem;">
                        <strong>üí∞ Il tuo denaro:</strong><br>
                        üíµ Contante: ‚Ç¨${game.player.cash.toFixed(0)}<br>
                        üè¶ Banca: ‚Ç¨${game.player.bankDeposit.toFixed(0)}
                    </div>
                </div>
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;

        showDialog(html);
    }

    function buyDevice(deviceType) {
        const prices = { phone: 150, computer: 500 };
        const names = { phone: 'Cellulare', computer: 'Computer' };
        const price = prices[deviceType];
        const name = names[deviceType];

        if (game.inventory.devices[deviceType]) {
            showNotification(`‚úÖ Hai gi√† un ${name}!`, 2000);
            return;
        }

        if (!canAfford(price)) {
            showNotification(`‚ùå Non hai abbastanza soldi per il ${name} (‚Ç¨${price})`, 3000);
            return;
        }

        payMoney(price);
        game.inventory.devices[deviceType] = true;
        showNotification(`‚úÖ Hai acquistato un ${name}! Ora puoi cercare lavoro online.`, 4000);
        
        // Close and reopen the shop to update UI
        closeDialog();
        setTimeout(() => showElectronicsShop(), 300);
    }

    function startJobInterview(jobId) {
        const job = game.jobListings.find(j => j.id === jobId);
        if (!job) return;

        if (game.player.rep < job.reqRep) {
            showNotification('Reputazione insufficiente!', 1500);
            return;
        }

        // Create temporary NPC for manager
        const managerNpc = {
            id: 'manager_' + jobId,
            name: job.manager,
            job: 'Manager di ' + job.name,
            personality: job.managerPersonality,
            mood: 'professionale',
            location: 'Ufficio',
            relation: 50, // Neutral starting point for interview
            conversationStyle: getConversationStyle(job.managerPersonality),
            isInterviewing: true,
            interviewFor: job
        };

        // Store interview data
        game.currentInterview = {
            job: job,
            manager: managerNpc,
            started: true
        };

        // Add manager temporarily to NPCs list if not exists
        if (!game.npcs.find(n => n.id === managerNpc.id)) {
            game.npcs.push(managerNpc);
        }

        // Open dialogue with manager (NEW SYSTEM)
        showNotification(`üíº Colloquio per ${job.name}`, 2000);
        setTimeout(() => {
            openDialogue(managerNpc.id);
        }, 500);
    }

    function applyJob(jobId) {
        // Redirect to interview system
        startJobInterview(jobId);
    }

    function updateWorkStatus() {
        const div = $('workStatusDiv');
        if (!div) return;

        if (game.player.job === 'Disoccupato') {
            div.innerHTML = '<p style="opacity:0.7;">Attualmente disoccupato. Cerca un lavoro e fai un colloquio!</p>';
        } else {
            const currentHour = game.time.hour;
            const jobData = game.workData.currentJob;
            const isWorkHours = jobData && currentHour >= jobData.hours.start && currentHour < jobData.hours.end;
            const canWork = isWorkHours && !game.workData.todayWorked;
            
            // Get career path info
            const careerPath = game.workData.careerPath;
            const careerLevel = game.workData.careerLevel || 0;
            let careerInfo = '';
            let nextLevelInfo = '';
            
            if (careerPath && CAREER_PATHS[careerPath]) {
                const career = CAREER_PATHS[careerPath];
                const currentLevel = career.levels[careerLevel];
                careerInfo = `üéØ Percorso: ${career.name} | Livello ${careerLevel + 1}/${career.levels.length}`;
                
                if (careerLevel + 1 < career.levels.length) {
                    const nextLevel = career.levels[careerLevel + 1];
                    const skills = game.player.skills || {};
                    const reqs = nextLevel.requirements;
                    
                    // Check which requirements are met
                    const reqCheck = [];
                    if (reqs.intellect) reqCheck.push(`Int:${skills.intellect||0}/${reqs.intellect}${(skills.intellect||0)>=reqs.intellect?'‚úì':'‚ùå'}`);
                    if (reqs.charisma) reqCheck.push(`Car:${skills.charisma||0}/${reqs.charisma}${(skills.charisma||0)>=reqs.charisma?'‚úì':'‚ùå'}`);
                    if (reqs.creativity) reqCheck.push(`Cre:${skills.creativity||0}/${reqs.creativity}${(skills.creativity||0)>=reqs.creativity?'‚úì':'‚ùå'}`);
                    if (reqs.fitness) reqCheck.push(`Fit:${skills.fitness||0}/${reqs.fitness}${(skills.fitness||0)>=reqs.fitness?'‚úì':'‚ùå'}`);
                    if (reqs.performance) reqCheck.push(`Perf:${game.workData.performance}%/${reqs.performance}%${game.workData.performance>=reqs.performance?'‚úì':'‚ùå'}`);
                    if (reqs.managerRelation) reqCheck.push(`Mgr:${game.workData.managerRelation}/${reqs.managerRelation}${game.workData.managerRelation>=reqs.managerRelation?'‚úì':'‚ùå'}`);
                    
                    nextLevelInfo = `
                        <div style="margin-top:12px; padding:10px; background:rgba(102,126,234,0.1); border-radius:8px; border-left:3px solid var(--primary);">
                            <div style="font-weight:bold; font-size:0.95rem; margin-bottom:6px;">üìà Prossima Promozione: ${nextLevel.title} (‚Ç¨${nextLevel.salary}/giorno)</div>
                            <div style="font-size:0.85rem; opacity:0.9;">
                                Requisiti: ${reqCheck.join(' | ')}
                            </div>
                            <div style="margin-top:6px;">
                                <div style="font-size:0.8rem; opacity:0.8;">Progresso Promozione</div>
                                <div class="stat-bar" style="margin-top:4px;">
                                    <div class="stat-fill ${(game.workData.promotionProgress||0) >= 75 ? 'high' : (game.workData.promotionProgress||0) >= 40 ? 'medium' : 'low'}" 
                                         style="width:${game.workData.promotionProgress||0}%">
                                        ${game.workData.promotionProgress||0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px; border-left:3px solid var(--success);">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:1.2rem;">${game.player.job}</div>
                            <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                                üëî Manager: ${jobData ? jobData.manager : 'N/A'}<br>
                                ‚è∞ Orario: ${jobData ? `${jobData.hours.start}:00 - ${jobData.hours.end}:00` : 'N/A'}<br>
                                üí∞ Stipendio: ‚Ç¨${game.player.jobSalary}/giorno<br>
                                üìä Performance: <span style="color:${game.workData.performance>=80?'#38ef7d':game.workData.performance>=60?'#ffd700':'#eb3349'}">${game.workData.performance}%</span><br>
                                üíô Relazione Manager: <span style="color:${game.workData.managerRelation>=70?'#38ef7d':game.workData.managerRelation>=40?'#ffd700':'#eb3349'}">${game.workData.managerRelation}/100</span>
                                ${game.workData.warnings > 0 ? `<br>‚ö†Ô∏è Avvertimenti: ${game.workData.warnings}/3` : ''}
                            </div>
                            ${careerInfo ? `<div style="font-size:0.85rem; opacity:0.9; margin-top:6px;">${careerInfo}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.85rem; opacity:0.8;">Giorni Lavorati</div>
                            <div style="font-weight:bold; font-size:1.5rem; color:var(--primary);">${game.workData.daysWorked || 0}</div>
                        </div>
                    </div>
                    
                    ${nextLevelInfo}

                    ${!isWorkHours ? `
                        <div style="padding:10px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:10px; text-align:center;">
                            ‚è∞ Fuori orario lavorativo (${jobData.hours.start}:00-${jobData.hours.end}:00)
                        </div>
                    ` : ''}

                    ${game.workData.todayWorked ? `
                        <div style="padding:10px; background:rgba(56,239,125,0.15); border-radius:8px; margin-bottom:10px; text-align:center;">
                            ‚úÖ Hai gi√† lavorato oggi
                        </div>
                    ` : ''}

                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button onclick="doWorkDay()" ${!canWork ? 'disabled' : ''} style="flex:1; min-width:150px;">
                            üíº ${canWork ? 'Inizia Lavoro' : 'Non disponibile'}
                        </button>
                        ${jobData ? `<button class="small" onclick="talkToManager()" style="flex:1; min-width:120px;">üí¨ Parla con Manager</button>` : ''}
                        ${checkPromotionEligibility() && (game.workData.promotionProgress || 0) >= 100 ? `
                            <button class="small" onclick="attemptPromotion()" style="flex:1; min-width:140px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                üéØ Richiedi Promozione
                            </button>
                        ` : ''}
                    </div>

                    ${game.workData.workEvents.length > 0 ? `
                        <div style="margin-top:12px;">
                            <h5 style="margin-bottom:6px;">üì∞ Eventi Recenti</h5>
                            ${game.workData.workEvents.slice(-3).map(e => `
                                <div style="font-size:0.85rem; opacity:0.8; padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px;">
                                    ${e}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    }

    // ---------- PEOPLE & SOCIAL ----------
    function renderKnownPeople() {
        const list = $('knownPeopleList');
        if (!list) return;

        // Filtra solo NPCs conosciuti (known = true)
        const knownNpcs = game.npcs.filter(npc => npc.known === true);

        if (knownNpcs.length === 0) {
            list.innerHTML = `
                <div style="padding:20px; text-align:center; opacity:0.7;">
                    <div style="font-size:2rem; margin-bottom:8px;">üë•</div>
                    <div>Non conosci ancora nessuno.</div>
                    <div style="font-size:0.85rem; margin-top:8px;">Esci in citt√†, frequenta i luoghi e incontra persone!</div>
                </div>
            `;
            return;
        }

        list.innerHTML = knownNpcs.map(npc => `
            <div class="npc-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">üë§ ${npc.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">${npc.job} | Relazione: ${npc.relation}/100</div>
                        ${npc.location ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:2px;">üìç ${npc.location}</div>` : ''}
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button class="small" onclick="openDialogue('${npc.id}')">üí¨ Parla</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function talkTo(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;

        npc.relation = clamp(npc.relation + randInt(3, 8));
        game.player.stats.morale = clamp(game.player.stats.morale + 5);
        
        passTime(1);
        showNotification(`Hai parlato con ${npc.name}. Relazione: ${npc.relation}/100`, 1800);
        updateUI();
        checkQuests();
    }

    // ---------- ACTIONS ----------
    function getActionDetails(actionName) {
        const act = ACTIONS[actionName];
        if (!act) return '';

        let details = `<div style="font-size:0.9rem;">`;
        details += `üí∞ Costo: ‚Ç¨${act.cost || 0}<br>`;
        details += `‚è±Ô∏è Tempo: ${act.time}h<br>`;
        
        if (act.effects) {
            details += `<br><strong>Effetti:</strong><br>`;
            Object.keys(act.effects).forEach(stat => {
                const value = act.effects[stat];
                const icon = {hunger: 'üçî', energy: '‚ö°', morale: 'üòä', health: '‚ù§Ô∏è'}[stat] || 'üìä';
                details += `${icon} ${stat}: ${value > 0 ? '+' : ''}${value}%<br>`;
            });
        }

        if (act.skills) {
            details += `<br><strong>Skills:</strong><br>`;
            Object.keys(act.skills).forEach(skill => {
                const value = act.skills[skill];
                details += `üìà ${skill}: +${value}<br>`;
            });
        }

        details += `</div>`;
        return details;
    }

    function action(actionName) {
        const act = ACTIONS[actionName];
        if (!act) {
            showNotification('Azione non disponibile', 1200);
            return;
        }

        // Block home actions if homeless
        const homeActions = ['shower', 'sleep', 'nap', 'clean', 'cook'];
        if (homeActions.includes(actionName) && game.player.isHomeless) {
            showNotification('üèöÔ∏è Sei senzatetto! Non puoi fare questa azione. Trova una casa!', 3000);
            return;
        }

        // Special handling for food-based actions
        if (actionName === 'eat') {
            if (game.inventory.food.length === 0) {
                showNotification('üçΩÔ∏è Non hai cibo! Vai al supermercato.', 2000);
                return;
            }
            // Open food inventory to choose what to eat
            switchMainTab('shop');
            showNotification('Scegli cosa mangiare dal tuo inventario', 1500);
            return;
        }

        if (actionName === 'cook') {
            cookFood();
            return;
        }

        if (act.cost > 0 && !canAfford(act.cost)) {
            showNotification('üí∞ Non hai abbastanza soldi!', 1500);
            return;
        }
        
        // Check energy for skill-based activities
        if (act.skills && Object.keys(act.skills).length > 0) {
            const energy = game.player.stats.energy;
            
            // Reset daily training counter if new day
            if (game.player.lastTrainingDay !== game.time.day) {
                game.player.dailyTraining = 0;
                game.player.lastTrainingDay = game.time.day;
            }
            
            // Limit training activities per day (max 3)
            if (game.player.dailyTraining >= 3) {
                showNotification('‚ö†Ô∏è Hai gi√† fatto 3 attivit√† di apprendimento oggi! Il corpo e la mente hanno bisogno di riposo.', 3000);
                return;
            }
            
            if (energy < 20) {
                showNotification('‚ö†Ô∏è Sei troppo stanco! Riposa prima di studiare/allenarti. Rischi risultati negativi!', 3000);
                return;
            } else if (energy < 40) {
                if (!confirm('‚ö†Ô∏è Hai poca energia. L\'apprendimento sar√† molto ridotto. Continuare comunque?')) {
                    return;
                }
            } else if (energy < 60) {
                showNotification('üí° Energia media: l\'apprendimento sar√† ridotto del 40%', 2000);
            }
            
            // Increment daily training counter
            game.player.dailyTraining++;
        }

        // Apply effects
        if (act.cost > 0 && !payMoney(act.cost)) {
            showNotification('‚ùå Fondi insufficienti!', 2000);
            return;
        }
        
        if (act.effects) {
            Object.keys(act.effects).forEach(stat => {
                if (game.player.stats[stat] !== undefined) {
                    game.player.stats[stat] = clamp(game.player.stats[stat] + act.effects[stat]);
                }
            });
        }

        if (act.skills) {
            const skillGains = [];
            Object.keys(act.skills).forEach(skill => {
                const oldValue = game.player.skills[skill] || 0;
                
                // Cap at 100
                if (oldValue >= 100) {
                    const skillName = skill.charAt(0).toUpperCase() + skill.slice(1);
                    skillGains.push(`‚ö†Ô∏è ${skillName} gi√† al massimo (100)`);
                    return;
                }
                
                let gain = act.skills[skill];
                
                // Apply fatigue penalty based on daily training count
                const fatigueMultiplier = [1.0, 0.8, 0.5][game.player.dailyTraining - 1] || 0.5;
                gain = Math.floor(gain * fatigueMultiplier);
                
                if (game.player.dailyTraining > 1) {
                    const fatigueMessages = {
                        2: '(fatica leggera)',
                        3: '(fatica elevata)'
                    };
                    if (fatigueMultiplier < 1.0) {
                        skillGains.push(`üí§ ${fatigueMessages[game.player.dailyTraining] || ''}`);
                    }
                }
                
                // Reduce gain based on energy - low energy = reduced learning
                const energyFactor = game.player.stats.energy / 100;
                if (energyFactor < 0.3) {
                    // Very low energy: negative effect!
                    gain = Math.floor(gain * -0.5);
                    skillGains.push(`‚ö†Ô∏è Troppo stanco! Prestazione negativa`);
                } else if (energyFactor < 0.5) {
                    // Low energy: much reduced gain
                    gain = Math.floor(gain * 0.3);
                } else if (energyFactor < 0.7) {
                    // Medium energy: reduced gain
                    gain = Math.floor(gain * 0.6);
                }
                
                const newValue = Math.min(100, oldValue + gain);
                game.player.skills[skill] = newValue;
                
                // Check for level up
                const oldLevel = getSkillLevel(oldValue);
                const newLevel = getSkillLevel(newValue);
                
                // Create skill gain notification
                const skillEmojis = {
                    intellect: 'üß†',
                    fitness: 'üí™',
                    creativity: 'üé®',
                    charisma: 'üí¨'
                };
                const emoji = skillEmojis[skill] || 'üìà';
                const skillName = skill.charAt(0).toUpperCase() + skill.slice(1);
                
                if (oldLevel !== newLevel) {
                    // Level up! Show special notification
                    skillGains.push(`${emoji} ${skillName}: ${newLevel}! üéâ`);
                } else if (gain > 0) {
                    skillGains.push(`${emoji} +${gain} ${skillName}`);
                } else if (gain < 0) {
                    skillGains.push(`${emoji} ${gain} ${skillName} (stanchezza)`);
                }
            });
            
            // Show skill gains in notification after main message
            if (skillGains.length > 0) {
                setTimeout(() => {
                    showNotification(skillGains.join(' | '), 2500);
                }, 1600);
            }
        }

        // Special actions
        if (actionName === 'work' && game.player.job !== 'Disoccupato') {
            const salary = game.player.jobSalary || 50;
            earnMoney(salary); // Salary goes to cash
            game.player.totalEarned = (game.player.totalEarned || 0) + salary;
            game.player.rep = clamp(game.player.rep + 2, 0, 100);
            showNotification(`${act.msg} Hai guadagnato ‚Ç¨${salary}!`, 2000);
        } else if (actionName === 'meet_new') {
            triggerRandomEncounter();
        } else {
            // Determine if action requires travel
            let destinationQuarterId = ACTION_LOCATIONS[actionName];

            if (destinationQuarterId === 'home') {
                destinationQuarterId = game.housing.neighborhood;
            } else if (destinationQuarterId === 'job_location' && game.workData.currentJob) {
                destinationQuarterId = game.workData.currentJob.location;
            } else if (destinationQuarterId === 'current') {
                destinationQuarterId = game.cityMap.currentLocation;
            }

            if (destinationQuarterId && destinationQuarterId !== game.cityMap.currentLocation) {
                const travelInfo = calculateTravelTime(destinationQuarterId);
                if (travelInfo.time > 0) {
                    // Check if player has enough money and energy
                    if (game.player.money < travelInfo.cost) {
                        showNotification(`üí∞ Non hai abbastanza soldi per il viaggio! Serve: ‚Ç¨${travelInfo.cost}`, 2500);
                        return;
                    }
                    
                    if (game.player.stats.energy < travelInfo.energy) {
                        showNotification(`‚ö° Non hai abbastanza energia per il viaggio! Serve: ${travelInfo.energy}%`, 2500);
                        return;
                    }
                    
                    // Apply travel costs
                    if (travelInfo.cost > 0 && !payMoney(travelInfo.cost)) {
                        showNotification('‚ùå Non hai abbastanza soldi per viaggiare!', 2000);
                        return;
                    }
                    game.player.stats.energy = clamp(game.player.stats.energy - travelInfo.energy);
                    
                    const vehicleUsed = game.vehicles.active || 'walk';
                    const vehicleEmoji = VEHICLES[vehicleUsed] ? VEHICLES[vehicleUsed].emoji : 'üö∂';
                    
                    showNotification(`${vehicleEmoji} Viaggio verso ${NEIGHBORHOODS[destinationQuarterId].name}... (${travelInfo.time}h, ‚Ç¨${travelInfo.cost})`, 2500);
                    passTime(travelInfo.time);
                    game.cityMap.currentLocation = destinationQuarterId; // Update player's current location
                }
            }
            
            // Update current building
            if (ACTION_BUILDINGS[actionName]) {
                game.cityMap.currentBuilding = ACTION_BUILDINGS[actionName];
            }

            showNotification(act.msg, 1500);
        }

        passTime(act.time);
        
        // Random encounter chance on city actions (excluding 'home' actions)
        const cityActions = Object.keys(ACTIONS).filter(a => ACTIONS[a].category !== 'casa');
        if (cityActions.includes(actionName)) {
            triggerRandomEncounter();
        }
        updateUI();
        checkRandomEvent();
        checkQuests();
    }

    // ---------- TRAVEL SYSTEM ----------
    function calculateTravelTime(destinationQuarterId, transportMethod = null) {
        const currentQuarterId = game.cityMap.currentLocation;
        if (currentQuarterId === destinationQuarterId) {
            return { time: 0, cost: 0, energy: 0 }; // Already at destination
        }

        const currentQuarter = NEIGHBORHOODS[currentQuarterId];
        const destinationQuarter = NEIGHBORHOODS[destinationQuarterId];

        if (!currentQuarter || !destinationQuarter) {
            console.error('Quartiere non trovato per il calcolo del tempo di viaggio.');
            return { time: 0, cost: 0, energy: 0 };
        }

        // Base travel time (walking)
        let baseTime = currentQuarter.travelTime + destinationQuarter.travelTime;
        let travelTime = baseTime;
        let travelCost = 0;
        let energyCost = baseTime * 3; // Walking is tiring
        
        // Determine transport method
        if (!transportMethod) {
            transportMethod = game.vehicles.active || 'walk';
        }
        
        if (transportMethod === 'walk') {
            // Already calculated above
            travelCost = 0;
        } else if (transportMethod === 'public') {
            // Public transport
            const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
            travelTime = baseTime * 0.5; // 50% faster than walking
            travelCost = hasPass ? 0 : Math.max(2, Math.floor(baseTime * 2));
            energyCost = baseTime * 0.5; // Less tiring
        } else if (VEHICLES[transportMethod]) {
            // Personal vehicle
            const vehicle = VEHICLES[transportMethod];
            travelTime = baseTime * vehicle.speedMultiplier;
            energyCost = travelTime * vehicle.energyCost;
            travelCost = vehicle.fuelCost ? travelTime * vehicle.fuelCost : 0;
        }
        
        return { 
            time: Math.ceil(travelTime), 
            cost: Math.ceil(travelCost), 
            energy: Math.ceil(energyCost) 
        };
    }

    // ---------- TIME ----------
    // Nuova funzione: aggiungi minuti al tempo di gioco
    function addMinutes(minutes) {
        game.time.minute += minutes;
        while (game.time.minute >= 60) {
            game.time.minute -= 60;
            game.time.hour += 1;
        }
        while (game.time.hour >= 24) {
            game.time.hour -= 24;
            game.time.day++;
            dailyEffects();
        }
        // Decadimento naturale ogni ora piena simulata
        // Approssimazione: decadimento per frazioni di ora
        const fractionalHours = minutes / 60;
        game.player.stats.hunger = clamp(game.player.stats.hunger - fractionalHours * 2);
        game.player.stats.energy = clamp(game.player.stats.energy - fractionalHours * 1);
    }

    // Mantiene compatibilit√† con vecchie chiamate che usano ore (pu√≤ essere frazione)
    function passTime(hours) {
        const totalMinutes = Math.round(hours * 60);
        addMinutes(totalMinutes);
    }

    function dailyEffects() {
        // Check rent and tax payments
        checkRentPayment();
        checkTaxPayment();
        
        // Reset daily work
        resetDailyWork();
        
        // Reset weekly work counter on Monday (day % 7 === 1)
        if ((game.time.day - 1) % 7 === 0) {
            game.player.workDaysThisWeek = 0;
            showNotification('üìÖ Nuova settimana lavorativa!', 2000);
        }
        
        // Homeless penalties OR Housing bonuses
        if (game.player.isHomeless || !game.housing.residenceId) {
            game.player.stats.morale = clamp(game.player.stats.morale - 30);
            game.player.stats.health = clamp(game.player.stats.health - 20);
            game.player.stats.energy = clamp(game.player.stats.energy - 15);
            
            // Hygiene penalty (if exists)
            if (game.player.stats.hygiene !== undefined) {
                game.player.stats.hygiene = clamp(game.player.stats.hygiene - 10);
            }
            
            showNotification('üèöÔ∏è Vita da senzatetto: -30 Morale, -20 Salute, -15 Energia', 3000);
            
            // Higher risk of getting fired
            if (game.player.job !== 'Disoccupato' && Math.random() < 0.15) {
                showNotification('üíº Il tuo datore di lavoro ha notato il tuo stato...', 3000);
                game.workData.managerRelation = clamp((game.workData.managerRelation || 50) - 20);
                game.workData.performance = clamp((game.workData.performance || 50) - 15);
            }
        } else if (game.housing.residenceId) {
            // Apply housing bonuses
            const residence = findResidenceById(game.housing.residenceId);
            if (residence && residence.bonuses) {
                const bonuses = residence.bonuses;
                if (bonuses.energy > 0) game.player.stats.energy = clamp(game.player.stats.energy + bonuses.energy);
                if (bonuses.morale > 0) game.player.stats.morale = clamp(game.player.stats.morale + bonuses.morale);
                if (bonuses.hygiene > 0 && game.player.stats.hygiene !== undefined) {
                    game.player.stats.hygiene = clamp(game.player.stats.hygiene + bonuses.hygiene);
                }
                if (bonuses.health > 0) game.player.stats.health = clamp(game.player.stats.health + bonuses.health);
                if (bonuses.stressReduction > 0) {
                    game.player.stats.stress = Math.max(0, (game.player.stats.stress || 0) - bonuses.stressReduction);
                }
                
                // Show notification for significant bonuses
                if (bonuses.energy >= 10 || bonuses.morale >= 8) {
                    showNotification(`üè† La tua casa ti d√† energia! +${bonuses.energy} ‚ö°, +${bonuses.morale} üòä`, 2000);
                }
            }
        }
        
        // Check for work absence penalties
        if (game.player.job !== 'Disoccupato' && !isWeekend(game.time.day)) {
            if (!game.workData.todayWorked && game.player.lastWorkDay !== game.time.day) {
                game.player.absences = (game.player.absences || 0) + 1;
                game.workData.managerRelation = clamp((game.workData.managerRelation || 50) - 15);
                game.workData.performance = clamp((game.workData.performance || 50) - 10);
                game.player.rep = Math.max(0, game.player.rep - 5);
                
                showNotification(`‚ö†Ô∏è Assenza ingiustificata! Penalit√†: -15 rapporto manager, -10 performance, -5 reputazione`, 4000);
                
                // Fire after 3 consecutive absences
                if (game.player.absences >= 3) {
                    showNotification('üö´ SEI STATO LICENZIATO per troppe assenze!', 5000);
                    game.player.job = 'Disoccupato';
                    game.player.jobSalary = 0;
                    game.player.absences = 0;
                    game.workData = {
                        currentJob: null,
                        todayWorked: false,
                        tasksCompleted: 0,
                        performance: 50,
                        manager: null,
                        workEvents: [],
                        careerPath: null,
                        careerLevel: 0,
                        daysWorked: 0,
                        managerRelation: 50,
                        warnings: 0,
                        promotionProgress: 0,
                        lastPerformanceReview: 0
                    };
                }
            } else if (game.workData.todayWorked) {
                // Reset absence counter if went to work
                game.player.absences = 0;
            }
        }
        
        // Daily crime events based on neighborhood safety
        checkDailyCrimeEvent();
        
        // Monthly savings interest (every 30 days)
        if (game.time.day % 30 === 0) {
            applySavingsInterest();
        }

        // Monthly property income (every 30 days)
        if (game.time.day % 30 === 0) {
            collectPropertyIncome();
            collectBusinessIncome();
        }
        
        // Monthly vehicle maintenance (every 30 days)
        if (game.time.day % 30 === 0) {
            payVehicleMaintenance();
        }

        // Update company performance and stock prices daily
        updateCompanyPerformance();
        updateStockPrices();

        // Reduce wanted level slowly over time
        if (game.crime.wanted > 0 && Math.random() < 0.1) {
            game.crime.wanted = Math.max(0, game.crime.wanted - 0.5);
        }
        
        // Daily hunger decay if no housing quality bonus
        if (game.housing) {
            const hood = NEIGHBORHOODS[game.housing.neighborhood];
            const qualityBonus = Math.floor(hood.quality / 20);
            game.player.stats.morale = clamp(game.player.stats.morale + qualityBonus - 2);
        }
        
        // Check critical health status and debt
        checkCriticalStatus();
        
        // Monthly loan payments
        if (game.time.day % 30 === 0) {
            processLoanPayments();
        }
        
        checkRandomEvent();
    }

    function passHour() {
        passTime(1);
        showNotification('‚è≠Ô∏è Passata 1 ora', 1000);
        updateUI();
    }

    function passDay() {
        passTime(24 - game.time.hour + 8); // Skip to 8 AM next day
        showNotification('üìÖ Nuovo giorno!', 1200);
        updateUI();
    }

    // ========================================
    // TIME CONTROL SYSTEM
    // ========================================
    
    function toggleTimePause() {
        if (!game.timeControl) {
            game.timeControl = { isPaused: true, speed: 1, lastTick: Date.now() };
        }
        
        game.timeControl.isPaused = !game.timeControl.isPaused;
        
        const btn = $('timePlayPauseBtn');
        if (btn) {
            btn.innerHTML = game.timeControl.isPaused ? '‚ñ∂Ô∏è Play' : '‚è∏Ô∏è Pause';
        }
        
        showNotification(game.timeControl.isPaused ? '‚è∏Ô∏è Tempo in pausa' : '‚ñ∂Ô∏è Tempo in movimento', 1200);
    }
    
    function cycleTimeSpeed() {
        if (!game.timeControl) {
            game.timeControl = { isPaused: true, speed: 1, lastTick: Date.now() };
        }
        
        const speeds = [1, 2, 5, 10];
        const currentIndex = speeds.indexOf(game.timeControl.speed);
        const nextIndex = (currentIndex + 1) % speeds.length;
        game.timeControl.speed = speeds[nextIndex];
        
        const btn = $('timeSpeedBtn');
        if (btn) {
            btn.innerHTML = `‚ö° ${game.timeControl.speed}x`;
        }
        
        showNotification(`‚ö° Velocit√†: ${game.timeControl.speed}x`, 1200);
    }
    
    // Game loop - avanza tempo automaticamente
    let gameLoopInterval = null;
    
    function startGameLoop() {
        if (gameLoopInterval) return; // Gi√† in esecuzione
        
        gameLoopInterval = setInterval(() => {
            if (!game.timeControl || game.timeControl.isPaused) return;

            // Avanza minuto per minuto in base alla velocit√†
            // Speed 1x = 1 min/sec, 2x = 2 min/sec, ecc.
            addMinutes(game.timeControl.speed);
            checkAppointmentReminders();
            updateUI();
        }, 1000); // Tick ogni secondo reale
    }
    
    function stopGameLoop() {
        if (gameLoopInterval) {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
        }
    }

    // ========================================
    // AGENDA SYSTEM
    // ========================================
    
    function showAddAppointmentDialog() {
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        
        const html = `
            <div style="padding:24px; max-width:500px;">
                <h3 style="margin-bottom:16px;">üìÖ Nuovo Appuntamento</h3>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;">üìÜ Giorno</label>
                    <input type="number" id="apptDay" min="${currentDay}" value="${currentDay}" 
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
                
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px; margin-bottom:12px;">
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;">‚è∞ Ora (0-23)</label>
                        <input type="number" id="apptHour" min="0" max="23" value="${Math.min(currentHour + 1, 23)}" 
                               style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:4px; font-size:0.9rem;">‚è±Ô∏è Minuti</label>
                        <input type="number" id="apptMinute" min="0" max="59" value="0" 
                               style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                    </div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;">üè∑Ô∏è Tipo</label>
                    <select id="apptType" style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                        <option value="work">üíº Lavoro</option>
                        <option value="social">ü§ù Sociale</option>
                        <option value="personal">üë§ Personale</option>
                        <option value="health">‚ù§Ô∏è Salute</option>
                        <option value="other">üìù Altro</option>
                    </select>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;">üìù Titolo</label>
                    <input type="text" id="apptTitle" placeholder="Es: Riunione, Cena con amici..." 
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white;">
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="display:block; margin-bottom:4px; font-size:0.9rem;">üìÑ Descrizione (opzionale)</label>
                    <textarea id="apptDescription" rows="3" placeholder="Dettagli aggiuntivi..."
                           style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:6px; color:white; resize:vertical;"></textarea>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:20px;">
                    <button onclick="createAppointment()" style="flex:1; padding:10px; background:var(--success); border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">
                        ‚úì Crea Appuntamento
                    </button>
                    <button onclick="closeModal()" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; color:white; cursor:pointer;">
                        ‚úï Annulla
                    </button>
                </div>
            </div>
        `;
        
        showModal(html);
    }
    
    function createAppointment() {
        const day = parseInt($('apptDay').value);
        const hour = parseInt($('apptHour').value);
        const minute = parseInt($('apptMinute').value) || 0;
        const type = $('apptType').value;
        const title = $('apptTitle').value.trim();
        const description = $('apptDescription').value.trim();
        
        if (!title) {
            showNotification('‚ùå Inserisci un titolo per l\'appuntamento!', 2000);
            return;
        }
        
        // Check if appointment is in the past
        const isPast = day < game.time.day || 
                      (day === game.time.day && hour < game.time.hour) ||
                      (day === game.time.day && hour === game.time.hour && minute < game.time.minute);
        
        if (isPast) {
            showNotification('‚ùå Non puoi creare un appuntamento nel passato!', 2000);
            return;
        }
        
        const appointment = {
            id: Date.now() + Math.random(),
            day: day,
            hour: hour,
            minute: minute,
            type: type,
            title: title,
            description: description,
            notified: false,
            created: game.time.day
        };
        
        game.agenda.appointments.push(appointment);
        game.agenda.appointments.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            if (a.hour !== b.hour) return a.hour - b.hour;
            return (a.minute || 0) - (b.minute || 0);
        });
        
        closeModal();
        const timeStr = formatTime(hour, minute);
        showNotification(`‚úì Appuntamento creato: ${title} (Giorno ${day} alle ${timeStr})`, 3000);
        updateUI();
    }
    
    function renderAgenda() {
        // Update current day/hour display
        if ($('agendaCurrentDay')) $('agendaCurrentDay').innerText = game.time.day;
        if ($('agendaCurrentHour')) $('agendaCurrentHour').innerText = (function(){
            const h = game.time.hour % 24;
            const m = game.time.minute || 0;
            const pad = n => (n<10? '0'+n : ''+n);
            return pad(h)+ ':' + pad(m);
        })();
        
        if (!game.agenda) {
            game.agenda = { appointments: [], reminders: [] };
        }
        
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        
        // Filtra appuntamenti futuri e passati
        const upcoming = game.agenda.appointments.filter(a => 
            a.day > currentDay || (a.day === currentDay && a.hour >= currentHour)
        );
        
        const past = game.agenda.appointments.filter(a => 
            a.day < currentDay || (a.day === currentDay && a.hour < currentHour)
        );
        
        // Render upcoming appointments
        const upcomingDiv = $('upcomingAppointments');
        if (upcomingDiv) {
            if (upcoming.length === 0) {
                upcomingDiv.innerHTML = `
                    <div style="padding:16px; text-align:center; opacity:0.6;">
                        <div>üìÖ Nessun appuntamento in programma</div>
                    </div>
                `;
            } else {
                upcomingDiv.innerHTML = upcoming.map(appt => {
                    const typeIcons = {
                        work: 'üíº',
                        social: 'ü§ù',
                        personal: 'üë§',
                        health: '‚ù§Ô∏è',
                        other: 'üìù'
                    };
                    const icon = typeIcons[appt.type] || 'üìÖ';
                    
                    const daysUntil = appt.day - currentDay;
                    const apptMinute = appt.minute || 0;
                    const timeStr = formatTime(appt.hour, apptMinute);
                    const timeInfo = daysUntil === 0 
                        ? `Oggi alle ${timeStr}` 
                        : `Tra ${daysUntil} giorni alle ${timeStr}`;
                    
                    return `
                        <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:8px; border-left:3px solid var(--primary); margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div style="flex:1;">
                                    <div style="font-weight:bold; margin-bottom:4px;">${icon} ${appt.title}</div>
                                    <div style="font-size:0.85rem; opacity:0.8;">üìÜ ${timeInfo}</div>
                                    ${appt.description ? `<div style="font-size:0.85rem; opacity:0.7; margin-top:4px;">${appt.description}</div>` : ''}
                                </div>
                                <button class="small" onclick="deleteAppointment('${appt.id}')" style="background:rgba(255,0,0,0.3);">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Render past appointments
        const pastDiv = $('pastAppointments');
        if (pastDiv) {
            if (past.length === 0) {
                pastDiv.innerHTML = `
                    <div style="padding:16px; text-align:center; opacity:0.6;">
                        <div>üìã Nessun appuntamento passato</div>
                    </div>
                `;
            } else {
                pastDiv.innerHTML = past.slice(-10).reverse().map(appt => {
                    const typeIcons = {
                        work: 'üíº',
                        social: 'ü§ù',
                        personal: 'üë§',
                        health: '‚ù§Ô∏è',
                        other: 'üìù'
                    };
                    const icon = typeIcons[appt.type] || 'üìÖ';
                    
                    const apptMinute = appt.minute || 0;
                    const timeStr = formatTime(appt.hour, apptMinute);
                    return `
                        <div style="padding:10px; background:rgba(255,255,255,0.03); border-radius:6px; border-left:2px solid rgba(255,255,255,0.2); margin-bottom:6px; opacity:0.7;">
                            <div style="font-size:0.9rem; font-weight:bold;">${icon} ${appt.title}</div>
                            <div style="font-size:0.8rem; opacity:0.8;">üìÜ Giorno ${appt.day} alle ${timeStr}</div>
                        </div>
                    `;
                }).join('');
            }
        }
    }
    
    function showTodaySchedule() {
        const currentDay = game.time.day;
        const todayAppts = game.agenda.appointments.filter(a => a.day === currentDay);
        
        if (todayAppts.length === 0) {
            showNotification('üìÖ Nessun appuntamento per oggi!', 2000);
            return;
        }
        
        const html = `
            <div style="padding:24px; max-width:500px;">
                <h3 style="margin-bottom:16px;">üìÖ Programma di Oggi (Giorno ${currentDay})</h3>
                
                <div style="max-height:400px; overflow-y:auto;">
                    ${todayAppts.map(appt => {
                        const typeIcons = {
                            work: 'üíº',
                            social: 'ü§ù',
                            personal: 'üë§',
                            health: '‚ù§Ô∏è',
                            other: 'üìù'
                        };
                        const icon = typeIcons[appt.type] || 'üìÖ';
                        const apptMinute = appt.minute || 0;
                        const isPast = appt.hour < game.time.hour || (appt.hour === game.time.hour && apptMinute < game.time.minute);
                        const timeStr = formatTime(appt.hour, apptMinute);
                        
                        return `
                            <div style="padding:14px; background:${isPast ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.08)'}; 
                                        border-radius:8px; margin-bottom:10px; ${isPast ? 'opacity:0.5;' : ''}
                                        border-left:3px solid ${isPast ? 'gray' : 'var(--primary)'};">
                                <div style="display:flex; justify-content:space-between; align-items:start;">
                                    <div>
                                        <div style="font-size:1.4rem; margin-bottom:4px;">${timeStr}</div>
                                        <div style="font-weight:bold; margin-bottom:4px;">${icon} ${appt.title}</div>
                                        ${appt.description ? `<div style="font-size:0.85rem; opacity:0.8;">${appt.description}</div>` : ''}
                                        ${isPast ? '<div style="font-size:0.8rem; color:#999; margin-top:4px;">‚úì Completato</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top:16px;">
                    <button onclick="closeModal()" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; color:white; cursor:pointer;">
                        Chiudi
                    </button>
                </div>
            </div>
        `;
        
        showModal(html);
    }
    
    function deleteAppointment(apptId) {
        game.agenda.appointments = game.agenda.appointments.filter(a => a.id !== apptId);
        showNotification('üóëÔ∏è Appuntamento eliminato', 1500);
        updateUI();
    }
    
    function checkAppointmentReminders() {
        if (!game.agenda || !game.agenda.appointments) return;
        
        const currentDay = game.time.day;
        const currentHour = game.time.hour;
        const currentMinute = game.time.minute || 0;
        
        // Calcola tempo corrente in minuti totali
        const currentTotalMinutes = currentDay * 24 * 60 + currentHour * 60 + currentMinute;
        
        game.agenda.appointments.forEach(appt => {
            const apptMinute = appt.minute || 0;
            const apptTotalMinutes = appt.day * 24 * 60 + appt.hour * 60 + apptMinute;
            
            // Notifica tra 55 e 65 minuti prima (finestra di 10 minuti per non perdere notifica)
            const minutesUntil = apptTotalMinutes - currentTotalMinutes;
            
            if (minutesUntil > 55 && minutesUntil <= 65 && !appt.notified) {
                const typeIcons = {
                    work: 'üíº',
                    social: 'ü§ù',
                    personal: 'üë§',
                    health: '‚ù§Ô∏è',
                    other: 'üìù'
                };
                const icon = typeIcons[appt.type] || 'üìÖ';
                const timeStr = formatTime(appt.hour, apptMinute);
                
                showNotification(`${icon} Promemoria: ${appt.title} alle ${timeStr} (tra ~1 ora)!`, 4000);
                appt.notified = true;
            }
        });
    }
    
    function showSleepUntilDialog() {
        const currentHour = game.time.hour;
        
        let html = `
            <div class="modal-section info">
                <div class="modal-section-title">ÔøΩ Ora Attuale</div>
                <div class="modal-section-content" style="font-size:1.3rem; font-weight:bold; text-align:center; color:#667eea;">
                    ${formatTime(game.time.hour, game.time.minute)}
                </div>
            </div>
        `;
        
        // Add options for specific hours
        const workJob = game.workData?.currentJob;
        
        // Suggest work hours if employed
        if (workJob && workJob.hours) {
            const workStart = workJob.hours.start;
            const travelTime = workJob.location && workJob.location !== game.cityMap.currentLocation ? 
                              calculateTravelTime(workJob.location).time : 0;
            const wakeUpTime = Math.max(6, workStart - travelTime - 1); // Wake up 1h before + travel time
            
            html += `
                <div class="modal-section success">
                    <div class="modal-section-title">üíº Sveglia Ottimizzata per Lavoro</div>
                    <div class="modal-section-content">
                        <div style="margin-bottom:12px; line-height:1.6;">
                            üìÖ Inizio turno: <strong>${workStart}:00</strong><br>
                            ${travelTime > 0 ? `üö∂ Tempo di viaggio: <strong>${travelTime}h</strong><br>` : ''}
                            ‚è∞ Sveglia consigliata: <strong>${wakeUpTime}:00</strong>
                        </div>
                        <button onclick="sleepUntil(${wakeUpTime}); closeDialog();" 
                                style="width:100%; padding:12px; background:linear-gradient(135deg, #38ef7d, #11998e); border-radius:10px; font-weight:600; font-size:1rem;">
                            üò¥ Svegliati alle ${wakeUpTime}:00
                        </button>
                    </div>
                </div>
            `;
        }
        
        html += `
            <div class="modal-section" style="border-left-color:#764ba2;">
                <div class="modal-section-title">üåô Scegli l'Orario di Sveglia</div>
                <div class="modal-section-content">
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
        `;
        
        // Add hourly options
        for (let hour = 0; hour < 24; hour++) {
            if (hour === currentHour) continue; // Skip current hour
            
            let hoursToSleep;
            if (hour > currentHour) {
                hoursToSleep = hour - currentHour;
            } else {
                hoursToSleep = (24 - currentHour) + hour;
            }
            
            // Calculate energy recovery
            const energyGain = Math.min(100, hoursToSleep * 8);
            
            html += `
                <button onclick="sleepUntil(${hour}); closeDialog();" 
                        class="modal-action-btn" 
                        style="padding:12px 8px; min-height:70px; background:rgba(102,126,234,0.12); border:1px solid rgba(102,126,234,0.3);">
                    <div style="font-size:1.2rem; font-weight:bold; margin-bottom:4px;">${hour}:00</div>
                    <div style="font-size:0.8rem; opacity:0.7;">+${energyGain} ‚ö°</div>
                </button>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        showDialog(html, 'üò¥ Dormi fino alle...', true);
    }
    
    function sleepUntil(targetHour) {
        const currentHour = game.time.hour;
        let hoursToSleep;
        
        if (targetHour > currentHour) {
            hoursToSleep = targetHour - currentHour;
        } else {
            hoursToSleep = (24 - currentHour) + targetHour;
        }
        
        // Must be at home to sleep
        if (game.cityMap.currentLocation !== game.housing.neighborhood) {
            showNotification('üè† Devi tornare a casa per dormire!', 2500);
            return;
        }
        
        // Calculate energy recovery (8% per hour of sleep, max 100%)
        const energyGain = Math.min(100 - game.player.stats.energy, hoursToSleep * 8);
        game.player.stats.energy = clamp(game.player.stats.energy + energyGain);
        
        // Small hunger and morale changes
        game.player.stats.hunger = clamp(game.player.stats.hunger - hoursToSleep * 3);
        game.player.stats.morale = clamp(game.player.stats.morale + Math.floor(hoursToSleep / 2));
        
        passTime(hoursToSleep);
        
        showNotification(`üò¥ Hai dormito ${hoursToSleep}h. Ti sei svegliato alle ${formatTime(game.time.hour, game.time.minute)}. Energia: +${energyGain}%`, 3000);
        updateUI();
    }

    function pad2(n) { return n < 10 ? '0' + n : '' + n; }
    function formatTime(hour24, minute) {
        const period = hour24 >= 12 ? 'PM' : 'AM';
        const h12 = hour24 % 12 === 0 ? 12 : hour24 % 12;
        return `${h12}:${pad2(minute)} ${period}`;
    }

    function getTimeString() {
        const dayOfWeek = DAYS_OF_WEEK[(game.time.day - 1) % 7];
        return `${dayOfWeek} - Giorno ${game.time.day} - ${formatTime(game.time.hour, game.time.minute)}`;
    }
    
    function getDayOfWeek(day) {
        return DAYS_OF_WEEK[(day - 1) % 7];
    }
    
    function isWeekend(day) {
        const dayIndex = (day - 1) % 7;
        return dayIndex === 5 || dayIndex === 6; // Sabato (5) o Domenica (6)
    }

    // ---------- CRIME EVENTS ----------
    function checkDailyCrimeEvent() {
        // No crime if homeless (already suffering enough)
        if (game.player.isHomeless) return;
        
        const hood = NEIGHBORHOODS[game.housing.neighborhood];
        const safetyLevel = hood.safety || 50;
        
        // Crime chance increases in unsafe neighborhoods
        const crimeChance = (100 - safetyLevel) / 100 * 0.2; // Max 20% in worst area
        
        if (Math.random() > crimeChance) return;
        
        // Types of crime based on neighborhood
        const crimeTypes = [];
        
        if (safetyLevel < 40) {
            crimeTypes.push('robbery_high', 'vehicle_damage', 'home_burglary');
        } else if (safetyLevel < 60) {
            crimeTypes.push('robbery_medium', 'vehicle_damage');
        } else if (safetyLevel < 80) {
            crimeTypes.push('robbery_low', 'pickpocket');
        } else {
            crimeTypes.push('pickpocket');
        }
        
        const crimeType = crimeTypes[randInt(0, crimeTypes.length - 1)];
        
        switch(crimeType) {
            case 'robbery_high':
                const stolen1 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.3 + Math.random() * 0.4)));
                game.player.cash -= stolen1;
                game.player.stats.morale = clamp(game.player.stats.morale - 30);
                showNotification(`üî™ SEI STATO RAPINATO! Hanno rubato ‚Ç¨${stolen1} in contante!`, 5000);
                break;
                
            case 'robbery_medium':
                const stolen2 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.15 + Math.random() * 0.25)));
                game.player.cash -= stolen2;
                game.player.stats.morale = clamp(game.player.stats.morale - 20);
                showNotification(`üò® Sei stato derubato! Persi ‚Ç¨${stolen2}!`, 4000);
                break;
                
            case 'robbery_low':
                const stolen3 = Math.min(game.player.cash, Math.floor(game.player.cash * (0.05 + Math.random() * 0.15)));
                game.player.cash -= stolen3;
                game.player.stats.morale = clamp(game.player.stats.morale - 10);
                showNotification(`üò† Borseggiatore! Persi ‚Ç¨${stolen3}!`, 3000);
                break;
                
            case 'pickpocket':
                const stolen4 = Math.min(game.player.cash, Math.floor(50 + Math.random() * 150));
                game.player.cash -= stolen4;
                game.player.stats.morale = clamp(game.player.stats.morale - 8);
                showNotification(`üëã Borseggiatore furtivo! Persi ‚Ç¨${stolen4}!`, 3000);
                break;
                
            case 'vehicle_damage':
                if (game.vehicles && game.vehicles.length > 0) {
                    const damageCost = Math.floor(200 + Math.random() * 1800);
                    showNotification(`üöóüí• Il tuo veicolo √® stato danneggiato! Riparazione: ‚Ç¨${damageCost}`, 4000);
                    
                    if (game.player.cash >= damageCost) {
                        game.player.cash -= damageCost;
                    } else {
                        // Remove vehicle if can't afford repair
                        game.vehicles = [];
                        game.player.stats.morale = clamp(game.player.stats.morale - 40);
                        showNotification('üíî Non puoi permetterti la riparazione. Veicolo perso!', 5000);
                    }
                }
                break;
                
            case 'home_burglary':
                if (game.housing.owned) {
                    const burglaryLoss = Math.floor(500 + Math.random() * 2500);
                    const totalMoney = game.player.cash + game.player.bankDeposit;
                    
                    if (totalMoney >= burglaryLoss) {
                        if (game.player.cash >= burglaryLoss) {
                            game.player.cash -= burglaryLoss;
                        } else {
                            const remaining = burglaryLoss - game.player.cash;
                            game.player.cash = 0;
                            game.player.bankDeposit -= remaining;
                        }
                        showNotification(`üè†üíî FURTO IN CASA! Persi beni per ‚Ç¨${burglaryLoss}!`, 5000);
                        game.player.stats.morale = clamp(game.player.stats.morale - 35);
                    }
                }
                break;
        }
        
        updateUI();
    }

    // ---------- BANK FUNCTIONS ----------
    function showBankDialog() {
        const html = `
            <div class="modal-section success">
                <div class="modal-section-title">üí∞ Il Tuo Patrimonio</div>
                <div class="modal-section-content">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;">
                        <div style="background:rgba(56,239,125,0.15); padding:14px; border-radius:10px; text-align:center; border:2px solid rgba(56,239,125,0.3);">
                            <div style="font-size:0.9rem; opacity:0.8; margin-bottom:6px;">üíµ Contante</div>
                            <div style="font-weight:bold; font-size:1.6rem; color:#38ef7d;">‚Ç¨${game.player.cash.toFixed(0)}</div>
                            <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">A rischio furto</div>
                        </div>
                        <div style="background:rgba(102,126,234,0.15); padding:14px; border-radius:10px; text-align:center; border:2px solid rgba(102,126,234,0.3);">
                            <div style="font-size:0.9rem; opacity:0.8; margin-bottom:6px;">üè¶ Deposito</div>
                            <div style="font-weight:bold; font-size:1.6rem; color:#667eea;">‚Ç¨${game.player.bankDeposit.toFixed(0)}</div>
                            <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">Protetto e sicuro</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-section info">
                <div class="modal-section-title">üí∞ Deposita Contante</div>
                <div class="modal-section-content">
                    <input type="number" id="depositAmount" min="0" max="${game.player.cash}" 
                        style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:2px solid rgba(102,126,234,0.3); border-radius:10px; color:white; font-size:1.1rem; margin-bottom:12px;"
                        placeholder="Quanto vuoi depositare?">
                    <button onclick="depositMoney()" style="width:100%; padding:12px; border-radius:10px; font-size:1rem; font-weight:600;">
                        üíµ‚û°Ô∏èüè¶ Deposita in Banca
                    </button>
                </div>
            </div>
            
            <div class="modal-section warning">
                <div class="modal-section-title">üíµ Preleva Contante</div>
                <div class="modal-section-content">
                    <input type="number" id="withdrawAmount" min="0" max="${game.player.bankDeposit}"
                        style="width:100%; padding:12px; background:rgba(255,255,255,0.08); border:2px solid rgba(255,215,0,0.3); border-radius:10px; color:white; font-size:1.1rem; margin-bottom:12px;"
                        placeholder="Quanto vuoi prelevare?">
                    <button onclick="withdrawMoney()" style="width:100%; padding:12px; border-radius:10px; font-size:1rem; font-weight:600;">
                        üè¶‚û°Ô∏èüíµ Preleva dalla Banca
                    </button>
                </div>
            </div>
            
            <div class="modal-section" style="background:rgba(56,239,125,0.08); border-left-color:#38ef7d;">
                <div style="font-size:0.9rem; line-height:1.6;">
                    üí° <strong>Importante:</strong> Il contante che porti con te pu√≤ essere rubato durante rapine o eventi negativi. I soldi depositati in banca sono completamente al sicuro!
                </div>
            </div>
        `;
        showDialog(html, 'üè¶ Gestione Bancaria', true);
    }

    function depositMoney() {
        const amount = parseFloat($('depositAmount').value);
        
        if (isNaN(amount) || amount <= 0) {
            showNotification('‚ùå Importo non valido!', 2000);
            return;
        }
        
        if (amount > game.player.cash) {
            showNotification('‚ùå Non hai abbastanza contante!', 2000);
            return;
        }
        
        game.player.cash -= amount;
        game.player.bankDeposit += amount;
        
        showNotification(`‚úÖ Depositati ‚Ç¨${amount.toFixed(0)} in banca!`, 2000);
        closeDialog();
        updateUI();
    }

    function withdrawMoney() {
        const amount = parseFloat($('withdrawAmount').value);
        
        if (isNaN(amount) || amount <= 0) {
            showNotification('‚ùå Importo non valido!', 2000);
            return;
        }
        
        if (amount > game.player.bankDeposit) {
            showNotification('‚ùå Fondi insufficienti in banca!', 2000);
            return;
        }
        
        game.player.bankDeposit -= amount;
        game.player.cash += amount;
        
        showNotification(`‚úÖ Prelevati ‚Ç¨${amount.toFixed(0)} dalla banca!`, 2000);
        closeDialog();
        updateUI();
    }

    // ---------- RANDOM EVENTS ----------
    // ---------- CRITICAL STATUS TRACKING ----------
    function checkCriticalStatus() {
        const stats = game.player.stats;
        const tracking = game.healthTracking;
        
        // Check if this is a new day
        if (tracking.lastCheckDay !== game.time.day) {
            tracking.lastCheckDay = game.time.day;
            
            // Check energy
            if (stats.energy < 10) {
                tracking.lowEnergyDays++;
                if (tracking.lowEnergyDays === 3) {
                    showNotification('‚ö†Ô∏è La tua energia √® stata criticamente bassa per 3 giorni!', 4000);
                } else if (tracking.lowEnergyDays === 5) {
                    showNotification('üö® PERICOLO: La tua energia √® pericolosamente bassa! Giorno 5/7', 5000);
                } else if (tracking.lowEnergyDays >= 7) {
                    gameOver('üíÄ GAME OVER - Sei morto di esaurimento. La tua energia √® rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.energy > 20) {
                tracking.lowEnergyDays = 0;
            }
            
            // Check hunger
            if (stats.hunger < 10) {
                tracking.lowHungerDays++;
                if (tracking.lowHungerDays === 3) {
                    showNotification('‚ö†Ô∏è La tua fame √® stata criticamente alta per 3 giorni!', 4000);
                } else if (tracking.lowHungerDays === 5) {
                    showNotification('üö® PERICOLO: Stai morendo di fame! Giorno 5/7', 5000);
                } else if (tracking.lowHungerDays >= 7) {
                    gameOver('üíÄ GAME OVER - Sei morto di malnutrizione. La tua fame √® rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.hunger > 20) {
                tracking.lowHungerDays = 0;
            }
            
            // Check health
            if (stats.health < 10) {
                tracking.lowHealthDays++;
                if (tracking.lowHealthDays === 3) {
                    showNotification('‚ö†Ô∏è La tua salute √® stata criticamente bassa per 3 giorni!', 4000);
                } else if (tracking.lowHealthDays === 5) {
                    showNotification('üö® PERICOLO: Sei gravemente malato! Giorno 5/7', 5000);
                } else if (tracking.lowHealthDays >= 7) {
                    gameOver('üíÄ GAME OVER - Sei morto di malattia. La tua salute √® rimasta critica per 7 giorni consecutivi.');
                    return;
                }
            } else if (stats.health > 20) {
                tracking.lowHealthDays = 0;
            }
            
            // Check debt
            if (game.player.money < 0) {
                tracking.debtDays++;
                if (tracking.debtDays === 7) {
                    showNotification('üí≥ Sei stato in debito per 7 giorni! Le banche potrebbero agire presto.', 4000);
                } else if (tracking.debtDays === 14) {
                    showNotification('üè¶ AVVISO FINALE: Paga i tuoi debiti o affronterai il fallimento!', 5000);
                } else if (tracking.debtDays >= 30) {
                    gameOver('üö´ GAME OVER - Fallimento dichiarato! Sei stato in debito per 30 giorni e i tuoi beni sono stati sequestrati.');
                    return;
                }
            } else {
                tracking.debtDays = 0;
            }
        }
    }
    
    // ---------- LOAN PAYMENT PROCESSING ----------
    function processLoanPayments() {
        if (!game.investments.loans || game.investments.loans.length === 0) return;
        
        const loansToRemove = [];
        
        for (let i = 0; i < game.investments.loans.length; i++) {
            const loan = game.investments.loans[i];
            
            // Check if payment is due
            if (game.player.money >= loan.monthlyPayment) {
                game.player.money -= loan.monthlyPayment;
                game.player.cash -= loan.monthlyPayment;
                loan.remainingMonths--;
                
                if (loan.remainingMonths <= 0) {
                    showNotification(`‚úÖ Hai completato il pagamento del prestito da ${loan.bank}!`, 3000);
                    loansToRemove.push(i);
                } else {
                    showNotification(`üí≥ Pagamento mensile di ‚Ç¨${loan.monthlyPayment.toFixed(0)} effettuato. Restano ${loan.remainingMonths} rate.`, 3000);
                }
            } else {
                // Can't pay - increase missed payments
                if (!loan.missedPayments) loan.missedPayments = 0;
                loan.missedPayments++;
                
                showNotification(`‚ùå Non hai abbastanza soldi per la rata del prestito! (‚Ç¨${loan.monthlyPayment.toFixed(0)}) Rate mancate: ${loan.missedPayments}`, 4000);
                
                if (loan.missedPayments >= 3) {
                    gameOver(`üö´ GAME OVER - Hai mancato ${loan.missedPayments} pagamenti del prestito. La banca ha sequestrato i tuoi beni!`);
                    return;
                }
            }
        }
        
        // Remove paid-off loans
        for (let i = loansToRemove.length - 1; i >= 0; i--) {
            game.investments.loans.splice(loansToRemove[i], 1);
        }
        
        updateUI();
    }
    
    // ---------- GAME OVER ----------
    function gameOver(message) {
        game.isPaused = true;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            border: 3px solid #ff0000;
            box-shadow: 0 0 50px rgba(255,0,0,0.5);
        `;
        
        content.innerHTML = `
            <h1 style="color: #ff0000; font-size: 48px; margin: 0 0 20px 0;">GAME OVER</h1>
            <p style="color: #fff; font-size: 20px; margin: 20px 0;">${message}</p>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <p style="color: #ccc; margin: 5px 0;">üìÖ Giorni sopravvissuti: ${game.time.day}</p>
                <p style="color: #ccc; margin: 5px 0;">üí∞ Denaro finale: ‚Ç¨${game.player.money.toFixed(0)}</p>
                <p style="color: #ccc; margin: 5px 0;">‚≠ê Reputazione: ${game.player.rep}</p>
            </div>
            <button onclick="location.reload()" style="
                background: #ff0000;
                color: white;
                border: none;
                padding: 15px 40px;
                font-size: 18px;
                border-radius: 10px;
                cursor: pointer;
                margin-top: 20px;
            ">Ricomincia</button>
        `;
        
        overlay.appendChild(content);
        document.body.appendChild(overlay);
    }

    function checkRandomEvent() {
        if (Math.random() > 0.15) return; // 15% chance

        const events = [
            { msg: 'üéâ Hai trovato 50‚Ç¨ per strada!', cash: 50 },
            { msg: 'üòä Una giornata particolarmente bella!', morale: 15 },
            { msg: '‚ö° Ti senti energico!', energy: 20 },
            { msg: 'üçï Qualcuno ti ha offerto la pizza!', hunger: 25, cash: 15 },
            { msg: 'üí™ Ti senti in gran forma!', health: 15 }
        ];

        const event = events[randInt(0, events.length - 1)];
        
        if (event.cash) game.player.cash += event.cash;
        if (event.morale) game.player.stats.morale = clamp(game.player.stats.morale + event.morale);
        if (event.energy) game.player.stats.energy = clamp(game.player.stats.energy + event.energy);
        if (event.hunger) game.player.stats.hunger = clamp(game.player.stats.hunger + event.hunger);
        if (event.health) game.player.stats.health = clamp(game.player.stats.health + event.health);

        showNotification(event.msg, 2500);
        updateUI();
    }

    // ---------- UI UPDATE ----------
    function updateUI() {
        if (!game.player) return;

        // Update total money display with cash/bank breakdown
        const totalMoney = (game.player.cash || 0) + (game.player.bankDeposit || 0);
        game.player.money = totalMoney; // Keep synced
        $('playerMoney').innerHTML = `‚Ç¨${totalMoney.toFixed(0)}<br><small style="font-size:9px">üíµ ${(game.player.cash || 0).toFixed(0)} | üè¶ ${(game.player.bankDeposit || 0).toFixed(0)}</small>`;
        
        $('playerRep').innerText = game.player.rep || 0;
        $('playerJob').innerText = game.player.job || 'Disoccupato';
        if ($('gameTime')) $('gameTime').innerText = getTimeString();
        
        // Update location display
        updateLocationDisplay();

        updateStatBar('hunger', game.player.stats.hunger);
        updateStatBar('energy', game.player.stats.energy);
        updateStatBar('morale', game.player.stats.morale);
        updateStatBar('health', game.player.stats.health);

        // Update skills in both locations (sidebar and skills tab)
        const skills = game.player.skills || { intellect: 0, fitness: 0, creativity: 0, charisma: 0 };
        
        // Update skills tab
        if ($('intellectValue')) $('intellectValue').innerText = skills.intellect;
        if ($('fitnessValue')) $('fitnessValue').innerText = skills.fitness;
        if ($('creativityValue')) $('creativityValue').innerText = skills.creativity;
        if ($('charismaValue')) $('charismaValue').innerText = skills.charisma;
        
        // Update skills in vital stats card with bars
        if ($('intellectValue2')) $('intellectValue2').innerText = skills.intellect;
        if ($('fitnessValue2')) $('fitnessValue2').innerText = skills.fitness;
        if ($('creativityValue2')) $('creativityValue2').innerText = skills.creativity;
        if ($('charismaValue2')) $('charismaValue2').innerText = skills.charisma;
        
        // Update skill bars (max 100)
        if ($('intellectBar')) $('intellectBar').style.width = Math.min(100, skills.intellect) + '%';
        if ($('fitnessBar')) $('fitnessBar').style.width = Math.min(100, skills.fitness) + '%';
        if ($('creativityBar')) $('creativityBar').style.width = Math.min(100, skills.creativity) + '%';
        if ($('charismaBar')) $('charismaBar').style.width = Math.min(100, skills.charisma) + '%';
        
        // Update skill bars in Skills tab
        if ($('intellectBarTab')) $('intellectBarTab').style.width = Math.min(100, skills.intellect) + '%';
        if ($('fitnessBarTab')) $('fitnessBarTab').style.width = Math.min(100, skills.fitness) + '%';
        if ($('creativityBarTab')) $('creativityBarTab').style.width = Math.min(100, skills.creativity) + '%';
        if ($('charismaBarTab')) $('charismaBarTab').style.width = Math.min(100, skills.charisma) + '%';
        
        // Update skill levels
        if ($('intellectLevel')) $('intellectLevel').innerText = getSkillLevel(skills.intellect);
        if ($('fitnessLevel')) $('fitnessLevel').innerText = getSkillLevel(skills.fitness);
        if ($('creativityLevel')) $('creativityLevel').innerText = getSkillLevel(skills.creativity);
        if ($('charismaLevel')) $('charismaLevel').innerText = getSkillLevel(skills.charisma);
        
        // Update daily training counter
        if ($('dailyTrainingCount')) {
            // Reset counter if new day
            if (game.player.lastTrainingDay !== game.time.day) {
                game.player.dailyTraining = 0;
                game.player.lastTrainingDay = game.time.day;
            }
            const count = game.player.dailyTraining || 0;
            $('dailyTrainingCount').innerText = `${count}/3`;
            $('dailyTrainingCount').style.color = count >= 3 ? '#eb3349' : count >= 2 ? '#ffd700' : '#38ef7d';
        }

        // Update cash/bank displays
        if ($('cashDisplay')) $('cashDisplay').innerText = (game.player.cash || 0).toFixed(0);
        if ($('bankDisplay')) $('bankDisplay').innerText = (game.player.bankDeposit || 0).toFixed(0);

        updateWorkStatus();
        renderKnownPeople();
        renderQuests();
        renderJobListings();
        
        // Update housing and food systems
        renderCurrentHousing();
        renderNeighborhoods();
        renderFoodShop();
        renderFoodInventory();

        // Update new systems
        renderRomanceStatus();
        renderPotentialPartners();
        renderFamilyStatus();
        
        // Update investments
        if ($('savingsAmount')) $('savingsAmount').innerText = formatMoney(game.investments.savings);
        renderStockMarket();
        renderStockPortfolio();
        renderPropertiesList();

        // Update crime
        renderCrimeStatus();

        // Update map and vehicles
        renderCityQuartiersMap();
        renderTransportInfo();
        renderVehiclesInfo();
        updatePlayerMarker(); // Update player position on map
        
        // Update agenda
        renderAgenda();
    }

    function updateStatBar(stat, value) {
        const bar = $(stat + 'Bar');
        const txt = $(stat + 'Value');
        if (!bar || !txt) return;

        bar.style.width = value + '%';
        txt.innerText = value + '%';
        bar.className = 'stat-fill ' + (value > 66 ? 'high' : value > 33 ? 'medium' : 'low');
    }
    
    function getSkillLevel(skillValue) {
        if (skillValue < 10) return 'Novizio';
        if (skillValue < 20) return 'Principiante';
        if (skillValue < 35) return 'Apprendista';
        if (skillValue < 50) return 'Competente';
        if (skillValue < 65) return 'Esperto';
        if (skillValue < 80) return 'Avanzato';
        if (skillValue < 95) return 'Maestro';
        return 'Gran Maestro';
    }

    // ---------- TABS ----------
    // ---------- UI CONTROL ----------
    function toggleStatsPanel() {
        const sidebar = document.getElementById('statsSidebar');
        const mapArea = document.getElementById('mainMapArea');
        if (sidebar.style.transform === 'translateX(-100%)') {
            sidebar.style.transform = 'translateX(0)';
            mapArea.style.left = '280px';
        } else {
            sidebar.style.transform = 'translateX(-100%)';
            mapArea.style.left = '0';
        }
    }
    
    function toggleMenuPanel() {
        const sidebar = document.getElementById('menuSidebar');
        if (sidebar.style.transform === 'translateX(0px)') {
            sidebar.style.transform = 'translateX(100%)';
        } else {
            sidebar.style.transform = 'translateX(0px)';
        }
    }
    
    // Funzioni per i nuovi menu
    function showVehiclesMenu() {
        closeLocationPopup(); // Chiudi eventuali popup aperti
        const currentLocation = game.cityMap?.currentLocation || 'periferia';
        const hood = NEIGHBORHOODS[currentLocation];
        
        let vehiclesHTML = '';
        if (game.vehicles.owned.length === 0) {
            vehiclesHTML = '<p style="opacity:0.7;">Nessun veicolo posseduto. Acquista veicoli per spostarti pi√π velocemente!</p>';
        } else {
            vehiclesHTML = game.vehicles.owned.map(v => {
                const vData = VEHICLES[v.type];
                const isActive = game.vehicles.active === v.id;
                return `
                    <div style="padding:12px; background:${isActive ? 'rgba(102,126,234,0.2)' : 'rgba(255,255,255,0.05)'}; border-radius:8px; margin-bottom:8px; border:2px solid ${isActive ? '#667eea' : 'transparent'};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:1.2rem;">${vData.emoji} ${vData.name}</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                    ${vData.description}<br>
                                    ‚ö° Velocit√†: ${Math.round((1-vData.speedMultiplier)*100)}% pi√π veloce<br>
                                    üí∞ Manutenzione: ‚Ç¨${vData.maintenanceCost}/mese
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                ${!isActive ? `<button class="small" onclick="setActiveVehicle('${v.id}')">‚úÖ Usa</button>` : '<div style="color:#667eea; font-weight:bold;">In Uso</div>'}
                                <button class="small" onclick="sellVehicle('${v.id}')" style="background:var(--danger);">üóëÔ∏è Vendi</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title">üöó I Tuoi Veicoli</div>
                <div class="modal-section-content">
                    ${vehiclesHTML}
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title">üõí Acquista Veicoli</div>
                <div class="modal-section-content">
                    ${Object.keys(VEHICLES).map(key => {
                        const v = VEHICLES[key];
                        const owned = game.vehicles.owned.some(owned => owned.type === key);
                        return `
                            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-size:1.1rem;">${v.emoji} ${v.name}</div>
                                        <div style="font-size:0.85rem; opacity:0.8;">${v.description}</div>
                                        <div style="font-size:0.8rem; margin-top:4px;">
                                            üí∞ ‚Ç¨${v.cost} ‚Ä¢ ‚ö° ${Math.round((1-v.speedMultiplier)*100)}% pi√π veloce
                                        </div>
                                    </div>
                                    ${owned ? '<div style="color:var(--success);">‚úÖ Posseduto</div>' : `<button class="small" onclick="buyVehicle('${key}')">üí∞ Acquista</button>`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        showDialog(html);
    }
    
    function showTransportMenu() {
        closeLocationPopup();
        const hasPass = game.cityMap?.transportPass && game.cityMap.transportPass > game.time.day;
        const daysLeft = hasPass ? game.cityMap.transportPass - game.time.day : 0;
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title">üöå Sistema Trasporti Pubblici</div>
                <div class="modal-section-content">
                    <p>Usa i trasporti pubblici per spostarti velocemente e gratuitamente (con abbonamento) nella citt√†.</p>
                    <div style="margin-top:12px; padding:12px; background:${hasPass ? 'rgba(56,239,125,0.1)' : 'rgba(255,100,100,0.1)'}; border-radius:8px;">
                        <strong>üìã Stato Abbonamento:</strong><br>
                        ${hasPass ? `‚úÖ Attivo (${daysLeft} giorni rimanenti)` : '‚ùå Nessun abbonamento attivo'}
                    </div>
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title">üé´ Acquista Abbonamento</div>
                <div class="modal-section-content">
                    <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:bold;">üöå Abbonamento Mensile</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                    Viaggio illimitato su bus e metro per 30 giorni<br>
                                    üí∞ Costo: ‚Ç¨50
                                </div>
                            </div>
                            <button onclick="closeDialog(); buyTransportPass()">üí∞ Acquista</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-section warning">
                <div class="modal-section-title">üó∫Ô∏è Linee Disponibili</div>
                <div class="modal-section-content" style="font-size:0.9rem;">
                    ${Object.values(NEIGHBORHOODS).map(n => `
                        <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:6px;">
                            <strong>${n.icon} ${n.name}</strong><br>
                            <div style="font-size:0.8rem; opacity:0.8;">
                                üöè Fermate: ${n.busStops.join(', ')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        showDialog(html);
    }
    
    function showQuartersMenu() {
        closeLocationPopup();
        const currentQuarter = game.cityMap?.currentLocation || 'periferia';
        
        const html = `
            <div class="modal-section info">
                <div class="modal-section-title">üèôÔ∏è Quartieri di Eldoria</div>
                <div class="modal-section-content">
                    <p>Esplora i diversi quartieri della citt√†. Ogni quartiere ha caratteristiche uniche!</p>
                </div>
            </div>
            
            ${Object.keys(NEIGHBORHOODS).map(key => {
                const n = NEIGHBORHOODS[key];
                const isCurrent = currentQuarter === key;
                return `
                    <div class="modal-section ${isCurrent ? 'success' : 'info'}">
                        <div class="modal-section-title">${n.icon} ${n.name} ${isCurrent ? 'üìç (Sei qui)' : ''}</div>
                        <div class="modal-section-content">
                            <p>${n.description}</p>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; font-size:0.85rem;">
                                <div>üí∞ Affitto: ‚Ç¨${n.rent}/mese</div>
                                <div>‚≠ê Qualit√†: ${n.quality}/100</div>
                                <div>üîí Sicurezza: ${n.safety}/100</div>
                                <div>üè™ Servizi: ${n.services}/100</div>
                            </div>
                            <div style="margin-top:8px;">
                                ${!isCurrent ? `<button onclick="closeDialog(); travelToQuarter('${key}')">üöó Vai a ${n.name}</button>` : '<div style="color:var(--success);">üìç Posizione attuale</div>'}
                                <button onclick="closeDialog(); showDetailedQuarterMap('${key}')" style="margin-left:8px;">üó∫Ô∏è Esplora Mappa</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
        
        showDialog(html);
    }
    
    function travelToQuarter(quarterId) {
        const hood = NEIGHBORHOODS[quarterId];
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, quarterId);
        
        if (confirm(`üöó Vuoi andare a ${hood.name}?\nTempo di viaggio: ${travelTime} minuti`)) {
            advanceTime(travelTime);
            game.cityMap.currentLocation = quarterId;
            game.cityMap.currentBuilding = null;
            updateLocationDisplay();
            updateUI();
            showNotification(`‚úÖ Sei arrivato a ${hood.name}!`);
            showDetailedQuarterMap(quarterId);
        }
    }
    
    function switchMapView(view) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if (view === 'overview') {
            document.getElementById('overviewMapContent').style.display = 'block';
            document.getElementById('detailedMapContent').style.display = 'none';
            // Nascondi la mappa dettagliata se era aperta
            const detailedMap = document.getElementById('detailedQuarterMap');
            if (detailedMap) detailedMap.classList.remove('active');
            const overviewGrid = document.getElementById('overviewMapGrid');
            if (overviewGrid) overviewGrid.style.display = 'grid';
        } else {
            // NUOVO: mostra la mappa grafica del quartiere corrente
            const currentQuarter = game.cityMap?.currentLocation || 'periferia';
            showDetailedQuarterMap(currentQuarter);
        }
    }
    
    function updateLocationDisplay() {
        const locText = document.getElementById('currentLocationText');
        if (!locText) return;
        
        const neighborhood = game.cityMap?.currentLocation || 'periferia';
        const building = game.cityMap?.currentBuilding;
        
        let text = `${NEIGHBORHOODS[neighborhood]?.name || neighborhood}`;
        if (building) {
            const location = findLocationById(building);
            if (location) {
                text += ` ‚Üí ${location.name}`;
            }
        }
        locText.textContent = text;
    }

    function switchMainTab(name) {
        // Open menu sidebar and show content
        const menuSidebar = document.getElementById('menuSidebar');
        menuSidebar.style.transform = 'translateX(0px)';
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const id = name + 'TabContent';
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
        
        game.currentTab = name;
    }

    // ---------- SCREENS ----------
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // ---------- SAVE/LOAD ----------
    function saveGame() {
        try {
            localStorage.setItem('cityLifeSave', JSON.stringify(game));
            showNotification('üíæ Partita salvata!', 1400);
        } catch (e) {
            showNotification('‚ùå Errore nel salvataggio', 1500);
        }
    }

    function loadGame() {
        const saved = localStorage.getItem('cityLifeSave');
        if (!saved) {
            showNotification('‚ùå Nessun salvataggio trovato', 1600);
            return;
        }

        try {
            game = JSON.parse(saved);
            
            // Initialize companies if not present (backward compatibility)
            if (!game.companies) {
                game.companies = {};
                initializeCompanies();
            } else {
                // Regenerate stocks from companies
                generateStocksFromCompanies();
            }
            
            showNotification('‚úÖ Partita caricata!', 1200);
            showScreen('gameScreen');
            updateUI();
            
            // Initialize map view
            setTimeout(() => {
                renderDetailedMap(game.cityMap?.currentLocation || game.housing?.neighborhood || 'periferia');
                updatePlayerMarker();
            }, 100);
        } catch (e) {
            showNotification('‚ùå Errore nel caricamento', 1500);
        }
    }

    function checkSavedGame() {
        const saved = localStorage.getItem('cityLifeSave');
        // Could show a "Continue" button on home screen if save exists
    }

    function backToMenu() {
        if (confirm('Vuoi tornare al menu principale? (Ricordati di salvare!)')) {
            showScreen('homeScreen');
        }
    }

    // ---------- NOTIFICATIONS ----------
    function showNotification(msg, duration = 2000) {
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.innerText = msg;
        document.body.appendChild(notif);

        setTimeout(() => {
            notif.style.opacity = '0';
            notif.style.transform = 'translateX(100px)';
            setTimeout(() => notif.remove(), 300);
        }, duration);
    }

    // ---------- TUTORIAL ----------
    function showTutorial() {
        showNotification('üìñ Tutorial: Usa i pulsanti per svolgere azioni. Gestisci le tue statistiche, trova lavoro, fai amicizie e completa missioni. Buon divertimento!', 4000);
    }

    // ---------- HOUSING SYSTEM ----------
    function renderCurrentHousing() {
        const div = $('currentHousingInfo');
        if (!div || !game.housing) return;

        // Check if homeless
        if (game.player.isHomeless || !game.housing.residenceId) {
            div.innerHTML = `
                <div style="padding:16px; background:rgba(235,51,73,0.15); border-radius:12px; border:2px solid var(--danger);">
                    <h4 style="margin-bottom:12px; color:var(--danger);">üèöÔ∏è SENZATETTO</h4>
                    <p style="opacity:0.9; margin-bottom:12px;">Vivi per strada. Devi trovare una casa!</p>
                    
                    <div style="padding:12px; background:rgba(0,0,0,0.3); border-radius:8px; margin-bottom:12px;">
                        <div style="color:var(--danger); font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è Penalit√† Giornaliere:</div>
                        <div style="font-size:0.9rem; opacity:0.9;">
                            ‚Ä¢ -30 Morale<br>
                            ‚Ä¢ -20 Salute<br>
                            ‚Ä¢ -15 Energia<br>
                            ‚Ä¢ -40% Prestazioni al lavoro<br>
                            ‚Ä¢ Rischio licenziamento aumentato<br>
                            ‚Ä¢ Impossibile lavarsi (-10 Igiene)
                        </div>
                    </div>

                    <button onclick="showHousingMarket()" class="action-btn" style="width:100%; margin-top:8px;">
                        üè† Cerca un'Abitazione
                    </button>
                </div>
            `;
            return;
        }

        // Find residence data
        const residence = findResidenceById(game.housing.residenceId);
        if (!residence) return;

        const hood = NEIGHBORHOODS[game.housing.neighborhood];
        const daysSinceRent = game.time.day - game.lastRentPayment;
        const daysUntilRent = 30 - daysSinceRent;

        div.innerHTML = `
            <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px; border:2px solid ${game.housing.rentPaid ? 'var(--success)' : 'var(--danger)'};">
                <h4 style="margin-bottom:12px;">üè† ${residence.name}</h4>
                <p style="opacity:0.8; margin-bottom:8px; font-size:0.9rem;">üìç ${residence.street}, ${hood.name}</p>
                <p style="opacity:0.9; margin-bottom:12px;">${hood.description}</p>
                
                <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap:8px; margin-bottom:12px;">
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Qualit√†</div>
                        <div style="font-weight:bold;">${hood.quality}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Servizi</div>
                        <div style="font-weight:bold;">${hood.services}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Sicurezza</div>
                        <div style="font-weight:bold;">${hood.safety}%</div>
                    </div>
                    <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:8px;">
                        <div style="font-size:0.85rem; opacity:0.8;">Costo Cibo</div>
                        <div style="font-weight:bold;">${hood.foodMultiplier}x</div>
                    </div>
                </div>

                ${game.housing.owned ? `
                    <div style="padding:12px; background:rgba(56,239,125,0.15); border-radius:8px; margin-bottom:12px;">
                        <div style="color:var(--success); font-weight:bold;">‚úÖ PROPRIET√Ä DI TUA PROPRIET√Ä</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">Valore: ‚Ç¨${residence.buyPrice}</div>
                    </div>
                ` : `
                    <div style="padding:12px; background:rgba(255,200,100,0.15); border-radius:8px; margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-size:0.85rem; opacity:0.8;">Affitto Mensile</div>
                                <div style="font-weight:bold; font-size:1.2rem; color:var(--warning);">‚Ç¨${residence.rent}/30 giorni</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.85rem; opacity:0.8;">Prossimo Pagamento</div>
                                <div style="font-weight:bold;">${daysUntilRent} giorni</div>
                            </div>
                        </div>
                    </div>
                `}

                ${!game.housing.rentPaid && !game.housing.owned ? '<div style="padding:10px; background:rgba(235,51,73,0.2); border-radius:8px; color:var(--danger); text-align:center; font-weight:bold;">‚ö†Ô∏è AFFITTO SCADUTO!</div>' : ''}
                
                <button onclick="showHousingMarket()" class="action-btn" style="width:100%; margin-top:8px;">
                    üè† Cambia Abitazione
                </button>
            </div>
        `;
    }

    // ---------- HOUSING MARKET ----------
    // Helper to find residence by ID
    function findResidenceById(residenceId) {
        for (let neighborhood in CITY_LOCATIONS) {
            const locations = CITY_LOCATIONS[neighborhood];
            const residence = locations.find(loc => loc.id === residenceId);
            if (residence) return residence;
        }
        return null;
    }

    function showHousingMarket() {
        // CITY_LOCATIONS √® un oggetto con chiavi per quartiere (periferia, quartiere_operaio, etc)
        // Ogni quartiere ha un array di locations
        const byNeighborhood = {};
        
        // Iterate through each neighborhood in CITY_LOCATIONS
        Object.keys(CITY_LOCATIONS).forEach(neighborhoodKey => {
            const locations = CITY_LOCATIONS[neighborhoodKey];
            const residences = locations.filter(loc => loc.type === 'residence');
            
            if (residences.length > 0) {
                byNeighborhood[neighborhoodKey] = residences;
            }
        });

        let html = `
            <div style="max-height:70vh; overflow-y:auto; padding:16px;">
                <h3 style="margin-bottom:16px;">üè† Mercato Immobiliare</h3>
                
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:0.9rem; opacity:0.8;">Disponibile</div>
                            <div style="font-weight:bold; font-size:1.2rem;">üíµ ‚Ç¨${game.player.cash.toFixed(0)}</div>
                        </div>
                        <div>
                            <div style="font-size:0.9rem; opacity:0.8;">Banca</div>
                            <div style="font-weight:bold; font-size:1.2rem;">üè¶ ‚Ç¨${game.player.bankDeposit.toFixed(0)}</div>
                        </div>
                    </div>
                </div>

                <div style="padding:14px; background:rgba(235,51,73,0.15); border-radius:10px; margin-bottom:16px; border:2px solid var(--danger);">
                    <h4 style="color:var(--danger); margin-bottom:8px;">üèöÔ∏è Vivi per Strada (Gratis)</h4>
                    <p style="font-size:0.85rem; opacity:0.9; margin-bottom:10px;">
                        Non hai soldi? Puoi vivere come senzatetto, ma con gravi conseguenze.
                    </p>
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:10px;">
                        ‚ö†Ô∏è Penalit√†: -30 Morale, -20 Salute, -15 Energia al giorno<br>
                        üíº Rischio licenziamento aumentato (-40% prestazioni)<br>
                        üöø Impossibile lavarsi (-10 Igiene al giorno)
                    </div>
                    <button onclick="becomeHomeless()" class="action-btn" style="background:var(--danger); width:100%;">
                        Vivi per Strada
                    </button>
                </div>
        `;

        // List residences by neighborhood
        Object.keys(byNeighborhood).forEach(hoodKey => {
            const hood = NEIGHBORHOODS[hoodKey];
            const residences = byNeighborhood[hoodKey];
            
            html += `
                <div style="margin-bottom:20px;">
                    <h4 style="margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid rgba(255,255,255,0.1);">
                        üìç ${hood.name}
                    </h4>
                    <div style="font-size:0.85rem; opacity:0.7; margin-bottom:10px;">
                        üèÜ Qualit√† ${hood.quality}% | üõ°Ô∏è Sicurezza ${hood.safety}% | üè™ Servizi ${hood.services}%
                    </div>
                    
                    ${residences.map(res => {
                        const isCurrent = game.housing.residenceId === res.id;
                        const canAffordRent = game.player.cash >= res.rent;
                        const canAffordBuy = (game.player.cash + game.player.bankDeposit) >= res.buyPrice;
                        
                        // Generate bonuses display
                        let bonusesHtml = '';
                        if (res.bonuses) {
                            const bonusItems = [];
                            if (res.bonuses.energy > 0) bonusItems.push(`‚ö° +${res.bonuses.energy} Energia`);
                            if (res.bonuses.morale > 0) bonusItems.push(`üòä +${res.bonuses.morale} Morale`);
                            if (res.bonuses.hygiene > 0) bonusItems.push(`üöø +${res.bonuses.hygiene} Igiene`);
                            if (res.bonuses.health > 0) bonusItems.push(`‚ù§Ô∏è +${res.bonuses.health} Salute`);
                            if (res.bonuses.stressReduction > 0) bonusItems.push(`üßò -${res.bonuses.stressReduction} Stress`);
                            bonusesHtml = `<div style="font-size:0.75rem; opacity:0.85; margin-top:6px; color:#38ef7d;">${bonusItems.join(' | ')}</div>`;
                        }
                        
                        return `
                            <div style="padding:12px; background:rgba(255,255,255,${isCurrent ? '0.12' : '0.06'}); border-radius:8px; margin-bottom:10px; border:2px solid ${isCurrent ? 'var(--primary)' : 'transparent'};">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:bold; margin-bottom:4px;">
                                            ${isCurrent ? '‚úÖ ' : ''}${res.name}
                                        </div>
                                        <div style="font-size:0.8rem; opacity:0.7;">üìÆ ${res.street}</div>
                                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">üë• ${res.residents} residenti</div>
                                        ${bonusesHtml}
                                    </div>
                                    <div style="text-align:right; min-width:120px;">
                                        <div style="font-size:0.85rem; opacity:0.8;">Affitto</div>
                                        <div style="font-weight:bold; color:var(--warning);">‚Ç¨${res.rent}/mese</div>
                                        <div style="font-size:0.75rem; opacity:0.6; margin-top:4px;">Acquisto: ‚Ç¨${res.buyPrice}</div>
                                    </div>
                                </div>
                                
                                ${!isCurrent ? `
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;">
                                        <button 
                                            onclick="rentResidence('${res.id}')" 
                                            class="action-btn" 
                                            ${!canAffordRent ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}
                                            style="font-size:0.85rem; padding:8px;">
                                            üìù Affitta ${!canAffordRent ? '(Non hai abbastanza contante)' : ''}
                                        </button>
                                        <button 
                                            onclick="buyResidence('${res.id}')" 
                                            class="action-btn" 
                                            ${!canAffordBuy ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}
                                            style="font-size:0.85rem; padding:8px; background:var(--success);">
                                            üí∞ Acquista ${!canAffordBuy ? '(Fondi insufficienti)' : ''}
                                        </button>
                                    </div>
                                ` : `
                                    <div style="text-align:center; padding:8px; background:rgba(56,239,125,0.2); border-radius:6px; color:var(--success);">
                                        ‚úÖ La tua casa attuale
                                    </div>
                                `}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        });

        html += `
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;

        showDialog(html);
    }

    function rentResidence(residenceId) {
        const residence = findResidenceById(residenceId);
        if (!residence || !residence.landlord) return;

        const landlord = residence.landlord;
        
        // Check if landlord accepts rent
        if (!landlord.acceptsRent) {
            showLandlordResponse(landlord, 'rent_refused', residence);
            return;
        }

        if (game.player.cash < residence.rent) {
            showNotification('‚ùå Non hai abbastanza contante per pagare l\'affitto!', 2500);
            return;
        }

        // Show negotiation dialog
        showLandlordNegotiation(residence, 'rent');
    }

    function buyResidence(residenceId) {
        const residence = findResidenceById(residenceId);
        if (!residence || !residence.landlord) return;

        const landlord = residence.landlord;
        
        // Check if landlord accepts sale
        if (!landlord.acceptsSale) {
            showLandlordResponse(landlord, 'sale_refused', residence);
            return;
        }

        const totalMoney = game.player.cash + game.player.bankDeposit;
        if (totalMoney < residence.buyPrice) {
            showNotification('‚ùå Non hai abbastanza soldi per acquistare questa propriet√†!', 2500);
            return;
        }

        // Show negotiation dialog
        showLandlordNegotiation(residence, 'buy');
    }

    function showLandlordNegotiation(residence, type) {
        const landlord = residence.landlord;
        const isRent = type === 'rent';
        const price = isRent ? residence.rent : residence.buyPrice;
        
        // Calculate possible discount based on personality
        let discount = 0;
        let discountText = '';
        
        if (landlord.negotiable) {
            if (landlord.personality === 'friendly') {
                discount = Math.floor(price * 0.10); // 10% discount
                discountText = 'üòä √à una persona amichevole e potrebbe farti uno sconto!';
            } else if (landlord.personality === 'neutral') {
                discount = Math.floor(price * 0.05); // 5% discount
                discountText = 'ü§ù Potrebbe considerare una piccola riduzione.';
            } else if (landlord.personality === 'professional') {
                discount = Math.floor(price * 0.07); // 7% discount
                discountText = 'üíº √à un professionista, puoi provare a negoziare.';
            }
        }
        
        let personalityDesc = '';
        switch(landlord.personality) {
            case 'friendly': personalityDesc = 'üòä Persona amichevole e disponibile'; break;
            case 'strict': personalityDesc = 'üòê Persona rigida, non negoziabile'; break;
            case 'neutral': personalityDesc = 'ü§ù Persona neutrale'; break;
            case 'professional': personalityDesc = 'üíº Persona professionale'; break;
            case 'greedy': personalityDesc = 'üí∞ Interessato solo al denaro'; break;
            case 'selective': personalityDesc = 'üéØ Molto selettivo con gli inquilini'; break;
            case 'arrogant': personalityDesc = 'üò§ Persona arrogante'; break;
        }

        const finalPrice = price - discount;
        
        const html = `
            <div style="padding:20px; max-width:600px;">
                <h3 style="margin-bottom:16px;">üë§ Incontro con il Proprietario</h3>
                
                <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <div style="font-size:3rem;">üë§</div>
                        <div>
                            <div style="font-weight:bold; font-size:1.2rem;">${landlord.name}</div>
                            <div style="font-size:0.9rem; opacity:0.8;">${landlord.age} anni</div>
                            <div style="font-size:0.85rem; opacity:0.7; margin-top:4px;">${personalityDesc}</div>
                        </div>
                    </div>
                    
                    <div style="padding:12px; background:rgba(0,0,0,0.2); border-radius:8px; margin-top:12px;">
                        <div style="font-style:italic; opacity:0.9;">
                            "${getQuote(landlord.personality, isRent)}"
                        </div>
                    </div>
                </div>

                <div style="padding:16px; background:rgba(56,159,239,0.15); border-radius:12px; margin-bottom:16px;">
                    <h4 style="margin-bottom:12px;">üè† ${residence.name}</h4>
                    <div style="font-size:0.9rem; opacity:0.8; margin-bottom:8px;">üìÆ ${residence.street}</div>
                    
                    <div style="margin-top:12px; padding-top:12px; border-top:2px solid rgba(255,255,255,0.1);">
                        ${landlord.negotiable && discount > 0 ? `
                            <div style="margin-bottom:10px;">
                                <div style="text-decoration:line-through; opacity:0.6;">Prezzo originale: ‚Ç¨${price}</div>
                                <div style="font-size:1.3rem; font-weight:bold; color:var(--success);">
                                    ${isRent ? 'Affitto' : 'Prezzo'}: ‚Ç¨${finalPrice} ${discount > 0 ? '(-‚Ç¨' + discount + ')' : ''}
                                </div>
                                <div style="font-size:0.8rem; color:var(--success); margin-top:4px;">
                                    ‚ú® ${discountText}
                                </div>
                            </div>
                        ` : `
                            <div style="font-size:1.3rem; font-weight:bold; color:var(--warning);">
                                ${isRent ? 'Affitto' : 'Prezzo'}: ‚Ç¨${price}
                            </div>
                            <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">
                                ‚ö†Ô∏è Prezzo non negoziabile
                            </div>
                        `}
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <button onclick="confirmHousingDeal('${residence.id}', '${type}', ${finalPrice})" class="action-btn" style="background:var(--success);">
                        ‚úÖ ${isRent ? 'Affitta' : 'Acquista'}
                    </button>
                    <button onclick="closeDialog()" class="action-btn" style="background:var(--danger);">
                        ‚ùå Rifiuta
                    </button>
                </div>
            </div>
        `;

        showDialog(html);
    }

    function getQuote(personality, isRent) {
        const quotes = {
            friendly: {
                rent: [
                    'Ciao! Cerco qualcuno di affidabile per questa casa. Sei la persona giusta?',
                    'Mi sembri una brava persona, sono sicuro che ci prenderai cura!',
                    'Benvenuto! Sar√≤ felice di averti come inquilino.'
                ],
                buy: [
                    'Ho deciso di vendere, ma voglio che vada a qualcuno che la apprezzi.',
                    '√à un posto speciale, me ne prendo cura da anni.',
                    'Sono contento di trovare un acquirente serio come te.'
                ]
            },
            strict: {
                rent: [
                    'Le regole sono chiare: affitto puntuale ogni mese, nessun ritardo.',
                    'Non accetto scuse. Pagamento il primo del mese, senza eccezioni.',
                    'Ho standard molto alti. Sei in grado di rispettarli?'
                ],
                buy: [
                    'Il prezzo √® quello, non c\'√® margine di trattativa.',
                    'O lo prendi a questo prezzo o cerco qualcun altro.',
                    'Non ho tempo da perdere. Sei interessato o no?'
                ]
            },
            neutral: {
                rent: [
                    'Le condizioni sono standard. Se sei d\'accordo, possiamo procedere.',
                    'Ecco il contratto. Dai un\'occhiata e fammi sapere.',
                    'Cerco un inquilino affidabile. Tu lo sei?'
                ],
                buy: [
                    'Il prezzo √® in linea con il mercato. Cosa ne pensi?',
                    'Se sei seriamente interessato, possiamo parlarne.',
                    'Fammi un\'offerta ragionevole e la valuter√≤.'
                ]
            },
            professional: {
                rent: [
                    'Ho preparato tutta la documentazione necessaria. Vuoi esaminarla?',
                    'Possiamo discutere i termini del contratto in modo professionale.',
                    'Lavoro solo con persone serie e affidabili.'
                ],
                buy: [
                    'Ho fatto una valutazione professionale dell\'immobile.',
                    'La documentazione √® in regola, possiamo procedere rapidamente.',
                    'Il prezzo riflette il valore di mercato attuale.'
                ]
            },
            greedy: {
                rent: [
                    'L\'affitto potrebbe sembrare alto, ma ne vale la pena.',
                    'Questo quartiere sta diventando costoso, considerati fortunato.',
                    'Ho altre persone interessate, devi decidere subito.'
                ],
                buy: [
                    'Questo √® un investimento, il valore salir√† sicuramente.',
                    'Altri compratori offrono di pi√π, ma ti do questa possibilit√†.',
                    'Il prezzo tiene gi√† conto di uno "sconto speciale".'
                ]
            },
            selective: {
                rent: [
                    'Seleziono accuratamente i miei inquilini. Parlami di te.',
                    'Non affitto a chiunque. Devo sapere che tipo di persona sei.',
                    'Questo posto merita qualcuno di speciale.'
                ],
                buy: [
                    'Non vendo a chiunque. Devo essere sicuro che sia la scelta giusta.',
                    'Voglio che questa casa vada a qualcuno che la rispetti.',
                    'Prima di vendere, devo conoscerti meglio.'
                ]
            },
            arrogant: {
                rent: [
                    'Dovresti sentirti fortunato che io stia considerando la tua richiesta.',
                    'Ho standard molto alti. Sei all\'altezza?',
                    'Normalmente affitto solo a persone... di un certo livello.'
                ],
                buy: [
                    'Dubito che tu possa permettertelo, ma dimmi pure.',
                    'Questa propriet√† √® per chi ha... un certo status.',
                    'Sei sicuro di potertelo permettere?'
                ]
            }
        };

        const category = isRent ? 'rent' : 'buy';
        const options = quotes[personality] ? quotes[personality][category] : quotes.neutral[category];
        return options[Math.floor(Math.random() * options.length)];
    }

    function showLandlordResponse(landlord, responseType, residence) {
        let message = '';
        let emoji = 'üòê';
        
        switch(responseType) {
            case 'rent_refused':
                emoji = '‚ùå';
                if (landlord.personality === 'strict') {
                    message = `${landlord.name} scuote la testa: "Non affitto pi√π. Devi cercare altrove."`;
                } else if (landlord.personality === 'arrogant') {
                    message = `${landlord.name} ti guarda dall'alto in basso: "Questo immobile non √® per chiunque. Buona fortuna altrove."`;
                } else {
                    message = `${landlord.name} si scusa: "Mi dispiace, ma al momento non affitto. Prova con altri immobili."`;
                }
                break;
                
            case 'sale_refused':
                emoji = '‚ùå';
                if (landlord.personality === 'greedy') {
                    message = `${landlord.name} sorride: "Vendere? Mai! Questo √® il mio patrimonio!"`;
                } else if (landlord.personality === 'arrogant') {
                    message = `${landlord.name} ti respinge: "Non vendo a chiunque. Decisamente non a te."`;
                } else {
                    message = `${landlord.name} √® fermo: "Non ho intenzione di vendere. √à fuori discussione."`;
                }
                break;
        }

        const html = `
            <div style="padding:20px; max-width:400px; text-align:center;">
                <div style="font-size:4rem; margin-bottom:16px;">${emoji}</div>
                <div style="font-size:1.1rem; margin-bottom:20px; font-style:italic; opacity:0.9;">
                    "${message}"
                </div>
                <button onclick="closeDialog(); showHousingMarket();" class="action-btn" style="width:100%;">
                    Torna al Mercato
                </button>
            </div>
        `;

        showDialog(html);
    }

    function confirmHousingDeal(residenceId, type, finalPrice) {
        const residence = findResidenceById(residenceId);
        if (!residence) return;

        const isRent = type === 'rent';

        if (isRent) {
            if (game.player.cash < finalPrice) {
                showNotification('‚ùå Non hai abbastanza contante!', 2500);
                return;
            }

            // Pay rent
            game.player.cash -= finalPrice;
            
            // Update housing
            const hood = residenceId.substring(0, 5);
            let hoodKey;
            if (hood === 'loc_p') hoodKey = 'periferia';
            else if (hood === 'loc_o') hoodKey = 'quartiere_operaio';
            else if (hood === 'loc_c') hoodKey = 'centro_storico';
            else if (hood === 'loc_r') hoodKey = 'zona_residenziale';
            else if (hood === 'loc_l') hoodKey = 'quartiere_lusso';
            
            game.housing.neighborhood = hoodKey;
            game.housing.residenceId = residenceId;
            game.housing.rentPaid = true;
            game.housing.owned = false;
            game.lastRentPayment = game.time.day;
            game.player.isHomeless = false;
            
            // Update location
            game.cityMap.currentLocation = hoodKey;
            game.cityMap.currentBuilding = 'home';
            
            showNotification(`‚úÖ Hai affittato ${residence.name}! Primo mese pagato: ‚Ç¨${finalPrice}`, 3000);
            
        } else {
            // Buy
            if (!payMoney(finalPrice)) {
                showNotification('‚ùå Fondi insufficienti!', 2500);
                return;
            }

            // Update housing
            const hood = residenceId.substring(0, 5);
            let hoodKey;
            if (hood === 'loc_p') hoodKey = 'periferia';
            else if (hood === 'loc_o') hoodKey = 'quartiere_operaio';
            else if (hood === 'loc_c') hoodKey = 'centro_storico';
            else if (hood === 'loc_r') hoodKey = 'zona_residenziale';
            else if (hood === 'loc_l') hoodKey = 'quartiere_lusso';
            
            game.housing.neighborhood = hoodKey;
            game.housing.residenceId = residenceId;
            game.housing.rentPaid = true;
            game.housing.owned = true;
            game.player.isHomeless = false;
            
            // Update location
            game.cityMap.currentLocation = hoodKey;
            game.cityMap.currentBuilding = 'home';
            
            showNotification(`üè† Congratulazioni! Hai acquistato ${residence.name} per ‚Ç¨${finalPrice}!`, 3000);
        }

        closeDialog();
        updateUI();
        updatePlayerMarker();
    }

    function becomeHomeless() {
        if (!confirm('‚ö†Ô∏è Sei sicuro di voler vivere per strada? Subirai gravi penalit√† ogni giorno!')) {
            return;
        }

        game.housing.neighborhood = 'periferia'; // Default location
        game.housing.residenceId = null;
        game.housing.rentPaid = false;
        game.housing.owned = false;
        game.player.isHomeless = true;
        
        game.cityMap.currentLocation = 'periferia';
        game.cityMap.currentBuilding = 'street';
        
        showNotification('üèöÔ∏è Ora sei senzatetto. Ogni giorno sar√† una lotta per sopravvivere...', 4000);
        closeDialog();
        updateUI();
        updatePlayerMarker();
    }

    function renderNeighborhoods() {
        const div = $('neighborhoodsList');
        if (!div) return;

        div.innerHTML = Object.keys(NEIGHBORHOODS).map(key => {
            const hood = NEIGHBORHOODS[key];
            const isCurrent = game.housing && game.housing.neighborhood === key;
            const canAfford = game.player.money >= hood.rent;

            return `
                <div style="padding:14px; background:rgba(255,255,255,${isCurrent ? '0.1' : '0.05'}); border-radius:10px; margin-bottom:10px; border:2px solid ${isCurrent ? 'var(--primary)' : 'transparent'};">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                            <h4 style="margin-bottom:4px;">${isCurrent ? 'üìç ' : ''}${hood.name}</h4>
                            <p style="font-size:0.85rem; opacity:0.8;">${hood.description}</p>
                        </div>
                        <div style="text-align:right; min-width:100px;">
                            <div style="font-weight:bold; color:var(--warning); font-size:1.1rem;">‚Ç¨${hood.rent}</div>
                            <div style="font-size:0.8rem; opacity:0.7;">/mese</div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:10px; font-size:0.8rem;">
                        <div>üèÜ ${hood.quality}%</div>
                        <div>üè™ ${hood.services}%</div>
                        <div>üõ°Ô∏è ${hood.safety}%</div>
                        <div>üçï ${hood.foodMultiplier}x</div>
                    </div>

                    ${!isCurrent ? `<button class="small" onclick="moveToNeighborhood('${key}')" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? 'Trasferisciti' : 'Non puoi permettertelo'}
                    </button>` : '<div style="text-align:center; padding:6px; background:rgba(102,126,234,0.2); border-radius:6px; font-size:0.85rem;">‚úì Casa Attuale</div>'}
                </div>
            `;
        }).join('');
    }

    function moveToNeighborhood(neighborhoodKey) {
        const hood = NEIGHBORHOODS[neighborhoodKey];
        
        if (game.player.money < hood.rent) {
            showNotification('üí∞ Non hai abbastanza soldi!', 1500);
            return;
        }

        if (confirm(`Vuoi trasferirti in ${hood.name}? Coster√† ‚Ç¨${hood.rent} per il primo mese.`)) {
            game.player.money -= hood.rent;
            game.housing.neighborhood = neighborhoodKey;
            game.housing.rentPaid = true;
            game.lastRentPayment = game.time.day;
            
            showNotification(`üè† Ti sei trasferito in ${hood.name}!`, 2000);
            updateUI();
        }
    }

    // ---------- FOOD SYSTEM ----------
    function renderFoodShop() {
        const div = $('foodShop');
        if (!div) return;

        const multiplier = game.housing ? NEIGHBORHOODS[game.housing.neighborhood].foodMultiplier : 1;

        div.innerHTML = Object.keys(FOOD_ITEMS).map(key => {
            const item = FOOD_ITEMS[key];
            const finalCost = Math.ceil(item.cost * multiplier);
            const canBuy = game.player.money >= finalCost;

            return `
                <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:10px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="font-weight:bold; margin-bottom:4px;">${item.name}</div>
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">
                        üçΩÔ∏è +${item.hunger}% fame<br>
                        ‚è≥ Scade in ${item.expires} giorni
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:bold; color:var(--warning);">‚Ç¨${finalCost}</div>
                        <button class="small" onclick="buyFood('${key}')" ${!canBuy ? 'disabled' : ''}>
                            Compra
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function buyFood(itemKey) {
        // Controlla se sei fisicamente al supermercato
        const currentBuilding = game.cityMap?.currentBuilding;
        let isAtSupermarket = false;
        
        // Cerca se la location corrente √® un supermercato
        if (currentBuilding) {
            for (let hood in CITY_LOCATIONS) {
                const location = CITY_LOCATIONS[hood].find(loc => loc.id === currentBuilding);
                if (location && (location.business === 'supermercato' || location.business === 'minimarket')) {
                    isAtSupermarket = true;
                    break;
                }
            }
        }
        
        if (!isAtSupermarket) {
            showNotification('üõí Devi andare fisicamente al supermercato per comprare cibo!', 3000);
            return;
        }
        
        const item = FOOD_ITEMS[itemKey];
        const multiplier = game.housing ? NEIGHBORHOODS[game.housing.neighborhood].foodMultiplier : 1;
        const finalCost = Math.ceil(item.cost * multiplier);

        if (game.player.money < finalCost) {
            showNotification('üí∞ Non hai abbastanza soldi!', 1500);
            return;
        }

        game.player.money -= finalCost;
        game.inventory.food.push({
            id: itemKey,
            boughtDay: game.time.day
        });

        showNotification(`‚úì Hai comprato ${item.name} per ‚Ç¨${finalCost}`, 1500);
        updateUI();
    }

    function renderFoodInventory() {
        const div = $('foodInventory');
        if (!div) return;

        // Remove expired food
        game.inventory.food = game.inventory.food.filter(f => {
            const item = FOOD_ITEMS[f.id];
            const daysSinceBought = game.time.day - f.boughtDay;
            return daysSinceBought < item.expires;
        });

        if (game.inventory.food.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; padding:12px; text-align:center;">Inventario vuoto! Vai al supermercato.</p>';
            return;
        }

        // Group food by type
        const foodCounts = {};
        game.inventory.food.forEach(f => {
            foodCounts[f.id] = (foodCounts[f.id] || 0) + 1;
        });

        div.innerHTML = Object.keys(foodCounts).map(key => {
            const item = FOOD_ITEMS[key];
            const count = foodCounts[key];
            const oldestItem = game.inventory.food.find(f => f.id === key);
            const daysSinceBought = game.time.day - oldestItem.boughtDay;
            const daysLeft = item.expires - daysSinceBought;

            return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:6px; border-left:3px solid ${daysLeft <= 1 ? 'var(--danger)' : daysLeft <= 3 ? 'var(--warning)' : 'var(--success)'};">
                    <div>
                        <span style="font-weight:bold;">${item.name}</span>
                        <span style="opacity:0.7; margin-left:8px;">x${count}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.85rem; opacity:0.8;">Scade: ${daysLeft}g</div>
                        <button class="small" onclick="eatFood('${key}')" style="margin-top:4px;">Mangia</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function cookFood() {
        // Check if player has ingredients
        if (game.inventory.food.length < 2) {
            showNotification('üç≥ Hai bisogno di almeno 2 ingredienti per cucinare!', 2000);
            return;
        }

        // Use 2 random ingredients
        const removed = [];
        for (let i = 0; i < 2; i++) {
            const randomIndex = randInt(0, game.inventory.food.length - 1);
            const food = game.inventory.food[randomIndex];
            removed.push(FOOD_ITEMS[food.id].name);
            game.inventory.food.splice(randomIndex, 1);
        }

        // Cooking gives more hunger satisfaction
        const hungerGain = 45;
        game.player.stats.hunger = clamp(game.player.stats.hunger + hungerGain);
        game.player.stats.morale = clamp(game.player.stats.morale + 10);
        game.player.stats.energy = clamp(game.player.stats.energy - 10);

        passTime(2);
        showNotification(`üë®‚Äçüç≥ Hai cucinato usando ${removed.join(' e ')}! +${hungerGain}% fame`, 2000);
        updateUI();
    }

    // ---------- ECONOMIC SYSTEM ----------
    function checkRentPayment() {
        // Skip if homeless or owns property
        if (game.player.isHomeless || game.housing.owned) return;
        
        const daysSinceRent = game.time.day - game.lastRentPayment;
        
        if (daysSinceRent >= 30) {
            const residence = findResidenceById(game.housing.residenceId);
            const rent = residence ? residence.rent : 0;
            
            if (rent > 0) {
                if (payMoney(rent)) {
                    game.lastRentPayment = game.time.day;
                    game.housing.rentPaid = true;
                    showNotification(`üè† Hai pagato l'affitto: ‚Ç¨${rent}`, 2500);
                } else {
                    game.housing.rentPaid = false;
                    showNotification(`‚ö†Ô∏è Non hai abbastanza soldi per l'affitto! Rischi lo sfratto!`, 3000);
                    game.player.stats.morale = clamp(game.player.stats.morale - 20);
                    
                    // After 2 months unpaid, become homeless
                    if (daysSinceRent >= 60) {
                        game.player.isHomeless = true;
                        game.housing.residenceId = null;
                        showNotification('üèöÔ∏è Sei stato sfrattato! Ora sei senzatetto!', 5000);
                    }
                }
            }
            updateUI();
        }
    }

    function checkTaxPayment() {
        const daysSinceTax = game.time.day - game.lastTaxPayment;
        
        if (daysSinceTax >= 90) {
            const taxRate = 0.10;
            const taxes = Math.floor(game.player.totalEarned * taxRate);
            
            if (taxes > 0) {
                if (payMoney(taxes)) {
                    game.lastTaxPayment = game.time.day;
                    game.player.totalEarned = 0;
                    showNotification(`üíº Hai pagato le tasse: ‚Ç¨${taxes} (10% del reddito)`, 2500);
                } else {
                    showNotification(`‚ö†Ô∏è Non hai abbastanza soldi per le tasse! Penalit√† applicata.`, 3000);
                    game.player.stats.morale = clamp(game.player.stats.morale - 15);
                    game.player.rep = clamp(game.player.rep - 5, 0, 100);
                    game.lastTaxPayment = game.time.day;
                }
            } else {
                game.lastTaxPayment = game.time.day;
            }
            updateUI();
        }
    }

    // ---------- VISUAL MAP FUNCTIONS ----------
    function selectQuarterFromMap(quarterId) {
        // Switch to detailed view and show this quarter
        switchMapView('detailed');
        renderDetailedMap(quarterId);
    }
    
    function renderDetailedMap(quarterId) {
        const container = document.getElementById('detailedMapContainer');
        if (!container) return;
        
        const quarter = quarterId || game.cityMap.currentLocation || 'periferia';
        const locations = CITY_LOCATIONS[quarter] || [];
        const neighborhood = NEIGHBORHOODS[quarter];
        
        container.innerHTML = `
            <div style="margin-bottom:16px;">
                <h3 style="margin:0 0 8px 0;">${neighborhood.icon} ${neighborhood.name}</h3>
                <p style="opacity:0.8; margin:0;">${neighborhood.description}</p>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
                ${locations.map(loc => {
                    const isCurrentLocation = game.cityMap.currentBuilding === loc.id;
                    const isClosed = loc.status === 'closed';
                    
                    // Get icon based on type
                    let icon = 'üè¢';
                    if (loc.type === 'shop') {
                        if (loc.business === 'supermercato') icon = 'üõí';
                        else if (loc.business === 'pizzeria') icon = 'üçï';
                        else if (loc.business === 'bar') icon = '‚òï';
                        else if (loc.business === 'palestra') icon = 'üí™';
                        else if (loc.business === 'libreria') icon = 'üìö';
                        else if (loc.business === 'boutique') icon = 'üëó';
                        else if (loc.business === 'ristorante') icon = 'üçΩÔ∏è';
                        else if (loc.business === 'banca') icon = 'üè¶';
                        else if (loc.business === 'pasticceria') icon = 'üßÅ';
                        else icon = 'üè™';
                    } else if (loc.type === 'residence') {
                        icon = 'üè†';
                    } else if (loc.type === 'landmark') {
                        icon = 'üèõÔ∏è';
                    } else if (loc.type === 'empty') {
                        icon = 'üèóÔ∏è';
                    }
                    
                    return `
                        <div onclick="interactWithLocation('${loc.id}', '${quarter}')" 
                             style="padding:12px; background:${isCurrentLocation ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}; 
                                    border-radius:8px; cursor:pointer; transition:all 0.2s; border:2px solid ${isCurrentLocation ? '#667eea' : 'transparent'}; 
                                    ${isClosed ? 'opacity:0.5;' : ''}"
                             onmouseenter="this.style.background='rgba(102,126,234,0.2)'" 
                             onmouseleave="this.style.background='${isCurrentLocation ? 'rgba(102,126,234,0.3)' : 'rgba(255,255,255,0.05)'}'">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                                <div style="font-size:1.5rem;">${icon}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:bold; font-size:0.9rem;">${loc.name}</div>
                                    <div style="font-size:0.75rem; opacity:0.7;">${loc.street}</div>
                                </div>
                                ${isCurrentLocation ? '<div style="color:#667eea;">üìç</div>' : ''}
                            </div>
                            ${isClosed ? '<div style="color:#ef4444; font-size:0.8rem;">‚ùå CHIUSO</div>' : ''}
                            ${loc.type === 'shop' && !isClosed ? `<div style="font-size:0.75rem; opacity:0.8;">üí∞ ${loc.business}</div>` : ''}
                            ${loc.type === 'residence' ? `<div style="font-size:0.75rem; opacity:0.8;">üí∞ ‚Ç¨${loc.rent}/mese</div>` : ''}
                            ${loc.type === 'empty' ? `<div style="font-size:0.75rem; opacity:0.8;">üí∞ ‚Ç¨${loc.cost}</div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    function interactWithLocation(locationId, neighborhood) {
        const location = findLocationById(locationId);
        if (!location) return;
        
        // Check if already there
        if (game.cityMap.currentBuilding === locationId) {
            // Show actions for current location
            showLocationActions(location, neighborhood);
        } else {
            // Ask if want to travel
            if (confirm(`üöó Vuoi andare a ${location.name}?\n${location.street}`)) {
                travelToLocation(locationId, neighborhood, location.name);
                renderDetailedMap(neighborhood);
            }
        }
    }
    
    function showLocationActions(location, neighborhood) {
        const actions = getLocationActions(location, neighborhood);
        
        if (actions.length === 0) {
            showNotification('üëÄ Osservi il luogo ma non ci sono azioni disponibili.', 2000);
            return;
        }
        
        // Genera le azioni con stile moderno
        const actionsHTML = `
            <div class="modal-section info">
                <div class="modal-section-title">üìç Posizione</div>
                <div class="modal-section-content">
                    <strong>${location.street}</strong> ‚Ä¢ ${NEIGHBORHOODS[neighborhood].name}
                </div>
            </div>
            
            <div class="modal-section success">
                <div class="modal-section-title">‚ú® Azioni Disponibili</div>
                <div class="modal-action-grid">
                    ${actions.map(action => `
                        <button class="modal-action-btn" onclick="${action.onclick}; closeDialog();">
                            <div class="btn-icon">${action.icon}</div>
                            <div class="btn-title">${action.label}</div>
                            <div class="btn-subtitle">${action.subtitle}</div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        
        showDialog(actionsHTML, `${location.icon || 'üìç'} ${location.name}`, true);
    }

    function updatePlayerMarker(quarterId) {
        const marker = $('playerMarker');
        const label = $('playerLocationLabel');
        if (!marker) return;

        const currentQuarter = game.cityMap.currentLocation || (game.housing ? game.housing.neighborhood : null);
        if (!currentQuarter) return;
        
        const zone = document.querySelector(`[data-quarter="${currentQuarter}"]`);
        
        if (zone) {
            const rect = zone.getBoundingClientRect();
            const container = $('visualMapContainer').getBoundingClientRect();
            
            const x = rect.left - container.left + (rect.width / 2) - 20;
            const y = rect.top - container.top + (rect.height / 2) - 20;
            
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.display = 'flex';
            
            // Update marker with building info
            const building = game.cityMap.currentBuilding || 'home';
            const buildingName = getBuildingName(building);
            marker.title = `üìç ${NEIGHBORHOODS[currentQuarter].name}\nüè¢ ${buildingName}`;
            
            // Update location label
            if (label) {
                label.textContent = buildingName;
            }
        }
    }
    
    function getBuildingName(buildingId) {
        const buildingNames = {
            'home': 'üè† Casa',
            'work': 'üíº Lavoro',
            'supermarket': 'üõí Supermercato',
            'gym': 'üí™ Palestra',
            'library': 'üìö Biblioteca',
            'museum': 'üèõÔ∏è Museo',
            'park': 'üå≥ Parco',
            'restaurant': 'üçΩÔ∏è Ristorante',
            'bar': 'üç∫ Bar',
            'nightclub': 'üéâ Discoteca',
            'cinema': 'üé¨ Cinema',
            'theater': 'üé≠ Teatro',
            'hospital': 'üè• Ospedale',
            'police': 'üëÆ Polizia',
            'bank': 'üè¶ Banca',
            'mall': 'üè¨ Centro Commerciale',
            'street': 'üö∂ Per Strada'
        };
        return buildingNames[buildingId] || 'üìç Luogo Sconosciuto';
    }

    function initializeVisualMap() {
        // This function will now only update the player marker on the overview map
        // Detailed markers (bus stops, landmarks, businesses) will be rendered by showDetailedQuarterMap
        const container = $('visualMapContainer');
        if (!container) return;

        // Clear any existing detailed markers from previous views
        container.querySelectorAll('.bus-stop, .landmark-marker, .business-marker').forEach(marker => marker.remove());

        // Update player marker on init
        const currentLoc = game.cityMap.currentLocation || (game.housing ? game.housing.neighborhood : null);
        if (currentLoc) {
            updatePlayerMarker(currentLoc);
        }
    }

    function showMapTooltip(event, text) {
        const tooltip = $('mapTooltip');
        if (!tooltip) return;
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (event.clientY - tooltip.offsetHeight - 10) + 'px';
    }

    function hideMapTooltip() {
        const tooltip = $('mapTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    function showDetailedQuarterMap(quarterId) {
        const overviewMap = $('overviewMapGrid');
        const detailedMap = $('detailedQuarterMap');
        const detailedMapGrid = $('detailedMapGrid');
        const detailedQuarterName = $('detailedQuarterName');

        overviewMap.style.display = 'none';
        detailedMap.classList.add('active');

        const hood = NEIGHBORHOODS[quarterId];
        detailedQuarterName.innerHTML = `üó∫Ô∏è ${hood.name} - Dettaglio`;
        detailedMapGrid.innerHTML = ''; // Clear previous content

        // Render roads
        renderRoads(quarterId, detailedMapGrid);

        // Render locations (shops, landmarks, etc.)
        renderLocations(quarterId, detailedMapGrid);

        // Update player marker position on detailed map
        updatePlayerMarkerDetailed(quarterId);
    }

    function hideDetailedQuarterMap() {
        $('detailedQuarterMap').classList.remove('active');
        $('overviewMapGrid').style.display = 'grid';
        // Re-initialize overview map markers if needed
        initializeVisualMap();
        // Reset dropdown
        $('quarterSelect').value = '';
        $('quarterDetails').innerHTML = '';
    }

    function renderRoads(quarterId, container) {
        const hood = NEIGHBORHOODS[quarterId];
        if (!hood || !hood.streets) return;

        // Clear existing roads
        container.querySelectorAll('.map-road, .road-label').forEach(el => el.remove());

        // Define a more visually appealing road network
        // For simplicity, let's create a few main roads and intersections
        const roadsData = [
            // Horizontal roads
            { type: 'h', x: 0, y: 25, length: 100, name: hood.streets[0] || 'Main Street' },
            { type: 'h', x: 0, y: 50, length: 100, name: hood.streets[1] || 'Central Avenue' },
            { type: 'h', x: 0, y: 75, length: 100, name: hood.streets[2] || 'Park Road' },
            // Vertical roads
            { type: 'v', x: 25, y: 0, length: 100, name: hood.streets[3] || 'North Street' },
            { type: 'v', x: 50, y: 0, length: 100, name: hood.streets[4] || 'East Street' },
            { type: 'v', x: 75, y: 0, length: 100, name: hood.streets[5] || 'West Street' }
        ];

        roadsData.forEach(road => {
            const roadEl = document.createElement('div');
            roadEl.className = `map-road ${road.type === 'h' ? 'road-h' : 'road-v'}`;
            roadEl.style.left = road.x + '%';
            roadEl.style.top = road.y + '%';
            if (road.type === 'h') {
                roadEl.style.width = road.length + '%';
            } else {
                roadEl.style.height = road.length + '%';
            }
            container.appendChild(roadEl);

            // Add road labels
            const labelEl = document.createElement('div');
            labelEl.className = 'road-label';
            labelEl.textContent = road.name;
            if (road.type === 'h') {
                labelEl.style.left = `${road.x + road.length / 2}%`;
                labelEl.style.top = `${road.y - 10}px`; // Position above road
                labelEl.style.transform = 'translateX(-50%)';
            } else {
                labelEl.style.left = `${road.x - 10}px`; // Position left of road
                labelEl.style.top = `${road.y + road.length / 2}%`;
                labelEl.style.transform = 'translateY(-50%) rotate(-90deg)';
                labelEl.style.transformOrigin = 'left center';
            }
            container.appendChild(labelEl);
        });
    }

    function renderLocations(quarterId, container) {
        const locations = CITY_LOCATIONS[quarterId] || [];

        locations.forEach(loc => {
            const markerWrapper = document.createElement('div');
            markerWrapper.className = 'location-marker-wrapper'; // New wrapper for marker + label
            markerWrapper.style.left = loc.x + '%';
            markerWrapper.style.top = loc.y + '%';
            
            const marker = document.createElement('div');
            marker.className = 'location-marker';
            
            let icon = '';
            let bgColor = '';

            if (loc.type === 'shop') {
                icon = 'üè™';
                bgColor = 'var(--primary)';
            } else if (loc.type === 'landmark') {
                icon = 'üèõÔ∏è';
                bgColor = 'var(--success)';
            } else if (loc.type === 'empty') {
                icon = 'üèóÔ∏è';
                bgColor = 'var(--warning)';
            } else if (loc.type === 'residence') {
                icon = 'üè†';
                bgColor = 'rgba(255,255,255,0.3)';
            }

            marker.innerHTML = icon;
            marker.style.background = bgColor;
            marker.title = loc.name; // Tooltip on hover

            // Add label
            const label = document.createElement('span');
            label.className = 'location-label';
            label.textContent = loc.name;

            markerWrapper.appendChild(marker);
            markerWrapper.appendChild(label);
            
            // Click per aprire popup spostamento
            markerWrapper.style.cursor = 'pointer';
            markerWrapper.addEventListener('click', () => {
                showTravelPopup(loc, quarterId, icon);
            });
            
            markerWrapper.addEventListener('mouseenter', (e) => {
                showMapTooltip(e, `${icon} ${loc.name} - ${loc.street}`);
            });
            markerWrapper.addEventListener('mouseleave', hideMapTooltip);
            
            container.appendChild(markerWrapper);
        });
        
        // Aggiungi marker del lavoro se esiste e siamo nel quartiere giusto
        console.log('üîç Checking work marker:', {
            hasWorkData: !!game.workData,
            hasWorkLocation: !!(game.workData && game.workData.workLocation),
            workNeighborhood: game.workData?.workLocation?.neighborhood,
            currentQuarter: quarterId,
            job: game.player.job
        });
        
        if (game.workData && game.workData.workLocation && 
            game.workData.workLocation.neighborhood === quarterId && 
            game.player.job !== 'Disoccupato') {
            
            const workLoc = game.workData.workLocation;
            console.log('‚úÖ Adding work marker at:', workLoc.coordinates);
            
            const markerWrapper = document.createElement('div');
            markerWrapper.className = 'location-marker-wrapper work-location-marker';
            markerWrapper.style.position = 'absolute';
            markerWrapper.style.left = workLoc.coordinates.x + '%';
            markerWrapper.style.top = workLoc.coordinates.y + '%';
            markerWrapper.style.transform = 'translate(-50%, -50%)';
            markerWrapper.style.zIndex = '1000';
            
            const marker = document.createElement('div');
            marker.className = 'location-marker';
            marker.innerHTML = 'üíº';
            marker.style.background = '#4CAF50';
            marker.style.animation = 'pulse 2s infinite';
            marker.style.fontSize = '24px';
            marker.style.padding = '8px';
            marker.style.borderRadius = '50%';
            marker.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            marker.title = 'Il tuo lavoro';
            
            const label = document.createElement('span');
            label.className = 'location-label';
            label.style.whiteSpace = 'nowrap';
            label.textContent = game.workData.workPlaceName || 'Lavoro';
            
            markerWrapper.appendChild(marker);
            markerWrapper.appendChild(label);
            
            // Click per mostrare dettagli
            markerWrapper.style.cursor = 'pointer';
            markerWrapper.addEventListener('click', () => {
                console.log('üíº Work marker clicked!');
                showWorkLocationDetails();
            });
            
            markerWrapper.addEventListener('mouseenter', (e) => {
                showMapTooltip(e, `üíº ${game.workData.workPlaceName}\n${workLoc.address}\n${game.player.job} - ‚Ç¨${game.player.jobSalary}/giorno`);
            });
            markerWrapper.addEventListener('mouseleave', hideMapTooltip);
            
            container.appendChild(markerWrapper);
            console.log('‚úÖ Work marker added to container');
        } else {
            console.log('‚ùå Work marker NOT added - conditions not met');
        }
    }

    function updatePlayerMarkerDetailed(quarterId) {
        const marker = $('playerMarker');
        const label = $('playerLocationLabel');
        if (!marker) return;

        const currentQuarter = game.cityMap.currentLocation;
        if (currentQuarter !== quarterId) {
            // If player is not in this detailed quarter, hide marker
            marker.style.display = 'none';
            return;
        }

        // Find player's current location (residence or building)
        const locations = CITY_LOCATIONS[quarterId];
        if (!locations) {
            marker.style.display = 'none';
            return;
        }
        
        let playerLocation = null;
        
        // If at home, find residence
        if (game.cityMap.currentBuilding === 'home' && game.housing.residenceId) {
            playerLocation = locations.find(loc => loc.id === game.housing.residenceId);
        }
        
        // If at work, find work location
        if (game.cityMap.currentBuilding === 'work' && game.workData && game.workData.currentJob) {
            // Work locations will need to be added later or use a default position
            playerLocation = { x: 50, y: 50 }; // Default center for now
        }
        
        // Otherwise try to match building type with location
        if (!playerLocation) {
            const buildingTypeMap = {
                'supermarket': 'supermercato',
                'gym': 'palestra',
                'library': 'libreria',
                'museum': 'galleria',
                'park': 'parco',
                'restaurant': 'ristorante',
                'bar': 'bar',
                'nightclub': 'nightclub',
                'cinema': 'cinema',
                'theater': 'teatro'
            };
            
            const searchBusiness = buildingTypeMap[game.cityMap.currentBuilding];
            if (searchBusiness) {
                playerLocation = locations.find(loc => loc.business === searchBusiness || loc.type === searchBusiness);
            }
        }
        
        // If still no location, use default center
        if (!playerLocation) {
            playerLocation = { x: 50, y: 50 };
        }

        // Position marker at specific coordinates
        marker.style.left = playerLocation.x + '%';
        marker.style.top = playerLocation.y + '%';
        marker.style.display = 'flex';
        
        // Update label
        if (label) {
            const building = game.cityMap.currentBuilding || 'home';
            label.textContent = getBuildingName(building);
        }
    }

    function showMapTooltip(event, text) {
        const tooltip = $('mapTooltip');
        if (!tooltip) return;
        
        tooltip.textContent = text;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX - tooltip.offsetWidth / 2) + 'px';
        tooltip.style.top = (event.clientY - tooltip.offsetHeight - 10) + 'px';
    }

    function hideMapTooltip() {
        const tooltip = $('mapTooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    function showWorkLocationDetails() {
        if (!game.workData || !game.workData.workLocation || game.player.job === 'Disoccupato') {
            showNotification('‚ùå Non hai un lavoro!', 2000);
            return;
        }
        
        const workLoc = game.workData.workLocation;
        const job = game.workData.currentJob;
        const placeName = game.workData.workPlaceName;
        const neighborhood = NEIGHBORHOODS[workLoc.neighborhood];
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;">üíº Il Tuo Lavoro</h3>
                
                <div style="background:linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding:16px; border-radius:12px; margin-bottom:16px; text-align:center;">
                    <h2 style="margin:0 0 8px 0; font-size:1.5rem;">${placeName}</h2>
                    <div style="font-size:0.9rem; opacity:0.9;">
                        ${workLoc.address}<br>
                        üìç ${neighborhood.name}
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;">üëî Informazioni Lavoro</h4>
                    <div style="font-size:0.9rem;">
                        üíº <strong>Posizione:</strong> ${game.player.job}<br>
                        üí∞ <strong>Stipendio:</strong> ‚Ç¨${game.player.jobSalary}/giorno<br>
                        ${job ? `‚è∞ <strong>Orario:</strong> ${job.hours.start}:00 - ${job.hours.end}:00<br>` : ''}
                        ${job && job.manager ? `üë§ <strong>Manager:</strong> ${job.manager}<br>` : ''}
                        üìä <strong>Performance:</strong> ${game.workData.performance || 75}%<br>
                        üìÖ <strong>Giorni lavorati:</strong> ${game.workData.daysWorked || 0}
                    </div>
                </div>
                
                ${job && job.tasks ? `
                    <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                        <h4 style="margin-bottom:10px;">üìã Mansioni Principali</h4>
                        <div style="font-size:0.9rem;">
                            ${job.tasks.map(task => `‚Ä¢ ${task}`).join('<br>')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;">üó∫Ô∏è Come Raggiungerlo</h4>
                    <div style="font-size:0.9rem;">
                        üö∂ A piedi dal centro: ~${randInt(5, 20)} minuti<br>
                        üöå Fermata bus pi√π vicina: ${neighborhood.streets[randInt(0, neighborhood.streets.length - 1)]}<br>
                        üí∏ Costo taxi: ~‚Ç¨${randInt(5, 15)}
                    </div>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button onclick="travelToWork()" class="action-btn" style="flex:1; background:var(--success);">
                        üöó Vai al Lavoro
                    </button>
                    ${game.workData.todayWorked ? 
                        '<button disabled class="action-btn" style="flex:1; opacity:0.5;">‚úÖ Gi√† lavorato oggi</button>' :
                        '<button onclick="closeDialog(); doWorkDay();" class="action-btn" style="flex:1; background:var(--primary);">üíº Inizia Lavoro</button>'
                    }
                </div>
            </div>
            <div style="padding:16px; border-top:2px solid rgba(255,255,255,0.1);">
                <button onclick="closeDialog()" class="action-btn" style="width:100%;">Chiudi</button>
            </div>
        `;
        
        showDialog(html);
    }

    function showTravelPopup(location, neighborhood, icon) {
        const neighborhoodData = NEIGHBORHOODS[neighborhood];
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, neighborhood);
        const currentLoc = game.cityMap.currentLocation ? NEIGHBORHOODS[game.cityMap.currentLocation].name : 'posizione sconosciuta';
        
        // Controlla se ci sono NPCs in questa location
        const npcsHere = getNPCsAtLocation(location.id, neighborhood);
        
        // Determina azioni disponibili in base al tipo
        let actions = getLocationActions(location, neighborhood);
        
        const html = `
            <div style="max-height:70vh; overflow-y:auto; padding:20px;">
                <h3 style="margin-bottom:16px;">${icon} ${location.name}</h3>
                
                <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding:16px; border-radius:12px; margin-bottom:16px; text-align:center;">
                    <h2 style="margin:0 0 8px 0; font-size:1.3rem;">${location.street}</h2>
                    <div style="font-size:0.9rem; opacity:0.9;">
                        üìç ${neighborhoodData.name}
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;">‚ÑπÔ∏è Informazioni</h4>
                    <div style="font-size:0.9rem;">
                        üè∑Ô∏è <strong>Tipo:</strong> ${location.type === 'shop' ? 'Negozio' : location.type === 'landmark' ? 'Punto d\'interesse' : location.type === 'residence' ? 'Residenza' : 'Area in costruzione'}<br>
                        ${location.business ? `ÔøΩ <strong>Attivit√†:</strong> ${location.business}<br>` : ''}
                        üìå <strong>Indirizzo:</strong> ${location.street}
                    </div>
                </div>
                
                ${npcsHere.length > 0 ? `
                    <div style="background:rgba(56,239,125,0.1); padding:14px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(56,239,125,0.3);">
                        <h4 style="margin-bottom:10px;">üë• Persone Presenti</h4>
                        ${npcsHere.map(npc => `
                            <div style="padding:8px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${npc.known ? npc.name : '??? Sconosciuto'}</strong>
                                    <div style="font-size:0.85rem; opacity:0.8;">${npc.known ? npc.job : 'Non lo conosci ancora'}</div>
                                </div>
                                ${npc.known ? `<div style="color:var(--success);">‚ù§Ô∏è ${npc.relation}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="background:rgba(255,255,255,0.05); padding:14px; border-radius:8px; margin-bottom:12px;">
                    <h4 style="margin-bottom:10px;">üö∂ Viaggio</h4>
                    <div style="font-size:0.9rem;">
                        üìç <strong>Posizione attuale:</strong> ${currentLoc}<br>
                        ‚è±Ô∏è <strong>Tempo stimato:</strong> ${travelTime} minuti<br>
                        üí∏ <strong>Costo:</strong> Gratuito (a piedi)
                    </div>
                </div>
                
                ${actions.length > 0 ? `
                    <div style="background:rgba(102,126,234,0.1); padding:14px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(102,126,234,0.3);">
                        <h4 style="margin-bottom:10px;">‚ö° Azioni Disponibili</h4>
                        <div style="display:grid; gap:8px;">
                            ${actions.map(action => `
                                <button onclick="${action.onclick}" class="action-btn" style="text-align:left; padding:10px;">
                                    ${action.icon} ${action.label}
                                    ${action.subtitle ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:2px;">${action.subtitle}</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button onclick="travelToLocation('${location.id}', '${neighborhood}', '${location.name}')" class="action-btn" style="flex:1; background:var(--success);">
                        üöó Vai Qui (${travelTime} min)
                    </button>
                </div>
            </div>
        `;
        
        // NUOVO: invece di usare showDialog, crea popup custom
        // Crea overlay
        const overlay = document.createElement('div');
        overlay.className = 'location-popup-overlay';
        overlay.onclick = () => closeLocationPopup();
        
        // Crea popup
        const popup = document.createElement('div');
        popup.className = 'location-popup';
        popup.id = 'locationPopup';
        
        popup.innerHTML = `
            <div class="location-popup-header">
                <div class="location-popup-icon">${icon}</div>
                <div class="location-popup-info">
                    <h3>${location.name}</h3>
                    <p>üìç ${location.street}, ${neighborhoodData.name}</p>
                </div>
            </div>
            
            ${npcsHere.length > 0 ? `
                <div style="background:rgba(56,239,125,0.1); padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid var(--success);">
                    <div style="font-weight:600; margin-bottom:8px;">üë• Persone Presenti (${npcsHere.length})</div>
                    ${npcsHere.map(npc => `
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="closeLocationPopup(); showNpcChat('${npc.id}')">
                            <div>
                                <strong>${npc.known ? npc.name : '??? Sconosciuto'}</strong>
                                <div style="font-size:0.8rem; opacity:0.8;">${npc.known ? npc.job : 'Non lo conosci ancora'}</div>
                            </div>
                            ${npc.known ? `<div style="color:var(--success);">‚ù§Ô∏è ${npc.relation}</div>` : '<button class="small">üëã Parla</button>'}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div class="location-popup-actions">
                <div class="location-action-btn" onclick="closeLocationPopup(); travelToLocation('${location.id}', '${neighborhood}', '${location.name}')">
                    <div class="location-action-icon">üö∂</div>
                    <div class="location-action-text">
                        <div class="location-action-title">Vai Qui</div>
                        <div class="location-action-desc">‚è±Ô∏è ${travelTime} minuti ‚Ä¢ Da: ${currentLoc}</div>
                    </div>
                </div>
                
                ${actions.map(action => `
                    <div class="location-action-btn" onclick="${action.onclick}">
                        <div class="location-action-icon">${action.icon}</div>
                        <div class="location-action-text">
                            <div class="location-action-title">${action.label}</div>
                            ${action.subtitle ? `<div class="location-action-desc">${action.subtitle}</div>` : ''}
                            ${action.cost ? `<div class="location-action-cost">üí∞ ${action.cost}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <button class="location-popup-close" onclick="closeLocationPopup()">‚úï Chiudi</button>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
    }
    
    function getNPCsAtLocation(locationId, neighborhood) {
        const currentDay = (game.time.day - 1) % 7 + 1; // 1-7 (Lun-Dom)
        const currentHour = game.time.hour;
        
        return game.npcs.filter(npc => {
            const schedule = npc.schedule;
            const isWorkDay = schedule.workDays.includes(currentDay);
            const isWorkHour = currentHour >= schedule.workHours.start && currentHour <= schedule.workHours.end;
            
            // NPC √® al lavoro
            if (npc.locationId === locationId && isWorkDay && isWorkHour) {
                return true;
            }
            
            // NPC √® a casa (nei giorni liberi o fuori orario)
            if (npc.homeLocationId === locationId && (!isWorkDay || !isWorkHour)) {
                return true;
            }
            
            return false;
        });
    }
    
    function closeLocationPopup() {
        const overlay = document.querySelector('.location-popup-overlay');
        const popup = document.getElementById('locationPopup');
        if (overlay) overlay.remove();
        if (popup) popup.remove();
    }
    
    function getLocationActions(location, neighborhood) {
        const actions = [];
        
        // Azioni per NEGOZI
        if (location.type === 'shop') {
            if (location.business === 'supermercato' || location.business === 'minimarket') {
                actions.push({
                    icon: 'üõí',
                    label: 'Fai la Spesa',
                    subtitle: 'Compra cibo e prodotti',
                    onclick: `closeLocationPopup(); showShoppingAt('${location.id}', '${location.name}')`
                });
            }
            
            if (location.business === 'palestra') {
                actions.push({
                    icon: 'üí™',
                    label: 'Allenati',
                    subtitle: '+Fitness, -Energia, -Fame (1h)',
                    onclick: `closeLocationPopup(); trainAtGym('${location.id}')`
                });
            }
            
            if (location.business === 'libreria') {
                actions.push({
                    icon: 'üìö',
                    label: 'Studia',
                    subtitle: '+Intelletto, -Energia (1h)',
                    onclick: `closeLocationPopup(); studyAtLibrary('${location.id}')`
                });
            }
            
            if (location.business === 'galleria' || location.business === 'teatro') {
                actions.push({
                    icon: 'üé®',
                    label: 'Visita Culturale',
                    subtitle: '+Creativit√†, +Morale (1h)',
                    onclick: `closeLocationPopup(); visitCulturalSite('${location.id}')`
                });
            }
            
            if (location.business === 'bar' || location.business === 'ristorante') {
                actions.push({
                    icon: '‚òï',
                    label: 'Prendi qualcosa',
                    subtitle: 'Mangia/bevi, +Morale',
                    cost: '‚Ç¨5-20',
                    onclick: `closeLocationPopup(); eatAtRestaurant('${location.id}', '${location.name}')`
                });
            }
            
            if (location.business === 'banca') {
                actions.push({
                    icon: 'üè¶',
                    label: 'Servizi Bancari',
                    subtitle: 'Prestiti e investimenti',
                    onclick: `closeLocationPopup(); showBankServices('${location.id}', '${location.name}')`
                });
            }
        }
        
        // Azioni per LANDMARK
        if (location.type === 'landmark') {
            if (location.business === 'parco' || location.business === 'sport') {
                actions.push({
                    icon: 'üèÉ',
                    label: 'Corri al Parco',
                    subtitle: '+Fitness, +Morale, -Energia (1h)',
                    onclick: `closeLocationPopup(); runInPark('${location.id}')`
                });
            }
        }
        
        // Azioni per RESIDENZE (visitare NPCs)
        if (location.type === 'residence') {
            const npcsLivingHere = game.npcs.filter(npc => npc.homeLocationId === location.id && npc.known && npc.relation >= 30);
            npcsLivingHere.forEach(npc => {
                actions.push({
                    icon: 'üè†',
                    label: `Visita ${npc.name}`,
                    subtitle: `Passa del tempo con ${npc.name}`,
                    onclick: `closeLocationPopup(); visitNPCHome('${npc.id}', '${location.id}')`
                });
            });
        }
        
        return actions;
    }

    function calculateTravelTime(fromNeighborhood, toNeighborhood) {
        if (!fromNeighborhood || fromNeighborhood === toNeighborhood) {
            return randInt(5, 15); // Stesso quartiere
        }
        return randInt(15, 45); // Quartiere diverso
    }

    function travelToLocation(locationId, neighborhood, locationName) {
        const travelTime = calculateTravelTime(game.cityMap.currentLocation, neighborhood);
        
        game.cityMap.currentLocation = neighborhood;
        game.cityMap.currentBuilding = locationId;
        
        closeDialog();
        showNotification(`üöó Sei arrivato a ${locationName}!`, 2000);
    addMinutes(travelTime); // Ora gestione minuti diretta
        updateUI();
        
        // Mostra mappa dettagliata del quartiere
        showDetailedQuarterMap(neighborhood);
    }

    function travelToWork() {
        if (!game.workData || !game.workData.workLocation) {
            showNotification('‚ùå Non hai un lavoro!', 2000);
            return;
        }
        
        const workLoc = game.workData.workLocation;
        game.cityMap.currentLocation = workLoc.neighborhood;
        game.cityMap.currentBuilding = 'work';
        
        closeDialog();
        showNotification(`üöó Sei arrivato a ${game.workData.workPlaceName}!`, 2000);
    addMinutes(30);
        updateUI();
        
        // Mostra mappa dettagliata del quartiere
        showDetailedQuarterMap(workLoc.neighborhood);
    }
    
    // ========== AZIONI NELLE LOCATION ==========
    
    function trainAtGym(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente in palestra per allenarti!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 20) {
            showNotification('‚ùå Sei troppo stanco per allenarti!', 2000);
            return;
        }
        
        const cost = 10;
        if (game.player.money < cost) {
            showNotification('‚ùå Non hai abbastanza soldi! (‚Ç¨10)', 2000);
            return;
        }
        
        game.player.money -= cost;
        game.player.stats.energy -= 20;
        game.player.stats.hunger -= 15;
        game.player.skills.fitness += randInt(2, 5);
        passTime(1);
        
        showNotification('üí™ Ottimo allenamento! +Fitness, -‚Ç¨10', 2000);
        
        // Possibilit√† di incontrare qualcuno
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function studyAtLibrary(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente in libreria per studiare!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 15) {
            showNotification('‚ùå Sei troppo stanco per studiare!', 2000);
            return;
        }
        
        game.player.stats.energy -= 15;
        game.player.skills.intellect += randInt(2, 4);
        passTime(1);
        
        showNotification('üìö Hai studiato con profitto! +Intelletto', 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function visitCulturalSite(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente al sito culturale per visitarlo!', 2500);
            return;
        }
        
        const cost = 15;
        if (game.player.money < cost) {
            showNotification('‚ùå Biglietto d\'ingresso: ‚Ç¨15', 2000);
            return;
        }
        
        game.player.money -= cost;
        game.player.stats.morale += 10;
        game.player.skills.creativity += randInt(1, 3);
        passTime(1);
        
        showNotification('üé® Che bella esperienza culturale! +Creativit√†, +Morale, -‚Ç¨15', 2500);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function runInPark(locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente al parco per correre!', 2500);
            return;
        }
        
        if (game.player.stats.energy < 15) {
            showNotification('‚ùå Sei troppo stanco per correre!', 2000);
            return;
        }
        
        game.player.stats.energy -= 15;
        game.player.stats.hunger -= 10;
        game.player.stats.morale += 5;
        game.player.skills.fitness += randInt(1, 3);
        passTime(1);
        
        showNotification('üèÉ Ottima corsa! +Fitness, +Morale', 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    function eatAtRestaurant(locationId, locationName) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente al ristorante per mangiare!', 2500);
            return;
        }
        
        const options = [
            { name: 'Caff√®', cost: 2, hunger: 5, morale: 3 },
            { name: 'Panino', cost: 5, hunger: 15, morale: 5 },
            { name: 'Pranzo completo', cost: 15, hunger: 40, morale: 10 }
        ];
        
        const choice = prompt(`Cosa vuoi ordinare da ${locationName}?\n1. Caff√® (‚Ç¨2)\n2. Panino (‚Ç¨5)\n3. Pranzo completo (‚Ç¨15)\n\nScrivi 1, 2 o 3:`);
        if (!choice) return;
        
        const idx = parseInt(choice) - 1;
        if (idx < 0 || idx >= options.length) {
            showNotification('‚ùå Scelta non valida!', 1500);
            return;
        }
        
        const selected = options[idx];
        if (game.player.money < selected.cost) {
            showNotification(`‚ùå Non hai abbastanza soldi! (‚Ç¨${selected.cost})`, 2000);
            return;
        }
        
        game.player.money -= selected.cost;
        game.player.stats.hunger = Math.min(100, game.player.stats.hunger + selected.hunger);
        game.player.stats.morale = Math.min(100, game.player.stats.morale + selected.morale);
        addMinutes(30); // 30 minuti per mangiare
        
        showNotification(`‚òï ${selected.name} ordinato! +Fame, +Morale, -‚Ç¨${selected.cost}`, 2000);
        checkRandomEncounter(locationId);
        updateUI();
    }
    
    // ---------- BANK SERVICES ----------
    function showBankServices(locationId, bankName) {
        // Controlla se sei fisicamente nella banca
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente in banca!', 2500);
            return;
        }
        
        const creditScore = calculateCreditScore();
        const maxLoan = Math.floor(creditScore * 500); // Max ‚Ç¨1000-50000
        const interestRate = Math.max(5, 20 - (creditScore / 10)); // 5-15% based on creditScore
        
        showDialog(`
            <h2>üè¶ ${bankName}</h2>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0;">
                <h3>Il tuo profilo creditizio</h3>
                <p>üìä Credit Score: ${creditScore}/100</p>
                <p>üí∞ Prestito massimo: ‚Ç¨${maxLoan.toFixed(0)}</p>
                <p>üìà Tasso interesse: ${interestRate.toFixed(1)}%</p>
                <p>üí≥ Prestiti attivi: ${game.investments.loans.length}</p>
            </div>
            
            ${game.investments.loans.length > 0 ? `
                <div style="background: rgba(255,100,100,0.2); padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h3>üìã I tuoi prestiti</h3>
                    ${game.investments.loans.map(loan => `
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 5px 0;">
                            <p><strong>${loan.bank}</strong></p>
                            <p>Importo: ‚Ç¨${loan.amount.toFixed(0)} | Rate mensili: ‚Ç¨${loan.monthlyPayment.toFixed(0)}</p>
                            <p>Rate rimanenti: ${loan.remainingMonths} | Tasso: ${loan.interestRate.toFixed(1)}%</p>
                            ${loan.missedPayments ? `<p style="color: #ff0000;">‚ö†Ô∏è Rate mancate: ${loan.missedPayments}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="requestLoan('${locationId}', '${bankName}', ${maxLoan}, ${interestRate})" 
                    style="flex: 1; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    üíµ Richiedi Prestito
                </button>
                <button onclick="closeDialog()" 
                    style="flex: 1; padding: 15px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ‚ùå Esci
                </button>
            </div>
        `);
    }
    
    function calculateCreditScore() {
        let score = 50; // Base score
        
        // Job status
        if (game.player.job !== 'Disoccupato') {
            score += 20;
            // Salary influence
            const salary = game.player.salary || 0;
            if (salary > 2000) score += 10;
            else if (salary > 1000) score += 5;
        } else {
            score -= 15;
        }
        
        // Money in bank
        if (game.player.money > 10000) score += 15;
        else if (game.player.money > 5000) score += 10;
        else if (game.player.money > 1000) score += 5;
        else if (game.player.money < 0) score -= 20;
        
        // Reputation
        if (game.player.rep > 80) score += 10;
        else if (game.player.rep > 50) score += 5;
        else if (game.player.rep < 20) score -= 10;
        
        // Existing loans
        score -= game.investments.loans.length * 10;
        
        // Missed payments
        game.investments.loans.forEach(loan => {
            if (loan.missedPayments) score -= loan.missedPayments * 15;
        });
        
        return Math.max(10, Math.min(100, score));
    }
    
    function requestLoan(locationId, bankName, maxLoan, interestRate) {
        closeDialog();
        
        if (game.investments.loans.length >= 3) {
            showNotification('‚ùå Non puoi avere pi√π di 3 prestiti attivi contemporaneamente!', 3000);
            return;
        }
        
        const amount = prompt(`Quanto vuoi richiedere in prestito?\n\nMassimo: ‚Ç¨${maxLoan.toFixed(0)}\nTasso interesse: ${interestRate.toFixed(1)}%\n\nInserisci l'importo:`);
        if (!amount) return;
        
        const loanAmount = parseFloat(amount);
        if (isNaN(loanAmount) || loanAmount <= 0) {
            showNotification('‚ùå Importo non valido!', 2000);
            return;
        }
        
        if (loanAmount > maxLoan) {
            showNotification(`‚ùå Puoi richiedere massimo ‚Ç¨${maxLoan.toFixed(0)}!`, 2500);
            return;
        }
        
        if (loanAmount < 1000) {
            showNotification('‚ùå Importo minimo: ‚Ç¨1000!', 2000);
            return;
        }
        
        const months = prompt(`In quanti mesi vuoi restituire il prestito?\n\nMin: 6 mesi | Max: 60 mesi\n\nInserisci il numero di mesi:`);
        if (!months) return;
        
        const loanMonths = parseInt(months);
        if (isNaN(loanMonths) || loanMonths < 6 || loanMonths > 60) {
            showNotification('‚ùå Durata non valida! (6-60 mesi)', 2500);
            return;
        }
        
        const totalWithInterest = loanAmount * (1 + interestRate / 100);
        const monthlyPayment = totalWithInterest / loanMonths;
        
        const confirm = window.confirm(
            `Confermi il prestito?\n\n` +
            `Importo: ‚Ç¨${loanAmount.toFixed(0)}\n` +
            `Durata: ${loanMonths} mesi\n` +
            `Tasso: ${interestRate.toFixed(1)}%\n` +
            `Totale da restituire: ‚Ç¨${totalWithInterest.toFixed(0)}\n` +
            `Rata mensile: ‚Ç¨${monthlyPayment.toFixed(0)}`
        );
        
        if (!confirm) {
            showNotification('‚ùå Richiesta annullata.', 1500);
            return;
        }
        
        // Crea il prestito
        const loan = {
            id: 'loan_' + Date.now(),
            amount: loanAmount,
            interestRate: interestRate,
            monthlyPayment: monthlyPayment,
            remainingMonths: loanMonths,
            bank: bankName,
            takenDay: game.time.day,
            missedPayments: 0
        };
        
        game.investments.loans.push(loan);
        game.player.money += loanAmount;
        game.player.cash += loanAmount;
        
        showNotification(`‚úÖ Prestito approvato! +‚Ç¨${loanAmount.toFixed(0)}\nPrima rata tra 30 giorni.`, 4000);
        updateUI();
    }

    function visitNPCHome(npcId, locationId) {
        // Controlla se sei fisicamente nella location
        if (game.cityMap?.currentBuilding !== locationId) {
            showNotification('‚ùå Devi andare fisicamente a casa della persona per visitarla!', 2500);
            return;
        }
        
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;
        
        if (npc.relation < 30) {
            showNotification(`‚ùå Non conosci abbastanza ${npc.name} per visitarlo a casa!`, 2500);
            return;
        }
        
        const relationGain = randInt(5, 10);
        npc.relation = Math.min(100, npc.relation + relationGain);
        game.player.stats.morale += 5;
        game.player.stats.energy -= 10;
        passTime(2);
        
        showNotification(`üè† Bella serata con ${npc.name}! Relazione: +${relationGain}`, 2500);
        updateUI();
        
        // Apri dialogo
        setTimeout(() => openDialogue(npcId), 1000);
    }
    
    function checkRandomEncounter(locationId) {
        // 30% possibilit√† di incontrare qualcuno
        if (Math.random() > 0.3) return;
        
        const npcsHere = getNPCsAtLocation(locationId, game.cityMap.currentLocation);
        if (npcsHere.length === 0) return;
        
        const npc = npcsHere[randInt(0, npcsHere.length - 1)];
        
        if (!npc.known) {
            // Primo incontro!
            npc.known = true;
            npc.relation = randInt(10, 25);
            showNotification(`üëã Hai conosciuto ${npc.name} (${npc.job})! Relazione: ${npc.relation}`, 3000);
        } else {
            // Incontro casuale con conoscente
            const gain = randInt(1, 3);
            npc.relation = Math.min(100, npc.relation + gain);
            showNotification(`üòä Hai incontrato ${npc.name}! Relazione: +${gain}`, 2000);
        }
    }
    
    function showShoppingAt(locationId, locationName) {
        // Riusa il sistema shopping esistente
        switchMainTab('shop');
        showNotification(`üõí Benvenuto a ${locationName}!`, 1500);
    }

    // Initialize visual map when tab is opened
    // ---------- CITY MAP SYSTEM ----------
    function renderCityQuartiersMap() {
        const div = $('cityQuartiersMap');
        if (!div) return;

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        div.innerHTML = Object.keys(NEIGHBORHOODS).map(key => {
            const hood = NEIGHBORHOODS[key];
            const isCurrent = game.housing && game.housing.neighborhood === key;
            const locations = CITY_LOCATIONS[key] || [];
            const shops = locations.filter(l => l.type === 'shop').length;
            const empty = locations.filter(l => l.type === 'empty').length;
            const landmarks = locations.filter(l => l.type === 'landmark').length;

            return `
                <div style="padding:14px; background:rgba(255,255,255,${isCurrent ? '0.12' : '0.06'}); border-radius:10px; margin-bottom:12px; border-left:3px solid ${isCurrent ? 'var(--primary)' : 'rgba(255,255,255,0.2)'};">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                            <h4 style="margin-bottom:4px;">${isCurrent ? 'üìç ' : ''}${hood.name}</h4>
                            <div style="font-size:0.85rem; opacity:0.8;">
                                üë• Popolazione: ${hood.population.toLocaleString()}<br>
                                üí∞ Reddito Medio: ‚Ç¨${hood.avgIncome.toLocaleString()}/anno
                            </div>
                        </div>
                        <button class="small" onclick="selectQuarter('${key}')">üìç Esplora</button>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px; font-size:0.85rem;">
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Negozi</div>
                            <div style="font-weight:bold;">${shops}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Disponibili</div>
                            <div style="font-weight:bold; color:var(--success);">${empty}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Punti Int.</div>
                            <div style="font-weight:bold;">${landmarks}</div>
                        </div>
                        <div style="padding:6px; background:rgba(0,0,0,0.2); border-radius:6px; text-align:center;">
                            <div style="opacity:0.7;">Fermate</div>
                            <div style="font-weight:bold;">${hood.busStops.length}</div>
                        </div>
                    </div>

                    <div style="margin-top:10px; font-size:0.8rem; opacity:0.7;">
                        üí° Interessi: ${hood.interests.join(', ')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectQuarter(quarterId) {
        $('quarterSelect').value = quarterId;
        exploreQuarter();
    }

    function exploreQuarter() {
        const quarterId = $('quarterSelect').value;
        if (!quarterId) {
            $('quarterDetails').innerHTML = '';
            return;
        }

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        // NUOVO: Apri la mappa grafica invece della lista
        showDetailedQuarterMap(quarterId);
        return;
        
        // Vecchio codice commentato per riferimento
        const hood = NEIGHBORHOODS[quarterId];
        const locations = CITY_LOCATIONS[quarterId] || [];

        let html = `
            <div style="padding:16px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <h4 style="margin-bottom:12px;">üìç ${hood.name}</h4>
                
                <div style="padding:12px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;">üìä Demografia</h5>
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; font-size:0.85rem;">
                        <div>üë∂ Giovani: ${hood.demographics.young}%</div>
                        <div>üë® Adulti: ${hood.demographics.adults}%</div>
                        <div>üë¥ Anziani: ${hood.demographics.elderly}%</div>
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;">üöå Fermate Bus</h5>
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${hood.busStops.map(stop => `
                            <span style="padding:6px 12px; background:rgba(102,126,234,0.2); border-radius:6px; font-size:0.85rem;">
                                üöè ${stop}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;">üõ£Ô∏è Strade Principali</h5>
                    <div style="font-size:0.85rem; opacity:0.9;">
                        ${hood.streets.join(' ‚Ä¢ ')}
                    </div>
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;">üèõÔ∏è Punti di Interesse</h5>
                    ${locations.filter(l => l.type === 'landmark').map(loc => `
                        <div style="padding:8px; background:rgba(56,239,125,0.1); border-radius:6px; margin-bottom:6px; border-left:3px solid var(--success);">
                            <div style="font-weight:bold;">${loc.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8;">üìç ${loc.street}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-bottom:16px;">
                    <h5 style="margin-bottom:8px;">üè™ Negozi & Attivit√†</h5>
                    ${locations.filter(l => l.type === 'shop').map(loc => {
                        const owned = game.cityMap.ownedBusinesses.some(b => b.locationId === loc.id);
                        return `
                            <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; ${owned ? 'border:2px solid var(--success);' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-weight:bold;">${owned ? '‚úÖ ' : ''}${loc.name}</div>
                                        <div style="font-size:0.85rem; opacity:0.8;">üìç ${loc.street}</div>
                                        <div style="font-size:0.85rem; opacity:0.7;">üí∞ Reddito: ~‚Ç¨${loc.income}/mese</div>
                                    </div>
                                    ${owned ? `<button class="small" onclick="manageOwnedBusiness('${loc.id}')">‚öôÔ∏è Gestisci</button>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div>
                    <h5 style="margin-bottom:8px;">üèóÔ∏è Lotti Disponibili</h5>
                    ${locations.filter(l => l.type === 'empty').map(loc => `
                        <div style="padding:12px; background:rgba(255,200,100,0.08); border-radius:8px; margin-bottom:8px; border-left:3px solid var(--warning);">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div>
                                    <div style="font-weight:bold;">üèóÔ∏è ${loc.name}</div>
                                    <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                        üìç ${loc.street}<br>
                                        üìè Dimensione: ${loc.size}<br>
                                        üí∞ Costo: ‚Ç¨${loc.cost.toLocaleString()}
                                    </div>
                                    <div style="margin-top:8px; font-size:0.85rem;">
                                        <strong>Attivit√† consigliate:</strong><br>
                                        ${hood.businessOpportunities.slice(0, 3).map(b => {
                                            const business = BUSINESS_TYPES[b];
                                            return business ? business.name : b;
                                        }).join(', ')}
                                    </div>
                                </div>
                                <button class="small" onclick="buyLocation('${loc.id}', '${quarterId}')">üí∞ Acquista</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        $('quarterDetails').innerHTML = html;
    }

    function buyLocation(locationId, quarterId) {
        const locations = CITY_LOCATIONS[quarterId];
        const location = locations.find(l => l.id === locationId);
        
        if (!location || location.type !== 'empty') {
            showNotification('Lotto non disponibile!', 1500);
            return;
        }

        if (game.player.money < location.cost) {
            showNotification('üí∞ Non hai abbastanza soldi!', 1500);
            return;
        }

        // Show business selection
        const hood = NEIGHBORHOODS[quarterId];
        const businessOptions = hood.businessOpportunities.map(b => {
            const business = BUSINESS_TYPES[b];
            if (!business) return '';
            return `${business.name} (‚Ç¨${business.cost.toLocaleString()} - Reddito: ‚Ç¨${business.income[0]}-${business.income[1]}/mese)`;
        }).join('\n');

        const choice = prompt(`Scegli che attivit√† aprire:\n\n${businessOptions}\n\nDigita il numero (1-${hood.businessOpportunities.length}):`, '1');
        if (!choice) return;

        const index = parseInt(choice) - 1;
        const businessKey = hood.businessOpportunities[index];
        const businessType = BUSINESS_TYPES[businessKey];

        if (!businessType) {
            showNotification('Scelta non valida!', 1500);
            return;
        }

        const totalCost = location.cost + businessType.cost;
        if (game.player.money < totalCost) {
            showNotification(`üí∞ Costo totale: ‚Ç¨${totalCost.toLocaleString()}. Non hai abbastanza!`, 2000);
            return;
        }

        if (confirm(`Acquistare ${location.name} e aprire ${businessType.name}?\nCosto totale: ‚Ç¨${totalCost.toLocaleString()}`)) {
            game.player.money -= totalCost;
            
            // Update location
            location.type = 'shop';
            location.name = businessType.name + ' "' + game.player.name + '"';
            location.business = businessKey;
            location.status = 'owned';
            
            // Add to owned businesses
            game.cityMap.ownedBusinesses.push({
                locationId: locationId,
                quarterId: quarterId,
                businessType: businessKey,
                opened: game.time.day,
                income: businessType.income[0],
                employees: businessType.employees,
                level: 1
            });

            showNotification(`üéâ Hai aperto ${businessType.name}!`, 2500);
            exploreQuarter();
            updateUI();
        }
    }

    function manageOwnedBusiness(locationId) {
        const business = game.cityMap.ownedBusinesses.find(b => b.locationId === locationId);
        if (!business) return;

        const businessType = BUSINESS_TYPES[business.businessType];
        const location = Object.values(CITY_LOCATIONS).flat().find(l => l.id === locationId);

        alert(`üè™ ${location.name}\n\nüí∞ Reddito Mensile: ‚Ç¨${business.income}\nüë• Dipendenti: ${business.employees}\nüìä Livello: ${business.level}\nüìÖ Aperto da: ${game.time.day - business.opened} giorni`);
    }

    function collectBusinessIncome() {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }
        
        if (game.cityMap.ownedBusinesses && game.cityMap.ownedBusinesses.length > 0) {
            const totalIncome = game.cityMap.ownedBusinesses.reduce((sum, b) => sum + b.income, 0);
            game.player.money += totalIncome;
            showNotification(`üè™ Reddito attivit√†: +‚Ç¨${totalIncome}!`, 2000);
        }
    }

    function renderTransportInfo() {
        const div = $('transportInfo');
        if (!div) return;

        // Initialize cityMap if not exists
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
        
        div.innerHTML = `
            <div style="padding:10px; background:rgba(0,0,0,0.2); border-radius:8px;">
                <div style="font-weight:bold; margin-bottom:8px;">
                    ${hasPass ? '‚úÖ Abbonamento Attivo' : '‚ùå Nessun Abbonamento'}
                </div>
                ${hasPass ? `<div style="font-size:0.85rem; opacity:0.8;">Valido fino al giorno ${game.cityMap.transportPass}</div>` : ''}
            </div>

            <div style="margin-top:12px;">
                <h5 style="margin-bottom:8px;">üöå Linee Disponibili</h5>
                ${Object.keys(BUS_ROUTES).map(key => {
                    const route = BUS_ROUTES[key];
                    return `
                        <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                            <div style="font-weight:bold;">${route.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                üöè ${route.stops.join(' ‚Üí ')}<br>
                                üí∞ Costo: ‚Ç¨${route.cost} | ‚è±Ô∏è Tempo: ${route.time} min
                            </div>
                            <button class="small" style="margin-top:6px;" onclick="takeBus('${key}')" ${!hasPass ? '' : 'disabled'}>
                                ${hasPass ? '‚úì Incluso' : `Prendi (‚Ç¨${route.cost})`}
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    // ---------- VEHICLES SYSTEM ----------
    function renderVehiclesInfo() {
        const div = $('vehiclesInfo');
        if (!div) return;
        
        const currentLocation = game.cityMap.currentLocation;
        const currentVehicle = game.vehicles.active;
        
        let html = '<div style="margin-bottom:12px;">';
        html += '<div style="font-weight:600; margin-bottom:8px;">üö∂ Mezzo di Trasporto Attivo:</div>';
        
        if (!currentVehicle) {
            html += '<div style="padding:8px; background:rgba(255,200,100,0.15); border-radius:6px;">A piedi üö∂</div>';
        } else if (currentVehicle === 'public') {
            const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
            html += `<div style="padding:8px; background:rgba(100,150,255,0.15); border-radius:6px;">üöå Trasporto Pubblico${hasPass ? ' (con abbonamento)' : ''}</div>`;
        } else {
            const vehicle = VEHICLES[currentVehicle];
            html += `<div style="padding:8px; background:rgba(100,255,150,0.15); border-radius:6px;">${vehicle.emoji} ${vehicle.name}</div>`;
        }
        html += '</div>';
        
        // Show owned vehicles
        if (game.vehicles.owned && game.vehicles.owned.length > 0) {
            html += '<div style="margin-top:16px;">';
            html += '<div style="font-weight:600; margin-bottom:8px;">üîë Veicoli Posseduti:</div>';
            game.vehicles.owned.forEach(vehicleId => {
                const vehicle = VEHICLES[vehicleId];
                const isActive = vehicleId === currentVehicle;
                html += `
                    <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; border-left:3px solid ${isActive ? 'var(--success)' : 'transparent'};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600;">${vehicle.emoji} ${vehicle.name}</div>
                                <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                                    ‚ö° Energia: ${vehicle.energyCost}/h | 
                                    ${vehicle.fuelCost ? `‚õΩ Carburante: ‚Ç¨${vehicle.fuelCost}/h` : 'üîã Elettrico'} | 
                                    üîß Manutenzione: ‚Ç¨${vehicle.maintenanceCost}/mese
                                </div>
                                <div style="font-size:0.8rem; opacity:0.7; margin-top:2px;">üèÉ Velocit√†: ${Math.round((1-vehicle.speedMultiplier)*100)}% pi√π veloce</div>
                            </div>
                            <button class="small" onclick="setActiveVehicle('${vehicleId}')" ${isActive ? 'disabled' : ''}>
                                ${isActive ? '‚úì Attivo' : 'Usa'}
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        // Shop section
        html += '<div style="margin-top:20px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1);">';
        html += '<div style="font-weight:600; margin-bottom:12px;">üõí Concessionario Veicoli:</div>';
        
        Object.keys(VEHICLES).forEach(vehicleId => {
            const vehicle = VEHICLES[vehicleId];
            const owned = game.vehicles.owned && game.vehicles.owned.includes(vehicleId);
            
            html += `
                <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:1.1rem;">${vehicle.emoji} ${vehicle.name}</div>
                            <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">${vehicle.description}</div>
                            <div style="font-size:0.85rem; margin-top:6px;">
                                üí∞ Prezzo: ‚Ç¨${vehicle.cost}<br>
                                ‚ö° Consumo Energia: ${vehicle.energyCost}/h<br>
                                ${vehicle.fuelCost ? `‚õΩ Carburante: ‚Ç¨${vehicle.fuelCost}/h<br>` : ''}
                                üîß Manutenzione: ‚Ç¨${vehicle.maintenanceCost}/mese<br>
                                üèÉ Velocit√†: ${Math.round((1-vehicle.speedMultiplier)*100)}% pi√π veloce
                            </div>
                        </div>
                        <button onclick="buyVehicle('${vehicleId}')" ${owned ? 'disabled' : ''} style="min-width:100px;">
                            ${owned ? '‚úì Posseduto' : 'Acquista'}
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Options section
        html += '<div style="margin-top:16px; padding:10px; background:rgba(100,150,255,0.1); border-radius:8px;">';
        html += '<div style="font-weight:600; margin-bottom:8px;">üö∂ Modalit√† di Viaggio:</div>';
        html += '<div style="display:flex; gap:8px; flex-wrap:wrap;">';
        html += `<button class="small" onclick="setActiveVehicle(null)" ${!currentVehicle ? 'disabled' : ''}>üö∂ A piedi (Gratis)</button>`;
        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;
        html += `<button class="small" onclick="setActiveVehicle('public')" ${currentVehicle === 'public' ? 'disabled' : ''}>üöå Trasporto Pubblico${hasPass ? '' : ' (‚Ç¨2-4/viaggio)'}</button>`;
        html += '</div>';
        html += '</div>';
        
        div.innerHTML = html;
    }
    
    function buyVehicle(vehicleId) {
        const vehicle = VEHICLES[vehicleId];
        
        if (!vehicle) {
            showNotification('‚ö†Ô∏è Veicolo non trovato!', 1500);
            return;
        }
        
        if (game.vehicles.owned && game.vehicles.owned.includes(vehicleId)) {
            showNotification('‚ö†Ô∏è Possiedi gi√† questo veicolo!', 1500);
            return;
        }
        
        if (game.player.money < vehicle.cost) {
            showNotification(`üí∞ Non hai abbastanza soldi! Serve: ‚Ç¨${vehicle.cost}`, 2000);
            return;
        }
        
        if (confirm(`${vehicle.emoji} Vuoi acquistare ${vehicle.name} per ‚Ç¨${vehicle.cost}?\n\nCosti di gestione:\n- Carburante: ‚Ç¨${vehicle.fuelCost || 0}/h di viaggio\n- Manutenzione: ‚Ç¨${vehicle.maintenanceCost}/mese`)) {
            game.player.money -= vehicle.cost;
            if (!game.vehicles.owned) game.vehicles.owned = [];
            game.vehicles.owned.push(vehicleId);
            showNotification(`üéâ Hai acquistato ${vehicle.name}!`, 2500);
            updateUI();
        }
    }
    
    function setActiveVehicle(vehicleId) {
        if (vehicleId && vehicleId !== 'public' && (!game.vehicles.owned || !game.vehicles.owned.includes(vehicleId))) {
            showNotification('‚ö†Ô∏è Non possiedi questo veicolo!', 1500);
            return;
        }
        
        game.vehicles.active = vehicleId;
        const vehicleName = vehicleId === null ? 'A piedi üö∂' : 
                           vehicleId === 'public' ? 'Trasporto Pubblico üöå' : 
                           VEHICLES[vehicleId].name;
        showNotification(`‚úì Modalit√† di viaggio impostata: ${vehicleName}`, 2000);
        updateUI();
    }
    
    function payVehicleMaintenance() {
        if (!game.vehicles.owned || game.vehicles.owned.length === 0) return;
        
        let totalCost = 0;
        game.vehicles.owned.forEach(vehicleId => {
            const vehicle = VEHICLES[vehicleId];
            if (vehicle && vehicle.maintenanceCost) {
                totalCost += vehicle.maintenanceCost;
            }
        });
        
        if (totalCost > 0) {
            game.player.money -= totalCost;
            showNotification(`üîß Manutenzione veicoli: -‚Ç¨${totalCost}`, 2500);
        }
    }
    
    // Show travel dialog with vehicle options
    function showTravelDialog(destination, callback) {
        const destName = NEIGHBORHOODS[destination] ? NEIGHBORHOODS[destination].name : destination;
        
        if (game.cityMap.currentLocation === destination) {
            callback(null); // Already there
            return;
        }
        
        // Calculate costs for each transport option
        const walkInfo = calculateTravelTime(destination, null);
        const publicInfo = calculateTravelTime(destination, 'public');
        
        let html = `
            <div style="padding:20px; max-width:500px;">
                <h3 style="margin-top:0;">üó∫Ô∏è Viaggio verso ${destName}</h3>
                <p style="opacity:0.8; margin-bottom:20px;">Scegli il mezzo di trasporto:</p>
                <div style="display:flex; flex-direction:column; gap:12px;">
        `;
        
        // Walking option
        html += `
            <button onclick="selectTransportForTravel(null, '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                    style="padding:15px; text-align:left; background:rgba(100,100,100,0.2); border:2px solid rgba(255,255,255,0.2); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                    onmouseover="this.style.background='rgba(100,100,100,0.4)'" 
                    onmouseout="this.style.background='rgba(100,100,100,0.2)'">
                <div style="font-weight:bold; font-size:1.1rem;">üö∂ A Piedi (Gratis)</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                    ‚è±Ô∏è Tempo: ${walkInfo.time}h | ‚ö° Energia: -${walkInfo.energy}%
                </div>
            </button>
        `;
        
        // Public transport option
        html += `
            <button onclick="selectTransportForTravel('public', '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                    style="padding:15px; text-align:left; background:rgba(50,100,200,0.2); border:2px solid rgba(50,150,255,0.3); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                    onmouseover="this.style.background='rgba(50,100,200,0.4)'" 
                    onmouseout="this.style.background='rgba(50,100,200,0.2)'">
                <div style="font-weight:bold; font-size:1.1rem;">üöå Trasporto Pubblico</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                    ‚è±Ô∏è Tempo: ${publicInfo.time}h | üí∞ Costo: ‚Ç¨${publicInfo.cost} | ‚ö° Energia: -${publicInfo.energy}%
                </div>
            </button>
        `;
        
        // Personal vehicles
        if (game.vehicles.owned && game.vehicles.owned.length > 0) {
            game.vehicles.owned.forEach(vehicleId => {
                const vehicle = VEHICLES[vehicleId];
                const vehicleInfo = calculateTravelTime(destination, vehicleId);
                
                html += `
                    <button onclick="selectTransportForTravel('${vehicleId}', '${destination}', ${callback ? `function(){${callback.toString().match(/\{([\s\S]*)\}/)[1]}}` : 'null'})" 
                            style="padding:15px; text-align:left; background:rgba(50,200,100,0.2); border:2px solid rgba(50,255,150,0.3); border-radius:8px; cursor:pointer; transition:all 0.3s;"
                            onmouseover="this.style.background='rgba(50,200,100,0.4)'" 
                            onmouseout="this.style.background='rgba(50,200,100,0.2)'">
                        <div style="font-weight:bold; font-size:1.1rem;">${vehicle.emoji} ${vehicle.name}</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:4px;">
                            ‚è±Ô∏è Tempo: ${vehicleInfo.time}h | üí∞ Costo: ‚Ç¨${vehicleInfo.cost} | ‚ö° Energia: -${vehicleInfo.energy}%
                        </div>
                    </button>
                `;
            });
        }
        
        html += `
                    <button onclick="closeDialog()" 
                            style="padding:12px; background:rgba(200,50,50,0.3); border:2px solid rgba(255,100,100,0.4); border-radius:8px; cursor:pointer; margin-top:10px;">
                        ‚ùå Annulla
                    </button>
                </div>
            </div>
        `;
        
        // Show dialog
        const dialog = document.createElement('div');
        dialog.id = 'travelDialog';
        dialog.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;';
        dialog.innerHTML = html;
        document.body.appendChild(dialog);
    }
    
    function selectTransportForTravel(vehicleId, destination, callback) {
        closeDialog();
        
        const travelInfo = calculateTravelTime(destination, vehicleId);
        
        // Check resources
        if (game.player.money < travelInfo.cost) {
            showNotification(`üí∞ Non hai abbastanza soldi! Serve: ‚Ç¨${travelInfo.cost}`, 2500);
            return;
        }
        
        if (game.player.stats.energy < travelInfo.energy) {
            showNotification(`‚ö° Non hai abbastanza energia! Serve: ${travelInfo.energy}%`, 2500);
            return;
        }
        
        // Apply travel
        game.player.money -= travelInfo.cost;
        game.player.stats.energy = clamp(game.player.stats.energy - travelInfo.energy);
        
        const vehicleName = vehicleId === null ? 'üö∂' : 
                           vehicleId === 'public' ? 'üöå' : 
                           VEHICLES[vehicleId].emoji;
        
        showNotification(`${vehicleName} Viaggio verso ${NEIGHBORHOODS[destination].name}... (${travelInfo.time}h, ‚Ç¨${travelInfo.cost})`, 2500);
        passTime(travelInfo.time);
        game.cityMap.currentLocation = destination;
        
        updateUI();
        
        if (callback) callback();
    }
    
    function showDialog(htmlContent, title = null, showCloseButton = true) {
        // Remove existing dialog if any
        closeDialog();
        
        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'travelDialog'; // Keep same ID for consistency
        overlay.className = 'enhanced-dialog-overlay';
        
        // Create content container
        const dialogContent = document.createElement('div');
        dialogContent.className = 'enhanced-dialog-content';
        
        // Add header if title provided
        if (title) {
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.innerHTML = `
                <h3>${title}</h3>
                ${showCloseButton ? `<button class="modal-close-btn" onclick="closeDialog()">‚úï</button>` : ''}
            `;
            dialogContent.appendChild(header);
        }
        
        // Add body
        const body = document.createElement('div');
        body.className = 'modal-body';
        body.innerHTML = htmlContent;
        dialogContent.appendChild(body);
        
        overlay.appendChild(dialogContent);
        document.body.appendChild(overlay);
        
        // Close on overlay click (but not on content click)
        if (showCloseButton) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeDialog();
            });
        }
    }

    function closeDialog() {
        const dialog = document.getElementById('travelDialog');
        if (dialog) {
            dialog.style.animation = 'fadeOut 0.2s ease';
            setTimeout(() => dialog.remove(), 200);
        }
    }

    function showWelcomeTutorial() {
        // Check if tutorial was already shown
        const tutorialShown = localStorage.getItem('eldoriaTutorialShown');
        if (tutorialShown === 'true') return;

        const html = `
            <div style="max-height:80vh; overflow-y:auto; padding:24px; max-width:600px;">
                <div style="text-align:center; margin-bottom:24px;">
                    <h2 style="font-size:2rem; margin-bottom:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                        üåÜ Benvenuto a Eldoria!
                    </h2>
                    <p style="font-size:1.1rem; opacity:0.9; margin-bottom:16px;">
                        La citt√† dove i sogni diventano realt√†... o incubi.
                    </p>
                </div>

                <div style="background:rgba(255,255,255,0.08); padding:16px; border-radius:12px; margin-bottom:16px; border-left:4px solid #667eea;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem;">üìñ La Tua Storia</h3>
                    <p style="font-size:0.95rem; line-height:1.6; opacity:0.9;">
                        Sei appena arrivato a <strong>Eldoria</strong>, una metropoli vibrante e pericolosa. 
                        Hai lasciato tutto alle spalle per cercare una nuova vita. 
                        Ora sei <span style="color:#eb3349;">senzatetto</span>, senza lavoro e con pochissimi soldi in tasca.
                    </p>
                </div>

                <div style="background:rgba(255,255,255,0.08); padding:16px; border-radius:12px; margin-bottom:16px; border-left:4px solid #38ef7d;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem;">‚úÖ Cosa Devi Fare</h3>
                    <div style="font-size:0.9rem; line-height:1.8; opacity:0.9;">
                        <div style="margin-bottom:8px;">
                            <strong>üè† 1. Trova una Casa</strong><br>
                            <span style="opacity:0.8;">Vivere per strada √® duro: perdi -30 morale, -20 salute e -15 energia ogni giorno! 
                            Vai su <em>Propriet√† ‚Üí Cerca un'Abitazione</em> e affitta o acquista una casa.</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong>üíº 2. Cerca Lavoro</strong><br>
                            <span style="opacity:0.8;">Senza reddito non sopravviverai. Vai su <em>Lavoro ‚Üí Cerca Lavoro</em> e trova un'occupazione. 
                            Ricorda: devi lavorare 5 giorni a settimana o rischi il licenziamento!</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong>üí∞ 3. Gestisci i Soldi</strong><br>
                            <span style="opacity:0.8;">Hai <em>contante</em> (rubabile) e <em>deposito bancario</em> (sicuro). 
                            Deposita i soldi in banca per proteggerli dai furti! Usa il tab Banca.</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong>üìà 4. Investi e Cresci</strong><br>
                            <span style="opacity:0.8;">Compra azioni in borsa, acquista propriet√†, apri attivit√† commerciali. 
                            Pi√π investi, pi√π guadagni!</span>
                        </div>
                        <div style="margin-bottom:8px;">
                            <strong>üó∫Ô∏è 5. Esplora la Citt√†</strong><br>
                            <span style="opacity:0.8;">Eldoria ha 5 quartieri: Periferia (economica ma pericolosa), 
                            Centro Storico (costoso ma prestigioso), Quartiere Lusso (per i ricchi). 
                            Ogni zona ha vantaggi e svantaggi.</span>
                        </div>
                    </div>
                </div>

                <div style="background:rgba(235,51,73,0.15); padding:16px; border-radius:12px; margin-bottom:20px; border-left:4px solid #eb3349;">
                    <h3 style="margin-bottom:12px; font-size:1.1rem; color:#eb3349;">‚ö†Ô∏è Attenzione</h3>
                    <ul style="font-size:0.9rem; line-height:1.6; opacity:0.9; margin-left:20px;">
                        <li>Ogni quartiere ha un <strong>livello di criminalit√†</strong>: puoi essere derubato, i tuoi veicoli danneggiati o subire furti in casa!</li>
                        <li>Se sei senzatetto, le tue prestazioni lavorative crollano (-40%) e rischi il licenziamento.</li>
                        <li>Devi pagare l'<strong>affitto ogni mese</strong> o sarai sfrattato dopo 60 giorni.</li>
                        <li>Controlla sempre <strong>energia, salute, morale e igiene</strong>: se crollano, non potrai lavorare!</li>
                    </ul>
                </div>

                <div style="text-align:center; padding-top:16px;">
                    <button onclick="closeTutorial()" class="action-btn" style="width:100%; font-size:1.1rem; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üöÄ Inizia la Tua Avventura!
                    </button>
                    <div style="margin-top:12px;">
                        <button onclick="skipTutorial()" style="background:transparent; border:none; color:rgba(255,255,255,0.6); cursor:pointer; font-size:0.85rem; text-decoration:underline;">
                            Salta Tutorial (non mostrare pi√π)
                        </button>
                    </div>
                </div>
            </div>
        `;

        showDialog(html);
    }

    function closeTutorial() {
        closeDialog();
    }

    function skipTutorial() {
        localStorage.setItem('eldoriaTutorialShown', 'true');
        closeDialog();
        showNotification('‚úÖ Tutorial disattivato. Buona fortuna a Eldoria!', 3000);
    }

    function resetTutorial() {
        localStorage.removeItem('eldoriaTutorialShown');
        showNotification('üîÑ Tutorial riattivato! Verr√† mostrato al prossimo caricamento.', 3000);
    }

    function buyTransportPass() {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        if (game.player.money < 50) {
            showNotification('üí∞ Serve ‚Ç¨50 per l\'abbonamento!', 1500);
            return;
        }

        game.player.money -= 50;
        game.cityMap.transportPass = game.time.day + 30;
        showNotification('üé´ Hai acquistato l\'abbonamento mensile!', 2000);
        updateUI();
    }

    function takeBus(routeKey) {
        if (!game.cityMap) {
            game.cityMap = {
                currentLocation: null,
                ownedBusinesses: [],
                discoveredLocations: [],
                transportPass: null
            };
        }

        const route = BUS_ROUTES[routeKey];
        const hasPass = game.cityMap.transportPass && game.cityMap.transportPass > game.time.day;

        if (!hasPass) {
            if (game.player.money < route.cost) {
                showNotification('üí∞ Non hai abbastanza soldi!', 1500);
                return;
            }
            game.player.money -= route.cost;
        }

        passTime(route.time / 60); // Convert minutes to hours
        showNotification(`üöå Hai preso la ${route.name}`, 1500);
        updateUI();
    }

    // ---------- ROMANCE SYSTEM ----------
    function renderRomanceStatus() {
        const div = $('romanceStatus');
        if (!div) return;

        if (game.relationships.spouse) {
            const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,105,180,0.15); border-radius:12px; border-left:3px solid #ff69b4;">
                    <h4>üíç Sposato/a con ${spouse.name}</h4>
                    <div style="margin-top:8px; font-size:0.9rem;">
                        üíï Relazione: ${spouse.relation}/100<br>
                        üíº Lavoro: ${spouse.job}<br>
                        üìÖ Sposati da ${game.time.day - (spouse.marriageDay || 0)} giorni
                    </div>
                    <div style="margin-top:12px; display:flex; gap:8px;">
                        <button class="small" onclick="openDialogue('${spouse.id}')">üí¨ Parla</button>
                        <button class="small" onclick="dateNight()">üåÉ Serata Romantica</button>
                        ${!game.relationships.children.length ? '<button class="small" onclick="tryForBaby()">üë∂ Prova ad avere un figlio</button>' : ''}
                    </div>
                </div>
            `;
        } else if (game.relationships.romantic) {
            const partner = game.npcs.find(n => n.id === game.relationships.romantic);
            div.innerHTML = `
                <div style="padding:14px; background:rgba(255,182,193,0.15); border-radius:12px; border-left:3px solid #ffb6c1;">
                    <h4>üíï In relazione con ${partner.name}</h4>
                    <div style="margin-top:8px; font-size:0.9rem;">
                        üíñ Relazione: ${partner.relation}/100<br>
                        üíº Lavoro: ${partner.job}
                    </div>
                    <div style="margin-top:12px; display:flex; gap:8px;">
                        <button class="small" onclick="openDialogue('${partner.id}')">üí¨ Parla</button>
                        <button class="small" onclick="goOnDate('${partner.id}')">üåπ Appuntamento</button>
                        ${partner.relation >= 80 ? '<button class="small" onclick="propose(\'' + partner.id + '\')">üíç Proposta</button>' : ''}
                        <button class="small" onclick="breakUp('${partner.id}')">üíî Lascia</button>
                    </div>
                </div>
            `;
        } else {
            div.innerHTML = '<p style="opacity:0.7; padding:12px;">Nessuna relazione romantica. Conosci persone e costruisci relazioni forti!</p>';
        }
    }

    function renderPotentialPartners() {
        const div = $('potentialPartners');
        if (!div) return;

        if (game.relationships.romantic || game.relationships.spouse) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Sei gi√† in una relazione.</p>';
            return;
        }

        const eligible = game.npcs.filter(n => 
            !n.isInterviewing && 
            n.relation >= 50 && 
            !game.relationships.dating.includes(n.id)
        );

        if (eligible.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Migliora le relazioni con le persone (‚â•50) per sbloccare opzioni romantiche.</p>';
            return;
        }

        div.innerHTML = eligible.map(npc => `
            <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;">üíñ ${npc.name}</div>
                    <div style="font-size:0.85rem; opacity:0.8;">${npc.job} | Relazione: ${npc.relation}/100</div>
                </div>
                <button class="small" onclick="askOut('${npc.id}')">üíê Chiedi di uscire</button>
            </div>
        `).join('');
    }

    function askOut(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || npc.relation < 50) {
            showNotification('La relazione non √® abbastanza forte!', 1500);
            return;
        }

        const success = Math.random() < (npc.relation / 100);
        
        if (success) {
            game.relationships.romantic = npcId;
            game.relationships.dating.push(npcId);
            npc.relation = clamp(npc.relation + 10);
            showNotification(`üíï ${npc.name} ha accettato! Siete ora una coppia!`, 2500);
        } else {
            npc.relation = clamp(npc.relation - 5);
            showNotification(`üíî ${npc.name} ha rifiutato gentilmente. Forse un'altra volta...`, 2000);
        }
        
        updateUI();
    }

    function goOnDate(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || game.player.money < 50) {
            showNotification('Serve ‚Ç¨50 per un appuntamento!', 1500);
            return;
        }

        game.player.money -= 50;
        npc.relation = clamp(npc.relation + randInt(8, 15));
        game.player.stats.morale = clamp(game.player.stats.morale + 20);
        
        passTime(3);
        showNotification(`üåπ Bellissimo appuntamento con ${npc.name}! Relazione: ${npc.relation}/100`, 2500);
        updateUI();
    }

    function propose(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc || npc.relation < 80) {
            showNotification('La relazione non √® abbastanza forte per il matrimonio!', 2000);
            return;
        }

        if (confirm(`Vuoi sposare ${npc.name}?`)) {
            game.relationships.spouse = npcId;
            game.relationships.romantic = null;
            npc.marriageDay = game.time.day;
            npc.relation = 100;
            
            showNotification(`üíç Congratulazioni! Hai sposato ${npc.name}!`, 3000);
            game.player.stats.morale = 100;
            updateUI();
        }
    }

    function breakUp(npcId) {
        if (confirm('Sei sicuro di voler lasciare questa persona?')) {
            game.relationships.romantic = null;
            const npc = game.npcs.find(n => n.id === npcId);
            if (npc) npc.relation = clamp(npc.relation - 30);
            
            game.player.stats.morale = clamp(game.player.stats.morale - 20);
            showNotification('üíî Hai lasciato la relazione.', 2000);
            updateUI();
        }
    }

    function dateNight() {
        if (game.player.money < 100) {
            showNotification('Serve ‚Ç¨100 per una serata speciale!', 1500);
            return;
        }

        game.player.money -= 100;
        const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
        if (spouse) spouse.relation = clamp(spouse.relation + 5);
        
        game.player.stats.morale = clamp(game.player.stats.morale + 25);
        passTime(4);
        showNotification('üåÉ Serata romantica indimenticabile!', 2000);
        updateUI();
    }

    // ---------- FAMILY SYSTEM ----------
    function renderFamilyStatus() {
        const div = $('familyStatus');
        if (!div) return;

        if (!game.relationships.spouse) {
            div.innerHTML = '<p style="opacity:0.7;">Devi essere sposato/a per avere una famiglia.</p>';
            return;
        }

        const spouse = game.npcs.find(n => n.id === game.relationships.spouse);
        div.innerHTML = `
            <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <h4>üë®‚Äçüë©‚Äçüëß La Tua Famiglia</h4>
                <div style="margin-top:8px;">
                    <p>üíë Coniuge: ${spouse.name}</p>
                    <p style="margin-top:4px;">üë∂ Figli: ${game.relationships.children.length}</p>
                </div>
            </div>
        `;

        renderChildren();
    }

    function renderChildren() {
        const div = $('childrenList');
        if (!div || game.relationships.children.length === 0) {
            if (div) div.innerHTML = '';
            return;
        }

        div.innerHTML = `
            <h4 style="margin-bottom:8px;">üë∂ I Tuoi Figli</h4>
            ${game.relationships.children.map(child => {
                const age = Math.floor((game.time.day - child.bornDay) / 365);
                return `
                    <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                        <div style="font-weight:bold;">${child.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8; margin-top:4px;">
                            Et√†: ${age} anni (${game.time.day - child.bornDay} giorni)<br>
                            Umore: ${child.mood || 'Felice'}
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    }

    function tryForBaby() {
        if (!game.relationships.spouse) {
            showNotification('Devi essere sposato/a!', 1500);
            return;
        }

        const chance = 0.3;
        if (Math.random() < chance) {
            const names = ['Luca', 'Sofia', 'Marco', 'Giulia', 'Alessandro', 'Elena'];
            const babyName = names[randInt(0, names.length - 1)];
            
            game.relationships.children.push({
                name: babyName,
                bornDay: game.time.day,
                mood: 'Felice'
            });
            
            showNotification(`üéâ Congratulazioni! √à nato/a ${babyName}!`, 3000);
            game.player.stats.morale = 100;
        } else {
            showNotification('Non ancora... Riprova pi√π tardi!', 2000);
        }
        
        passTime(1);
        updateUI();
    }

    // ---------- INVESTMENTS SYSTEM ----------
    // ---------- COMPANY SYSTEM ----------
    function initializeCompanies() {
        // Extract unique companies from job listings and locations
        const companies = new Map();
        
        // Get companies from job locations
        game.jobListings.forEach(job => {
            const location = findLocationById(job.locationId);
            if (location && location.name) {
                const companyId = job.locationId;
                if (!companies.has(companyId)) {
                    companies.set(companyId, {
                        id: companyId,
                        name: location.name,
                        business: location.business,
                        locationIds: [job.locationId],
                        neighborhood: job.location,
                        employees: 0,
                        performance: 50 + Math.random() * 30, // Start 50-80
                        performanceHistory: [],
                        revenue: 0,
                        foundedDay: game.time.day
                    });
                }
                // Count employees
                const company = companies.get(companyId);
                if (game.player.job === job.name && game.player.workplace === job.locationId) {
                    company.employees++;
                }
            }
        });
        
        // Convert to object
        game.companies = {};
        companies.forEach((company, id) => {
            game.companies[id] = company;
        });
        
        // Generate stocks from companies
        generateStocksFromCompanies();
    }
    
    function findLocationById(locationId) {
        for (const neighborhood in CITY_LOCATIONS) {
            const location = CITY_LOCATIONS[neighborhood].find(loc => loc.id === locationId);
            if (location) return location;
        }
        return null;
    }
    
    function generateStocksFromCompanies() {
        STOCKS = {};
        
        // Only create stocks for companies with certain business types
        const stockEligibleTypes = ['boutique', 'ristorante', 'palestra', 'libreria', 'galleria', 
                                    'pasticceria', 'supermercato', 'ferramenta', 'gioielleria', 
                                    'ristorante_stellato', 'spa'];
        
        Object.values(game.companies).forEach(company => {
            if (stockEligibleTypes.includes(company.business)) {
                const basePrice = 50 + Math.random() * 150; // ‚Ç¨50-200
                STOCKS[company.id] = {
                    name: company.name,
                    companyId: company.id,
                    price: basePrice,
                    volatility: 0.08 + Math.random() * 0.12, // 8-20%
                    performance: company.performance
                };
            }
        });
    }
    
    function updateCompanyPerformance() {
        Object.values(game.companies).forEach(company => {
            let performance = company.performance;
            
            // Base random fluctuation
            performance += (Math.random() - 0.5) * 10;
            
            // Employee factor
            const expectedEmployees = company.locationIds.length * 3;
            if (company.employees > expectedEmployees) {
                performance += 5; // Well staffed
            } else if (company.employees < expectedEmployees * 0.5) {
                performance -= 10; // Understaffed
            }
            
            // Revenue factor (simulated based on business type and neighborhood)
            const revenueMultipliers = {
                'periferia': 0.8,
                'quartiere_operaio': 1.0,
                'zona_residenziale': 1.2,
                'centro_storico': 1.5,
                'quartiere_lusso': 2.0
            };
            const multiplier = revenueMultipliers[company.neighborhood] || 1.0;
            company.revenue = company.employees * 1000 * multiplier;
            
            // Clamp performance
            performance = Math.max(0, Math.min(100, performance));
            
            // Track history
            company.performanceHistory.push({
                day: game.time.day,
                performance: performance
            });
            
            // Keep only last 30 days
            if (company.performanceHistory.length > 30) {
                company.performanceHistory.shift();
            }
            
            company.performance = performance;
            
            // Check for bankruptcy or expansion
            checkCompanyStatus(company);
        });
    }
    
    function checkCompanyStatus(company) {
        // Check bankruptcy: performance < 20 for 30+ days
        if (company.performanceHistory.length >= 30) {
            const last30 = company.performanceHistory.slice(-30);
            const avgPerformance = last30.reduce((sum, h) => sum + h.performance, 0) / 30;
            
            if (avgPerformance < 20 && company.performance < 20) {
                triggerBankruptcy(company);
                return;
            }
            
            // Check expansion: performance > 85 for 30+ days
            if (avgPerformance > 85 && company.performance > 85) {
                if (!company.lastExpansionDay || (game.time.day - company.lastExpansionDay) > 60) {
                    triggerExpansion(company);
                }
            }
        }
    }
    
    function triggerBankruptcy(company) {
        showNotification(`üìâ BREAKING NEWS: ${company.name} ha dichiarato bancarotta!`, 5000);
        
        // Set stock price to 0
        if (STOCKS[company.id]) {
            STOCKS[company.id].price = 0;
        }
        
        // Fire employees working there
        game.jobListings = game.jobListings.filter(job => {
            if (job.locationId === company.id) {
                if (game.player.job === job.name && game.workData?.currentJob?.locationId === company.id) {
                    game.player.job = 'Disoccupato';
                    game.player.jobSalary = 0;
                    game.workData.currentJob = null;
                    showNotification(`üò¢ Sei stato licenziato a causa del fallimento di ${company.name}!`, 4000);
                }
                return false; // Remove job listing
            }
            return true;
        });
        
        // Remove location from map (mark as closed)
        company.locationIds.forEach(locId => {
            const location = findLocationById(locId);
            if (location) {
                location.status = 'closed';
                location.business = 'chiuso';
            }
        });
        
        // Remove company
        delete game.companies[company.id];
        delete STOCKS[company.id];
        
        updateUI();
    }
    
    function triggerExpansion(company) {
        showNotification(`üìà ${company.name} apre una nuova sede!`, 4000);
        
        company.lastExpansionDay = game.time.day;
        
        // Increase stock price
        if (STOCKS[company.id]) {
            STOCKS[company.id].price *= 1.2;
        }
        
        // Add new location to the same neighborhood
        const neighborhood = company.neighborhood;
        const newLocationId = `${company.id}_expansion_${Date.now()}`;
        
        const newLocation = {
            id: newLocationId,
            type: 'shop',
            name: `${company.name} - Nuova Sede`,
            business: company.business,
            street: `Via Espansione ${Math.floor(Math.random() * 100)}`,
            status: 'occupied',
            income: 300,
            x: Math.random() * 100,
            y: Math.random() * 100
        };
        
        CITY_LOCATIONS[neighborhood].push(newLocation);
        company.locationIds.push(newLocationId);
        
        // Add new job listings for this location
        const newJobId = `job_expansion_${Date.now()}`;
        const baseJob = game.jobListings.find(j => j.locationId === company.id);
        
        if (baseJob) {
            const newJob = {
                ...baseJob,
                id: newJobId,
                locationId: newLocationId
            };
            game.jobListings.push(newJob);
        }
        
        updateUI();
    }
    
    function updateStockPrices() {
        Object.keys(STOCKS).forEach(key => {
            const stock = STOCKS[key];
            
            // Base volatility change
            const change = (Math.random() - 0.5) * 2 * stock.volatility;
            let newPrice = stock.price * (1 + change);
            
            // Company performance influence
            const company = game.companies[stock.companyId];
            if (company) {
                const performanceInfluence = (company.performance - 50) / 500; // -0.1 to +0.1
                newPrice *= (1 + performanceInfluence);
                
                // Update stock performance reference
                stock.performance = company.performance;
            }
            
            stock.price = Math.max(1, newPrice); // Minimum ‚Ç¨1 (unless bankrupt = 0)
        });
    }

    function renderStockMarket() {
        const div = $('stockMarket');
        if (!div) return;

        div.innerHTML = getMarketStatusHTML() + Object.keys(STOCKS).map(key => {
            const stock = STOCKS[key];
            const owned = game.investments.stocks.find(s => s.id === key);
            const company = game.companies[stock.companyId];
            
            // Performance indicator
            let perfColor = '#4ade80'; // green
            let perfIcon = 'üìà';
            if (company) {
                if (company.performance < 30) {
                    perfColor = '#ef4444'; // red
                    perfIcon = 'üìâ';
                } else if (company.performance < 60) {
                    perfColor = '#f59e0b'; // orange
                    perfIcon = 'üìä';
                }
            }
            
            return `
                <div style="padding:12px; background:rgba(255,255,255,0.06); border-radius:10px;">
                    <div style="font-weight:bold; margin-bottom:6px;">${stock.name}</div>
                    <div style="font-size:1.2rem; color:var(--success); margin-bottom:8px;">‚Ç¨${stock.price.toFixed(2)}</div>
                    ${company ? `
                        <div style="font-size:0.75rem; opacity:0.9; margin-bottom:4px; color:${perfColor};">
                            ${perfIcon} Performance: ${company.performance.toFixed(0)}%
                        </div>
                        <div style="font-size:0.75rem; opacity:0.7; margin-bottom:8px;">
                            üë• Dipendenti: ${company.employees} | üí∞ Revenue: ‚Ç¨${company.revenue.toFixed(0)}
                        </div>
                    ` : ''}
                    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:8px;">
                        ${owned ? `Possedute: ${owned.shares} azioni` : 'Non possedute'}
                    </div>
                    <div style="display:flex; gap:6px;">
                        <button class="small" onclick="buyStock('${key}')">Compra</button>
                        ${owned ? `<button class="small" onclick="sellStock('${key}')">Vendi</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------- MARKET HOURS ----------
    function isMarketOpen() {
        const dayOfWeek = game.time.day % 7;
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // Domenica=0, Sabato=6
        const hour = game.time.hour;
        
        if (isWeekend) {
            return { open: false, reason: 'Il mercato √® chiuso nei weekend' };
        }
        
        if (hour < 9) {
            return { open: false, reason: `Il mercato apre alle 9:00 AM (ora: ${formatTime(hour, game.time.minute)})` };
        }
        
        if (hour >= 17) {
            return { open: false, reason: `Il mercato √® chiuso (chiude alle 5:00 PM, ora: ${formatTime(hour, game.time.minute)})` };
        }
        
        return { open: true, reason: '' };
    }
    
    function getMarketStatusHTML() {
        const status = isMarketOpen();
        if (status.open) {
            return `<div style="background: rgba(0,255,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                <strong>üü¢ MERCATO APERTO</strong><br>
                <small>Lun-Ven 9:00-17:00 | Ora: ${formatTime(game.time.hour, game.time.minute)}</small>
            </div>`;
        } else {
            return `<div style="background: rgba(255,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
                <strong>üî¥ MERCATO CHIUSO</strong><br>
                <small>${status.reason}</small>
            </div>`;
        }
    }

    function buyStock(stockId) {
        const marketStatus = isMarketOpen();
        if (!marketStatus.open) {
            showNotification(`üî¥ ${marketStatus.reason}`, 3000);
            return;
        }
        
        const stock = STOCKS[stockId];
        const amount = prompt('Quante azioni vuoi comprare?', '1');
        if (!amount) return;

        const shares = parseInt(amount);
        const cost = stock.price * shares;

        if (game.player.money < cost) {
            showNotification('üí∞ Non hai abbastanza soldi!', 1500);
            return;
        }

        game.player.money -= cost;
        game.player.cash -= cost;
        
        const existing = game.investments.stocks.find(s => s.id === stockId);
        if (existing) {
            existing.shares += shares;
            existing.avgPrice = ((existing.avgPrice * (existing.shares - shares)) + (stock.price * shares)) / existing.shares;
        } else {
            game.investments.stocks.push({
                id: stockId,
                name: stock.name,
                shares: shares,
                avgPrice: stock.price
            });
        }

        showNotification(`üìà Hai comprato ${shares} azioni di ${stock.name}!`, 2000);
        updateUI();
        renderStockMarket(); // Aggiorna display
    }

    function sellStock(stockId) {
        const marketStatus = isMarketOpen();
        if (!marketStatus.open) {
            showNotification(`üî¥ ${marketStatus.reason}`, 3000);
            return;
        }
        
        const stock = STOCKS[stockId];
        const owned = game.investments.stocks.find(s => s.id === stockId);
        if (!owned) return;

        const amount = prompt(`Quante azioni vuoi vendere? (Hai: ${owned.shares})`, owned.shares);
        if (!amount) return;

        const shares = Math.min(parseInt(amount), owned.shares);
        const revenue = stock.price * shares;
        const profit = (stock.price - owned.avgPrice) * shares;

        game.player.money += revenue;
        game.player.cash += revenue;
        owned.shares -= shares;

        if (owned.shares <= 0) {
            game.investments.stocks = game.investments.stocks.filter(s => s.id !== stockId);
        }

        showNotification(`üí∞ Vendute ${shares} azioni! ${profit >= 0 ? 'Profitto' : 'Perdita'}: ‚Ç¨${profit.toFixed(2)}`, 2500);
        updateUI();
        renderStockMarket(); // Aggiorna display
    }

    function renderStockPortfolio() {
        const div = $('stockPortfolio');
        if (!div) return;

        if (game.investments.stocks.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Nessuna azione in portafoglio.</p>';
            return;
        }

        let totalValue = 0;
        let totalInvested = 0;

        div.innerHTML = game.investments.stocks.map(owned => {
            const stock = STOCKS[owned.id];
            const value = stock.price * owned.shares;
            const invested = owned.avgPrice * owned.shares;
            const profit = value - invested;
            const profitPercent = (profit / invested) * 100;

            totalValue += value;
            totalInvested += invested;

            return `
                <div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${owned.name}</div>
                        <div style="font-size:0.85rem; opacity:0.8;">${owned.shares} azioni @ ‚Ç¨${stock.price.toFixed(2)}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${profit >= 0 ? '+' : ''}‚Ç¨${profit.toFixed(2)}
                        </div>
                        <div style="font-size:0.85rem; opacity:0.8;">${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }).join('') + `
            <div style="margin-top:12px; padding:12px; background:rgba(56,239,125,0.1); border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">
                    <span>Valore Totale:</span>
                    <span style="font-weight:bold;">‚Ç¨${totalValue.toFixed(2)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:4px;">
                    <span>P&L Totale:</span>
                    <span style="font-weight:bold; color:${(totalValue - totalInvested) >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${(totalValue - totalInvested) >= 0 ? '+' : ''}‚Ç¨${(totalValue - totalInvested).toFixed(2)}
                    </span>
                </div>
            </div>
        `;
    }

    function depositSavings() {
        const amount = prompt(`üíµ Quanto vuoi depositare nel conto risparmio?\n\nDisponibile: ‚Ç¨${game.player.money}\nInteressi: 2% giornaliero`);
        if (!amount) return;

        const deposit = parseInt(amount);
        
        // Validazione input
        if (isNaN(deposit) || deposit <= 0) {
            showNotification('‚ùå Importo non valido!', 1500);
            return;
        }
        
        if (deposit > game.player.money) {
            showNotification(`üí∞ Non hai abbastanza soldi! Hai solo ‚Ç¨${game.player.money}`, 2000);
            return;
        }

        game.player.money -= deposit;
        game.investments.savings += deposit;
        showNotification(`üíµ Depositati ‚Ç¨${deposit} nel conto risparmio! Interessi: 2%/giorno`, 2000);
        updateUI();
    }

    function withdrawSavings() {
        if (game.investments.savings <= 0) {
            showNotification('‚ùå Il conto risparmio √® vuoto!', 1500);
            return;
        }
        
        const amount = prompt(`üí∏ Quanto vuoi prelevare?\n\nDisponibile: ‚Ç¨${Math.floor(game.investments.savings)}`);
        if (!amount) return;

        const withdrawal = parseInt(amount);
        
        // Validazione input
        if (isNaN(withdrawal) || withdrawal <= 0) {
            showNotification('‚ùå Importo non valido!', 1500);
            return;
        }
        
        if (withdrawal > game.investments.savings) {
            showNotification(`‚ùå Puoi prelevare massimo ‚Ç¨${Math.floor(game.investments.savings)}!`, 2000);
            return;
        }

        game.investments.savings -= withdrawal;
        game.player.money += withdrawal;
        showNotification(`üí∏ Prelevati ‚Ç¨${withdrawal} dal conto risparmio!`, 2000);
        updateUI();
    }

    function applySavingsInterest() {
        if (game.investments.savings > 0) {
            const interest = game.investments.savings * 0.02;
            game.investments.savings += interest;
            showNotification(`üí∞ Interessi maturati: +‚Ç¨${interest.toFixed(2)}!`, 2000);
        }
    }

    function renderPropertiesList() {
        const div = $('propertiesList');
        if (!div) return;

        if (game.investments.properties.length === 0) {
            div.innerHTML = '<p style="opacity:0.7; font-size:0.9rem;">Nessuna propriet√† posseduta.</p>';
            return;
        }

        div.innerHTML = game.investments.properties.map(prop => {
            const propData = PROPERTIES.find(p => p.id === prop.id);
            return `
                <div style="padding:12px; background:rgba(255,255,255,0.08); border-radius:8px; margin-bottom:8px;">
                    <div style="font-weight:bold;">${propData.name}</div>
                    <div style="font-size:0.9rem; opacity:0.9; margin-top:4px;">
                        üí∞ Rendita: ‚Ç¨${propData.income}/mese<br>
                        üìç Zona: ${NEIGHBORHOODS[propData.area].name}
                    </div>
                </div>
            `;
        }).join('');
    }

    function showPropertyMarket() {
        alert('Mercato immobiliare: ' + PROPERTIES.map(p => 
            `${p.name} - ‚Ç¨${p.cost} (Rende ‚Ç¨${p.income}/mese)`
        ).join('\n'));
    }

    function collectPropertyIncome() {
        if (game.investments.properties.length > 0) {
            const income = game.investments.properties.reduce((sum, prop) => {
                const propData = PROPERTIES.find(p => p.id === prop.id);
                return sum + (propData?.income || 0);
            }, 0);
            
            game.player.money += income;
            showNotification(`üè¢ Rendita propriet√†: +‚Ç¨${income}!`, 2000);
        }
    }

    // ---------- CRIME SYSTEM ----------
    function renderCrimeStatus() {
        const div = $('crimeStatus');
        if (!div) return;

        const status = game.crime.wanted > 0 ? 'üö® RICERCATO' : '‚úÖ Pulito';
        const color = game.crime.wanted > 0 ? 'var(--danger)' : 'var(--success)';

        div.innerHTML = `
            <div style="padding:14px; background:rgba(255,255,255,0.08); border-radius:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">Stato Legale</div>
                        <div style="font-size:1.3rem; color:${color}; margin-top:4px;">${status}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.9rem; opacity:0.8;">Livello Ricerca</div>
                        <div style="font-weight:bold; font-size:1.5rem; color:${color};">${game.crime.wanted}</div>
                    </div>
                </div>
                <div style="font-size:0.9rem; opacity:0.9;">
                    üìã Fedina: ${game.crime.reputation}<br>
                    üöî Precedenti: ${game.crime.record.length}
                </div>
                ${game.crime.wanted > 0 ? `
                    <div style="margin-top:12px; padding:10px; background:rgba(235,51,73,0.2); border-radius:8px; text-align:center;">
                        ‚ö†Ô∏è Rischio arresto: ${Math.min(game.crime.wanted * 10, 90)}%
                    </div>
                ` : ''}
            </div>
        `;
    }

    function crimeAction(type) {
        const crimes = {
            pickpocket: { name: 'Borseggio', reward: [20, 100], risk: 0.2, time: 1 },
            burglary: { name: 'Furto', reward: [100, 500], risk: 0.4, time: 3 },
            hack: { name: 'Hacking', reward: [200, 1000], risk: 0.3, time: 4 },
            scam: { name: 'Truffa', reward: [150, 800], risk: 0.35, time: 2 },
            smuggle: { name: 'Contrabbando', reward: [500, 2000], risk: 0.5, time: 6 },
            blackjack: { name: 'Blackjack Illegale', reward: [-200, 500], risk: 0.25, time: 2 }
        };

        const crime = crimes[type];
        if (!crime) return;

        if (!confirm(`Tentare: ${crime.name}?\nRischio: ${crime.risk * 100}%\nTempo: ${crime.time}h`)) {
            return;
        }

        const caught = Math.random() < (crime.risk + game.crime.wanted * 0.05);
        
        if (caught) {
            const fine = randInt(200, 1000);
            game.player.money = Math.max(0, game.player.money - fine);
            game.crime.wanted = clamp(game.crime.wanted + 1, 0, 10);
            game.crime.record.push({ crime: crime.name, day: game.time.day });
            game.crime.reputation = 'Criminale';
            game.player.rep = clamp(game.player.rep - 10, 0, 100);
            game.player.stats.morale = clamp(game.player.stats.morale - 20);
            
            showNotification(`üöî Arrestato per ${crime.name}! Multa: ‚Ç¨${fine}`, 3000);
        } else {
            const reward = randInt(crime.reward[0], crime.reward[1]);
            game.player.money += reward;
            game.crime.wanted = clamp(game.crime.wanted + 0.5, 0, 10);
            
            if (reward > 0) {
                showNotification(`üí∞ ${crime.name} riuscito! +‚Ç¨${reward}`, 2500);
            } else {
                showNotification(`üí∏ ${crime.name} fallito. Persi ‚Ç¨${Math.abs(reward)}`, 2000);
            }
        }

        passTime(crime.time);
        updateUI();
    }

    function clearRecord() {
        if (game.player.money < 5000) {
            showNotification('Serve ‚Ç¨5000 per pulire la fedina!', 1500);
            return;
        }

        if (confirm('Pagare ‚Ç¨5000 per pulire la fedina penale?')) {
            game.player.money -= 5000;
            game.crime.record = [];
            game.crime.wanted = 0;
            game.crime.reputation = 'pulito';
            game.player.rep = clamp(game.player.rep + 10, 0, 100);
            
            showNotification('‚ú® Fedina penale pulita!', 2000);
            updateUI();
        }
    }

    // ---------- TIME ----------
    function passTime(hours) {
        // Usa il sistema a minuti per coerenza
        const totalMinutes = Math.round(hours * 60);
        addMinutes(totalMinutes);
    }

    function showWorkInterface(job) {
        const tasks = job.tasks;
        const randomTask = tasks[randInt(0, tasks.length - 1)];
        
        // Create work modal/interface via chat with manager
        const manager = game.npcs.find(n => n.name === job.manager);
        if (!manager) return;

        game.currentChatNpc = manager.id;
        
        if (!game.chatHistory[manager.id]) {
            game.chatHistory[manager.id] = [];
        }

        // OLD: Update chat header - NOW USING DIALOGUE SYSTEM
        // $('chatNpcName').innerText = manager.name + ' (Manager)';
        // $('chatNpcIcon').innerText = 'üíº';
        // $('chatNpcJob').innerText = `Lavoro: ${job.name}`;
        // $('chatRelation').innerText = `Performance: ${game.workData.performance}%`;

        // renderChatMessages();

        // OLD: Show chat modal - NOW USING DIALOGUE SYSTEM
        // $('chatModal').classList.add('active');
        // $('chatInput').focus();

        // Manager assigns task
        setTimeout(() => {
            addSystemMessage(`üè¢ Giornata lavorativa iniziata - ${job.hours.start}:00`);
            setTimeout(() => {
                const taskMessage = `Buongiorno ${game.player.name}. Oggi hai questo compito: "${randomTask}". Come procedi?`;
                game.chatHistory[manager.id].push({ type: 'npc', text: taskMessage });
                renderChatMessages();
                
                // Mark as work conversation
                game.currentWorkTask = randomTask;
            }, 800);
        }, 300);
    }

    function completeWorkDay() {
        if (!game.workData.currentJob) return;

        const job = game.workData.currentJob;
        const salary = game.player.jobSalary || job.salary;
        const performanceBonus = Math.floor(salary * (game.workData.performance / 100 - 1));
        const totalPay = salary + performanceBonus;

        game.player.money += totalPay;
        game.player.totalEarned = (game.player.totalEarned || 0) + totalPay;
        game.player.rep = clamp(game.player.rep + 2, 0, 100);
        game.workData.todayWorked = true;
        game.workData.tasksCompleted++;

        // Apply work effects
        game.player.stats.energy = clamp(game.player.stats.energy - 40);
        game.player.stats.hunger = clamp(game.player.stats.hunger - 30);
        game.player.stats.morale = clamp(game.player.stats.morale + (performanceBonus > 0 ? 10 : -5));

        const workHours = job.hours.end - job.hours.start;
        game.time.hour = job.hours.end;

        const msg = performanceBonus > 0 
            ? `üíº Ottimo lavoro! Hai guadagnato ‚Ç¨${totalPay} (bonus: ‚Ç¨${performanceBonus})` 
            : `üíº Lavoro completato. Hai guadagnato ‚Ç¨${totalPay}`;

        showNotification(msg, 2500);
        
        // Random work event
        if (Math.random() > 0.7) {
            triggerWorkEvent();
        }

        updateUI();
        checkQuests();
    }

    function triggerWorkEvent() {
        const events = [
            { msg: 'üëî Il tuo manager ti ha fatto i complimenti!', performance: 5, morale: 10 },
            { msg: 'üìà Hai ricevuto un riconoscimento dal team!', performance: 3, rep: 3 },
            { msg: '‚ö†Ô∏è Hai avuto un piccolo disaccordo con un collega', performance: -2, morale: -5 },
            { msg: 'üéâ Hai completato un progetto importante!', performance: 8, money: 50 },
            { msg: '‚òï Pausa caff√® piacevole con i colleghi', morale: 8 }
        ];

        const event = events[randInt(0, events.length - 1)];
        
        if (event.performance) game.workData.performance = clamp(game.workData.performance + event.performance, 0, 150);
        if (event.morale) game.player.stats.morale = clamp(game.player.stats.morale + event.morale);
        if (event.rep) game.player.rep = clamp(game.player.rep + event.rep, 0, 100);
        if (event.money) game.player.money += event.money;

        game.workData.workEvents.push(event.msg);
        showNotification(event.msg, 2500);
    }

    function talkToManager() {
        if (!game.workData.currentJob) return;

        const manager = game.npcs.find(n => n.name === game.workData.currentJob.manager);
        if (!manager) return;

        openDialogue(manager.id);
    }

    function resetDailyWork() {
        game.workData.todayWorked = false;
    }

    // ---------- CHAT SYSTEM WITH AI ----------
    /* VECCHIA FUNZIONE CHAT - SOSTITUITA DA SISTEMA DIALOGHI
    function openChat(npcId) {
        const npc = game.npcs.find(n => n.id === npcId);
        if (!npc) return;

        game.currentChatNpc = npcId;
        
        // Initialize chat history if not exists
        if (!game.chatHistory) game.chatHistory = {};
        if (!game.chatHistory[npcId]) {
            game.chatHistory[npcId] = [];
        }

        // OLD: Update chat header - NOW USING DIALOGUE SYSTEM
        // $('chatNpcName').innerText = npc.name;
        // $('chatNpcIcon').innerText = getJobIcon(npc.job);
        // $('chatNpcJob').innerText = `${npc.job} ‚Ä¢ ${npc.personality || 'amichevole'}`;
        // $('chatRelation').innerText = `Relazione: ${npc.relation}/100`;

        // Load chat history
        renderChatMessages();

        // OLD: Show chat modal - NOW USING DIALOGUE SYSTEM
        // $('chatModal').classList.add('active');
        // $('chatInput').focus();

        // Initial greeting if first time
        if (game.chatHistory[npcId].length === 0) {
            setTimeout(() => {
                addSystemMessage(`${npc.name} si avvicina...`);
                setTimeout(() => {
                    const greeting = getSimpleGreeting(npc);
                    addNpcMessage(greeting, false);
                }, 800);
            }, 300);
        }
    }

    function getSimpleGreeting(npc) {
        const greetings = {
            'amichevole': [`Ciao ${game.player.name}! Come va?`, `Ehi! Che piacere vederti!`],
            'socievole': [`${game.player.name}! Finalmente! Come stai?`, `Ehi ciao! Che bella sorpresa!`],
            'introverso': [`Oh, ciao. Come va?`, `Salve. Tutto bene?`],
            'creativa': [`Ciao! Stavo proprio pensando a qualcosa di interessante...`, `Oh ciao! Ho appena avuto un'idea!`],
            'professionale': [`Buongiorno ${game.player.name}. Come posso esserti utile?`, `Salve. √à un piacere rivederla.`],
            'paziente': [`Ciao ${game.player.name}, come ti senti oggi?`, `Salve, sono qui per ascoltarti.`]
        };
        const personality = npc.personality || 'amichevole';
        const options = greetings[personality] || greetings['amichevole'];
        return options[randInt(0, options.length - 1)];
    }
    */ // FINE VECCHIA FUNZIONE CHAT

    /* OLD CHAT FUNCTIONS - REMOVED
    function closeChat() {
        $('chatModal').classList.remove('active');
        game.currentChatNpc = null;
        updateUI();
    }

    function getJobIcon(job) {
        const icons = {
            'Studente': 'üìö',
            'Barista': '‚òï',
            'Programmatore': 'üíª',
            'Artista': 'üé®',
            'Manager': 'üíº',
            'Insegnante': 'üë®‚Äçüè´',
            'Commesso': 'üõçÔ∏è',
            'Receptionist': 'üè®',
            'Programmatore Jr': 'üíª',
            'Disoccupato': 'üîç'
        };
        return icons[job] || 'üë§';
    }

    function renderChatMessages() {
        const messagesDiv = $('chatMessages');
        const npcId = game.currentChatNpc;
        
        if (!npcId || !game.chatHistory[npcId]) return;

        messagesDiv.innerHTML = game.chatHistory[npcId].map(msg => {
            if (msg.type === 'user') {
                return `<div class="chat-message user">${escapeHtml(msg.text)}</div>`;
            } else if (msg.type === 'npc') {
                return `<div class="chat-message npc">${escapeHtml(msg.text)}</div>`;
            } else {
                return `<div class="chat-message system">${escapeHtml(msg.text)}</div>`;
            }
        }).join('');

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addSystemMessage(text) {
        const npcId = game.currentChatNpc;
        if (!npcId) return;

        game.chatHistory[npcId].push({ type: 'system', text });
        renderChatMessages();
    }

    function addNpcMessage(text, saveToHistory = true) {
        const npcId = game.currentChatNpc;
        if (!npcId) return;

        if (saveToHistory) {
            game.chatHistory[npcId].push({ type: 'npc', text });
        }
        renderChatMessages();
    }

    async function sendMessage() {
        const input = $('chatInput');
        const message = input.value.trim();
        
        if (!message || !game.currentChatNpc) return;

        const npc = game.npcs.find(n => n.id === game.currentChatNpc);
        if (!npc) return;

        // Add user message
        game.chatHistory[game.currentChatNpc].push({ type: 'user', text: message });
        input.value = '';
        renderChatMessages();

        // Show typing indicator
        $('typingIndicator').classList.add('active');
        $('sendBtn').disabled = true;

        // Simulate thinking time
        await new Promise(resolve => setTimeout(resolve, 1200));

        try {
            // Generate AI response
            const response = await generateAIResponse(message, npc);
            
            $('typingIndicator').classList.remove('active');
            
            // Add NPC response
            game.chatHistory[game.currentChatNpc].push({ type: 'npc', text: response.message });
            renderChatMessages();

            // Apply relationship changes
            if (response.relationChange) {
                npc.relation = clamp(npc.relation + response.relationChange);
                $('chatRelation').innerText = npc.isInterviewing 
                    ? `Impressione: ${npc.relation}/100` 
                    : game.currentWorkTask 
                    ? `Performance: ${game.workData.performance}%`
                    : `Relazione: ${npc.relation}/100`;
                
                if (response.relationChange > 0) {
                    game.player.stats.morale = clamp(game.player.stats.morale + 3);
                }
            }

            // Handle job offer from interview
            if (response.jobOffered && response.jobData) {
                setTimeout(() => {
                    addSystemMessage(`üéâ ${npc.name} ti ha offerto il lavoro di ${response.jobOffered}!`);
                    
                    game.player.job = response.jobOffered;
                    game.player.jobSalary = response.salary || 80;
                    game.player.jobLevel = 1;
                    game.workData.currentJob = response.jobData;
                    game.workData.performance = 100;
                    
                    // End interview
                    game.currentInterview = null;
                    npc.isInterviewing = false;
                    
                    checkQuests();
                    updateUI();
                    
                    setTimeout(() => {
                        showNotification(`‚úÖ Complimenti! Inizierai come ${response.jobOffered}`, 2500);
                    }, 1000);
                }, 1000);
            }

            // Handle work task completion
            if (response.taskCompleted) {
                setTimeout(() => {
                    addSystemMessage(`‚úÖ Task completato: "${game.currentWorkTask}"`);
                    
                    if (response.performanceChange) {
                        game.workData.performance = clamp(game.workData.performance + response.performanceChange, 0, 150);
                        
                        const perfMsg = response.performanceChange > 0 
                            ? `üìà Performance aumentata: +${response.performanceChange}%`
                            : `üìâ Performance diminuita: ${response.performanceChange}%`;
                        
                        setTimeout(() => {
                            addSystemMessage(perfMsg);
                        }, 500);
                    }
                    
                    game.currentWorkTask = null;
                    
                    setTimeout(() => {
                        completeWorkDay();
                        closeChat();
                    }, 2000);
                }, 1000);
            } else if (game.currentWorkTask && response.performanceChange) {
                // Update performance even if task not completed yet
                game.workData.performance = clamp(game.workData.performance + response.performanceChange, 0, 150);
                $('chatRelation').innerText = `Performance: ${game.workData.performance}%`;
            }

        } catch (error) {
            console.error('Chat error:', error);
            $('typingIndicator').classList.remove('active');
            game.chatHistory[game.currentChatNpc].push({ 
                type: 'system', 
                text: 'Errore nella comunicazione. Riprova.' 
            });
            renderChatMessages();
        }

        $('sendBtn').disabled = false;
        addMinutes(15); // 15 minuti per messaggio
        updateUI();
    }

    async function generateAIResponse(userMessage, npc) {
        // Build context for AI
        const context = buildChatContext(userMessage, npc);
        
        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 300,
                    messages: [
                        { 
                            role: 'user', 
                            content: context 
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            let responseText = data.content[0].text;
            
            // Try to parse JSON response
            responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            try {
                const parsed = JSON.parse(responseText);
                return parsed;
            } catch {
                // If not JSON, return as plain text
                return {
                    message: responseText,
                    relationChange: determineRelationChange(userMessage, npc)
                };
            }

        } catch (error) {
            console.error('AI Error:', error);
            return getFallbackResponse(userMessage, npc);
        }
    }

    function buildChatContext(userMessage, npc) {
        const player = game.player;
        const relation = npc.relation;
        const chatHistory = game.chatHistory[game.currentChatNpc] || [];
        const recentHistory = chatHistory.slice(-6).map(m => 
            `${m.type === 'user' ? player.name : npc.name}: ${m.text}`
        ).join('\n');

        // Check if this is a job interview
        const isJobInterview = npc.isInterviewing && game.currentInterview;
        
        // Check if this is a work task conversation
        const isWorkTask = game.currentWorkTask && npc.name === game.workData.currentJob?.manager;

        if (isJobInterview) {
            const job = game.currentInterview.job;
            return `Sei ${npc.name}, ${npc.job}. Stai conducendo un colloquio per la posizione di ${job.name}.
Il candidato √® ${player.name}, et√† ${player.age}, background: ${player.background}, reputazione: ${player.rep}/100.

SITUAZIONE: COLLOQUIO DI LAVORO
- Devi valutare il candidato in base alle sue risposte
- Fai domande pertinenti alla posizione (${job.name})
- Il lavoro richiede: ${job.tasks.join(', ')}
- Orario di lavoro: ${job.hours.start}:00 - ${job.hours.end}:00
- Stipendio offerto: ‚Ç¨${job.salary}/giorno

IMPORTANTE: Rispondi SOLO con JSON valido. Non aggiungere testo esterno.

Se il candidato risponde bene e mostra competenza/interesse:
- Aumenta "relationChange" positivamente
- Se relationChange porta relation >= 70, OFFRI IL LAVORO con "jobOffered": "${job.name}", "salary": ${job.salary}, "jobData": ${JSON.stringify(job)}

Se il candidato risponde male o √® poco professionale:
- Diminuisci "relationChange"

Conversazione:
${recentHistory || 'Inizio colloquio'}

${player.name} dice: "${userMessage}"

Rispondi con JSON:
{
  "message": "la tua risposta professionale come manager che conduce un colloquio",
  "relationChange": numero tra -15 e +15 basato sulla qualit√† della risposta${relation >= 70 ? ',\n  "jobOffered": "' + job.name + '",\n  "salary": ' + job.salary + ',\n  "jobData": ' + JSON.stringify(job) : ''}
}`;
        }

        if (isWorkTask) {
            return `Sei ${npc.name}, manager di ${player.name} che lavora come ${player.job}.
${player.name} deve completare questo task: "${game.currentWorkTask}"

SITUAZIONE: CONVERSAZIONE LAVORATIVA
- ${player.name} sta descrivendo come svolger√† il task
- Valuta la sua risposta e fornisci feedback
- Performance attuale: ${game.workData.performance}%

${player.name} dice: "${userMessage}"

Rispondi con JSON:
{
  "message": "il tuo feedback come manager",
  "relationChange": numero tra -5 e +10,
  "taskCompleted": true/false (true se la risposta dimostra competenza),
  "performanceChange": numero tra -10 e +15 (quanto cambia la performance)
}

IMPORTANTE: Rispondi SOLO con JSON valido.`;
        }

        // Normal conversation
        return `Sei ${npc.name}, un/a ${npc.job} con personalit√† ${npc.personality} e umore ${npc.mood}.
Stai parlando con ${player.name}, et√† ${player.age}, background: ${player.background}.
La vostra relazione √® a ${relation}/100. Il tuo stile conversazionale √®: ${npc.conversationStyle.tone}.

IMPORTANTISSIMO: Devi rispondere SOLO con un oggetto JSON valido. Non aggiungere testo prima o dopo il JSON.

Conversazione recente:
${recentHistory || 'Prima conversazione'}

${player.name} dice: "${userMessage}"

Rispondi con un JSON in questo formato:
{
  "message": "la tua risposta naturale e coinvolgente in italiano (1-3 frasi)",
  "relationChange": numero tra -10 e +10 basato sulla conversazione
}

Regole:
- Parla in modo naturale e umano, usa il tuo stile (${npc.conversationStyle.tone})
- Sii coerente con il tuo lavoro di ${npc.job}
- Se la relazione √® alta (>60), sii pi√π amichevole e aperto
- Se la relazione √® bassa (<30), sii pi√π distante
- Reagisci in modo appropriato al messaggio di ${player.name}
- NON scrivere nulla al di fuori del JSON`;
    }

    function determineRelationChange(userText, npc) {
        const msg = userText.toLowerCase();
        
        // Very positive
        if (msg.includes('ti amo') || msg.includes('sei fantastico') || msg.includes('sei incredibile')) return randInt(8, 12);
        if (msg.includes('grazie mille') || msg.includes('sei gentile') || msg.includes('apprezzo')) return randInt(5, 8);
        
        // Positive
        if (msg.includes('ciao') || msg.includes('come stai') || msg.includes('come va')) return randInt(2, 5);
        if (msg.includes('compliment') || msg.includes('bravo') || msg.includes('bello') || msg.includes('brava')) return randInt(3, 7);
        if (msg.includes('aiut') || msg.includes('consigli') || msg.includes('suggeriment')) return randInt(2, 5);
        if (msg.includes('interessante') || msg.includes('davvero') || msg.includes('capisco')) return randInt(2, 4);
        
        // Job/work related
        if (msg.includes('lavoro') || msg.includes('assun') || msg.includes('opportunit√†') || msg.includes('posizione')) return randInt(1, 3);
        
        // Questions
        if (msg.includes('?') || msg.includes('come') || msg.includes('quando') || msg.includes('dove')) return randInt(1, 3);
        
        // Negative
        if (msg.includes('idiota') || msg.includes('stupido') || msg.includes('scemo')) return randInt(-8, -5);
        if (msg.includes('vaffan') || msg.includes('insulto') || msg.includes('odio')) return -10;
        if (msg.includes('noioso') || msg.includes('fastidioso') || msg.includes('lasciami')) return randInt(-5, -3);
        
        // Neutral
        return randInt(1, 3);
    }

    function detectIntent(message, npc) {
        const msg = message.toLowerCase();
        
        // Job seeking
        if ((msg.includes('lavoro') || msg.includes('assun') || msg.includes('cerco lavoro') || 
             msg.includes('opportunit√†') || msg.includes('posizione')) && 
            (['Manager', 'Imprenditore', 'Direttore', 'CEO', 'Titolare', 'HR Manager', 'Team Leader'].includes(npc.job) ||
             msg.includes('hai bisogno') || msg.includes('stai cercando') || msg.includes('assumete'))) {
            return 'job_seeking';
        }
        
        // Business
        if (msg.includes('investimento') || msg.includes('affari') || msg.includes('business') || 
            msg.includes('societ√†') || msg.includes('partnership')) {
            return 'business';
        }
        
        // Location info
        if (msg.includes('dove') && (msg.includes('trovo') || msg.includes('posso') || msg.includes('si trova'))) {
            return 'location_info';
        }
        
        // Advice
        if (msg.includes('consigli') || msg.includes('suggeriment') || msg.includes('cosa ne pensi') || 
            msg.includes('come faccio') || msg.includes('aiuto')) {
            return 'advice';
        }
        
        // Social
        if (msg.includes('amici') || msg.includes('conoscere') || msg.includes('uscire') || 
            msg.includes('insieme') || msg.includes('caff√®') || msg.includes('pranzo') || msg.includes('cena')) {
            return 'social';
        }
        
        // Shopping
        if (msg.includes('comprare') || msg.includes('vendere') || msg.includes('acquistare') || 
            msg.includes('prezzo') || msg.includes('costa')) {
            return 'shopping';
        }
        
        return 'general';
    }

    function getJobSeekingResponse(message, npc) {
        const relation = npc.relation;
        const canHire = ['Manager', 'Imprenditore', 'Direttore', 'CEO', 'Titolare', 'HR Manager', 'Team Leader'].includes(npc.job);
        
        if (canHire && relation >= 60) {
            const jobOffers = [
                { title: 'Assistente', salary: 70, hours: {start: 9, end: 18}, daysPerWeek: 5, message: "Sai che c'√®? Mi piaci! Abbiamo bisogno di un assistente. Paga ‚Ç¨70 al giorno. Interessato?" },
                { title: 'Collaboratore', salary: 90, hours: {start: 9, end: 17}, daysPerWeek: 5, message: "Proprio oggi cercavo qualcuno di fidato! Ti offro un posto come collaboratore a ‚Ç¨90 al giorno. Che dici?" },
                { title: 'Responsabile Vendite', salary: 110, hours: {start: 10, end: 19}, daysPerWeek: 5, message: "Conosco le tue capacit√†. Che ne dici di lavorare come responsabile vendite? ‚Ç¨110 al giorno." }
            ];
            const offer = jobOffers[randInt(0, jobOffers.length - 1)];
            
            setTimeout(function() {
                if (confirm(`${npc.name} ti offre il lavoro di ${offer.title}:\nüí∞ Stipendio: ‚Ç¨${offer.salary}/giorno\n‚è∞ Orario: ${offer.hours.start}:00-${offer.hours.end}:00\nüìÖ Giorni: ${offer.daysPerWeek}/settimana\n\nAccetti?`)) {
                    game.player.job = offer.title;
                    game.player.salary = offer.salary;
                    game.workData.workHours = offer.hours;
                    game.workData.daysPerWeek = offer.daysPerWeek;
                    game.workData.currentJob = {
                        name: offer.title,
                        salary: offer.salary,
                        hours: offer.hours,
                        daysPerWeek: offer.daysPerWeek
                    };
                    showNotification("üéâ Congratulazioni! Sei stato assunto come " + offer.title + "!", 3000);
                    updateUI();
                }
            }, 100);
            
            return {
                message: offer.message,
                relationChange: 5
            };
        } else if (canHire && relation >= 30) {
            const responses = [
                "Mmm, lavoro... Al momento non abbiamo posizioni aperte, ma tieni d'occhio. Potresti lasciare il CV?",
                "Interessante che tu lo chieda. Non stiamo assumendo ora, ma se miglioriamo la nostra relazione, chiss√†!",
                "Lavoro? Beh, dipende. Devo conoscerti meglio prima di prenderti nel team. Parliamo di pi√π!"
            ];
            return {
                message: responses[randInt(0, responses.length - 1)],
                relationChange: 2
            };
        } else if (canHire) {
            return {
                message: "Lavoro? Non ti conosco abbastanza per assumerti. Forse se parliamo di pi√π e ci conosciamo meglio...",
                relationChange: 1
            };
        } else {
            const responses = [
                "Lavoro? Guarda, non sono io che assumo, ma ti posso dare un consiglio: vai a parlare con qualche Manager nel Business District. Stanno cercando gente!",
                "Ah, cerchi lavoro? Io purtroppo sono solo " + npc.job + ", ma so che al Business District cercano sempre personale!",
                "Non sono in posizione di assumere, ma ti posso dire che con le tue capacit√† dovresti provare al Business District. L√† cercano sempre!"
            ];
            return {
                message: responses[randInt(0, responses.length - 1)],
                relationChange: 2
            };
        }
    }

    function getBusinessResponse(message, npc) {
        const relation = npc.relation;
        if (relation >= 70 && game.player.money >= 10000) {
            return { message: "Affari? Interessante! Ho un'opportunit√† di investimento. Con ‚Ç¨10,000 potresti entrare in una mia attivit√†. Ti interessa?", relationChange: 5 };
        } else if (relation >= 50) {
            return { message: "Affari? Mi piace il tuo spirito imprenditoriale! Quando avrai pi√π capitale ne riparliamo.", relationChange: 3 };
        }
        return { message: "Business? Beh, gli affari si fanno tra persone che si fidano. Conosciamoci meglio prima.", relationChange: 1 };
    }

    function getLocationInfoResponse(message, npc) {
        const locations = [
            { place: 'banca', info: "La banca? Vai al Business District, √® il grande edificio con le colonne!" },
            { place: 'lavoro', info: "Per trovare lavoro vai al Business District o al Tech Hub!" },
            { place: 'mangiare', info: "Per mangiare bene ti consiglio il Centro Storico!" },
            { place: 'divertir', info: "Per divertirti vai alla Vita Notturna!" },
            { place: 'palestra', info: "La palestra migliore √® nella Zona Sportiva!" }
        ];
        const msg = message.toLowerCase();
        for (var i = 0; i < locations.length; i++) {
            if (msg.includes(locations[i].place)) {
                return { message: locations[i].info, relationChange: 2 };
            }
        }
        return { message: "Cosa cercavi esattamente? Dimmi meglio e ti aiuto!", relationChange: 1 };
    }

    function getAdviceResponse(message, npc) {
        const advices = [
            "Per fare soldi: lavora sodo, risparmia, e poi investi!",
            "Per la carriera: crea relazioni, sii affidabile, prendi rischi calcolati!",
            "Per la felicit√†: equilibrio √® la chiave. Lavoro, socialit√†, salute!"
        ];
        return { message: advices[randInt(0, advices.length - 1)], relationChange: 3 };
    }

    function getSocialResponse(message, npc) {
        const relation = npc.relation;
        if (relation >= 70) {
            setTimeout(function() {
                game.player.stats.happiness = Math.min(100, game.player.stats.happiness + 10);
                showNotification("‚ù§Ô∏è " + npc.name + " √® felice di passare tempo con te! +10 Felicit√†", 2000);
                updateUI();
            }, 100);
            return { message: "Uscire insieme? Assolutamente s√¨! Che ne dici di un caff√® domani?", relationChange: 5 };
        } else if (relation >= 40) {
            return { message: "Uscire? Perch√© no! Per√≤ conosciamoci un po' meglio prima.", relationChange: 3 };
        }
        return { message: "Mmm, uscire? Non ti conosco ancora abbastanza. Forse pi√π avanti...", relationChange: 1 };
    }

    function getShoppingResponse(message, npc) {
        return { message: "Per lo shopping ti consiglio il Centro Commerciale! Hanno di tutto!", relationChange: 2 };
    }

    function getFallbackResponse(message, npc) {
        const msg = message.toLowerCase();
        const intent = detectIntent(message, npc);
        
        // Handle specific intents
        if (intent === 'job_seeking') {
            return getJobSeekingResponse(message, npc);
        } else if (intent === 'business') {
            return getBusinessResponse(message, npc);
        } else if (intent === 'location_info') {
            return getLocationInfoResponse(message, npc);
        } else if (intent === 'advice') {
            return getAdviceResponse(message, npc);
        } else if (intent === 'social') {
            return getSocialResponse(message, npc);
        } else if (intent === 'shopping') {
            return getShoppingResponse(message, npc);
        }
        
        // General conversation by personality
        const responses = {
            'amichevole': [
                "Capisco cosa intendi! √à interessante vedere le cose da questa prospettiva.",
                "S√¨, la vita √® piena di sorprese! Non sai mai cosa pu√≤ succedere.",
                "Interessante! Mi piace come ragioni su queste cose.",
                "Beh, ognuno ha il suo punto di vista. Il tuo √® davvero particolare!",
                "√à un argomento che mi affascina! Parlami di pi√π, se ti va."
            ],
            'socievole': [
                "Wow, davvero?! Che figata! Devi assolutamente raccontarmi di pi√π!",
                "S√¨ s√¨, ti capisco perfettamente! √à esattamente come dici tu!",
                "Ma dai! Non ci posso credere! E poi cos'√® successo?",
                "Oddio s√¨! Anche io la penso cos√¨! Siamo sulla stessa lunghezza d'onda!",
                "Che storia! Ma √® incredibile! Ti √® davvero successo?"
            ],
            'introverso': [
                "Capisco.",
                "Interessante punto di vista.",
                "Hm, devo pensarci.",
                "S√¨, ha senso.",
                "Comprendo cosa intendi."
            ],
            'creativa': [
                "Oh, questo mi d√† delle idee fantastiche!",
                "Che prospettiva interessante! Non l'avrei mai vista cos√¨!",
                "Mi piace come pensi! √à davvero originale!",
                "Affascinante! Potrebbe essere l'inizio di qualcosa di creativo!",
                "Wow, la tua immaginazione √® incredibile!"
            ],
            'professionale': [
                "Comprendo la situazione. Procediamo con metodo.",
                "Vedo. Andiamo direttamente al punto.",
                "Interessante. Quali sono i prossimi passi?",
                "Capito. Organizziamo le priorit√†.",
                "Chiaro. Focalizziamoci sugli obiettivi concreti."
            ],
            'paziente': [
                "Ti ascolto, prenditi il tuo tempo.",
                "Capisco, √® normale sentirsi cos√¨.",
                "Va bene, parliamone con calma.",
                "Comprendo. Non c'√® fretta, sono qui.",
                "S√¨, ti seguo. Continua pure, ti ascolto attentamente."
            ]
        };

        const personality = npc.personality || 'amichevole';
        const options = responses[personality] || responses['amichevole'];
        const responseMessage = options[randInt(0, options.length - 1)];

        return {
            message: responseMessage,
            relationChange: determineRelationChange(message, npc)
        };
    }

    // ---------- RANDOM ENCOUNTERS ----------
    function triggerRandomEncounter() {
        if (Math.random() > 0.3) return; // 30% chance

        const locations = ['Parco', 'Caff√®', 'Biblioteca', 'Palestra', 'Centro Commerciale', 'Ristorante', 'Business District', 'Tech Hub'];
        const names = ['Elena', 'Davide', 'Francesca', 'Matteo', 'Laura', 'Roberto', 'Valentina', 'Simone', 'Marco', 'Giulia', 'Alessandro', 'Sofia'];
        const jobs = ['Studente', 'Barista', 'Designer', 'Fotografo', 'Musicista', 'Scrittore', 'Personal Trainer', 'Manager', 'Imprenditore', 'Direttore', 'CEO', 'Titolare', 'HR Manager', 'Team Leader'];
        const personalities = ['amichevole', 'socievole', 'introverso', 'creativa', 'professionale', 'paziente'];

        const newNPC = {
            id: 'npc_' + Date.now(),
            name: names[randInt(0, names.length - 1)],
            relation: randInt(10, 25),
            job: jobs[randInt(0, jobs.length - 1)],
            location: locations[randInt(0, locations.length - 1)],
            personality: personalities[randInt(0, personalities.length - 1)],
            mood: ['allegro', 'neutro', 'pensieroso', 'energico'][randInt(0, 3)],
            conversationStyle: null,
            lastInteraction: game.time.day
        };

        newNPC.conversationStyle = getConversationStyle(newNPC.personality);

        game.npcs.push(newNPC);
        showNotification(`‚ú® Hai incontrato ${newNPC.name}, ${newNPC.job} al ${newNPC.location}!`, 3000);
        renderKnownPeople();
    }

    END OF OLD CHAT FUNCTIONS - COMMENTED OUT */

    // Helper function needed by both systems
    function getJobIcon(job) {
        const icons = {
            'Studente': 'üìö',
            'Barista': '‚òï',
            'Programmatore': 'üíª',
            'Artista': 'üé®',
            'Manager': 'üíº',
            'Insegnante': 'üë®‚Äçüè´',
            'Commesso': 'üõçÔ∏è',
            'Receptionist': 'üè®',
            'Programmatore Jr': 'üíª',
            'Disoccupato': 'üîç',
            'CEO': 'üëî',
            'Imprenditore': 'üè¢',
            'Direttore': 'üìä',
            'HR Manager': 'üë•',
            'Team Leader': 'üéØ',
            'Coordinatore': 'üìã',
            'Responsabile Vendite': 'üíº',
            'Assistente': 'üìù',
            'Collaboratore': 'ü§ù'
        };
        return icons[job] || 'üë§';
    }

    // ---------- AUTO-SAVE ----------
    // ============================================
    // SISTEMA DIALOGHI DINAMICO - COMPLETO
    // ============================================

    let currentDialogueNPC = null;

    // Inizializza memoria NPC
    function initNPCMemory(npc) {
        if (!npc.memory) {
            npc.memory = {
                conversations: 0,
                topics: [],
                favors: [],
                promises: [],
                insults: 0,
                compliments: 0,
                lastInteraction: null,
                relationHistory: [npc.relation],
                jobOffered: false,
                jobRejected: false,
                metFamily: false,
                sharedSecrets: false,
                trustLevel: 'sconosciuto',
                mood: 'neutro'
            };
        }
    }

    // Aggiorna livello fiducia
    function updateTrustLevel(npc) {
        const rel = npc.relation;
        const mem = npc.memory;
        
        if (rel >= 90 && mem.sharedSecrets && mem.conversations >= 20) {
            mem.trustLevel = 'familiare';
        } else if (rel >= 70 && mem.conversations >= 10) {
            mem.trustLevel = 'confidente';
        } else if (rel >= 50 && mem.conversations >= 5) {
            mem.trustLevel = 'amico';
        } else if (rel >= 30 || mem.conversations >= 2) {
            mem.trustLevel = 'conoscente';
        } else {
            mem.trustLevel = 'sconosciuto';
        }
    }

    // Sistema check D&D
    function makeCheck(type, difficulty) {
        const player = game.player;
        let modifier = 0;
        
        switch(type) {
            case 'charisma':
                modifier = Math.floor((player.skills.charisma || 0) / 10);
                break;
            case 'intelligence':
                modifier = Math.floor((player.skills.intellect || 0) / 10);
                break;
            case 'creativity':
                modifier = Math.floor((player.skills.creativity || 0) / 10);
                break;
            case 'fitness':
                modifier = Math.floor((player.skills.fitness || 0) / 10);
                break;
        }
        
        const roll = randInt(1, 20) + modifier;
        const success = roll >= difficulty;
        
        return {
            success: success,
            roll: roll - modifier,
            modifier: modifier,
            total: roll,
            margin: roll - difficulty
        };
    }

    // ============================================
    // SISTEMA DIALOGHI CONTESTUALI
    // ============================================
    
    // Determina il contesto della conversazione
    function getConversationContext(npc) {
        // Colloquio di lavoro
        if (game.currentInterview && game.currentInterview.manager && game.currentInterview.manager.id === npc.id) {
            return {
                type: 'job_interview',
                job: game.currentInterview.job
            };
        }
        
        // Giornata lavorativa
        if (game.currentWorkTask && game.workData && game.workData.currentJob && npc.name === game.workData.currentJob.manager) {
            return {
                type: 'work_task',
                task: game.currentWorkTask
            };
        }
        
        // Conversazione normale
        return {
            type: 'normal'
        };
    }
    
    // Genera opzioni per COLLOQUIO DI LAVORO - VERSIONE REALISTICA
    function getJobInterviewOptions(npc, job) {
        const options = [];
        const player = game.player;
        const skills = player.skills;
        
        // Mappa skill per tipo di lavoro
        const jobSkillMap = {
            'Programmatore Junior': 'intellect',
            'Programmatore Senior': 'intellect',
            'Grafico Pubblicitario': 'creativity',
            'Social Media Manager': 'creativity',
            'Commesso Supermercato': 'charisma',
            'Commesso Boutique': 'charisma',
            'Barista': 'charisma',
            'Cameriere': 'charisma',
            'Manager Boutique Luxury': 'charisma',
            'Project Manager': 'intellect',
            'Istruttore Palestra': 'fitness',
            'Terapista SPA': 'fitness'
        };
        
        const relevantSkill = jobSkillMap[job.name] || 'charisma';
        const skillValue = skills[relevantSkill] || 0;
        
        // Calcola difficolt√† base in base allo stipendio/livello lavoro
        const baseDifficulty = Math.min(18, Math.max(10, Math.floor(job.salary / 20)));
        
        // FASE 1: SALUTO INIZIALE
        if (!npc.memory.jobInterviewStarted) {
            options.push({
                id: 'interview_greeting_confident',
                text: 'üëî Buongiorno, sono molto interessato a questa posizione',
                type: 'interview_greeting',
                check: { type: 'charisma', difficulty: 12 },
                outcomes: {
                    success: { relation: 5, response: 'Ottimo! Mi piace l\'entusiasmo. Iniziamo. Mi parli delle sue competenze.' },
                    failure: { relation: 2, response: 'Bene. Mi parli di lei.' }
                }
            });
            
            options.push({
                id: 'interview_greeting_nervous',
                text: 'üòÖ Buongiorno... sono qui per il colloquio',
                type: 'interview_greeting',
                outcomes: {
                    relation: 1,
                    response: 'S√¨, lo so. Si calmi e mi parli delle sue competenze per questa posizione.'
                }
            });
            
            npc.memory.jobInterviewStarted = true;
            npc.memory.interviewQuestionCount = 0;
        }
        
        // FASE 2-4: DOMANDE MULTIPLE (3-5 domande per colloquio)
        const questionCount = npc.memory.interviewQuestionCount || 0;
        
        // Pool di domande generiche (sempre disponibili)
        const genericQuestions = [
            {
                id: 'q_why_here',
                text: 'üéØ "Perch√© vuole lavorare qui?"',
                options: [
                    { text: 'üíº Questa azienda √® leader nel settore', check: 'charisma', diff: baseDifficulty, success: 5, fail: -3 },
                    { text: 'üí∞ Mi interessa la retribuzione', check: 'charisma', diff: baseDifficulty + 4, success: 2, fail: -8 },
                    { text: 'üåü Voglio crescere professionalmente', check: 'charisma', diff: baseDifficulty - 2, success: 6, fail: -2 },
                    { text: 'üòÖ Ho bisogno di un lavoro', check: 'charisma', diff: baseDifficulty + 6, success: 1, fail: -10 }
                ]
            },
            {
                id: 'q_strengths',
                text: 'üí™ "Quali sono i suoi punti di forza?"',
                options: [
                    { text: 'üéØ Sono affidabile e puntuale', check: 'charisma', diff: baseDifficulty, success: 4, fail: -2 },
                    { text: 'üß† Imparo velocemente', check: 'intellect', diff: baseDifficulty - 1, success: 5, fail: -3 },
                    { text: 'ü§ù Lavoro bene in team', check: 'charisma', diff: baseDifficulty - 2, success: 6, fail: -2 },
                    { text: 'üåü Sono il migliore!', check: 'charisma', diff: baseDifficulty + 5, success: 8, fail: -12 }
                ]
            },
            {
                id: 'q_weaknesses',
                text: '‚ö†Ô∏è "Mi parli di un suo punto debole"',
                options: [
                    { text: 'üéØ Perfezionismo - dedico troppo tempo ai dettagli', check: 'charisma', diff: baseDifficulty + 2, success: 7, fail: -4 },
                    { text: 'üòÖ Sono sempre in ritardo', check: 'charisma', diff: baseDifficulty + 8, success: 2, fail: -15 },
                    { text: 'üìö A volte mi serve pi√π tempo per apprendere', check: 'charisma', diff: baseDifficulty, success: 5, fail: -5 },
                    { text: 'ü§∑ Non ho difetti rilevanti', check: 'charisma', diff: baseDifficulty + 6, success: 3, fail: -10 }
                ]
            },
            {
                id: 'q_pressure',
                text: '‚è∞ "Come gestisce lo stress e le scadenze?"',
                options: [
                    { text: 'üí™ Lavoro meglio sotto pressione', check: 'fitness', diff: baseDifficulty - 1, success: 6, fail: -3 },
                    { text: 'üìã Organizzo priorit√† e seguo un piano', check: 'intellect', diff: baseDifficulty, success: 7, fail: -2 },
                    { text: 'üò∞ Lo stress mi blocca', check: 'charisma', diff: baseDifficulty + 8, success: 1, fail: -12 },
                    { text: 'üßò Uso tecniche di rilassamento', check: 'fitness', diff: baseDifficulty + 1, success: 5, fail: -4 }
                ]
            },
            {
                id: 'q_future',
                text: 'üîÆ "Dove si vede tra 5 anni?"',
                options: [
                    { text: 'üìà In una posizione senior in questa azienda', check: 'charisma', diff: baseDifficulty - 1, success: 6, fail: -3 },
                    { text: 'üíº A gestire il mio business', check: 'charisma', diff: baseDifficulty + 3, success: 4, fail: -8 },
                    { text: 'ü§î Non ci ho ancora pensato', check: 'charisma', diff: baseDifficulty + 6, success: 1, fail: -10 },
                    { text: 'üåç Esperto riconosciuto nel settore', check: 'intellect', diff: baseDifficulty + 2, success: 7, fail: -4 }
                ]
            }
        ];
        
        // Seleziona 1-2 domande generiche casuali
        const shuffledGeneric = [...genericQuestions].sort(() => Math.random() - 0.5);
        const numGenericQuestions = questionCount < 2 ? 2 : 1;
        
        for (let i = 0; i < Math.min(numGenericQuestions, shuffledGeneric.length); i++) {
            const q = shuffledGeneric[i];
            q.options.forEach(opt => {
                options.push({
                    id: `${q.id}_${options.length}`,
                    text: opt.text,
                    type: 'interview_answer',
                    check: { type: opt.check, difficulty: opt.diff },
                    outcomes: {
                        success: { relation: opt.success, response: 'Buona risposta.' },
                        failure: { relation: opt.fail, response: 'Risposta inadeguata.' }
                    }
                });
            });
        }
        
        // DOMANDE SPECIFICHE PER CATEGORIA DI LAVORO
        const techJobs = ['Programmatore Junior', 'Programmatore Senior', 'Grafico Pubblicitario', 'Social Media Manager', 'CTO'];
        const serviceJobs = ['Barista', 'Cameriere', 'Commesso Supermercato', 'Commesso Boutique', 'Addetto Pet Shop', 'Libraio', 'Pasticciere', 'Commesso Ferramenta', 'Commesso Gioielleria'];
        const managerJobs = ['Project Manager', 'Manager Boutique Luxury', 'Direttore', 'CEO'];
        const healthJobs = ['Terapista SPA', 'Istruttore Palestra'];
        const creativeJobs = ['Assistente Gallerista'];
        
        if (techJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // TECH: Domande tecniche
            options.push({
                id: 'tech_skills_strong',
                text: 'üíª Ho esperienza con linguaggi moderni e framework',
                type: 'interview_answer',
                check: { type: 'intellect', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 8, response: 'Ottimo! Competenze solide.' },
                    failure: { relation: -5, response: 'Hmm, pensavo sapesse pi√π dettagli tecnici...' }
                }
            });
            
            options.push({
                id: 'tech_skills_weak',
                text: 'üòÖ Sono autodidatta, sto ancora imparando',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 5 },
                outcomes: {
                    success: { relation: 3, response: 'L\'onest√† √® apprezzata, ma serve esperienza.' },
                    failure: { relation: -10, response: 'Cerchiamo qualcuno gi√† formato...' }
                }
            });
            
            if (skillValue >= 60) {
                options.push({
                    id: 'tech_portfolio',
                    text: '‚≠ê Ho un portfolio con progetti reali e certificazioni',
                    type: 'interview_answer',
                    check: { type: 'intellect', difficulty: baseDifficulty - 3 },
                    outcomes: {
                        success: { relation: 12, response: 'Eccellente! Profilo perfetto!', jobOfferBoost: 25 },
                        failure: { relation: 4, response: 'Interessante, valuteremo.' }
                    }
                });
            }
        } else if (serviceJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // SERVIZI: Domande customer service
            options.push({
                id: 'service_exp_yes',
                text: 'ÔøΩ Ho esperienza nel servizio clienti',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty - 2 },
                outcomes: {
                    success: { relation: 7, response: 'Perfetto! L\'esperienza √® fondamentale.' },
                    failure: { relation: -3, response: 'Ma esempi concreti ne ha?' }
                }
            });
            
            options.push({
                id: 'service_exp_no',
                text: 'üòÖ Primo lavoro ma imparo velocemente',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 4 },
                outcomes: {
                    success: { relation: 3, response: 'Ok, possiamo formarla.' },
                    failure: { relation: -7, response: 'Cerchiamo qualcuno gi√† formato...' }
                }
            });
            
        } else if (managerJobs.some(j => job.name.includes(j) || j.includes(job.name))) {
            // MANAGEMENT: Leadership
            options.push({
                id: 'mgmt_leadership',
                text: 'üìä Ho gestito team e raggiunto obiettivi aziendali',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 9, response: 'Esattamente il profilo che cerchiamo!' },
                    failure: { relation: -4, response: 'Servono prove concrete...' }
                }
            });
            
            options.push({
                id: 'mgmt_noexp',
                text: 'ÔøΩ Voglio crescere e diventare un leader',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 5 },
                outcomes: {
                    success: { relation: 4, response: 'Ambizione buona, ma serve esperienza.' },
                    failure: { relation: -9, response: 'Cerchiamo manager esperti, non aspiranti.' }
                }
            });
            
        } else if (healthJobs.some(j => job.name.includes(j))) {
            // HEALTH/FITNESS
            options.push({
                id: 'health_cert',
                text: 'ÔøΩ Ho certificazioni e esperienza nel settore',
                type: 'interview_answer',
                check: { type: 'fitness', difficulty: baseDifficulty - 1 },
                outcomes: {
                    success: { relation: 8, response: 'Perfetto! Le certificazioni sono importanti.' },
                    failure: { relation: -4, response: 'Le certificazioni sono obbligatorie...' }
                }
            });
            
            options.push({
                id: 'health_passion',
                text: 'üòä Sono appassionato di benessere',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 3 },
                outcomes: {
                    success: { relation: 4, response: 'La passione √® buona, ma servono competenze.' },
                    failure: { relation: -6, response: 'Servono qualifiche professionali...' }
                }
            });
            
        } else if (creativeJobs.some(j => job.name.includes(j))) {
            // CREATIVI/CULTURA
            options.push({
                id: 'creative_knowledge',
                text: 'üé® Ho conoscenze approfondite di arte e cultura',
                type: 'interview_answer',
                check: { type: 'creativity', difficulty: baseDifficulty },
                outcomes: {
                    success: { relation: 7, response: 'Ottimo! La cultura √® fondamentale per noi.' },
                    failure: { relation: -3, response: 'Aspettavamo pi√π preparazione...' }
                }
            });
            
            options.push({
                id: 'creative_passion',
                text: 'ÔøΩ Sono molto appassionato d\'arte',
                type: 'interview_answer',
                check: { type: 'charisma', difficulty: baseDifficulty + 3 },
                outcomes: {
                    success: { relation: 4, response: 'La passione √® importante.' },
                    failure: { relation: -5, response: 'Serve conoscenza, non solo passione.' }
                }
            });
        }
        
        // OPZIONI CHIUSURA COLLOQUIO - sempre disponibili
        // Chiusura formale e professionale
        options.push({
            id: 'interview_conclude_professional',
            text: 'ü§ù Grazie per il suo tempo. Quando avr√≤ una risposta?',
            type: 'interview_end',
            check: { type: 'charisma', difficulty: 12 },
            outcomes: {
                success: {
                    relation: 3,
                    response: '√à stato un piacere conoscerla. La ricontatteremo entro 48 ore. Ottima presentazione!',
                    event: 'interview_end'
                },
                failure: {
                    relation: 1,
                    response: 'La ricontatteremo entro 48 ore. Grazie per essere venuto.',
                    event: 'interview_end'
                }
            }
        });
        
        // Chiusura con interesse
        options.push({
            id: 'interview_conclude_interested',
            text: 'üíº Sono molto interessato a questa opportunit√†. Grazie!',
            type: 'interview_end',
            outcomes: {
                relation: 2,
                response: 'L\'entusiasmo √® importante. Valuteremo attentamente la sua candidatura. A presto!',
                event: 'interview_end'
            }
        });
        
        // Chiusura neutrale
        options.push({
            id: 'interview_conclude_neutral',
            text: 'üëã Grazie per l\'opportunit√†. Buona giornata',
            type: 'interview_end',
            outcomes: {
                relation: 0,
                response: 'Arrivederci. Le faremo sapere.',
                event: 'interview_end'
            }
        });
        
        // Incrementa contatore domande solo se non √® il saluto iniziale
        if (npc.memory.jobInterviewStarted) {
            npc.memory.interviewQuestionCount = (npc.memory.interviewQuestionCount || 0) + 1;
        }
        
        return options;
    }
    
    // Genera opzioni per GIORNATA LAVORATIVA
    function getWorkTaskOptions(npc, task) {
        const options = [];
        const player = game.player;
        const job = game.workData?.currentJob;
        
        if (!job) return options;
        
        // Determina skill rilevante
        const jobSkillMap = {
            'Programmatore': 'intellect',
            'Programmatore Jr': 'intellect',
            'Designer': 'creativity',
            'Artista': 'creativity',
            'Manager': 'charisma',
            'Team Leader': 'charisma',
            'Barista': 'charisma',
            'Commesso': 'charisma',
            'Receptionist': 'charisma',
            'Insegnante': 'intellect',
            'Personal Trainer': 'fitness'
        };
        
        const relevantSkill = jobSkillMap[job.name] || 'charisma';
        const skillValue = player.skills[relevantSkill] || 0;
        
        // SALUTO INIZIALE
        if (!npc.memory.workGreeted) {
            const greetings = [
                'üëã Buongiorno! Pronto a lavorare',
                'üåÖ Buongiorno, sono arrivato!',
                '‚òï Buongiorno! Caff√® bevuto, pronto!',
                'üòä Buongiorno! Bella giornata!',
                'üí™ Buongiorno! Carico e motivato!'
            ];
            
            options.push({
                id: 'work_greeting',
                text: greetings[randInt(0, greetings.length - 1)],
                type: 'work_greeting',
                outcomes: {
                    relation: 2,
                    response: `Buongiorno ${player.name}. Oggi il tuo compito √®: "${task}". Come procedi?`
                }
            });
            
            npc.memory.workGreeted = true;
            return options;
        }
        
        // Risposte BASE
        const basicResponses = [
            'üí™ Far√≤ del mio meglio',
            '‚úÖ Ok, ci provo subito',
            'üéØ Capito, inizio ora',
            'üëç Va bene, lo faccio',
            'üìã Ricevuto, procedo'
        ];
        
        options.push({
            id: 'task_basic',
            text: basicResponses[randInt(0, basicResponses.length - 1)],
            type: 'work_response',
            check: { type: relevantSkill, difficulty: 14 },
            outcomes: {
                success: { 
                    relation: 3, 
                    performance: 5,
                    response: 'Bene, conta su di te. Fammi sapere se hai dubbi.'
                },
                failure: { 
                    relation: 1,
                    performance: 2,
                    response: 'Ok. Cerca di fare un buon lavoro.'
                }
            }
        });
        
        // Risposte COMPETENTI (30+)
        if (skillValue >= 30) {
            const competentResponses = [
                '‚úÖ So esattamente come procedere',
                'üéØ Ho gi√† un piano d\'azione',
                'üí° Conosco il processo',
                'üìä So come gestirlo bene'
            ];
            
            options.push({
                id: 'task_competent',
                text: competentResponses[randInt(0, competentResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 12 },
                outcomes: {
                    success: { 
                        relation: 5, 
                        performance: 10,
                        response: 'Ottimo! Mi piace questa sicurezza.'
                    },
                    failure: { 
                        relation: 2,
                        performance: 5,
                        response: 'Ok, mostrami i risultati.'
                    }
                }
            });
        }
        
        // Risposte AVANZATE (50+)
        if (skillValue >= 50) {
            const advancedResponses = [
                'üöÄ Ho esperienza in situazioni simili',
                '‚≠ê User√≤ le strategie che hanno funzionato',
                'üéñÔ∏è √à nel mio campo di expertise',
                'üíé Posso applicare tecniche avanzate'
            ];
            
            options.push({
                id: 'task_advanced',
                text: advancedResponses[randInt(0, advancedResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 10 },
                outcomes: {
                    success: { 
                        relation: 7, 
                        performance: 15,
                        response: 'Perfetto! Sapevo di poter contare su di te!',
                        bonus: 20
                    },
                    failure: { 
                        relation: 3,
                        performance: 8,
                        response: 'Bene, mi fido della tua esperienza.'
                    }
                }
            });
        }
        
        // Risposte ESPERTE (70+)
        if (skillValue >= 70) {
            const expertResponses = [
                'üí° Ho un\'idea per farlo meglio e pi√π veloce',
                'üöÄ Posso ottimizzare il processo',
                '‚≠ê Conosco una soluzione innovativa',
                'üèÜ Ho un metodo molto efficace'
            ];
            
            options.push({
                id: 'task_expert',
                text: expertResponses[randInt(0, expertResponses.length - 1)],
                type: 'work_response',
                check: { type: relevantSkill, difficulty: 8 },
                outcomes: {
                    success: { 
                        relation: 10, 
                        performance: 20,
                        response: 'Eccellente! Questa √® l\'iniziativa che cerco!',
                        bonus: 40
                    },
                    failure: { 
                        relation: 4,
                        performance: 10,
                        response: 'Interessante. Vediamo i risultati.'
                    }
                }
            });
        }
        
        // Chiedi aiuto
        options.push({
            id: 'task_help',
            text: 'ü§î Ho dei dubbi, pu√≤ aiutarmi?',
            type: 'work_help',
            outcomes: {
                relation: -1,
                performance: 3,
                response: 'Devi essere pi√π autonomo, ma ok. Ti spiego...'
            }
        });
        
        // Completa lavoro
        if (game.workData.performance >= 50) {
            options.push({
                id: 'task_complete',
                text: '‚úÖ Ho finito il compito!',
                type: 'work_complete',
                outcomes: {
                    relation: 3,
                    response: 'Bene! Ottimo lavoro! A domani!',
                    event: 'complete_work_day'
                }
            });
        }
        
        return options;
    }

    // Genera opzioni di dialogo dinamiche (ORIGINALE - per conversazioni normali)
    function getDialogueOptions(npc, context = {}) {
        // Prima controlla il contesto
        const conversationContext = getConversationContext(npc);
        
        // Se √® un colloquio, usa le opzioni specifiche
        if (conversationContext.type === 'job_interview') {
            return getJobInterviewOptions(npc, conversationContext.job);
        }
        
        // Altrimenti usa il sistema normale
        initNPCMemory(npc);
        updateTrustLevel(npc);
        
        const options = [];
        const mem = npc.memory;
        const rel = npc.relation;
        const trust = mem.trustLevel;
        const canHire = ['Manager', 'Imprenditore', 'Direttore', 'CEO', 'Titolare', 'HR Manager', 'Team Leader'].includes(npc.job);
        
        // SALUTI
        if (mem.conversations === 0) {
            options.push({
                id: 'intro_friendly',
                text: `üëã Ciao! Sono ${game.player.name}`,
                type: 'greeting',
                outcomes: { 
                    relation: 3, 
                    memory: ['first_meeting'],
                    response: `Piacere! Io sono ${npc.name}. Che ci fai da queste parti?`
                },
                followUp: [
                    {
                        id: 'intro_job',
                        text: `üíº Lavoro come ${game.player.job}`,
                        type: 'personal',
                        outcomes: { 
                            relation: 2,
                            response: `Interessante! Io invece faccio ${npc.job}.`
                        },
                        followUp: [
                            {
                                id: 'ask_experience',
                                text: 'üìö Da quanto fai questo lavoro?',
                                type: 'info',
                                outcomes: {
                                    relation: 2,
                                    response: `Ormai da qualche anno. All'inizio era dura, ma ora va meglio.`
                                }
                            },
                            {
                                id: 'ask_like_job',
                                text: 'üòä Ti piace il tuo lavoro?',
                                type: 'personal',
                                outcomes: {
                                    relation: 3,
                                    response: npc.mood === 'felice' ? 'S√¨, tantissimo! Non lo cambierei per niente al mondo.' : 'Ha i suoi pro e contro, ma in generale s√¨.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'intro_explore',
                        text: 'üó∫Ô∏è Sto esplorando la citt√†',
                        type: 'casual',
                        outcomes: { 
                            relation: 2,
                            response: 'Ah, sei nuovo qui? Eldoria √® bellissima, vedrai!'
                        },
                        followUp: [
                            {
                                id: 'ask_recommendations',
                                text: 'üìç Cosa mi consigli di visitare?',
                                type: 'advice',
                                outcomes: {
                                    relation: 3,
                                    response: `Devi assolutamente vedere ${['il Centro Storico', 'il Parco Centrale', 'il Porto', 'il Business District'][randInt(0, 3)]}! √à stupendo!`
                                }
                            },
                            {
                                id: 'ask_safety',
                                text: 'üõ°Ô∏è La citt√† √® sicura?',
                                type: 'advice',
                                outcomes: {
                                    relation: 2,
                                    response: 'Dipende dalle zone. La periferia pu√≤ essere pericolosa di notte, ma il centro √® tranquillo.'
                                }
                            }
                        ]
                    }
                ]
            });
            if (game.player.skills.charisma >= 20) {
                options.push({
                    id: 'intro_professional',
                    text: 'ü§ù Buongiorno, piacere di conoscerla',
                    type: 'greeting',
                    check: { type: 'charisma', difficulty: 12 },
                    outcomes: {
                        success: { 
                            relation: 5, 
                            reputation: 2,
                            response: `Che bella presentazione! ${npc.name}, molto lieto. Lei lavora qui?`
                        },
                        failure: { 
                            relation: 1,
                            response: 'Ehm... ciao. Piacere.'
                        }
                    }
                });
            }
        } else {
            options.push({
                id: 'greet_normal',
                text: 'üëã Ciao! Come va?',
                type: 'greeting',
                outcomes: { 
                    relation: 2,
                    response: rel >= 60 ? 'Tutto bene grazie! Tu come stai?' : 'Bene dai, la solita routine.'
                },
                followUp: [
                    {
                        id: 'share_day',
                        text: 'üí¨ Ti racconto la mia giornata',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: 'Dimmi tutto! Ti ascolto.'
                        },
                        followUp: [
                            {
                                id: 'good_news',
                                text: 'üéâ Ho avuto ottime notizie!',
                                type: 'positive',
                                outcomes: {
                                    relation: 4,
                                    response: 'Che bello! Sono felice per te! Raccontami!'
                                }
                            },
                            {
                                id: 'bad_news',
                                text: 'üòî √à stata una giornata difficile',
                                type: 'negative',
                                outcomes: {
                                    relation: 4,
                                    response: rel >= 50 ? 'Mi dispiace... vuoi parlarne? Sono qui per te.' : 'Oh, mi dispiace. Spero migliori presto.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'ask_their_day',
                        text: 'ü§î E tu come stai?',
                        type: 'friendly',
                        outcomes: {
                            relation: 3,
                            response: npc.mood === 'felice' ? 'Benissimo! √à una bella giornata!' : 'Insomma, potrebbe andare meglio ma dai.'
                        }
                    }
                ]
            });
        }
        
        // LAVORO
        if (canHire && !mem.jobOffered && !mem.jobRejected) {
            if (trust === 'sconosciuto' || trust === 'conoscente') {
                options.push({
                    id: 'job_inquiry_cold',
                    text: 'üíº State cercando personale?',
                    type: 'job',
                    outcomes: {
                        relation: 1,
                        response: 'Mmm, non so chi sei. Parliamo prima, poi vediamo.'
                    }
                });
            } else if (trust === 'amico') {
                options.push({
                    id: 'job_inquiry_friend',
                    text: 'üíº Sai di qualche opportunit√† di lavoro?',
                    type: 'job',
                    check: { type: 'charisma', difficulty: 14 },
                    outcomes: {
                        success: {
                            relation: 5,
                            event: 'job_offer',
                            response: 'Sai che c\'√®? Ho proprio bisogno di qualcuno di fidato!'
                        },
                        failure: {
                            relation: 2,
                            response: 'Al momento no, ma ti far√≤ sapere!'
                        }
                    }
                });
            } else if (trust === 'confidente' || trust === 'familiare') {
                options.push({
                    id: 'job_direct',
                    text: 'üíº Ho bisogno di un lavoro, puoi aiutarmi?',
                    type: 'job',
                    outcomes: {
                        relation: 3,
                        event: 'job_offer_guaranteed',
                        response: 'Certo! Per te c\'√® sempre posto. Quando puoi iniziare?'
                    }
                });
            }
        } else if (mem.jobOffered && game.player.job !== 'Disoccupato') {
            options.push({
                id: 'job_thankyou',
                text: 'üíº Grazie ancora per il lavoro!',
                type: 'gratitude',
                outcomes: {
                    relation: 3,
                    response: 'Figurati! Stai andando bene?'
                }
            });
        }
        
        // CONVERSAZIONE PERSONALE
        if (trust === 'sconosciuto') {
            options.push({
                id: 'personal_basic',
                text: 'üé≠ Cosa fai nella vita?',
                type: 'personal',
                outcomes: {
                    relation: 2,
                    memory: ['asked_about_life'],
                    response: `Faccio ${npc.job}. E tu?`
                },
                followUp: [
                    {
                        id: 'tell_job',
                        text: `üíº Io sono ${game.player.job}`,
                        type: 'personal',
                        outcomes: {
                            relation: 2,
                            response: 'Interessante! Ti piace?'
                        },
                        followUp: [
                            {
                                id: 'love_job',
                                text: 'üòä S√¨, mi piace molto!',
                                type: 'positive',
                                outcomes: {
                                    relation: 3,
                                    response: 'Che bello quando si fa quello che piace!'
                                }
                            },
                            {
                                id: 'hate_job',
                                text: 'üòï In realt√† non tanto...',
                                type: 'negative',
                                outcomes: {
                                    relation: 2,
                                    response: 'Capisco... spero tu possa trovare qualcosa di meglio.'
                                }
                            }
                        ]
                    },
                    {
                        id: 'ask_hobbies',
                        text: 'üé® Hai degli hobby?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: `Nel tempo libero mi piace ${['leggere', 'fare sport', 'guardare film', 'ascoltare musica', 'cucinare'][randInt(0, 4)]}.`
                        }
                    }
                ]
            });
        } else if (trust === 'conoscente' || trust === 'amico') {
            options.push({
                id: 'personal_deeper',
                text: 'üí≠ Come ti trovi qui in citt√†?',
                type: 'personal',
                outcomes: {
                    relation: 3,
                    memory: ['deeper_conversation'],
                    response: 'Beh, Eldoria ha i suoi pro e contro. Ma ci si abitua.'
                },
                followUp: [
                    {
                        id: 'ask_origins',
                        text: 'üè† Sei di qui originariamente?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: Math.random() > 0.5 ? 'S√¨, sono nato qui. Conosco ogni angolo!' : 'No, mi sono trasferito qualche anno fa. Ma ormai √® casa.'
                        }
                    },
                    {
                        id: 'ask_dreams',
                        text: '‚ú® Hai dei sogni nel cassetto?',
                        type: 'intimate',
                        check: { type: 'charisma', difficulty: 12 },
                        outcomes: {
                            success: {
                                relation: 5,
                                response: 'S√¨... vorrei davvero realizzare qualcosa di importante. Non so ancora cosa, ma lo sento.'
                            },
                            failure: {
                                relation: 1,
                                response: 'Ehm... chi non ne ha? Ma preferirei non parlarne ora.'
                            }
                        }
                    },
                    {
                        id: 'ask_family',
                        text: 'üë®‚Äçüë©‚Äçüëß Hai famiglia qui?',
                        type: 'personal',
                        outcomes: {
                            relation: 3,
                            response: Math.random() > 0.5 ? 'S√¨, vivono qui vicino. Ci vediamo spesso.' : 'No, la mia famiglia √® lontana. Mi manca a volte.'
                        }
                    }
                ]
            });
            
            if (!mem.sharedSecrets && game.player.skills.charisma >= 30) {
                options.push({
                    id: 'share_secret',
                    text: 'ü§´ Posso confidarti una cosa?',
                    type: 'intimate',
                    check: { type: 'charisma', difficulty: 15 },
                    outcomes: {
                        success: {
                            relation: 8,
                            memory: ['shared_secret'],
                            trustBoost: true,
                            response: 'Certo, dimmi tutto. Sai che puoi fidarti di me.'
                        },
                        failure: {
                            relation: -2,
                            response: 'Ehm... forse √® un po\' presto per queste cose...'
                        }
                    },
                    followUp: [
                        {
                            id: 'share_problem',
                            text: 'üò∞ Ho un problema serio...',
                            type: 'intimate',
                            outcomes: {
                                relation: 6,
                                response: 'Ascolta, qualunque cosa sia, possiamo affrontarla insieme. Parlami.'
                            }
                        },
                        {
                            id: 'share_hope',
                            text: 'üåü Ho un sogno che voglio realizzare',
                            type: 'intimate',
                            outcomes: {
                                relation: 6,
                                response: 'Fantastico! Raccontami tutto, voglio sapere!'
                            }
                        }
                    ]
                });
            }
        }
        
        // USCIRE INSIEME
        if (rel >= 40 && mem.conversations >= 3) {
            options.push({
                id: 'invite_coffee',
                text: '‚òï Ti va di prendere un caff√®?',
                type: 'social',
                check: { type: 'charisma', difficulty: rel >= 60 ? 10 : 14 },
                outcomes: {
                    success: {
                        relation: 5,
                        happiness: 10,
                        event: 'coffee_date',
                        response: 'Volentieri! Quando sei libero?'
                    },
                    failure: {
                        relation: 0,
                        response: 'Mi piacerebbe ma sono impegnato. Un\'altra volta!'
                    }
                },
                followUp: [
                    {
                        id: 'suggest_now',
                        text: '‚è∞ Che ne dici di ora?',
                        type: 'social',
                        outcomes: {
                            relation: 4,
                            response: 'Perfetto! Conosco un bel posto qui vicino.',
                            event: 'coffee_immediate'
                        }
                    },
                    {
                        id: 'suggest_later',
                        text: 'üìÖ Magari domani?',
                        type: 'social',
                        outcomes: {
                            relation: 3,
                            response: 'Va bene! Ci sentiamo domani allora.',
                            event: 'coffee_planned'
                        }
                    },
                    {
                        id: 'my_treat',
                        text: 'üí∞ Offro io!',
                        type: 'generous',
                        check: { type: 'charisma', difficulty: 10 },
                        outcomes: {
                            success: {
                                relation: 6,
                                response: 'Oh, che gentile! Allora accetto sicuramente!',
                                event: 'coffee_treat'
                            },
                            failure: {
                                relation: 3,
                                response: 'Non c\'√® bisogno, ma grazie dell\'offerta!'
                            }
                        }
                    }
                ]
            });
        }
        
        if (rel >= 70 && !mem.metFamily) {
            options.push({
                id: 'meet_family',
                text: 'üë®‚Äçüë©‚Äçüëß Mi piacerebbe conoscere la tua famiglia',
                type: 'deep_social',
                check: { type: 'charisma', difficulty: 16 },
                outcomes: {
                    success: {
                        relation: 10,
                        event: 'family_meeting',
                        memory: ['met_family'],
                        response: 'Wow, mi fa davvero piacere! Organizzo una cena!'
                    },
                    failure: {
                        relation: 2,
                        response: '√à un po\' presto, ma apprezzo l\'interesse!'
                    }
                }
            });
        }
        
        // CONSIGLI
        options.push({
            id: 'advice_money',
            text: 'üí∞ Consigli per guadagnare?',
            type: 'advice',
            outcomes: {
                relation: 2,
                memory: ['asked_advice'],
                response: 'Beh, devi essere costante. Lavora duro e risparmia.'
            },
            followUp: [
                {
                    id: 'ask_invest',
                    text: 'üìà E gli investimenti?',
                    type: 'advice',
                    outcomes: {
                        relation: 2,
                        response: 'Le azioni sono rischiose ma possono dare buoni ritorni. Studia bene prima!'
                    }
                },
                {
                    id: 'ask_savings',
                    text: 'üè¶ Come risparmiare meglio?',
                    type: 'advice',
                    outcomes: {
                        relation: 2,
                        response: 'Metti da parte almeno il 20% di quello che guadagni. E tieni i soldi in banca, non tutti in contanti.'
                    }
                },
                {
                    id: 'ask_business',
                    text: 'üíº Meglio dipendente o mettersi in proprio?',
                    type: 'advice',
                    outcomes: {
                        relation: 3,
                        response: 'Dipende. Il lavoro dipendente √® sicuro, ma in proprio hai pi√π libert√†. Serve coraggio!'
                    }
                }
            ]
        });
        
        if (rel >= 30) {
            options.push({
                id: 'advice_life',
                text: 'üß≠ Come affronti le difficolt√†?',
                type: 'advice_deep',
                outcomes: {
                    relation: 3,
                    response: 'Non √® mai facile. Ma bisogna andare avanti, un passo alla volta.'
                },
                followUp: [
                    {
                        id: 'ask_motivation',
                        text: 'üí™ Come trovi la motivazione?',
                        type: 'advice_deep',
                        outcomes: {
                            relation: 4,
                            response: 'Penso ai miei obiettivi. E alle persone che amo. Loro mi danno forza.'
                        }
                    },
                    {
                        id: 'ask_failure',
                        text: 'üòî E quando fallisci?',
                        type: 'advice_deep',
                        outcomes: {
                            relation: 4,
                            response: 'I fallimenti fanno parte del percorso. L\'importante √® imparare e non arrendersi.'
                        }
                    },
                    {
                        id: 'ask_happiness',
                        text: 'üòä Cos\'√® per te la felicit√†?',
                        type: 'philosophical',
                        check: { type: 'intellect', difficulty: 12 },
                        outcomes: {
                            success: {
                                relation: 6,
                                response: 'Bella domanda... Per me √® fare quello che ami con le persone che ami. Semplice no?'
                            },
                            failure: {
                                relation: 2,
                                response: 'Domanda difficile... non saprei dirti.'
                            }
                        }
                    }
                ]
            });
        }
        
        // AFFARI
        if (game.player.money >= 5000 && rel >= 50 && game.player.skills.intellect >= 30) {
            options.push({
                id: 'business_proposal',
                text: 'üíº Ho un\'idea imprenditoriale...',
                type: 'business',
                check: { type: 'intelligence', difficulty: 15 },
                outcomes: {
                    success: {
                        relation: 6,
                        event: 'business_opportunity',
                        response: 'Interessante! Parliamone con calma.'
                    },
                    failure: {
                        relation: -1,
                        response: 'Mmm, non mi convince. Ripensaci.'
                    }
                }
            });
        }
        
        // INFORMAZIONI
        options.push({
            id: 'city_info',
            text: 'üìç Cosa mi consigli di visitare?',
            type: 'info',
            outcomes: { 
                relation: 1,
                response: `Dovresti vedere ${['il Business District', 'il Centro Storico', 'il Parco Centrale', 'il Porto'][randInt(0, 3)]}! √à bellissimo!`
            },
            followUp: [
                {
                    id: 'ask_nightlife',
                    text: 'üåÉ E per la vita notturna?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'I migliori locali sono nel Centro Storico e nel Porto. Si balla fino all\'alba!'
                    }
                },
                {
                    id: 'ask_restaurants',
                    text: 'üçΩÔ∏è Ristoranti da provare?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'Ce ne sono tantissimi! Dipende cosa ti piace. Italiana, cinese, indiana...'
                    },
                    followUp: [
                        {
                            id: 'italian_food',
                            text: 'üçù Italiana sicuramente!',
                            type: 'info',
                            outcomes: {
                                relation: 2,
                                response: 'Allora devi provare "La Tavola Calda" nel Centro Storico. Fantastico!'
                            }
                        },
                        {
                            id: 'exotic_food',
                            text: 'üåç Mi piace provare cucine esotiche',
                            type: 'info',
                            outcomes: {
                                relation: 2,
                                response: 'C\'√® un ristorante cinese ottimo nel Business District. E uno indiano vicino al Porto!'
                            }
                        }
                    ]
                },
                {
                    id: 'ask_safety',
                    text: 'üõ°Ô∏è Quali zone evitare?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'La Periferia di notte pu√≤ essere pericolosa. Meglio stare nel centro e nelle zone residenziali.'
                    }
                },
                {
                    id: 'ask_parks',
                    text: 'üå≥ Parchi e natura?',
                    type: 'info',
                    outcomes: {
                        relation: 2,
                        response: 'Il Parco Centrale √® magnifico! Perfetto per correre o rilassarsi. E c\'√® anche il giardino botanico!'
                    }
                }
            ]
        });
        
        // CONGEDO - Opzioni diverse in base alla relazione
        if (rel >= 70) {
            // Amici stretti
            options.push({
                id: 'leave_friend',
                text: 'ü§ó √à stato bello parlare! Ci sentiamo presto!',
                type: 'leave',
                outcomes: {
                    relation: 2,
                    response: 'Sempre un piacere! Chiamami quando vuoi!'
                }
            });
        } else if (rel >= 40) {
            // Conoscenti amichevoli
            options.push({
                id: 'leave_friendly',
                text: 'üëã Devo andare, ci vediamo presto!',
                type: 'leave',
                outcomes: {
                    relation: 1,
                    response: 'Certo, a presto! Buona giornata!'
                }
            });
        } else {
            // Sconosciuti/formale
            options.push({
                id: 'leave_polite',
                text: 'üôè √à stato un piacere conoscerla. Arrivederci',
                type: 'leave',
                outcomes: {
                    relation: 1,
                    response: 'Arrivederci. Buona giornata!'
                }
            });
        }
        
        // Opzione alternativa pi√π rapida
        options.push({
            id: 'leave_quick',
            text: '‚è∞ Scusa, ho fretta. Ciao!',
            type: 'leave',
            outcomes: {
                relation: rel >= 60 ? 0 : -1,
                response: rel >= 60 ? 'Vai vai! Ci sentiamo!' : 'Oh... ok, ciao.'
            }
        });
        
        return options;
    }

    // Esegui scelta dialogo
    function executeDialogueChoice(npc, option) {
        initNPCMemory(npc);
        const mem = npc.memory;
        const outcomes = option.outcomes;
        let result = {
            response: '',
            relationChange: 0,
            events: [],
            checkResult: null
        };
        
        mem.conversations++;
        mem.lastInteraction = game.time.day;
        
        if (option.check) {
            const checkResult = makeCheck(option.check.type, option.check.difficulty);
            result.checkResult = checkResult;
            
            const outcome = checkResult.success ? outcomes.success : outcomes.failure;
            result.relationChange = outcome.relation || 0;
            result.response = generateResponse(npc, option, outcome, checkResult);
            
            if (outcome.event) result.events.push(outcome.event);
            if (outcome.memory) {
                outcome.memory.forEach(m => {
                    if (!mem.topics.includes(m)) mem.topics.push(m);
                });
            }
            if (outcome.trustBoost) mem.sharedSecrets = true;
            if (outcome.happiness) {
                game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + outcome.happiness);
            }
            
            // NUOVI CAMPI PER COLLOQUI
            if (outcome.jobOfferBoost) {
                mem.jobOfferBoost = (mem.jobOfferBoost || 0) + outcome.jobOfferBoost;
            }
            if (outcome.salaryBonus) {
                mem.salaryBonus = (mem.salaryBonus || 0) + outcome.salaryBonus;
            }
            if (outcome.jobOfferGuaranteed) {
                mem.jobOfferGuaranteed = true;
            }
            if (outcome.performance) {
                if (game.workData) {
                    game.workData.performance = Math.min(100, (game.workData.performance || 50) + outcome.performance);
                }
            }
            if (outcome.bonus) {
                game.player.money = (game.player.money || 0) + outcome.bonus;
                showNotification(`üí∞ Bonus: +‚Ç¨${outcome.bonus}!`, 2000);
            }
        } else {
            result.relationChange = outcomes.relation || 0;
            result.response = generateResponse(npc, option, outcomes);
            
            if (outcomes.event) result.events.push(outcomes.event);
            if (outcomes.memory) {
                outcomes.memory.forEach(m => {
                    if (!mem.topics.includes(m)) mem.topics.push(m);
                });
            }
            
            // NUOVI CAMPI anche senza check
            if (outcomes.jobOfferBoost) {
                mem.jobOfferBoost = (mem.jobOfferBoost || 0) + outcomes.jobOfferBoost;
            }
            if (outcomes.salaryBonus) {
                mem.salaryBonus = (mem.salaryBonus || 0) + outcomes.salaryBonus;
            }
            if (outcomes.jobOfferGuaranteed) {
                mem.jobOfferGuaranteed = true;
            }
        }
        
        npc.relation = Math.max(0, Math.min(100, npc.relation + result.relationChange));
        mem.relationHistory.push(npc.relation);
        
        if (result.relationChange > 5) {
            mem.mood = 'felice';
        } else if (result.relationChange < -5) {
            mem.mood = 'arrabbiato';
        } else if (result.relationChange > 0) {
            mem.mood = 'contento';
        }
        
        if (option.type === 'gratitude') mem.compliments++;
        
        // Se √® un'opzione di chiusura, aggiungi evento per chiudere il dialogo
        if (option.type === 'leave') {
            result.events.push('conversation_end');
        }
        
        // CONTROLLO COLLOQUIO: NPC chiude automaticamente in base all'andamento
        if (game.currentInterview && option.type === 'interview_answer') {
            const questionCount = mem.interviewQuestionCount || 0;
            const job = game.currentInterview.job;
            
            // Calcola soglia minima per questo lavoro
            let minRelation = 35;
            const baseSalary = job.salary || 100;
            if (baseSalary < 70) minRelation = 35;
            else if (baseSalary < 150) minRelation = 50;
            else if (baseSalary < 280) minRelation = 65;
            else minRelation = 80;
            
            // ‚úÖ CHIUSURA POSITIVA: NPC entusiasta se relazione molto alta dopo 3+ domande
            if (questionCount >= 3 && npc.relation >= (minRelation + 20)) {
                const positiveClosings = [
                    'üòä "Complimenti! √à esattamente il profilo che cercavamo. Posso dirle che √® praticamente assunto! La contatteremo domani con l\'offerta formale."',
                    'üéâ "Wow, ottime risposte! Raramente incontro candidati cos√¨ preparati. Direi che abbiamo trovato la persona giusta. Le far√≤ avere l\'offerta entro 24 ore!"',
                    'üëè "Eccellente! Ha tutte le qualifiche che cerchiamo e anche di pi√π. Posso anticiparle che la posizione √® sua. A presto!"',
                    'üåü "Fantastico colloquio! √à chiaro che lei √® la persona perfetta per questa posizione. Consideri di essere gi√† parte del team!"'
                ];
                result.response += '\n\n' + positiveClosings[Math.floor(Math.random() * positiveClosings.length)];
                result.events.push('interview_end');
                mem.jobOfferGuaranteed = true; // Assunzione garantita!
                mem.interviewClosedByNPC = true;
            }
            // üòä CHIUSURA SODDISFATTA: Se sopra soglia e 4+ domande
            else if (questionCount >= 4 && npc.relation >= minRelation) {
                result.response += '\n\nüòä "Bene, ho visto abbastanza. Lei ha un buon profilo. La ricontatteremo entro 48 ore con la nostra decisione. Grazie per il suo tempo!"';
                result.events.push('interview_end');
                mem.interviewClosedByNPC = true;
            }
            // ‚ùå CHIUSURA NEGATIVA: relazione troppo bassa dopo 3+ domande
            else if (questionCount >= 3 && npc.relation < (minRelation - 15)) {
                result.response += '\n\nüò§ "Senta, credo che questo non sia il posto giusto per lei. Le faremo sapere. Arrivederci."';
                result.events.push('interview_end');
                mem.interviewFailedByNPC = true;
            }
            // ‚è∞ CHIUSURA NEUTRA: colloquio troppo lungo (8+ domande)
            else if (questionCount >= 8) {
                result.response += '\n\nÔøΩ "Direi che ho tutte le informazioni necessarie. La ricontatteremo presto. Grazie per essere venuto."';
                result.events.push('interview_end');
                mem.interviewClosedByNPC = true;
            }
            // üí• CHIUSURA IMMEDIATA: gaffe grave (risposta che fa perdere 10+ punti)
            else if (result.relationChange <= -10) {
                result.response += '\n\nüò¨ "Mi dispiace ma questa risposta dimostra che non √® adatto alla posizione. Buona giornata."';
                result.events.push('interview_end');
                mem.interviewFailedByNPC = true;
            }
        }
        
        updateTrustLevel(npc);
        
        return result;
    }

    // Genera risposta contestuale
    function generateResponse(npc, option, outcomes, checkResult = null) {
        const mem = npc.memory;
        const personality = npc.personality || 'amichevole';
        
        if (outcomes.response) return outcomes.response;
        
        const responses = {
            'greeting': {
                'amichevole': [
                    `Ciao ${game.player.name}! Che piacere vederti!`,
                    `Ehi! Come va la vita?`
                ],
                'socievole': [
                    `${game.player.name}! Finalmente! Come stai?!`,
                    `Oh wow, ciao! Raccontami tutto!`
                ],
                'introverso': [
                    `Oh, ciao ${game.player.name}.`,
                    `Salve.`
                ],
                'professionale': [
                    `Buongiorno ${game.player.name}. Come posso aiutarla?`,
                    `Salve. √à un piacere rivederla.`
                ],
                'creativa': [
                    `Ciao! Sai, stavo pensando proprio a te...`,
                    `Oh ciao! Ho avuto un'idea fantastica!`
                ],
                'paziente': [
                    `Ciao ${game.player.name}. Come ti senti oggi?`,
                    `Salve. √à bello vederti.`
                ]
            },
            'personal': {
                'amichevole': [`Beh, lavoro come ${npc.job}. Non √® male! Tu cosa fai?`],
                'socievole': [`Faccio il/la ${npc.job}! √à fantastico! E tu?`],
                'introverso': [`Sono ${npc.job}. Niente di speciale.`],
                'professionale': [`Mi occupo di ${npc.job}. √à la mia professione.`],
                'creativa': [`Lavoro come ${npc.job}, ma sogno sempre qualcosa di pi√π grande!`],
                'paziente': [`Faccio il/la ${npc.job}. Mi piace aiutare le persone.`]
            },
            'advice': {
                'all': [
                    `Per guadagnare devi essere costante. Lavora ogni giorno e risparmia.`,
                    `Investi in te stesso. Formazione e abilit√† pagano sempre.`,
                    `Cerca opportunit√†, non aspettare che arrivino da sole.`
                ]
            },
            'info': {
                'all': [
                    `Ti consiglio il ${['Business District', 'Centro Storico', 'Parco Centrale'][randInt(0, 2)]}. √à bellissimo!`,
                    `Dovresti visitare il ${['Tech Hub', 'Quartiere Culturale', 'Porto'][randInt(0, 2)]}!`
                ]
            }
        };
        
        let response = '';
        if (checkResult) {
            if (checkResult.success) {
                response = checkResult.margin >= 5 ? '[Successo Critico!] ' : '[Successo] ';
            } else {
                response = '[Fallimento] ';
            }
        }
        
        if (responses[option.type]) {
            const typeResponses = responses[option.type][personality] || responses[option.type]['all'];
            if (typeResponses) {
                response += typeResponses[randInt(0, typeResponses.length - 1)];
            } else {
                response += 'Interessante...';
            }
        } else {
            response += `${npc.name} riflette un momento...`;
        }
        
        return response;
    }

    // ============================================
    // SISTEMA LAVORATIVO COMPLETO
    // ============================================
    
    // Inizia giornata lavorativa
    function startWorkDay() {
        if (!game.player.job || game.player.job === 'Disoccupato') {
            showNotification('‚ùå Non hai un lavoro!', 2000);
            return;
        }
        
        if (!game.workData || !game.workData.currentJob) {
            showNotification('‚ùå Dati lavoro non trovati!', 2000);
            return;
        }
        
        const job = game.workData.currentJob;
        const currentHour = game.time.hour;
        
        // Verifica orario
        if (currentHour < job.hours.start || currentHour >= job.hours.end) {
            showNotification(`‚è∞ Puoi lavorare solo tra le ${job.hours.start}:00 e ${job.hours.end}:00`, 2000);
            return;
        }
        
        // Verifica energia
        if (game.player.stats.energy < 30) {
            showNotification('üò¥ Troppo stanco! Riposa prima di lavorare.', 2000);
            return;
        }
        
        // Inizializza performance
        if (!game.workData.performance) {
            game.workData.performance = 50;
        }
        
        // Task casuale
        const tasks = job.tasks || [
            'Completare il progetto assegnato',
            'Rispondere alle email urgenti',
            'Preparare il report giornaliero',
            'Gestire le richieste dei clienti',
            'Organizzare la documentazione',
            'Partecipare al meeting di team',
            'Risolvere i problemi tecnici',
            'Coordinare con gli altri reparti'
        ];
        
        game.currentWorkTask = tasks[randInt(0, tasks.length - 1)];
        
        // Trova o crea manager
        let manager = game.npcs.find(n => n.name === job.manager);
        if (!manager) {
            manager = {
                id: 'manager_' + Date.now(),
                name: job.manager || 'Manager',
                job: 'Manager',
                personality: 'professionale',
                relation: 50,
                memory: {}
            };
            game.npcs.push(manager);
        }
        
        // Apri dialogo
        showNotification(`üè¢ Giornata lavorativa iniziata - ${job.hours.start}:00`, 2000);
        setTimeout(() => {
            openDialogue(manager.id);
        }, 500);
    }
    
    // Completa giornata lavorativa
    function completeWorkDay() {
        if (!game.workData || !game.workData.currentJob) return;
        
        const job = game.workData.currentJob;
        const salary = game.player.jobSalary || job.salary || 100;
        const performance = game.workData.performance || 50;
        
        // Calcola bonus
        const performanceBonus = Math.floor(salary * (performance / 100 - 0.5));
        const totalPay = Math.max(salary + performanceBonus, Math.floor(salary * 0.7));
        
        // Paga
        game.player.money += totalPay;
        game.player.totalEarned = (game.player.totalEarned || 0) + totalPay;
        
        // Reputazione
        if (performance >= 70) {
            game.player.rep = Math.min(100, (game.player.rep || 0) + 3);
        } else if (performance >= 50) {
            game.player.rep = Math.min(100, (game.player.rep || 0) + 2);
        } else {
            game.player.rep = Math.max(0, (game.player.rep || 0) - 1);
        }
        
        // Stats lavoro
        game.workData.todayWorked = true;
        game.workData.tasksCompleted = (game.workData.tasksCompleted || 0) + 1;
        game.workData.totalEarned = (game.workData.totalEarned || 0) + totalPay;
        
        // CONSUMA RISORSE
        const workHours = job.hours.end - job.hours.start;
        
        // Energia: -10 per ora
        game.player.stats.energy = Math.max(0, (game.player.stats.energy || 100) - (workHours * 10));
        
        // Fame: -8 per ora  
        game.player.stats.hunger = Math.max(0, (game.player.stats.hunger || 100) - (workHours * 8));
        
        // Morale
        if (performanceBonus > 0) {
            game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + 10);
        } else if (performance < 40) {
            game.player.stats.morale = Math.max(0, (game.player.stats.morale || 50) - 5);
        }
        
        // PASSA TEMPO
        game.time.hour = job.hours.end;
        if (game.time.hour >= 24) {
            game.time.hour -= 24;
            game.time.day++;
        }
        
        // Reset
        game.currentWorkTask = null;
        game.workData.performance = 50;
        
        // Notifica
        const msg = performanceBonus > 0 
            ? `üíº Ottimo lavoro! ‚Ç¨${totalPay} (bonus: ‚Ç¨${performanceBonus})` 
            : performance < 40
            ? `üíº Completato. ‚Ç¨${totalPay} (performance bassa)`
            : `üíº Completato. ‚Ç¨${totalPay}`;
        
        showNotification(msg, 3000);
        
        setTimeout(() => {
            showNotification(`üò¥ Energia: -${workHours * 10} | üçî Fame: -${workHours * 8}`, 2500);
        }, 1000);
        
        updateUI();
        closeDialogue();
    }

    // Eventi speciali
    function handleDialogueEvent(eventType, npc) {
        switch(eventType) {
            case 'job_offer':
            case 'job_offer_guaranteed':
                offerJobDialogue(npc);
                break;
            case 'interview_end':
                handleInterviewEnd(npc);
                break;
            case 'conversation_end':
                // Chiude il dialogo dopo la risposta NPC
                setTimeout(() => closeDialogue(), 1500);
                break;
            case 'complete_work_day':
                completeWorkDay();
                break;
            case 'coffee_date':
                scheduleCoffeeDate(npc);
                break;
            case 'family_meeting':
                scheduleFamilyMeeting(npc);
                break;
            case 'business_opportunity':
                presentBusinessOffer(npc);
                break;
        }
    }
    
    function handleInterviewEnd(npc) {
        const interview = game.currentInterview;
        if (!interview) return;
        
        const job = interview.job;
        const relation = npc.relation;
        const jobOfferBoost = npc.memory.jobOfferBoost || 0;
        const salaryBonus = npc.memory.salaryBonus || 0;
        const jobOfferGuaranteed = npc.memory.jobOfferGuaranteed || false;
        
        // Calcola se viene assunto - SISTEMA REALISTICO
        let hired = false;
        let baseSalary = job.salary || 100;
        let finalSalary = baseSalary;
        
        // Soglia minima basata su stipendio/livello lavoro
        // Entry level (‚Ç¨45-70): soglia 35-45
        // Mid level (‚Ç¨70-150): soglia 45-60
        // Senior (‚Ç¨150-280): soglia 60-75
        // Executive (‚Ç¨280+): soglia 75-85
        let minRelation = 35;
        if (baseSalary < 70) {
            minRelation = 35;  // Entry level - pi√π facile
        } else if (baseSalary < 150) {
            minRelation = 50;  // Mid level
        } else if (baseSalary < 280) {
            minRelation = 65;  // Senior
        } else {
            minRelation = 80;  // Executive - molto difficile
        }
        
        // Applica boost
        minRelation -= jobOfferBoost;
        
        if (jobOfferGuaranteed) {
            hired = true;
            finalSalary = Math.floor(baseSalary * (1 + salaryBonus / 100));
        } else if (relation >= minRelation) {
            hired = true;
            if (salaryBonus > 0) {
                finalSalary = Math.floor(baseSalary * (1 + salaryBonus / 100));
            }
        }
        
        setTimeout(() => {
            closeDialogue();
            
            setTimeout(() => {
                if (hired) {
                    if (confirm(`üéâ ASSUNTO! ${npc.name} ti offre il lavoro di ${job.name} con stipendio ‚Ç¨${finalSalary}/giorno.\nOrario: ${job.hours.start}:00-${job.hours.end}:00, ${job.daysPerWeek} giorni/settimana.\nAccetti?`)) {
                        game.player.job = job.name;
                        game.player.jobSalary = finalSalary;
                        game.workData.currentJob = job;
                        game.workData.performance = 75; // Start with decent performance
                        game.workData.workHours = job.hours;
                        game.workData.daysPerWeek = job.daysPerWeek;
                        game.workData.manager = job.manager;
                        npc.memory.jobOffered = true;
                        
                        // Initialize career path
                        game.workData.careerPath = JOB_TO_CAREER[job.name] || 'business';
                        game.workData.careerLevel = 0; // Entry level
                        game.workData.daysWorked = 0;
                        game.workData.managerRelation = 50; // Neutral starting relationship
                        game.workData.warnings = 0;
                        game.workData.promotionProgress = 0;
                        game.workData.lastPerformanceReview = 0;
                        
                        // Assegna location lavoro
                        assignWorkLocation(job);
                        
                        // Update company employee count
                        if (game.companies[job.locationId]) {
                            game.companies[job.locationId].employees++;
                        }
                        
                        // Pulisci interview
                        game.currentInterview = null;
                        npc.memory.jobInterviewStarted = false;
                        
                        showNotification(`üéâ Congratulazioni! Inizi come ${job.name}!`, 3000);
                        updateUI();
                    } else {
                        npc.memory.jobRejected = true;
                        npc.relation = Math.max(0, npc.relation - 10);
                        game.currentInterview = null;
                        npc.memory.jobInterviewStarted = false;
                        showNotification(`${npc.name} √® deluso. -10 Relazione`, 2000);
                    }
                } else {
                    game.currentInterview = null;
                    npc.memory.jobInterviewStarted = false;
                    npc.memory.jobRejected = true;
                    npc.relation = Math.max(0, npc.relation - 5); // Penalit√† per colloquio fallito
                    
                    const reasons = [
                        'profilo non in linea con le nostre esigenze',
                        'competenze insufficienti per la posizione',
                        'altri candidati pi√π qualificati',
                        'mancanza di esperienza richiesta',
                        'preparazione inadeguata'
                    ];
                    const reason = reasons[randInt(0, reasons.length - 1)];
                    
                    showNotification(`‚ùå COLLOQUIO FALLITO!\n${npc.name}: "Spiacente, ${reason}."\nRelazione: ${relation}/${minRelation} richiesta`, 4000);
                }
            }, 500);
        }, 800);
    }

    function offerJobDialogue(npc) {
        // Offri lavori entry-level o intermediate dalla lista principale
        const availableJobs = game.jobs.filter(j => j.reqRep <= game.player.reputation);
        
        if (availableJobs.length === 0) {
            showNotification(`${npc.name} non ha posizioni disponibili per te al momento.`, 2000);
            return;
        }
        
        const job = availableJobs[randInt(0, availableJobs.length - 1)];
        
        setTimeout(() => {
            if (confirm(`${npc.name} ti offre il lavoro di ${job.name} con stipendio ‚Ç¨${job.salary}/giorno.\nOrario: ${job.hours.start}:00-${job.hours.end}:00, ${job.daysPerWeek} giorni/settimana.\nAccetti?`)) {
                game.player.job = job.name;
                game.player.jobSalary = job.salary;
                npc.memory.jobOffered = true;
                
                // Initialize career path
                game.workData.careerPath = JOB_TO_CAREER[job.name] || 'business';
                game.workData.careerLevel = 0;
                game.workData.daysWorked = 0;
                game.workData.managerRelation = 50;
                game.workData.warnings = 0;
                game.workData.promotionProgress = 0;
                game.workData.lastPerformanceReview = 0;
                game.workData.performance = 75;
                game.workData.workHours = job.hours;
                game.workData.daysPerWeek = job.daysPerWeek;
                game.workData.manager = job.manager;
                
                // Assegna location lavoro reale
                assignWorkLocation(job);
                
                showNotification(`üéâ Congratulazioni! Sei stato assunto come ${job.name}!`, 3000);
                updateUI();
            } else {
                npc.memory.jobRejected = true;
                npc.relation = Math.max(0, npc.relation - 10);
                showNotification(`${npc.name} √® deluso dal tuo rifiuto. -10 Relazione`, 2000);
            }
        }, 500);
    }

    // Assegna posizione al lavoro sulla mappa
    function assignWorkLocation(job) {
        console.log('üè¢ assignWorkLocation called with:', job);
        
        if (!job || !job.locationId) {
            console.error('‚ùå Job missing locationId:', job);
            return;
        }
        
        // Trova la location reale in CITY_LOCATIONS
        let workLocation = null;
        let neighborhood = null;
        
        console.log('üîç Searching for location:', job.locationId);
        
        for (let hood in CITY_LOCATIONS) {
            const found = CITY_LOCATIONS[hood].find(loc => loc.id === job.locationId);
            if (found) {
                workLocation = found;
                neighborhood = hood;
                console.log(`‚úÖ Found location in ${hood}:`, found);
                break;
            }
        }
        
        if (!workLocation) {
            console.error('‚ùå Location not found for job:', job.locationId);
            return;
        }
        
        // Usa le coordinate reali della location aziendale
        const x = workLocation.x;
        const y = workLocation.y;
        
        // Usa il nome dell'azienda dalla location
        const placeName = workLocation.name;
        const address = workLocation.street;
        
        // Salva nel workData
        game.workData.workLocation = {
            neighborhood: neighborhood,
            coordinates: { x, y },
            address: address,
            locationId: job.locationId
        };
        game.workData.workPlaceName = placeName;
        
        console.log(`‚úÖ Lavoro assegnato: ${placeName} @ ${address} (${neighborhood}) [${x}%, ${y}%]`);
        console.log('üì¶ game.workData.workLocation:', game.workData.workLocation);
        console.log('üì¶ game.workData.workPlaceName:', game.workData.workPlaceName);
        
        // Salva subito nel localStorage per persistenza
        saveGame();
    }

    function scheduleCoffeeDate(npc) {
        showNotification(`‚òï Hai fissato un caff√® con ${npc.name}!`, 2000);
        game.player.stats.morale = Math.min(100, (game.player.stats.morale || 50) + 10);
        passTime(2);
    }

    function scheduleFamilyMeeting(npc) {
        showNotification(`üë®‚Äçüë©‚Äçüëß ${npc.name} ti presenter√† alla sua famiglia! +15 Relazione`, 3000);
        npc.relation = Math.min(100, npc.relation + 15);
        npc.memory.metFamily = true;
    }

    function presentBusinessOffer(npc) {
        const investment = randInt(5000, 15000);
        const dailyReturn = Math.floor(investment * 0.015);
        
        setTimeout(() => {
            if (game.player.money >= investment) {
                if (confirm(`${npc.name} propone un investimento di ‚Ç¨${investment} con ritorno di ‚Ç¨${dailyReturn}/giorno. Accetti?`)) {
                    game.player.money -= investment;
                    game.player.passiveIncome = (game.player.passiveIncome || 0) + dailyReturn;
                    showNotification(`üíº Investimento completato! Guadagnerai ‚Ç¨${dailyReturn}/giorno`, 3000);
                    updateUI();
                }
            } else {
                showNotification(`‚ùå Non hai abbastanza soldi (servono ‚Ç¨${investment})`, 2000);
            }
        }, 500);
    }

    // ========================================
    // UI DIALOGHI
    // ========================================

    function openDialogue(npcId) {
        try {
            const npc = game.npcs.find(n => n.id === npcId);
            if (!npc) {
                console.error('NPC not found:', npcId);
                return;
            }
            
            currentDialogueNPC = npc;
            initNPCMemory(npc);
            
            // Safely set elements
            const avatarEl = document.getElementById('dialogueAvatar');
            const nameEl = document.getElementById('dialogueName');
            const jobEl = document.getElementById('dialogueJob');
            const relEl = document.getElementById('dialogueRelation');
            const convEl = document.getElementById('dialogueConversations');
            const historyEl = document.getElementById('dialogueHistory');
            const modalEl = document.getElementById('dialogueModal');
            
            if (!avatarEl || !nameEl || !jobEl || !relEl || !convEl || !historyEl || !modalEl) {
                console.error('Dialogue modal elements not found in DOM');
                alert('Errore: Elementi del dialogo non trovati. Ricarica la pagina.');
                return;
            }
            
            avatarEl.textContent = getJobIcon(npc.job);
            nameEl.textContent = npc.name;
            jobEl.textContent = `${npc.job} ‚Ä¢ ${npc.personality || 'amichevole'}`;
            relEl.textContent = npc.relation;
            convEl.textContent = npc.memory.conversations;
            
            updateTrustDisplay(npc);
            historyEl.innerHTML = '';
            modalEl.classList.add('active');
            
            if (npc.memory.conversations === 0) {
                addDialogueBubble('system', `Incontri ${npc.name}...`);
                setTimeout(() => {
                    addDialogueBubble('npc', getInitialGreeting(npc));
                    setTimeout(() => renderDialogueChoices(npc), 500);
                }, 800);
            } else {
                addDialogueBubble('npc', getReturningGreeting(npc));
                setTimeout(() => renderDialogueChoices(npc), 500);
            }
        } catch (error) {
            console.error('Error in openDialogue:', error);
            alert('Errore nell\'apertura del dialogo: ' + error.message);
        }
    }

    function closeDialogue() {
        const modalEl = document.getElementById('dialogueModal');
        if (modalEl) {
            modalEl.classList.remove('active');
        }
        currentDialogueNPC = null;
        if (typeof updateUI === 'function') {
            updateUI();
        }
    }

    function updateTrustDisplay(npc) {
        const trustLevel = npc.memory.trustLevel;
        const trustIcons = {
            'sconosciuto': '‚ùì',
            'conoscente': 'ü§ù',
            'amico': 'üòä',
            'confidente': 'üíö',
            'familiare': 'üíõ'
        };
        
        const trustNames = {
            'sconosciuto': 'Sconosciuto',
            'conoscente': 'Conoscente',
            'amico': 'Amico',
            'confidente': 'Confidente',
            'familiare': 'Familiare'
        };
        
        document.getElementById('trustIcon').textContent = trustIcons[trustLevel];
        const trustEl = document.getElementById('trustLevel');
        trustEl.textContent = trustNames[trustLevel];
        trustEl.className = `trust-level-${trustLevel}`;
    }

    function getInitialGreeting(npc) {
        const greetings = {
            'amichevole': `Ciao! Sono ${npc.name}. Piacere di conoscerti!`,
            'socievole': `Ehi! Ciao! Sono ${npc.name}! Come ti chiami?`,
            'introverso': `...Ciao. ${npc.name}.`,
            'creativa': `Oh, ciao! Sono ${npc.name}. Stavo proprio pensando a qualcosa...`,
            'professionale': `Buongiorno. Sono ${npc.name}, ${npc.job}.`,
            'paziente': `Salve. ${npc.name}, piacere. Come stai?`
        };
        return greetings[npc.personality] || greetings['amichevole'];
    }

    function getReturningGreeting(npc) {
        const trust = npc.memory.trustLevel;
        if (trust === 'familiare') return `${game.player.name}! Che bello rivederti!`;
        if (trust === 'confidente') return `Ciao ${game.player.name}! Siediti!`;
        if (trust === 'amico') return `Ehi ${game.player.name}! Come stai?`;
        if (trust === 'conoscente') return `Oh, ciao. Come va?`;
        return `Ciao. Ci siamo gi√† visti?`;
    }

    function addDialogueBubble(type, text, checkResult = null) {
        const history = document.getElementById('dialogueHistory');
        const bubble = document.createElement('div');
        bubble.className = `dialogue-bubble ${type}`;
        
        let content = `<div class="bubble-content">`;
        
        if (type === 'player') {
            content += `<div class="bubble-label">${game.player.name}</div>`;
        } else if (type === 'npc') {
            content += `<div class="bubble-label">${currentDialogueNPC.name}</div>`;
        }
        
        content += text;
        
        if (checkResult) {
            const checkClass = checkResult.success ? 
                (checkResult.margin >= 5 ? 'critical' : 'success') : 
                'failure';
            content += `<span class="check-result ${checkClass}">
                üé≤ ${checkResult.roll}+${checkResult.modifier}=${checkResult.total} ${checkResult.success ? '‚úì' : '‚úó'}
            </span>`;
        }
        
        content += `</div>`;
        bubble.innerHTML = content;
        history.appendChild(bubble);
        history.scrollTop = history.scrollHeight;
    }

    function renderDialogueChoices(npc) {
        const choicesDiv = document.getElementById('dialogueChoices');
        choicesDiv.innerHTML = '';
        
        const options = getDialogueOptions(npc);
        
        options.forEach(option => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-option';
            
            let html = `<div class="choice-text">${option.text}</div>`;
            
            if (option.check) {
                const skillValue = game.player.skills[option.check.type] || 0;
                const modifier = Math.floor(skillValue / 10);
                html += `<span class="choice-check">üé≤ ${option.check.type.toUpperCase()} DC${option.check.difficulty} (${modifier >= 0 ? '+' : ''}${modifier})</span>`;
            }
            
            choiceDiv.innerHTML = html;
            choiceDiv.onclick = () => selectDialogueChoice(npc, option);
            choicesDiv.appendChild(choiceDiv);
        });
    }

    function selectDialogueChoice(npc, option) {
        addDialogueBubble('player', option.text);
        document.getElementById('dialogueChoices').innerHTML = '<div style="text-align:center; opacity:0.7; padding:20px;">...</div>';
        
        setTimeout(() => {
            const result = executeDialogueChoice(npc, option);
            
            setTimeout(() => {
                addDialogueBubble('npc', result.response, result.checkResult);
                
                if (result.relationChange !== 0) {
                    showRelationChange(result.relationChange);
                }
                
                document.getElementById('dialogueRelation').textContent = npc.relation;
                document.getElementById('dialogueConversations').textContent = npc.memory.conversations;
                updateTrustDisplay(npc);
                
                if (result.events.length > 0) {
                    result.events.forEach(event => {
                        setTimeout(() => handleDialogueEvent(event, npc), 1000);
                    });
                }
                
                // Se l'opzione ha follow-up, mostra quelli invece del menu principale
                if (option.followUp && option.followUp.length > 0) {
                    setTimeout(() => renderFollowUpChoices(npc, option.followUp, option.type), 1500);
                } else {
                    // Torna al menu principale solo se non ci sono follow-up
                    setTimeout(() => renderDialogueChoices(npc), 1500);
                }
            }, 800);
        }, 300);
    }

    function renderFollowUpChoices(npc, followUpOptions, previousType) {
        const choicesDiv = document.getElementById('dialogueChoices');
        choicesDiv.innerHTML = '';
        
        // Aggiungi le opzioni di follow-up
        followUpOptions.forEach(option => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-option';
            
            let html = `<div class="choice-text">${option.text}</div>`;
            
            if (option.check) {
                const skillValue = game.player.skills[option.check.type] || 0;
                const modifier = Math.floor(skillValue / 10);
                html += `<span class="choice-check">üé≤ ${option.check.type.toUpperCase()} DC${option.check.difficulty} (${modifier >= 0 ? '+' : ''}${modifier})</span>`;
            }
            
            choiceDiv.innerHTML = html;
            choiceDiv.onclick = () => selectDialogueChoice(npc, option);
            choicesDiv.appendChild(choiceDiv);
        });
        
        // Aggiungi sempre un'opzione per tornare indietro
        const backDiv = document.createElement('div');
        backDiv.className = 'choice-option';
        backDiv.innerHTML = `<div class="choice-text">‚Ü©Ô∏è Torna al menu principale</div>`;
        backDiv.onclick = () => renderDialogueChoices(npc);
        choicesDiv.appendChild(backDiv);
    }

    function showRelationChange(change) {
        const notif = document.createElement('div');
        notif.className = `dialogue-notification ${change > 0 ? 'relation-up' : 'relation-down'}`;
        notif.textContent = `${change > 0 ? 'üíö' : 'üíî'} Relazione ${change > 0 ? '+' : ''}${change}`;
        
        document.querySelector('.dialogue-container').appendChild(notif);
        
        setTimeout(() => {
            notif.style.animation = 'fadeOut 0.5s';
            setTimeout(() => notif.remove(), 500);
        }, 2000);
    }

    
// ---------- ADVANCED CAREER & WORK SYSTEM ----------

// Calculate work performance based on vital stats
function calculateWorkPerformance() {
    const stats = game.player.stats || {};
    const skills = game.player.skills || {};
    
    // Vital stats influence (0-100 each)
    const energy = stats.energy || 50;
    const health = stats.health || 50;
    const morale = stats.morale || 50;
    const hunger = stats.hunger || 50;
    
    // Base performance from vital stats (weighted)
    let vitalPerformance = (
        energy * 0.35 +  // Energy is most important
        health * 0.25 +  // Health affects stamina
        morale * 0.25 +  // Morale affects motivation
        hunger * 0.15    // Hunger affects focus
    );
    
    // Homeless penalty: massive performance drop
    if (game.player.isHomeless) {
        vitalPerformance *= 0.6; // -40% performance if homeless
        showNotification('üèöÔ∏è Il tuo stato di senzatetto influisce gravemente sul lavoro!', 2500);
    }
    
    // Get relevant skill for current job
    const careerPath = game.workData.careerPath;
    let skillBonus = 0;
    
    if (careerPath && CAREER_PATHS[careerPath]) {
        const level = game.workData.careerLevel || 0;
        const requirements = CAREER_PATHS[careerPath].levels[level].requirements;
        
        // Calculate skill bonus based on requirements
        const relevantSkills = ['intellect', 'charisma', 'creativity', 'fitness'];
        let totalSkill = 0;
        let requiredSkill = 0;
        
        relevantSkills.forEach(skill => {
            if (requirements[skill]) {
                totalSkill += skills[skill] || 0;
                requiredSkill += requirements[skill];
            }
        });
        
        // Skill bonus: positive if above requirements, negative if below
        if (requiredSkill > 0) {
            skillBonus = ((totalSkill - requiredSkill) / requiredSkill) * 20;
        }
    }
    
    // Combine vital performance and skill bonus
    const finalPerformance = clamp(vitalPerformance + skillBonus);
    
    return Math.round(finalPerformance);
}

// Work events based on performance and stats
function triggerWorkEvent(performance) {
    const stats = game.player.stats || {};
    const events = [];
    
    // Very poor performance (< 40)
    if (performance < 40) {
        events.push(
            { type: 'negative', msg: 'üòì Performance scarsa: il manager ti ha rimproverato', managerChange: -8, perfChange: -5 },
            { type: 'negative', msg: '‚ö†Ô∏è Hai commesso un errore grave che ha causato problemi', managerChange: -12, perfChange: -8, moneyChange: -50 },
            { type: 'negative', msg: 'üò∞ Ti sei addormentato durante il lavoro per la stanchezza', managerChange: -15, perfChange: -10 },
            { type: 'warning', msg: 'üìã AVVERTIMENTO FORMALE ricevuto per performance inadeguata', managerChange: -20, perfChange: -12, warning: true }
        );
    }
    // Poor performance (40-60)
    else if (performance < 60) {
        events.push(
            { type: 'neutral', msg: 'üòê Giornata nella media, ma potresti fare di meglio', managerChange: -3, perfChange: -2 },
            { type: 'negative', msg: 'üìä Il manager ha notato cali di produttivit√†', managerChange: -5, perfChange: -3 },
            { type: 'neutral', msg: 'üíº Hai completato i compiti base ma senza eccellere', managerChange: 0, perfChange: 0 }
        );
    }
    // Good performance (60-80)
    else if (performance < 80) {
        events.push(
            { type: 'positive', msg: '‚úÖ Buon lavoro, il manager √® soddisfatto', managerChange: 3, perfChange: 2 },
            { type: 'positive', msg: 'üëç Hai gestito bene una situazione difficile', managerChange: 5, perfChange: 3, repChange: 2 },
            { type: 'neutral', msg: 'üíº Giornata produttiva e senza intoppi', managerChange: 2, perfChange: 1 }
        );
    }
    // Excellent performance (80-100)
    else {
        events.push(
            { type: 'excellent', msg: 'üåü Performance eccellente! Il manager ti ha elogiato', managerChange: 8, perfChange: 5, repChange: 3 },
            { type: 'excellent', msg: 'üíé Hai risolto un problema critico salvando la situazione', managerChange: 12, perfChange: 8, repChange: 5, moneyChange: 100 },
            { type: 'excellent', msg: 'üèÜ Ottimo lavoro! Sei stato preso come esempio per il team', managerChange: 10, perfChange: 6, repChange: 4, promotionProgress: 10 }
        );
    }
    
    // Random events based on stats
    if (stats.energy < 30) {
        events.push({ type: 'negative', msg: 'üò¥ La stanchezza ti ha fatto rallentare molto', managerChange: -6, perfChange: -4 });
    }
    if (stats.health < 30) {
        events.push({ type: 'negative', msg: 'ü§í Non stavi bene e hai lavorato male', managerChange: -5, perfChange: -5 });
    }
    if (stats.morale > 80) {
        events.push({ type: 'positive', msg: 'üòä Il tuo ottimo umore ha contagiato i colleghi', managerChange: 4, perfChange: 2, repChange: 2 });
    }
    
    return events[randInt(0, events.length - 1)];
}

// Check for promotion eligibility
function checkPromotionEligibility() {
    const careerPath = game.workData.careerPath;
    if (!careerPath || !CAREER_PATHS[careerPath]) return false;
    
    const currentLevel = game.workData.careerLevel || 0;
    const nextLevel = currentLevel + 1;
    
    // Check if there's a next level
    if (nextLevel >= CAREER_PATHS[careerPath].levels.length) return false;
    
    const requirements = CAREER_PATHS[careerPath].levels[nextLevel].requirements;
    const skills = game.player.skills || {};
    const workData = game.workData;
    
    // Check all requirements
    const checks = {
        intellect: !requirements.intellect || (skills.intellect || 0) >= requirements.intellect,
        charisma: !requirements.charisma || (skills.charisma || 0) >= requirements.charisma,
        creativity: !requirements.creativity || (skills.creativity || 0) >= requirements.creativity,
        fitness: !requirements.fitness || (skills.fitness || 0) >= requirements.fitness,
        performance: !requirements.performance || workData.performance >= requirements.performance,
        managerRelation: !requirements.managerRelation || workData.managerRelation >= requirements.managerRelation
    };
    
    return Object.values(checks).every(check => check);
}

// Attempt promotion
function attemptPromotion() {
    if (!checkPromotionEligibility()) {
        showNotification('‚ùå Non hai ancora i requisiti per una promozione', 2500);
        return;
    }
    
    const careerPath = game.workData.careerPath;
    const nextLevel = (game.workData.careerLevel || 0) + 1;
    const levelData = CAREER_PATHS[careerPath].levels[nextLevel];
    
    // Promotion success chance based on various factors
    const baseChance = 60;
    const performanceBonus = (game.workData.performance - 70) * 0.5;
    const managerBonus = (game.workData.managerRelation - 60) * 0.4;
    const progressBonus = (game.workData.promotionProgress || 0) * 0.3;
    
    const successChance = clamp(baseChance + performanceBonus + managerBonus + progressBonus, 20, 95);
    
    if (Math.random() * 100 < successChance) {
        // PROMOTION SUCCESS!
        game.workData.careerLevel = nextLevel;
        game.player.job = levelData.title;
        game.player.jobSalary = levelData.salary;
        game.player.jobLevel = nextLevel + 1;
        game.workData.promotionProgress = 0;
        game.workData.managerRelation = Math.min(100, game.workData.managerRelation + 10);
        game.player.rep += 10;
        
        showNotification(`üéâ PROMOZIONE! Ora sei ${levelData.title} con stipendio ‚Ç¨${levelData.salary}/giorno!`, 5000);
        
        game.workData.workEvents.push(`${getTimeString()} ‚Äî üéâ PROMOSSO a ${levelData.title}!`);
        
        updateUI();
    } else {
        // Promotion denied
        showNotification('üòî Promozione rifiutata. Continua a migliorare performance e relazione col manager', 3000);
        game.workData.promotionProgress += 10;
    }
}

// Talk to manager action
function talkToManager() {
    const manager = game.npcs.find(n => n.name === game.workData.currentJob.manager);
    if (manager) {
        openDialogue(manager.id);
    } else {
        showNotification('üëî Il tuo manager non √® disponibile al momento', 2000);
    }
}

function doWorkDay() {
    if (!game.player || game.player.job === 'Disoccupato') {
        showNotification('‚ùå Non hai un lavoro!', 2000);
        return;
    }

    if (!game.workData || !game.workData.currentJob) {
        showNotification('‚ùå Dati lavoro non trovati!', 2000);
        return;
    }

    const job = game.workData.currentJob;
    const currentHour = game.time.hour;
    
    // Check if it's weekend
    if (isWeekend(game.time.day)) {
        showNotification('üèñÔ∏è √à weekend! Riposa e goditi il tempo libero.', 2500);
        return;
    }
    
    // Check work days this week
    if (game.player.workDaysThisWeek >= 5) {
        showNotification('‚è∞ Hai gi√† lavorato 5 giorni questa settimana. Riposati!', 2500);
        return;
    }

    if (game.workData.todayWorked) {
        showNotification('‚úÖ Hai gi√† lavorato oggi.', 2000);
        return;
    }

    if (!job.hours || typeof job.hours.start !== 'number' || typeof job.hours.end !== 'number') {
        showNotification('‚ö†Ô∏è Orario di lavoro non valido.', 2000);
        return;
    }
    
    // Validate max 8 hour shift
    const shiftDuration = job.hours.end - job.hours.start;
    if (shiftDuration > 8) {
        showNotification('‚ö†Ô∏è Errore: turno superiore a 8 ore non permesso!', 2500);
        return;
    }

    if (currentHour < job.hours.start || currentHour >= job.hours.end) {
        showNotification(`‚è∞ Non sei nell'orario di lavoro (${job.hours.start}:00-${job.hours.end}:00).`, 2500);
        return;
    }
    
    // Travel to work location if needed
    if (job.location && game.cityMap.currentLocation !== job.location) {
        // Show travel dialog
        showTravelDialog(job.location, function() {
            // After travel, check if still in work hours
            if (game.time.hour >= job.hours.end) {
                showNotification(`‚è∞ Troppo tardi! Orario di lavoro terminato durante il viaggio.`, 2500);
                updateUI();
                return;
            }
            
            // Continue with work
            performWorkDay();
        });
        return;
    }

    // If already at work location, perform work directly
    performWorkDay();
}

function performWorkDay() {
    const job = game.workData.currentJob;
    const currentHour = game.time.hour;
    
    // Update building to work
    game.cityMap.currentBuilding = 'work';
    
    const fullShiftHours = Math.max(1, job.hours.end - job.hours.start);
    const hoursToWork = Math.max(1, job.hours.end - currentHour);

    // Calculate performance based on vital stats
    const dailyPerformance = calculateWorkPerformance();
    
    // Update rolling average performance
    game.workData.performance = Math.round((game.workData.performance * 0.7) + (dailyPerformance * 0.3));
    
    // Base salary
    const baseSalary = game.player.jobSalary || job.salary || 100;
    let earnings = Math.round(baseSalary * (hoursToWork / fullShiftHours));
    
    // Performance affects earnings
    const performanceMultiplier = dailyPerformance / 100;
    earnings = Math.round(earnings * performanceMultiplier);
    
    // Consumo risorse base
    const baseEnergyLoss = hoursToWork * 8;
    const baseHungerLoss = hoursToWork * 6;
    const baseMoraleLoss = Math.floor(hoursToWork * 1.5);
    const baseHealthLoss = Math.floor(hoursToWork * 0.5);

    let energyChange = -baseEnergyLoss;
    let hungerChange = -baseHungerLoss;
    let moraleChange = -baseMoraleLoss;
    let healthChange = -baseHealthLoss;
    let repChange = 0;

    // Trigger work event
    const workEvent = triggerWorkEvent(dailyPerformance);
    let message = workEvent.msg;
    
    // Apply event effects
    game.workData.managerRelation = clamp(game.workData.managerRelation + (workEvent.managerChange || 0));
    game.workData.performance = clamp(game.workData.performance + (workEvent.perfChange || 0));
    
    if (workEvent.moneyChange) {
        earnings += workEvent.moneyChange;
    }
    if (workEvent.repChange) {
        repChange += workEvent.repChange;
    }
    if (workEvent.promotionProgress) {
        game.workData.promotionProgress = Math.min(100, (game.workData.promotionProgress || 0) + workEvent.promotionProgress);
    }
    if (workEvent.warning) {
        game.workData.warnings = (game.workData.warnings || 0) + 1;
        
        // Check for firing after 3 warnings
        if (game.workData.warnings >= 3) {
            showNotification('üö´ SEI STATO LICENZIATO per ripetute performance scadenti!', 5000);
            
            // Update company employee count
            if (game.workData.currentJob && game.companies[game.workData.currentJob.locationId]) {
                game.companies[game.workData.currentJob.locationId].employees = Math.max(0, game.companies[game.workData.currentJob.locationId].employees - 1);
            }
            
            game.player.job = 'Disoccupato';
            game.player.jobSalary = 0;
            game.workData = {
                currentJob: null,
                todayWorked: false,
                tasksCompleted: 0,
                performance: 50,
                manager: null,
                workEvents: [...game.workData.workEvents, `${getTimeString()} ‚Äî üö´ LICENZIATO per performance scadenti`],
                careerPath: null,
                careerLevel: 0,
                daysWorked: 0,
                managerRelation: 50,
                warnings: 0,
                promotionProgress: 0,
                lastPerformanceReview: 0
            };
            updateUI();
            return;
        }
    }
    
    // Poor manager relation can lead to firing
    if (game.workData.managerRelation < 20 && Math.random() < 0.3) {
        showNotification('üö´ SEI STATO LICENZIATO per pessimi rapporti col manager!', 5000);
        
        // Update company employee count
        if (game.workData.currentJob && game.companies[game.workData.currentJob.locationId]) {
            game.companies[game.workData.currentJob.locationId].employees = Math.max(0, game.companies[game.workData.currentJob.locationId].employees - 1);
        }
        
        game.player.job = 'Disoccupato';
        game.player.jobSalary = 0;
        game.workData = {
            currentJob: null,
            todayWorked: false,
            tasksCompleted: 0,
            performance: 50,
            manager: null,
            workEvents: [...game.workData.workEvents, `${getTimeString()} ‚Äî üö´ LICENZIATO per conflitti col manager`],
            careerPath: null,
            careerLevel: 0,
            daysWorked: 0,
            managerRelation: 50,
            warnings: 0,
            promotionProgress: 0,
            lastPerformanceReview: 0
        };
        updateUI();
        return;
    }

    // Aggiorna stats giocatore
    const stats = game.player.stats || {};
    stats.energy = clamp((stats.energy || 0) + energyChange);
    stats.hunger = clamp((stats.hunger || 0) + hungerChange);
    stats.morale = clamp((stats.morale || 0) + moraleChange);
    stats.health = clamp((stats.health || 0) + healthChange);
    game.player.stats = stats;
    game.player.rep = clamp((game.player.rep || 0) + repChange);

    // Aggiorna denaro
    game.player.money += earnings;
    game.player.totalEarned = (game.player.totalEarned || 0) + earnings;

    // Increment days worked
    game.workData.daysWorked = (game.workData.daysWorked || 0) + 1;
    game.workData.todayWorked = true;
    
    // Track work days this week
    game.player.workDaysThisWeek = (game.player.workDaysThisWeek || 0) + 1;
    game.player.lastWorkDay = game.time.day;
    
    // Auto promotion progress for good performance
    if (dailyPerformance >= 80) {
        game.workData.promotionProgress = Math.min(100, (game.workData.promotionProgress || 0) + 2);
    }
    
    // Check for automatic promotion at 100% progress
    if (game.workData.promotionProgress >= 100 && checkPromotionEligibility()) {
        attemptPromotion();
    }

    // Avanza il tempo fino a fine turno
    game.time.hour += hoursToWork;
    while (game.time.hour >= 24) {
        game.time.hour -= 24;
        game.time.day += 1;
    }

    // Log eventi di lavoro
    if (!Array.isArray(game.workData.workEvents)) {
        game.workData.workEvents = [];
    }
    const summary = `${getTimeString()} ‚Äî ${message} | Guadagni: ${formatMoney(earnings)} | Perf: ${dailyPerformance}% | Manager: ${game.workData.managerRelation}/100`;
    game.workData.workEvents.push(summary);
    if (game.workData.workEvents.length > 20) {
        game.workData.workEvents = game.workData.workEvents.slice(-20);
    }

    showNotification(message + ` | ${formatMoney(earnings)} | Perf: ${dailyPerformance}%`, 4000);
    updateUI();
}

setInterval(() => {
        if (game.settings.autoSave && game.player) {
            saveGame();
        }
    }, 60000); // Auto-save every 60 seconds

    // Debug function - call from console: debugWork()
    window.debugWork = function() {
        console.log('=== WORK DEBUG INFO ===');
        console.log('Player Job:', game.player.job);
        console.log('Player Salary:', game.player.jobSalary);
        console.log('Has workData:', !!game.workData);
        console.log('Has workLocation:', !!(game.workData && game.workData.workLocation));
        console.log('Work Location:', game.workData?.workLocation);
        console.log('Work Place Name:', game.workData?.workPlaceName);
        console.log('Current City Location:', game.cityMap?.currentLocation);
        console.log('Current Job Object:', game.workData?.currentJob);
        console.log('======================');
        return game.workData;
    };

    </script>
    <script src="fix_ui_v2.js"></script>
    <script src="fix_jobs_complete.js"></script>
    <script src="fix_map_actions.js"></script>
</body>
</html>
